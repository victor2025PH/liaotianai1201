name: Deploy Three Sites

on:
  push:
    branches:
      - main
    paths:
      - 'tgmini20251220/**'
      - 'hbwy20251220/**'
      - 'aizkw20251219/**'
      - '.github/workflows/deploy-three-sites.yml'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: '部署所有三个网站'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        site:
          - name: tgmini
            dir: tgmini20251220
            domain: tgmini.usdt2026.cc
            port: 3001
            pm2_name: tgmini-frontend
          - name: hongbao
            dir: hbwy20251220
            domain: hongbao.usdt2026.cc
            port: 3002
            pm2_name: hongbao-frontend
          - name: aizkw
            dir: aizkw20251219
            domain: aikz.usdt2026.cc
            port: 3003
            pm2_name: aizkw-frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ${{ matrix.site.name }} to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            SITE_NAME="${{ matrix.site.name }}"
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            SITE_DIR="$PROJECT_DIR/${{ matrix.site.dir }}"
            DOMAIN="${{ matrix.site.domain }}"
            PORT="${{ matrix.site.port }}"
            PM2_NAME="${{ matrix.site.pm2_name }}"
            
            echo "=========================================="
            echo "🚀 部署 $SITE_NAME"
            echo "域名: $DOMAIN"
            echo "端口: $PORT"
            echo "目录: $SITE_DIR"
            echo "时间: $(date)"
            echo "=========================================="
            echo ""
            
            # 进入项目根目录
            cd "$PROJECT_DIR" || {
              echo "❌ 项目目录不存在: $PROJECT_DIR"
              exit 1
            }
            
            # 拉取最新代码
            echo "📥 [1/6] 拉取最新代码..."
            echo "----------------------------------------"
            
            # 确保项目目录存在
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "⚠️  项目目录不存在，创建目录..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "❌ Git clone 失败"
                exit 1
              }
            else
              cd "$PROJECT_DIR"
              git fetch origin main || git fetch origin || true
              git reset --hard origin/main || git pull origin main || {
                echo "⚠️  Git pull 失败，尝试继续..."
              }
            fi
            echo "✅ 代码同步完成"
            echo ""
            
            # 检查站点目录是否存在
            if [ ! -d "$SITE_DIR" ]; then
              echo "❌ 站点目录不存在: $SITE_DIR"
              echo "当前项目目录内容:"
              ls -la "$PROJECT_DIR" | head -20
              exit 1
            fi
            
            # 进入站点目录
            cd "$SITE_DIR" || {
              echo "❌ 无法进入站点目录: $SITE_DIR"
              exit 1
            }
            
            # 检查 package.json
            if [ ! -f "package.json" ]; then
              echo "❌ package.json 不存在"
              exit 1
            fi
            
            echo "✅ 找到 package.json"
            echo ""
            
            # 安装依赖
            echo "📦 [2/6] 安装依赖..."
            echo "----------------------------------------"
            npm install || {
              echo "❌ npm install 失败"
              exit 1
            }
            echo "✅ 依赖安装完成"
            echo ""
            
            # 构建项目
            echo "🔨 [3/6] 构建项目..."
            echo "----------------------------------------"
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "❌ npm run build 失败"
              exit 1
            }
            
            # 检查构建输出
            if [ ! -d "dist" ]; then
              echo "❌ dist 目录不存在，构建可能失败"
              exit 1
            fi
            echo "✅ 构建完成"
            echo ""
            
            # 停止旧进程
            echo "🛑 [4/6] 停止旧进程..."
            echo "----------------------------------------"
            pm2 delete "$PM2_NAME" 2>/dev/null || true
            
            # 停止占用端口的进程
            if sudo lsof -i :$PORT >/dev/null 2>&1; then
              echo "停止占用端口 $PORT 的进程..."
              sudo lsof -ti :$PORT | xargs sudo kill -9 2>/dev/null || true
              sleep 2
            fi
            echo "✅ 旧进程已停止"
            echo ""
            
            # 启动服务（使用 serve 或 vite preview）
            echo "🚀 [5/6] 启动服务..."
            echo "----------------------------------------"
            
            # 确保日志目录存在
            mkdir -p "$PROJECT_DIR/logs"
            
            # 确认当前目录和 dist 文件夹
            echo "当前工作目录: $(pwd)"
            echo "检查 dist 目录..."
            if [ ! -d "$SITE_DIR/dist" ]; then
              echo "❌ dist 目录不存在: $SITE_DIR/dist"
              echo "当前目录内容:"
              ls -la "$SITE_DIR" | head -20
              exit 1
            fi
            echo "✅ dist 目录存在: $SITE_DIR/dist"
            echo "dist 目录大小: $(du -sh $SITE_DIR/dist | cut -f1)"
            
            # 检查并安装 PM2
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "安装 PM2..."
              sudo npm install -g pm2
              pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            fi
            
            # 安装 serve（如果未安装）
            if ! command -v serve >/dev/null 2>&1; then
              echo "安装 serve..."
              sudo npm install -g serve
            fi
            
            # 进入站点目录
            cd "$SITE_DIR" || {
              echo "❌ 无法进入站点目录: $SITE_DIR"
              exit 1
            }
            
            # 生成启动脚本（直接在脚本中写入路径和端口，避免参数传递问题）
            echo "生成启动脚本..."
            START_SCRIPT="$SITE_DIR/start-frontend.sh"
            printf '#!/bin/bash\n# 前端服务启动脚本\n# 使用全局 serve 命令启动静态文件服务\nset -e\nDIST_DIR="%s"\nPORT=%s\n# 检查 serve 命令是否存在\nif ! command -v serve >/dev/null 2>&1; then\n  echo "错误: serve 命令未找到，请先安装: npm install -g serve"\n  exit 1\nfi\n# 检查 dist 目录是否存在\nif [ ! -d "$DIST_DIR" ]; then\n  echo "错误: dist 目录不存在: $DIST_DIR"\n  exit 1\nfi\n# 启动 serve（移除不支持的 --no-open 选项）\nexec serve -s "$DIST_DIR" -l "$PORT" --no-clipboard\n' "$SITE_DIR/dist" "$PORT" > "$START_SCRIPT"
            
            chmod +x "$START_SCRIPT"
            echo "✅ 启动脚本已生成: $START_SCRIPT"
            echo "启动脚本内容:"
            cat "$START_SCRIPT"
            echo ""
            
            # 使用 PM2 启动脚本（不需要传递参数，路径已写入脚本）
            echo "使用 PM2 启动前端服务..."
            pm2 start "$START_SCRIPT" \
              --name "$PM2_NAME" \
              --error "$PROJECT_DIR/logs/${SITE_NAME}-error.log" \
              --output "$PROJECT_DIR/logs/${SITE_NAME}-out.log" \
              --merge-logs \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
              echo "⚠️  PM2 启动失败，查看错误..."
              pm2 logs "$PM2_NAME" --lines 50 --nostream 2>/dev/null || true
              echo "查看 PM2 进程状态:"
              pm2 list || true
              exit 1
            }
            
            pm2 save || true
            echo "✅ 服务已启动"
            echo ""
            
            # 立即检查 PM2 状态
            echo "检查 PM2 进程状态..."
            sleep 2
            PM2_STATUS=$(pm2 describe "$PM2_NAME" 2>/dev/null | grep -E "status|restarts" || echo "")
            echo "PM2 状态: $PM2_STATUS"
            if echo "$PM2_STATUS" | grep -q "errored\|stopped"; then
              echo "⚠️  PM2 进程状态异常，查看日志..."
              pm2 logs "$PM2_NAME" --lines 30 --nostream 2>/dev/null || true
            fi
            
            # 等待启动（延长等待时间，给 Node.js 应用更多启动时间）
            echo "等待服务启动..."
            sleep 13
            
            # 检查服务状态
            if sudo lsof -i :$PORT >/dev/null 2>&1; then
              echo "✅ 端口 $PORT 正在监听"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$PORT || echo "000")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "✅ 服务响应正常 (HTTP $HTTP_CODE)"
              else
                echo "⚠️  服务响应异常 (HTTP $HTTP_CODE)"
              fi
            else
              echo "❌ 端口 $PORT 未在监听，应用可能未成功启动"
              echo "=========================================="
              echo "🔍 详细错误诊断..."
              echo "=========================================="
              echo "PM2 进程状态:"
              pm2 list || true
              echo ""
              echo "PM2 进程详情:"
              pm2 describe "$PM2_NAME" || true
              echo ""
              echo "PM2 最新日志 (最后 50 行):"
              pm2 logs "$PM2_NAME" --lines 50 --nostream 2>/dev/null || true
              echo ""
              echo "检查进程是否在运行:"
              ps aux | grep -E "serve|$PM2_NAME" | grep -v grep || true
              echo ""
              echo "检查端口占用:"
              sudo lsof -i :$PORT || echo "端口未被占用"
              echo ""
              echo "查看错误日志文件:"
              tail -50 "$PROJECT_DIR/logs/${SITE_NAME}-error.log" 2>/dev/null || echo "错误日志文件不存在"
              echo ""
              echo "查看输出日志文件:"
              tail -50 "$PROJECT_DIR/logs/${SITE_NAME}-out.log" 2>/dev/null || echo "输出日志文件不存在"
              exit 1
            fi
            echo ""
            
            # 配置 Nginx
            echo "🌐 [6/6] 配置 Nginx..."
            echo "----------------------------------------"
            
            # 创建 Nginx 配置
            NGINX_CONFIG="/tmp/${SITE_NAME}.conf"
            
            # 检查 SSL 证书是否存在
            SSL_CERT="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
            SSL_KEY="/etc/letsencrypt/live/$DOMAIN/privkey.pem"
            
            if [ -f "$SSL_CERT" ] && [ -f "$SSL_KEY" ]; then
              # SSL 证书存在，配置 HTTPS（使用 printf 避免 YAML 解析问题）
              printf '# HTTP to HTTPS redirect\nserver {\n    listen 80;\n    server_name %s;\n    \n    # Let'\''s Encrypt 验证路径\n    location /.well-known/acme-challenge/ {\n        root /var/www/html;\n    }\n    \n    # 重定向所有 HTTP 请求到 HTTPS\n    location / {\n        return 301 https://$server_name$request_uri;\n    }\n}\n\n# HTTPS server\nserver {\n    listen 443 ssl http2;\n    server_name %s;\n\n    # SSL 证书配置（由 Certbot 自动管理）\n    ssl_certificate /etc/letsencrypt/live/%s/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/%s/privkey.pem;\n    \n    # SSL 安全配置\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers '\''ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384'\'';\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    \n    # 安全头\n    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;\n    add_header X-Frame-Options "SAMEORIGIN" always;\n    add_header X-Content-Type-Options "nosniff" always;\n    add_header X-XSS-Protection "1; mode=block" always;\n\n    client_max_body_size 50M;\n\n    # 前端应用\n    location / {\n        proxy_pass http://127.0.0.1:%s;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n        proxy_read_timeout 86400;\n    }\n}\n' "$DOMAIN" "$DOMAIN" "$DOMAIN" "$DOMAIN" "$PORT" > "$NGINX_CONFIG"
            else
              # SSL 证书不存在，只配置 HTTP（使用 printf 避免 YAML 解析问题）
              echo "⚠️  SSL 证书不存在，配置 HTTP only"
              printf '# HTTP server (SSL certificate not found)\nserver {\n    listen 80;\n    server_name %s;\n\n    client_max_body_size 50M;\n\n    location / {\n        proxy_pass http://127.0.0.1:%s;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n        proxy_read_timeout 86400;\n    }\n}\n' "$DOMAIN" "$PORT" > "$NGINX_CONFIG"
            fi
            
            # 复制配置到 Nginx
            sudo cp "$NGINX_CONFIG" "/etc/nginx/sites-available/$DOMAIN"
            
            # 创建符号链接（如果不存在）
            if [ ! -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
              sudo ln -s "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
            fi
            
            # 检查 Nginx 是否安装
            if ! command -v nginx >/dev/null 2>&1; then
              echo "⚠️  Nginx 未安装，安装 Nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # 重载/重启 Nginx（简单粗暴但有效）
            echo "🔄 重载/重启 Nginx..."
            echo "----------------------------------------"
            
            # 0. 清理无效的旧配置（证书不存在的 HTTPS 配置）
            echo "0. 清理无效的旧配置..."
            for config_file in /etc/nginx/sites-enabled/*; do
              if [ -f "$config_file" ]; then
                # 检查配置文件中是否引用了证书，但证书文件不存在
                if grep -q "ssl_certificate" "$config_file" 2>/dev/null; then
                  # 提取证书路径（更可靠的方法）
                  CERT_PATH=$(grep "ssl_certificate" "$config_file" | grep -v "^[[:space:]]*#" | head -1 | sed 's/.*ssl_certificate[[:space:]]*\([^;]*\);.*/\1/' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                  if [ -n "$CERT_PATH" ] && [ ! -f "$CERT_PATH" ]; then
                    echo "⚠️  发现无效配置（证书不存在: $CERT_PATH）: $config_file，临时禁用..."
                    sudo rm -f "$config_file" || true
                  fi
                fi
              fi
            done
            
            # 1. 先做体检（确保配置文件没写错）
            echo "1. 测试 Nginx 配置文件..."
            if ! sudo nginx -t 2>&1; then
              echo "❌ Nginx 配置文件有误！"
              echo "查看详细错误："
              sudo nginx -t 2>&1 || true
              echo ""
              echo "尝试修复：删除所有可能无效的配置..."
              # 列出所有启用的配置
              echo "当前启用的配置："
              ls -la /etc/nginx/sites-enabled/ || true
              echo ""
              echo "检查每个配置的证书..."
              for config_file in /etc/nginx/sites-enabled/*; do
                if [ -f "$config_file" ]; then
                  echo "检查: $config_file"
                  if grep -q "ssl_certificate" "$config_file" 2>/dev/null; then
                    # 提取证书路径（更可靠的方法）
                    CERT_PATH=$(grep "ssl_certificate" "$config_file" | grep -v "^[[:space:]]*#" | head -1 | sed 's/.*ssl_certificate[[:space:]]*\([^;]*\);.*/\1/' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
                    if [ -n "$CERT_PATH" ]; then
                      if [ ! -f "$CERT_PATH" ]; then
                        echo "  ❌ 证书不存在: $CERT_PATH，删除配置..."
                        sudo rm -f "$config_file" || true
                      else
                        echo "  ✅ 证书存在: $CERT_PATH"
                      fi
                    fi
                  fi
                fi
              done
              echo ""
              echo "再次测试配置..."
              if ! sudo nginx -t 2>&1; then
                echo "❌ 修复后配置测试仍然失败，禁止重启，以免搞挂现有服务。"
                exit 1
              fi
            fi
            echo "✅ Nginx 配置测试通过"
            
            # 2. 直接重启（不管它现在是死是活，重启能解决所有状态问题）
            echo "2. 执行重启..."
            if sudo systemctl restart nginx; then
              echo "✅ Nginx 重启成功！"
            else
              echo "❌ Nginx 重启失败！打印日志："
              sudo journalctl -u nginx --no-pager -n 50
              exit 1
            fi
            
            # 3. 最终确认
            echo "3. 验证运行状态..."
            sleep 3
            if sudo systemctl is-active --quiet nginx; then
              echo "✅ Nginx 服务正常运行中"
            else
              echo "❌ Nginx 重启后依然未运行"
              exit 1
            fi
            
            echo "✅ Nginx 配置完成"
            echo ""
            
            # 验证部署
            echo "🔍 验证部署..."
            echo "----------------------------------------"
            pm2 list | grep "$PM2_NAME" || true
            echo ""
            
            echo "=========================================="
            echo "✅ $SITE_NAME 部署完成！"
            echo "域名: https://$DOMAIN"
            echo "时间: $(date)"
            echo "=========================================="
