# 401 认证错误 - 解决方案

## 问题

浏览器显示 401 Unauthorized 错误："无法验证身份"

多个 API 请求失败：
- `GET /api/v1/notifications/unread-count` → 401
- `PUT /api/v1/group-ai/accounts/639277358115` → 401

## 原因

前端没有有效的 JWT token 或 token 已过期。

### 认证流程

1. **前端存储**: Token 存储在 `localStorage.getItem("access_token")`
2. **请求发送**: 通过 `fetchWithAuth` 添加 `Authorization: Bearer <token>` 头
3. **后端验证**: `get_current_user` 验证 JWT token

### 可能的原因

- ❌ 用户未登录（localStorage 中没有 token）
- ❌ Token 已过期
- ❌ Token 格式不正确
- ❌ 后端 JWT_SECRET 配置不正确

## 解决方案

### 方案1：登录获取 Token（推荐）

1. **访问登录页面**:
   ```
   http://aikz.usdt2026.cc/login
   ```

2. **使用默认管理员账号登录**:
   - 邮箱: `admin@example.com`
   - 密码: `changeme123`

3. **登录成功后，token 会保存到 localStorage**

### 方案2：临时禁用认证（仅用于测试）

如果需要在测试时跳过认证，可以设置环境变量：

```bash
export DISABLE_AUTH=true
```

然后重启后端服务。

### 方案3：手动设置 Token（临时）

在浏览器控制台执行：

```javascript
// 登录获取token
fetch('http://aikz.usdt2026.cc/api/v1/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: new URLSearchParams({
    username: 'admin@example.com',
    password: 'changeme123'
  })
})
.then(res => res.json())
.then(data => {
  localStorage.setItem('access_token', data.access_token)
  console.log('Token已保存，请刷新页面')
  location.reload()
})
```

## 验证

### 检查 Token

在浏览器控制台执行：

```javascript
console.log('Token:', localStorage.getItem('access_token'))
```

如果有 token，应该看到类似：
```
Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 检查后端认证配置

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
python3 -c "from app.core.config import get_settings; s = get_settings(); print(f'disable_auth: {s.disable_auth}')"
```

## 快速修复步骤

1. **打开浏览器控制台** (F12)
2. **执行登录脚本**（方案3）
3. **刷新页面** (`Ctrl+Shift+R`)
4. **重新尝试分配剧本**

## 长期解决方案

确保用户通过登录页面正确登录，token 会自动保存。

---

**问题：用户未登录或 token 丢失/过期**  
**解决：登录获取新的 token**
