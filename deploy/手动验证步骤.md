# WebSocket 配置部署验证步骤

## 快速验证命令

SSH 连接到服务器后，执行以下命令：

### 1. 检查 WebSocket 配置是否存在

```bash
sudo grep -A 15 'notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
```

**预期结果：** 应该看到类似以下的配置：
```nginx
location /api/v1/notifications/ws {
    proxy_pass http://127.0.0.1:8000/api/v1/notifications/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    ...
}
```

### 2. 检查 Nginx 配置语法

```bash
sudo nginx -t
```

**预期结果：** 
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### 3. 检查 Nginx 服务状态

```bash
sudo systemctl status nginx
```

**预期结果：** 状态应该是 `active (running)`

### 4. 检查后端服务状态

```bash
sudo systemctl status liaotian-backend
```

**预期结果：** 状态应该是 `active (running)`

### 5. 检查端口监听

```bash
sudo netstat -tlnp | grep -E ':80|:8000'
# 或使用
sudo ss -tlnp | grep -E ':80|:8000'
```

**预期结果：** 
- 应该看到 Nginx 监听端口 80
- 应该看到后端服务监听端口 8000

## 前端浏览器验证

### 步骤：

1. **打开前端应用：** http://aikz.usdt2026.cc

2. **打开开发者工具：** 按 F12

3. **切换到 Network 标签**

4. **筛选 WebSocket 连接：**
   - 点击筛选器，选择 "WS" 或 "WebSocket"
   - 或者直接在筛选框输入 "ws"

5. **刷新页面或触发通知**

6. **检查连接状态：**
   - ✅ **成功：** 状态码 101 (Switching Protocols)
   - ✅ **连接名称：** 应该包含 `/api/v1/notifications/ws/`
   - ❌ **失败：** 状态码 400/404/502 等，或连接失败

### 浏览器控制台检查

在 Console 标签中，应该看到：
- ✅ 无 WebSocket 连接错误
- ✅ 可能看到连接成功的日志（如果前端有日志）

### 常见问题

#### 问题 1：仍然看到连接错误

**检查：**
1. 确认 Nginx 配置已正确部署（步骤 1）
2. 确认 Nginx 已重载（`sudo systemctl reload nginx`）
3. 检查 Nginx 错误日志：`sudo tail -f /var/log/nginx/error.log`

#### 问题 2：连接建立但立即断开

**检查：**
1. 后端服务是否正常运行
2. 后端日志：`sudo journalctl -u liaotian-backend -f`
3. 检查用户邮箱是否正确传递

#### 问题 3：状态码 502 Bad Gateway

**可能原因：**
- 后端服务未运行
- 后端端口配置错误
- 防火墙阻止连接

**检查：**
```bash
sudo systemctl status liaotian-backend
curl http://localhost:8000/health
```

## 完整验证脚本

如果需要自动化验证，可以运行：

```bash
# 在服务器上执行
cd /home/ubuntu
cat > verify_ws.sh << 'EOF'
#!/bin/bash
echo "=== WebSocket 配置验证 ==="
echo ""
echo "1. 检查配置..."
sudo grep -A 15 'notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
echo ""
echo "2. 检查语法..."
sudo nginx -t
echo ""
echo "3. 检查服务状态..."
echo "Nginx: $(sudo systemctl is-active nginx)"
echo "Backend: $(sudo systemctl is-active liaotian-backend)"
echo ""
echo "4. 检查端口..."
sudo ss -tlnp | grep -E ':80|:8000'
EOF
chmod +x verify_ws.sh
./verify_ws.sh
```

## 验证清单

- [ ] WebSocket location 配置存在
- [ ] Nginx 配置语法正确
- [ ] Nginx 服务运行中
- [ ] 后端服务运行中
- [ ] 端口 80 和 8000 正在监听
- [ ] 前端浏览器中 WebSocket 连接成功（状态码 101）
- [ ] 无浏览器控制台错误

如果所有项目都打勾，说明部署成功！

