# 401 è®¤è¯é—®é¢˜å®Œæ•´åˆ†ææŠ¥å‘Š

## ğŸ“Š å½“å‰çŠ¶æ€æ€»ç»“

### âœ… å·²è§£å†³çš„é—®é¢˜
1. **Nginx é…ç½®ä¿®å¤æˆåŠŸ**
   - API è¯·æ±‚ç°åœ¨èƒ½æ­£ç¡®è½¬å‘åˆ°åç«¯ï¼ˆä¸å†æ˜¯ 404ï¼‰
   - `/api/` è·¯å¾„æ­£ç¡®ä»£ç†åˆ°åç«¯æœåŠ¡
   - WebSocket è·¯å¾„é…ç½®æ­£ç¡®

### âŒ å½“å‰é—®é¢˜
1. **401 Unauthorized é”™è¯¯**
   - æ‰€æœ‰ group-ai ç›¸å…³æ¥å£è¿”å› 401
   - é”™è¯¯ä¿¡æ¯ï¼š"è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•"ã€"æ— æ³•éªŒè¯èº«ä»½"

2. **é…ç½®è·¯å¾„æœªçŸ¥**
   - `.env` æ–‡ä»¶è·¯å¾„ä¸æ˜ç¡®
   - åç«¯æœåŠ¡åä¸æ˜ç¡®
   - æ— æ³•ç›´æ¥ä¿®æ”¹ CORS é…ç½®

3. **WebSocket è¿æ¥å¤±è´¥**
   - æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤º WebSocket è¿æ¥é”™è¯¯
   - å¯èƒ½å½±å“å®æ—¶é€šçŸ¥åŠŸèƒ½

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

### åŸå›  1ï¼šCORS é…ç½®ç¼ºå¤±ï¼ˆæœ€å¯èƒ½ï¼‰

**é—®é¢˜æè¿°ï¼š**
- åç«¯ CORS é…ç½®ä¸­æ²¡æœ‰åŒ…å«ç”Ÿäº§åŸŸå `http://aikz.usdt2026.cc`
- å¯¼è‡´æµè§ˆå™¨é˜»æ­¢è·¨åŸŸè¯·æ±‚ï¼Œå³ä½¿æœ‰ token ä¹Ÿæ— æ³•åˆ°è¾¾åç«¯

**è¯æ®ï¼š**
- æµè§ˆå™¨å·²ç™»å½•ï¼ˆæ˜¾ç¤º"ç™»å½•æˆåŠŸ æ­£åœ¨è·³è½¬..."ï¼‰
- ä½†æ‰€æœ‰ API è¯·æ±‚è¿”å› 401
- æ‰€æœ‰æŒ‡æ ‡æ˜¾ç¤ºä¸º 0ï¼ˆæ— æ³•è·å–æ•°æ®ï¼‰

**ä»£ç ä½ç½®ï¼š**
- `admin-backend/app/core/config.py:21` - CORS é»˜è®¤é…ç½®
- `admin-backend/app/main.py:105-117` - CORS ä¸­é—´ä»¶é…ç½®

**é»˜è®¤é…ç½®ï¼š**
```python
cors_origins: str = "http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:8080"
```

**ç¼ºå¤±ï¼š** `http://aikz.usdt2026.cc`

### åŸå›  2ï¼šé…ç½®è·¯å¾„ä¸æ˜ç¡®

**é—®é¢˜æè¿°ï¼š**
- æ— æ³•æ‰¾åˆ° `.env` æ–‡ä»¶
- æ— æ³•ç¡®å®šåç«¯æœåŠ¡å
- æ— æ³•ç›´æ¥ä¿®æ”¹é…ç½®

**å¯èƒ½çš„æƒ…å†µï¼š**
1. åç«¯ä½¿ç”¨ç¯å¢ƒå˜é‡è€Œä¸æ˜¯ `.env` æ–‡ä»¶
2. é…ç½®æ–‡ä»¶åœ¨å…¶ä»–ä½ç½®
3. åç«¯é€šè¿‡ systemd çš„ `EnvironmentFile` é…ç½®
4. åç«¯é€šè¿‡ Docker ç¯å¢ƒå˜é‡é…ç½®

### åŸå›  3ï¼šWebSocket è¿æ¥é—®é¢˜ï¼ˆæ¬¡è¦ï¼‰

**é—®é¢˜æè¿°ï¼š**
- WebSocket è¿æ¥å¤±è´¥
- å¯èƒ½å½±å“å®æ—¶é€šçŸ¥åŠŸèƒ½

**å¯èƒ½åŸå› ï¼š**
1. WebSocket è·¯å¾„é…ç½®é—®é¢˜ï¼ˆå·²ä¿®å¤ Nginxï¼‰
2. åç«¯ WebSocket æœåŠ¡æœªå¯åŠ¨
3. è®¤è¯ token åœ¨ WebSocket è¿æ¥ä¸­æœªæ­£ç¡®ä¼ é€’

## ğŸ¯ è§£å†³æ–¹æ¡ˆä¼˜å…ˆçº§

### ä¼˜å…ˆçº§ 1ï¼šæ‰¾åˆ°å¹¶ä¿®å¤ CORS é…ç½®ï¼ˆå¿…é¡»ï¼‰

**æ­¥éª¤ï¼š**

1. **æŸ¥æ‰¾é…ç½®ä½ç½®**
   ```bash
   # æŸ¥æ‰¾ .env æ–‡ä»¶
   find /opt /home /root -name ".env" -type f 2>/dev/null | grep -E "(admin|backend)"
   
   # æŸ¥æ‰¾ systemd æœåŠ¡æ–‡ä»¶
   ls -la /etc/systemd/system/*backend*.service
   ls -la /etc/systemd/system/*liaotian*.service
   
   # æŸ¥æ‰¾è¿è¡Œä¸­çš„åç«¯è¿›ç¨‹
   ps aux | grep -E "(gunicorn|uvicorn|python.*main)" | grep -v grep
   ```

2. **æ ¹æ®æ‰¾åˆ°çš„é…ç½®æ–¹å¼ä¿®å¤**

   **æƒ…å†µ Aï¼šæ‰¾åˆ° .env æ–‡ä»¶**
   ```bash
   # æ·»åŠ ç”Ÿäº§åŸŸå
   sudo sed -i 's|CORS_ORIGINS=\(.*\)|CORS_ORIGINS=\1,http://aikz.usdt2026.cc|' /path/to/.env
   ```

   **æƒ…å†µ Bï¼šsystemd æœåŠ¡æ–‡ä»¶ä¸­æœ‰ EnvironmentFile**
   ```bash
   # æŸ¥çœ‹æœåŠ¡æ–‡ä»¶
   cat /etc/systemd/system/*backend*.service | grep EnvironmentFile
   
   # ç¼–è¾‘å¯¹åº”çš„ç¯å¢ƒæ–‡ä»¶
   sudo nano /path/to/environment/file
   # æ·»åŠ ï¼šCORS_ORIGINS=...,http://aikz.usdt2026.cc
   ```

   **æƒ…å†µ Cï¼šç›´æ¥åœ¨ systemd æœåŠ¡æ–‡ä»¶ä¸­æ·»åŠ ç¯å¢ƒå˜é‡**
   ```bash
   # ç¼–è¾‘æœåŠ¡æ–‡ä»¶
   sudo nano /etc/systemd/system/*backend*.service
   
   # åœ¨ [Service] éƒ¨åˆ†æ·»åŠ ï¼š
   Environment="CORS_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:8080,http://aikz.usdt2026.cc"
   ```

3. **é‡å¯åç«¯æœåŠ¡**
   ```bash
   # å¦‚æœæ‰¾åˆ°æœåŠ¡å
   sudo systemctl daemon-reload
   sudo systemctl restart <service-name>
   
   # æˆ–è€…é‡å¯è¿è¡Œä¸­çš„è¿›ç¨‹
   # å…ˆæ‰¾åˆ°è¿›ç¨‹ ID
   ps aux | grep gunicorn
   # ç„¶åé‡å¯ï¼ˆæ ¹æ®å®é™…éƒ¨ç½²æ–¹å¼ï¼‰
   ```

### ä¼˜å…ˆçº§ 2ï¼šéªŒè¯ä¿®å¤æ•ˆæœ

**æ­¥éª¤ï¼š**

1. **æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ**
   ```bash
   # æ£€æŸ¥ CORS_ORIGINS é…ç½®
   grep CORS_ORIGINS /path/to/config
   
   # æ£€æŸ¥åç«¯æ—¥å¿—
   sudo journalctl -u <service-name> -n 50 | grep -i cors
   ```

2. **æµ‹è¯• API**
   ```bash
   # æµ‹è¯•ç™»å½• API
   curl -X POST http://localhost:8000/api/v1/auth/login \
     -H "Content-Type: application/x-www-form-urlencoded" \
     -d "username=admin@example.com&password=changeme123"
   ```

3. **æµè§ˆå™¨éªŒè¯**
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
   - è®¿é—® `http://aikz.usdt2026.cc/login` é‡æ–°ç™»å½•
   - è®¿é—® `http://aikz.usdt2026.cc/group-ai/accounts`
   - æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼Œç¡®è®¤ API è¯·æ±‚è¿”å› 200

### ä¼˜å…ˆçº§ 3ï¼šä¿®å¤ WebSocket è¿æ¥ï¼ˆå¯é€‰ï¼‰

**æ­¥éª¤ï¼š**

1. **æ£€æŸ¥åç«¯ WebSocket æœåŠ¡**
   ```bash
   # æ£€æŸ¥åç«¯æ—¥å¿—
   sudo journalctl -u <service-name> -n 100 | grep -i websocket
   ```

2. **éªŒè¯ WebSocket ç«¯ç‚¹**
   ```bash
   # æµ‹è¯• WebSocket è¿æ¥ï¼ˆéœ€è¦ tokenï¼‰
   wscat -c ws://localhost:8000/api/v1/notifications/ws/test@example.com \
     -H "Authorization: Bearer <token>"
   ```

## ğŸ“‹ æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µ 1ï¼šè¯Šæ–­ï¼ˆç«‹å³æ‰§è¡Œï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡ŒæŸ¥æ‰¾è„šæœ¬
bash /tmp/æŸ¥æ‰¾é…ç½®.sh
```

**é¢„æœŸè¾“å‡ºï¼š**
- `.env` æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- systemd æœåŠ¡å
- è¿è¡Œä¸­çš„åç«¯è¿›ç¨‹ä¿¡æ¯
- ç«¯å£ 8000 çš„ç›‘å¬è¿›ç¨‹

### é˜¶æ®µ 2ï¼šä¿®å¤ï¼ˆæ ¹æ®è¯Šæ–­ç»“æœï¼‰

**å¦‚æœæ‰¾åˆ° .env æ–‡ä»¶ï¼š**
```bash
# ä½¿ç”¨è‡ªåŠ¨ä¿®å¤è„šæœ¬
sudo bash /tmp/ä¿®å¤401.sh
```

**å¦‚æœä½¿ç”¨ systemd ç¯å¢ƒå˜é‡ï¼š**
```bash
# æ‰‹åŠ¨ç¼–è¾‘æœåŠ¡æ–‡ä»¶æˆ–ç¯å¢ƒæ–‡ä»¶
sudo nano /etc/systemd/system/<service-name>.service
# æ·»åŠ  CORS_ORIGINS ç¯å¢ƒå˜é‡
sudo systemctl daemon-reload
sudo systemctl restart <service-name>
```

### é˜¶æ®µ 3ï¼šéªŒè¯ï¼ˆä¿®å¤åï¼‰

1. **æœåŠ¡å™¨ç«¯éªŒè¯**
   - æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®
   - æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
   - æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

2. **æµè§ˆå™¨ç«¯éªŒè¯**
   - é‡æ–°ç™»å½•
   - æ£€æŸ¥ API è¯·æ±‚æ˜¯å¦æˆåŠŸ
   - æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£å¸¸æ˜¾ç¤º

## ğŸ”§ å¿«é€Ÿä¿®å¤å‘½ä»¤ï¼ˆé€šç”¨ï¼‰

å¦‚æœæ— æ³•æ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹é€šç”¨æ–¹æ³•ï¼š

```bash
# 1. æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„é…ç½®ä½ç½®
find /opt /home /root -name "*.env" -o -name "*backend*" -type f 2>/dev/null | head -20

# 2. æŸ¥æ‰¾æ‰€æœ‰ systemd æœåŠ¡
systemctl list-units --type=service --all | grep -E "(backend|admin)"

# 3. æŸ¥æ‰¾è¿è¡Œä¸­çš„è¿›ç¨‹åŠå…¶å·¥ä½œç›®å½•
ps aux | grep -E "gunicorn|uvicorn" | grep -v grep
# æŸ¥çœ‹è¿›ç¨‹çš„å·¥ä½œç›®å½•ï¼ˆä»è¾“å‡ºä¸­è·å– PIDï¼Œç„¶åï¼‰
ls -la /proc/<PID>/cwd

# 4. æ£€æŸ¥ç«¯å£ 8000 çš„è¿›ç¨‹
sudo lsof -i :8000
# æˆ–
sudo netstat -tlnp | grep :8000
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½é…ç½®**
   - ä¿®æ”¹å‰åŠ¡å¿…å¤‡ä»½é…ç½®æ–‡ä»¶
   - è®°å½•åŸå§‹é…ç½®å€¼

2. **æœåŠ¡é‡å¯**
   - ä¿®æ”¹é…ç½®åå¿…é¡»é‡å¯åç«¯æœåŠ¡
   - å¦‚æœä½¿ç”¨ systemdï¼Œéœ€è¦ `daemon-reload`

3. **éªŒè¯é¡ºåº**
   - å…ˆä¿®å¤ CORS é…ç½®
   - å†å¤„ç† WebSocket é—®é¢˜
   - æœ€åéªŒè¯æ•´ä½“åŠŸèƒ½

4. **æ—¥å¿—æ£€æŸ¥**
   - ä¿®å¤åæ£€æŸ¥åç«¯æ—¥å¿—
   - æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—
   - æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®å¤æˆåŠŸåï¼š
- âœ… API è¯·æ±‚è¿”å› 200ï¼ˆä¸æ˜¯ 401ï¼‰
- âœ… é¡µé¢æ•°æ®æ­£å¸¸æ˜¾ç¤ºï¼ˆä¸æ˜¯å…¨ 0ï¼‰
- âœ… WebSocket è¿æ¥æˆåŠŸï¼ˆå¯é€‰ï¼‰
- âœ… æµè§ˆå™¨æ§åˆ¶å°æ— è®¤è¯é”™è¯¯

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œï¼š** è¿è¡ŒæŸ¥æ‰¾è„šæœ¬ï¼Œç¡®å®šé…ç½®è·¯å¾„
2. **æ ¹æ®ç»“æœï¼š** ä½¿ç”¨å¯¹åº”çš„ä¿®å¤æ–¹æ³•
3. **éªŒè¯ä¿®å¤ï¼š** åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•åŠŸèƒ½
4. **å¦‚æœ‰é—®é¢˜ï¼š** æä¾›æŸ¥æ‰¾è„šæœ¬çš„è¾“å‡ºç»“æœï¼Œæˆ‘ä¼šæä¾›ç²¾ç¡®çš„ä¿®å¤å‘½ä»¤

