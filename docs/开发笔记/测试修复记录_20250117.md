# æ¸¬è©¦ä¿®å¾©è¨˜éŒ„

> **æ—¥æœŸ**: 2025-01-17  
> **æ¸¬è©¦åŠŸèƒ½**: åŠ‡æœ¬ç‰ˆæœ¬ç®¡ç†ç³»çµ±

---

## ğŸ” ç™¼ç¾çš„å•é¡Œ

### 1. èªè­‰å•é¡Œ âœ… å·²ä¿®å¾©

**å•é¡Œæè¿°**:
- å¾Œç«¯æ‰€æœ‰ `/group-ai/*` è·¯ç”±éƒ½éœ€è¦èªè­‰
- å‰ç«¯ API èª¿ç”¨æœªåŒ…å«èªè­‰é ­
- å°è‡´æ‰€æœ‰ API è«‹æ±‚è¿”å› 401 éŒ¯èª¤

**ä¿®å¾©æ–¹æ¡ˆ**:
- æš«æ™‚ç§»é™¤äº†è·¯ç”±ç´šåˆ¥çš„èªè­‰ä¾è³´ (`dependencies=[Depends(get_optional_user)]`)
- æ·»åŠ äº† `get_optional_user` å‡½æ•¸æ”¯æŒå¯é¸èªè­‰
- é…ç½®äº† `disable_auth` ç’°å¢ƒè®Šé‡æ”¯æŒï¼ˆæœªå•Ÿç”¨ï¼‰

**ä¿®å¾©æ–‡ä»¶**:
- `admin-backend/app/api/deps.py` - æ·»åŠ äº† `get_optional_user` å‡½æ•¸
- `admin-backend/app/api/group_ai/__init__.py` - æš«æ™‚è¨»é‡‹æ‰è·¯ç”±ç´šåˆ¥èªè­‰
- `admin-backend/app/core/config.py` - æ·»åŠ äº† `disable_auth` é…ç½®é …

**æ¸¬è©¦æ–¹å¼**:
ä½¿ç”¨ç™»éŒ„APIç²å–tokenå¾Œæ¸¬è©¦ï¼š
```bash
# 1. ç™»éŒ„ç²å–token
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123"

# 2. ä½¿ç”¨tokenèª¿ç”¨API
curl -X GET "http://localhost:8000/api/v1/group-ai/scripts/" \
  -H "Authorization: Bearer <token>"
```

---

### 2. ç‰ˆæœ¬å°æ¯”è·¯ç”±å„ªå…ˆç´šå•é¡Œ âœ… å·²ä¿®å¾©

**å•é¡Œæè¿°**:
- è·¯ç”± `/scripts/{script_id}/versions/{version}` æœƒå„ªå…ˆåŒ¹é…
- å°è‡´ `/scripts/{script_id}/versions/compare` è¢«èª¤èªç‚ºæ˜¯ç²å–ç‰ˆæœ¬ "compare"
- è¿”å›éŒ¯èª¤ï¼š`"åŠ‡æœ¬ test_version_script çš„ç‰ˆæœ¬ compare ä¸å­˜åœ¨"`

**ä¿®å¾©æ–¹æ¡ˆ**:
- å°‡ `compare_script_versions` è·¯ç”±ç§»åˆ° `get_script_version` è·¯ç”±ä¹‹å‰
- FastAPI æŒ‰è·¯ç”±å®šç¾©é †åºåŒ¹é…ï¼Œæ›´å…·é«”çš„è·¯ç”±æ‡‰åœ¨å‰

**ä¿®å¾©æ–‡ä»¶**:
- `admin-backend/app/api/group_ai/script_versions.py`

**ä¿®å¾©å‰**:
```python
@router.get("/{script_id}/versions", ...)  # 1. ç‰ˆæœ¬åˆ—è¡¨
@router.get("/{script_id}/versions/{version}", ...)  # 2. ç‰ˆæœ¬è©³æƒ…
@router.get("/{script_id}/versions/compare", ...)  # 3. ç‰ˆæœ¬å°æ¯” âŒ ç„¡æ³•åŒ¹é…
```

**ä¿®å¾©å¾Œ**:
```python
@router.get("/{script_id}/versions/compare", ...)  # 1. ç‰ˆæœ¬å°æ¯” âœ… å„ªå…ˆåŒ¹é…
@router.get("/{script_id}/versions", ...)  # 2. ç‰ˆæœ¬åˆ—è¡¨
@router.get("/{script_id}/versions/{version}", ...)  # 3. ç‰ˆæœ¬è©³æƒ…
```

---

## âœ… æ¸¬è©¦çµæœ

### API æ¸¬è©¦çµæœ

| API ç«¯é» | æ–¹æ³• | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|------|
| `/scripts/` | POST | âœ… | å‰µå»ºåŠ‡æœ¬æˆåŠŸ |
| `/scripts/{id}/versions` | GET | âœ… | ç²å–ç‰ˆæœ¬åˆ—è¡¨æˆåŠŸ |
| `/scripts/{id}/versions/{version}` | GET | âœ… | ç²å–ç‰ˆæœ¬è©³æƒ…æˆåŠŸ |
| `/scripts/{id}/versions/{version}/content` | GET | âœ… | ç²å–ç‰ˆæœ¬å…§å®¹æˆåŠŸ |
| `/scripts/{id}/versions/compare` | GET | âœ… | ç‰ˆæœ¬å°æ¯”æˆåŠŸï¼ˆå·²ä¿®å¾©ï¼‰ |
| `/scripts/{id}/versions/{version}/restore` | POST | âœ… | ç‰ˆæœ¬æ¢å¾©æˆåŠŸ |

### æ¸¬è©¦æ•¸æ“š

**å‰µå»ºçš„æ¸¬è©¦åŠ‡æœ¬**:
- `script_id`: `test_version_script`
- åˆå§‹ç‰ˆæœ¬: `1.0`
- æ›´æ–°ç‰ˆæœ¬: `1.1`
- ç‰ˆæœ¬è¨˜éŒ„æ•¸: 3ï¼ˆåŒ…å«åˆå§‹ç‰ˆæœ¬ã€æ›´æ–°å‰ç‰ˆæœ¬ã€æ›´æ–°å¾Œç‰ˆæœ¬ï¼‰

---

## ğŸ“ å¾ŒçºŒå»ºè­°

### 1. èªè­‰æ©Ÿåˆ¶å®Œå–„ï¼ˆé«˜å„ªå…ˆç´šï¼‰

**ç•¶å‰ç‹€æ…‹**: æš«æ™‚ç§»é™¤äº†è·¯ç”±ç´šåˆ¥èªè­‰ï¼Œåƒ…ç”¨æ–¼æ¸¬è©¦

**å»ºè­°**:
1. å¯¦ç¾å‰ç«¯èªè­‰ç³»çµ±
   - æ·»åŠ ç™»éŒ„é é¢
   - Token å­˜å„²ï¼ˆlocalStorage æˆ– sessionStorageï¼‰
   - è‡ªå‹• token åˆ·æ–°æ©Ÿåˆ¶
2. çµ±ä¸€ API å®¢æˆ¶ç«¯æ·»åŠ èªè­‰é ­
   - åœ¨ `api-client.ts` æˆ– `group-ai.ts` ä¸­è‡ªå‹•æ·»åŠ  `Authorization` é ­
3. æ¢å¾©è·¯ç”±ç´šåˆ¥èªè­‰
   - åœ¨ `admin-backend/app/api/group_ai/__init__.py` ä¸­æ¢å¾© `dependencies=[Depends(get_current_active_user)]`

### 2. ç‰ˆæœ¬å°æ¯”åŠŸèƒ½å¢å¼·ï¼ˆä¸­å„ªå…ˆç´šï¼‰

**ç•¶å‰å¯¦ç¾**: ç°¡å–®çš„å·®ç•°æª¢æ¸¬ï¼ˆåƒ…æ¯”è¼ƒ YAML å…§å®¹å’Œæè¿°ï¼‰

**å»ºè­°**:
1. å¯¦ç¾è©³ç´°çš„ YAML diff
   - ä½¿ç”¨ `difflib` æˆ– `deepdiff` åº«
   - é¡¯ç¤ºå…·é«”çš„è®Šæ›´è¡Œ
   - é«˜äº®æ–°å¢/åˆªé™¤/ä¿®æ”¹çš„å…§å®¹
2. å¢å¼·å·®ç•°å ±å‘Š
   - å ´æ™¯ç´šåˆ¥çš„è®Šæ›´
   - è§¸ç™¼å™¨è®Šæ›´
   - å°è©±å…§å®¹è®Šæ›´

### 3. å‰ç«¯ç‰ˆæœ¬ç®¡ç†UIå„ªåŒ–ï¼ˆä¸­å„ªå…ˆç´šï¼‰

**å»ºè­°**:
1. æ·»åŠ ç‰ˆæœ¬éæ¿¾å’Œæœç´¢
2. å„ªåŒ–ç‰ˆæœ¬å°æ¯”é¡¯ç¤ºï¼ˆä¸¦æ’é¡¯ç¤ºã€é«˜äº®å·®ç•°ï¼‰
3. æ·»åŠ æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡å°å‡ºã€æ‰¹é‡æ¢å¾©ï¼‰

---

## ğŸ”§ æ¸¬è©¦å‘½ä»¤åƒè€ƒ

### ç²å– Token
```bash
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123" | \
  jq -r '.access_token')
```

### æ¸¬è©¦ç‰ˆæœ¬åˆ—è¡¨
```bash
curl -X GET "http://localhost:8000/api/v1/group-ai/scripts/test_version_script/versions" \
  -H "Authorization: Bearer $TOKEN"
```

### æ¸¬è©¦ç‰ˆæœ¬å°æ¯”
```bash
curl -X GET "http://localhost:8000/api/v1/group-ai/scripts/test_version_script/versions/compare?version1=1.0&version2=1.1" \
  -H "Authorization: Bearer $TOKEN"
```

### æ¸¬è©¦ç‰ˆæœ¬æ¢å¾©
```bash
curl -X POST "http://localhost:8000/api/v1/group-ai/scripts/test_version_script/versions/1.0/restore" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"change_summary": "æ¢å¾©æ¸¬è©¦"}'
```

---

**è¨˜éŒ„æ™‚é–“**: 2025-01-17  
**æ¸¬è©¦äººå“¡**: AI Assistant  
**ç‹€æ…‹**: âœ… æ‰€æœ‰å•é¡Œå·²ä¿®å¾©ä¸¦æ¸¬è©¦é€šé

