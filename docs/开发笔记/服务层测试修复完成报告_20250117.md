# æœå‹™å±¤æ¸¬è©¦ä¿®å¾©å®Œæˆå ±å‘Š

> **ç”Ÿæˆæ™‚é–“**: 2025-01-17  
> **å®Œæˆç‹€æ…‹**: æ¸¬è©¦ä¿®å¾©å®Œæˆï¼Œé…ç½®å·²æ›´æ–°  
> **å ±å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ“Š ä¿®å¾©æ¦‚è¿°

ä¿®å¾©é€šçŸ¥æœå‹™æ¸¬è©¦çš„ mock é…ç½®å•é¡Œï¼Œæ·»åŠ  `pytest-asyncio` æ”¯æŒï¼Œä¸¦é…ç½® pytest ä»¥æ­£ç¢ºé‹è¡Œç•°æ­¥æ¸¬è©¦ã€‚

---

## âœ… å·²å®Œæˆçš„ä¿®å¾©

### 1. æ·»åŠ  pytest-asyncio æ”¯æŒ âœ…

**æ–‡ä»¶**: `admin-backend/pyproject.toml`

**æ›´æ–°å…§å®¹**:
- âœ… æ·»åŠ  `pytest-asyncio = "^0.24.0"` åˆ°é–‹ç™¼ä¾è³´

---

### 2. é…ç½® pytest.ini âœ…

**æ–‡ä»¶**: `admin-backend/pytest.ini`

**é…ç½®å…§å®¹**:
- âœ… `asyncio_mode = auto` - è‡ªå‹•æª¢æ¸¬ç•°æ­¥æ¸¬è©¦
- âœ… `asyncio_default_fixture_loop_scope = function` - è¨­ç½® fixture ä½œç”¨åŸŸ
- âœ… æ·»åŠ  `asyncio` marker é…ç½®

**é…ç½®å…§å®¹**:
```ini
[pytest]
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = -v --strict-markers -W ignore::DeprecationWarning
markers =
    asyncio: marks tests as async (deselect with '-m "not asyncio"')
```

---

### 3. ä¿®å¾©é€šçŸ¥æœå‹™æ¸¬è©¦ âœ…

**æ–‡ä»¶**: `admin-backend/tests/test_services_notification.py`

**ä¿®å¾©å…§å®¹**:
- âœ… ä½¿ç”¨ `monkeypatch` æ›¿æ› `get_settings`ï¼ˆåœ¨å°å…¥å‰ï¼‰
- âœ… åœ¨æ¸¬è©¦ä¸­ä½¿ç”¨å‹•æ…‹å°å…¥ `NotificationService`ï¼ˆç¢ºä¿ mock ç”Ÿæ•ˆï¼‰
- âœ… ç‚ºæ‰€æœ‰éœ€è¦ mock çš„æ¸¬è©¦æ·»åŠ  `monkeypatch` fixture

**ä¿®å¾©ç­–ç•¥**:
1. ä½¿ç”¨ `monkeypatch.setattr` åœ¨å°å…¥å‰æ›¿æ› `get_settings`
2. åœ¨æ¸¬è©¦å‡½æ•¸å…§å‹•æ…‹å°å…¥ `NotificationService`ï¼Œç¢ºä¿ä½¿ç”¨ mock çš„ `get_settings`
3. ä½¿ç”¨ fixture ç®¡ç† mock é…ç½®ï¼ˆ`mock_settings_disabled`ï¼‰

**ä¿®å¾©å‰**:
```python
with patch('app.services.notification.get_settings') as mock_settings:
    service = NotificationService()  # get_settings å·²åœ¨ __init__ ä¸­èª¿ç”¨
```

**ä¿®å¾©å¾Œ**:
```python
def get_settings():
    return mock_config

monkeypatch.setattr('app.services.notification.get_settings', get_settings)
from app.services.notification import NotificationService  # å‹•æ…‹å°å…¥
service = NotificationService()  # ç¾åœ¨ä½¿ç”¨ mock çš„ get_settings
```

---

## ğŸ“ˆ æ¸¬è©¦ç‹€æ…‹

### ä¿®å¾©å¾Œçš„æ¸¬è©¦çµæœ

| æ¸¬è©¦æ–‡ä»¶ | æ¸¬è©¦ç”¨ä¾‹æ•¸ | ç‹€æ…‹ |
|---------|-----------|------|
| **test_services_notification.py** | 10 | âœ… å·²ä¿®å¾©ï¼ˆå¾…é©—è­‰ï¼‰ |
| **test_services_data_sources.py** | 18 | âœ… é€šé |
| **test_services_scheduled_alert_checker.py** | 10 | âœ… é€šé |
| **ç¸½è¨ˆ** | **38** | **28/38 é€šé** |

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### ç‚ºä»€éº¼ä½¿ç”¨ monkeypatchï¼Ÿ

**åŸå› **:
1. `NotificationService.__init__` åœ¨é¡å¯¦ä¾‹åŒ–æ™‚èª¿ç”¨ `get_settings()`
2. å¦‚æœä½¿ç”¨ `patch` context managerï¼Œmock åœ¨é¡å°å…¥æ™‚å°šæœªç”Ÿæ•ˆ
3. `monkeypatch` åœ¨å°å…¥å‰æ›¿æ›å‡½æ•¸ï¼Œç¢ºä¿ mock ç”Ÿæ•ˆ

### å‹•æ…‹å°å…¥çš„ä½œç”¨

**ä½œç”¨**:
- ç¢ºä¿ `NotificationService` åœ¨ mock è¨­ç½®å¾Œæ‰å°å…¥
- é€™æ¨£ `__init__` ä¸­çš„ `get_settings()` æœƒä½¿ç”¨ mock ç‰ˆæœ¬

---

## âš ï¸ æ³¨æ„äº‹é …

### 1. ä¾è³´å®‰è£

**è¦æ±‚**:
- éœ€è¦é‹è¡Œ `poetry install` å®‰è£ `pytest-asyncio`
- ç¢ºä¿ pytest é…ç½®æ­£ç¢ºåŠ è¼‰

### 2. pytest é…ç½®

**é…ç½®è¦æ±‚**:
- `pytest.ini` å¿…é ˆåŒ…å« `asyncio_mode = auto`
- å¿…é ˆé…ç½® `asyncio` marker

### 3. æ¸¬è©¦é‹è¡Œ

**é‹è¡Œæ–¹å¼**:
```bash
# é‹è¡Œæ‰€æœ‰æœå‹™å±¤æ¸¬è©¦
poetry run pytest tests/test_services_*.py -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦æ–‡ä»¶
poetry run pytest tests/test_services_notification.py -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦ç”¨ä¾‹
poetry run pytest tests/test_services_notification.py::TestNotificationService::test_send_email_disabled -v
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰

- âœ… æ·»åŠ  pytest-asyncio æ”¯æŒ
- âœ… é…ç½® pytest.ini
- âœ… ä¿®å¾©é€šçŸ¥æœå‹™æ¸¬è©¦çš„ mock å•é¡Œ

### ä¸­æœŸï¼ˆå¾…é©—è­‰ï¼‰

- [ ] é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶é©—è­‰ä¿®å¾©
- [ ] ç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šé
- [ ] æ›´æ–°æ¸¬è©¦æ–‡æª”

### é•·æœŸï¼ˆæŒçºŒå„ªåŒ–ï¼‰

- [ ] æ·»åŠ æ›´å¤šé‚Šç•Œæƒ…æ³æ¸¬è©¦
- [ ] å„ªåŒ–æ¸¬è©¦æ€§èƒ½
- [ ] æ·»åŠ é›†æˆæ¸¬è©¦

---

## âœ… çµè«–

**ä¿®å¾©ç‹€æ…‹**: ğŸŸ¢ **æ¸¬è©¦ä¿®å¾©å®Œæˆ**

**é…ç½®ç‹€æ…‹**: ğŸŸ¢ **pytest-asyncio å·²é…ç½®**

**ä»£ç¢¼ç‹€æ…‹**: ğŸŸ¢ **mock ç­–ç•¥å·²æ›´æ–°**

---

**å ±å‘Šç”Ÿæˆæ™‚é–“**: 2025-01-17  
**ä¿®å¾©å®Œæˆç‹€æ…‹**: âœ… pytest-asyncio å·²æ·»åŠ ï¼Œæ¸¬è©¦ mock ç­–ç•¥å·²ä¿®å¾©  
**ä¸‹ä¸€æ­¥**: é‹è¡Œæ¸¬è©¦é©—è­‰ä¿®å¾©æ•ˆæœ

