# AccountManager 手動測試指南

> **更新日期**: 2024-12-19

---

## 測試方式

### 方式 1: 快速測試（推薦先運行）

**無需真實 session 文件，只測試基本功能**

```bash
python scripts/test_account_manager_quick.py
```

**測試內容**:
- 創建 AccountManager
- 列出賬號（空列表）
- 獲取不存在的賬號狀態
- 錯誤處理（不存在的文件）
- 配置檢查

**預期結果**: 所有測試應該通過

---

### 方式 2: 完整測試

**需要真實的 Telegram session 文件和 API 憑證**

```bash
python scripts/test_account_manager.py
```

**前置條件**:
1. 配置 Telegram API 憑證
   - 在 `config.py` 中設置 `TELEGRAM_API_ID` 和 `TELEGRAM_API_HASH`
   - 或設置環境變量

2. 準備測試 session 文件
   - 創建 `sessions/` 目錄
   - 將 `.session` 文件放入該目錄

**測試內容**:
1. ✅ 基本操作測試
   - 創建管理器
   - 列出賬號
   - 獲取狀態

2. ✅ 添加賬號測試
   - 從 session 文件添加賬號
   - 驗證配置

3. ✅ 列出賬號測試
   - 顯示所有賬號信息

4. ✅ 獲取狀態測試
   - 獲取賬號詳細狀態

5. ⚠️ 啟動/停止賬號測試（需要用戶確認）
   - 啟動賬號（需要真實連接）
   - 停止賬號

6. ⚠️ 批量加載測試（需要用戶確認）
   - 從目錄批量加載所有 session 文件

7. ⚠️ 移除賬號測試（需要用戶確認）
   - 移除測試賬號

---

## 測試步驟詳解

### 步驟 1: 準備環境

```bash
# 1. 確保在項目根目錄
cd "C:\Users\Administrator\Desktop\新建文件夹\聊天AI08-继续开发"

# 2. 檢查 config.py 是否存在並配置了 API 憑證
# 應該包含:
#   TELEGRAM_API_ID = ...
#   TELEGRAM_API_HASH = ...

# 3. 創建 sessions 目錄（如果不存在）
mkdir sessions

# 4. 將測試用的 .session 文件放入 sessions/ 目錄
# 例如: sessions/test_account.session
```

### 步驟 2: 運行快速測試

```bash
python scripts/test_account_manager_quick.py
```

**預期輸出**:
```
============================================================
AccountManager 快速測試（無需真實 session）
============================================================

[1] 創建 AccountManager...
✓ AccountManager 創建成功

[2] 列出所有賬號...
✓ 當前賬號數量: 0

[3] 獲取不存在的賬號狀態...
✓ 正確返回 None（賬號不存在）

[4] 嘗試添加不存在的 session 文件...
✓ 正確捕獲 FileNotFoundError

[5] 檢查配置...
✓ 最大賬號數: 100
✓ 默認回復頻率: 0.3
✓ 健康檢查間隔: 60 秒

============================================================
快速測試完成！
============================================================
```

### 步驟 3: 運行完整測試

```bash
python scripts/test_account_manager.py
```

**測試過程**:
1. 腳本會自動檢測 session 文件
2. 對於需要真實連接的測試，會詢問是否繼續
3. 可以選擇跳過某些測試

**示例交互**:
```
[5.1] 啟動賬號: test_account
⚠ 注意: 這需要有效的 Telegram API 憑證和 session 文件
  是否嘗試啟動賬號？(y/N): y
✓ 賬號啟動成功
  當前狀態: online
  在線: True
```

---

## 常見問題

### Q1: 提示 "未找到 config.py 或 API 憑證未配置"

**解決方案**:
1. 檢查 `config.py` 文件是否存在
2. 確認文件中包含 `TELEGRAM_API_ID` 和 `TELEGRAM_API_HASH`
3. 或設置環境變量:
   ```bash
   set TELEGRAM_API_ID=your_api_id
   set TELEGRAM_API_HASH=your_api_hash
   ```

### Q2: 提示 "Session 文件不存在"

**解決方案**:
1. 確認 `sessions/` 目錄存在
2. 確認目錄中有 `.session` 文件
3. 檢查文件路徑是否正確

### Q3: 啟動賬號失敗

**可能原因**:
1. Session 文件無效或過期
2. API 憑證錯誤
3. 網絡連接問題
4. Telegram 服務暫時不可用

**解決方案**:
1. 重新生成 session 文件
2. 檢查 API 憑證
3. 檢查網絡連接
4. 稍後重試

### Q4: 測試過程中出現異常

**解決方案**:
1. 查看完整的錯誤信息
2. 檢查日誌輸出
3. 確認所有依賴已安裝:
   ```bash
   cd admin-backend
   poetry install
   ```

---

## 測試檢查清單

### 基本功能測試
- [ ] AccountManager 可以正常創建
- [ ] 可以列出賬號（初始為空）
- [ ] 獲取不存在的賬號返回 None
- [ ] 添加不存在的 session 文件會拋出錯誤

### 添加賬號測試
- [ ] 可以添加有效的 session 文件
- [ ] 賬號配置正確保存
- [ ] 重複添加同一賬號會返回已存在的賬號

### 狀態查詢測試
- [ ] 可以獲取賬號狀態
- [ ] 狀態信息完整（消息數、回復數等）
- [ ] 狀態更新正確

### 啟動/停止測試（需要真實連接）
- [ ] 可以啟動賬號
- [ ] 啟動後狀態變為 online
- [ ] 可以停止賬號
- [ ] 停止後狀態變為 offline

### 批量加載測試
- [ ] 可以從目錄批量加載
- [ ] 所有 session 文件都被正確加載
- [ ] 錯誤的 session 文件被跳過並記錄

### 移除賬號測試
- [ ] 可以移除賬號
- [ ] 移除後賬號從列表中消失
- [ ] 移除在線賬號會先停止

---

## 測試結果記錄

### 測試環境
- **操作系統**: Windows 10
- **Python 版本**: 3.11+
- **測試日期**: 2024-12-19

### 測試結果

| 測試項 | 狀態 | 備註 |
|--------|------|------|
| 快速測試 | ✅ 通過 | 所有基本功能正常 |
| 添加賬號 | ✅ 通過 | 需要有效 session 文件 |
| 列出賬號 | ✅ 通過 | - |
| 獲取狀態 | ✅ 通過 | - |
| 啟動賬號 | ⚠️ 需驗證 | 需要真實連接 |
| 停止賬號 | ⚠️ 需驗證 | 需要真實連接 |
| 批量加載 | ⚠️ 需驗證 | 需要多個 session 文件 |
| 移除賬號 | ✅ 通過 | - |

---

## 下一步

測試通過後，可以:
1. 繼續完善其他功能
2. 開始階段 2 的開發（劇本引擎）
3. 完善 API 實現
4. 添加更多測試用例

---

**文檔版本**: v1.0  
**最後更新**: 2024-12-19

