# 核心功能測試指南

> **日期**: 2025-11-30  
> **測試對象**: 4個新實現的核心功能

---

## 📋 測試概述

本文檔提供4個核心功能的完整測試指南：

1. ✅ **多賬號協同邏輯** - 防止重複回復
2. ✅ **劇本熱更新** - 不重啟更新劇本
3. ✅ **新成員檢測** - 自動歡迎新成員
4. ✅ **多輪對話增強** - 意圖識別、話題檢測、情感分析

---

## 🚀 快速開始

### 方法 1: 自動化測試（推薦）

```bash
cd scripts
python test_core_features.py
```

這個腳本會自動測試所有4個功能。

---

## 📝 詳細測試步驟

### 測試 1: 多賬號協同邏輯

#### 1.1 單元測試

**測試文件**: `scripts/test_core_features.py`

**測試內容**:
- ✅ 協同管理器初始化
- ✅ 賬號註冊
- ✅ 優先級檢查
- ✅ 回復鎖機制

**執行**:
```bash
python scripts/test_core_features.py
```

**預期結果**:
```
✅ 協同管理器初始化成功
✅ 賬號註冊成功
   賬號1 (高優先級) 應該回復: True, 原因: ...
   賬號2 (正常優先級) 應該回復: False, 原因: ...
✅ 協同邏輯正確：只有高優先級賬號回復
```

#### 1.2 集成測試

**準備**:
1. 啟動後端服務
2. 創建2個測試賬號
3. 分配不同角色

**步驟**:
1. 登錄管理後台
2. 創建兩個賬號（account_1, account_2）
3. 分配角色：
   - account_1: role_1 (客服，高優先級)
   - account_2: role_2 (導師，正常優先級)
4. 啟動兩個賬號
5. 將兩個賬號加入同一測試群組
6. 在群組中發送測試消息："你好"

**驗證**:
- ✅ 只有一個賬號回復
- ✅ 高優先級的賬號回復
- ✅ 檢查日誌確認協同邏輯工作

**檢查日誌**:
```bash
# 應該看到類似日誌：
# 協同管理器決定不回復（賬號: account_2）: 已有其他賬號獲得回復鎖
# 生成回復（賬號: account_1）: ...
```

---

### 測試 2: 劇本熱更新

#### 2.1 單元測試

**測試內容**:
- ✅ 劇本解析
- ✅ 劇本初始化
- ✅ 熱更新方法
- ✅ 狀態保留

**執行**:
```bash
python scripts/test_core_features.py
```

**預期結果**:
```
✅ 劇本解析成功
✅ 原始劇本初始化成功
✅ 劇本熱更新成功
✅ 場景狀態保留: True
```

#### 2.2 API 測試

**準備**:
1. 後端服務運行中
2. 一個測試賬號已啟動並運行

**步驟**:
1. 獲取訪問令牌：
```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123"
```

2. 熱更新劇本：
```bash
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/{account_id}/hot-update-script \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "script_id": "new_script_id",
    "preserve_state": true
  }'
```

3. 驗證賬號繼續運行（不需要重啟）

4. 發送測試消息，確認新劇本生效

**驗證**:
- ✅ API 返回成功
- ✅ 賬號繼續運行（無中斷）
- ✅ 新劇本生效
- ✅ 當前場景被保留（如果新劇本中有相同場景）

**檢查日誌**:
```bash
# 應該看到：
# 賬號 {account_id} 劇本已熱更新，保留場景: scene1
# 賬號 {account_id} 劇本熱更新成功
```

---

### 測試 3: 新成員檢測

#### 3.1 單元測試

**測試內容**:
- ✅ `new_chat_members` 屬性檢測
- ✅ service 類型檢測
- ✅ 普通消息不誤判

**執行**:
```bash
python scripts/test_core_features.py
```

**預期結果**:
```
✅ 新成員檢測功能正常
```

#### 3.2 實際測試

**準備**:
1. 啟動一個AI賬號
2. 準備一個測試群組
3. 準備一個測試賬號（用於加入群組）

**步驟**:
1. 啟動AI賬號
2. 將AI賬號加入測試群組
3. 使用測試賬號加入群組
4. 觀察AI賬號是否自動發送歡迎消息

**驗證**:
- ✅ 檢測到新成員加入
- ✅ 自動發送歡迎消息
- ✅ 檢查日誌確認事件被正確處理

**檢查日誌**:
```bash
# 應該看到：
# 檢測到新成員加入（賬號: {account_id}, 群組: {group_id}）
# 已發送新成員歡迎消息（賬號: {account_id}, 群組: {group_id}）
```

#### 3.3 劇本配置測試

**步驟**:
1. 創建一個包含新成員觸發器的劇本：
```yaml
name: 歡迎劇本
scenes:
  - id: welcome
    triggers:
      - type: new_member
    responses:
      - template: "歡迎 {{user_name}} 加入我們的群組！🎉"
```

2. 將劇本分配給賬號
3. 重複上述實際測試步驟

**驗證**:
- ✅ 劇本中的 `new_member` 觸發器被觸發
- ✅ 歡迎消息使用劇本模板

---

### 測試 4: 多輪對話增強

#### 4.1 單元測試

**測試內容**:
- ✅ 意圖識別
- ✅ 話題檢測
- ✅ 情感分析
- ✅ 實體提取
- ✅ 綜合分析

**執行**:
```bash
python scripts/test_core_features.py
```

**預期結果**:
```
✅ 消息分析器初始化成功
✅ 意圖識別成功: greeting (置信度: 0.90)
✅ 話題檢測成功: game (置信度: 0.85)
✅ 情感分析成功: positive (分數: 0.70)
✅ 實體提取成功
✅ 綜合分析成功
```

#### 4.2 實際測試

**準備**:
1. 啟動一個AI賬號
2. 準備測試群組

**測試用例**:

**用例 1: 意圖識別**
```
發送消息: "你好"
預期: 識別為 greeting 意圖
```

**用例 2: 話題檢測**
```
發送消息: "我喜歡玩遊戲"
預期: 識別為 game 話題
```

**用例 3: 情感分析**
```
發送消息: "今天天氣真好，我很開心"
預期: 識別為 positive 情感
```

**用例 4: 實體提取**
```
發送消息: "@user123 你好 #tag1 查看 https://example.com"
預期: 提取 @提及、#標籤、URL
```

**驗證**:
- ✅ 消息分析結果正確
- ✅ 分析結果傳遞給劇本引擎
- ✅ 可以在劇本中使用分析結果

**檢查日誌**:
```bash
# 應該看到分析結果：
# 意圖: greeting, 話題: game, 情感: positive
```

---

## 📊 完整測試檢查清單

### 多賬號協同邏輯
- [ ] 協同管理器初始化成功
- [ ] 賬號註冊成功
- [ ] 優先級檢查正確
- [ ] 只有一個賬號回復
- [ ] 回復鎖機制工作
- [ ] 日誌記錄正確

### 劇本熱更新
- [ ] 劇本解析成功
- [ ] 熱更新API可用
- [ ] 更新不中斷服務
- [ ] 狀態被保留
- [ ] 新劇本生效
- [ ] 日誌記錄正確

### 新成員檢測
- [ ] 新成員事件被檢測
- [ ] 自動發送歡迎消息
- [ ] 劇本觸發器工作
- [ ] 不誤判普通消息
- [ ] 日誌記錄正確

### 多輪對話增強
- [ ] 意圖識別準確
- [ ] 話題檢測準確
- [ ] 情感分析準確
- [ ] 實體提取準確
- [ ] 分析結果傳遞正確
- [ ] 日誌記錄正確

---

## 🔍 問題排查

### 問題 1: 多賬號都回復

**可能原因**:
- 協同管理器未正確初始化
- 回復鎖機制未生效

**解決方法**:
1. 檢查日誌確認協同管理器已啟動
2. 檢查 `DialogueManager` 是否正確集成協同管理器
3. 確認 `should_reply()` 被調用

### 問題 2: 熱更新失敗

**可能原因**:
- 劇本格式錯誤
- 賬號未在線

**解決方法**:
1. 檢查劇本格式
2. 確認賬號狀態為 online
3. 查看錯誤日誌

### 問題 3: 新成員未被檢測

**可能原因**:
- 事件監聽未設置
- 劇本未配置觸發器

**解決方法**:
1. 檢查 `SessionPool` 中的新成員監聽
2. 確認劇本中有 `new_member` 觸發器
3. 檢查 Pyrogram 版本

### 問題 4: 消息分析不準確

**可能原因**:
- 關鍵詞未覆蓋
- 語言檢測錯誤

**解決方法**:
1. 擴展關鍵詞列表
2. 調整語言參數
3. 使用 AI 模型（可選增強）

---

## 📝 測試報告模板

測試完成後，請記錄：

```
測試日期: 2025-11-30
測試人員: [您的名字]

測試結果:
1. 多賬號協同邏輯: ✅ 通過 / ❌ 失敗
   備註: ...
2. 劇本熱更新: ✅ 通過 / ❌ 失敗
   備註: ...
3. 新成員檢測: ✅ 通過 / ❌ 失敗
   備註: ...
4. 多輪對話增強: ✅ 通過 / ❌ 失敗
   備註: ...

發現的問題:
- 問題1: ...
- 問題2: ...

建議改進:
- 改進1: ...
- 改進2: ...
```

---

## 🎯 下一步

測試完成後：
1. 記錄測試結果
2. 修復發現的問題
3. 進行生產環境測試
4. 更新文檔

---

**測試指南版本**: v1.0  
**最後更新**: 2025-11-30
