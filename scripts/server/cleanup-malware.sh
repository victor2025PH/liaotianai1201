#!/bin/bash
# ============================================================
# 恶意软件清理脚本
# ============================================================

set -e

echo "=========================================="
echo "🧹 恶意软件清理"
echo "=========================================="
echo ""

# 1. 终止可疑进程
echo "[1/8] 终止可疑进程..."
SUSPICIOUS_PATTERNS=("MUTA71VL" "CX81yM9aE" "UY" "unk.sh" "80.64.16.241")
KILLED_COUNT=0

for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
    PIDS=$(ps aux | grep -i "$pattern" | grep -v grep | awk '{print $2}' || true)
    if [ -n "$PIDS" ]; then
        echo "  发现进程 (关键词: '$pattern'):"
        for pid in $PIDS; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                CMD=$(ps -p "$pid" -o cmd --no-headers 2>/dev/null || echo "未知")
                echo "    终止 PID $pid: $CMD"
                sudo kill -9 "$pid" 2>/dev/null && KILLED_COUNT=$((KILLED_COUNT+1)) || true
            fi
        done
    fi
done

if [ "$KILLED_COUNT" -eq 0 ]; then
    echo "  ✅ 未发现运行中的可疑进程"
else
    echo "  ✅ 已终止 $KILLED_COUNT 个可疑进程"
fi
echo ""

# 2. 备份可疑文件
echo "[2/8] 备份可疑文件..."
BACKUP_DIR="/tmp/malware_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

SUSPICIOUS_FILES=("/data/MUTA71VL" "/data/CX81yM9aE" "/data/UY")
BACKED_UP=0

for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  备份: $file"
        sudo cp "$file" "$BACKUP_DIR/$(basename "$file").backup" 2>/dev/null && BACKED_UP=$((BACKED_UP+1)) || true
    fi
done

if [ "$BACKED_UP" -gt 0 ]; then
    echo "  ✅ 已备份 $BACKED_UP 个文件到 $BACKUP_DIR"
else
    echo "  ✅ 未发现可疑文件（可能已删除）"
fi
echo ""

# 3. 删除可疑文件
echo "[3/8] 删除可疑文件..."
DELETED_COUNT=0

for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  删除: $file"
        sudo rm -f "$file" && DELETED_COUNT=$((DELETED_COUNT+1)) || true
    fi
done

if [ "$DELETED_COUNT" -gt 0 ]; then
    echo "  ✅ 已删除 $DELETED_COUNT 个可疑文件"
else
    echo "  ✅ 未发现可疑文件"
fi
echo ""

# 4. 清理恶意定时任务
echo "[4/8] 清理恶意定时任务..."
MALICIOUS_CRON_PATTERNS=("80.64.16.241" "unk.sh" "wget.*http.*sh" "curl.*http.*sh")

# 检查用户定时任务
if crontab -l >/dev/null 2>&1; then
    CRON_CONTENT=$(crontab -l)
    MALICIOUS_FOUND=false
    
    for pattern in "${MALICIOUS_CRON_PATTERNS[@]}"; do
        if echo "$CRON_CONTENT" | grep -qE "$pattern"; then
            echo "  ⚠️  发现恶意定时任务 (用户 crontab):"
            echo "$CRON_CONTENT" | grep -E "$pattern" | sed 's/^/    /'
            MALICIOUS_FOUND=true
        fi
    done
    
    if [ "$MALICIOUS_FOUND" = true ]; then
        echo "  清理用户定时任务..."
        # 备份当前 crontab
        crontab -l > "$BACKUP_DIR/user_crontab.backup" 2>/dev/null || true
        # 删除恶意任务
        crontab -l 2>/dev/null | grep -vE "$(IFS='|'; echo "${MALICIOUS_CRON_PATTERNS[*]}")" | crontab -
        echo "  ✅ 已清理用户定时任务"
    else
        echo "  ✅ 用户定时任务正常"
    fi
else
    echo "  ✅ 用户无定时任务"
fi

# 检查系统定时任务
if [ -f /etc/crontab ]; then
    SYSTEM_CRON_MALICIOUS=$(grep -E "$(IFS='|'; echo "${MALICIOUS_CRON_PATTERNS[*]}")" /etc/crontab 2>/dev/null || true)
    if [ -n "$SYSTEM_CRON_MALICIOUS" ]; then
        echo "  ⚠️  发现恶意系统定时任务:"
        echo "$SYSTEM_CRON_MALICIOUS" | sed 's/^/    /'
        echo "  请手动编辑 /etc/crontab 删除恶意任务"
    fi
fi

# 检查 /etc/cron.d/
if [ -d /etc/cron.d ]; then
    for cron_file in /etc/cron.d/*; do
        if [ -f "$cron_file" ] && [ "$(basename "$cron_file")" != ".placeholder" ]; then
            MALICIOUS_IN_FILE=$(grep -E "$(IFS='|'; echo "${MALICIOUS_CRON_PATTERNS[*]}")" "$cron_file" 2>/dev/null || true)
            if [ -n "$MALICIOUS_IN_FILE" ]; then
                echo "  ⚠️  发现恶意定时任务文件: $cron_file"
                echo "$MALICIOUS_IN_FILE" | sed 's/^/    /'
                echo "  建议删除: sudo rm -f $cron_file"
            fi
        fi
    done
fi
echo ""

# 5. 检查并清理 /data 目录
echo "[5/8] 检查 /data 目录..."
if [ -d "/data" ]; then
    DATA_FILES=$(find /data -type f -name "*[A-Z0-9]*" ! -name "lost+found" 2>/dev/null | head -20)
    if [ -n "$DATA_FILES" ]; then
        echo "  ⚠️  发现可疑文件（随机字符串命名）:"
        echo "$DATA_FILES" | while read file; do
            if [ -f "$file" ]; then
                SIZE=$(stat -c %s "$file" 2>/dev/null || echo "0")
                FILE_TYPE=$(file "$file" 2>/dev/null | cut -d: -f2 || echo "未知")
                echo "    $file (大小: $SIZE 字节, 类型: $FILE_TYPE)"
            fi
        done
        echo "  建议检查这些文件，确认是否为恶意文件后删除"
    else
        echo "  ✅ /data 目录正常"
    fi
fi
echo ""

# 6. 检查异常网络连接
echo "[6/8] 检查异常网络连接到可疑 IP..."
SUSPICIOUS_IP="80.64.16.241"
CONNECTIONS=$(ss -tunp 2>/dev/null | grep "$SUSPICIOUS_IP" || true)
if [ -n "$CONNECTIONS" ]; then
    echo "  ⚠️  发现到可疑 IP $SUSPICIOUS_IP 的连接:"
    echo "$CONNECTIONS" | sed 's/^/    /'
    echo "  建议终止相关进程"
else
    echo "  ✅ 未发现到可疑 IP 的连接"
fi
echo ""

# 7. 检查系统完整性
echo "[7/8] 检查系统完整性..."
if command -v debsums >/dev/null 2>&1; then
    echo "  运行 debsums 检查（可能需要一些时间）..."
    sudo debsums -c 2>/dev/null | head -20 || echo "  检查完成（如有错误请查看完整输出）"
else
    echo "  ⚠️  debsums 未安装，跳过系统完整性检查"
    echo "  安装命令: sudo apt-get install debsums"
fi
echo ""

# 8. 生成清理报告
echo "[8/8] 生成清理报告..."
REPORT_FILE="$BACKUP_DIR/cleanup_report.txt"
{
    echo "恶意软件清理报告"
    echo "生成时间: $(date)"
    echo ""
    echo "终止的进程数: $KILLED_COUNT"
    echo "备份的文件数: $BACKED_UP"
    echo "删除的文件数: $DELETED_COUNT"
    echo "备份目录: $BACKUP_DIR"
    echo ""
    echo "建议后续操作:"
    echo "  1. 更改所有密码（SSH、数据库、应用等）"
    echo "  2. 检查其他服务器是否也被感染"
    echo "  3. 运行完整安全扫描: sudo rkhunter --check"
    echo "  4. 检查系统日志: journalctl --since '7 days ago' | grep -i error"
    echo "  5. 监控系统资源使用情况"
} > "$REPORT_FILE"

echo "  ✅ 清理报告已保存到: $REPORT_FILE"
echo ""

# 总结
echo "=========================================="
echo "清理完成"
echo "=========================================="
echo ""
echo "已执行的操作:"
echo "  - 终止可疑进程: $KILLED_COUNT 个"
echo "  - 备份可疑文件: $BACKED_UP 个"
echo "  - 删除可疑文件: $DELETED_COUNT 个"
echo "  - 清理恶意定时任务"
echo ""
echo "⚠️  重要：请立即执行以下操作"
echo "  1. 更改所有密码（SSH、数据库、应用等）"
echo "  2. 检查其他服务器是否也被感染"
echo "  3. 运行安全扫描: sudo rkhunter --check"
echo "  4. 检查备份文件: ls -la $BACKUP_DIR"
echo "  5. 查看清理报告: cat $REPORT_FILE"
echo ""

