# Nginx WebSocket 配置修复

## 修复内容

1. **删除重复的 location 块**：只保留一个 `/api/v1/notifications/ws`
2. **修正 proxy_pass**：添加末尾斜杠，改为 `http://127.0.0.1:8000/api/v1/notifications/ws/;`

## 在服务器上执行的完整命令

```bash
# 1. SSH 连接到服务器
ssh ubuntu@165.154.233.55

# 2. 备份配置
sudo cp /etc/nginx/sites-available/aikz.usdt2026.cc /etc/nginx/sites-available/aikz.usdt2026.cc.bak.$(date +%Y%m%d_%H%M%S)

# 3. 执行修复脚本
sudo python3 << 'PYEOF'
import re

# 读取配置
with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 找到所有 location 块
location_indices = []
for i, line in enumerate(lines):
    if 'location /api/v1/notifications/ws' in line:
        location_indices.append(i)

print(f'找到 {len(location_indices)} 个 location 块')

# 删除重复的（保留第一个）
if len(location_indices) > 1:
    for idx in reversed(location_indices[1:]):
        # 向前查找注释
        block_start = idx
        for j in range(max(0, idx-3), idx):
            if '# WebSocket' in lines[j] or ('#' in lines[j] and 'WebSocket' in lines[j]):
                block_start = j
                break
        
        # 向后查找结束的 }
        brace_count = 0
        block_end = idx
        found_open = False
        for j in range(idx, len(lines)):
            if '{' in lines[j]:
                brace_count += lines[j].count('{')
                found_open = True
            if '}' in lines[j]:
                brace_count -= lines[j].count('}')
                if found_open and brace_count == 0:
                    block_end = j
                    break
        
        print(f'删除行 {block_start+1} 到 {block_end+1}')
        lines = lines[:block_start] + lines[block_end+1:]

# 修复第一个 location 中的 proxy_pass
first_location_idx = None
for i, line in enumerate(lines):
    if 'location /api/v1/notifications/ws' in line:
        first_location_idx = i
        break

if first_location_idx is not None:
    for i in range(first_location_idx, min(first_location_idx + 20, len(lines))):
        if 'proxy_pass' in lines[i] and 'notifications/ws' in lines[i]:
            # 修复 proxy_pass，确保末尾有斜杠
            if 'http://127.0.0.1:8000/api/v1/notifications/ws;' in lines[i]:
                lines[i] = lines[i].replace(
                    'http://127.0.0.1:8000/api/v1/notifications/ws;',
                    'http://127.0.0.1:8000/api/v1/notifications/ws/;'
                )
                print(f'修改行 {i+1}：proxy_pass 添加末尾斜杠')
            break

# 写入新配置
with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'w', encoding='utf-8') as f:
    f.writelines(lines)

print('修复完成')
PYEOF

# 4. 验证配置
sudo nginx -t

# 5. 应用配置（如果测试通过）
sudo nginx -t && sudo systemctl reload nginx
```

## 或者使用单行命令（推荐）

```bash
ssh ubuntu@165.154.233.55 "sudo python3 << 'PYEOF'
import re
with open('/etc/nginx/sites-available/aikz.usdt2026.cc','r',encoding='utf-8') as f:
    lines=f.readlines()
idx=[i for i,l in enumerate(lines) if 'location /api/v1/notifications/ws' in l]
if len(idx)>1:
    for i in reversed(idx[1:]):
        s=i
        for j in range(max(0,i-3),i):
            if '# WebSocket' in lines[j]: s=j; break
        b=0; e=i; f=False
        for j in range(i,len(lines)):
            if '{' in lines[j]: b+=lines[j].count('{'); f=True
            if '}' in lines[j]:
                b-=lines[j].count('}')
                if f and b==0: e=j; break
        lines=lines[:s]+lines[e+1:]
for i,l in enumerate(lines):
    if 'proxy_pass' in l and 'notifications/ws' in l:
        if 'http://127.0.0.1:8000/api/v1/notifications/ws;' in l:
            lines[i]=l.replace('http://127.0.0.1:8000/api/v1/notifications/ws;','http://127.0.0.1:8000/api/v1/notifications/ws/;')
        break
with open('/etc/nginx/sites-available/aikz.usdt2026.cc','w',encoding='utf-8') as f:
    f.writelines(lines)
print('修复完成')
PYEOF
" && ssh ubuntu@165.154.233.55 "sudo nginx -t && sudo systemctl reload nginx"
```

## 验证修复结果

修复后执行：

```bash
# 1. 检查 location 数量（应该只有 1 个）
sudo grep -c 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 2. 查看最终配置
sudo grep -A 15 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 3. 确认 proxy_pass 有末尾斜杠
sudo grep 'proxy_pass.*notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
```

## 预期结果

修复后，配置应该类似：

```nginx
location /api/v1/notifications/ws {
    proxy_pass http://127.0.0.1:8000/api/v1/notifications/ws/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_buffering off;
}
```

**注意**：`proxy_pass` 末尾必须有斜杠 `/`，这样才能正确传递路径参数。

