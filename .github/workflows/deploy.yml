name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 25m
          script_stop: true
          debug: true
          script: |
            set -x
            set -o pipefail
            
            handle_error() {
              echo "❌ Error at: $1"
              echo "Exit code: $?"
              exit 1
            }
            trap 'handle_error "line $LINENO"' ERR
            
            echo "=========================================="
            echo "Starting deployment - $(date)"
            echo "=========================================="
            
            echo "Testing SSH connection..."
            if ! whoami; then
              echo "❌ SSH connection failed"
              exit 1
            fi
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            echo "✅ SSH connection successful"
            
            echo "=========================================="
            echo "Step 1: Check project directory"
            echo "=========================================="
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Project directory not found, cloning..."
              cd /home/ubuntu || exit 1
              if ! git clone https://github.com/${{ github.repository }}.git telegram-ai-system; then
                echo "❌ Git clone failed"
                exit 1
              fi
              cd "$PROJECT_DIR" || exit 1
            else
              echo "✅ Project directory exists"
              cd "$PROJECT_DIR" || exit 1
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 2: Pull latest code"
            echo "=========================================="
            if ! git fetch origin main; then
              echo "⚠️  Git fetch failed, retrying..."
              git remote set-url origin https://github.com/${{ github.repository }}.git
              if ! git fetch origin main; then
                echo "❌ Git fetch failed"
                exit 1
              fi
            fi
            if ! git reset --hard origin/main; then
              echo "❌ Git reset failed"
              exit 1
            fi
            echo "✅ Code updated to latest version"
            git log -1 --oneline
            
            echo ""
            echo "=========================================="
            echo "Step 3: Update backend dependencies"
            echo "=========================================="
            if [ -d "admin-backend" ]; then
              cd admin-backend
              if [ ! -d "venv" ]; then
                echo "Creating virtual environment..."
                python3 -m venv venv
              fi
              source venv/bin/activate
              echo "Updating Python packages..."
              pip install --quiet --upgrade pip
              pip install --quiet -r requirements.txt || {
                echo "⚠️  Some dependencies failed, continuing..."
              }
              cd ..
              echo "✅ Backend dependencies updated"
            else
              echo "⚠️  admin-backend directory not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 4: Update Bot dependencies"
            echo "=========================================="
            if [ -d "venv" ] && [ -f "requirements.txt" ]; then
              source venv/bin/activate
              pip install --quiet --upgrade pip
              pip install --quiet -r requirements.txt || {
                echo "⚠️  Some dependencies failed, continuing..."
              }
              echo "✅ Bot dependencies updated"
            else
              echo "⚠️  Bot venv or requirements.txt not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 5: Deploy frontend"
            echo "=========================================="
            if [ -d "saas-demo" ]; then
              cd saas-demo
              
              echo "Installing frontend dependencies..."
              if [ -d "node_modules" ]; then
                echo "Using incremental install..."
                npm ci --prefer-offline --no-audit || npm install --prefer-offline --no-audit
              else
                echo "First-time install..."
                npm install --prefer-offline --no-audit
              fi
              
              echo "Building frontend project..."
              export NODE_OPTIONS="--max-old-space-size=2048"
              npm run build || {
                echo "⚠️  Build failed, but continuing..."
              }
              
              if [ -d ".next/standalone" ]; then
                echo "Preparing Standalone directory..."
                if [ -d "public" ]; then
                  cp -r public .next/standalone/ || true
                fi
                mkdir -p .next/standalone/.next
                if [ -d ".next/static" ]; then
                  cp -r .next/static .next/standalone/.next/ || true
                fi
                echo "✅ Standalone directory ready"
              else
                echo "⚠️  Standalone directory not found"
              fi
              
              cd ..
            else
              echo "⚠️  saas-demo directory not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 6: Update Nginx config"
            echo "=========================================="
            if [ -f "deploy/nginx/aikz.conf" ]; then
              sudo cp deploy/nginx/aikz.conf /etc/nginx/sites-available/aikz.conf
              sudo ln -sf /etc/nginx/sites-available/aikz.conf /etc/nginx/sites-enabled/aikz.conf
              if sudo nginx -t; then
                sudo systemctl reload nginx
                echo "✅ Nginx config updated and reloaded"
              else
                echo "❌ Nginx config test failed"
              fi
            else
              echo "⚠️  deploy/nginx/aikz.conf not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 7: Deploy Systemd services"
            echo "=========================================="
            if [ -f "scripts/server/deploy-systemd.sh" ]; then
              sudo bash scripts/server/deploy-systemd.sh || echo "⚠️  Systemd deployment failed, continuing..."
            else
              echo "⚠️  deploy-systemd.sh not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 8: Restart services"
            echo "=========================================="
            
            echo "Restarting backend service..."
            sudo systemctl restart telegram-backend && echo "✅ Backend restarted" || echo "⚠️  Backend restart failed"
            
            echo "Restarting Bot service..."
            sudo systemctl restart telegram-bot && echo "✅ Bot restarted" || echo "⚠️  Bot restart failed"
            
            if systemctl list-units --type=service --no-legend | grep -q "liaotian-frontend"; then
              echo "Restarting frontend service (liaotian-frontend)..."
              sudo systemctl restart liaotian-frontend && echo "✅ Frontend restarted" || echo "⚠️  Frontend restart failed"
            elif systemctl list-units --type=service --no-legend | grep -q "smart-tg-frontend"; then
              echo "Restarting frontend service (smart-tg-frontend)..."
              sudo systemctl restart smart-tg-frontend && echo "✅ Frontend restarted" || echo "⚠️  Frontend restart failed"
            else
              echo "⚠️  Frontend systemd service not found"
            fi
            
            echo ""
            echo "Waiting for services to start (5 seconds)..."
            sleep 5
            
            echo ""
            echo "=========================================="
            echo "Step 9: Check service status"
            echo "=========================================="
            
            echo "Checking backend service..."
            if systemctl is-active --quiet telegram-backend 2>/dev/null; then
              echo "✅ Backend service: Running"
              if curl -s -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "✅ Backend health check: Passed"
              else
                echo "⚠️  Backend health check: Failed"
              fi
            else
              echo "❌ Backend service: Not running"
              sudo systemctl status telegram-backend --no-pager -l | head -n 5 || true
            fi
            
            echo ""
            echo "Checking Bot service..."
            if systemctl is-active --quiet telegram-bot 2>/dev/null; then
              echo "✅ Bot service: Running"
            else
              echo "❌ Bot service: Not running"
              sudo systemctl status telegram-bot --no-pager -l | head -n 5 || true
            fi
            
            echo ""
            echo "Checking frontend service..."
            FRONTEND_SERVICE=""
            if systemctl list-units --type=service --no-legend | grep -q "liaotian-frontend"; then
              FRONTEND_SERVICE="liaotian-frontend"
            elif systemctl list-units --type=service --no-legend | grep -q "smart-tg-frontend"; then
              FRONTEND_SERVICE="smart-tg-frontend"
            fi
            
            if [ -n "$FRONTEND_SERVICE" ]; then
              if systemctl is-active --quiet "$FRONTEND_SERVICE" 2>/dev/null; then
                echo "✅ Frontend service ($FRONTEND_SERVICE): Running"
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 2>/dev/null || echo "000")
                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                  echo "✅ Frontend HTTP response: Normal (HTTP $HTTP_CODE)"
                else
                  echo "⚠️  Frontend HTTP response: Abnormal (HTTP $HTTP_CODE)"
                fi
              else
                echo "❌ Frontend service ($FRONTEND_SERVICE): Not running"
                sudo systemctl status "$FRONTEND_SERVICE" --no-pager -l | head -n 5 || true
              fi
            else
              echo "⚠️  Frontend systemd service not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Deployment completed - $(date)"
            echo "=========================================="
            echo "✅ Code updated"
            echo "✅ Services restarted"
            echo ""
            echo "Service URLs:"
            echo "  - Frontend: http://${{ secrets.SERVER_HOST }}"
            echo "  - Backend API: http://${{ secrets.SERVER_HOST }}:8000"
            echo "  - API Docs: http://${{ secrets.SERVER_HOST }}:8000/docs"
