# 行尾符问题修复说明

> **创建时间**: 2025-11-29  
> **问题**: Windows/Linux 行尾符不兼容导致脚本执行失败

---

## 问题描述

在 Windows 系统上创建的 shell 脚本（`.sh`）使用 CRLF (`\r\n`) 作为行尾符，而在 Linux 服务器上执行时，bash 无法正确解析 `\r` 字符，导致以下错误：

```
/home/ubuntu/liaotian/deploy/从GitHub拉取并部署.sh: line 4: $'\r': command not found
```

---

## 解决方案

### 1. 在 PowerShell 上传脚本时自动转换

**文件**: `deploy/推送到GitHub并部署.ps1`

**修复位置**（第 144-152 行）:
```powershell
# 读取脚本内容并转换行尾符从 CRLF 到 LF
$scriptContent = Get-Content $deployScriptPath -Raw -Encoding UTF8
# 将 Windows 行尾符 (\r\n) 替换为 Unix 行尾符 (\n)
$scriptContent = $scriptContent -replace "`r`n", "`n" -replace "`r", "`n"

$base64 = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($scriptContent))

# 上传脚本并在服务器上转换行尾符（使用 sed）
$uploadCmd = "mkdir -p ~/liaotian/deploy && echo '$base64' | base64 -d > ~/liaotian/deploy/从GitHub拉取并部署.sh && sed -i 's/\r$//' ~/liaotian/deploy/从GitHub拉取并部署.sh 2>/dev/null || sed -i '' 's/\r$//' ~/liaotian/deploy/从GitHub拉取并部署.sh 2>/dev/null || true && chmod +x ~/liaotian/deploy/从GitHub拉取并部署.sh && echo 'SCRIPT_UPLOADED'"
```

**说明**:
- 在上传前将 Windows 行尾符 (`\r\n`) 转换为 Unix 行尾符 (`\n`)
- 在服务器上再次使用 `sed` 命令清理可能残留的 `\r` 字符
- 兼容不同版本的 sed（GNU sed 和 macOS sed）

---

### 2. 在服务器上拉取脚本后自动转换

**文件**: `deploy/从GitHub拉取并部署.sh`

**修复位置**（第 47 行后）:
```bash
# 2.1 修复拉取的脚本文件的行尾符（如果存在）
if [ -f "deploy/从GitHub拉取并部署.sh" ]; then
    echo "  转换脚本行尾符为 Unix 格式..."
    sed -i 's/\r$//' deploy/从GitHub拉取并部署.sh 2>/dev/null || sed -i '' 's/\r$//' deploy/从GitHub拉取并部署.sh 2>/dev/null || true
    chmod +x deploy/从GitHub拉取并部署.sh 2>/dev/null || true
fi
```

**说明**:
- 从 GitHub 拉取代码后，自动检查并转换脚本的行尾符
- 确保脚本始终使用 Unix 格式的行尾符

---

## 预防措施

### 方法1: 配置 Git 自动转换

在仓库根目录创建或更新 `.gitattributes` 文件：

```gitattributes
# 自动检测文本文件并标准化行尾符
* text=auto

# 明确指定 shell 脚本使用 LF
*.sh text eol=lf

# PowerShell 脚本使用 CRLF（在 Windows 上编辑）
*.ps1 text eol=crlf
```

然后提交并推送：

```bash
git add .gitattributes
git commit -m "配置 Git 行尾符自动转换"
git push
```

### 方法2: 在本地使用 LF 格式

**Visual Studio Code**:
1. 打开设置 (`Ctrl+,`)
2. 搜索 "eol"
3. 将 "Files: Eol" 设置为 `\n`（对于 shell 脚本）

**或者**在文件底部状态栏点击 "CRLF"，切换为 "LF"

**PowerShell 中检查行尾符**:
```powershell
# 查看文件行尾符类型
Get-Content deploy/从GitHub拉取并部署.sh -Raw | Select-String -Pattern "`r`n" | Measure-Object
```

---

## 测试验证

### 1. 验证修复后的脚本

在服务器上执行：

```bash
# 检查行尾符类型
file deploy/从GitHub拉取并部署.sh
# 应该显示: ASCII text 或 ASCII text executable

# 检查是否还有 \r 字符
od -c deploy/从GitHub拉取并部署.sh | grep '\r'
# 应该没有输出

# 尝试执行（应该不报错）
bash -n deploy/从GitHub拉取并部署.sh
# 应该没有语法错误
```

### 2. 完整测试部署流程

```powershell
# 在本地执行
.\deploy\推送到GitHub并部署.ps1 -CommitMessage "测试行尾符修复"
```

---

## 相关文档

- [GitHub 部署工作流程-完整指南.md](./GitHub部署工作流程-完整指南.md)
- [为什么应该使用GitHub部署-完整方案.md](./为什么应该使用GitHub部署-完整方案.md)

---

**更新时间**: 2025-11-29  
**状态**: ✅ 已修复并测试
