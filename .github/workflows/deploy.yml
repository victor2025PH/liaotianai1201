name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 55m
          script_stop: true
          debug: true
          envs: GITHUB_REPO=${{ github.repository }},SERVER_HOST=${{ secrets.SERVER_HOST }}
          script: |
            # é‡åˆ°ä»»ä½•å‘½ä»¤é”™è¯¯(éé€»è¾‘åˆ¤æ–­)åˆ™é€€å‡º
            set -e
            
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # 1. è¿›å…¥ç›®å½•å¹¶æ›´æ–°ä»£ç 
            cd "$PROJECT_DIR"
            git fetch origin main
            git reset --hard origin/main
            
            # 2. ä¿®å¤æƒé™ (å¿½ç•¥é”™è¯¯)
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR" || true
            
            # 3. æ„å»ºå‰ç«¯
            echo "ğŸ“¦ æ„å»ºå‰ç«¯..."
            cd saas-demo
            
            # 1. æ¸…ç†é”æ–‡ä»¶ï¼ˆä¸åœæ­¢æœåŠ¡ï¼Œå‡å°‘ä¸­æ–­æ—¶é—´ï¼‰
            rm -f .next/lock
            
            # 2. å®‰è£…ä¸æ„å»ºï¼ˆåœ¨æœåŠ¡è¿è¡Œçš„æƒ…å†µä¸‹æ„å»ºï¼‰
            npm install --prefer-offline --no-audit
            npm run build
            
            # æš´åŠ›å¤åˆ¶é™æ€èµ„æº (Standalone è¡¥ä¸)
            echo "ğŸ“‚ å¤„ç†é™æ€èµ„æº..."
            mkdir -p .next/standalone/.next/static
            # ä½¿ç”¨ || true é˜²æ­¢æŸäº›æ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´æŠ¥é”™
            cp -r .next/static/* .next/standalone/.next/static/ || true
            cp -r public .next/standalone/ || true
            cd ..
            
            # 4. åç«¯ä¾èµ–
            echo "ğŸ å®‰è£…åç«¯ä¾èµ–..."
            cd admin-backend
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            cd ..
            
            # 5. é‡å¯æœåŠ¡ï¼ˆä½¿ç”¨æ›´ä¼˜é›…çš„æ–¹å¼ï¼‰
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            # å…ˆé‡å¯åç«¯ï¼ˆé€šå¸¸è¾ƒå¿«ï¼‰
            sudo systemctl restart luckyred-api
            sleep 3
            
            # ç„¶åé‡å¯å‰ç«¯ï¼ˆéœ€è¦åœæ­¢æ—§æœåŠ¡ï¼‰
            sudo systemctl stop liaotian-frontend || true
            sleep 2
            sudo systemctl start liaotian-frontend
            sleep 5
            
            # æœ€åé‡å¯ Nginx
            sudo systemctl restart nginx
            sleep 2
            
            # 6. éªŒè¯æœåŠ¡çŠ¶æ€
            echo "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
            if sudo systemctl is-active --quiet luckyred-api && sudo systemctl is-active --quiet liaotian-frontend; then
                echo "âœ… æ‰€æœ‰æœåŠ¡å·²æˆåŠŸå¯åŠ¨"
            else
                echo "âš ï¸  éƒ¨åˆ†æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
                sudo systemctl status luckyred-api --no-pager | head -5
                sudo systemctl status liaotian-frontend --no-pager | head -5
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
