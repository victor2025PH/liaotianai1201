# 故障排查指南

本文档提供系统常见问题的排查和解决方案。

---

## 快速诊断

### 1. 检查服务状态

```bash
# 检查后端服务
curl http://localhost:8000/health

# 检查详细健康状态
curl http://localhost:8000/health?detailed=true

# 检查 Prometheus 指标
curl http://localhost:8000/metrics
```

### 2. 查看日志

```bash
# 后端日志
tail -f admin-backend/logs/app.log

# 或使用 Docker
docker-compose logs -f admin-backend

# 查看最近的错误
grep -i error admin-backend/logs/app.log | tail -20
```

---

## 常见问题

### 问题 1: Session 文件无法读取

#### 症状
- 错误信息: "Session 文件不存在" 或 "无法读取 Session 文件"
- 账号无法启动
- 日志显示文件路径错误

#### 排查步骤

1. **检查文件是否存在**:
   ```bash
   ls -la sessions/
   # 或 Windows
   dir sessions\
   ```

2. **检查文件权限**:
   ```bash
   # Linux/macOS
   ls -l sessions/*.session
   # 应该显示 -rw------- (600)
   
   # 如果权限不对，修复：
   chmod 600 sessions/*.session
   ```

3. **检查文件路径配置**:
   ```bash
   # 检查环境变量
   echo $SESSION_FILES_DIRECTORY
   
   # 或检查配置文件
   cat .env | grep SESSION
   ```

4. **验证 Session 文件**:
   ```bash
   python3 scripts/verify_session.py account1
   ```

#### 解决方案

- **文件不存在**: 上传 Session 文件到 `sessions/` 目录
- **权限问题**: 运行 `chmod 600 sessions/*.session`
- **路径错误**: 检查 `SESSION_FILES_DIRECTORY` 环境变量
- **文件损坏**: 重新生成或导入 Session 文件

---

### 问题 2: 无法连接 Telegram

#### 症状
- 错误信息: "ConnectionError" 或 "AuthKeyUnregistered"
- 账号状态显示为 "offline"
- 无法接收或发送消息

#### 排查步骤

1. **检查网络连接**:
   ```bash
   ping api.telegram.org
   curl -I https://api.telegram.org
   ```

2. **检查 API 配置**:
   ```bash
   # 检查环境变量
   echo $TELEGRAM_API_ID
   echo $TELEGRAM_API_HASH
   
   # 验证配置是否正确
   ```

3. **检查 Session 文件有效性**:
   ```bash
   python3 scripts/verify_session.py account1
   ```

4. **查看详细错误日志**:
   ```bash
   grep -i "telegram\|connection\|auth" logs/app.log | tail -20
   ```

#### 解决方案

- **网络问题**: 检查防火墙、代理设置
- **API 配置错误**: 验证 `TELEGRAM_API_ID` 和 `TELEGRAM_API_HASH`
- **Session 失效**: 重新登录生成新的 Session 文件
- **2FA 问题**: 如果启用了 2FA，需要提供密码

---

### 问题 3: 数据库连接失败

#### 症状
- 错误信息: "Database connection failed" 或 "OperationalError"
- API 返回 500 错误
- 健康检查显示数据库不健康

#### 排查步骤

1. **检查数据库服务**:
   ```bash
   # PostgreSQL
   pg_isready -h localhost -p 5432
   
   # 或使用 Docker
   docker-compose ps postgres
   ```

2. **检查连接字符串**:
   ```bash
   echo $DATABASE_URL
   # 格式应该是: postgresql://user:password@host:port/dbname
   ```

3. **测试数据库连接**:
   ```bash
   # PostgreSQL
   psql $DATABASE_URL -c "SELECT 1;"
   ```

4. **检查数据库日志**:
   ```bash
   # Docker
   docker-compose logs postgres
   ```

#### 解决方案

- **数据库未启动**: 启动数据库服务
- **连接字符串错误**: 检查 `DATABASE_URL` 环境变量
- **权限问题**: 检查数据库用户权限
- **网络问题**: 检查防火墙和网络配置

---

### 问题 4: Redis 连接失败

#### 症状
- 错误信息: "Redis connection failed"
- 缓存功能不可用
- 健康检查显示 Redis 不健康

#### 排查步骤

1. **检查 Redis 服务**:
   ```bash
   redis-cli ping
   # 应该返回 PONG
   
   # 或使用 Docker
   docker-compose ps redis
   ```

2. **检查连接配置**:
   ```bash
   echo $REDIS_URL
   # 格式应该是: redis://host:port/db
   ```

3. **测试连接**:
   ```bash
   redis-cli -u $REDIS_URL ping
   ```

#### 解决方案

- **Redis 未启动**: 启动 Redis 服务
- **连接配置错误**: 检查 `REDIS_URL` 环境变量
- **网络问题**: 检查防火墙配置

---

### 问题 5: 加密 Session 文件无法解密

#### 症状
- 错误信息: "Invalid token" 或 "Decryption failed"
- 无法读取加密的 Session 文件
- 账号无法启动

#### 排查步骤

1. **检查加密配置**:
   ```bash
   echo $SESSION_ENCRYPTION_ENABLED
   echo $SESSION_ENCRYPTION_KEY
   ```

2. **验证加密密钥**:
   ```bash
   # 检查密钥格式（应该是 44 字符的 base64 字符串）
   echo $SESSION_ENCRYPTION_KEY | wc -c
   ```

3. **检查文件扩展名**:
   ```bash
   ls -la sessions/*.enc
   # 加密文件应该是 .enc 扩展名
   ```

#### 解决方案

- **密钥未配置**: 设置 `SESSION_ENCRYPTION_KEY` 环境变量
- **密钥错误**: 使用正确的加密密钥（与加密时使用的密钥一致）
- **密钥格式错误**: 确保密钥是有效的 Fernet key（44 字符 base64）

---

### 问题 6: Prometheus 指标无法访问

#### 症状
- `/metrics` 端点返回错误
- Prometheus 无法抓取指标
- 监控数据缺失

#### 排查步骤

1. **检查端点**:
   ```bash
   curl http://localhost:8000/metrics
   ```

2. **检查 Prometheus 配置**:
   ```bash
   cat admin-backend/prometheus.yml
   ```

3. **检查 Prometheus 服务**:
   ```bash
   # Docker
   docker-compose ps prometheus
   docker-compose logs prometheus
   ```

#### 解决方案

- **端点未启用**: 确保 `/metrics` 路由已注册
- **Prometheus 配置错误**: 检查 `prometheus.yml` 中的目标地址
- **网络问题**: 检查 Prometheus 服务器能否访问应用

---

### 问题 7: Telegram 告警无法发送

#### 症状
- 告警触发但未收到 Telegram 通知
- 错误信息: "Telegram request failed"
- 告警统计显示发送失败

#### 排查步骤

1. **检查配置**:
   ```bash
   echo $TELEGRAM_BOT_TOKEN
   echo $TELEGRAM_CHAT_ID
   ```

2. **测试告警发送**:
   ```bash
   curl -X POST "http://localhost:8000/api/v1/group-ai/telegram-alerts/test" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

3. **查看告警统计**:
   ```bash
   curl "http://localhost:8000/api/v1/group-ai/telegram-alerts/stats" \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

#### 解决方案

- **Bot Token 错误**: 验证 Telegram Bot Token
- **Chat ID 错误**: 验证 Telegram Chat ID（可以使用 @userinfobot 获取）
- **网络问题**: 检查服务器能否访问 `api.telegram.org`
- **速率限制**: 检查是否触发 Telegram API 速率限制

---

### 问题 8: 健康检查失败

#### 症状
- `/health` 端点返回不健康状态
- Kubernetes Pod 重启
- 服务无法正常启动

#### 排查步骤

1. **检查详细健康状态**:
   ```bash
   curl http://localhost:8000/health?detailed=true
   ```

2. **检查各个组件**:
   ```bash
   # 数据库
   curl http://localhost:8000/health?detailed=true | jq '.components.database'
   
   # Redis
   curl http://localhost:8000/health?detailed=true | jq '.components.redis'
   
   # Telegram API
   curl http://localhost:8000/health?detailed=true | jq '.components.telegram_api'
   ```

3. **查看健康检查日志**:
   ```bash
   grep -i "health" logs/app.log | tail -20
   ```

#### 解决方案

- **数据库不健康**: 检查数据库连接和状态
- **Redis 不健康**: 检查 Redis 连接（如果配置了）
- **Telegram API 不可达**: 检查网络连接
- **Session 文件问题**: 检查 Session 文件目录和权限

---

### 问题 9: Docker 容器无法启动

#### 症状
- Docker 容器立即退出
- 错误信息: "Container exited with code 1"
- 日志显示启动失败

#### 排查步骤

1. **查看容器日志**:
   ```bash
   docker-compose logs admin-backend
   docker logs <container_id>
   ```

2. **检查环境变量**:
   ```bash
   docker-compose config
   ```

3. **检查镜像**:
   ```bash
   docker images | grep group-ai
   ```

4. **尝试交互式运行**:
   ```bash
   docker run -it --rm group-ai/admin-backend:latest /bin/sh
   ```

#### 解决方案

- **环境变量缺失**: 检查 `.env` 文件或环境变量配置
- **依赖问题**: 检查 Dockerfile 和依赖安装
- **端口冲突**: 检查端口是否被占用
- **资源不足**: 检查系统资源（内存、磁盘）

---

### 问题 10: Kubernetes 部署失败

#### 症状
- Pod 状态为 `CrashLoopBackOff` 或 `Pending`
- 服务无法访问
- 部署一直处于进行中

#### 排查步骤

1. **检查 Pod 状态**:
   ```bash
   kubectl get pods -n group-ai
   kubectl describe pod <pod-name> -n group-ai
   ```

2. **查看 Pod 日志**:
   ```bash
   kubectl logs <pod-name> -n group-ai
   kubectl logs <pod-name> -n group-ai --previous  # 查看之前的日志
   ```

3. **检查资源**:
   ```bash
   kubectl top pods -n group-ai
   kubectl describe node
   ```

4. **检查配置**:
   ```bash
   kubectl get configmap -n group-ai
   kubectl get secret -n group-ai
   ```

#### 解决方案

- **资源不足**: 增加资源限制或添加节点
- **配置错误**: 检查 ConfigMap 和 Secret
- **镜像拉取失败**: 检查镜像仓库和权限
- **存储问题**: 检查 PVC 和存储类配置

---

## 诊断工具

### 1. 健康检查脚本

```bash
#!/bin/bash
# 完整健康检查脚本

echo "=== 系统健康检查 ==="

# 后端服务
echo "1. 检查后端服务..."
curl -f http://localhost:8000/health || echo "❌ 后端服务不可用"

# 数据库
echo "2. 检查数据库..."
curl -f http://localhost:8000/health?detailed=true | jq '.components.database' || echo "❌ 数据库检查失败"

# Redis
echo "3. 检查 Redis..."
curl -f http://localhost:8000/health?detailed=true | jq '.components.redis' || echo "❌ Redis 检查失败"

# Session 文件
echo "4. 检查 Session 文件..."
ls -la sessions/ || echo "❌ Session 目录不存在"

# Prometheus
echo "5. 检查 Prometheus..."
curl -f http://localhost:8000/metrics > /dev/null || echo "❌ Prometheus 指标不可用"

echo "=== 检查完成 ==="
```

### 2. 日志分析脚本

```bash
#!/bin/bash
# 日志分析脚本

LOG_FILE="admin-backend/logs/app.log"

echo "=== 错误统计 ==="
grep -i "error" $LOG_FILE | tail -20

echo ""
echo "=== 警告统计 ==="
grep -i "warning" $LOG_FILE | tail -20

echo ""
echo "=== 最近的活动 ==="
tail -50 $LOG_FILE
```

### 3. 性能诊断

```bash
# 检查 API 响应时间
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:8000/health

# curl-format.txt 内容:
# time_namelookup:  %{time_namelookup}\n
# time_connect:  %{time_connect}\n
# time_starttransfer:  %{time_starttransfer}\n
# time_total:  %{time_total}\n
```

---

## 紧急恢复

### 1. 服务完全无法启动

```bash
# 1. 停止所有服务
docker-compose down
# 或
kubectl delete deployment -n group-ai --all

# 2. 检查配置文件
cat .env
cat deploy/docker-compose.yaml

# 3. 清理并重新启动
docker-compose up -d --force-recreate
# 或
kubectl apply -f deploy/k8s/
```

### 2. 数据库损坏

```bash
# 1. 备份当前数据库
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# 2. 恢复数据库
psql $DATABASE_URL < backup_YYYYMMDD.sql

# 3. 或重新初始化
alembic upgrade head
```

### 3. Session 文件丢失

```bash
# 1. 检查备份
ls -la backups/sessions/

# 2. 从备份恢复
cp backups/sessions/account1.session sessions/

# 3. 或重新上传
# 通过 API 或前端界面上传 Session 文件
```

---

## 获取帮助

### 1. 查看日志

- **后端日志**: `admin-backend/logs/app.log`
- **Docker 日志**: `docker-compose logs`
- **Kubernetes 日志**: `kubectl logs`

### 2. 检查文档

- [部署指南](DEPLOYMENT_GUIDE.md)
- [Session 跨服务器部署指南](SESSION跨服务器部署指南.md)
- [API 文档](http://localhost:8000/docs)

### 3. 联系支持

- 查看 GitHub Issues
- 查看系统日志
- 提供错误信息和日志

---

## 预防措施

### 1. 定期备份

```bash
# 备份数据库
pg_dump $DATABASE_URL > backups/db_$(date +%Y%m%d).sql

# 备份 Session 文件
tar -czf backups/sessions_$(date +%Y%m%d).tar.gz sessions/
```

### 2. 监控告警

- 配置 Prometheus 告警规则
- 设置 Telegram 告警通知
- 定期检查健康状态

### 3. 日志管理

- 配置日志轮转
- 定期清理旧日志
- 监控日志大小

---

**文档结束**

