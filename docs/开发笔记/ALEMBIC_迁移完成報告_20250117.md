# Alembic æ•¸æ“šåº«é·ç§»æ©Ÿåˆ¶å®Œæˆå ±å‘Š

> **å®Œæˆæ™‚é–“**: 2025-01-17  
> **ä»»å‹™**: Week 2 ä»»å‹™ 2.1 - å¼•å…¥ Alembic é·ç§»æ©Ÿåˆ¶  
> **å ±å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ“‹ å®Œæˆæ¦‚è¦½

å·²æˆåŠŸç‚º `admin-backend` å¼•å…¥ Alembic æ•¸æ“šåº«é·ç§»æ©Ÿåˆ¶ï¼Œæ›¿ä»£åŸæœ‰çš„ `Base.metadata.create_all()` æ–¹æ³•ã€‚

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. å‰µå»º Alembic é…ç½®

#### é…ç½®æ–‡ä»¶
- âœ… `admin-backend/alembic.ini` - Alembic ä¸»é…ç½®æ–‡ä»¶
- âœ… `admin-backend/alembic/env.py` - Alembic ç’°å¢ƒé…ç½®ï¼ˆé€£æ¥æ•¸æ“šåº«ã€å°å…¥æ¨¡å‹ï¼‰
- âœ… `admin-backend/alembic/script.py.mako` - é·ç§»æ–‡ä»¶æ¨¡æ¿

#### é…ç½®ç‰¹é»
- è‡ªå‹•å¾ `app.core.config` è®€å–æ•¸æ“šåº« URL
- è‡ªå‹•å°å…¥æ‰€æœ‰æ¨¡å‹ï¼ˆåŒ…æ‹¬ Group AI æ¨¡å‹ï¼‰
- æ”¯æŒ SQLite å’Œ PostgreSQL

### 2. å‰µå»ºåˆå§‹é·ç§»

#### é·ç§»æ–‡ä»¶éˆ
```
000_initial_base_tables.py (æ–°å»º)
  â†“
001_create_group_ai_tables.py (å·²å­˜åœ¨ï¼Œæ›´æ–° down_revision)
  â†“
002_add_indexes_for_performance.py (å·²å­˜åœ¨)
  â†“
003_add_script_version_management.py (å·²å­˜åœ¨ï¼Œä¿®æ­£ down_revision)
```

#### é·ç§»å…§å®¹

**000_initial_base_tables.py**ï¼ˆæ–°å»ºï¼‰
- å‰µå»ºåŸºç¤è¡¨ï¼š`users`, `roles`, `permissions`
- å‰µå»ºé—œè¯è¡¨ï¼š`user_roles`, `role_permissions`
- åŒ…å«æ‰€æœ‰å¿…è¦çš„ç´¢å¼•

**001_create_group_ai_tables.py**ï¼ˆå·²å­˜åœ¨ï¼‰
- å‰µå»ºç¾¤çµ„ AI ç›¸é—œè¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
- å·²æ›´æ–° `down_revision` ç‚º `000_initial_base`

**002_add_indexes_for_performance.py**ï¼ˆå·²å­˜åœ¨ï¼‰
- æ·»åŠ æ€§èƒ½å„ªåŒ–ç´¢å¼•

**003_add_script_version_management.py**ï¼ˆå·²å­˜åœ¨ï¼‰
- æ·»åŠ åŠ‡æœ¬ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½
- å·²ä¿®æ­£ `down_revision` ç‚º `002_add_indexes`

### 3. æ·»åŠ é·ç§»å‰è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶

#### å‚™ä»½è…³æœ¬
- âœ… `admin-backend/scripts/backup_db.py` - æ•¸æ“šåº«å‚™ä»½è…³æœ¬
  - æ”¯æŒ SQLiteï¼ˆæ–‡ä»¶è¤‡è£½ï¼‰
  - æ”¯æŒ PostgreSQLï¼ˆpg_dumpï¼‰

#### é·ç§»è…³æœ¬
- âœ… `admin-backend/scripts/run_migrations.py` - é·ç§»é‹è¡Œè…³æœ¬
  - é·ç§»å‰è‡ªå‹•å‚™ä»½
  - é‹è¡Œ Alembic é·ç§»
  - éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒè¼¸å‡º

#### å‚™ä»½ä½ç½®
- SQLite: `admin-backend/backup/db_bak/before-migrate-YYYYMMDD-HHMMSS-admin.db`
- PostgreSQL: `admin-backend/backup/db_bak/before-migrate-YYYYMMDD-HHMMSS-admin.sql`

### 4. æ›´æ–° main.py ä½¿ç”¨ Alembic

#### è®Šæ›´å…§å®¹
- âŒ ç§»é™¤ `Base.metadata.create_all()`ï¼ˆä¸å†è‡ªå‹•å‰µå»ºè¡¨ï¼‰
- âœ… æ·»åŠ  Alembic ç‰ˆæœ¬æª¢æŸ¥
- âœ… å¦‚æœç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œè¨˜éŒ„è­¦å‘Šæ—¥èªŒ
- âœ… ä¿ç•™ `create_all()` ä½œç‚ºå¾Œå‚™æ–¹æ¡ˆï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼ç’°å¢ƒï¼‰

#### å•Ÿå‹•è¡Œç‚º
1. æª¢æŸ¥ Alembic ç‰ˆæœ¬
2. å¦‚æœç‰ˆæœ¬ä¸€è‡´ï¼Œè¨˜éŒ„æˆåŠŸæ—¥èªŒ
3. å¦‚æœç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œè¨˜éŒ„è­¦å‘Šæ—¥èªŒï¼ˆæç¤ºé‹è¡Œé·ç§»ï¼‰
4. å¦‚æœ Alembic æª¢æŸ¥å¤±æ•—ï¼Œä½¿ç”¨ `create_all()` ä½œç‚ºå¾Œå‚™ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰

### 5. ç·¨å¯«é·ç§»æ–‡æª”

- âœ… `admin-backend/docs/MIGRATION_GUIDE.md` - å®Œæ•´é·ç§»æŒ‡å—
  - å¿«é€Ÿé–‹å§‹
  - é·ç§»æµç¨‹
  - å‰µå»ºé·ç§»
  - æ‡‰ç”¨é·ç§»
  - å›æ»¾é·ç§»
  - æ•¸æ“šåº«å‚™ä»½
  - å¸¸è¦‹å•é¡Œ

- âœ… æ›´æ–° `admin-backend/README.md` - æ·»åŠ é·ç§»èªªæ˜

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶
1. `admin-backend/alembic.ini` - Alembic é…ç½®æ–‡ä»¶
2. `admin-backend/alembic/env.py` - Alembic ç’°å¢ƒé…ç½®
3. `admin-backend/alembic/script.py.mako` - é·ç§»æ–‡ä»¶æ¨¡æ¿
4. `admin-backend/alembic/versions/000_initial_base_tables.py` - åˆå§‹é·ç§»ï¼ˆåŸºç¤è¡¨ï¼‰
5. `admin-backend/scripts/__init__.py` - Scripts åŒ…åˆå§‹åŒ–
6. `admin-backend/scripts/backup_db.py` - æ•¸æ“šåº«å‚™ä»½è…³æœ¬
7. `admin-backend/scripts/run_migrations.py` - é·ç§»é‹è¡Œè…³æœ¬
8. `admin-backend/docs/MIGRATION_GUIDE.md` - é·ç§»æŒ‡å—æ–‡æª”

### ä¿®æ”¹æ–‡ä»¶
1. `admin-backend/app/main.py` - æ›´æ–°å•Ÿå‹•é‚è¼¯ï¼ˆä½¿ç”¨ Alembicï¼‰
2. `admin-backend/alembic/versions/001_create_group_ai_tables.py` - æ›´æ–° `down_revision`
3. `admin-backend/alembic/versions/003_add_script_version_management.py` - ä¿®æ­£ `down_revision`
4. `admin-backend/README.md` - æ›´æ–°é·ç§»èªªæ˜

---

## ğŸ¯ é·ç§»éˆå®Œæ•´æ€§

### é·ç§»é †åº
```
000_initial_base (æ–°å»º)
  â†“ down_revision = '000_initial_base'
001_group_ai
  â†“ down_revision = '001_group_ai'
002_add_indexes
  â†“ down_revision = '002_add_indexes'
003_add_script_version_management
```

### æ•¸æ“šè¡¨è¦†è“‹

**000_initial_base_tables.py** åŒ…å«ï¼š
- âœ… `users` - ç”¨æˆ¶è¡¨
- âœ… `roles` - è§’è‰²è¡¨
- âœ… `permissions` - æ¬Šé™è¡¨
- âœ… `user_roles` - ç”¨æˆ¶-è§’è‰²é—œè¯è¡¨
- âœ… `role_permissions` - è§’è‰²-æ¬Šé™é—œè¯è¡¨

**001_create_group_ai_tables.py** åŒ…å«ï¼š
- âœ… `group_ai_accounts` - ç¾¤çµ„ AI è³¬è™Ÿè¡¨
- âœ… `group_ai_scripts` - åŠ‡æœ¬è¡¨
- âœ… `group_ai_dialogue_history` - å°è©±æ­·å²è¡¨
- âœ… `group_ai_redpacket_logs` - ç´…åŒ…æ—¥èªŒè¡¨
- âœ… `group_ai_metrics` - æŒ‡æ¨™è¡¨

**002_add_indexes_for_performance.py** åŒ…å«ï¼š
- âœ… æ€§èƒ½å„ªåŒ–ç´¢å¼•

**003_add_script_version_management.py** åŒ…å«ï¼š
- âœ… `group_ai_script_versions` - åŠ‡æœ¬ç‰ˆæœ¬æ­·å²è¡¨
- âœ… åŠ‡æœ¬ç‹€æ…‹å’Œå¯©æ ¸ç›¸é—œå­—æ®µ

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### é¦–æ¬¡è¨­ç½®

```bash
cd admin-backend

# é‹è¡Œåˆå§‹é·ç§»ï¼ˆè‡ªå‹•å‚™ä»½ + é·ç§»ï¼‰
poetry run python -m scripts.run_migrations
```

### æ—¥å¸¸é·ç§»

```bash
# ä½¿ç”¨å‚™ä»½è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
poetry run python -m scripts.run_migrations

# æˆ–ç›´æ¥ä½¿ç”¨ Alembic
poetry run alembic upgrade head
```

### å‰µå»ºæ–°é·ç§»

```bash
# è‡ªå‹•ç”Ÿæˆï¼ˆæ¨è–¦ï¼‰
poetry run alembic revision --autogenerate -m "æè¿°è®Šæ›´å…§å®¹"

# æ‰‹å‹•å‰µå»º
poetry run alembic revision -m "æè¿°è®Šæ›´å…§å®¹"
```

### æª¢æŸ¥é·ç§»ç‹€æ…‹

```bash
# æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬
poetry run alembic current

# æŸ¥çœ‹é·ç§»æ­·å²
poetry run alembic history

# æŸ¥çœ‹è©³ç´°æ­·å²
poetry run alembic history --verbose
```

### å›æ»¾é·ç§»

```bash
# å›æ»¾ä¸€å€‹ç‰ˆæœ¬
poetry run alembic downgrade -1

# å›æ»¾åˆ°ç‰¹å®šç‰ˆæœ¬
poetry run alembic downgrade {revision_id}
```

---

## ğŸ”’ å®‰å…¨æ”¹é€²

### é·ç§»å‰è‡ªå‹•å‚™ä»½
- âœ… æ‰€æœ‰é·ç§»å‰è‡ªå‹•å‚™ä»½æ•¸æ“šåº«
- âœ… å‚™ä»½æ–‡ä»¶åŒ…å«æ™‚é–“æˆ³
- âœ… æ”¯æŒ SQLite å’Œ PostgreSQL

### ç‰ˆæœ¬æª¢æŸ¥
- âœ… å•Ÿå‹•æ™‚æª¢æŸ¥æ•¸æ“šåº«ç‰ˆæœ¬
- âœ… ç‰ˆæœ¬ä¸ä¸€è‡´æ™‚è¨˜éŒ„è­¦å‘Š
- âœ… æç¤ºé‹è¡Œé·ç§»å‘½ä»¤

---

## ğŸ“Š èˆ‡åŸæœ‰æ©Ÿåˆ¶å°æ¯”

### åŸæœ‰æ©Ÿåˆ¶ï¼ˆmain.pyï¼‰
```python
Base.metadata.create_all(bind=engine)  # è‡ªå‹•å‰µå»ºæ‰€æœ‰è¡¨
```

**å•é¡Œ**ï¼š
- âŒ ç„¡æ³•è¿½è¹¤æ•¸æ“šåº«çµæ§‹è®Šæ›´
- âŒ ç„¡æ³•å›æ»¾è®Šæ›´
- âŒ ç”Ÿç”¢ç’°å¢ƒæ›´æ–°å›°é›£
- âŒ ç„¡æ³•ç®¡ç†æ•¸æ“šé·ç§»

### æ–°æ©Ÿåˆ¶ï¼ˆAlembicï¼‰
```python
# å•Ÿå‹•æ™‚æª¢æŸ¥ç‰ˆæœ¬
alembic current  # æª¢æŸ¥ç•¶å‰ç‰ˆæœ¬
alembic upgrade head  # å‡ç´šåˆ°æœ€æ–°ç‰ˆæœ¬
```

**å„ªé»**ï¼š
- âœ… å®Œæ•´çš„é·ç§»æ­·å²è¿½è¹¤
- âœ… æ”¯æŒå›æ»¾
- âœ… ç”Ÿç”¢ç’°å¢ƒå‹å¥½
- âœ… æ”¯æŒæ•¸æ“šé·ç§»
- âœ… è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶

---

## âš ï¸ æ³¨æ„äº‹é …

### å°æ–¼å·²å­˜åœ¨çš„æ•¸æ“šåº«

å¦‚æœæ•¸æ“šåº«å·²ç¶“ä½¿ç”¨ `create_all()` å‰µå»ºäº†è¡¨ï¼Œéœ€è¦ï¼š

1. **æª¢æŸ¥ç•¶å‰ç‹€æ…‹**
   ```bash
   poetry run alembic current
   ```

2. **æ‰‹å‹•æ¨™è¨˜ç‚ºå·²æ‡‰ç”¨é·ç§»**ï¼ˆå¦‚æœéœ€è¦ï¼‰
   ```bash
   # å¦‚æœæ•¸æ“šåº«å·²åŒ…å«æ‰€æœ‰è¡¨ï¼Œå¯ä»¥æ‰‹å‹•æ’å…¥ç‰ˆæœ¬è¨˜éŒ„
   # æˆ–åˆªé™¤æ•¸æ“šåº«é‡æ–°é‹è¡Œé·ç§»
   ```

3. **æˆ–é‡æ–°åˆå§‹åŒ–**ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
   ```bash
   # åˆªé™¤æ•¸æ“šåº«æ–‡ä»¶
   rm admin-backend/admin.db
   
   # é‹è¡Œé·ç§»
   poetry run python -m scripts.run_migrations
   ```

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²

1. âœ… **å…ˆå‚™ä»½æ•¸æ“šåº«**
   ```bash
   poetry run python -m scripts.backup_db
   ```

2. âœ… **åœ¨æ¸¬è©¦ç’°å¢ƒæ¸¬è©¦é·ç§»**
   ```bash
   poetry run alembic upgrade head
   ```

3. âœ… **é©—è­‰é·ç§»å¾Œçš„åŠŸèƒ½**
   - é‹è¡Œæ¸¬è©¦å¥—ä»¶
   - æª¢æŸ¥æ‡‰ç”¨åŠŸèƒ½

4. âœ… **åœ¨ç¶­è­·çª—å£åŸ·è¡Œç”Ÿç”¢é·ç§»**
   ```bash
   poetry run python -m scripts.run_migrations
   ```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°

### çŸ­æœŸï¼ˆ1-2 é€±ï¼‰
1. **æ¸¬è©¦é·ç§»æ©Ÿåˆ¶**
   - åœ¨æ¸¬è©¦ç’°å¢ƒé‹è¡Œé·ç§»
   - é©—è­‰æ‰€æœ‰è¡¨çµæ§‹æ­£ç¢º
   - æ¸¬è©¦å›æ»¾åŠŸèƒ½

2. **æ–‡æª”æ›´æ–°**
   - æ›´æ–°éƒ¨ç½²æ–‡æª”
   - æ›´æ–°é–‹ç™¼æ–‡æª”

### ä¸­æœŸï¼ˆ2-4 é€±ï¼‰
3. **çµ±ä¸€é·ç§»ç­–ç•¥**
   - è€ƒæ…®å°‡ä¸»ç¨‹åºä¹Ÿé·ç§»åˆ° Alembic
   - çµ±ä¸€å‚™ä»½æ©Ÿåˆ¶

4. **CI/CD é›†æˆ**
   - åœ¨ CI/CD æµç¨‹ä¸­æ·»åŠ é·ç§»æª¢æŸ¥
   - è‡ªå‹•é‹è¡Œé·ç§»ï¼ˆæ¸¬è©¦ç’°å¢ƒï¼‰

---

## âœ… å®Œæˆç¸½çµ

æœ¬æ¬¡å·¥ä½œå·²å®Œæˆä»¥ä¸‹ç›®æ¨™ï¼š

1. âœ… **å‰µå»º Alembic é…ç½®**ï¼ˆalembic.ini, env.pyï¼‰
2. âœ… **å‰µå»ºåˆå§‹é·ç§»**ï¼ˆåŒ…å«æ‰€æœ‰æ•¸æ“šæ¨¡å‹ï¼‰
3. âœ… **æ·»åŠ é·ç§»å‰è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶**
4. âœ… **æ›´æ–° main.py ä½¿ç”¨ Alembic**
5. âœ… **ç·¨å¯«é·ç§»æ–‡æª”**

**é·ç§»æ–‡ä»¶**: 4 å€‹ï¼ˆ000, 001, 002, 003ï¼‰  
**å‚™ä»½è…³æœ¬**: 2 å€‹ï¼ˆbackup_db.py, run_migrations.pyï¼‰  
**æ–‡æª”**: 1 å€‹ï¼ˆMIGRATION_GUIDE.mdï¼‰  
**ç‹€æ…‹**: âœ… æ‰€æœ‰ä»»å‹™å·²å®Œæˆ

---

**å ±å‘Šç”Ÿæˆå®Œæˆæ™‚é–“**: 2025-01-17  
**ä¸‹æ¬¡æ›´æ–°å»ºè­°**: æ¸¬è©¦é·ç§»æ©Ÿåˆ¶å¾Œï¼Œæ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³èª¿æ•´

