# Telegram注册系统 - 功能测试总结

## 当前状态

### ✅ 已完成

1. **数据库迁移**
   - ✅ 所有表已创建
   - ✅ 迁移版本: `xxxx_add_telegram_registration` (head)

2. **代码验证**
   - ✅ 数据库模型导入成功
   - ✅ 服务类导入成功
   - ✅ API路由注册成功（4个路由）

3. **依赖检查**
   - ✅ paramiko 已安装
   - ✅ 所有Python依赖就绪

### ⏳ 待测试

1. **后端服务启动**
   - 需要手动启动服务
   - 验证API端点可访问

2. **前端服务启动**
   - 需要手动启动服务
   - 验证页面可访问

3. **端到端功能测试**
   - 完整注册流程
   - 异常场景处理

## 手动测试步骤

### 步骤1: 启动后端服务

打开终端1，执行：

```bash
cd admin-backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**验证**:
- 看到 "Uvicorn running on http://0.0.0.0:8000"
- 访问 http://localhost:8000/docs 能看到Swagger文档

### 步骤2: 启动前端服务

打开终端2，执行：

```bash
cd admin-frontend
npm run dev
```

**验证**:
- 看到 "Local: http://localhost:5173"
- 访问该地址能看到前端页面

### 步骤3: 登录系统

1. 打开浏览器访问前端地址
2. 使用有效账号登录
3. 确认登录成功

### 步骤4: 访问注册页面

1. 点击左侧菜单"账户中心"
2. 点击"Telegram注册"标签页
3. 确认页面正常加载

**预期看到**:
- 三个步骤指示器
- 手机号输入框
- 国家代码选择
- 服务器选择下拉框
- "开始注册"按钮

### 步骤5: 测试注册流程

#### 5.1 填写信息

- **手机号**: `+1234567890` (示例，请使用真实手机号)
- **国家代码**: `+1`
- **服务器**: 选择一个可用的服务器节点

#### 5.2 开始注册

1. 点击"开始注册"按钮
2. 观察页面变化

**预期结果**:
- 按钮显示加载状态
- 如果成功: 跳转到步骤2，显示倒计时和风险评分
- 如果失败: 显示错误提示

#### 5.3 输入验证码

1. 查看手机收到的验证码
2. 在输入框中输入验证码
3. 点击"验证"按钮

**预期结果**:
- 如果正确: 跳转到步骤3，显示成功信息
- 如果错误: 显示错误提示

## API测试（使用Swagger UI）

### 访问API文档

1. 打开浏览器访问: http://localhost:8000/docs
2. 找到 `telegram-registration` 标签

### 测试端点

#### 1. POST /telegram-registration/start

**点击"Try it out"**，填写：

```json
{
  "phone": "+1234567890",
  "country_code": "+1",
  "node_id": "worker-01"
}
```

**点击"Execute"**

**预期响应**:
- 状态码: 200 或 401（需要认证）
- 如果成功: 返回 `registration_id` 和 `phone_code_hash`

#### 2. POST /telegram-registration/verify

使用上一步获得的 `registration_id`，填写：

```json
{
  "registration_id": "从start接口获得",
  "code": "12345"
}
```

#### 3. GET /telegram-registration/status/{registration_id}

在路径参数中填入 `registration_id`

**预期响应**:
- 返回注册状态信息
- 包含倒计时信息

## 测试检查清单

### 后端测试

- [ ] 服务启动成功
- [ ] API文档可访问 (http://localhost:8000/docs)
- [ ] 所有4个API端点存在
- [ ] 端点需要认证（返回401为正常）

### 前端测试

- [ ] 服务启动成功
- [ ] 页面可访问
- [ ] 登录功能正常
- [ ] 注册页面可访问
- [ ] 表单显示正常
- [ ] 服务器列表加载

### 功能测试

- [ ] 手机号格式验证
- [ ] 开始注册功能
- [ ] 验证码输入功能
- [ ] 倒计时显示
- [ ] 风险评分显示
- [ ] 错误提示显示
- [ ] 完成注册功能

## 常见问题

### 后端服务无法启动

**问题**: 端口被占用

**解决**:
```bash
# Windows
netstat -ano | findstr :8000
# 找到PID后
taskkill /PID <PID> /F

# 或使用其他端口
uvicorn app.main:app --reload --port 8001
```

### API返回401错误

**原因**: 需要认证token

**解决**:
1. 在Swagger UI中点击右上角"Authorize"按钮
2. 输入有效的JWT token
3. 或使用Postman等工具添加Authorization header

### 前端无法连接后端

**检查**:
1. 确认后端服务已启动
2. 检查 `admin-frontend/.env` 中的 `VITE_API_BASE_URL` 配置
3. 检查浏览器控制台的网络请求

### 注册失败

**可能原因**:
1. 服务器配置不正确 (`data/master_config.json`)
2. 服务器SSH连接失败
3. 服务器上缺少pyrogram
4. 手机号格式错误
5. 触发速率限制

**排查**:
1. 查看后端日志
2. 检查服务器配置
3. 测试SSH连接
4. 查看错误消息

## 测试报告模板

```
测试日期: 2025-11-22
测试人员: [姓名]
测试环境: Windows / Linux / Mac

=== 后端测试 ===
服务启动: [通过/失败]
API文档: [通过/失败]
API端点: [通过/失败]

=== 前端测试 ===
服务启动: [通过/失败]
页面加载: [通过/失败]
登录功能: [通过/失败]

=== 功能测试 ===
注册流程: [通过/失败]
表单验证: [通过/失败]
错误处理: [通过/失败]

=== 发现的问题 ===
1. [问题描述]
2. [问题描述]

=== 建议 ===
1. [建议内容]
2. [建议内容]
```

## 下一步

1. 按照上述步骤手动启动服务
2. 进行端到端功能测试
3. 记录测试结果
4. 修复发现的问题
5. 进行第二轮测试

## 相关文档

- **功能测试指南**: `docs/开发文档/功能测试指南.md`
- **系统就绪报告**: `docs/开发文档/系统就绪报告.md`
- **迁移完成报告**: `docs/开发文档/迁移完成报告.md`

