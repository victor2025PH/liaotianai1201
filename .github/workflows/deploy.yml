name: Deploy aizkw to Server

on:
  push:
    branches:
      - main
    paths:
      - 'aizkw20251219/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_aizkw:
        description: 'éƒ¨ç½² aizkw é¡¹ç›®åˆ° 3003 ç«¯å£'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy aizkw to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸš€ éƒ¨ç½² aizkw é¡¹ç›®"
            echo "ç«¯å£: 3003"
            echo "PM2 åç§°: aizkw-frontend"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""
            
            # é¡¹ç›®é…ç½®ï¼ˆæ˜ç¡®æŒ‡å®šï¼‰
            PROJECT_ROOT="/home/ubuntu/telegram-ai-system"
            SITE_DIR="aizkw20251219"
            PROJECT_DIR="$PROJECT_ROOT/$SITE_DIR"
            TARGET_PORT=3003
            PM2_NAME="aizkw-frontend"
            
            # ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•å­˜åœ¨
            if [ ! -d "$PROJECT_ROOT" ]; then
              echo "âŒ é¡¹ç›®æ ¹ç›®å½•ä¸å­˜åœ¨: $PROJECT_ROOT"
              echo "æ­£åœ¨åˆ›å»ºç›®å½•å¹¶å…‹éš†é¡¹ç›®..."
              mkdir -p "$PROJECT_ROOT"
              cd "$PROJECT_ROOT"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "âŒ Git clone å¤±è´¥"
                exit 1
              }
            fi
            
            # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
            echo "ğŸ“ [1/6] è¿›å…¥é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || {
              echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®æ ¹ç›®å½•"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo ""
            echo "ğŸ“¥ [2/6] æ‹‰å–æœ€æ–°ä»£ç ..."
            echo "----------------------------------------"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ git ä»“åº“
            if [ ! -d ".git" ]; then
              echo "âš ï¸  å½“å‰ç›®å½•ä¸æ˜¯ git ä»“åº“ï¼Œåˆå§‹åŒ–..."
              git init || true
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            # è·å–è¿œç¨‹åˆ†æ”¯ä¿¡æ¯
            git fetch origin main || git fetch origin || true
            
            # åŒæ­¥åˆ°è¿œç¨‹ main åˆ†æ”¯
            echo "åŒæ­¥åˆ° origin/main..."
            git stash || true
            git reset --hard origin/main || {
              echo "âš ï¸  git reset å¤±è´¥ï¼Œå°è¯• git pull..."
              git pull origin main || {
                echo "âš ï¸  Git pull å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
              }
            }
            
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
            echo "æœ€æ–°æäº¤: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # æ£€æŸ¥é¡¹ç›®å­ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ é¡¹ç›®å­ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              echo "å½“å‰é¡¹ç›®ç›®å½•å†…å®¹:"
              ls -la "$PROJECT_ROOT" | head -20
              exit 1
            fi
            
            # è¿›å…¥é¡¹ç›®å­ç›®å½•
            echo "ğŸ“ [3/6] è¿›å…¥é¡¹ç›®å­ç›®å½•: $PROJECT_DIR"
            cd "$PROJECT_DIR" || {
              echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®å­ç›®å½•"
              exit 1
            }
            
            # æ£€æŸ¥ package.json
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json ä¸å­˜åœ¨"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la | head -20
              exit 1
            fi
            
            echo "âœ… æ‰¾åˆ° package.json"
            echo ""
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ [4/6] å®‰è£…ä¾èµ–..."
            echo "----------------------------------------"
            npm install || {
              echo "âŒ npm install å¤±è´¥"
              exit 1
            }
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            echo ""
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ [5/6] æ„å»ºé¡¹ç›®..."
            echo "----------------------------------------"
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "âŒ npm run build å¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºè¾“å‡ºï¼ˆVite é¡¹ç›®åº”è¯¥æ˜¯ dist ç›®å½•ï¼‰
            if [ ! -d "dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la | head -20
              exit 1
            fi
            
            echo "âœ… æ„å»ºå®Œæˆ"
            echo "æ„å»ºè¾“å‡ºå¤§å°: $(du -sh dist | cut -f1)"
            echo ""
            
            # å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨ serve å¯åŠ¨é™æ€æ–‡ä»¶æœåŠ¡ï¼‰
            echo "ğŸš€ [6/6] å¯åŠ¨æœåŠ¡..."
            echo "----------------------------------------"
            
            # æ£€æŸ¥å¹¶å®‰è£… serveï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            if ! command -v serve >/dev/null 2>&1; then
              echo "å®‰è£… serve..."
              sudo npm install -g serve
            fi
            
            # æ£€æŸ¥å¹¶å®‰è£… PM2ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "å®‰è£… PM2..."
              sudo npm install -g pm2
              pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            fi
            
            # åœæ­¢æ—§è¿›ç¨‹ï¼ˆåªå½±å“ aizkw-frontendï¼Œä¸å½±å“å…¶ä»–æœåŠ¡ï¼‰
            echo "åœæ­¢æ—§è¿›ç¨‹..."
            pm2 delete "$PM2_NAME" 2>/dev/null || true
            
            # åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹ï¼ˆåªå½±å“ 3003 ç«¯å£ï¼‰
            if sudo lsof -i :$TARGET_PORT >/dev/null 2>&1; then
              echo "åœæ­¢å ç”¨ç«¯å£ $TARGET_PORT çš„è¿›ç¨‹..."
              sudo lsof -ti :$TARGET_PORT | xargs sudo kill -9 2>/dev/null || true
              sleep 2
            fi
            
            echo "âœ… æ—§è¿›ç¨‹å·²åœæ­¢"
            echo ""
            
            # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
            mkdir -p "$PROJECT_ROOT/logs"
            
            # ç¡®è®¤å½“å‰ç›®å½•å’Œ dist æ–‡ä»¶å¤¹
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo "æ£€æŸ¥ dist ç›®å½•..."
            if [ ! -d "$PROJECT_DIR/dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR/dist"
              exit 1
            fi
            echo "âœ… dist ç›®å½•å­˜åœ¨: $PROJECT_DIR/dist"
            echo ""
            
            # ä½¿ç”¨ PM2 å¯åŠ¨ serveï¼ˆç›´æ¥ä½¿ç”¨ serve å‘½ä»¤ï¼Œä¸éœ€è¦ç”Ÿæˆè„šæœ¬ï¼‰
            echo "ä½¿ç”¨ PM2 å¯åŠ¨é™æ€æ–‡ä»¶æœåŠ¡..."
            echo "å‘½ä»¤: serve -s $PROJECT_DIR/dist -l $TARGET_PORT"
            
            pm2 start serve \
              --name "$PM2_NAME" \
              -- -s "$PROJECT_DIR/dist" -l $TARGET_PORT \
              --error "$PROJECT_ROOT/logs/${PM2_NAME}-error.log" \
              --output "$PROJECT_ROOT/logs/${PM2_NAME}-out.log" \
              --merge-logs \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
              echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯..."
              pm2 logs "$PM2_NAME" --lines 50 --nostream 2>/dev/null || true
              echo "æŸ¥çœ‹ PM2 è¿›ç¨‹çŠ¶æ€:"
              pm2 list || true
              exit 1
            }
            
            pm2 save || true
            echo "âœ… PM2 åº”ç”¨å·²å¯åŠ¨"
            pm2 list | grep "$PM2_NAME" || true
            echo ""
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            # æ£€æŸ¥ PM2 çŠ¶æ€
            PM2_STATUS=$(pm2 describe "$PM2_NAME" 2>/dev/null | grep -E "status|restarts" || echo "")
            echo "PM2 çŠ¶æ€: $PM2_STATUS"
            if echo "$PM2_STATUS" | grep -q "errored\|stopped"; then
              echo "âš ï¸  PM2 è¿›ç¨‹çŠ¶æ€å¼‚å¸¸ï¼ŒæŸ¥çœ‹æ—¥å¿—..."
              pm2 logs "$PM2_NAME" --lines 30 --nostream 2>/dev/null || true
            fi
            
            # æ£€æŸ¥ç«¯å£æ˜¯å¦åœ¨ç›‘å¬
            echo ""
            echo "æ£€æŸ¥ç«¯å£ $TARGET_PORT..."
            sleep 2
            if sudo lsof -i :$TARGET_PORT >/dev/null 2>&1; then
              echo "âœ… ç«¯å£ $TARGET_PORT æ­£åœ¨ç›‘å¬"
              
              # æµ‹è¯•è¿æ¥
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$TARGET_PORT || echo "000")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "âœ… æœåŠ¡å“åº”æ­£å¸¸ (HTTP $HTTP_CODE)"
              else
                echo "âš ï¸  æœåŠ¡å“åº”å¼‚å¸¸ (HTTP $HTTP_CODE)"
                pm2 logs "$PM2_NAME" --lines 10 --nostream 2>/dev/null || true
              fi
            else
              echo "âŒ ç«¯å£ $TARGET_PORT æœªåœ¨ç›‘å¬ï¼Œåº”ç”¨å¯èƒ½æœªæˆåŠŸå¯åŠ¨"
              echo "=========================================="
              echo "ğŸ” è¯¦ç»†é”™è¯¯è¯Šæ–­..."
              echo "=========================================="
              echo "PM2 è¿›ç¨‹çŠ¶æ€:"
              pm2 list || true
              echo ""
              echo "PM2 è¿›ç¨‹è¯¦æƒ…:"
              pm2 describe "$PM2_NAME" || true
              echo ""
              echo "PM2 æœ€æ–°æ—¥å¿— (æœ€å 50 è¡Œ):"
              pm2 logs "$PM2_NAME" --lines 50 --nostream 2>/dev/null || true
              echo ""
              echo "æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ:"
              ps aux | grep -E "serve|$PM2_NAME" | grep -v grep || true
              echo ""
              echo "æ£€æŸ¥ç«¯å£å ç”¨:"
              sudo lsof -i :$TARGET_PORT || echo "ç«¯å£æœªè¢«å ç”¨"
              exit 1
            fi
            
            echo ""
            echo "=========================================="
            echo "âœ… aizkw éƒ¨ç½²å®Œæˆï¼"
            echo "ç«¯å£: $TARGET_PORT"
            echo "PM2 åç§°: $PM2_NAME"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""
            echo "éªŒè¯å‘½ä»¤:"
            echo "  pm2 list | grep $PM2_NAME"
            echo "  curl -I http://127.0.0.1:$TARGET_PORT"
            echo "  sudo lsof -i :$TARGET_PORT"
