# 服務器上直接應用修復

> **日期**: 2025-12-01  
> **問題**: 測試返回 404，需要在服務器上應用修復

---

## 🔧 解決方案

由於測試返回 404，說明服務器代碼還沒有包含修復。有兩種方式：

### 方案 1: 檢查並在服務器上直接應用修復（快速）

### 方案 2: 通過 Git 部署（推薦，但需要 Git 倉庫已更新）

---

## 🚀 方案 1: 直接在服務器上檢查和修復

### 步驟 1: 找到實際運行的後端目錄

```bash
# 查看運行中的進程
ps aux | grep uvicorn | grep app.main | grep -v grep

# 查看進程的工作目錄
ls -l /proc/$(pgrep -f "uvicorn.*app.main:app" | head -1)/cwd 2>/dev/null | awk '{print $NF}'
```

### 步驟 2: 檢查代碼並備份

```bash
# 進入後端目錄（根據步驟1的結果）
cd /home/ubuntu/liaotian/admin-backend  # 或實際目錄

# 備份原文件
cp app/api/group_ai/accounts.py app/api/group_ai/accounts.py.bak

# 檢查當前代碼
grep -n "檢查數據庫（包含遠程服務器賬號）" app/api/group_ai/accounts.py
```

### 步驟 3: 如果代碼不包含修復，需要手動應用

需要修改 `get_account_status` 函數，添加數據庫檢查邏輯。由於修改較複雜，建議使用方案 2。

---

## 🚀 方案 2: 通過 Git 部署（推薦）

### 步驟 1: 確認本地代碼已提交

```bash
# 在本地檢查
git status
git log --oneline -1 -- admin-backend/app/api/group_ai/accounts.py
```

### 步驟 2: 推送到 Git 倉庫

```bash
# 提交修復（如果還沒提交）
git add admin-backend/app/api/group_ai/accounts.py
git commit -m "修復: 賬號狀態端點添加數據庫檢查"
git push origin main  # 或 master
```

### 步驟 3: 在服務器上拉取最新代碼

```bash
# 進入後端目錄
cd /home/ubuntu/liaotian/admin-backend  # 或實際目錄

# 拉取最新代碼
git pull origin main  # 或 master

# 檢查代碼是否已更新
grep -n "檢查數據庫（包含遠程服務器賬號）" app/api/group_ai/accounts.py
```

### 步驟 4: 重啟後端服務

```bash
# 停止服務
pkill -f "uvicorn.*app.main:app"
sleep 3

# 啟動服務
source ../.venv/bin/activate 2>/dev/null || source .venv/bin/activate 2>/dev/null
nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5

# 驗證
curl http://localhost:8000/health
```

---

## 🎯 快速執行（推薦）

如果服務器使用 Git，執行：

```bash
# 找到後端目錄
BACKEND_DIR=$(find ~ -type d -name "admin-backend" -exec test -f {}/app/main.py \; -print 2>/dev/null | head -1)

if [ -n "$BACKEND_DIR" ]; then
    echo "找到後端目錄: $BACKEND_DIR"
    cd "$BACKEND_DIR"
    
    # 拉取最新代碼（如果是 Git 倉庫）
    if [ -d ".git" ]; then
        echo "拉取最新代碼..."
        git pull origin main 2>/dev/null || git pull origin master 2>/dev/null
        
        # 檢查是否包含修復
        if grep -q "檢查數據庫（包含遠程服務器賬號）" app/api/group_ai/accounts.py; then
            echo "✅ 代碼已更新，重啟服務..."
            pkill -f "uvicorn.*app.main:app"
            sleep 3
            source ../.venv/bin/activate 2>/dev/null || source .venv/bin/activate 2>/dev/null
            nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
            sleep 5
            curl http://localhost:8000/health
        else
            echo "⚠️ 代碼未更新，需要手動部署"
        fi
    else
        echo "⚠️ 不是 Git 倉庫，需要手動部署"
    fi
fi
```

---

**先檢查服務器是否使用 Git，然後決定使用哪個方案！**
