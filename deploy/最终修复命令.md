# Nginx 配置修复 - 最终执行命令

## 问题

所有 `/api/` 请求返回前端 HTML 而不是后端 JSON，说明 Nginx 没有正确转发 API 请求。

## 修复后的完整 server 配置

```nginx
server {
    listen 80;
    server_name aikz.usdt2026.cc;

    # WebSocket 支持 - 通知服务（必须在 /api/ 之前，优先级最高）
    location /api/v1/notifications/ws {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;
    }

    # 后端 API（必须在 / 之前，优先级高于前端）
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300;
    }

    # 前端（最后，最低优先级）
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 86400;
    }
}
```

## 关键修复点

### 1. proxy_pass 配置（最重要）

**正确写法：**
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8000;  # 注意：不包含路径
}
```

**错误写法：**
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8000/api/;  # 错误：会导致路径重复
}
```

**原因：**
- 当 `proxy_pass` 不包含路径时，Nginx 会将完整请求路径传递给后端
- `/api/v1/dashboard` → `http://127.0.0.1:8000/api/v1/dashboard` ✅
- 如果写成 `proxy_pass http://127.0.0.1:8000/api/;`，会变成 `/api/api/v1/dashboard` ❌

### 2. location 顺序（优先级从高到低）

1. `/api/v1/notifications/ws` - 最具体，优先级最高
2. `/api/` - 匹配所有 API 请求
3. `/` - 匹配所有其他请求（前端）

## 在服务器上执行的修复命令

### 完整修复命令（一键执行）

```bash
# 备份配置
sudo cp /etc/nginx/sites-available/aikz.usdt2026.cc /etc/nginx/sites-available/aikz.usdt2026.cc.bak.$(date +%Y%m%d_%H%M%S) && \
sudo python3 << 'PYEOF'
import re

with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 找到 server 块
server_start = None
server_end = None

for i, line in enumerate(lines):
    if 'server_name aikz.usdt2026.cc' in line:
        # 向前查找 server {
        for j in range(max(0, i-10), i+1):
            if 'server {' in lines[j] or 'server{' in lines[j]:
                server_start = j
                break
        if server_start is None:
            server_start = i
        
        # 向后查找结束的 }
        brace_count = 0
        found_open = False
        for j in range(server_start, len(lines)):
            if '{' in lines[j]:
                brace_count += lines[j].count('{')
                found_open = True
            if '}' in lines[j]:
                brace_count -= lines[j].count('}')
                if found_open and brace_count == 0:
                    server_end = j
                    break
        break

if server_start is None or server_end is None:
    print('未找到 server 块')
    exit(1)

# 构建新配置
new_lines = []
new_lines.extend(lines[:server_start])
new_lines.append('server {\n')
new_lines.append('    listen 80;\n')
new_lines.append('    server_name aikz.usdt2026.cc;\n')
new_lines.append('\n')
new_lines.append('    # WebSocket 支持 - 通知服务（必须在 /api/ 之前，优先级最高）\n')
new_lines.append('    location /api/v1/notifications/ws {\n')
new_lines.append('        proxy_pass http://127.0.0.1:8000;\n')
new_lines.append('        proxy_http_version 1.1;\n')
new_lines.append('        proxy_set_header Upgrade $http_upgrade;\n')
new_lines.append('        proxy_set_header Connection "upgrade";\n')
new_lines.append('        proxy_set_header Host $host;\n')
new_lines.append('        proxy_set_header X-Real-IP $remote_addr;\n')
new_lines.append('        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n')
new_lines.append('        proxy_set_header X-Forwarded-Proto $scheme;\n')
new_lines.append('        proxy_read_timeout 86400;\n')
new_lines.append('        proxy_send_timeout 86400;\n')
new_lines.append('        proxy_buffering off;\n')
new_lines.append('    }\n')
new_lines.append('\n')
new_lines.append('    # 后端 API（必须在 / 之前，优先级高于前端）\n')
new_lines.append('    location /api/ {\n')
new_lines.append('        proxy_pass http://127.0.0.1:8000;\n')
new_lines.append('        proxy_http_version 1.1;\n')
new_lines.append('        proxy_set_header Host $host;\n')
new_lines.append('        proxy_set_header X-Real-IP $remote_addr;\n')
new_lines.append('        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n')
new_lines.append('        proxy_set_header X-Forwarded-Proto $scheme;\n')
new_lines.append('        proxy_read_timeout 300;\n')
new_lines.append('    }\n')
new_lines.append('\n')
new_lines.append('    # 前端（最后，最低优先级）\n')
new_lines.append('    location / {\n')
new_lines.append('        proxy_pass http://127.0.0.1:3000;\n')
new_lines.append('        proxy_http_version 1.1;\n')
new_lines.append('        proxy_set_header Upgrade $http_upgrade;\n')
new_lines.append('        proxy_set_header Connection "upgrade";\n')
new_lines.append('        proxy_set_header Host $host;\n')
new_lines.append('        proxy_set_header X-Real-IP $remote_addr;\n')
new_lines.append('        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n')
new_lines.append('        proxy_read_timeout 86400;\n')
new_lines.append('    }\n')
new_lines.append('}\n')
new_lines.extend(lines[server_end+1:])

with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'w', encoding='utf-8') as f:
    f.writelines(new_lines)

print('配置已修复')
PYEOF

# 测试配置
sudo nginx -t

# 应用配置
sudo systemctl reload nginx
```

## 分步执行（推荐，更安全）

```bash
# 步骤 1: 备份配置
sudo cp /etc/nginx/sites-available/aikz.usdt2026.cc /etc/nginx/sites-available/aikz.usdt2026.cc.bak.$(date +%Y%m%d_%H%M%S)

# 步骤 2: 执行修复脚本
sudo python3 << 'PYEOF'
import re

with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 找到 server 块
server_start = None
server_end = None

for i, line in enumerate(lines):
    if 'server_name aikz.usdt2026.cc' in line:
        for j in range(max(0, i-10), i+1):
            if 'server {' in lines[j] or 'server{' in lines[j]:
                server_start = j
                break
        if server_start is None:
            server_start = i
        
        brace_count = 0
        found_open = False
        for j in range(server_start, len(lines)):
            if '{' in lines[j]:
                brace_count += lines[j].count('{')
                found_open = True
            if '}' in lines[j]:
                brace_count -= lines[j].count('}')
                if found_open and brace_count == 0:
                    server_end = j
                    break
        break

if server_start is None or server_end is None:
    print('未找到 server 块')
    exit(1)

# 构建新配置
new_lines = []
new_lines.extend(lines[:server_start])
new_lines.append('server {\n')
new_lines.append('    listen 80;\n')
new_lines.append('    server_name aikz.usdt2026.cc;\n')
new_lines.append('\n')
new_lines.append('    # WebSocket 支持 - 通知服务（必须在 /api/ 之前，优先级最高）\n')
new_lines.append('    location /api/v1/notifications/ws {\n')
new_lines.append('        proxy_pass http://127.0.0.1:8000;\n')
new_lines.append('        proxy_http_version 1.1;\n')
new_lines.append('        proxy_set_header Upgrade $http_upgrade;\n')
new_lines.append('        proxy_set_header Connection "upgrade";\n')
new_lines.append('        proxy_set_header Host $host;\n')
new_lines.append('        proxy_set_header X-Real-IP $remote_addr;\n')
new_lines.append('        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n')
new_lines.append('        proxy_set_header X-Forwarded-Proto $scheme;\n')
new_lines.append('        proxy_read_timeout 86400;\n')
new_lines.append('        proxy_send_timeout 86400;\n')
new_lines.append('        proxy_buffering off;\n')
new_lines.append('    }\n')
new_lines.append('\n')
new_lines.append('    # 后端 API（必须在 / 之前，优先级高于前端）\n')
new_lines.append('    location /api/ {\n')
new_lines.append('        proxy_pass http://127.0.0.1:8000;\n')
new_lines.append('        proxy_http_version 1.1;\n')
new_lines.append('        proxy_set_header Host $host;\n')
new_lines.append('        proxy_set_header X-Real-IP $remote_addr;\n')
new_lines.append('        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n')
new_lines.append('        proxy_set_header X-Forwarded-Proto $scheme;\n')
new_lines.append('        proxy_read_timeout 300;\n')
new_lines.append('    }\n')
new_lines.append('\n')
new_lines.append('    # 前端（最后，最低优先级）\n')
new_lines.append('    location / {\n')
new_lines.append('        proxy_pass http://127.0.0.1:3000;\n')
new_lines.append('        proxy_http_version 1.1;\n')
new_lines.append('        proxy_set_header Upgrade $http_upgrade;\n')
new_lines.append('        proxy_set_header Connection "upgrade";\n')
new_lines.append('        proxy_set_header Host $host;\n')
new_lines.append('        proxy_set_header X-Real-IP $remote_addr;\n')
new_lines.append('        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n')
new_lines.append('        proxy_read_timeout 86400;\n')
new_lines.append('    }\n')
new_lines.append('}\n')
new_lines.extend(lines[server_end+1:])

with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'w', encoding='utf-8') as f:
    f.writelines(new_lines)

print('配置已修复')
PYEOF

# 步骤 3: 测试配置
sudo nginx -t

# 步骤 4: 应用配置（如果测试通过）
sudo systemctl reload nginx
```

## 验证修复

修复后执行：

```bash
# 1. 检查配置语法
sudo nginx -t

# 2. 查看 location 配置
sudo grep -A 3 'location /api/' /etc/nginx/sites-available/aikz.usdt2026.cc

# 3. 测试 API 端点（应该返回 JSON，不是 HTML）
curl http://localhost/api/v1/dashboard
curl http://localhost/api/v1/users/me

# 4. 检查 Nginx 状态
sudo systemctl status nginx
```

## 预期结果

修复后：
- ✅ `/api/v1/dashboard` 返回 JSON（不是 HTML）
- ✅ `/api/v1/users/me` 返回 JSON
- ✅ `/api/v1/notifications/ws/{email}` WebSocket 连接成功
- ✅ 前端页面正常加载

## 配置变更摘要

**主要变更：**
1. ✅ 添加/修正 `location /api/` 配置，`proxy_pass` 不包含路径
2. ✅ 确保 `location /api/v1/notifications/ws` 在 `/api/` 之前
3. ✅ 确保 `location /` 在最后
4. ✅ 删除所有重复的 location 块

**关键点：**
- `location /api/` 的 `proxy_pass` 必须是 `http://127.0.0.1:8000`（不包含 `/api/`）
- location 顺序：WebSocket > API > 前端

