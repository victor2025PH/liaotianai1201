# 404 问题修复说明 - 最终方案

## 问题描述

用户在测试"分配剧本"功能时，仍然遇到 **404 错误**："賬號 639454959591 不存在"。

## 问题分析

从截图看到：
- 错误信息：`PUT http://aikz.usdt2026.cc/api/v1/group-ai/accounts/639454959591 404 (Not Found)`
- 前端已经正确发送了 `server_id: computer_002`
- 但后端仍然返回 404

## 可能原因

1. **文件未正确上传到服务器**
   - 修改后的代码可能没有成功上传到服务器
   - 服务器上的文件仍然是旧版本

2. **后端服务未重启**
   - 即使文件已更新，后端服务可能仍在使用旧的代码（Python 模块缓存）

3. **代码逻辑问题**
   - UPSERT 逻辑可能没有正确执行
   - 可能在其他地方返回了 404

## 最终修复方案

### 步骤 1: 确保文件已上传

```bash
# 在本地执行
scp admin-backend/app/api/group_ai/accounts.py ubuntu@165.154.233.55:~/liaotian/admin-backend/app/api/group_ai/accounts.py

# 验证文件
ssh ubuntu@165.154.233.55 "grep -c 'UPSERT 模式' ~/liaotian/admin-backend/app/api/group_ai/accounts.py"
```

### 步骤 2: 强制重启后端服务

```bash
# 在服务器上执行
cd ~/liaotian/admin-backend
source .venv/bin/activate

# 强制杀死所有相关进程
pkill -9 -f 'uvicorn.*app.main:app' || true
pkill -9 -f 'python.*uvicorn' || true
sleep 3

# 启动新服务
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 10

# 验证
curl http://localhost:8000/health
```

### 步骤 3: 验证 UPSERT 功能

```bash
# 登录获取 token
TOKEN=$(curl -s -X POST 'http://localhost:8000/api/v1/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin@example.com&password=changeme123' | \
  python3 -c 'import sys, json; print(json.load(sys.stdin)["access_token"])')

# 测试 UPSERT（账号不存在）
curl -X PUT "http://localhost:8000/api/v1/group-ai/accounts/639454959591" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "script_id": "test-script",
    "server_id": "computer_002"
  }' \
  -v

# 应该返回 200/201，而不是 404
```

## 重要提示

1. **必须重启后端服务**：修改代码后，必须完全重启后端服务才能加载新代码
2. **检查日志**：查看 `/tmp/backend.log` 确认是否有错误
3. **验证文件**：确认服务器上的文件确实包含 UPSERT 代码

## 如果仍然返回 404

1. 检查后端日志：`tail -100 /tmp/backend.log`
2. 检查代码是否已上传：`grep "UPSERT 模式" ~/liaotian/admin-backend/app/api/group_ai/accounts.py`
3. 检查服务是否重启：`ps aux | grep uvicorn`
4. 检查是否有其他错误：查看日志中的异常信息

---

**最后更新**: 2025-11-29
