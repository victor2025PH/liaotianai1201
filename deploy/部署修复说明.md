# 部署修复说明

## 问题总结

1. **paramiko 模块未安装** - Python脚本需要此模块
2. **SSH命令语法错误** - PowerShell中转义字符问题
3. **构建失败** - 语法错误导致前端服务无法启动
4. **502错误** - 前端服务未运行

## 解决方案

### 方法1：使用批处理脚本（推荐）

```powershell
.\deploy\一键修复部署.bat
```

这个脚本会：
1. 重新构建前端
2. 重启前端服务
3. 显示服务状态

### 方法2：手动执行SSH命令

#### 步骤1：重新构建前端

```bash
ssh ubuntu@165.154.233.55 "bash -c 'cd /home/ubuntu/liaotian/saas-demo && export NVM_DIR=\"\$HOME/.nvm\" && [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\" && nvm use 20 && rm -rf .next && npm run build'"
```

#### 步骤2：重启前端服务

```bash
ssh ubuntu@165.154.233.55 "sudo systemctl restart liaotian-frontend"
```

#### 步骤3：检查服务状态

```bash
ssh ubuntu@165.154.233.55 "sudo systemctl status liaotian-frontend --no-pager | head -20"
```

#### 步骤4：检查端口监听

```bash
ssh ubuntu@165.154.233.55 "sudo netstat -tlnp | grep ':3000'"
```

### 方法3：安装paramiko后使用Python脚本

如果需要使用Python诊断脚本：

```powershell
# 安装paramiko
pip install paramiko

# 运行诊断脚本
python deploy/全面诊断部署状态.py
```

## 验证步骤

修复后，请验证：

1. **服务状态**
   ```bash
   ssh ubuntu@165.154.233.55 "sudo systemctl is-active liaotian-frontend"
   ```
   应该返回：`active`

2. **端口监听**
   ```bash
   ssh ubuntu@165.154.233.55 "sudo netstat -tlnp | grep ':3000'"
   ```
   应该显示端口3000正在监听

3. **浏览器访问**
   - 清除浏览器缓存（Ctrl+Shift+Delete）
   - 强制刷新页面（Ctrl+F5）
   - 访问 http://aikz.usdt2026.cc
   - 应该不再显示502错误

## 故障排查

### 如果构建失败

1. 检查语法错误：
   ```bash
   ssh ubuntu@165.154.233.55 "cd /home/ubuntu/liaotian/saas-demo && npm run build 2>&1 | grep -i error"
   ```

2. 查看详细构建日志：
   ```bash
   ssh ubuntu@165.154.233.55 "cd /home/ubuntu/liaotian/saas-demo && npm run build"
   ```

### 如果服务无法启动

1. 查看服务日志：
   ```bash
   ssh ubuntu@165.154.233.55 "sudo journalctl -u liaotian-frontend -n 50 --no-pager"
   ```

2. 检查服务配置：
   ```bash
   ssh ubuntu@165.154.233.55 "cat /etc/systemd/system/liaotian-frontend.service"
   ```

### 如果仍然显示502

1. 检查Nginx状态：
   ```bash
   ssh ubuntu@165.154.233.55 "sudo systemctl status nginx"
   ```

2. 检查Nginx配置：
   ```bash
   ssh ubuntu@165.154.233.55 "sudo nginx -t"
   ```

3. 检查Nginx错误日志：
   ```bash
   ssh ubuntu@165.154.233.55 "sudo tail -20 /var/log/nginx/error.log"
   ```

## 已创建的脚本

1. `deploy/一键修复部署.bat` - 一键修复脚本（推荐）
2. `deploy/快速验证部署.bat` - 快速验证脚本
3. `deploy/重新构建并重启.bat` - 重新构建脚本
4. `deploy/验证部署状态.ps1` - PowerShell验证脚本
5. `deploy/重新构建并重启.ps1` - PowerShell构建脚本

## 下一步

执行以下命令开始修复：

```powershell
.\deploy\一键修复部署.bat
```

