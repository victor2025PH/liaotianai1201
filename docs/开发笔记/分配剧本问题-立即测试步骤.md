# 分配剧本问题 - 立即测试步骤

## 当前问题

分配剧本时显示"账号不存在"错误（404），需要启动服务并查看日志。

## 立即执行的命令

### 步骤1：启动后端服务

在服务器上执行：

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f 'uvicorn.*app.main:app' || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &
sleep 5
curl http://localhost:8000/health
```

如果看到 `{"status":"ok"}` 或类似输出，说明后端已启动。

### 步骤2：启动前端服务（如果需要）

```bash
cd ~/liaotian/saas-demo
pkill -f 'next.*dev|node.*3000' || true
sleep 2
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 10
curl http://localhost:3000
```

### 步骤3：查看实时日志

在另一个终端窗口执行：

```bash
tail -f /tmp/backend_final.log | grep -E "MIDDLEWARE|UPDATE_ACCOUNT|server_id|账号ID匹配|639277358115"
```

### 步骤4：测试分配剧本

1. 刷新浏览器页面（Ctrl+Shift+R）
2. 选择账号 639277358115（Eve）
3. 点击"分配剧本"
4. 选择剧本和角色
5. 点击"分配剧本"

### 步骤5：观察日志

在查看日志的终端窗口，应该会看到类似输出：

```
[MIDDLEWARE] PUT 请求到达: /api/v1/group-ai/accounts/639277358115
[UPDATE_ACCOUNT] 收到更新賬號請求: account_id=639277358115
[UPDATE_ACCOUNT] server_id=computer_001
开始扫描服务器 computer_001
扫描结果: 找到 X 个账号
账号ID列表: ['639277358115', ...]
账号ID匹配: 目标='639277358115', 类型=str, 找到=True
```

## 如果仍然失败

### 查看完整日志

```bash
tail -100 /tmp/backend_final.log
```

### 查看最近的错误

```bash
tail -100 /tmp/backend_final.log | grep -E "错误|Error|404|不存在|失败"
```

### 检查服务是否运行

```bash
ps aux | grep uvicorn | grep -v grep
```

### 检查端口

```bash
sudo ss -tlnp | grep 8000
```

## 一键启动脚本

如果上面的步骤太复杂，可以使用一键脚本：

```bash
bash ~/liaotian/deploy/强制启动并诊断服务.sh
```

## 常见问题

### 日志文件不存在

如果 `/tmp/backend_final.log` 不存在：
- 后端服务可能没有启动
- 检查进程：`ps aux | grep uvicorn`
- 重新启动后端服务

### 没有日志输出

如果没有看到日志：
- 请求可能没有到达后端
- 检查浏览器控制台是否有错误
- 检查 Nginx 配置和日志

### 404 错误

如果仍然 404：
- 查看日志中的详细信息
- 检查 `server_id` 是否正确
- 检查账号ID匹配结果

## 关键日志关键字

查找以下关键字：
- `MIDDLEWARE` - 请求到达中间件
- `UPDATE_ACCOUNT` - 更新账号请求
- `server_id` - 服务器ID
- `账号ID匹配` - 账号ID匹配结果
- `639277358115` - 目标账号ID
- `computer_001` - 服务器节点ID
