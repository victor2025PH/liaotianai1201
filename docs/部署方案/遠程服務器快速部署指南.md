# 遠程服務器快速部署指南

## 服務器信息

根據您提供的雲主機信息：

- **外網IP**: `165.154.254.99`
- **內網IP**: `10.11.156.159`
- **操作系統**: Ubuntu 24.04 64位
- **配置**: 2核CPU, 2GB內存, 40GB磁盤
- **遠程密碼**: `Along2025!!!`
- **SSH端口**: 22（默認）

## 快速部署步驟

### 步驟1: 準備本地環境

#### Windows用戶

1. 安裝OpenSSH（如果未安裝）：
   ```powershell
   # 在PowerShell中執行（管理員權限）
   Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
   ```

2. 或使用PuTTY/Windows Terminal

#### Linux/macOS用戶

確保已安裝：
- `ssh` 客戶端
- `sshpass`（用於自動輸入密碼）

```bash
# Ubuntu/Debian
sudo apt-get install sshpass

# macOS
brew install hudochenkov/sshpass/sshpass
```

### 步驟2: 執行自動部署

#### 方式1: 使用Bash腳本（推薦）

```bash
# 進入項目目錄
cd "E:\002-工作文件\重要程序\聊天AI群聊程序"

# 設置環境變量並執行部署
export REMOTE_HOST="165.154.254.99"
export REMOTE_USER="root"
export REMOTE_PASSWORD="Along2025!!!"
export NODE_ID="worker-01"
export MAX_ACCOUNTS=5

# 執行部署腳本
bash scripts/deployment/deploy_remote_worker.sh
```

#### 方式2: 使用PowerShell腳本（Windows）

```powershell
# 進入項目目錄
cd "E:\002-工作文件\重要程序\聊天AI群聊程序"

# 執行部署腳本
.\scripts\deployment\deploy_remote_worker.ps1 `
    -RemoteHost "165.154.254.99" `
    -RemoteUser "root" `
    -RemotePassword "Along2025!!!" `
    -NodeId "worker-01" `
    -MaxAccounts 5
```

### 步驟3: 手動配置（如果自動部署失敗）

如果自動部署腳本執行失敗，可以手動執行以下步驟：

#### 3.1 連接服務器

```bash
ssh root@165.154.254.99
# 輸入密碼: Along2025!!!
```

#### 3.2 更新系統並安裝基礎工具

```bash
export DEBIAN_FRONTEND=noninteractive
apt-get update
apt-get upgrade -y
apt-get install -y \
    curl \
    wget \
    git \
    vim \
    htop \
    net-tools \
    ufw \
    build-essential \
    software-properties-common \
    python3-pip \
    python3-venv \
    python3-dev
```

#### 3.3 安裝Python 3.11

```bash
add-apt-repository -y ppa:deadsnakes/ppa
apt-get update
apt-get install -y python3.11 python3.11-venv python3.11-dev
```

#### 3.4 創建部署目錄

```bash
DEPLOY_DIR="/opt/group-ai"
mkdir -p ${DEPLOY_DIR}/{sessions,logs,configs,ai_models/group_scripts,data}
chmod -R 755 ${DEPLOY_DIR}
```

#### 3.5 創建Python虛擬環境

```bash
python3.11 -m venv ${DEPLOY_DIR}/venv
${DEPLOY_DIR}/venv/bin/pip install --upgrade pip setuptools wheel
```

#### 3.6 上傳項目文件

從本地計算機執行：

```bash
# 打包項目文件
cd "E:\002-工作文件\重要程序\聊天AI群聊程序"
tar czf /tmp/group-ai-deploy.tar.gz \
    group_ai_service/ \
    admin-backend/app/api/group_ai/ \
    config.py \
    admin-backend/requirements.txt

# 上傳到服務器
scp /tmp/group-ai-deploy.tar.gz root@165.154.254.99:/tmp/

# 在服務器上解壓
ssh root@165.154.254.99 "cd /opt/group-ai && tar xzf /tmp/group-ai-deploy.tar.gz"
```

#### 3.7 安裝Python依賴

```bash
# 在服務器上執行
cd /opt/group-ai
source venv/bin/activate

# 創建requirements.txt（如果不存在）
cat > requirements.txt << 'EOF'
pyrogram>=2.0.0
tgcrypto>=1.2.5
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
pydantic>=2.0.0
pydantic-settings>=2.0.0
sqlalchemy>=2.0.0
alembic>=1.12.0
aiosqlite>=0.19.0
redis>=5.0.0
hiredis>=2.2.0
openai>=1.0.0
tiktoken>=0.5.0
python-dotenv>=1.0.0
pyyaml>=6.0
aiofiles>=23.2.0
httpx>=0.25.0
prometheus-client>=0.19.0
EOF

# 安裝依賴
pip install -r requirements.txt
```

#### 3.8 創建配置文件

```bash
# 在服務器上執行
cat > /opt/group-ai/.env << 'EOF'
# 應用配置
APP_NAME=Group AI Worker Node
APP_ENV=production
DEBUG=false
NODE_ID=worker-01
NODE_ROLE=worker

# 數據庫配置
DATABASE_URL=sqlite:////opt/group-ai/data/group_ai.db

# Telegram API配置（需要修改）
TELEGRAM_API_ID=your_api_id
TELEGRAM_API_HASH=your_api_hash

# OpenAI配置（需要修改）
OPENAI_API_KEY=your_openai_api_key
OPENAI_MODEL=gpt-3.5-turbo

# Session文件配置
SESSION_FILES_DIRECTORY=/opt/group-ai/sessions
SESSION_FILES_BACKUP_DIRECTORY=/opt/group-ai/sessions_backup

# 帳號配置
MAX_ACCOUNTS_PER_NODE=5
ACCOUNT_HEALTH_CHECK_INTERVAL=60
ACCOUNT_RECONNECT_DELAY=5
ACCOUNT_MAX_RECONNECT_ATTEMPTS=3

# 日誌配置
LOG_LEVEL=INFO
LOG_FILE=/opt/group-ai/logs/worker.log
LOG_MAX_SIZE=100MB
LOG_BACKUP_COUNT=10

# 監控配置
METRICS_ENABLED=true
METRICS_PORT=9091
HEARTBEAT_INTERVAL=30
EOF
```

#### 3.9 創建config.py（如果不存在）

```bash
cat > /opt/group-ai/config.py << 'EOF'
import os
from dotenv import load_dotenv

load_dotenv()

# Telegram API配置
API_ID = int(os.getenv('TELEGRAM_API_ID', '0'))
API_HASH = os.getenv('TELEGRAM_API_HASH', '')

# OpenAI配置
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY', '')
OPENAI_MODEL = os.getenv('OPENAI_MODEL', 'gpt-3.5-turbo')
EOF
```

### 步驟4: 配置API密鑰

編輯配置文件並填入正確的API密鑰：

```bash
ssh root@165.154.254.99
vi /opt/group-ai/.env
```

需要修改：
- `TELEGRAM_API_ID`: 從 https://my.telegram.org 獲取
- `TELEGRAM_API_HASH`: 從 https://my.telegram.org 獲取
- `OPENAI_API_KEY`: 您的OpenAI API Key（如果使用）

### 步驟5: 上傳Session文件

將您的Telegram Session文件上傳到服務器：

```bash
# 從本地上傳（Windows PowerShell）
scp "E:\path\to\your\*.session" root@165.154.254.99:/opt/group-ai/sessions/

# 或使用SFTP客戶端（如FileZilla）
# 主機: 165.154.254.99
# 用戶名: root
# 密碼: Along2025!!!
# 端口: 22
# 目標目錄: /opt/group-ai/sessions/
```

### 步驟6: 創建啟動腳本

```bash
# 在服務器上執行
cat > /opt/group-ai/start.sh << 'EOF'
#!/bin/bash
cd /opt/group-ai
source venv/bin/activate
export PYTHONPATH=/opt/group-ai:$PYTHONPATH

# 如果存在admin-backend目錄，使用uvicorn啟動
if [ -d "admin-backend" ]; then
    cd admin-backend
    python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
else
    # 否則啟動group_ai_service
    python -m group_ai_service.main --host 0.0.0.0 --port 8000
fi
EOF

chmod +x /opt/group-ai/start.sh
```

### 步驟7: 配置防火牆

```bash
# 在服務器上執行
ufw allow 22/tcp    # SSH
ufw allow 8000/tcp  # API服務
ufw --force enable
ufw status
```

### 步驟8: 啟動服務

#### 方式1: 手動啟動（測試用）

```bash
ssh root@165.154.254.99
cd /opt/group-ai
./start.sh
```

#### 方式2: 使用systemd服務（推薦）

```bash
# 在服務器上執行
cat > /etc/systemd/system/group-ai-worker.service << 'EOF'
[Unit]
Description=Group AI Worker Node Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/group-ai
Environment="PATH=/opt/group-ai/venv/bin"
Environment="PYTHONPATH=/opt/group-ai"
ExecStart=/opt/group-ai/venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 啟動服務
systemctl daemon-reload
systemctl enable group-ai-worker
systemctl start group-ai-worker

# 查看狀態
systemctl status group-ai-worker
```

### 步驟9: 驗證部署

#### 檢查服務狀態

```bash
# 檢查服務是否運行
ssh root@165.154.254.99 'systemctl status group-ai-worker'

# 檢查端口
ssh root@165.154.254.99 'netstat -tlnp | grep 8000'

# 測試API
curl http://165.154.254.99:8000/health
```

#### 查看日誌

```bash
# 實時查看日誌
ssh root@165.154.254.99 'tail -f /opt/group-ai/logs/worker.log'

# 或使用systemd日誌
ssh root@165.154.254.99 'journalctl -u group-ai-worker -f'
```

## 常見問題排查

### 問題1: SSH連接失敗

**錯誤**: `Connection refused` 或 `Connection timed out`

**解決方案**:
1. 檢查服務器是否運行
2. 檢查防火牆是否開放22端口
3. 確認IP地址是否正確
4. 嘗試使用內網IP: `10.11.156.159`

### 問題2: 部署腳本執行失敗

**錯誤**: 腳本執行過程中出現錯誤

**解決方案**:
1. 檢查服務器磁盤空間: `df -h`
2. 檢查網絡連接: `ping 8.8.8.8`
3. 查看系統日誌: `journalctl -xe`
4. 手動執行部署步驟

### 問題3: Python依賴安裝失敗

**錯誤**: `pip install` 失敗

**解決方案**:
```bash
# 升級pip
/opt/group-ai/venv/bin/pip install --upgrade pip

# 使用國內鏡像源（如果網絡慢）
/opt/group-ai/venv/bin/pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 問題4: 服務無法啟動

**錯誤**: systemd服務啟動失敗

**解決方案**:
```bash
# 查看詳細錯誤
journalctl -u group-ai-worker -n 50

# 檢查配置文件
cat /opt/group-ai/.env

# 檢查Python環境
/opt/group-ai/venv/bin/python --version

# 手動測試啟動
cd /opt/group-ai
source venv/bin/activate
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 問題5: 端口被佔用

**錯誤**: `Address already in use`

**解決方案**:
```bash
# 查找佔用端口的進程
lsof -i :8000
# 或
netstat -tlnp | grep 8000

# 殺死進程
kill -9 <PID>

# 或修改配置文件中的端口
```

## 安全建議

1. **修改SSH密碼**: 部署完成後，建議修改root密碼
2. **配置SSH密鑰**: 使用SSH密鑰認證，禁用密碼登錄
3. **防火牆規則**: 只開放必要的端口
4. **定期更新**: 定期更新系統和依賴包
5. **備份配置**: 定期備份配置文件和Session文件

## 維護命令

```bash
# 重啟服務
ssh root@165.154.254.99 'systemctl restart group-ai-worker'

# 停止服務
ssh root@165.154.254.99 'systemctl stop group-ai-worker'

# 查看服務狀態
ssh root@165.154.254.99 'systemctl status group-ai-worker'

# 查看資源使用
ssh root@165.154.254.99 'htop'

# 查看磁盤使用
ssh root@165.154.254.99 'df -h'

# 查看內存使用
ssh root@165.154.254.99 'free -h'

# 查看日誌
ssh root@165.154.254.99 'tail -100 /opt/group-ai/logs/worker.log'
```

## 下一步

部署完成後，您可以：

1. **通過前端管理界面管理帳號**
   - 訪問: `http://165.154.254.99:8000`（如果部署了前端）
   - 或通過API管理: `http://165.154.254.99:8000/api/v1/group-ai/accounts`

2. **上傳更多Session文件**
   ```bash
   scp *.session root@165.154.254.99:/opt/group-ai/sessions/
   ```

3. **配置劇本和角色**
   - 上傳劇本文件到: `/opt/group-ai/ai_models/group_scripts/`
   - 通過API或前端界面配置角色分配

4. **監控帳號運行狀態**
   - 查看日誌: `tail -f /opt/group-ai/logs/worker.log`
   - 查看API狀態: `curl http://165.154.254.99:8000/api/v1/group-ai/accounts`

## 相關文檔

- [分散式部署方案](./分散式部署方案.md)
- [群組AI功能使用手冊](../用户手册/群组AI功能使用手册.md)
- [帳號安全運行指南](../使用说明/账号安全运行指南.md)

