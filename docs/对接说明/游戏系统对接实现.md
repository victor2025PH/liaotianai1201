# 游戏系统对接实现说明

> **创建日期**: 2025-11-15  
> **状态**: 已完成基础对接

---

## 对接方案

基于对游戏系统代码的分析，实现了以下对接方案：

### 1. 红包检测方式

#### 方式1：Telegram 按钮检测（主要方法）
- **原理**：检测消息中的内联按钮，查找 `callback_data` 格式为 `hb:grab:{envelope_id}` 的按钮
- **实现位置**：`group_ai_service/redpacket_handler.py` 的 `detect_redpacket()` 方法
- **优点**：准确、实时、无需额外配置
- **缺点**：需要消息包含按钮

#### 方式2：游戏系统数据库查询（推荐）
- **原理**：直接查询游戏系统的 `envelopes` 表，获取活跃红包
- **实现位置**：`group_ai_service/game_api_client.py` 的 `_get_game_status_from_db()` 方法
- **配置**：设置环境变量 `GAME_DATABASE_URL` 或配置 `game_database_url`
- **优点**：可以获取所有活跃红包，不依赖消息
- **缺点**：需要共享数据库或数据库访问权限

#### 方式3：HTTP API 查询（如果游戏系统提供）
- **原理**：通过 HTTP API 查询游戏状态
- **实现位置**：`group_ai_service/game_api_client.py` 的 `get_game_status()` 方法
- **配置**：设置 `game_api_base_url` 和 `game_api_key`
- **优点**：解耦、安全
- **缺点**：需要游戏系统提供 API

### 2. 红包参与方式

#### 方式1：Telegram 按钮点击（主要方法）
- **原理**：通过 Telegram API 发送 CallbackQuery 点击按钮
- **实现位置**：`group_ai_service/redpacket_handler.py` 的 `participate()` 方法
- **callback_data 格式**：`hb:grab:{envelope_id}`
- **注意**：Pyrogram 没有直接的 callback_query 方法，需要使用 aiogram Bot 或通过其他方式

#### 方式2：数据库直接操作（如果允许）
- **原理**：直接调用游戏系统的 `grab_share()` 函数
- **实现位置**：`group_ai_service/game_api_client.py` 的 `_participate_via_database()` 方法
- **配置**：设置 `GAME_SYSTEM_PATH` 环境变量，指向游戏系统代码路径
- **优点**：直接、高效
- **缺点**：需要游戏系统代码在 Python 路径中可用

#### 方式3：HTTP API 参与（如果游戏系统提供）
- **原理**：通过 HTTP API 发送参与请求
- **实现位置**：`group_ai_service/game_api_client.py` 的 `participate_redpacket()` 方法
- **配置**：设置 `game_api_base_url` 和 `game_api_key`

---

## 配置说明

### 环境变量

在 `.env` 文件中添加以下配置：

```bash
# 游戏系统数据库 URL（推荐）
GAME_DATABASE_URL=sqlite:///./path/to/game_system/data.sqlite
# 或 PostgreSQL
# GAME_DATABASE_URL=postgresql://user:password@localhost/game_db

# 游戏系统代码路径（用于导入游戏系统函数）
GAME_SYSTEM_PATH=E:/002-工作文件/重要程序/红包系统机器人/037重新开发新功能

# 游戏系统 HTTP API（可选）
GROUP_AI_GAME_API_BASE_URL=http://localhost:8000
GROUP_AI_GAME_API_KEY=your_api_key
GROUP_AI_GAME_API_ENABLED=true
```

### 配置文件

在 `group_ai_service/config.py` 中已添加以下配置项：

- `game_api_base_url`: 游戏系统 API 基础 URL
- `game_api_key`: API 密钥
- `game_api_timeout`: 请求超时时间
- `game_api_enabled`: 是否启用 API
- `game_database_url`: 游戏系统数据库 URL（新增）
- `game_system_path`: 游戏系统代码路径（新增）

---

## 使用示例

### 1. 通过数据库对接（推荐）

```python
from group_ai_service.config import get_group_ai_config
from group_ai_service.game_api_client import GameAPIClient

config = get_group_ai_config()
client = GameAPIClient(
    database_url="sqlite:///./game_system/data.sqlite"
)

# 查询游戏状态
game_status = await client.get_game_status(group_id=-1001234567890)
for redpacket in game_status.active_redpackets:
    print(f"活跃红包: {redpacket.redpacket_id}, 金额: {redpacket.amount}")
```

### 2. 通过 Telegram 按钮检测

```python
from group_ai_service.redpacket_handler import RedpacketHandler

handler = RedpacketHandler()

# 在消息处理中检测
redpacket = await handler.detect_redpacket(message)
if redpacket:
    print(f"检测到红包: {redpacket.redpacket_id}")
```

### 3. 参与红包

```python
# 通过 Telegram 按钮参与
result = await handler.participate(
    account_id="123456789",
    redpacket=redpacket,
    client=pyrogram_client
)

if result.success:
    print(f"参与成功，获得: {result.amount}")
```

---

## 注意事项

1. **数据库对接**：
   - 需要确保两个系统可以访问同一个数据库，或者有数据库访问权限
   - 建议使用只读权限的数据库用户

2. **Telegram 按钮点击**：
   - Pyrogram 没有直接的 callback_query 方法
   - 如果需要点击按钮，建议使用 aiogram Bot 或通过游戏系统的 HTTP API

3. **游戏系统代码路径**：
   - 如果使用数据库直接操作，需要游戏系统代码在 Python 路径中
   - 设置 `GAME_SYSTEM_PATH` 环境变量，指向游戏系统代码根目录

4. **安全性**：
   - 数据库对接时，建议使用只读权限
   - HTTP API 对接时，使用 API Key 认证
   - 不要在生产环境中暴露敏感信息

---

## 下一步优化

1. **实现 aiogram Bot 集成**：
   - 如果需要点击按钮，可以集成 aiogram Bot
   - 或者通过游戏系统提供的 HTTP API

2. **添加 Webhook 支持**：
   - 如果游戏系统支持 Webhook，可以接收实时事件通知
   - 实现位置：`admin-backend/app/api/group_ai/game_webhook.py`

3. **完善错误处理**：
   - 添加重试机制
   - 添加详细的错误日志
   - 添加监控指标

4. **性能优化**：
   - 添加缓存机制
   - 优化数据库查询
   - 添加连接池

---

## 测试建议

1. **单元测试**：
   - 测试红包检测逻辑
   - 测试数据库查询
   - 测试 API 调用

2. **集成测试**：
   - 测试完整的红包参与流程
   - 测试错误处理
   - 测试并发场景

3. **端到端测试**：
   - 在真实环境中测试
   - 验证红包检测和参与的准确性
   - 验证性能指标

---

**对接完成！** 现在系统可以通过 Telegram API 和游戏系统数据库检测和参与红包了。

