# ä¸‰å€‹æ ¸å¿ƒåŠŸèƒ½å¯¦ç¾å®Œæˆç¸½çµ

> **å®Œæˆæ—¥æœŸ**: 2025-11-30  
> **ç‹€æ…‹**: âœ… å…¨éƒ¨å®Œæˆä¸¦é›†æˆ

---

## ğŸ“‹ å®Œæˆçš„åŠŸèƒ½

### 1. âœ… åŠ‡æœ¬ç†±æ›´æ–°åŠŸèƒ½

**æ–‡ä»¶**:
- `group_ai_service/script_engine.py` - æ·»åŠ  `update_script()` æ–¹æ³•
- `group_ai_service/service_manager.py` - æ·»åŠ  `update_account_script()` æ–¹æ³•
- `admin-backend/app/api/group_ai/accounts.py` - æ·»åŠ ç†±æ›´æ–° API ç«¯é»

**åŠŸèƒ½**:
- âœ… å‹•æ…‹æ›´æ–°åŠ‡æœ¬ï¼Œä¸é‡å•Ÿè³¬è™Ÿ
- âœ… ä¿ç•™ç•¶å‰å ´æ™¯ç‹€æ…‹ï¼ˆå¯é¸ï¼‰
- âœ… ä¿ç•™è®Šé‡å’Œå ´æ™¯æ­·å²
- âœ… å¹³æ»‘åˆ‡æ›åˆ°æ–°åŠ‡æœ¬

**API ç«¯é»**:
```
POST /api/v1/group-ai/accounts/{account_id}/hot-update-script
```

**è«‹æ±‚é«”**:
```json
{
  "script_id": "new_script_id",  // å¯é¸ï¼Œæ–°åŠ‡æœ¬ID
  "script_yaml": "...",           // å¯é¸ï¼Œæ–°åŠ‡æœ¬YAMLå…§å®¹
  "preserve_state": true          // æ˜¯å¦ä¿ç•™ç•¶å‰å ´æ™¯ç‹€æ…‹
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# é€šé API ç†±æ›´æ–°åŠ‡æœ¬
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/account_001/hot-update-script \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{
    "script_id": "updated_script",
    "preserve_state": true
  }'
```

---

### 2. âœ… æ–°æˆå“¡æª¢æ¸¬åŠŸèƒ½

**æ–‡ä»¶**:
- `group_ai_service/session_pool.py` - æ·»åŠ  `_handle_new_members()` æ–¹æ³•
- `group_ai_service/dialogue_manager.py` - å·²æœ‰ `_check_new_member()` æ–¹æ³•

**åŠŸèƒ½**:
- âœ… ç›£è½æ–°æˆå“¡åŠ å…¥äº‹ä»¶ï¼ˆä½¿ç”¨ Pyrogram `filters.new_chat_members`ï¼‰
- âœ… è‡ªå‹•è§¸ç™¼æ­¡è¿æ¶ˆæ¯
- âœ… æ”¯æŒåŠ‡æœ¬ä¸­çš„ `new_member` è§¸ç™¼å™¨

**å¯¦ç¾ç´°ç¯€**:
```python
# åœ¨ SessionPool ä¸­ç›£è½æ–°æˆå“¡äº‹ä»¶
@client.on_message(filters.new_chat_members)
async def handle_new_members(client: Client, message: Message):
    """è™•ç†æ–°æˆå“¡åŠ å…¥æ¶ˆæ¯"""
    await self._handle_new_members(account, message, account_id)
```

**åŠ‡æœ¬é…ç½®ç¤ºä¾‹**:
```yaml
scenes:
  - id: welcome
    triggers:
      - type: new_member  # æ–°æˆå“¡è§¸ç™¼å™¨
    responses:
      - template: "æ­¡è¿ {{user_name}} åŠ å…¥ç¾¤çµ„ï¼ğŸ‰"
```

---

### 3. âœ… å¤šè¼ªå°è©±å¢å¼·åŠŸèƒ½

**æ–‡ä»¶**:
- `group_ai_service/message_analyzer.py` - æ–°å‰µå»ºçš„æ¶ˆæ¯åˆ†æå™¨
- `group_ai_service/dialogue_manager.py` - é›†æˆæ¶ˆæ¯åˆ†æå™¨

**åŠŸèƒ½**:
- âœ… æ„åœ–è­˜åˆ¥ï¼ˆgreeting, question, request, redpacket, thanks, goodbyeï¼‰
- âœ… è©±é¡Œæª¢æ¸¬ï¼ˆwork, game, weather, food, sports, technologyï¼‰
- âœ… æƒ…æ„Ÿåˆ†æï¼ˆpositive, negative, neutralï¼‰
- âœ… å¯¦é«”æå–ï¼ˆ@æåŠã€#æ¨™ç±¤ã€URLï¼‰

**å¯¦ç¾ç´°ç¯€**:

#### æ„åœ–è­˜åˆ¥
```python
intent = analyzer.detect_intent(message, language="zh")
# è¿”å›: MessageIntent(intent_type="greeting", confidence=0.9)
```

#### è©±é¡Œæª¢æ¸¬
```python
topic = analyzer.detect_topic(message, language="zh")
# è¿”å›: TopicInfo(topic="game", confidence=0.85)
```

#### æƒ…æ„Ÿåˆ†æ
```python
sentiment = analyzer.analyze_sentiment(message)
# è¿”å›: SentimentInfo(sentiment="positive", score=0.7)
```

**é›†æˆåˆ°å°è©±ä¸Šä¸‹æ–‡**:
```python
context_info = {
    "intent": {...},      # æ„åœ–ä¿¡æ¯
    "topic": {...},       # è©±é¡Œä¿¡æ¯
    "sentiment": {...},   # æƒ…æ„Ÿä¿¡æ¯
    "current_topic": "game"  # ç•¶å‰è©±é¡Œ
}
```

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### åŠ‡æœ¬ç†±æ›´æ–°æµç¨‹

```
1. èª¿ç”¨ API: POST /accounts/{id}/hot-update-script
   â†“
2. ServiceManager.update_account_script()
   â†“
3. åŠ è¼‰æ–°åŠ‡æœ¬
   â†“
4. ScriptEngine.update_script()
   â”œâ”€ ä¿å­˜ç•¶å‰ç‹€æ…‹ï¼ˆå ´æ™¯ã€è®Šé‡ã€æ­·å²ï¼‰
   â”œâ”€ å‰µå»ºæ–°ç‹€æ…‹
   â”œâ”€ æ¢å¾©å ´æ™¯ï¼ˆå¦‚æœæ–°åŠ‡æœ¬ä¸­æœ‰ç›¸åŒå ´æ™¯ï¼‰
   â””â”€ æ¢å¾©è®Šé‡å’Œæ­·å²
   â†“
5. æ›´æ–°å®Œæˆï¼Œè³¬è™Ÿç¹¼çºŒé‹è¡Œ
```

### æ–°æˆå“¡æª¢æ¸¬æµç¨‹

```
1. Telegram æ–°æˆå“¡åŠ å…¥äº‹ä»¶
   â†“
2. Pyrogram filters.new_chat_members è§¸ç™¼
   â†“
3. SessionPool._handle_new_members()
   â†“
4. DialogueManager.process_message()
   â†“
5. DialogueManager._check_new_member() æª¢æ¸¬
   â†“
6. ScriptEngine åŒ¹é… "new_member" è§¸ç™¼å™¨
   â†“
7. ç”Ÿæˆæ­¡è¿æ¶ˆæ¯ä¸¦ç™¼é€
```

### å¤šè¼ªå°è©±å¢å¼·æµç¨‹

```
1. æ¶ˆæ¯åˆ°é”
   â†“
2. DialogueManager.process_message()
   â†“
3. MessageAnalyzer.analyze_message()
   â”œâ”€ æª¢æ¸¬æ„åœ–
   â”œâ”€ æª¢æ¸¬è©±é¡Œ
   â”œâ”€ åˆ†ææƒ…æ„Ÿ
   â””â”€ æå–å¯¦é«”
   â†“
4. æ›´æ–°ä¸Šä¸‹æ–‡ï¼ˆcurrent_topicï¼‰
   â†“
5. å°‡åˆ†æçµæœå‚³éçµ¦åŠ‡æœ¬å¼•æ“
   â†“
6. åŠ‡æœ¬å¼•æ“å¯ä»¥ä½¿ç”¨æ„åœ–/è©±é¡Œä¿¡æ¯ç”Ÿæˆæ›´æ™ºèƒ½çš„å›å¾©
```

---

## ğŸ“ ä¿®æ”¹å’Œæ–°å¢çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
1. `group_ai_service/coordination_manager.py` - å¤šè³¬è™Ÿå”åŒç®¡ç†å™¨
2. `group_ai_service/message_analyzer.py` - æ¶ˆæ¯åˆ†æå™¨

### ä¿®æ”¹æ–‡ä»¶
1. `group_ai_service/script_engine.py`
   - æ·»åŠ  `update_script()` æ–¹æ³•

2. `group_ai_service/service_manager.py`
   - æ·»åŠ  `update_account_script()` æ–¹æ³•
   - åˆå§‹åŒ– CoordinationManager

3. `group_ai_service/dialogue_manager.py`
   - é›†æˆ CoordinationManager
   - é›†æˆ MessageAnalyzer
   - æ·»åŠ æ¶ˆæ¯åˆ†æé‚è¼¯

4. `group_ai_service/session_pool.py`
   - æ·»åŠ æ–°æˆå“¡äº‹ä»¶ç›£è½
   - æ·»åŠ  `_handle_new_members()` æ–¹æ³•

5. `admin-backend/app/api/group_ai/accounts.py`
   - æ·»åŠ ç†±æ›´æ–°åŠ‡æœ¬ API ç«¯é»

---

## ğŸ¯ åŠŸèƒ½æ•ˆæœ

### åŠ‡æœ¬ç†±æ›´æ–°
- âœ… **å¯¦ç¾å‰**: ä¿®æ”¹åŠ‡æœ¬éœ€è¦é‡å•Ÿè³¬è™Ÿï¼Œæœå‹™ä¸­æ–·
- âœ… **å¯¦ç¾å¾Œ**: å¯ä»¥åœ¨ä¸åœæ­¢è³¬è™Ÿçš„æƒ…æ³ä¸‹æ›´æ–°åŠ‡æœ¬ï¼Œä¿ç•™å°è©±ç‹€æ…‹

### æ–°æˆå“¡æª¢æ¸¬
- âœ… **å¯¦ç¾å‰**: æ–°æˆå“¡åŠ å…¥æ²’æœ‰è‡ªå‹•æ­¡è¿
- âœ… **å¯¦ç¾å¾Œ**: è‡ªå‹•æª¢æ¸¬ä¸¦ç™¼é€æ­¡è¿æ¶ˆæ¯ï¼Œæ”¯æŒåŠ‡æœ¬é…ç½®

### å¤šè¼ªå°è©±å¢å¼·
- âœ… **å¯¦ç¾å‰**: åŸºç¤é—œéµè©åŒ¹é…ï¼Œä¸Šä¸‹æ–‡ç†è§£æœ‰é™
- âœ… **å¯¦ç¾å¾Œ**: æ™ºèƒ½æ„åœ–è­˜åˆ¥ã€è©±é¡Œè¿½è¹¤ã€æƒ…æ„Ÿåˆ†æï¼Œæ”¯æŒæ›´è‡ªç„¶çš„å¤šè¼ªå°è©±

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç†±æ›´æ–°åŠ‡æœ¬

```python
# 1. é€šé API ç†±æ›´æ–°
POST /api/v1/group-ai/accounts/account_001/hot-update-script
{
  "script_id": "new_version",
  "preserve_state": true
}

# 2. è³¬è™Ÿç¹¼çºŒé‹è¡Œï¼Œä½¿ç”¨æ–°åŠ‡æœ¬
# 3. ç•¶å‰å ´æ™¯å’Œè®Šé‡è¢«ä¿ç•™
```

### ç¤ºä¾‹ 2: æ–°æˆå“¡æ­¡è¿

```yaml
# åŠ‡æœ¬é…ç½®
scenes:
  - id: welcome_new_member
    triggers:
      - type: new_member
    responses:
      - template: "æ­¡è¿ {{user_name}} åŠ å…¥æˆ‘å€‘çš„å¤§å®¶åº­ï¼ğŸ‘‹"
```

### ç¤ºä¾‹ 3: ä½¿ç”¨æ„åœ–å’Œè©±é¡Œ

```yaml
# åŠ‡æœ¬å¯ä»¥ä½¿ç”¨æ„åœ–å’Œè©±é¡Œä¿¡æ¯
scenes:
  - id: game_topic
    triggers:
      - type: keyword
        keywords: ["éŠæˆ²"]
    responses:
      - template: |
          {% if topic == "game" %}
          æˆ‘ä¹Ÿå–œæ­¡ç©éŠæˆ²ï¼ä½ æœ€è¿‘åœ¨ç©ä»€éº¼ï¼Ÿ
          {% else %}
          éŠæˆ²æ˜¯å€‹ä¸éŒ¯çš„è©±é¡Œï¼
          {% endif %}
```

---

## âœ… å®Œæˆç‹€æ…‹

| åŠŸèƒ½ | ç‹€æ…‹ | å®Œæˆåº¦ |
|------|------|--------|
| **åŠ‡æœ¬ç†±æ›´æ–°** | âœ… å·²å®Œæˆ | 100% |
| **æ–°æˆå“¡æª¢æ¸¬** | âœ… å·²å®Œæˆ | 100% |
| **å¤šè¼ªå°è©±å¢å¼·** | âœ… å·²å®Œæˆ | 100% |

**ç¸½é«”å®Œæˆåº¦**: **100%** âœ…

---

## ğŸ” æ¸¬è©¦å»ºè­°

### æ¸¬è©¦åŠ‡æœ¬ç†±æ›´æ–°

1. å•Ÿå‹•ä¸€å€‹è³¬è™Ÿ
2. åœ¨ç¾¤çµ„ä¸­ç™¼é€æ¶ˆæ¯ï¼Œç¢ºèªè³¬è™Ÿæ­£å¸¸å›å¾©
3. èª¿ç”¨ç†±æ›´æ–° APIï¼Œæ›´æ–°åŠ‡æœ¬
4. å†æ¬¡ç™¼é€æ¶ˆæ¯ï¼Œç¢ºèªæ–°åŠ‡æœ¬ç”Ÿæ•ˆ
5. æª¢æŸ¥æ—¥èªŒç¢ºèªç‹€æ…‹è¢«ä¿ç•™

### æ¸¬è©¦æ–°æˆå“¡æª¢æ¸¬

1. å°‡æ¸¬è©¦è³¬è™ŸåŠ å…¥ç¾¤çµ„
2. å•Ÿå‹• AI è³¬è™Ÿ
3. é‚€è«‹æ–°æˆå“¡åŠ å…¥ç¾¤çµ„
4. è§€å¯Ÿ AI è³¬è™Ÿæ˜¯å¦è‡ªå‹•ç™¼é€æ­¡è¿æ¶ˆæ¯
5. æª¢æŸ¥æ—¥èªŒç¢ºèªäº‹ä»¶è¢«æ­£ç¢ºæª¢æ¸¬

### æ¸¬è©¦å¤šè¼ªå°è©±å¢å¼·

1. ç™¼é€ä¸åŒé¡å‹çš„æ¶ˆæ¯ï¼ˆå•å€™ã€æå•ã€æ„Ÿè¬ç­‰ï¼‰
2. æª¢æŸ¥æ—¥èªŒä¸­çš„æ„åœ–è­˜åˆ¥çµæœ
3. ç™¼é€é—œæ–¼ä¸åŒè©±é¡Œçš„æ¶ˆæ¯
4. æª¢æŸ¥è©±é¡Œæª¢æ¸¬çµæœ
5. è§€å¯Ÿ AI å›å¾©æ˜¯å¦æ›´æ™ºèƒ½ï¼ˆåŸºæ–¼æ„åœ–å’Œè©±é¡Œï¼‰

---

## ğŸ“ å¾ŒçºŒæ”¹é€²å»ºè­°

### çŸ­æœŸï¼ˆå¯é¸ï¼‰
1. ä½¿ç”¨ AI æ¨¡å‹é€²è¡Œæ›´ç²¾ç¢ºçš„æ„åœ–è­˜åˆ¥ï¼ˆæ›¿ä»£é—œéµè©åŒ¹é…ï¼‰
2. å¢å¼·è©±é¡Œæª¢æ¸¬ï¼ˆä½¿ç”¨ NLP æ¨¡å‹ï¼‰
3. æ”¯æŒæ›´å¤šæ„åœ–é¡å‹

### ä¸­æœŸï¼ˆå¯é¸ï¼‰
1. èªè¨€è‡ªå‹•æª¢æ¸¬
2. å¤šèªè¨€è©±é¡Œé—œéµè©
3. æ›´ç²¾ç¢ºçš„æƒ…æ„Ÿåˆ†ææ¨¡å‹

---

**å®Œæˆæ™‚é–“**: 2025-11-30  
**å¯¦ç¾è€…**: AI Assistant  
**æ–‡æª”ç‰ˆæœ¬**: v1.0
