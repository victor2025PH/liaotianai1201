name: Deploy Three Sites

on:
  push:
    branches:
      - main
    paths:
      - 'tgmini20251220/**'
      - 'hbwy20251220/**'
      - 'aizkw20251219/**'
      - '.github/workflows/deploy-three-sites.yml'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'éƒ¨ç½²æ‰€æœ‰ä¸‰ä¸ªç½‘ç«™'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        site:
          - name: tgmini
            dir: tgmini20251220
            domain: tgmini.usdt2026.cc
            port: 3001
            pm2_name: tgmini-frontend
          - name: hongbao
            dir: hbwy20251220
            domain: hongbao.usdt2026.cc
            port: 3002
            pm2_name: hongbao-frontend
          - name: aizkw
            dir: aizkw20251219
            domain: aikz.usdt2026.cc
            port: 3003
            pm2_name: aizkw-frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ${{ matrix.site.name }} to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            SITE_NAME="${{ matrix.site.name }}"
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            SITE_DIR="$PROJECT_DIR/${{ matrix.site.dir }}"
            DOMAIN="${{ matrix.site.domain }}"
            PORT="${{ matrix.site.port }}"
            PM2_NAME="${{ matrix.site.pm2_name }}"
            
            echo "=========================================="
            echo "ğŸš€ éƒ¨ç½² $SITE_NAME"
            echo "åŸŸå: $DOMAIN"
            echo "ç«¯å£: $PORT"
            echo "ç›®å½•: $SITE_DIR"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""
            
            # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
            cd "$PROJECT_DIR" || {
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ [1/6] æ‹‰å–æœ€æ–°ä»£ç ..."
            echo "----------------------------------------"
            
            # ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âš ï¸  é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "âŒ Git clone å¤±è´¥"
                exit 1
              }
            else
              cd "$PROJECT_DIR"
              git fetch origin main || git fetch origin || true
              git reset --hard origin/main || git pull origin main || {
                echo "âš ï¸  Git pull å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
              }
            fi
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
            echo ""
            
            # æ£€æŸ¥ç«™ç‚¹ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$SITE_DIR" ]; then
              echo "âŒ ç«™ç‚¹ç›®å½•ä¸å­˜åœ¨: $SITE_DIR"
              echo "å½“å‰é¡¹ç›®ç›®å½•å†…å®¹:"
              ls -la "$PROJECT_DIR" | head -20
              exit 1
            fi
            
            # è¿›å…¥ç«™ç‚¹ç›®å½•
            cd "$SITE_DIR" || {
              echo "âŒ æ— æ³•è¿›å…¥ç«™ç‚¹ç›®å½•: $SITE_DIR"
              exit 1
            }
            
            # æ£€æŸ¥ package.json
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "âœ… æ‰¾åˆ° package.json"
            echo ""
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ [2/6] å®‰è£…ä¾èµ–..."
            echo "----------------------------------------"
            npm install || {
              echo "âŒ npm install å¤±è´¥"
              exit 1
            }
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            echo ""
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ [3/6] æ„å»ºé¡¹ç›®..."
            echo "----------------------------------------"
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "âŒ npm run build å¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºè¾“å‡º
            if [ ! -d "dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
              exit 1
            fi
            echo "âœ… æ„å»ºå®Œæˆ"
            echo ""
            
            # åœæ­¢æ—§è¿›ç¨‹
            echo "ğŸ›‘ [4/6] åœæ­¢æ—§è¿›ç¨‹..."
            echo "----------------------------------------"
            pm2 delete "$PM2_NAME" 2>/dev/null || true
            
            # åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
            if sudo lsof -i :$PORT >/dev/null 2>&1; then
              echo "åœæ­¢å ç”¨ç«¯å£ $PORT çš„è¿›ç¨‹..."
              sudo lsof -ti :$PORT | xargs sudo kill -9 2>/dev/null || true
              sleep 2
            fi
            echo "âœ… æ—§è¿›ç¨‹å·²åœæ­¢"
            echo ""
            
            # å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨ serve æˆ– vite previewï¼‰
            echo "ğŸš€ [5/6] å¯åŠ¨æœåŠ¡..."
            echo "----------------------------------------"
            
            # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
            mkdir -p "$PROJECT_DIR/logs"
            
            # ç¡®è®¤å½“å‰ç›®å½•å’Œ dist æ–‡ä»¶å¤¹
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo "æ£€æŸ¥ dist ç›®å½•..."
            if [ ! -d "$SITE_DIR/dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨: $SITE_DIR/dist"
              echo "å½“å‰ç›®å½•å†…å®¹:"
              ls -la "$SITE_DIR" | head -20
              exit 1
            fi
            echo "âœ… dist ç›®å½•å­˜åœ¨: $SITE_DIR/dist"
            echo "dist ç›®å½•å¤§å°: $(du -sh $SITE_DIR/dist | cut -f1)"
            
            # æ£€æŸ¥å¹¶å®‰è£… PM2
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "å®‰è£… PM2..."
              sudo npm install -g pm2
              pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            fi
            
            # å®‰è£… serveï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            if ! command -v serve >/dev/null 2>&1; then
              echo "å®‰è£… serve..."
              sudo npm install -g serve
            fi
            
            # è¿›å…¥ç«™ç‚¹ç›®å½•
            cd "$SITE_DIR" || {
              echo "âŒ æ— æ³•è¿›å…¥ç«™ç‚¹ç›®å½•: $SITE_DIR"
              exit 1
            }
            
            # ç”Ÿæˆå¯åŠ¨è„šæœ¬ï¼ˆä½¿ç”¨å…¨å±€ serveï¼Œä¸ç»è¿‡ npxï¼‰
            echo "ç”Ÿæˆå¯åŠ¨è„šæœ¬..."
            START_SCRIPT="$SITE_DIR/start-frontend.sh"
            printf '#!/bin/bash\n# å‰ç«¯æœåŠ¡å¯åŠ¨è„šæœ¬\n# ä½¿ç”¨å…¨å±€ serve å‘½ä»¤å¯åŠ¨é™æ€æ–‡ä»¶æœåŠ¡\n# è·å–å‚æ•°\nDIST_DIR="$1"\nPORT="$2"\n# å¯åŠ¨ serve\nexec serve -s "$DIST_DIR" -l "$PORT" --no-clipboard --no-open\n' > "$START_SCRIPT"
            
            chmod +x "$START_SCRIPT"
            echo "âœ… å¯åŠ¨è„šæœ¬å·²ç”Ÿæˆ: $START_SCRIPT"
            echo "å¯åŠ¨è„šæœ¬å†…å®¹:"
            cat "$START_SCRIPT"
            echo ""
            
            # ä½¿ç”¨ PM2 å¯åŠ¨è„šæœ¬
            echo "ä½¿ç”¨ PM2 å¯åŠ¨å‰ç«¯æœåŠ¡..."
            pm2 start "$START_SCRIPT" \
              --name "$PM2_NAME" \
              -- "$SITE_DIR/dist" "$PORT" \
              --error "$PROJECT_DIR/logs/${SITE_NAME}-error.log" \
              --output "$PROJECT_DIR/logs/${SITE_NAME}-out.log" \
              --merge-logs \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
              echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯..."
              pm2 logs "$PM2_NAME" --lines 50 --nostream 2>/dev/null || true
              echo "æŸ¥çœ‹ PM2 è¿›ç¨‹çŠ¶æ€:"
              pm2 list || true
              exit 1
            }
            
            pm2 save || true
            echo "âœ… æœåŠ¡å·²å¯åŠ¨"
            echo ""
            
            # ç­‰å¾…å¯åŠ¨ï¼ˆå»¶é•¿ç­‰å¾…æ—¶é—´ï¼Œç»™ Node.js åº”ç”¨æ›´å¤šå¯åŠ¨æ—¶é—´ï¼‰
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if sudo lsof -i :$PORT >/dev/null 2>&1; then
              echo "âœ… ç«¯å£ $PORT æ­£åœ¨ç›‘å¬"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$PORT || echo "000")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "âœ… æœåŠ¡å“åº”æ­£å¸¸ (HTTP $HTTP_CODE)"
              else
                echo "âš ï¸  æœåŠ¡å“åº”å¼‚å¸¸ (HTTP $HTTP_CODE)"
              fi
            else
              echo "âŒ ç«¯å£ $PORT æœªåœ¨ç›‘å¬ï¼Œåº”ç”¨å¯èƒ½æœªæˆåŠŸå¯åŠ¨"
              echo "=========================================="
              echo "ğŸ” è¯¦ç»†é”™è¯¯è¯Šæ–­..."
              echo "=========================================="
              echo "PM2 è¿›ç¨‹çŠ¶æ€:"
              pm2 list || true
              echo ""
              echo "PM2 è¿›ç¨‹è¯¦æƒ…:"
              pm2 describe "$PM2_NAME" || true
              echo ""
              echo "PM2 æœ€æ–°æ—¥å¿— (æœ€å 50 è¡Œ):"
              pm2 logs "$PM2_NAME" --lines 50 --nostream 2>/dev/null || true
              echo ""
              echo "æ£€æŸ¥è¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ:"
              ps aux | grep -E "serve|$PM2_NAME" | grep -v grep || true
              echo ""
              echo "æ£€æŸ¥ç«¯å£å ç”¨:"
              sudo lsof -i :$PORT || echo "ç«¯å£æœªè¢«å ç”¨"
              echo ""
              echo "æŸ¥çœ‹é”™è¯¯æ—¥å¿—æ–‡ä»¶:"
              tail -50 "$PROJECT_DIR/logs/${SITE_NAME}-error.log" 2>/dev/null || echo "é”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
              echo ""
              echo "æŸ¥çœ‹è¾“å‡ºæ—¥å¿—æ–‡ä»¶:"
              tail -50 "$PROJECT_DIR/logs/${SITE_NAME}-out.log" 2>/dev/null || echo "è¾“å‡ºæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            echo ""
            
            # é…ç½® Nginx
            echo "ğŸŒ [6/6] é…ç½® Nginx..."
            echo "----------------------------------------"
            
            # åˆ›å»º Nginx é…ç½®
            NGINX_CONFIG="/tmp/${SITE_NAME}.conf"
            
            # æ£€æŸ¥ SSL è¯ä¹¦æ˜¯å¦å­˜åœ¨
            SSL_CERT="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
            SSL_KEY="/etc/letsencrypt/live/$DOMAIN/privkey.pem"
            
            if [ -f "$SSL_CERT" ] && [ -f "$SSL_KEY" ]; then
              # SSL è¯ä¹¦å­˜åœ¨ï¼Œé…ç½® HTTPSï¼ˆä½¿ç”¨ printf é¿å… YAML è§£æé—®é¢˜ï¼‰
              printf '# HTTP to HTTPS redirect\nserver {\n    listen 80;\n    server_name %s;\n    \n    # Let'\''s Encrypt éªŒè¯è·¯å¾„\n    location /.well-known/acme-challenge/ {\n        root /var/www/html;\n    }\n    \n    # é‡å®šå‘æ‰€æœ‰ HTTP è¯·æ±‚åˆ° HTTPS\n    location / {\n        return 301 https://$server_name$request_uri;\n    }\n}\n\n# HTTPS server\nserver {\n    listen 443 ssl http2;\n    server_name %s;\n\n    # SSL è¯ä¹¦é…ç½®ï¼ˆç”± Certbot è‡ªåŠ¨ç®¡ç†ï¼‰\n    ssl_certificate /etc/letsencrypt/live/%s/fullchain.pem;\n    ssl_certificate_key /etc/letsencrypt/live/%s/privkey.pem;\n    \n    # SSL å®‰å…¨é…ç½®\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers '\''ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384'\'';\n    ssl_prefer_server_ciphers off;\n    ssl_session_cache shared:SSL:10m;\n    ssl_session_timeout 10m;\n    \n    # å®‰å…¨å¤´\n    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;\n    add_header X-Frame-Options "SAMEORIGIN" always;\n    add_header X-Content-Type-Options "nosniff" always;\n    add_header X-XSS-Protection "1; mode=block" always;\n\n    client_max_body_size 50M;\n\n    # å‰ç«¯åº”ç”¨\n    location / {\n        proxy_pass http://127.0.0.1:%s;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n        proxy_read_timeout 86400;\n    }\n}\n' "$DOMAIN" "$DOMAIN" "$DOMAIN" "$DOMAIN" "$PORT" > "$NGINX_CONFIG"
            else
              # SSL è¯ä¹¦ä¸å­˜åœ¨ï¼Œåªé…ç½® HTTPï¼ˆä½¿ç”¨ printf é¿å… YAML è§£æé—®é¢˜ï¼‰
              echo "âš ï¸  SSL è¯ä¹¦ä¸å­˜åœ¨ï¼Œé…ç½® HTTP only"
              printf '# HTTP server (SSL certificate not found)\nserver {\n    listen 80;\n    server_name %s;\n\n    client_max_body_size 50M;\n\n    location / {\n        proxy_pass http://127.0.0.1:%s;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection "upgrade";\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_cache_bypass $http_upgrade;\n        proxy_read_timeout 86400;\n    }\n}\n' "$DOMAIN" "$PORT" > "$NGINX_CONFIG"
            fi
            
            # å¤åˆ¶é…ç½®åˆ° Nginx
            sudo cp "$NGINX_CONFIG" "/etc/nginx/sites-available/$DOMAIN"
            
            # åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if [ ! -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
              sudo ln -s "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
            fi
            
            # æ£€æŸ¥ Nginx æ˜¯å¦å®‰è£…
            if ! command -v nginx >/dev/null 2>&1; then
              echo "âš ï¸  Nginx æœªå®‰è£…ï¼Œå®‰è£… Nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # æ£€æŸ¥ Nginx æœåŠ¡çŠ¶æ€
            if ! sudo systemctl is-active --quiet nginx; then
              echo "âš ï¸  Nginx æœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨ Nginx..."
              sudo systemctl enable nginx
              sudo systemctl start nginx || {
                echo "âŒ Nginx å¯åŠ¨å¤±è´¥"
                exit 1
              }
            fi
            
            # æµ‹è¯• Nginx é…ç½®
            sudo nginx -t || {
              echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
              exit 1
            }
            
            # é‡è½½ Nginx
            sudo systemctl reload nginx || {
              echo "âš ï¸  Nginx reload å¤±è´¥ï¼Œå°è¯• restart..."
              sudo systemctl restart nginx || {
                echo "âŒ Nginx restart å¤±è´¥"
                exit 1
              }
            }
            
            echo "âœ… Nginx é…ç½®å®Œæˆ"
            echo ""
            
            # éªŒè¯éƒ¨ç½²
            echo "ğŸ” éªŒè¯éƒ¨ç½²..."
            echo "----------------------------------------"
            pm2 list | grep "$PM2_NAME" || true
            echo ""
            
            echo "=========================================="
            echo "âœ… $SITE_NAME éƒ¨ç½²å®Œæˆï¼"
            echo "åŸŸå: https://$DOMAIN"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
