# å‘Šè­¦è§„åˆ™é›†æˆå®ŒæˆæŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2025-01-17  
> **é›†æˆçŠ¶æ€**: âœ… å·²å®Œæˆ  
> **æŠ¥å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ“Š å®Œæˆæ¦‚è¿°

### é›†æˆç»“æœ

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è§„åˆ™è¯„ä¼°é€»è¾‘ | âœ… å®Œæˆ | æ”¯æŒ 4 ç§è§„åˆ™ç±»å‹ |
| ç›‘æ§æœåŠ¡é›†æˆ | âœ… å®Œæˆ | `check_alerts()` æ”¯æŒè§„åˆ™å‚æ•° |
| API é›†æˆ | âœ… å®Œæˆ | å‘Šè­¦æ£€æŸ¥ç«¯ç‚¹å·²é›†æˆ |
| å‘åå…¼å®¹ | âœ… å®Œæˆ | ä¿ç•™é»˜è®¤ç¡¬ç¼–ç è§„åˆ™ |

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ä¿®æ”¹ç›‘æ§æœåŠ¡

**æ–‡ä»¶**: `group_ai_service/monitor_service.py`

**æ”¹è¿›**:

1. **`check_alerts()` æ–¹æ³•**
   - æ·»åŠ  `alert_rules` å‚æ•°ï¼ˆå¯é€‰ï¼‰
   - å¦‚æœæä¾›è§„åˆ™ï¼Œä½¿ç”¨è§„åˆ™è¿›è¡Œæ£€æŸ¥
   - å¦‚æœæ²¡æœ‰è§„åˆ™ï¼Œä½¿ç”¨é»˜è®¤ç¡¬ç¼–ç è§„åˆ™ï¼ˆå‘åå…¼å®¹ï¼‰

2. **æ–°å¢æ–¹æ³•**:
   - `_evaluate_rule()`: è¯„ä¼°å•ä¸ªå‘Šè­¦è§„åˆ™
   - `_compare_values()`: æ¯”è¾ƒå®é™…å€¼å’Œé˜ˆå€¼ï¼ˆæ”¯æŒ 6 ç§è¿ç®—ç¬¦ï¼‰
   - `_generate_alert_message()`: ç”Ÿæˆå‘Šè­¦æ¶ˆæ¯
   - `_check_default_rules()`: æ£€æŸ¥é»˜è®¤ç¡¬ç¼–ç è§„åˆ™ï¼ˆå‘åå…¼å®¹ï¼‰

3. **æ”¯æŒçš„è§„åˆ™ç±»å‹**:
   - `error_rate`: é”™è¯¯ç‡å‘Šè­¦
   - `system_errors`: ç³»ç»Ÿé”™è¯¯æ•°å‘Šè­¦
   - `response_time`: å“åº”æ—¶é—´å‘Šè­¦
   - `account_offline`: è´¦å·ç¦»çº¿å‘Šè­¦

4. **æ”¯æŒçš„æ¯”è¾ƒè¿ç®—ç¬¦**:
   - `>`: å¤§äº
   - `>=`: å¤§äºç­‰äº
   - `<`: å°äº
   - `<=`: å°äºç­‰äº
   - `==`: ç­‰äº
   - `!=`: ä¸ç­‰äº

---

### 2. ä¿®æ”¹ç›‘æ§ API

**æ–‡ä»¶**: `admin-backend/app/api/group_ai/monitor.py`

**æ”¹è¿›**:

1. **`get_alerts()` ç«¯ç‚¹**
   - æ·»åŠ  `check_rules` æŸ¥è¯¢å‚æ•°ï¼ˆå¯é€‰ï¼‰
   - å¦‚æœ `check_rules=true`ï¼Œå…ˆæ‰§è¡Œå‘Šè­¦è§„åˆ™æ£€æŸ¥
   - ä»æ•°æ®åº“è¯»å–å¯ç”¨çš„å‘Šè­¦è§„åˆ™
   - ä¼ é€’ç»™ç›‘æ§æœåŠ¡è¿›è¡Œæ£€æŸ¥

2. **æ–°å¢ç«¯ç‚¹**: `POST /api/v1/group-ai/monitor/alerts/check`
   - æ‰‹åŠ¨è§¦å‘å‘Šè­¦è§„åˆ™æ£€æŸ¥
   - è¿”å›æ£€æŸ¥ç»“æœå’Œæ–°å‘Šè­¦åˆ—è¡¨
   - æ”¯æŒä½¿ç”¨æ•°æ®åº“è§„åˆ™æˆ–é»˜è®¤è§„åˆ™

---

## ğŸ”§ ä½¿ç”¨æ–¹å¼

### 1. åˆ›å»ºå‘Šè­¦è§„åˆ™

```bash
POST /api/v1/group-ai/alert-rules/
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "è´¦å·é”™è¯¯ç‡è­¦å‘Š",
  "rule_type": "error_rate",
  "alert_level": "warning",
  "threshold_value": 0.2,
  "threshold_operator": ">",
  "enabled": true,
  "notification_method": "email",
  "notification_target": "admin@example.com",
  "description": "å½“è´¦å·é”™è¯¯ç‡è¶…è¿‡ 20% æ—¶å‘é€è­¦å‘Š"
}
```

### 2. æ‰‹åŠ¨è§¦å‘å‘Šè­¦æ£€æŸ¥

```bash
POST /api/v1/group-ai/monitor/alerts/check
Authorization: Bearer <token>
```

**å“åº”**:
```json
{
  "message": "å‘Šè­¦è¦å‰‡æª¢æŸ¥å®Œæˆ",
  "rules_checked": 3,
  "new_alerts": 1,
  "alerts": [
    {
      "alert_id": "error_rate_xxx_1234567890",
      "alert_type": "warning",
      "account_id": "account_123",
      "message": "è³¬è™Ÿ account_123: è´¦å·é”™è¯¯ç‡è­¦å‘Š - ç•¶å‰å€¼ 0.25 > é–¾å€¼ 0.2",
      "timestamp": "2025-01-17T12:00:00"
    }
  ]
}
```

### 3. è·å–å‘Šè­¦åˆ—è¡¨ï¼ˆå¸¦æ£€æŸ¥ï¼‰

```bash
GET /api/v1/group-ai/monitor/alerts?check_rules=true&limit=50
Authorization: Bearer <token>
```

**æŸ¥è¯¢å‚æ•°**:
- `check_rules=true`: æ‰§è¡Œå‘Šè­¦è§„åˆ™æ£€æŸ¥
- `limit`: è¿”å›æ•°é‡
- `alert_type`: å‘Šè­¦ç±»å‹ç­›é€‰
- `resolved`: æ˜¯å¦å·²è§£å†³ç­›é€‰

---

## ğŸ“‹ æ”¯æŒçš„è§„åˆ™ç±»å‹

### 1. error_rateï¼ˆé”™è¯¯ç‡å‘Šè­¦ï¼‰

**è¯´æ˜**: æ£€æŸ¥è´¦å·é”™è¯¯ç‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼

**é…ç½®ç¤ºä¾‹**:
```json
{
  "name": "è´¦å·é”™è¯¯ç‡è­¦å‘Š",
  "rule_type": "error_rate",
  "threshold_value": 0.2,
  "threshold_operator": ">",
  "alert_level": "warning"
}
```

**è®¡ç®—æ–¹å¼**: `error_count / (message_count + reply_count + redpacket_count)`

### 2. system_errorsï¼ˆç³»ç»Ÿé”™è¯¯æ•°å‘Šè­¦ï¼‰

**è¯´æ˜**: æ£€æŸ¥ç³»ç»Ÿæ€»é”™è¯¯æ•°æ˜¯å¦è¶…è¿‡é˜ˆå€¼

**é…ç½®ç¤ºä¾‹**:
```json
{
  "name": "ç³»ç»Ÿé”™è¯¯æ•°å‘Šè­¦",
  "rule_type": "system_errors",
  "threshold_value": 100,
  "threshold_operator": ">",
  "alert_level": "error"
}
```

**è®¡ç®—æ–¹å¼**: `system_metrics.total_errors`

### 3. response_timeï¼ˆå“åº”æ—¶é—´å‘Šè­¦ï¼‰

**è¯´æ˜**: æ£€æŸ¥å¹³å‡å“åº”æ—¶é—´æ˜¯å¦è¶…è¿‡é˜ˆå€¼

**é…ç½®ç¤ºä¾‹**:
```json
{
  "name": "å“åº”æ—¶é—´å‘Šè­¦",
  "rule_type": "response_time",
  "threshold_value": 2000,
  "threshold_operator": ">",
  "alert_level": "warning"
}
```

**è®¡ç®—æ–¹å¼**: `system_metrics.average_reply_time * 1000`ï¼ˆæ¯«ç§’ï¼‰

### 4. account_offlineï¼ˆè´¦å·ç¦»çº¿å‘Šè­¦ï¼‰

**è¯´æ˜**: æ£€æŸ¥è´¦å·ç¦»çº¿ç‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼

**é…ç½®ç¤ºä¾‹**:
```json
{
  "name": "è´¦å·ç¦»çº¿ç‡å‘Šè­¦",
  "rule_type": "account_offline",
  "threshold_value": 30.0,
  "threshold_operator": ">",
  "alert_level": "warning"
}
```

**è®¡ç®—æ–¹å¼**: `(1.0 - online_rate) * 100`ï¼ˆç™¾åˆ†æ¯”ï¼‰

---

## ğŸ”„ å‘åå…¼å®¹

### é»˜è®¤è§„åˆ™

å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰å¯ç”¨çš„å‘Šè­¦è§„åˆ™ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤ç¡¬ç¼–ç è§„åˆ™ï¼š

1. **è´¦å·é”™è¯¯ç‡ > 50%**: é”™è¯¯çº§åˆ«å‘Šè­¦
2. **è´¦å·é”™è¯¯ç‡ > 20%**: è­¦å‘Šçº§åˆ«å‘Šè­¦
3. **ç³»ç»Ÿé”™è¯¯æ•° > 100**: é”™è¯¯çº§åˆ«å‘Šè­¦

### å…¼å®¹æ–¹å¼

- `check_alerts()` æ–¹æ³•ï¼šå¦‚æœ `alert_rules=None`ï¼Œä½¿ç”¨é»˜è®¤è§„åˆ™
- API ç«¯ç‚¹ï¼šå¦‚æœæ²¡æœ‰å¯ç”¨çš„è§„åˆ™ï¼Œè‡ªåŠ¨å›é€€åˆ°é»˜è®¤è§„åˆ™

---

## âš ï¸ å¾…å®Œæˆçš„å·¥ä½œ

### 1. é€šçŸ¥å‘é€åŠŸèƒ½

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
**å·¥ä½œé‡**: 2-3 å°æ—¶

**ä»»åŠ¡**:
- å®ç° Email é€šçŸ¥å‘é€
- å®ç° Webhook é€šçŸ¥å‘é€
- å®ç° Telegram é€šçŸ¥å‘é€
- åœ¨è§„åˆ™è§¦å‘æ—¶è°ƒç”¨é€šçŸ¥å‘é€

**æ–‡ä»¶**: 
- `admin-backend/app/services/notification.py`ï¼ˆæ–°å»ºï¼‰

---

### 2. å®šæ—¶å‘Šè­¦æ£€æŸ¥

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
**å·¥ä½œé‡**: 1-2 å°æ—¶

**ä»»åŠ¡**:
- æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆä½¿ç”¨ Celery æˆ– APSchedulerï¼‰
- å®šæœŸæ‰§è¡Œå‘Šè­¦è§„åˆ™æ£€æŸ¥
- è‡ªåŠ¨å‘é€é€šçŸ¥

---

### 3. è§„åˆ™æ¡ä»¶æ‰©å±•

**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½  
**å·¥ä½œé‡**: 3-5 å°æ—¶

**ä»»åŠ¡**:
- æ”¯æŒæ›´å¤æ‚çš„è§„åˆ™æ¡ä»¶ï¼ˆJSON æ ¼å¼ï¼‰
- æ”¯æŒå¤šä¸ªæ¡ä»¶çš„ç»„åˆï¼ˆANDã€ORï¼‰
- æ”¯æŒæ—¶é—´çª—å£æ¡ä»¶ï¼ˆå¦‚ï¼š5 åˆ†é’Ÿå†…è§¦å‘ 3 æ¬¡ï¼‰

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶

1. `group_ai_service/monitor_service.py`
   - ä¿®æ”¹ `check_alerts()` æ–¹æ³•
   - æ–°å¢è§„åˆ™è¯„ä¼°æ–¹æ³•
   - ä¿ç•™å‘åå…¼å®¹

2. `admin-backend/app/api/group_ai/monitor.py`
   - ä¿®æ”¹ `get_alerts()` ç«¯ç‚¹
   - æ–°å¢ `check_alerts()` ç«¯ç‚¹

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´æµç¨‹

1. **åˆ›å»ºå‘Šè­¦è§„åˆ™**
   ```bash
   POST /api/v1/group-ai/alert-rules/
   ```

2. **è§¦å‘å‘Šè­¦æ£€æŸ¥**
   ```bash
   POST /api/v1/group-ai/monitor/alerts/check
   ```

3. **æŸ¥çœ‹å‘Šè­¦åˆ—è¡¨**
   ```bash
   GET /api/v1/group-ai/monitor/alerts?check_rules=true
   ```

4. **è§£å†³å‘Šè­¦**
   ```bash
   POST /api/v1/group-ai/monitor/alerts/{alert_id}/resolve
   ```

---

## âœ… æˆåŠŸè¦ç‚¹

1. **çµæ´»çš„è§„åˆ™ç³»ç»Ÿ**
   - æ”¯æŒå¤šç§è§„åˆ™ç±»å‹
   - æ”¯æŒå¤šç§æ¯”è¾ƒè¿ç®—ç¬¦
   - æ”¯æŒè‡ªå®šä¹‰é˜ˆå€¼

2. **å‘åå…¼å®¹**
   - ä¿ç•™é»˜è®¤ç¡¬ç¼–ç è§„åˆ™
   - å¹³æ»‘è¿‡æ¸¡åˆ°è§„åˆ™ç³»ç»Ÿ
   - ä¸å½±å“ç°æœ‰åŠŸèƒ½

3. **æ˜“äºæ‰©å±•**
   - å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è§„åˆ™ç±»å‹
   - è§„åˆ™è¯„ä¼°é€»è¾‘æ¸…æ™°
   - ä»£ç ç»“æ„è‰¯å¥½

---

## ğŸ“Š æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```python
# æµ‹è¯•è§„åˆ™è¯„ä¼°
def test_evaluate_error_rate_rule():
    # åˆ›å»ºè§„åˆ™
    rule = GroupAIAlertRule(
        rule_type="error_rate",
        threshold_value=0.2,
        threshold_operator=">",
        enabled=True
    )
    
    # åˆ›å»ºç›‘æ§æœåŠ¡
    service = MonitorService()
    # è®°å½•äº‹ä»¶...
    
    # è¯„ä¼°è§„åˆ™
    alert = service._evaluate_rule(rule, system_metrics)
    assert alert is not None
```

### 2. é›†æˆæµ‹è¯•

```bash
# åˆ›å»ºè§„åˆ™
POST /api/v1/group-ai/alert-rules/

# è§¦å‘æ£€æŸ¥
POST /api/v1/group-ai/monitor/alerts/check

# éªŒè¯å‘Šè­¦
GET /api/v1/group-ai/monitor/alerts
```

---

**æŠ¥å‘Šç”Ÿæˆå®Œæˆæ—¶é—´**: 2025-01-17  
**å½“å‰çŠ¶æ€**: ğŸŸ¢ å‘Šè­¦è§„åˆ™é›†æˆå·²å®Œæˆï¼Œæ”¯æŒæ•°æ®åº“è§„åˆ™æ£€æŸ¥å’Œå‘åå…¼å®¹

