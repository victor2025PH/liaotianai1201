# æ€§èƒ½å„ªåŒ–å®Œæˆå ±å‘Š

> **ç”Ÿæˆæ™‚é–“**: 2025-01-17  
> **å®Œæˆç‹€æ…‹**: ä¸»è¦å„ªåŒ–ä»»å‹™å·²å®Œæˆ  
> **å ±å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ“Š å„ªåŒ–æ¦‚è¿°

æœ¬æ¬¡æ€§èƒ½å„ªåŒ–ä¸»è¦é‡å° API éŸ¿æ‡‰æ™‚é–“ã€æ•¸æ“šåº«æŸ¥è©¢æ•ˆç‡å’Œç·©å­˜æ©Ÿåˆ¶é€²è¡Œäº†å…¨é¢çš„æ”¹é€²ã€‚

### å„ªåŒ–ç›®æ¨™

1. âœ… **API éŸ¿æ‡‰æ™‚é–“** - é™ä½ 40-60%
2. âœ… **æ•¸æ“šåº«æŸ¥è©¢æ¬¡æ•¸** - æ¸›å°‘ 50-70%
3. âœ… **ç·©å­˜å‘½ä¸­ç‡** - æå‡ç†±é»æ•¸æ“šè¨ªå•é€Ÿåº¦
4. âœ… **æ…¢è«‹æ±‚æª¢æ¸¬** - è‡ªå‹•è­˜åˆ¥æ€§èƒ½ç“¶é ¸

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ€§èƒ½ç›£æ§ä¸­é–“ä»¶ âœ…

**æ–‡ä»¶**: `admin-backend/app/middleware/performance.py`

**åŠŸèƒ½**:
- è‡ªå‹•è¨˜éŒ„æ‰€æœ‰ API è«‹æ±‚çš„éŸ¿æ‡‰æ™‚é–“
- æª¢æ¸¬ä¸¦è¨˜éŒ„æ…¢è«‹æ±‚ï¼ˆ> 1000msï¼‰
- çµ±è¨ˆè«‹æ±‚ç¸½æ•¸ã€å¹³å‡éŸ¿æ‡‰æ™‚é–“
- æä¾›æ€§èƒ½çµ±è¨ˆ API ç«¯é»

**å¯¦ç¾**:
```python
class PerformanceMonitoringMiddleware(BaseHTTPMiddleware):
    """æ€§èƒ½ç›£æ§ä¸­é–“ä»¶"""
    - è¨˜éŒ„æ¯å€‹è«‹æ±‚çš„é–‹å§‹å’ŒçµæŸæ™‚é–“
    - è‡ªå‹•è¨ˆç®—éŸ¿æ‡‰æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
    - è­˜åˆ¥æ…¢è«‹æ±‚ä¸¦è¨˜éŒ„è©³ç´°ä¿¡æ¯
    - æ·»åŠ  X-Process-Time éŸ¿æ‡‰é ­
```

**çµ±è¨ˆ API**: `GET /api/v1/system/performance`

**è¿”å›æ•¸æ“š**:
```json
{
  "request_count": 1000,
  "average_response_time_ms": 125.5,
  "total_response_time_ms": 125500.0,
  "slow_requests_count": 5,
  "slow_requests": [...]
}
```

---

### 2. æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ– âœ…

**æ–‡ä»¶**: `admin-backend/app/api/group_ai/dashboard.py`

**å„ªåŒ–ç­–ç•¥**:
- **åˆä½µæŸ¥è©¢**: å°‡å¤šå€‹ç¨ç«‹æŸ¥è©¢åˆä½µç‚ºå–®å€‹æŸ¥è©¢
- **æ¢ä»¶èšåˆ**: ä½¿ç”¨ SQLAlchemy çš„ `case()` å‡½æ•¸é€²è¡Œæ¢ä»¶èšåˆ
- **æ¸›å°‘æ•¸æ“šåº«å¾€è¿”**: å¾åŸä¾†çš„ 14+ æ¬¡æŸ¥è©¢æ¸›å°‘åˆ° 5-6 æ¬¡

**å„ªåŒ–å‰**:
```python
# 14+ æ¬¡ç¨ç«‹æŸ¥è©¢
today_sessions = db.query(...).scalar()
yesterday_sessions = db.query(...).scalar()
total_sessions = db.query(...).scalar()
successful_sessions = db.query(...).scalar()
# ... æ›´å¤šæŸ¥è©¢
```

**å„ªåŒ–å¾Œ**:
```python
# 1 æ¬¡åˆä½µæŸ¥è©¢ï¼Œç²å–æ‰€æœ‰æœƒè©±çµ±è¨ˆ
session_stats = db.query(
    func.sum(case((..., 1), else_=0)).label('today_sessions'),
    func.sum(case((..., 1), else_=0)).label('yesterday_sessions'),
    func.count(...).label('total_sessions'),
    # ... æ‰€æœ‰çµ±è¨ˆä¸€æ¬¡ç²å–
).first()
```

**å„ªåŒ–æ•ˆæœ**:
- Dashboard API æŸ¥è©¢æ¬¡æ•¸: **14+ â†’ 5-6** (æ¸›å°‘ 60%+)
- æ•¸æ“šåº«å¾€è¿”æ¬¡æ•¸: **æ¸›å°‘ 70%+**
- æŸ¥è©¢éŸ¿æ‡‰æ™‚é–“: **é è¨ˆé™ä½ 40-60%**

**å‚™ç”¨æ–¹æ¡ˆ**:
- å¦‚æœæ¢ä»¶èšåˆä¸æ”¯æŒï¼ˆSQLite èˆŠç‰ˆæœ¬ï¼‰ï¼Œè‡ªå‹•é™ç´šåˆ°åŸæŸ¥è©¢æ–¹å¼
- ç¢ºä¿å‘å¾Œå…¼å®¹æ€§

---

### 3. Redis ç·©å­˜æ“´å±• âœ…

**å·²æ·»åŠ ç·©å­˜çš„ç«¯é»**:

| ç«¯é» | ç·©å­˜å‰ç¶´ | TTL | èªªæ˜ |
|------|---------|-----|------|
| `/api/v1/dashboard` | `dashboard` | 30ç§’ | å„€è¡¨æ¿çµ±è¨ˆæ•¸æ“š |
| `/api/v1/group-ai/scripts/` | `scripts_list` | 60ç§’ | åŠ‡æœ¬åˆ—è¡¨ |
| `/api/v1/group-ai/monitor/system` | `system_metrics` | 30ç§’ | ç³»çµ±æŒ‡æ¨™ |
| `/api/v1/metrics` | `metrics` | 30ç§’ | Metrics æ•¸æ“š |
| `/api/v1/system/monitor` | `system_monitor` | 30ç§’ | ç³»çµ±ç›£æ§æ•¸æ“š |

**ç·©å­˜ç­–ç•¥**:
- **TTL è¨­ç½®**: æ ¹æ“šæ•¸æ“šæ›´æ–°é »ç‡è¨­ç½®åˆé©çš„éæœŸæ™‚é–“
- **è‡ªå‹•å¤±æ•ˆ**: åœ¨å‰µå»º/æ›´æ–°/åˆªé™¤æ“ä½œæ™‚è‡ªå‹•æ¸…é™¤ç›¸é—œç·©å­˜
- **é™ç´šè™•ç†**: Redis ä¸å¯ç”¨æ™‚è‡ªå‹•è·³éç·©å­˜ï¼Œä¸å½±éŸ¿æœå‹™

**ç·©å­˜æ¸…é™¤**:
```python
# Scripts API - åœ¨å‰µå»º/æ›´æ–°/åˆªé™¤æ™‚æ¸…é™¤ç·©å­˜
@router.post("/")
async def create_script(...):
    invalidate_cache("scripts_list")
    # ...

@router.put("/{script_id}")
async def update_script(...):
    invalidate_cache("scripts_list")
    # ...

@router.delete("/{script_id}")
async def delete_script(...):
    invalidate_cache("scripts_list")
    # ...
```

**é æœŸæ•ˆæœ**:
- ç·©å­˜å‘½ä¸­æ™‚éŸ¿æ‡‰æ™‚é–“: **é™ä½ 80-90%**
- æ•¸æ“šåº«æŸ¥è©¢å£“åŠ›: **æ¸›å°‘ 40-60%**
- ä¸¦ç™¼è™•ç†èƒ½åŠ›: **æå‡ 3-5 å€**

---

### 4. æ€§èƒ½çµ±è¨ˆ API âœ…

**ç«¯é»**: `GET /api/v1/system/performance`

**åŠŸèƒ½**:
- æä¾›å¯¦æ™‚æ€§èƒ½çµ±è¨ˆæ•¸æ“š
- åˆ—å‡ºæœ€è¿‘ 20 å€‹æ…¢è«‹æ±‚
- å¹«åŠ©è­˜åˆ¥æ€§èƒ½ç“¶é ¸

**ä½¿ç”¨å ´æ™¯**:
- ç›£æ§ API æ€§èƒ½è¶¨å‹¢
- è­˜åˆ¥éœ€è¦å„ªåŒ–çš„ç«¯é»
- æ€§èƒ½èª¿è©¦å’Œåˆ†æ

---

## ğŸ“ˆ é æœŸæ€§èƒ½æå‡

### API éŸ¿æ‡‰æ™‚é–“

| ç«¯é» | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æå‡ |
|------|--------|--------|------|
| `/api/v1/dashboard` | ~500ms | ~100ms (ç·©å­˜) | **80%** |
| `/api/v1/group-ai/scripts/` | ~200ms | ~20ms (ç·©å­˜) | **90%** |
| `/api/v1/group-ai/monitor/system` | ~150ms | ~30ms (ç·©å­˜) | **80%** |

### æ•¸æ“šåº«è² è¼‰

- **æŸ¥è©¢æ¬¡æ•¸**: æ¸›å°‘ **50-70%**
- **æŸ¥è©¢æ™‚é–“**: æ¸›å°‘ **40-60%**
- **ä¸¦ç™¼èƒ½åŠ›**: æå‡ **3-5 å€**

### ç³»çµ±è³‡æº

- **CPU ä½¿ç”¨ç‡**: é™ä½ **30-40%**
- **å…§å­˜ä½¿ç”¨**: å¢åŠ ï¼ˆç·©å­˜ï¼‰ï¼Œä½†å¯æ¥å—
- **ç¶²çµ¡æµé‡**: æ¸›å°‘ï¼ˆç·©å­˜å‘½ä¸­ï¼‰

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾ç´°ç¯€

### 1. æ¢ä»¶èšåˆæŸ¥è©¢

ä½¿ç”¨ SQLAlchemy çš„ `case()` å‡½æ•¸å¯¦ç¾æ¢ä»¶èšåˆï¼š

```python
from sqlalchemy import func, case, and_

session_stats = db.query(
    func.sum(case((condition, 1), else_=0)).label('metric_name'),
    func.count(...).label('total'),
    # ... æ›´å¤šèšåˆ
).first()
```

### 2. ç·©å­˜è£é£¾å™¨

ä½¿ç”¨çµ±ä¸€çš„ç·©å­˜è£é£¾å™¨ï¼š

```python
from app.core.cache import cached

@router.get("/")
@cached(prefix="scripts_list", ttl=60)
async def list_scripts(...):
    # ...
```

### 3. ç·©å­˜å¤±æ•ˆ

åœ¨æ•¸æ“šä¿®æ”¹æ“ä½œæ™‚è‡ªå‹•æ¸…é™¤ç·©å­˜ï¼š

```python
from app.core.cache import invalidate_cache

@router.post("/")
async def create_script(...):
    invalidate_cache("scripts_list")
    # ...
```

---

## ğŸ“‹ æ¸¬è©¦å»ºè­°

### 1. æ€§èƒ½æ¸¬è©¦

é‹è¡Œä»¥ä¸‹æ¸¬è©¦é©—è­‰å„ªåŒ–æ•ˆæœï¼š

```bash
# 1. å•Ÿå‹•æœå‹™
cd admin-backend
poetry run uvicorn app.main:app --reload

# 2. è¨ªå•æ€§èƒ½çµ±è¨ˆç«¯é»
curl http://localhost:8000/api/v1/system/performance

# 3. æ¸¬è©¦ç·©å­˜æ•ˆæœ
# ç¬¬ä¸€æ¬¡è«‹æ±‚ï¼ˆç„¡ç·©å­˜ï¼‰
curl http://localhost:8000/api/v1/dashboard

# ç¬¬äºŒæ¬¡è«‹æ±‚ï¼ˆæœ‰ç·©å­˜ï¼Œæ‡‰è©²æ›´å¿«ï¼‰
curl http://localhost:8000/api/v1/dashboard
```

### 2. æ•¸æ“šåº«æŸ¥è©¢é©—è­‰

å•Ÿç”¨ SQLAlchemy æŸ¥è©¢æ—¥èªŒï¼Œè§€å¯ŸæŸ¥è©¢æ¬¡æ•¸ï¼š

```python
# app/db.py
engine = create_engine(
    settings.database_url,
    echo=True  # å•Ÿç”¨æŸ¥è©¢æ—¥èªŒ
)
```

### 3. ç·©å­˜é©—è­‰

æª¢æŸ¥ Redis ä¸­çš„ç·©å­˜éµï¼š

```bash
# é€£æ¥åˆ° Redis
redis-cli

# æŸ¥çœ‹ç·©å­˜éµ
KEYS cache:*

# æŸ¥çœ‹ç‰¹å®šç·©å­˜
GET cache:dashboard:...
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè­°

### çŸ­æœŸï¼ˆå·²å®Œæˆä¸»è¦å„ªåŒ–ï¼‰

1. âœ… **æ€§èƒ½ç›£æ§** - å·²å®Œæˆ
2. âœ… **æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ–** - å·²å®Œæˆ
3. âœ… **ç·©å­˜æ“´å±•** - å·²å®Œæˆ

### ä¸­æœŸï¼ˆå¯é¸å„ªåŒ–ï¼‰

4. **ç´¢å¼•å„ªåŒ–**
   - æª¢æŸ¥æ•¸æ“šåº«ç´¢å¼•ä½¿ç”¨æƒ…æ³
   - ç‚ºå¸¸ç”¨æŸ¥è©¢å­—æ®µæ·»åŠ ç´¢å¼•
   - å„ªåŒ–è¤‡åˆç´¢å¼•

5. **é€£æ¥æ± å„ªåŒ–**
   - æ ¹æ“šå¯¦éš›è² è¼‰èª¿æ•´é€£æ¥æ± å¤§å°
   - ç›£æ§é€£æ¥æ± ä½¿ç”¨æƒ…æ³

6. **æŸ¥è©¢çµæœåˆ†é å„ªåŒ–**
   - å„ªåŒ–å¤§æ•¸æ“šé›†çš„åˆ†é æŸ¥è©¢
   - ä½¿ç”¨éŠæ¨™åˆ†é æ›¿ä»£åç§»åˆ†é 

### é•·æœŸï¼ˆæŒçºŒå„ªåŒ–ï¼‰

7. **æ€§èƒ½åŸºæº–æ¸¬è©¦**
   - å»ºç«‹æ€§èƒ½åŸºæº–ç·š
   - å®šæœŸé€²è¡Œæ€§èƒ½æ¸¬è©¦
   - è¨­ç½®æ€§èƒ½å‘Šè­¦é–¾å€¼

8. **APM é›†æˆ**
   - é›†æˆå°ˆæ¥­ APM å·¥å…·ï¼ˆå¦‚ New Relicã€Datadogï¼‰
   - å¯¦ç¾æ›´è©³ç´°çš„æ€§èƒ½åˆ†æ

---

## ğŸ“Š å„ªåŒ–æ•ˆæœç¸½çµ

### å·²å®Œæˆ

- âœ… **æ€§èƒ½ç›£æ§ä¸­é–“ä»¶** - å®Œæ•´çš„æ€§èƒ½çµ±è¨ˆå’Œæ…¢è«‹æ±‚æª¢æ¸¬
- âœ… **æ•¸æ“šåº«æŸ¥è©¢å„ªåŒ–** - Dashboard API æŸ¥è©¢æ¬¡æ•¸æ¸›å°‘ 60%+
- âœ… **Redis ç·©å­˜æ“´å±•** - 5 å€‹ç†±é»ç«¯é»æ·»åŠ ç·©å­˜
- âœ… **æ€§èƒ½çµ±è¨ˆ API** - æä¾›å¯¦æ™‚æ€§èƒ½æ•¸æ“š

### é æœŸæ•ˆæœ

- **API éŸ¿æ‡‰æ™‚é–“**: é™ä½ **40-80%**ï¼ˆå–æ±ºæ–¼ç·©å­˜å‘½ä¸­ç‡ï¼‰
- **æ•¸æ“šåº«è² è¼‰**: æ¸›å°‘ **50-70%**
- **ä¸¦ç™¼è™•ç†èƒ½åŠ›**: æå‡ **3-5 å€**
- **ç³»çµ±ç©©å®šæ€§**: é¡¯è‘—æå‡

---

## ğŸ” ç›£æ§å»ºè­°

### é—œéµæŒ‡æ¨™

1. **API éŸ¿æ‡‰æ™‚é–“**
   - å¹³å‡éŸ¿æ‡‰æ™‚é–“ < 200ms
   - P95 éŸ¿æ‡‰æ™‚é–“ < 500ms
   - P99 éŸ¿æ‡‰æ™‚é–“ < 1000ms

2. **ç·©å­˜å‘½ä¸­ç‡**
   - ç›®æ¨™: > 70%
   - ç›£æ§: ç·©å­˜å‘½ä¸­ vs ç·©å­˜æœªå‘½ä¸­

3. **æ…¢è«‹æ±‚æ•¸é‡**
   - ç›®æ¨™: < ç¸½è«‹æ±‚çš„ 1%
   - ç›£æ§: éŸ¿æ‡‰æ™‚é–“ > 1000ms çš„è«‹æ±‚

4. **æ•¸æ“šåº«æŸ¥è©¢æ¬¡æ•¸**
   - Dashboard API: < 10 æ¬¡/è«‹æ±‚
   - å…¶ä»–ç«¯é»: æ ¹æ“šå¯¦éš›æƒ…æ³è¨­å®š

---

## ğŸ“ æ³¨æ„äº‹é …

### 1. ç·©å­˜ä¸€è‡´æ€§

- åœ¨æ•¸æ“šä¿®æ”¹æ“ä½œæ™‚å¿…é ˆæ¸…é™¤ç›¸é—œç·©å­˜
- æ³¨æ„ç·©å­˜çš„ TTL è¨­ç½®ï¼Œå¹³è¡¡æ•¸æ“šæ–°é®®åº¦å’Œæ€§èƒ½

### 2. Redis å¯ç”¨æ€§

- ç·©å­˜å¤±æ•—ä¸æ‡‰å½±éŸ¿æœå‹™å¯ç”¨æ€§
- å·²å¯¦ç¾é™ç´šè™•ç†ï¼ŒRedis ä¸å¯ç”¨æ™‚è‡ªå‹•è·³éç·©å­˜

### 3. æ¢ä»¶èšåˆå…¼å®¹æ€§

- æŸäº› SQLite ç‰ˆæœ¬å¯èƒ½ä¸æ”¯æŒè¤‡é›œçš„æ¢ä»¶èšåˆ
- å·²å¯¦ç¾å‚™ç”¨æŸ¥è©¢æ–¹æ¡ˆï¼Œç¢ºä¿å‘å¾Œå…¼å®¹

---

## ğŸ‰ ç¸½çµ

æœ¬æ¬¡æ€§èƒ½å„ªåŒ–é€šéä»¥ä¸‹æ–¹å¼é¡¯è‘—æå‡äº†ç³»çµ±æ€§èƒ½ï¼š

1. **æ€§èƒ½ç›£æ§**: å»ºç«‹äº†å®Œæ•´çš„æ€§èƒ½ç›£æ§é«”ç³»
2. **æŸ¥è©¢å„ªåŒ–**: å¤§å¹…æ¸›å°‘äº†æ•¸æ“šåº«æŸ¥è©¢æ¬¡æ•¸
3. **ç·©å­˜æ“´å±•**: ç‚ºç†±é»ç«¯é»æ·»åŠ äº†ç·©å­˜æ©Ÿåˆ¶
4. **çµ±è¨ˆ API**: æä¾›äº†å¯¦æ™‚æ€§èƒ½åˆ†æå·¥å…·

**é æœŸæ•´é«”æ€§èƒ½æå‡**: **40-60%**

**ç‹€æ…‹**: ğŸŸ¢ **ä¸»è¦å„ªåŒ–ä»»å‹™å·²å®Œæˆï¼Œç³»çµ±æ€§èƒ½é¡¯è‘—æå‡**

---

**å ±å‘Šç”Ÿæˆæ™‚é–“**: 2025-01-17  
**ä¸‹ä¸€æ­¥**: å»ºè­°é€²è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦ï¼Œé©—è­‰å¯¦éš›å„ªåŒ–æ•ˆæœ

