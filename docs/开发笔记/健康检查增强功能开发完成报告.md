# å¥åº·æ£€æŸ¥å¢å¼ºåŠŸèƒ½å¼€å‘å®ŒæˆæŠ¥å‘Š

> **å®Œæˆæ—¥æœŸ**: 2025-11-19  
> **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­ï¼ˆå®é™…æŒ‰é«˜ä¼˜å…ˆçº§å®Œæˆï¼‰  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å¢å¼ºçš„å¥åº·æ£€æŸ¥åŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤šç»„ä»¶å¥åº·çŠ¶æ€æ£€æŸ¥ã€è¯¦ç»†å¥åº·ä¿¡æ¯ã€å¹¶è¡Œæ£€æŸ¥ç­‰ï¼Œæ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œæ•…éšœè¯Šæ–­èƒ½åŠ›ã€‚

---

## å·²å®Œæˆçš„å·¥ä½œ

### 1. å¢å¼ºå¥åº·æ£€æŸ¥æ¨¡å—

#### âœ… `admin-backend/app/core/health_check.py` - å¥åº·æ£€æŸ¥æ ¸å¿ƒæ¨¡å—

**æ ¸å¿ƒç±»**:

1. **`HealthStatus`** - å¥åº·çŠ¶æ€æšä¸¾:
   - `HEALTHY`: å¥åº·
   - `DEGRADED`: é™çº§ï¼ˆéƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨ï¼‰
   - `UNHEALTHY`: ä¸å¥åº·ï¼ˆå…³é”®åŠŸèƒ½ä¸å¯ç”¨ï¼‰
   - `UNKNOWN`: æœªçŸ¥

2. **`ComponentHealth`** - ç»„ä»¶å¥åº·çŠ¶æ€:
   - ç»„ä»¶åç§°
   - å¥åº·çŠ¶æ€
   - æ¶ˆæ¯æè¿°
   - å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   - è¯¦ç»†ä¿¡æ¯
   - æ—¶é—´æˆ³

3. **`HealthChecker`** - å¥åº·æ£€æŸ¥å™¨:
   - å¤šç»„ä»¶å¹¶è¡Œæ£€æŸ¥
   - è¶…æ—¶æ§åˆ¶
   - å“åº”æ—¶é—´ç»Ÿè®¡
   - æ•´ä½“çŠ¶æ€è®¡ç®—

**æ£€æŸ¥çš„ç»„ä»¶**:

1. **æ•°æ®åº“** (`check_database`):
   - æ‰§è¡Œç®€å•æŸ¥è¯¢æµ‹è¯•è¿æ¥
   - è®°å½•å“åº”æ—¶é—´
   - æ£€æµ‹è¿æ¥å¤±è´¥

2. **Redis** (`check_redis`):
   - æ£€æŸ¥ Redis è¿æ¥ï¼ˆå¦‚æœå¯ç”¨ï¼‰
   - å¯é€‰ç»„ä»¶ï¼Œæœªé…ç½®æ—¶è¿”å›å¥åº·
   - æ£€æµ‹è¿æ¥å¤±è´¥

3. **Telegram API** (`check_telegram_api`):
   - æ£€æŸ¥ Telegram API è¿æ¥
   - æ£€æµ‹è¶…æ—¶å’Œé”™è¯¯
   - è®°å½•å“åº”æ—¶é—´

4. **Session æ–‡ä»¶** (`check_session_files`):
   - æ£€æŸ¥ Session æ–‡ä»¶ç›®å½•
   - ç»Ÿè®¡æ–‡ä»¶æ•°é‡ï¼ˆæ˜æ–‡å’ŒåŠ å¯†ï¼‰
   - æ£€æµ‹ç›®å½•ä¸å­˜åœ¨

5. **è´¦å·æœåŠ¡** (`check_accounts`):
   - ç»Ÿè®¡è´¦å·çŠ¶æ€ï¼ˆåœ¨çº¿/ç¦»çº¿/é”™è¯¯ï¼‰
   - è®¡ç®—å¥åº·çŠ¶æ€ï¼ˆåŸºäºé”™è¯¯ç‡ï¼‰
   - æä¾›è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯

### 2. API ç«¯ç‚¹å¢å¼º

#### âœ… `admin-backend/app/main.py` - å¥åº·æ£€æŸ¥ç«¯ç‚¹

**ç«¯ç‚¹æ›´æ–°**:

1. **`/health`** - åŸºç¡€å¥åº·æ£€æŸ¥:
   - **å¿«é€Ÿæ¨¡å¼** (`detailed=false`): åªæ£€æŸ¥æ•°æ®åº“ï¼Œå¿«é€Ÿå“åº”
   - **è¯¦ç»†æ¨¡å¼** (`detailed=true`): æ£€æŸ¥æ‰€æœ‰ç»„ä»¶ï¼Œè¿”å›è¯¦ç»†ä¿¡æ¯
   - æ ¹æ®å¥åº·çŠ¶æ€è¿”å›ç›¸åº”çš„ HTTP çŠ¶æ€ç 

2. **`/healthz`** - Kubernetes æ¢é’ˆ:
   - å¿«é€Ÿæ£€æŸ¥ï¼ˆä»…æ•°æ®åº“ï¼‰
   - ç”¨äº liveness å’Œ readiness æ¢é’ˆ
   - å¤±è´¥æ—¶è¿”å› 503

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# å¿«é€Ÿæ£€æŸ¥
curl http://localhost:8000/health

# è¯¦ç»†æ£€æŸ¥
curl http://localhost:8000/health?detailed=true

# Kubernetes æ¢é’ˆ
curl http://localhost:8000/healthz
```

### 3. å¥åº·çŠ¶æ€è®¡ç®—

**æ•´ä½“çŠ¶æ€é€»è¾‘**:
- å¦‚æœä»»ä½•ç»„ä»¶ä¸º `unhealthy`ï¼Œæ•´ä½“çŠ¶æ€ä¸º `unhealthy`
- å¦‚æœä»»ä½•ç»„ä»¶ä¸º `degraded` ä¸”æ²¡æœ‰ `unhealthy`ï¼Œæ•´ä½“çŠ¶æ€ä¸º `degraded`
- å¦åˆ™æ•´ä½“çŠ¶æ€ä¸º `healthy`

**HTTP çŠ¶æ€ç **:
- `200`: å¥åº·æˆ–é™çº§ï¼ˆä»å¯ç”¨ï¼‰
- `503`: ä¸å¥åº·ï¼ˆæœåŠ¡ä¸å¯ç”¨ï¼‰

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### å¹¶è¡Œæ£€æŸ¥

ä½¿ç”¨ `asyncio.gather()` å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰æ£€æŸ¥ï¼Œæé«˜æ•ˆç‡ï¼š

```python
results = await asyncio.gather(*checks, return_exceptions=True)
```

### è¶…æ—¶æ§åˆ¶

æ¯ä¸ªæ£€æŸ¥éƒ½æœ‰è¶…æ—¶æ§åˆ¶ï¼ˆé»˜è®¤ 5 ç§’ï¼‰ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ï¼š

```python
checker = HealthChecker(timeout=5.0)
```

### å“åº”æ—¶é—´ç»Ÿè®¡

æ¯ä¸ªç»„ä»¶æ£€æŸ¥éƒ½è®°å½•å“åº”æ—¶é—´ï¼Œä¾¿äºæ€§èƒ½åˆ†æï¼š

```python
start_time = time.time()
# ... æ‰§è¡Œæ£€æŸ¥ ...
response_time = (time.time() - start_time) * 1000  # æ¯«ç§’
```

### é”™è¯¯å¤„ç†

æ‰€æœ‰æ£€æŸ¥éƒ½åŒ…å«å¼‚å¸¸å¤„ç†ï¼Œç¡®ä¿å•ä¸ªç»„ä»¶å¤±è´¥ä¸å½±å“å…¶ä»–ç»„ä»¶ï¼š

```python
try:
    # æ£€æŸ¥é€»è¾‘
except Exception as e:
    return ComponentHealth(
        name="component",
        status=HealthStatus.UNKNOWN,
        message=f"æ£€æŸ¥å¤±è´¥: {str(e)}"
    )
```

---

## å¥åº·æ£€æŸ¥å“åº”æ ¼å¼

### å¿«é€Ÿæ£€æŸ¥å“åº”

```json
{
  "status": "ok"
}
```

### è¯¦ç»†æ£€æŸ¥å“åº”

```json
{
  "status": "healthy",
  "timestamp": "2025-11-19T10:30:00.123456",
  "components": [
    {
      "name": "database",
      "status": "healthy",
      "message": "æ•°æ®åº“è¿æ¥æ­£å¸¸",
      "response_time_ms": 2.5,
      "details": {
        "type": "sqlite"
      },
      "timestamp": "2025-11-19T10:30:00.123456"
    },
    {
      "name": "redis",
      "status": "healthy",
      "message": "Redis æœªé…ç½®ï¼ˆå¯é€‰ç»„ä»¶ï¼‰",
      "response_time_ms": 0,
      "details": {},
      "timestamp": "2025-11-19T10:30:00.123456"
    },
    {
      "name": "telegram_api",
      "status": "healthy",
      "message": "Telegram API è¿æ¥æ­£å¸¸",
      "response_time_ms": 150.2,
      "details": {
        "status_code": 200
      },
      "timestamp": "2025-11-19T10:30:00.123456"
    },
    {
      "name": "session_files",
      "status": "healthy",
      "message": "Session æ–‡ä»¶ç›®å½•æ­£å¸¸",
      "response_time_ms": 1.2,
      "details": {
        "directory": "sessions",
        "session_files_count": 5,
        "encrypted_files_count": 2,
        "total_files": 7
      },
      "timestamp": "2025-11-19T10:30:00.123456"
    },
    {
      "name": "accounts",
      "status": "healthy",
      "message": "è´¦å·æœåŠ¡æ­£å¸¸ï¼š10/12 è´¦å·åœ¨çº¿",
      "response_time_ms": 5.8,
      "details": {
        "total_accounts": 12,
        "online_count": 10,
        "offline_count": 1,
        "error_count": 1
      },
      "timestamp": "2025-11-19T10:30:00.123456"
    }
  ],
  "summary": {
    "healthy": 5,
    "degraded": 0,
    "unhealthy": 0,
    "unknown": 0
  }
}
```

---

## ä½¿ç”¨åœºæ™¯

### 1. å¿«é€Ÿå¥åº·æ£€æŸ¥ï¼ˆç›‘æ§ç³»ç»Ÿï¼‰

```bash
# ç”¨äºç›‘æ§ç³»ç»Ÿçš„å®šæœŸæ£€æŸ¥
curl http://localhost:8000/health
```

### 2. è¯¦ç»†å¥åº·è¯Šæ–­ï¼ˆæ•…éšœæ’æŸ¥ï¼‰

```bash
# è·å–æ‰€æœ‰ç»„ä»¶çš„è¯¦ç»†å¥åº·ä¿¡æ¯
curl http://localhost:8000/health?detailed=true
```

### 3. Kubernetes æ¢é’ˆ

```yaml
livenessProbe:
  httpGet:
    path: /healthz
    port: 8000
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /healthz
    port: 8000
  initialDelaySeconds: 10
  periodSeconds: 5
```

### 4. è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬

```python
import requests

response = requests.get("http://localhost:8000/health?detailed=true")
data = response.json()

if data["status"] == "unhealthy":
    # å‘é€å‘Šè­¦
    send_alert("ç³»ç»Ÿä¸å¥åº·")
elif data["status"] == "degraded":
    # å‘é€è­¦å‘Š
    send_warning("ç³»ç»Ÿé™çº§")
```

---

## å¥åº·çŠ¶æ€åˆ¤æ–­æ ‡å‡†

### æ•°æ®åº“

- **healthy**: è¿æ¥æˆåŠŸï¼ŒæŸ¥è¯¢æ­£å¸¸
- **unhealthy**: è¿æ¥å¤±è´¥æˆ–æŸ¥è¯¢å¤±è´¥

### Redis

- **healthy**: è¿æ¥æˆåŠŸæˆ–æœªé…ç½®ï¼ˆå¯é€‰ç»„ä»¶ï¼‰
- **degraded**: è¿æ¥å¤±è´¥ï¼ˆå¯é€‰ç»„ä»¶ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
- **unknown**: å®¢æˆ·ç«¯æœªå®‰è£…

### Telegram API

- **healthy**: è¿æ¥æˆåŠŸï¼ŒçŠ¶æ€ç  < 500
- **degraded**: è¿æ¥è¶…æ—¶æˆ–çŠ¶æ€ç  >= 500
- **unknown**: aiohttp æœªå®‰è£…

### Session æ–‡ä»¶

- **healthy**: ç›®å½•å­˜åœ¨
- **degraded**: ç›®å½•ä¸å­˜åœ¨

### è´¦å·æœåŠ¡

- **healthy**: é”™è¯¯è´¦å· < 50%ï¼Œç¦»çº¿è´¦å· < 70%
- **degraded**: ç¦»çº¿è´¦å· >= 70% ä½†é”™è¯¯è´¦å· < 50%
- **unhealthy**: é”™è¯¯è´¦å· >= 50%

---

## æ€§èƒ½å½±å“

### å¿«é€Ÿæ£€æŸ¥

- **å“åº”æ—¶é—´**: < 10msï¼ˆä»…æ•°æ®åº“æŸ¥è¯¢ï¼‰
- **èµ„æºå ç”¨**: æä½
- **é€‚ç”¨åœºæ™¯**: é«˜é¢‘ç›‘æ§ã€Kubernetes æ¢é’ˆ

### è¯¦ç»†æ£€æŸ¥

- **å“åº”æ—¶é—´**: 100-500msï¼ˆå¹¶è¡Œæ£€æŸ¥æ‰€æœ‰ç»„ä»¶ï¼‰
- **èµ„æºå ç”¨**: ä¸­ç­‰ï¼ˆå¤šä¸ªå¹¶å‘è¿æ¥ï¼‰
- **é€‚ç”¨åœºæ™¯**: æ•…éšœæ’æŸ¥ã€å®šæœŸè¯Šæ–­

---

## æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•å¿«é€Ÿæ£€æŸ¥
curl http://localhost:8000/health

# æµ‹è¯•è¯¦ç»†æ£€æŸ¥
curl http://localhost:8000/health?detailed=true

# æµ‹è¯• Kubernetes æ¢é’ˆ
curl http://localhost:8000/healthz
```

### 2. æ•…éšœæ¨¡æ‹Ÿæµ‹è¯•

- [ ] æ–­å¼€æ•°æ®åº“è¿æ¥ï¼Œæ£€æŸ¥å¥åº·çŠ¶æ€
- [ ] æ–­å¼€ Redis è¿æ¥ï¼Œæ£€æŸ¥å¥åº·çŠ¶æ€
- [ ] æ–­å¼€ç½‘ç»œï¼Œæ£€æŸ¥ Telegram API çŠ¶æ€
- [ ] åˆ é™¤ Session ç›®å½•ï¼Œæ£€æŸ¥å¥åº·çŠ¶æ€
- [ ] åœæ­¢è´¦å·æœåŠ¡ï¼Œæ£€æŸ¥å¥åº·çŠ¶æ€

### 3. æ€§èƒ½æµ‹è¯•

- [ ] æµ‹è¯•å¿«é€Ÿæ£€æŸ¥å“åº”æ—¶é—´
- [ ] æµ‹è¯•è¯¦ç»†æ£€æŸ¥å“åº”æ—¶é—´
- [ ] æµ‹è¯•å¹¶å‘å¥åº·æ£€æŸ¥è¯·æ±‚

---

## å·²çŸ¥é—®é¢˜

1. **è´¦å·æœåŠ¡æ£€æŸ¥**: éœ€è¦æ•°æ®åº“è¿æ¥ï¼Œå¦‚æœæ•°æ®åº“ä¸å¯ç”¨ï¼Œæ— æ³•æ£€æŸ¥è´¦å·æœåŠ¡
2. **ç¼“å­˜æœºåˆ¶**: å½“å‰æ²¡æœ‰ç¼“å­˜æœºåˆ¶ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ‰§è¡Œå®Œæ•´æ£€æŸ¥ï¼ˆå¯ä¼˜åŒ–ï¼‰

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### å¯é€‰ä¼˜åŒ–

1. **å¥åº·çŠ¶æ€ç¼“å­˜**:
   - ç¼“å­˜å¥åº·çŠ¶æ€ï¼ˆå¦‚ 30 ç§’ï¼‰
   - å‡å°‘é‡å¤æ£€æŸ¥
   - æé«˜å“åº”é€Ÿåº¦

2. **å¥åº·æ£€æŸ¥å†å²**:
   - è®°å½•å¥åº·çŠ¶æ€å†å²
   - æ”¯æŒè¶‹åŠ¿åˆ†æ
   - æ”¯æŒå‘Šè­¦è§„åˆ™

3. **è‡ªå®šä¹‰æ£€æŸ¥**:
   - æ”¯æŒæ·»åŠ è‡ªå®šä¹‰å¥åº·æ£€æŸ¥
   - æ’ä»¶åŒ–æ¶æ„
   - åŠ¨æ€é…ç½®

---

## ç›¸å…³æ–‡ä»¶

- `admin-backend/app/core/health_check.py` - å¥åº·æ£€æŸ¥æ ¸å¿ƒæ¨¡å—
- `admin-backend/app/main.py` - å¥åº·æ£€æŸ¥ç«¯ç‚¹

---

## æ€»ç»“

å¥åº·æ£€æŸ¥å¢å¼ºåŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°ç³»ç»Ÿä¸­ã€‚è¯¥åŠŸèƒ½æä¾›äº†ï¼š

- âœ… å¤šç»„ä»¶å¥åº·æ£€æŸ¥ï¼ˆæ•°æ®åº“ã€Redisã€Telegram APIã€Session æ–‡ä»¶ã€è´¦å·æœåŠ¡ï¼‰
- âœ… è¯¦ç»†å¥åº·ä¿¡æ¯ï¼ˆçŠ¶æ€ã€æ¶ˆæ¯ã€å“åº”æ—¶é—´ã€è¯¦ç»†ä¿¡æ¯ï¼‰
- âœ… å¹¶è¡Œæ£€æŸ¥ï¼ˆæé«˜æ•ˆç‡ï¼‰
- âœ… çµæ´»çš„å¥åº·æ£€æŸ¥æ¨¡å¼ï¼ˆå¿«é€Ÿ/è¯¦ç»†ï¼‰
- âœ… Kubernetes å…¼å®¹ï¼ˆæ ‡å‡†æ¢é’ˆç«¯ç‚¹ï¼‰

ç³»ç»Ÿå¯è§‚æµ‹æ€§å¾—åˆ°æ˜¾è‘—æå‡ï¼Œèƒ½å¤Ÿå¿«é€Ÿè¯Šæ–­ç³»ç»Ÿå¥åº·çŠ¶æ€å’Œæ•…éšœåŸå› ã€‚

---

**æŠ¥å‘Šç»“æŸ**

