name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script_stop: true
          debug: true
          envs: GITHUB_REPO=${{ github.repository }},SERVER_HOST=${{ secrets.SERVER_HOST }}
          script: |
            # 遇到任何命令错误(非逻辑判断)则退出
            set -e
            
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            
            echo "🚀 开始部署..."
            echo "时间: $(date)"
            echo "系统资源:"
            free -h || true
            echo ""
            
            # 0. 启用 Swap（如果未启用）
            echo "检查并启用 Swap..."
            sudo swapon /swapfile 2>/dev/null || echo "Swap 已启用或文件不存在"
            free -h || true
            echo ""
            
            # 1. 预检：如果目录存在但不是 git 仓库，先清理
            if [ -d "$PROJECT_DIR" ] && [ ! -d "$PROJECT_DIR/.git" ]; then
                echo "⚠️  发现无效项目目录（缺少 .git），正在清理..."
                sudo rm -rf "$PROJECT_DIR"
                echo "✅ 无效目录已清理"
            fi
            
            # 2. 检查并创建项目目录（如果不存在）
            if [ ! -d "$PROJECT_DIR" ]; then
                echo "项目目录不存在，正在创建并克隆代码..."
                sudo mkdir -p "$PROJECT_DIR"
                sudo chown -R ubuntu:ubuntu "$PROJECT_DIR"
                # 克隆代码
                sudo -u ubuntu git clone https://github.com/victor2025PH/liaotianai1201.git "$PROJECT_DIR"
                echo "✅ 代码克隆完成"
            fi
            
            # 3. 确保目录权限正确
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR" || true
            sudo chmod 755 "$PROJECT_DIR" || true
            
            # 4. 进入目录并更新代码
            cd "$PROJECT_DIR" || {
                echo "❌ 无法进入项目目录，检查权限..."
                ls -la "$PROJECT_DIR" || true
                exit 1
            }
            
            # 验证是 git 仓库
            if [ ! -d ".git" ]; then
                echo "❌ 错误：目录不是 git 仓库，这不应该发生"
                exit 1
            fi
            
            echo "📥 更新代码..."
            sudo -u ubuntu git fetch origin main
            sudo -u ubuntu git reset --hard origin/main
            echo "✅ 代码更新完成"
            
            # 2. 确保权限正确（再次确认）
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR" || true
            
            # 3. 构建前端
            echo "📦 构建前端..."
            cd saas-demo
            
            # 1. 清理锁文件（不停止服务，减少中断时间）
            rm -f .next/lock
            
            # 2. 检查内存和 Swap
            echo "检查系统资源..."
            free -h || true
            echo ""
            echo "启用 Swap（如果未启用）..."
            sudo swapon /swapfile 2>/dev/null || echo "Swap 已启用或文件不存在"
            free -h || true
            echo ""
            
            # 3. 安装与构建（在服务运行的情况下构建）
            # 使用 NODE_OPTIONS 限制 Node.js 内存使用（512MB，更保守）
            export NODE_OPTIONS="--max-old-space-size=512"
            npm install --prefer-offline --no-audit
            
            # 构建时也限制内存
            NODE_OPTIONS="--max-old-space-size=512" npm run build
            
            # 暴力复制静态资源 (Standalone 补丁)
            echo "📂 处理静态资源..."
            mkdir -p .next/standalone/.next/static
            # 使用 || true 防止某些文件不存在导致报错
            cp -r .next/static/* .next/standalone/.next/static/ || true
            cp -r public .next/standalone/ || true
            cd ..
            
            # 4. 后端依赖
            echo "🐍 安装后端依赖..."
            
            # 检查 admin-backend 目录是否存在
            if [ ! -d "admin-backend" ]; then
                echo "❌ admin-backend 目录不存在"
                echo "   当前目录: $(pwd)"
                echo "   目录内容:"
                ls -la || true
                exit 1
            fi
            
            cd admin-backend || {
                echo "❌ 无法进入 admin-backend 目录"
                exit 1
            }
            
            echo "✅ 已进入 admin-backend 目录: $(pwd)"
            
            # 临时禁用 set -e 以进行调试
            set +e
            echo "   当前目录内容:"
            ls -la | head -20
            LS_EXIT_CODE=$?
            set -e
            if [ $LS_EXIT_CODE -ne 0 ]; then
                echo "   ⚠️  警告：列出目录内容时出现问题（退出码: $LS_EXIT_CODE）"
            fi
            echo ""
            
            # 检查并创建虚拟环境（如果不存在）
            echo "🔍 检查虚拟环境状态..."
            if [ ! -d "venv" ]; then
                echo "   📦 venv 目录不存在，需要创建"
                echo "📦 创建 Python 虚拟环境..."
                echo "   检查 Python3..."
                # 检查 python3 是否可用
                if ! command -v python3 &> /dev/null; then
                    echo "❌ Python3 未安装，请先安装 Python3"
                    exit 1
                fi
                echo "   ✅ Python3 已安装: $(python3 --version 2>&1)"
                
                # 检查 python3-venv 模块是否可用
                echo "   检查 python3-venv 模块..."
                if python3 -m venv --help > /dev/null 2>&1; then
                    echo "   ✅ python3-venv 模块可用"
                else
                    echo "   ⚠️  python3-venv 模块可能不可用，尝试创建虚拟环境..."
                fi
                
                # 尝试创建虚拟环境
                echo "   正在创建虚拟环境..."
                if python3 -m venv venv 2>&1; then
                    echo "✅ 虚拟环境创建完成"
                    # 验证虚拟环境是否真的创建成功
                    if [ -d "venv" ] && [ -f "venv/bin/activate" ]; then
                        echo "   ✅ 虚拟环境验证成功"
                    else
                        echo "   ❌ 虚拟环境创建后验证失败"
                        exit 1
                    fi
                else
                    echo "❌ 创建虚拟环境失败"
                    echo "   可能原因：缺少 python3-venv 模块"
                    echo "   解决方法：在服务器上运行: sudo apt update && sudo apt install -y python3-venv"
                    exit 1
                fi
            else
                echo "✅ 虚拟环境已存在"
                # 验证现有虚拟环境是否完整
                if [ ! -f "venv/bin/activate" ]; then
                    echo "   ⚠️  虚拟环境目录存在但激活脚本缺失，将重新创建..."
                    rm -rf venv
                    echo "   重新创建虚拟环境..."
                    python3 -m venv venv || {
                        echo "❌ 重新创建虚拟环境失败"
                        exit 1
                    }
                    echo "   ✅ 虚拟环境重新创建完成"
                fi
            fi
            
            # 检查虚拟环境目录结构
            if [ ! -f "venv/bin/activate" ]; then
                echo "❌ 虚拟环境激活脚本不存在: venv/bin/activate"
                echo "   虚拟环境目录内容:"
                ls -la venv/ || true
                ls -la venv/bin/ || true
                exit 1
            fi
            
            # 激活虚拟环境
            echo "🔄 激活虚拟环境..."
            source venv/bin/activate || {
                echo "❌ 激活虚拟环境失败"
                exit 1
            }
            echo "✅ 虚拟环境已激活: $(which python)"
            
            # 升级 pip
            echo "📦 升级 pip..."
            pip install --upgrade pip --quiet || {
                echo "⚠️  pip 升级失败，继续执行..."
            }
            
            # 安装依赖
            echo "📦 安装 Python 依赖..."
            pip install -r requirements.txt --quiet || {
                echo "❌ 依赖安装失败"
                exit 1
            }
            echo "✅ 依赖安装完成"
            
            cd ..
            
            # 5. 重启服务（使用 PM2）
            echo "🔄 重启服务..."
            
            # 切换到 ubuntu 用户执行 PM2 命令
            # 注意：PM2 需要以运行服务的用户身份执行
            sudo -u ubuntu bash -c "cd /home/ubuntu/telegram-ai-system && pm2 reload ecosystem.config.js || pm2 restart ecosystem.config.js"
            sudo -u ubuntu bash -c "cd /home/ubuntu/telegram-ai-system && pm2 save"
            
            # 等待服务启动
            sleep 5
            
            # 最后重启 Nginx
            sudo systemctl restart nginx
            sleep 2
            
            # 6. 验证服务状态
            echo "🔍 验证服务状态..."
            
            # 完全禁用 set -e 进行验证（避免任何命令失败导致脚本退出）
            set +e
            
            # 显示 PM2 状态（简单检查）
            echo "PM2 进程列表："
            sudo -u ubuntu pm2 status 2>&1 || echo "无法获取 PM2 状态"

            # 简单的服务检查
            echo ""
            echo "服务检查："
            if sudo -u ubuntu pm2 list 2>/dev/null | grep -q "backend.*online"; then
                echo "  ✅ 后端服务: online"
            else
                echo "  ⚠️  后端服务: 状态未知"
            fi

            if sudo -u ubuntu pm2 list 2>/dev/null | grep -q "frontend.*online"; then
                echo "  ✅ 前端服务: online"
            else
                echo "  ⚠️  前端服务: 状态未知"
            fi

            # 确保脚本以成功状态退出
            EXIT_CODE=0

            # 检查 PM2 reload 是否成功（最重要的检查）
            if sudo -u ubuntu pm2 list 2>/dev/null | grep -q -E "backend|frontend"; then
                echo ""
                echo "✅ PM2 服务已重新加载"
                EXIT_CODE=0
            else
                echo ""
                echo "⚠️  PM2 服务状态未知，但部署步骤已完成"
                EXIT_CODE=0  # 即使检查失败，也认为部署成功
            fi
            
            # 退出脚本（确保有明确的退出码）
            exit $EXIT_CODE
