# 端到端业务流程测试报告

## 测试目标
测试完整的业务流程：
1. 往服务器部署账号
2. 账号自动建群
3. 在群里按剧本聊天

## 测试时间
2025-11-21 20:40:00

## 测试环境
- **前端服务**: http://localhost:3000 (saas-demo - Next.js)
- **后端服务**: http://localhost:8000 (admin-backend - FastAPI)

## 测试步骤

### 步骤1: 检查测试环境
- [ ] 检查可用账号列表
- [ ] 检查可用服务器列表
- [ ] 检查可用剧本列表

### 步骤2: 部署账号到服务器
- [ ] 选择测试账号
- [ ] 分配账号到服务器
- [ ] 验证账号部署成功

### 步骤3: 账号自动建群
- [ ] 启动账号（如果未启动）
- [ ] 创建群组
- [ ] 验证群组创建成功

### 步骤4: 按剧本聊天
- [ ] 启动群组聊天
- [ ] 验证剧本加载
- [ ] 验证消息监听启动
- [ ] 测试自动回复功能

## 测试结果

### 步骤1: 检查测试环境 ✅
- ✅ 可用账号列表：3个账号（639641837416, 639457597211, 639277356598）
- ✅ 可用服务器列表：3个服务器（都是online状态，每个最多5个账号）
- ✅ 可用剧本列表：1个剧本（000新人欢迎剧本）
- ✅ 创建测试账号：test_account_001（已创建，状态：offline，未分配服务器）

### 步骤2: 部署账号到服务器 ⚠️ 遇到问题
- ✅ 选择测试账号：639641837416
- ✅ 选择服务器：worker-01
- ⚠️ 分配账号到服务器：API调用成功，但server_id仍为空（可能需要使用node_id）
- ❌ 启动账号失败：错误信息 "無法加載劇本: 000新人欢迎剧本"
- **问题分析**：
  - 数据库中的剧本 yaml_content 存在但格式可能有问题
  - 文件系统中的剧本文件存在于 `docs\剧本\000新人欢迎剧本.yaml`
  - ServiceManager 尝试从数据库加载剧本，但可能解析失败
- **解决方案**：
  - 需要检查剧本 YAML 格式是否正确
  - 或者确保文件系统中的剧本文件可以被正确加载

### 步骤3: 账号自动建群
待测试...

### 步骤4: 按剧本聊天
待测试...

## 发现的问题
待记录...

## 测试总结

### 测试进度
1. ✅ **步骤1：检查测试环境** - 完成
2. ⚠️ **步骤2：部署账号到服务器** - 遇到问题
3. ⏸️ **步骤3：账号自动建群** - 等待步骤2完成
4. ⏸️ **步骤4：按剧本聊天** - 等待步骤2完成

### 发现的问题

#### 问题1：账号分配服务器失败
- **现象**：使用 `PUT /api/v1/group-ai/accounts/{account_id}` 分配服务器后，server_id 仍为空
- **原因**：服务器API使用 `node_id` 而不是 `server_id`
- **解决方案**：需要确认账号更新API是否正确处理 `node_id`

#### 问题2：启动账号失败 - 无法加载剧本
- **错误信息**：`啟動賬號 639641837416 失敗。詳細信息: 無法加載劇本: 000新人欢迎剧本`
- **原因分析**：
  - 数据库中的剧本 `yaml_content` 存在但格式可能有问题（最后有一个空的scene）
  - 文件系统中的剧本文件存在且格式正确（`docs\剧本\000新人欢迎剧本.yaml`）
  - ServiceManager 优先从数据库加载剧本，如果解析失败，会尝试从文件系统加载
  - 但文件系统路径是 `ai_models/group_scripts/{script_id}.yaml`，而实际文件在 `docs\剧本\` 目录
- **解决方案**：
  1. 修复数据库中的剧本 yaml_content 格式
  2. 或者将剧本文件复制到 `ai_models/group_scripts/` 目录
  3. 或者修改 ServiceManager 的剧本加载逻辑，支持从 `docs\剧本\` 目录加载

### 下一步行动
1. 修复剧本加载问题
2. 重新测试账号启动
3. 继续测试建群和聊天功能

### 测试环境信息
- **测试账号**: 639641837416
- **服务器**: worker-01 (node_id)
- **剧本**: 000新人欢迎剧本
- **剧本文件位置**: `docs\剧本\000新人欢迎剧本.yaml` (2909字符)

