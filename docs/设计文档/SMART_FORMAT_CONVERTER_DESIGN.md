# 智能格式转换功能设计文档

## 功能概述

智能格式转换功能是一个AI驱动的文档格式转换和优化工具，主要用于将旧格式的剧本YAML自动转换为新格式，同时支持多种文档格式的上传和处理。

## 功能需求

### 1. 核心功能
- **格式转换**：将旧格式YAML（step/actor/action）转换为新格式（script_id/scenes/triggers/responses）
- **内容优化**：使用AI对内容进行语法纠正、表达润色和结构调整
- **多格式支持**：支持DOCX、PDF、TXT、HTML、YAML等多种格式
- **智能识别**：自动识别文档格式和内容结构
- **预览确认**：提供转换后的预览，用户可确认或修改

### 2. 支持的文件格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| YAML | .yaml, .yml | 剧本YAML文件 |
| 文本 | .txt | 纯文本文件 |
| Markdown | .md | Markdown格式 |
| Word文档 | .docx | Microsoft Word文档 |
| PDF | .pdf | PDF文档（需要OCR） |
| HTML | .html, .htm | HTML网页 |
| JSON | .json | JSON格式 |

### 3. AI能力范围

#### 3.1 格式转换能力
- 识别旧格式YAML结构（step, actor, action, lines）
- 转换为新格式结构（script_id, scenes, triggers, responses）
- 保持语义和逻辑完整性
- 自动生成场景ID和触发条件

#### 3.2 内容优化能力
- **语法纠正**：修正语法错误和拼写错误
- **表达润色**：优化表达方式，使其更自然流畅
- **结构调整**：优化场景顺序和逻辑关系
- **变量提取**：识别并提取可复用的变量

#### 3.3 智能分析能力
- 分析剧本结构和逻辑
- 识别重复内容
- 建议优化方案
- 生成剧本描述和元数据

### 4. 用户交互流程

```
1. 用户打开剧本创建页面
   ↓
2. 用户可以选择：
   a) 直接粘贴YAML内容
   b) 点击"智能转换"按钮上传文件
   ↓
3. 系统识别文件格式和内容
   ↓
4. 调用AI接口进行转换和优化
   ↓
5. 显示转换进度和状态
   ↓
6. 展示转换后的预览结果
   ↓
7. 用户确认或修改
   ↓
8. 保存到表单或直接创建
```

### 5. 技术架构

#### 5.1 前端组件
- **文件上传组件**：支持拖拽和点击上传
- **转换按钮**：触发转换流程
- **进度指示器**：显示转换进度
- **预览面板**：展示转换结果
- **编辑面板**：允许用户修改结果

#### 5.2 后端API
- `POST /api/v1/group-ai/scripts/convert` - 格式转换接口
- `POST /api/v1/group-ai/scripts/upload` - 文件上传接口
- `POST /api/v1/group-ai/scripts/optimize` - 内容优化接口

#### 5.3 AI服务集成
- 使用OpenAI GPT-4进行格式转换
- 使用OpenAI GPT-4进行内容优化
- 支持流式响应，实时显示转换进度

### 6. 数据安全和隐私保护

#### 6.1 数据安全措施
- 文件上传后立即处理，不长期存储
- 临时文件在处理完成后自动删除
- 使用HTTPS加密传输
- API密钥安全存储

#### 6.2 隐私保护
- 不上传敏感信息到第三方服务
- 处理完成后立即清除临时数据
- 支持本地处理模式（可选）
- 用户数据不用于模型训练

### 7. 错误处理

- 文件格式不支持：提示用户使用支持的格式
- 文件过大：限制文件大小（如10MB）
- 转换失败：提供详细错误信息和建议
- AI服务异常：提供降级方案（规则转换）

### 8. 性能优化

- 大文件分块处理
- 异步处理，不阻塞用户界面
- 缓存转换结果（可选）
- 支持批量转换

## 实现计划

### 阶段1：基础功能
1. 实现YAML格式转换API
2. 添加前端转换按钮
3. 实现基础预览功能

### 阶段2：多格式支持
1. 添加文件上传功能
2. 实现多种格式解析
3. 添加格式识别逻辑

### 阶段3：AI优化
1. 集成OpenAI API
2. 实现内容优化功能
3. 添加智能建议

### 阶段4：用户体验优化
1. 添加进度指示
2. 优化预览界面
3. 添加编辑功能

