# ğŸ” è„šæœ¬æ‰¾ä¸åˆ°é—®é¢˜ - è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `sudo bash scripts/setup_nginx_and_systemd.sh` æ—¶å‡ºç°é”™è¯¯ï¼š
```
bash: scripts/setup_nginx_and_systemd.sh: No such file or directory
```

## ğŸ” å¯èƒ½çš„åŸå› 

1. **è„šæœ¬æ–‡ä»¶è¿˜æ²¡æœ‰è¢«æ¨é€åˆ° GitHub**
2. **æœåŠ¡å™¨ä¸Šçš„ä»£ç æ²¡æœ‰æ­£ç¡®æ‹‰å–**
3. **æ–‡ä»¶è·¯å¾„ä¸æ­£ç¡®**
4. **Git åˆ†æ”¯ä¸ä¸€è‡´**

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³• 1: æ£€æŸ¥å¹¶æ‰‹åŠ¨æ‹‰å–è„šæœ¬æ–‡ä»¶ï¼ˆæ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
cd ~/liaotian

# 1. æ£€æŸ¥å½“å‰æ–‡ä»¶ç»“æ„
ls -la scripts/ | grep setup

# 2. ä» GitHub ç›´æ¥æ£€å‡ºè„šæœ¬æ–‡ä»¶
git fetch origin main
git checkout origin/main -- scripts/setup_nginx_and_systemd.sh

# 3. éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh scripts/setup_nginx_and_systemd.sh

# 4. æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/setup_nginx_and_systemd.sh

# 5. å†æ¬¡å°è¯•è¿è¡Œ
sudo bash scripts/setup_nginx_and_systemd.sh
```

### æ–¹æ³• 2: ç›´æ¥åˆ›å»ºè„šæœ¬æ–‡ä»¶

å¦‚æœ Git æ£€å‡ºå¤±è´¥ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼š

```bash
cd ~/liaotian

# åˆ›å»º scripts ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p scripts

# åˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼ˆå†…å®¹è§ä¸‹æ–‡ï¼‰
cat > scripts/setup_nginx_and_systemd.sh << 'EOFSCRIPT'
#!/bin/bash
# Setup Nginx and Systemd Services for Liaotian AI System

set -e

echo "========================================="
echo "Liaotian AI System - Nginx & Systemd Setup"
echo "========================================="
echo ""

# æ£€æŸ¥æ˜¯å¦ä»¥ root æƒé™è¿è¡Œ
if [ "$EUID" -ne 0 ]; then 
    echo "é”™è¯¯: è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬"
    echo "Usage: sudo bash scripts/setup_nginx_and_systemd.sh"
    exit 1
fi

# é¡¹ç›®è·¯å¾„
PROJECT_DIR="/home/ubuntu/liaotian"
NGINX_CONF_DIR="/etc/nginx/sites-available"
NGINX_ENABLED_DIR="/etc/nginx/sites-enabled"
SYSTEMD_DIR="/etc/systemd/system"

echo "=== æ­¥éª¤ 1: å®‰è£… Nginx ==="
if ! command -v nginx &> /dev/null; then
    echo "å®‰è£… Nginx..."
    apt-get update
    apt-get install -y nginx
    echo "âœ… Nginx å®‰è£…å®Œæˆ"
else
    echo "âœ… Nginx å·²å®‰è£…"
fi

echo ""
echo "=== æ­¥éª¤ 2: é…ç½® Nginx ==="

# åˆ›å»º Nginx é…ç½®æ–‡ä»¶
cat > "$NGINX_CONF_DIR/liaotian" << 'EOFNGINX'
upstream frontend {
    server localhost:3000;
    keepalive 64;
}

upstream backend {
    server localhost:8000;
    keepalive 64;
}

server {
    listen 80;
    server_name 165.154.233.55;
    client_max_body_size 50M;

    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    location /api {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /health {
        proxy_pass http://backend/health;
        access_log off;
    }

    location /docs {
        proxy_pass http://backend/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    access_log /var/log/nginx/liaotian-access.log;
    error_log /var/log/nginx/liaotian-error.log;
}
EOFNGINX

# åˆ›å»ºç¬¦å·é“¾æ¥
if [ ! -L "$NGINX_ENABLED_DIR/liaotian" ]; then
    ln -s "$NGINX_CONF_DIR/liaotian" "$NGINX_ENABLED_DIR/liaotian"
fi

# æµ‹è¯•é…ç½®
nginx -t && systemctl reload nginx
echo "âœ… Nginx é…ç½®å®Œæˆ"

echo ""
echo "=== æ­¥éª¤ 3: é…ç½® Systemd æœåŠ¡ ==="

# åˆ›å»ºå‰ç«¯æœåŠ¡æ–‡ä»¶
cat > "$SYSTEMD_DIR/liaotian-frontend.service" << 'EOFFRONTEND'
[Unit]
Description=Liaotian Frontend Service (Next.js)
After=network.target liaotian-backend.service
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="PATH=/usr/bin:/bin"
Environment="NODE_ENV=production"
Environment="PORT=3000"
ExecStart=/bin/bash -c 'if [ -d "/home/ubuntu/liaotian/saas-demo/.next/standalone" ]; then cd /home/ubuntu/liaotian/saas-demo/.next/standalone && PORT=3000 /usr/bin/node server.js; else cd /home/ubuntu/liaotian/saas-demo && /usr/bin/npm start; fi'
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOFFRONTEND

# åˆ›å»ºåç«¯æœåŠ¡æ–‡ä»¶
cat > "$SYSTEMD_DIR/liaotian-backend.service" << 'EOFBACKEND'
[Unit]
Description=Liaotian Backend API Service (FastAPI)
After=network.target
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/admin-backend
Environment="PATH=/usr/bin:/bin"
ExecStart=/usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --timeout-keep-alive 120
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOFBACKEND

# é‡æ–°åŠ è½½ systemd
systemctl daemon-reload
echo "âœ… Systemd æœåŠ¡æ–‡ä»¶å·²åˆ›å»º"

echo ""
echo "=== æ­¥éª¤ 4: å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡ ==="

# åœæ­¢æ—§æœåŠ¡
systemctl stop liaotian-frontend 2>/dev/null || true
systemctl stop liaotian-backend 2>/dev/null || true
pkill -f "next-server" 2>/dev/null || true
pkill -f "node.*next" 2>/dev/null || true
pkill -f "uvicorn" 2>/dev/null || true
sleep 3

# å¯ç”¨æœåŠ¡
systemctl enable liaotian-backend
systemctl enable liaotian-frontend

# å¯åŠ¨æœåŠ¡
systemctl start liaotian-backend
sleep 5
systemctl start liaotian-frontend
sleep 5

echo ""
echo "=== æ­¥éª¤ 5: éªŒè¯æœåŠ¡çŠ¶æ€ ==="
systemctl status liaotian-backend --no-pager -l
echo ""
systemctl status liaotian-frontend --no-pager -l

echo ""
echo "========================================="
echo "âœ… é…ç½®å®Œæˆï¼"
echo "========================================="
EOFSCRIPT

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/setup_nginx_and_systemd.sh

# è¿è¡Œè„šæœ¬
sudo bash scripts/setup_nginx_and_systemd.sh
```

### æ–¹æ³• 3: ä½¿ç”¨å®Œæ•´çš„ä¸€é”®å‘½ä»¤ï¼ˆæœ€ç®€å•ï¼‰

åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œè¿™ä¸ªé•¿å‘½ä»¤ï¼š

```bash
cd ~/liaotian && \
git fetch origin main && \
git checkout origin/main -- scripts/setup_nginx_and_systemd.sh deploy/systemd/*.service deploy/nginx/*.conf 2>/dev/null || \
echo "æ–‡ä»¶å¯èƒ½ä¸åœ¨ Git ä¸­ï¼Œç»§ç»­æ‰‹åŠ¨åˆ›å»º..." && \
mkdir -p scripts deploy/systemd deploy/nginx && \
chmod +x scripts/setup_nginx_and_systemd.sh 2>/dev/null || \
echo "è¯·ä½¿ç”¨æ–¹æ³• 2 ç›´æ¥åˆ›å»ºè„šæœ¬æ–‡ä»¶"
```

## ğŸ” è¯Šæ–­æ­¥éª¤

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œæ‰§è¡Œä»¥ä¸‹è¯Šæ–­å‘½ä»¤ï¼š

```bash
cd ~/liaotian

# 1. æ£€æŸ¥å½“å‰ç›®å½•
pwd
ls -la

# 2. æ£€æŸ¥ scripts ç›®å½•
ls -la scripts/ 2>/dev/null || echo "scripts ç›®å½•ä¸å­˜åœ¨"

# 3. æ£€æŸ¥ Git çŠ¶æ€
git status
git branch
git remote -v

# 4. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨è¿œç¨‹
git ls-tree -r origin/main --name-only | grep setup_nginx

# 5. å¼ºåˆ¶æ‹‰å–æ‰€æœ‰æ–‡ä»¶
git fetch origin main
git reset --hard origin/main
```

## ğŸ“ å¦‚æœè„šæœ¬ç¡®å®ä¸å­˜åœ¨

å¦‚æœè„šæœ¬æ–‡ä»¶ç¡®å®è¿˜æ²¡æœ‰æ¨é€åˆ° GitHubï¼Œä½ å¯ä»¥ï¼š

1. **ç­‰å¾… Git æ¨é€å®Œæˆ**ï¼šç¡®ä¿æœ¬åœ°æ–‡ä»¶å·²æäº¤å¹¶æ¨é€åˆ° GitHub
2. **ä½¿ç”¨æ‰‹åŠ¨é…ç½®**ï¼šå‚è€ƒ `docs/Nginxå’ŒSystemdé…ç½®å®Œæ•´æŒ‡å—.md` è¿›è¡Œæ‰‹åŠ¨é…ç½®
3. **ç›´æ¥å¤åˆ¶é…ç½®å†…å®¹**ï¼šä»æ–‡æ¡£ä¸­å¤åˆ¶é…ç½®å†…å®¹ï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–‡ä»¶

## âœ… éªŒè¯è„šæœ¬å­˜åœ¨

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯è„šæœ¬æ˜¯å¦å¯ç”¨ï¼š

```bash
cd ~/liaotian
ls -lh scripts/setup_nginx_and_systemd.sh
file scripts/setup_nginx_and_systemd.sh
head -5 scripts/setup_nginx_and_systemd.sh
```

å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°æ–‡ä»¶å¤§å°å’Œå†…å®¹ã€‚

---

**æœ€åæ›´æ–°**: 2025-12-07
