# æœå‹™å™¨ä¸Šæ­£ç¢ºé‡å•Ÿå’Œæ¸¬è©¦

> **æ—¥æœŸ**: 2025-12-01  
> **å•é¡Œ**: systemd æœå‹™ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹å‹•é‡å•Ÿ

---

## ğŸ” ç•¶å‰ç‹€æ³

- âŒ systemd æœå‹™ `smart-tg-backend.service` ä¸å­˜åœ¨
- âœ… å¾Œç«¯å¯èƒ½é€šéæ‰‹å‹•æ–¹å¼é‹è¡Œ
- éœ€è¦æ‰¾åˆ°é‹è¡Œä¸­çš„é€²ç¨‹ä¸¦é‡å•Ÿ

---

## ğŸš€ æ­£ç¢ºçš„é‡å•Ÿæ­¥é©Ÿ

### æ­¥é©Ÿ 1: æª¢æŸ¥ç•¶å‰å¾Œç«¯é€²ç¨‹

```bash
# æŸ¥æ‰¾ uvicorn é€²ç¨‹
ps aux | grep uvicorn | grep -v grep

# æˆ–æŸ¥æ‰¾ç«¯å£ 8000
lsof -i :8000 || netstat -tlnp | grep :8000
```

### æ­¥é©Ÿ 2: åœæ­¢ç¾æœ‰é€²ç¨‹

```bash
# æ–¹æ³•1: ä½¿ç”¨ pkill
pkill -f "uvicorn.*app.main:app"

# æ–¹æ³•2: ä½¿ç”¨ killï¼ˆå¦‚æœçŸ¥é“ PIDï¼‰
# kill <PID>

# ç­‰å¾…é€²ç¨‹åœæ­¢
sleep 3
```

### æ­¥é©Ÿ 3: ç¢ºèªé€²ç¨‹å·²åœæ­¢

```bash
ps aux | grep uvicorn | grep -v grep
# æ‡‰è©²æ²’æœ‰è¼¸å‡º
```

### æ­¥é©Ÿ 4: æ‰¾åˆ°å¾Œç«¯ç›®éŒ„ä¸¦å•Ÿå‹•

```bash
# æŸ¥æ‰¾é …ç›®ç›®éŒ„
find /opt -name "accounts.py" -path "*/group_ai/*" 2>/dev/null | head -1

# æˆ–å¸¸è¦‹è·¯å¾‘
cd /opt/group-ai/admin-backend  # å˜—è©¦è·¯å¾‘1
# æˆ–
cd /opt/smart-tg/admin-backend  # å˜—è©¦è·¯å¾‘2

# å•Ÿå‹•å¾Œç«¯ï¼ˆæ ¹æ“šå¯¦éš›è·¯å¾‘èª¿æ•´ï¼‰
# å¦‚æœæœ‰è™›æ“¬ç’°å¢ƒ
source ../.venv/bin/activate

# å•Ÿå‹•æœå‹™
nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
```

---

## ğŸ§ª æ­£ç¢ºçš„æ¸¬è©¦å‘½ä»¤

### ä¿®æ­£å¾Œçš„æ¸¬è©¦å‘½ä»¤

```bash
# ç²å– Token
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123" | \
  python3 -c "import sys, json; print(json.loads(sys.stdin.read()).get('access_token', ''))")

# æ¸¬è©¦è³¬è™Ÿç‹€æ…‹ç«¯é»ï¼ˆä¿®æ­£ç‰ˆæœ¬ - åˆ†é–‹è™•ç† HTTP ç‹€æ…‹ç¢¼å’ŒéŸ¿æ‡‰é«”ï¼‰
echo "=== æ¸¬è©¦è³¬è™Ÿç‹€æ…‹ç«¯é» ==="
RESPONSE=$(curl -s -w "\nHTTPSTATUS:%{http_code}" \
  -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/v1/group-ai/accounts/639454959591/status")

HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTPSTATUS" | cut -d: -f2)
BODY=$(echo "$RESPONSE" | sed '/HTTPSTATUS/d')

echo "HTTP ç‹€æ…‹ç¢¼: $HTTP_STATUS"
echo ""
echo "éŸ¿æ‡‰å…§å®¹:"
echo "$BODY" | python3 -m json.tool
```

### æ›´ç°¡å–®çš„æ¸¬è©¦å‘½ä»¤

```bash
# ç²å– Token
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123" | \
  python3 -c "import sys, json; print(json.loads(sys.stdin.read()).get('access_token', ''))")

# æ¸¬è©¦ï¼ˆåªé¡¯ç¤º HTTP ç‹€æ…‹ç¢¼å’ŒéŸ¿æ‡‰ï¼‰
echo "æ¸¬è©¦è³¬è™Ÿç‹€æ…‹ç«¯é»..."
curl -s -o /tmp/response.json -w "HTTPç‹€æ…‹ç¢¼: %{http_code}\n" \
  -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/v1/group-ai/accounts/639454959591/status"

echo ""
echo "éŸ¿æ‡‰å…§å®¹:"
cat /tmp/response.json | python3 -m json.tool
```

---

## âœ… ä¸€éµé‡å•Ÿå’Œæ¸¬è©¦è…³æœ¬

```bash
#!/bin/bash
# ä¸€éµé‡å•Ÿå’Œæ¸¬è©¦

echo "ã€1ã€‘åœæ­¢ç¾æœ‰å¾Œç«¯é€²ç¨‹..."
pkill -f "uvicorn.*app.main:app" 2>/dev/null
sleep 3

echo "ã€2ã€‘æŸ¥æ‰¾ä¸¦å•Ÿå‹•å¾Œç«¯..."
# å˜—è©¦å¸¸è¦‹è·¯å¾‘
BACKEND_DIR=""
for path in "/opt/group-ai/admin-backend" "/opt/smart-tg/admin-backend" "$HOME/group-ai/admin-backend"; do
    if [ -f "$path/app/main.py" ]; then
        BACKEND_DIR="$path"
        break
    fi
done

if [ -z "$BACKEND_DIR" ]; then
    echo "âŒ æœªæ‰¾åˆ°å¾Œç«¯ç›®éŒ„ï¼Œè«‹æ‰‹å‹•æŒ‡å®š"
    exit 1
fi

echo "æ‰¾åˆ°å¾Œç«¯ç›®éŒ„: $BACKEND_DIR"
cd "$BACKEND_DIR"

# å•Ÿå‹•æœå‹™
if [ -f "../.venv/bin/activate" ]; then
    source ../.venv/bin/activate
elif [ -f ".venv/bin/activate" ]; then
    source .venv/bin/activate
fi

nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
BACKEND_PID=$!
echo "å¾Œç«¯å·²å•Ÿå‹• (PID: $BACKEND_PID)"
sleep 5

echo "ã€3ã€‘æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹..."
for i in {1..10}; do
    if curl -s http://localhost:8000/health > /dev/null 2>&1; then
        echo "âœ… å¾Œç«¯æœå‹™æ­£å¸¸"
        break
    else
        if [ $i -eq 10 ]; then
            echo "âš ï¸ å¾Œç«¯å¯èƒ½æœªæ­£å¸¸å•Ÿå‹•ï¼Œæª¢æŸ¥æ—¥èªŒ:"
            tail -20 /tmp/backend.log
            exit 1
        fi
        sleep 2
    fi
done

echo ""
echo "ã€4ã€‘æ¸¬è©¦è³¬è™Ÿç‹€æ…‹ç«¯é»..."
TOKEN=$(curl -s -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123" | \
  python3 -c "import sys, json; print(json.loads(sys.stdin.read()).get('access_token', ''))")

if [ -z "$TOKEN" ]; then
    echo "âŒ ç„¡æ³•ç²å– Token"
    exit 1
fi

echo "âœ… Token ç²å–æˆåŠŸ"
echo ""

RESPONSE=$(curl -s -w "\nHTTPSTATUS:%{http_code}" \
  -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8000/api/v1/group-ai/accounts/639454959591/status")

HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTPSTATUS" | cut -d: -f2)
BODY=$(echo "$RESPONSE" | sed '/HTTPSTATUS/d')

echo "HTTP ç‹€æ…‹ç¢¼: $HTTP_STATUS"
echo ""
echo "éŸ¿æ‡‰å…§å®¹:"
echo "$BODY" | python3 -m json.tool

if [ "$HTTP_STATUS" = "200" ]; then
    echo ""
    echo "âœ… ä¿®å¾©é©—è­‰æˆåŠŸï¼"
else
    echo ""
    echo "âš ï¸ HTTP ç‹€æ…‹ç¢¼: $HTTP_STATUSï¼ˆé æœŸæ˜¯ 200ï¼‰"
fi
```

---

**è«‹å…ˆæª¢æŸ¥ç•¶å‰å¾Œç«¯é€²ç¨‹ç‹€æ…‹ï¼Œç„¶å¾Œä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•é‡å•Ÿï¼**
