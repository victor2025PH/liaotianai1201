# 回復質量優化功能實現說明

> **完成日期**: 2025-11-30  
> **狀態**: ✅ 已完成

---

## 📋 功能概述

回復質量優化功能旨在提升 AI 回復的多樣性，避免重複使用相同的回復，讓對話更加自然和多樣化。

---

## ✅ 實現的功能

### 1. 回復歷史追蹤

**功能**:
- ✅ 記錄每個賬號在每個群組中的回復歷史
- ✅ 記錄使用的模板ID
- ✅ 記錄回復時間
- ✅ 自動清理舊歷史（保留最近50條）

**實現**:
- `ReplyHistory` 數據類存儲回復信息
- `reply_history` 字典存儲歷史記錄

---

### 2. 重複檢測機制

**功能**:
- ✅ 檢查回復是否在時間窗口內重複使用
- ✅ 使用文本相似度算法檢測重複
- ✅ 可配置的重複檢查時間窗口（默認5分鐘）
- ✅ 可配置的相似度閾值（默認0.8）

**實現**:
- `is_duplicate()` 方法檢測重複
- `_calculate_similarity()` 方法計算文本相似度
- 使用 Jaccard 相似度算法

---

### 3. 智能回復選擇

**功能**:
- ✅ 優先選擇未使用過的回復模板
- ✅ 優先選擇未在時間窗口內使用過的回復
- ✅ 如果所有回復都重複，降級為隨機選擇
- ✅ 支持模板使用頻率追蹤

**實現**:
- `select_best_response()` 方法智能選擇回復
- 分類回復為：未使用、已使用但過期、重複
- 優先選擇策略

---

### 4. 回復統計

**功能**:
- ✅ 統計總回復數
- ✅ 統計唯一模板數
- ✅ 統計最近回復數
- ✅ 計算重複率

**實現**:
- `get_reply_stats()` 方法獲取統計信息

---

## 🔧 技術實現

### 核心類

#### `ReplyQualityManager`

```python
class ReplyQualityManager:
    def __init__(
        self,
        max_history_per_account: int = 50,
        duplicate_check_window: int = 300,  # 5分鐘
        similarity_threshold: float = 0.8
    )
```

**主要方法**:
- `record_reply()` - 記錄回復
- `is_duplicate()` - 檢測重複
- `select_best_response()` - 智能選擇回復
- `get_reply_stats()` - 獲取統計信息
- `clear_history()` - 清理歷史

---

### 集成點

#### 1. ScriptEngine 集成

**修改**:
- `ScriptEngine.__init__()` 接受 `reply_quality_manager` 參數
- `_select_response()` 使用質量管理器選擇回復
- 回復生成後記錄到質量管理器

**效果**:
- 智能選擇回復模板
- 避免重複使用相同回復

---

#### 2. ServiceManager 集成

**修改**:
- 初始化 `ReplyQualityManager` 實例
- 傳遞給 `ScriptEngine` 實例

**效果**:
- 統一管理回復質量
- 共享回復歷史

---

## 📊 使用示例

### 基本使用

```python
# 在 ServiceManager 中自動初始化
service_manager = ServiceManager()
# ReplyQualityManager 已自動初始化並傳遞給 ScriptEngine

# 回復會自動記錄和檢查重複
reply = await script_engine.process_message(...)
# 回復已自動記錄到質量管理器
```

### 獲取統計信息

```python
stats = service_manager.reply_quality_manager.get_reply_stats(
    account_id="account_001",
    group_id=-1001234567890
)

print(f"總回復數: {stats['total_replies']}")
print(f"唯一模板數: {stats['unique_templates']}")
print(f"重複率: {stats['duplicate_rate']:.2%}")
```

### 清理歷史

```python
# 清理特定賬號和群組的歷史
service_manager.reply_quality_manager.clear_history(
    account_id="account_001",
    group_id=-1001234567890
)

# 清理所有歷史
service_manager.reply_quality_manager.clear_history()
```

---

## ⚙️ 配置參數

### 初始化參數

| 參數 | 類型 | 默認值 | 說明 |
|------|------|--------|------|
| `max_history_per_account` | int | 50 | 每個賬號保留的最大歷史記錄數 |
| `duplicate_check_window` | int | 300 | 重複檢查時間窗口（秒），5分鐘內不重複 |
| `similarity_threshold` | float | 0.8 | 相似度閾值（0-1），超過此值視為重複 |

### 可調整設置

在 `ServiceManager.__init__()` 中可以調整：

```python
self.reply_quality_manager = ReplyQualityManager(
    max_history_per_account=100,  # 增加歷史記錄數
    duplicate_check_window=600,   # 增加到10分鐘
    similarity_threshold=0.7      # 降低閾值，更嚴格
)
```

---

## 📈 效果預期

### 改進前

- ❌ 可能重複使用相同的回復
- ❌ 回復缺乏多樣性
- ❌ 用戶可能感到單調

### 改進後

- ✅ 自動避免重複回復
- ✅ 優先使用未使用過的回復
- ✅ 回復更加多樣化
- ✅ 提升用戶體驗

---

## 🔍 工作原理

### 回復選擇流程

```
1. 接收到回復請求
   ↓
2. 獲取所有可用的回復模板
   ↓
3. 使用 ReplyQualityManager 選擇最佳回復
   ├─ 檢查每個回復是否重複
   ├─ 分類為：未使用 / 已過期 / 重複
   └─ 優先選擇未使用的
   ↓
4. 生成回復文本
   ↓
5. 記錄回復到質量管理器
   ↓
6. 返回回復
```

### 重複檢測流程

```
1. 計算回復文本的相似度
   ↓
2. 檢查時間窗口內的回復歷史
   ↓
3. 如果相似度 >= 閾值 → 視為重複
   ↓
4. 跳過重複的回復
```

---

## ✅ 完成狀態

| 功能 | 狀態 | 完成度 |
|------|------|--------|
| **回復歷史追蹤** | ✅ 已完成 | 100% |
| **重複檢測機制** | ✅ 已完成 | 100% |
| **智能回復選擇** | ✅ 已完成 | 100% |
| **回復統計** | ✅ 已完成 | 100% |
| **集成到 ScriptEngine** | ✅ 已完成 | 100% |
| **集成到 ServiceManager** | ✅ 已完成 | 100% |

**總體完成度**: **100%** ✅

---

## 📝 後續優化建議（可選）

### 短期優化

1. **更精確的相似度算法**
   - 使用編輯距離（Levenshtein Distance）
   - 使用語義相似度（如果接入 NLP 模型）

2. **智能模板權重**
   - 根據回復效果調整模板權重
   - 優先使用效果好的模板

### 長期優化

1. **用戶反饋學習**
   - 記錄用戶對回復的反饋
   - 根據反饋調整選擇策略

2. **A/B 測試支持**
   - 支持不同選擇策略的對比
   - 統計分析不同策略的效果

---

**完成時間**: 2025-11-30  
**實現者**: AI Assistant  
**文檔版本**: v1.0  
**狀態**: ✅ 功能已完成並集成
