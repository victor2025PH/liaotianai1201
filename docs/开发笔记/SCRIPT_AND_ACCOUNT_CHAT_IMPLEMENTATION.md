# åŠ‡æœ¬å’Œå¸³è™Ÿç¾¤çµ„èŠå¤©åŠŸèƒ½å¯¦ç¾ç¸½çµ

> **æ›´æ–°æ—¥æœŸ**: 2025-01-07  
> **ç‹€æ…‹**: âœ… å·²å®Œæˆ

---

## æ¦‚è¿°

æœ¬æ¬¡é–‹ç™¼å®Œæˆäº†åŠ‡æœ¬å’Œå¸³è™Ÿåœ¨ç¾¤çµ„è£¡èŠå¤©çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç¢ºä¿å¸³è™Ÿå•Ÿå‹•æ™‚èƒ½è‡ªå‹•åŠ è¼‰åŠ‡æœ¬ã€åˆå§‹åŒ–åŠ‡æœ¬å¼•æ“å’Œå°è©±ç®¡ç†å™¨ï¼Œä¸¦æ­£ç¢ºç›£è½ç¾¤çµ„æ¶ˆæ¯é€²è¡Œæ™ºèƒ½å›å¾©ã€‚

---

## å®Œæˆçš„åŠŸèƒ½

### 1. âœ… æœå‹™ç®¡ç†å™¨ (ServiceManager)

**æ–‡ä»¶**: `group_ai_service/service_manager.py`

**åŠŸèƒ½**:
- çµ±ä¸€ç®¡ç†åŠ‡æœ¬å¼•æ“ã€å°è©±ç®¡ç†å™¨å’Œæœƒè©±æ± 
- å¾æ–‡ä»¶ç³»çµ±æˆ–æ•¸æ“šåº«åŠ è¼‰åŠ‡æœ¬
- è‡ªå‹•åˆå§‹åŒ–å¸³è™Ÿçš„æœå‹™ï¼ˆåŠ‡æœ¬å¼•æ“å’Œå°è©±ç®¡ç†å™¨ï¼‰
- ç®¡ç†å¸³è™Ÿçš„å®Œæ•´å•Ÿå‹•æµç¨‹

**æ ¸å¿ƒæ–¹æ³•**:
```python
# ç²å–åŠ‡æœ¬ï¼ˆæ”¯æŒå¾æ–‡ä»¶ç³»çµ±æˆ–æ•¸æ“šåº«ï¼‰
get_script(script_id: str, yaml_content: Optional[str] = None) -> Optional[Script]

# åˆå§‹åŒ–å¸³è™Ÿçš„æœå‹™
initialize_account_services(account_id: str, account_config: AccountConfig, script_yaml_content: Optional[str] = None) -> bool

# å•Ÿå‹•å¸³è™Ÿï¼ˆå®Œæ•´æµç¨‹ï¼‰
start_account(account_id: str, script_yaml_content: Optional[str] = None) -> bool
```

### 2. âœ… å¸³è™Ÿå•Ÿå‹•æµç¨‹å®Œå–„

**æ›´æ–°**: `admin-backend/app/api/group_ai/accounts.py`

**æ”¹é€²**:
- å¸³è™Ÿå•Ÿå‹•æ™‚è‡ªå‹•å¾æ•¸æ“šåº«åŠ è¼‰åŠ‡æœ¬
- è‡ªå‹•åˆå§‹åŒ–åŠ‡æœ¬å¼•æ“å’Œå°è©±ç®¡ç†å™¨
- è‡ªå‹•å•Ÿå‹•æœƒè©±æ± çš„æ¶ˆæ¯ç›£è½

**å•Ÿå‹•æµç¨‹**:
1. å¾æ•¸æ“šåº«ç²å–åŠ‡æœ¬ YAML å…§å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
2. åˆå§‹åŒ–åŠ‡æœ¬å¼•æ“ï¼ˆåŠ è¼‰åŠ‡æœ¬ä¸¦ç‚ºå¸³è™Ÿå‰µå»ºç‹€æ…‹ï¼‰
3. åˆå§‹åŒ–å°è©±ç®¡ç†å™¨ï¼ˆè¨»å†ŠåŠ‡æœ¬å¼•æ“å’Œç¾¤çµ„ä¸Šä¸‹æ–‡ï¼‰
4. å•Ÿå‹• Telegram é€£æ¥
5. å•Ÿå‹•æœƒè©±æ± çš„æ¶ˆæ¯ç›£è½

### 3. âœ… æœƒè©±æ± æ”¹é€²

**æ›´æ–°**: `group_ai_service/session_pool.py`

**æ”¹é€²**:
- æ–°å¢ `start_monitoring_account()` æ–¹æ³•ï¼Œæ”¯æŒç‚ºæ–°å•Ÿå‹•çš„å¸³è™Ÿå•Ÿå‹•æ¶ˆæ¯ç›£è½
- ç¢ºä¿å¸³è™Ÿå•Ÿå‹•å¾Œèƒ½ç«‹å³é–‹å§‹ç›£è½ç¾¤çµ„æ¶ˆæ¯

**æ¶ˆæ¯è™•ç†æµç¨‹**:
1. æ¥æ”¶ç¾¤çµ„æ¶ˆæ¯
2. æª¢æŸ¥æ˜¯å¦åœ¨ç›£è½çš„ç¾¤çµ„åˆ—è¡¨ä¸­
3. èª¿ç”¨å°è©±ç®¡ç†å™¨è™•ç†æ¶ˆæ¯
4. æ ¹æ“šåŠ‡æœ¬ç”Ÿæˆå›å¾©
5. ç™¼é€å›å¾©åˆ°ç¾¤çµ„

---

## æ¶æ§‹è¨­è¨ˆ

### æ•¸æ“šæµ

```
ç¾¤çµ„æ¶ˆæ¯
  â†“
ExtendedSessionPool (æœƒè©±æ± )
  â†“
DialogueManager (å°è©±ç®¡ç†å™¨)
  â†“
ScriptEngine (åŠ‡æœ¬å¼•æ“)
  â†“
ç”Ÿæˆå›å¾©
  â†“
ç™¼é€åˆ°ç¾¤çµ„
```

### æœå‹™é—œä¿‚

```
ServiceManager (æœå‹™ç®¡ç†å™¨)
  â”œâ”€â”€ AccountManager (å¸³è™Ÿç®¡ç†å™¨)
  â”œâ”€â”€ ScriptParser (åŠ‡æœ¬è§£æå™¨)
  â”œâ”€â”€ ScriptEngine (åŠ‡æœ¬å¼•æ“)
  â”œâ”€â”€ DialogueManager (å°è©±ç®¡ç†å™¨)
  â””â”€â”€ ExtendedSessionPool (æœƒè©±æ± )
```

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. å‰µå»ºå¸³è™Ÿ

```python
# é€šé API
POST /api/v1/group-ai/accounts/
{
    "account_id": "account_001",
    "session_file": "sessions/account1.session",
    "script_id": "daily_chat",
    "group_ids": [-1001234567890]
}
```

### 2. å•Ÿå‹•å¸³è™Ÿ

```python
# é€šé API
POST /api/v1/group-ai/accounts/account_001/start

# ç³»çµ±æœƒè‡ªå‹•ï¼š
# 1. å¾æ•¸æ“šåº«æˆ–æ–‡ä»¶ç³»çµ±åŠ è¼‰åŠ‡æœ¬ "daily_chat"
# 2. åˆå§‹åŒ–åŠ‡æœ¬å¼•æ“
# 3. åˆå§‹åŒ–å°è©±ç®¡ç†å™¨
# 4. å•Ÿå‹• Telegram é€£æ¥
# 5. å•Ÿå‹•æ¶ˆæ¯ç›£è½
```

### 3. å¸³è™Ÿè‡ªå‹•å›å¾©

ç•¶ç¾¤çµ„ä¸­æœ‰æ–°æ¶ˆæ¯æ™‚ï¼š
1. æœƒè©±æ± æ¥æ”¶æ¶ˆæ¯
2. å°è©±ç®¡ç†å™¨åˆ¤æ–·æ˜¯å¦éœ€è¦å›å¾©
3. åŠ‡æœ¬å¼•æ“æ ¹æ“šè§¸ç™¼æ¢ä»¶åŒ¹é…å ´æ™¯
4. ç”Ÿæˆå›å¾©å…§å®¹
5. ç™¼é€åˆ°ç¾¤çµ„

---

## åŠ‡æœ¬æ ¼å¼

åŠ‡æœ¬ä½¿ç”¨ YAML æ ¼å¼ï¼Œç¤ºä¾‹ï¼š

```yaml
script_id: daily_chat
version: 1.0
description: æ—¥å¸¸èŠå¤©åŠ‡æœ¬

scenes:
  - id: greeting
    triggers:
      - type: keyword
        keywords: ["ä½ å¥½", "hello", "hi"]
    responses:
      - template: "ä½ å¥½ï¼å¾ˆé«˜èˆˆèªè­˜ä½  ğŸ˜Š"
    next_scene: conversation

  - id: conversation
    triggers:
      - type: message
        min_length: 5
    responses:
      - template: "{{contextual_reply}}"
        ai_generate: true
        context_window: 10
```

---

## æ¸¬è©¦å»ºè­°

### 1. æ¸¬è©¦å¸³è™Ÿå•Ÿå‹•

```bash
# 1. å‰µå»ºå¸³è™Ÿ
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/ \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "test_001",
    "session_file": "sessions/test.session",
    "script_id": "daily_chat",
    "group_ids": [-1001234567890]
  }'

# 2. å•Ÿå‹•å¸³è™Ÿ
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/test_001/start

# 3. æª¢æŸ¥ç‹€æ…‹
curl http://localhost:8000/api/v1/group-ai/accounts/test_001/status
```

### 2. æ¸¬è©¦ç¾¤çµ„èŠå¤©

1. åœ¨æŒ‡å®šçš„ Telegram ç¾¤çµ„ä¸­ç™¼é€æ¶ˆæ¯ï¼ˆä¾‹å¦‚ï¼š"ä½ å¥½"ï¼‰
2. æª¢æŸ¥å¸³è™Ÿæ˜¯å¦è‡ªå‹•å›å¾©
3. æŸ¥çœ‹æ—¥èªŒç¢ºèªæ¶ˆæ¯è™•ç†æµç¨‹

---

## æ³¨æ„äº‹é …

1. **Session æ–‡ä»¶**: ç¢ºä¿ `sessions/` ç›®éŒ„ä¸‹æœ‰æœ‰æ•ˆçš„ `.session` æ–‡ä»¶
2. **åŠ‡æœ¬æ–‡ä»¶**: åŠ‡æœ¬å¯ä»¥å­˜å„²åœ¨æ•¸æ“šåº«æˆ–æ–‡ä»¶ç³»çµ±ï¼ˆ`ai_models/group_scripts/`ï¼‰
3. **ç¾¤çµ„ ID**: ç¢ºä¿å¸³è™Ÿå·²åŠ å…¥æŒ‡å®šçš„ç¾¤çµ„
4. **API æ†‘è­‰**: ç¢ºä¿å·²é…ç½® `TELEGRAM_API_ID` å’Œ `TELEGRAM_API_HASH`

---

## å¾ŒçºŒæ”¹é€²å»ºè­°

1. **åŠ‡æœ¬ç†±æ›´æ–°**: æ”¯æŒåœ¨ä¸é‡å•Ÿå¸³è™Ÿçš„æƒ…æ³ä¸‹æ›´æ–°åŠ‡æœ¬
2. **å¤šåŠ‡æœ¬æ”¯æŒ**: æ”¯æŒå¸³è™Ÿåœ¨ä¸åŒç¾¤çµ„ä½¿ç”¨ä¸åŒåŠ‡æœ¬
3. **å›å¾©çµ±è¨ˆ**: è¨˜éŒ„å›å¾©æˆåŠŸç‡ã€è§¸ç™¼å ´æ™¯çµ±è¨ˆç­‰
4. **éŒ¯èª¤è™•ç†**: å¢å¼·éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶
5. **æ€§èƒ½å„ªåŒ–**: å„ªåŒ–å¤§é‡å¸³è™Ÿä¸¦è¡Œé‹è¡Œæ™‚çš„è³‡æºä½¿ç”¨

---

## ç›¸é—œæ–‡ä»¶

- `group_ai_service/service_manager.py` - æœå‹™ç®¡ç†å™¨
- `group_ai_service/session_pool.py` - æœƒè©±æ± 
- `group_ai_service/dialogue_manager.py` - å°è©±ç®¡ç†å™¨
- `group_ai_service/script_engine.py` - åŠ‡æœ¬å¼•æ“
- `admin-backend/app/api/group_ai/accounts.py` - å¸³è™Ÿç®¡ç† API
- `ai_models/group_scripts/daily_chat.yaml` - ç¤ºä¾‹åŠ‡æœ¬

---

**æœ€å¾Œæ›´æ–°**: 2025-01-07

