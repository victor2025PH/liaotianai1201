# 服务器和账号分配问题修复报告

## 问题描述

1. **服务器启动失败**：los-angeles 和 manila 显示"不存在"
   - 原因：代码检查的是 `systemctl is-active group-ai-worker`，但实际部署没有创建 systemd 服务
   - 实际运行的是直接执行 `main.py` 进程

2. **账号数统计不准确**：
   - worker-01: 7/5（超标）
   - los-angeles: 8/5（超标）
   - manila: 8/5（超标）
   - 原因：统计的是文件系统中的 session 文件数量，可能包含旧文件或重复文件

3. **账号分配问题**：
   - 总共只有 8 个账号，但显示的总数远超 8 个
   - 需要智能分配功能，确保每个账号只在一个服务器上
   - 需要手动调整功能

## 修复方案

### 1. 修改服务器状态检查

**文件**: `admin-backend/app/api/group_ai/servers.py`

**修改内容**:
- 将 `systemctl is-active group-ai-worker` 改为 `pgrep -f "python.*main.py"`
- 检查进程是否运行，而不是 systemd 服务

**代码变更**:
```python
# 旧代码
stdin, stdout, stderr = ssh.exec_command('systemctl is-active group-ai-worker 2>/dev/null || echo "inactive"')

# 新代码
stdin, stdout, stderr = ssh.exec_command('pgrep -f "python.*main.py" > /dev/null && echo "active" || echo "inactive"')
```

### 2. 修改账号数统计

**修改内容**:
- 优先从数据库统计账号数（`GroupAIAccount.server_id == node_id`）
- 同时检查进程数和文件数，取较大值作为备用
- 确保统计准确性

**代码变更**:
```python
# 从数据库统计（优先）
if db:
    db_count = db.query(GroupAIAccount).filter(
        GroupAIAccount.server_id == node_id
    ).count()
    accounts_count = max(db_count, file_based_count)
```

### 3. 修改服务器操作

**修改内容**:
- `start`: 启动 `main.py` 进程
- `stop`: 停止所有 `main.py` 进程（`pkill -f "python.*main.py"`）
- `restart`: 先停止再启动
- `status`: 检查进程状态

**代码变更**:
```python
if action == "start":
    cmd = f'cd {deploy_dir} && nohup python3 main.py > logs/main.log 2>&1 &'
elif action == "stop":
    cmd = 'pkill -f "python.*main.py"'
elif action == "restart":
    cmd = 'pkill -f "python.*main.py"; sleep 2; cd {deploy_dir} && nohup python3 main.py > logs/main.log 2>&1 &'
```

### 4. 创建账号分配管理API

**新文件**: `admin-backend/app/api/group_ai/account_allocation.py`

**功能**:
1. **自动分配** (`POST /api/v1/group-ai/account-allocation/auto`)
   - `balanced`: 平衡分配，尽量让每个服务器负载均衡
   - `round_robin`: 轮询分配，依次分配给每个服务器
   - `least_loaded`: 最少负载优先，总是分配给当前负载最少的服务器

2. **批量手动分配** (`POST /api/v1/group-ai/account-allocation/batch`)
   - 支持批量指定账号到服务器
   - 验证服务器容量限制
   - 确保不超出最大账号数

3. **分配摘要** (`GET /api/v1/group-ai/account-allocation/summary`)
   - 显示每个服务器的账号分配情况
   - 显示总账号数、已分配数、未分配数
   - 显示每个服务器的使用率

## API 使用示例

### 自动分配（平衡策略）

```bash
POST /api/v1/group-ai/account-allocation/auto
{
  "strategy": "balanced"
}
```

### 批量手动分配

```bash
POST /api/v1/group-ai/account-allocation/batch
{
  "allocations": [
    {"account_id": "639277356155", "server_id": "worker-01"},
    {"account_id": "639277333688", "server_id": "worker-01"},
    {"account_id": "639277356598", "server_id": "los-angeles"},
    {"account_id": "639641837416", "server_id": "los-angeles"},
    {"account_id": "639652840998", "server_id": "los-angeles"},
    {"account_id": "639457597211", "server_id": "manila"},
    {"account_id": "639679410504", "server_id": "manila"},
    {"account_id": "639641842001", "server_id": "manila"}
  ]
}
```

### 获取分配摘要

```bash
GET /api/v1/group-ai/account-allocation/summary
```

响应示例:
```json
{
  "total_accounts": 8,
  "unallocated": 0,
  "allocated": 8,
  "servers": {
    "worker-01": {
      "current": 2,
      "max": 5,
      "available": 3,
      "usage_percent": 40.0
    },
    "los-angeles": {
      "current": 3,
      "max": 5,
      "available": 2,
      "usage_percent": 60.0
    },
    "manila": {
      "current": 3,
      "max": 5,
      "available": 2,
      "usage_percent": 60.0
    }
  }
}
```

## 建议的分配方案

基于 8 个账号和 3 个服务器（每个最多 5 个账号）：

### 方案 1: 平衡分配（推荐）
- worker-01: 3 个账号
- los-angeles: 3 个账号
- manila: 2 个账号

### 方案 2: 均匀分配
- worker-01: 3 个账号
- los-angeles: 2 个账号
- manila: 3 个账号

## 下一步操作

1. **重启后端服务**以应用更改
2. **清理数据库**：检查并清理重复的账号记录
3. **执行自动分配**：使用 API 自动分配所有账号
4. **验证分配结果**：检查每个服务器的账号数是否正确
5. **前端集成**：在前端页面添加账号分配管理界面

## 注意事项

1. **数据库一致性**：确保数据库中的 `server_id` 字段正确反映账号的实际部署位置
2. **进程管理**：服务器操作现在直接操作进程，需要确保有足够的权限
3. **容量限制**：手动分配时会验证服务器容量，防止超出限制
4. **唯一性保证**：每个账号只能分配到一个服务器，避免重复运行

## 相关文件

- `admin-backend/app/api/group_ai/servers.py` - 服务器管理API（已修改）
- `admin-backend/app/api/group_ai/account_allocation.py` - 账号分配管理API（新建）
- `admin-backend/app/api/group_ai/__init__.py` - 路由注册（已更新）
- `data/master_config.json` - 服务器配置文件

