# 服务器状态加载性能优化报告

## 优化时间
2024年11月20日

## 问题分析

### 原始实现的问题
1. **串行处理**：每个服务器都是串行检查的，一个接一个
2. **SSH 连接超时**：每个服务器最多等待 5 秒
3. **多个 SSH 命令**：每个服务器需要执行 3 个独立的 SSH 命令
   - 检查进程状态
   - 统计进程数
   - 统计文件数
4. **性能瓶颈**：
   - 3 个服务器 × 5 秒超时 = 最多 15 秒
   - 每个服务器 3 个 SSH 命令 = 9 次网络往返
   - 如果某个服务器连接慢，会阻塞整个请求

## 优化方案

### 1. 并发处理
- **优化前**：串行处理，逐个检查服务器
- **优化后**：使用 `asyncio.gather` 并发检查所有服务器
- **效果**：3 个服务器并行处理，总时间从最多 15 秒降低到 3-5 秒

### 2. 合并 SSH 命令
- **优化前**：每个服务器执行 3 个独立的 SSH 命令
- **优化后**：合并为 1 个命令，一次性获取所有信息
- **效果**：减少网络往返次数，从 9 次降低到 3 次

### 3. 优化超时时间
- **优化前**：SSH 连接超时 5 秒，命令超时 10 秒
- **优化后**：SSH 连接超时 3 秒，命令超时 3 秒，总超时 10 秒
- **效果**：快速失败，避免长时间等待

### 4. 添加总超时控制
- **新增**：设置总超时时间为 10 秒
- **效果**：即使某个服务器很慢，也不会阻塞整个请求超过 10 秒

## 代码变更

### 1. list_servers 函数优化
```python
# 优化前：串行处理
for node_id, config in servers_config.items():
    status = await get_server_status(node_id, config, db)
    servers.append(status)

# 优化后：并发处理
tasks = [
    get_server_status_safe(node_id, config)
    for node_id, config in servers_config.items()
]
servers = await asyncio.wait_for(
    asyncio.gather(*tasks),
    timeout=10.0
)
```

### 2. get_server_status 函数优化
```python
# 优化前：3 个独立的 SSH 命令
ssh.exec_command('pgrep -f "python.*main.py" > /dev/null && echo "active" || echo "inactive"')
ssh.exec_command('pgrep -f "python.*main.py" | wc -l')
ssh.exec_command(f'ls -1 {deploy_dir}/sessions/*.session 2>/dev/null | wc -l')

# 优化后：1 个合并的命令
combined_command = f'''
if pgrep -f "python.*main.py" > /dev/null; then
    echo "active"
else
    echo "inactive"
fi
echo "---SEPARATOR---"
pgrep -f "python.*main.py" | wc -l
echo "---SEPARATOR---"
ls -1 {deploy_dir}/sessions/*.session 2>/dev/null | wc -l
'''
ssh.exec_command(combined_command, timeout=3)
```

## 性能对比

### 优化前
- **串行处理**：3 个服务器 × 5 秒 = 最多 15 秒
- **SSH 命令数**：3 个服务器 × 3 个命令 = 9 次网络往返
- **实际测试**：通常需要 10-15 秒

### 优化后
- **并发处理**：3 个服务器并行，最多 3-5 秒
- **SSH 命令数**：3 个服务器 × 1 个命令 = 3 次网络往返
- **预期效果**：通常只需要 3-5 秒

### 性能提升
- **响应时间**：从 10-15 秒降低到 3-5 秒（提升 60-70%）
- **网络往返**：从 9 次降低到 3 次（减少 67%）
- **用户体验**：显著改善，页面加载更快

## 建议

1. **继续监控**：观察实际运行中的性能表现
2. **添加缓存**：可以考虑添加短期缓存（如 5-10 秒），避免频繁检查
3. **错误处理**：优化错误处理，确保部分服务器失败不影响整体响应
4. **日志记录**：记录每个服务器的检查时间，便于进一步优化

