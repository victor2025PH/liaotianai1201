# æœå‹™å™¨ä¸Šä¸€éµä¿®å¾©å‘½ä»¤

> **æ—¥æœŸ**: 2025-12-01

---

## ğŸš€ ä¸€éµä¿®å¾©ï¼ˆç›´æ¥åŸ·è¡Œï¼‰

åœ¨æœå‹™å™¨ä¸ŠåŸ·è¡Œä»¥ä¸‹å‘½ä»¤é€²è¡Œä¿®å¾©ï¼š

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend

# å‚™ä»½åŸæ–‡ä»¶
cp app/api/group_ai/accounts.py app/api/group_ai/accounts.py.bak

# ä½¿ç”¨ Python ç›´æ¥ä¿®å¾©ï¼ˆæˆ‘æœƒæä¾›å®Œæ•´çš„ Python ä¸€è¡Œå‘½ä»¤ï¼‰
python3 << 'PYTHON_EOF'
import re

file_path = 'app/api/group_ai/accounts.py'

# è®€å–æ–‡ä»¶
with open(file_path, 'r', encoding='utf-8') as f:
    content = f.read()

# ä¿®å¾©å¾Œçš„å‡½æ•¸ä»£ç¢¼
fixed_function = '''@router.get("/{account_id}/status", response_model=AccountStatusResponse)
async def get_account_status(
    account_id: str,
    current_user: User = Depends(get_current_active_user),
    manager: AccountManager = Depends(get_account_manager),
    db: Session = Depends(get_db)
):
    """ç²å–è³¬è™Ÿç‹€æ…‹ï¼ˆéœ€è¦ account:view æ¬Šé™ï¼‰"""
    check_permission(current_user, PermissionCode.ACCOUNT_VIEW.value, db)
    try:
        # 1. å…ˆæª¢æŸ¥ AccountManagerï¼ˆåœ¨å…§å­˜ä¸­é‹è¡Œçš„è³¬è™Ÿï¼‰
        status_data = manager.get_account_status(account_id)
        if status_data:
            return AccountStatusResponse(
                account_id=status_data.account_id,
                status=status_data.status.value,
                online=status_data.online,
                last_activity=status_data.last_activity.isoformat() if status_data.last_activity else None,
                message_count=status_data.message_count,
                reply_count=status_data.reply_count,
                redpacket_count=status_data.redpacket_count,
                error_count=status_data.error_count,
                last_error=status_data.last_error,
                uptime_seconds=status_data.uptime_seconds
            )
        
        # 2. æª¢æŸ¥æ•¸æ“šåº«ï¼ˆåŒ…å«é ç¨‹æœå‹™å™¨è³¬è™Ÿï¼‰
        db_account = db.query(GroupAIAccount).filter(
            GroupAIAccount.account_id == account_id
        ).first()
        
        if db_account:
            # è³¬è™Ÿåœ¨æ•¸æ“šåº«ä¸­ä½†ä¸åœ¨ AccountManager ä¸­ï¼Œè¿”å›é»˜èªçš„ offline ç‹€æ…‹
            from group_ai_service.models.account import AccountStatusEnum
            return AccountStatusResponse(
                account_id=account_id,
                status=AccountStatusEnum.OFFLINE.value,
                online=False,
                last_activity=None,
                message_count=0,
                reply_count=0,
                redpacket_count=0,
                error_count=0,
                last_error=None,
                uptime_seconds=0
            )
        
        # 3. éƒ½ä¸å­˜åœ¨ï¼Œè¿”å› 404
        raise HTTPException(status_code=404, detail=f"è³¬è™Ÿ {account_id} ä¸å­˜åœ¨")
    except HTTPException:
        raise
    except Exception as e:
        logger.exception(f"ç²å–è³¬è™Ÿç‹€æ…‹å¤±æ•—: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"ç²å–è³¬è™Ÿç‹€æ…‹å¤±æ•—: {str(e)}")'''

# ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æ›¿æ›æ•´å€‹å‡½æ•¸
pattern = r'@router\.get\("/{account_id}/status".*?)(?=\n@router\.|\nclass |\ndef [^@]|\Z)'
new_content = re.sub(pattern, fixed_function + '\n\n', content, flags=re.DOTALL)

# å¯«å›æ–‡ä»¶
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(new_content)

print("âœ… ä¿®å¾©å®Œæˆ")
PYTHON_EOF

echo "âœ… ä¿®å¾©è…³æœ¬åŸ·è¡Œå®Œæˆ"
```

---

ç”±æ–¼é€™å€‹ä¿®å¾©è…³æœ¬è¼ƒé•·ä¸”è¤‡é›œï¼Œ**æ›´æ¨è–¦çš„æ–¹æ³•æ˜¯æ‰‹å‹•ä¸Šå‚³ä¿®å¾©å¾Œçš„æ–‡ä»¶**ï¼Œæˆ–è€…å…ˆæª¢æŸ¥ç•¶å‰ä»£ç¢¼çµæ§‹ï¼Œç„¶å¾Œæä¾›æ›´ç²¾ç¢ºçš„ä¿®å¾©æ–¹æ¡ˆã€‚

---

**å…ˆåŸ·è¡Œä»¥ä¸‹ç°¡å–®æª¢æŸ¥ï¼Œå‘Šè¨´æˆ‘çµæœï¼š**

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend
grep -n "@router.get(\"/{account_id}/status\"" app/api/group_ai/accounts.py
```

**å‘Šè¨´æˆ‘é€™å€‹å‘½ä»¤çš„è¼¸å‡ºè¡Œè™Ÿï¼Œæˆ‘æœƒæä¾›é‡å°æ€§çš„ä¿®å¾©æ–¹æ¡ˆï¼**
