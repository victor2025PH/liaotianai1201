#!/bin/bash
# ============================================================
# 强制删除恶意软件脚本
# ============================================================

set -e

echo "=========================================="
echo "🔨 强制删除恶意软件"
echo "=========================================="
echo ""

# 可疑文件列表
SUSPICIOUS_FILES=(
    "/data/MUTA71VL"
    "/data/CX81yM9aE"
    "/data/UY"
)

# 1. 终止所有相关进程
echo "[1/5] 强制终止所有相关进程..."
for file in "${SUSPICIOUS_FILES[@]}"; do
    FILE_NAME=$(basename "$file")
    # 查找使用该文件的进程
    PIDS=$(lsof "$file" 2>/dev/null | awk 'NR>1 {print $2}' | sort -u || true)
    if [ -n "$PIDS" ]; then
        for pid in $PIDS; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                echo "  终止进程 PID: $pid (使用文件: $FILE_NAME)"
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
    fi
    
    # 查找命令中包含文件名的进程
    PIDS=$(ps aux | grep -i "$FILE_NAME" | grep -v grep | awk '{print $2}' || true)
    if [ -n "$PIDS" ]; then
        for pid in $PIDS; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                echo "  终止进程 PID: $pid (命令包含: $FILE_NAME)"
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
    fi
done

# 等待进程终止
sleep 2
echo "  ✅ 进程终止完成"
echo ""

# 2. 卸载文件系统（如果 /data 是独立分区）
echo "[2/5] 检查 /data 目录..."
if mountpoint -q /data 2>/dev/null; then
    echo "  /data 是独立挂载点"
    # 不卸载，直接删除文件
else
    echo "  /data 是普通目录"
fi
echo ""

# 3. 强制删除文件
echo "[3/5] 强制删除可疑文件..."
DELETED=0
FAILED=0

for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  删除: $file"
        
        # 获取文件 inode（用于验证删除）
        FILE_INODE=$(stat -c %i "$file" 2>/dev/null || echo "")
        
        # 尝试多种删除方法
        DELETE_SUCCESS=false
        
        # 方法 1: 标准删除
        if sudo rm -f "$file" 2>/dev/null; then
            DELETE_SUCCESS=true
        # 方法 2: 使用 unlink
        elif sudo unlink "$file" 2>/dev/null; then
            DELETE_SUCCESS=true
        # 方法 3: 覆盖后删除
        else
            echo "    ⚠️  标准删除失败，尝试覆盖后删除..."
            if sudo dd if=/dev/zero of="$file" bs=1M count=1 2>/dev/null; then
                if sudo rm -f "$file" 2>/dev/null; then
                    DELETE_SUCCESS=true
                fi
            fi
        fi
        
        # 同步文件系统
        sync
        
        # 等待文件系统更新
        sleep 1
        
        # 验证文件是否真的被删除（使用 inode 和文件存在性双重检查）
        if [ -n "$FILE_INODE" ]; then
            # 检查 inode 是否还存在
            INODE_EXISTS=$(find /data -inum "$FILE_INODE" 2>/dev/null | wc -l)
            if [ "$INODE_EXISTS" -gt 0 ]; then
                DELETE_SUCCESS=false
            fi
        fi
        
        # 再次检查文件是否存在
        if [ -f "$file" ]; then
            DELETE_SUCCESS=false
        fi
        
        if [ "$DELETE_SUCCESS" = true ]; then
            DELETED=$((DELETED+1))
            echo "    ✅ 删除成功"
        else
            FAILED=$((FAILED+1))
            echo "    ❌ 删除失败，文件可能被锁定或受保护"
            echo "    尝试检查文件状态:"
            ls -li "$file" 2>/dev/null || echo "      文件信息无法获取"
        fi
    else
        echo "    ✅ 文件不存在（可能已删除）"
    fi
done

# 强制同步文件系统
sync
echo ""

if [ "$DELETED" -gt 0 ]; then
    echo "  ✅ 成功删除 $DELETED 个文件"
fi
if [ "$FAILED" -gt 0 ]; then
    echo "  ⚠️  $FAILED 个文件删除失败"
fi
echo ""

# 4. 验证删除结果（强制刷新缓存后检查）
echo "[4/5] 验证删除结果..."
# 强制刷新目录缓存
sync
# 重新读取目录（触发缓存刷新）
ls /data/ >/dev/null 2>&1 || true
sleep 1

REMAINING_FILES=0
for file in "${SUSPICIOUS_FILES[@]}"; do
    # 使用多种方法检查文件是否存在
    FILE_EXISTS=false
    
    # 方法 1: 标准文件检查
    if [ -f "$file" ]; then
        FILE_EXISTS=true
    fi
    
    # 方法 2: 使用 stat 检查
    if stat "$file" >/dev/null 2>&1; then
        FILE_EXISTS=true
    fi
    
    # 方法 3: 使用 test 命令
    if test -f "$file"; then
        FILE_EXISTS=true
    fi
    
    if [ "$FILE_EXISTS" = true ]; then
        REMAINING_FILES=$((REMAINING_FILES+1))
        echo "  ⚠️  文件仍存在: $file"
        echo "    文件信息:"
        if ls -lh "$file" >/dev/null 2>&1; then
            ls -lh "$file" | awk '{print "      大小: " $5 ", 权限: " $1 ", 所有者: " $3 ":" $4 ", inode: " $1}'
            echo "    详细信息: sudo ls -li $file"
        else
            echo "      无法获取文件信息"
        fi
        echo "    建议:"
        echo "      1. 检查文件是否被进程占用: sudo lsof $file"
        echo "      2. 检查文件系统: mount | grep /data"
        echo "      3. 尝试强制删除: sudo rm -f $file && sync"
        echo "      4. 如果仍无法删除，可能需要重启系统"
    fi
done

if [ "$REMAINING_FILES" -eq 0 ]; then
    echo "  ✅ 所有可疑文件已删除"
else
    echo "  ⚠️  仍有 $REMAINING_FILES 个文件存在"
fi
echo ""

# 5. 清理相关目录和临时文件
echo "[5/5] 清理相关目录..."
# 检查 /data 目录是否还有其他可疑文件（排除已知的可疑文件）
if [ -d "/data" ]; then
    # 只查找特定的可疑文件名模式（避免误报）
    SUSPICIOUS_PATTERNS=("MUTA*" "CX*" "*[0-9][A-Z][0-9]*")
    FOUND_OTHER=false
    
    for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
        FOUND=$(find /data -maxdepth 1 -type f -name "$pattern" ! -name "lost+found" 2>/dev/null | grep -v -E "(MUTA71VL|CX81yM9aE|UY)" || true)
        if [ -n "$FOUND" ]; then
            if [ "$FOUND_OTHER" = false ]; then
                echo "  ⚠️  /data 目录中还有其他可疑文件:"
                FOUND_OTHER=true
            fi
            echo "$FOUND" | while read f; do
                if [ -f "$f" ]; then
                    echo "    $f"
                fi
            done
        fi
    done
    
    if [ "$FOUND_OTHER" = false ]; then
        echo "  ✅ /data 目录正常（未发现其他可疑文件）"
    else
        echo "  建议检查这些文件是否为恶意文件"
    fi
fi
echo ""

# 总结
echo "=========================================="
echo "强制删除完成"
echo "=========================================="
echo ""

if [ "$REMAINING_FILES" -gt 0 ]; then
    echo "⚠️  仍有文件无法删除，建议："
    echo "  1. 检查文件是否被进程占用: sudo lsof /data/MUTA71VL"
    echo "  2. 检查文件系统权限: ls -la /data/"
    echo "  3. 如果文件被锁定，重启系统后再次删除"
    echo "  4. 如果 /data 是独立分区，检查分区是否只读: mount | grep /data"
    echo ""
    echo "手动删除命令:"
    for file in "${SUSPICIOUS_FILES[@]}"; do
        if [ -f "$file" ]; then
            echo "  sudo rm -f $file"
        fi
    done
else
    echo "✅ 所有可疑文件已成功删除"
    echo ""
    echo "建议后续操作:"
    echo "  1. 更改所有密码"
    echo "  2. 运行安全扫描: sudo rkhunter --check"
    echo "  3. 监控系统资源使用情况"
    echo "  4. 定期检查 /data 目录"
fi
echo ""

