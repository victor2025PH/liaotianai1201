# 502 错误 - 后端服务启动失败修复

## 问题

浏览器显示 502 Bad Gateway，后端服务无法启动（curl 连接失败）。

## 症状

- `curl http://localhost:8000/health` 返回 "Failed to connect to localhost port 8000"
- 浏览器访问 `http://aikz.usdt2026.cc/group-ai/accounts` 显示 502 Bad Gateway
- 后端进程可能启动后立即退出

## 诊断步骤

### 方法1：使用诊断脚本

```bash
cd ~/liaotian
bash deploy/诊断后端启动失败.sh
```

这个脚本会：
- 检查现有进程
- 查看启动日志
- 检查虚拟环境
- 检查模块导入
- 检查端口占用
- 尝试前台启动

### 方法2：手动诊断

#### 1. 查看启动日志

```bash
tail -100 /tmp/backend_final.log
```

查看是否有错误信息。

#### 2. 检查进程

```bash
ps aux | grep uvicorn | grep -v grep
```

如果没有进程，说明服务没有启动或已退出。

#### 3. 检查模块导入

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
python3 -c "from app.main import app; print('OK')"
```

如果导入失败，会显示错误信息。

#### 4. 前台启动测试

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

在前台运行可以看到实时错误输出。

## 修复步骤

### 方法1：使用修复脚本（推荐）

```bash
cd ~/liaotian
bash deploy/修复并启动后端.sh
```

这个脚本会自动：
- 清理旧进程和端口
- 检查虚拟环境
- 安装缺失依赖
- 验证模块导入
- 启动服务并验证

### 方法2：手动修复

#### 1. 清理旧进程

```bash
pkill -9 -f 'uvicorn.*app.main:app'
sudo lsof -ti:8000 | xargs kill -9
```

#### 2. 检查虚拟环境

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
python3 --version
```

如果没有虚拟环境：
```bash
python3 -m venv .venv
source .venv/bin/activate
```

#### 3. 安装依赖

```bash
pip install -r requirements.txt
# 或至少安装 uvicorn
pip install uvicorn[standard]
```

#### 4. 验证模块导入

```bash
python3 -c "from app.main import app; print('OK')"
```

如果失败，根据错误信息修复。

#### 5. 启动服务

```bash
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &
```

#### 6. 验证启动

```bash
sleep 5
curl http://localhost:8000/health
```

应该返回 `{"status":"ok"}` 或类似响应。

## 常见问题

### 1. 模块导入失败

**错误**: `ModuleNotFoundError: No module named 'xxx'`

**解决**:
```bash
pip install -r requirements.txt
```

### 2. 端口被占用

**错误**: `Address already in use`

**解决**:
```bash
sudo lsof -ti:8000 | xargs kill -9
```

### 3. 虚拟环境问题

**错误**: `bash: .venv/bin/activate: No such file or directory`

**解决**:
```bash
python3 -m venv .venv
source .venv/bin/activate
```

### 4. Python 路径问题

**错误**: `ModuleNotFoundError: No module named 'app'`

**解决**: 确保在 `admin-backend` 目录下运行：
```bash
cd ~/liaotian/admin-backend
```

### 5. 权限问题

**错误**: `Permission denied`

**解决**: 检查日志文件权限：
```bash
touch /tmp/backend_final.log
chmod 666 /tmp/backend_final.log
```

## 启动前端服务

修复后端后，还需要启动前端：

```bash
cd ~/liaotian/saas-demo
pkill -f 'next.*dev|node.*3000' || true
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 10
curl http://localhost:3000
```

## 验证

1. **后端健康检查**:
   ```bash
   curl http://localhost:8000/health
   ```

2. **前端检查**:
   ```bash
   curl http://localhost:3000
   ```

3. **浏览器访问**:
   访问 `http://aikz.usdt2026.cc/group-ai/accounts` 应该不再显示 502。

## 日志文件

- **后端日志**: `/tmp/backend_final.log`
- **前端日志**: `/tmp/frontend.log`

## 相关脚本

- `deploy/诊断后端启动失败.sh` - 诊断问题
- `deploy/修复并启动后端.sh` - 自动修复并启动
- `deploy/强制启动并诊断服务.sh` - 启动所有服务
