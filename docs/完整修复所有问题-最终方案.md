# ğŸ”§ å®Œæ•´ä¿®å¤æ‰€æœ‰é—®é¢˜ - æœ€ç»ˆæ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æ€»ç»“

æ ¹æ®æ—¥å¿—ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç«¯å£ 3000 è¢«å ç”¨**ï¼šå‰ç«¯æœåŠ¡æ— æ³•å¯åŠ¨
2. **ç«¯å£ 8000 è¢«å ç”¨**ï¼šåç«¯æœåŠ¡æ— æ³•å¯åŠ¨
3. **uvicorn æ¨¡å—æœªå®‰è£…**ï¼šåç«¯æœåŠ¡ç¼ºå°‘ä¾èµ–
4. **Systemd é…ç½®é—®é¢˜**ï¼šæœåŠ¡æ–‡ä»¶é…ç½®å¯èƒ½æœ‰è¯¯

---

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆï¼ˆä¸€æ¡é¾™ï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¿®å¤æ‰€æœ‰é—®é¢˜ï¼š

```bash
cd ~/liaotian && sudo bash -c '
echo "========================================="
echo "å®Œæ•´ä¿®å¤æ‰€æœ‰æœåŠ¡å¯åŠ¨é—®é¢˜"
echo "========================================="
echo ""

echo "=== æ­¥éª¤ 1: å½»åº•åœæ­¢æ‰€æœ‰æœåŠ¡å’Œè¿›ç¨‹ ==="
systemctl stop liaotian-frontend 2>/dev/null || true
systemctl stop liaotian-backend 2>/dev/null || true

# æŸ¥æ‰¾å¹¶åœæ­¢æ‰€æœ‰å ç”¨ç«¯å£çš„è¿›ç¨‹
echo "åœæ­¢å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹..."
PORT_3000_PIDS=$(ss -tlnp | grep :3000 | grep -oP "pid=\K[0-9]+" || true)
if [ -n "$PORT_3000_PIDS" ]; then
    for PID in $PORT_3000_PIDS; do
        echo "  åœæ­¢è¿›ç¨‹: $PID"
        kill -9 "$PID" 2>/dev/null || true
    done
fi

echo "åœæ­¢å ç”¨ç«¯å£ 8000 çš„è¿›ç¨‹..."
PORT_8000_PIDS=$(ss -tlnp | grep :8000 | grep -oP "pid=\K[0-9]+" || true)
if [ -n "$PORT_8000_PIDS" ]; then
    for PID in $PORT_8000_PIDS; do
        echo "  åœæ­¢è¿›ç¨‹: $PID"
        kill -9 "$PID" 2>/dev/null || true
    done
fi

# å¼ºåˆ¶åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
pkill -9 -f "next-server" 2>/dev/null || true
pkill -9 -f "node.*next" 2>/dev/null || true
pkill -9 -f "npm start" 2>/dev/null || true
pkill -9 -f "uvicorn" 2>/dev/null || true
pkill -9 -f "python.*uvicorn" 2>/dev/null || true
sleep 5

echo ""
echo "=== æ­¥éª¤ 2: æ£€æŸ¥å¹¶å®‰è£… Python ä¾èµ– ==="
if python3 -m uvicorn --version > /dev/null 2>&1; then
    echo "âœ… uvicorn å·²å®‰è£…"
else
    echo "å®‰è£… uvicorn..."
    pip3 install uvicorn fastapi --user || python3 -m pip install uvicorn fastapi --user || echo "âš ï¸  éœ€è¦æ‰‹åŠ¨å®‰è£…"
fi

echo ""
echo "=== æ­¥éª¤ 3: ä¿®å¤ Systemd æœåŠ¡æ–‡ä»¶ ==="

# å‰ç«¯æœåŠ¡
cat > /etc/systemd/system/liaotian-frontend.service << "EOFFRONTEND"
[Unit]
Description=Liaotian Frontend Service (Next.js)
After=network.target liaotian-backend.service
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="PATH=/usr/bin:/bin:/usr/local/bin"
Environment="NODE_ENV=production"
Environment="PORT=3000"
ExecStart=/bin/bash -c "if [ -d /home/ubuntu/liaotian/saas-demo/.next/standalone ]; then cd /home/ubuntu/liaotian/saas-demo/.next/standalone && PORT=3000 /usr/bin/node server.js; else cd /home/ubuntu/liaotian/saas-demo && /usr/bin/npm start; fi"
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=liaotian-frontend

[Install]
WantedBy=multi-user.target
EOFFRONTEND

# åç«¯æœåŠ¡
cat > /etc/systemd/system/liaotian-backend.service << "EOFBACKEND"
[Unit]
Description=Liaotian Backend API Service (FastAPI)
After=network.target
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/admin-backend
Environment="PATH=/usr/bin:/bin:/usr/local/bin:/home/ubuntu/.local/bin"
ExecStart=/bin/bash -c "cd /home/ubuntu/liaotian/admin-backend && python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --timeout-keep-alive 120"
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=liaotian-backend

[Install]
WantedBy=multi-user.target
EOFBACKEND

echo "âœ… æœåŠ¡æ–‡ä»¶å·²ä¿®å¤"

echo ""
echo "=== æ­¥éª¤ 4: é‡æ–°åŠ è½½ systemd ==="
systemctl daemon-reload

echo ""
echo "=== æ­¥éª¤ 5: å¯åŠ¨åç«¯æœåŠ¡ ==="
systemctl start liaotian-backend
sleep 10

if systemctl is-active --quiet liaotian-backend; then
    echo "âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
else
    echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
    journalctl -u liaotian-backend -n 20 --no-pager | tail -10
fi

echo ""
echo "=== æ­¥éª¤ 6: å¯åŠ¨å‰ç«¯æœåŠ¡ ==="
systemctl start liaotian-frontend
sleep 10

if systemctl is-active --quiet liaotian-frontend; then
    echo "âœ… å‰ç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ"
else
    echo "âŒ å‰ç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
    journalctl -u liaotian-frontend -n 20 --no-pager | tail -10
fi

echo ""
echo "=== æ­¥éª¤ 7: æœ€ç»ˆéªŒè¯ ==="
systemctl is-active liaotian-backend && echo "âœ… åç«¯è¿è¡Œä¸­" || echo "âŒ åç«¯æœªè¿è¡Œ"
systemctl is-active liaotian-frontend && echo "âœ… å‰ç«¯è¿è¡Œä¸­" || echo "âŒ å‰ç«¯æœªè¿è¡Œ"
ss -tlnp | grep :3000 && echo "âœ… ç«¯å£ 3000 ç›‘å¬" || echo "âŒ ç«¯å£ 3000 æœªç›‘å¬"
ss -tlnp | grep :8000 && echo "âœ… ç«¯å£ 8000 ç›‘å¬" || echo "âŒ ç«¯å£ 8000 æœªç›‘å¬"

echo ""
echo "âœ… ä¿®å¤å®Œæˆï¼"
'
```

---

## ğŸ” å¦‚æœè¿˜æœ‰é—®é¢˜ - æ‰‹åŠ¨è¯Šæ–­

### 1. æ£€æŸ¥ç«¯å£å ç”¨

```bash
# æŸ¥çœ‹æ‰€æœ‰å ç”¨ç«¯å£ 3000 å’Œ 8000 çš„è¿›ç¨‹
sudo lsof -i :3000
sudo lsof -i :8000

# æˆ–è€…ä½¿ç”¨ ss
sudo ss -tlnp | grep :3000
sudo ss -tlnp | grep :8000
```

### 2. æ£€æŸ¥ Python ç¯å¢ƒ

```bash
# æ£€æŸ¥ uvicorn æ˜¯å¦å®‰è£…
python3 -m uvicorn --version

# å¦‚æœæœªå®‰è£…ï¼Œå®‰è£…å®ƒ
pip3 install uvicorn fastapi --user
# æˆ–è€…
python3 -m pip install uvicorn fastapi --user

# æ£€æŸ¥åç«¯ç›®å½•
cd ~/liaotian/admin-backend
python3 -c "import uvicorn; print(uvicorn.__version__)"
```

### 3. æ£€æŸ¥å‰ç«¯æ„å»º

```bash
cd ~/liaotian/saas-demo

# æ£€æŸ¥ .next ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la .next

# å¦‚æœä¸å­˜åœ¨ï¼Œé‡æ–°æ„å»º
npm run build
```

### 4. æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨

**åç«¯ï¼š**
```bash
cd ~/liaotian/admin-backend
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**å‰ç«¯ï¼š**
```bash
cd ~/liaotian/saas-demo
npm start
```

---

## ğŸ“ å¸¸è§é—®é¢˜è§£å†³

### Q1: uvicorn æ¨¡å—æœªæ‰¾åˆ°

**è§£å†³**ï¼š
```bash
# æ–¹æ³• 1: ä½¿ç”¨ pip3 å®‰è£…
pip3 install uvicorn fastapi --user

# æ–¹æ³• 2: ä½¿ç”¨ python3 -m pip
python3 -m pip install uvicorn fastapi --user

# æ–¹æ³• 3: ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
sudo apt install python3-uvicorn python3-fastapi 2>/dev/null || echo "åŒ…ç®¡ç†å™¨ä¸æä¾›"
```

### Q2: ç«¯å£ä¸€ç›´è¢«å ç”¨

**è§£å†³**ï¼š
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :3000
sudo lsof -i :8000

# å¼ºåˆ¶åœæ­¢
sudo kill -9 <PID>

# æˆ–è€…ä½¿ç”¨ ss æŸ¥æ‰¾
sudo ss -tlnp | grep :3000
sudo kill -9 $(ss -tlnp | grep :3000 | grep -oP 'pid=\K[0-9]+')
```

### Q3: æœåŠ¡å¯åŠ¨åç«‹å³é€€å‡º

**æŸ¥çœ‹æ—¥å¿—**ï¼š
```bash
# åç«¯æ—¥å¿—
sudo journalctl -u liaotian-backend -f

# å‰ç«¯æ—¥å¿—
sudo journalctl -u liaotian-frontend -f
```

---

## âœ… ä¿®å¤åéªŒè¯

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status liaotian-backend
sudo systemctl status liaotian-frontend

# æ£€æŸ¥ç«¯å£
ss -tlnp | grep -E ":(3000|8000|80)"

# æµ‹è¯• HTTP
curl http://localhost:8000/health
curl http://localhost:3000
curl http://localhost/health
```

---

**æœ€åæ›´æ–°**: 2025-12-07
