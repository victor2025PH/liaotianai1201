# 最终修复指南

## 当前状态

从终端输出可以看到：
- Standalone目录已找到：`/home/ubuntu/liaotian/saas-demo/.next/standalone/liaotian/saas-demo`
- sed命令已执行
- 但服务仍然失败：`Active: activating (auto-restart) (Result: exit-code)`

## 诊断步骤

请在服务器上执行以下命令来诊断问题：

```bash
# 1. 检查当前配置
cat /etc/systemd/system/liaotian-frontend.service | grep -E "WorkingDirectory|ExecStart"

# 2. 检查server.js是否存在
ls -la /home/ubuntu/liaotian/saas-demo/.next/standalone/liaotian/saas-demo/server.js

# 3. 查看最新错误日志
sudo journalctl -u liaotian-frontend -n 30 --no-pager | tail -20
```

## 完整修复方案

如果配置不正确，请执行以下完整修复：

```bash
cd /home/ubuntu/liaotian/saas-demo

# 1. 查找standalone目录
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
FULL_STANDALONE_DIR="/home/ubuntu/liaotian/saas-demo/$STANDALONE_DIR"
echo "Standalone目录: $FULL_STANDALONE_DIR"

# 2. 验证server.js存在
ls -la "$FULL_STANDALONE_DIR/server.js"

# 3. 停止服务
sudo systemctl stop liaotian-frontend

# 4. 复制静态文件
mkdir -p "$STANDALONE_DIR/.next/static"
cp -r .next/static/* "$STANDALONE_DIR/.next/static/"

# 5. 备份并完全重写systemd配置
sudo cp /etc/systemd/system/liaotian-frontend.service /etc/systemd/system/liaotian-frontend.service.bak

sudo tee /etc/systemd/system/liaotian-frontend.service > /dev/null <<EOF
[Unit]
Description=Liaotian Frontend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=$FULL_STANDALONE_DIR
Environment=PORT=3000
Environment="NVM_DIR=\$HOME/.nvm"
Environment="PATH=\$HOME/.nvm/versions/node/v20.19.6/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node server.js
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 6. 验证配置
cat /etc/systemd/system/liaotian-frontend.service | grep -E "WorkingDirectory|ExecStart"

# 7. 重新加载并启动
sudo systemctl daemon-reload
sudo systemctl start liaotian-frontend
sleep 5

# 8. 检查状态
sudo systemctl status liaotian-frontend --no-pager | head -20

# 9. 如果仍然失败，查看错误日志
sudo journalctl -u liaotian-frontend -n 30 --no-pager | tail -20
```

## 手动测试服务器

如果服务仍然无法启动，可以手动测试服务器是否能正常运行：

```bash
cd /home/ubuntu/liaotian/saas-demo/.next/standalone/liaotian/saas-demo

# 加载NVM
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
nvm use 20

# 手动启动服务器
node server.js
```

**预期结果**：
- 如果成功，会看到类似以下输出：
  ```
  ▲ Next.js 16.0.2
  - Local:        http://localhost:3000
  - Network:      http://0.0.0.0:3000
  ✓ Ready in 96ms
  ```
- 如果有错误，会显示错误信息

**注意**：按 `Ctrl+C` 停止测试服务器

## 常见错误和解决方案

### 错误1：`Cannot find module 'server.js'`
- **原因**：WorkingDirectory不正确
- **解决**：确保WorkingDirectory指向standalone目录

### 错误2：`EACCES: permission denied`
- **原因**：文件权限问题
- **解决**：`sudo chown -R ubuntu:ubuntu /home/ubuntu/liaotian/saas-demo/.next`

### 错误3：`ENOENT: no such file or directory`
- **原因**：文件不存在
- **解决**：检查server.js和静态文件是否存在

### 错误4：`EADDRINUSE: address already in use`
- **原因**：端口3000被占用
- **解决**：`sudo lsof -ti:3000 | xargs sudo kill -9`

## 验证修复成功

修复成功后：
1. ✅ 服务状态：`Active: active (running)`
2. ✅ 端口3000被监听
3. ✅ 页面不再显示502错误
4. ✅ 浏览器可以正常访问

## 已创建的脚本

1. **`deploy/诊断服务失败原因.sh`** - 诊断脚本
2. **`deploy/完整修复-最终版本.sh`** - 完整修复脚本

可以在服务器上执行：
```bash
bash /tmp/诊断服务失败原因.sh
bash /tmp/完整修复-最终版本.sh
```

