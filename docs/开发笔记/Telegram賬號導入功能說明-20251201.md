# Telegram 賬號導入功能說明

> **日期**: 2025-12-01  
> **功能**: 後台網頁批量導入 Telegram 賬號配置

---

## 📋 功能概述

支持通過後台網頁批量導入 Telegram 賬號配置，每個賬號可以有不同的 API ID、API Hash 和 Session Name。

---

## 🎯 使用場景

### 場景 1: 批量導入新賬號

**需求**: 一次性導入多個 Telegram 賬號配置

**步驟**:
1. 準備配置文件（TXT 或 Excel）
2. 在後台頁面選擇文件上傳
3. 系統自動解析並導入配置

**適用情況**:
- 初始部署時批量導入賬號
- 從其他系統遷移賬號配置
- 定期批量添加新賬號

### 場景 2: 更新現有賬號配置

**需求**: 更新已存在賬號的 Telegram API 配置

**步驟**:
1. 準備包含現有賬號的配置文件
2. 上傳文件，系統會自動識別並更新

**適用情況**:
- API 憑證過期需要更新
- 更換 Telegram API 配置
- 批量修改賬號配置

### 場景 3: 混合操作（新建+更新）

**需求**: 同時導入新賬號和更新現有賬號

**步驟**:
1. 準備包含新舊賬號的配置文件
2. 一次性上傳，系統自動處理

**適用情況**:
- 定期維護和擴展賬號池
- 混合操作場景

---

## 📝 文件格式

### TXT 格式

**格式**: 每行一個賬號，使用 `|` 或 `,` 分隔

```
API_ID|API_HASH|SESSION_NAME
123456|abc123def456|+1234567890
789012|xyz789uvw012|+9876543210
```

或使用逗號分隔:
```
API_ID,API_HASH,SESSION_NAME
123456,abc123def456,+1234567890
789012,xyz789uvw012,+9876543210
```

**說明**:
- 第一行可以是標題行（可選）
- `#` 開頭的行會被忽略（註釋）
- 空行會被跳過

### Excel 格式

**格式**: 包含三列的 Excel 文件

| API_ID | API_HASH | SESSION_NAME |
|--------|----------|--------------|
| 123456 | abc123def456 | +1234567890 |
| 789012 | xyz789uvw012 | +9876543210 |

**說明**:
- 第一行必須是表頭
- 列名不區分大小寫（支持 `API_ID`, `api_id`, `ApiId` 等）
- `SESSION_NAME` 也可以用 `PHONE` 或 `PHONE_NUMBER` 作為列名

---

## 🔧 API 端點

### 1. 文件上傳導入

**端點**: `POST /api/v1/group-ai/accounts/import`

**請求**:
- 方法: `POST`
- Content-Type: `multipart/form-data`
- 參數: `file` (文件)

**響應**:
```json
{
  "total": 10,
  "success": 8,
  "failed": 2,
  "errors": [
    "賬號 +1234567890: 配置格式錯誤",
    "賬號 +9876543210: API ID 無效"
  ]
}
```

### 2. JSON 批量導入

**端點**: `POST /api/v1/group-ai/accounts/import/batch`

**請求**:
```json
[
  {
    "api_id": "123456",
    "api_hash": "abc123def456",
    "session_name": "+1234567890"
  },
  {
    "api_id": "789012",
    "api_hash": "xyz789uvw012",
    "session_name": "+9876543210"
  }
]
```

**響應**: 同文件上傳導入

---

## 💾 數據存儲

配置存儲在 `GroupAIAccount` 表的 `config` 字段中：

```json
{
  "telegram_api_id": "123456",
  "telegram_api_hash": "abc123def456",
  "telegram_session_name": "+1234567890"
}
```

**特點**:
- 每個賬號獨立配置
- 支持更新現有配置
- 不影響其他賬號

---

## 🔐 權限要求

需要 `account:create` 權限才能執行導入操作。

---

## ✅ 導入邏輯

### 處理流程

1. **文件解析**
   - 檢測文件格式（TXT/Excel）
   - 解析文件內容
   - 驗證格式正確性

2. **數據驗證**
   - 檢查必填字段
   - 驗證數據格式
   - 檢查重複項

3. **數據庫操作**
   - 檢查賬號是否已存在（根據 `session_name`）
   - 如果存在：更新配置
   - 如果不存在：創建新記錄

4. **結果返回**
   - 統計成功/失敗數量
   - 返回錯誤詳情

### 錯誤處理

- **文件格式錯誤**: 返回 400 錯誤
- **數據驗證失敗**: 記錄錯誤，繼續處理其他項
- **數據庫錯誤**: 回滾事務，返回 500 錯誤

---

## 📊 前端實現

### 功能按鈕

在賬號管理頁面添加「批量導入」按鈕，支持：
1. 文件選擇（TXT/Excel）
2. 上傳進度顯示
3. 導入結果展示
4. 錯誤詳情查看

### 使用流程

1. 點擊「批量導入」按鈕
2. 選擇配置文件
3. 點擊「上傳」按鈕
4. 查看導入結果
5. 如有錯誤，下載錯誤報告

---

## 🚀 後續改進

1. **配置驗證增強**
   - 驗證 API ID/Hash 格式
   - 檢查 Session Name 有效性

2. **導入模板下載**
   - 提供標準模板文件
   - 支持一鍵下載

3. **導入歷史記錄**
   - 記錄每次導入操作
   - 支持查看導入歷史

4. **批量操作增強**
   - 支持導入時同時設置其他參數（劇本、群組等）
   - 支持導入預覽（導入前確認）

---

## 📋 相關文件

- `admin-backend/app/api/group_ai/account_import.py` - 導入 API 實現
- `saas-demo/src/app/group-ai/accounts/page.tsx` - 前端頁面（待添加導入功能）
- `admin-backend/scripts/import_telegram_accounts.py` - 命令行導入腳本

---

**功能已實現，等待前端集成！**
