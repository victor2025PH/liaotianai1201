# å·¥ä½œç¯€é»ä¿®å¾©æŒ‡å—

æœ¬æ–‡æª”æä¾›å®Œæ•´çš„å·¥ä½œç¯€é»ï¼ˆé›»è…¦001å’Œé›»è…¦002ï¼‰å•é¡Œè¨ºæ–·å’Œä¿®å¾©æ­¥é©Ÿã€‚

## ğŸ” å•é¡Œæ¦‚è¿°

æ ¹æ“šæ‚¨çš„æˆªåœ–å’Œæ—¥èªŒï¼Œç™¼ç¾ä»¥ä¸‹ä¸»è¦å•é¡Œï¼š

1. **å¾Œç«¯æœå‹™ 502 éŒ¯èª¤** - å‰ç«¯ç„¡æ³•èˆ‡å¾Œç«¯ API é€šè¨Š
2. **Telethon æœƒè©±æ–‡ä»¶ç‰ˆæœ¬éŒ¯èª¤** - `no such column: version`
3. **API_ID/API_HASH æœªæ­£ç¢ºè¨­ç½®** - å³ä½¿å¾ Excel è®€å–ï¼Œä»é¡¯ç¤º NOT SET
4. **å·¥ä½œç¯€é»ç„¡æ³•ç²å– Telegram ID** - æ‰€æœ‰å¸³è™Ÿé¡¯ç¤º Telegram ID ç‚º N/A

---

## ğŸš¨ å„ªå…ˆç´š 1: ä¿®å¾©å¾Œç«¯æœå‹™ 502 éŒ¯èª¤

### åœ¨æœå‹™å™¨ä¸ŠåŸ·è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. æª¢æŸ¥å¾Œç«¯æœå‹™ç‹€æ…‹
sudo systemctl status luckyred-api

# 2. å¦‚æœæœå‹™æœªé‹è¡Œï¼Œå•Ÿå‹•å®ƒ
sudo systemctl start luckyred-api

# 3. å¦‚æœæœå‹™é‹è¡Œä½†æœ‰éŒ¯èª¤ï¼Œé‡å•Ÿå®ƒ
sudo systemctl restart luckyred-api

# 4. æŸ¥çœ‹å¾Œç«¯æ—¥èªŒä»¥æ‰¾å‡ºéŒ¯èª¤åŸå› 
sudo journalctl -u luckyred-api -n 50 --no-pager

# 5. æª¢æŸ¥å¾Œç«¯æ˜¯å¦åœ¨ç«¯å£ 8000 ä¸Šç›£è½
sudo ss -tlnp | grep :8000

# 6. æ¸¬è©¦å¾Œç«¯å¥åº·æª¢æŸ¥
curl http://localhost:8000/health

# 7. å¦‚æœå¥åº·æª¢æŸ¥å¤±æ•—ï¼Œæª¢æŸ¥å¾Œç«¯ä»£ç¢¼å’Œé…ç½®
cd /home/ubuntu/telegram-ai-system/admin-backend
source venv/bin/activate
python -m app.main  # æ‰‹å‹•æ¸¬è©¦å•Ÿå‹•
```

### å¸¸è¦‹å¾Œç«¯å•é¡Œä¿®å¾©ï¼š

#### å•é¡Œ A: å¾Œç«¯æœå‹™æœªé‹è¡Œ
```bash
# å•Ÿå‹•æœå‹™
sudo systemctl start luckyred-api

# è¨­ç½®é–‹æ©Ÿè‡ªå•Ÿ
sudo systemctl enable luckyred-api

# æª¢æŸ¥ç‹€æ…‹
sudo systemctl status luckyred-api
```

#### å•é¡Œ B: ç«¯å£è¢«å ç”¨
```bash
# æ‰¾å‡ºå ç”¨ 8000 ç«¯å£çš„é€²ç¨‹
sudo lsof -i :8000
# æˆ–
sudo netstat -tlnp | grep :8000

# å¦‚æœç™¼ç¾å…¶ä»–é€²ç¨‹å ç”¨ï¼Œå¯ä»¥æ®ºæ­»å®ƒï¼ˆè¬¹æ…æ“ä½œï¼‰
# sudo kill -9 <PID>
```

#### å•é¡Œ C: ä¾è³´ç¼ºå¤±æˆ–ç’°å¢ƒå•é¡Œ
```bash
cd /home/ubuntu/telegram-ai-system/admin-backend
source venv/bin/activate
pip install -r requirements.txt
```

---

## ğŸ”§ å„ªå…ˆç´š 2: ä¿®å¾© Telethon æœƒè©±æ–‡ä»¶ç‰ˆæœ¬éŒ¯èª¤

### å•é¡Œæè¿°
éŒ¯èª¤ï¼š`[TELETHON] Error for xxx.session: no such column: version`

é€™è¡¨ç¤º Telethon æœƒè©±æ–‡ä»¶èˆ‡ç•¶å‰ Telethon ç‰ˆæœ¬ä¸å…¼å®¹ã€‚

### ä¿®å¾©æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: æ›´æ–° Telethon åº«ï¼ˆæ¨è–¦ï¼‰

åœ¨**é›»è…¦001**å’Œ**é›»è…¦002**ä¸ŠåŸ·è¡Œï¼š

```bash
# åœ¨ Windows ä¸Šï¼ˆä»¥ç®¡ç†å“¡èº«ä»½é‹è¡Œ CMDï¼‰
python -m pip install --upgrade telethon

# æˆ–è€…å¦‚æœä½¿ç”¨ pip.exe
pip install --upgrade telethon
```

#### æ–¹æ¡ˆ 2: å¦‚æœ Device Guard é˜»æ­¢ pip.exe

å¦‚æœçœ‹åˆ°éŒ¯èª¤ï¼š`'pip.exe'å·²è¢«ç»„ç»‡çš„ Device Guard ç­–ç•¥é˜»æ­¢`

**ä¿®å¾©æ­¥é©Ÿï¼š**

1. **æ–¹æ³• A: ä½¿ç”¨ Python æ¨¡å¡Šæ–¹å¼é‹è¡Œ pip**
   ```bash
   python -m pip install --upgrade telethon
   ```

2. **æ–¹æ³• B: ä¿®æ”¹ Device Guard ç­–ç•¥ï¼ˆéœ€è¦ç®¡ç†å“¡æ¬Šé™ï¼‰**
   - æ‰“é–‹ã€Œæœ¬åœ°å®‰å…¨ç­–ç•¥ã€æˆ–ã€Œçµ„ç­–ç•¥ç·¨è¼¯å™¨ã€
   - æ‰¾åˆ°ã€Œæ‡‰ç”¨ç¨‹åºæ§åˆ¶ç­–ç•¥ã€->ã€ŒDevice Guardã€
   - å°‡ `pip.exe` æ·»åŠ åˆ°ç™½åå–®ï¼Œæˆ–
   - è‡¨æ™‚ç¦ç”¨ Device Guard é€²è¡Œæ›´æ–°

3. **æ–¹æ³• C: ç›´æ¥ä¸‹è¼‰ä¸¦å®‰è£ wheel æ–‡ä»¶**
   ```bash
   # ä¸‹è¼‰æœ€æ–°ç‰ˆæœ¬çš„ telethon wheel æ–‡ä»¶
   python -m pip download telethon
   # ç„¶å¾Œæ‰‹å‹•å®‰è£
   python -m pip install telethon-*.whl
   ```

#### æ–¹æ¡ˆ 3: åˆªé™¤èˆŠæœƒè©±æ–‡ä»¶ä¸¦é‡æ–°ç”Ÿæˆï¼ˆæœ€å¾Œæ‰‹æ®µï¼‰

âš ï¸ **è­¦å‘Šï¼šé€™æœƒåˆªé™¤ç¾æœ‰æœƒè©±ï¼Œéœ€è¦é‡æ–°ç™»éŒ„ Telegram å¸³è™Ÿ**

åœ¨**é›»è…¦001**å’Œ**é›»è…¦002**ä¸Šï¼š

1. **å‚™ä»½ç¾æœ‰æœƒè©±æ–‡ä»¶**ï¼ˆå¯é¸ä½†å»ºè­°ï¼‰
   ```cmd
   # åœ¨æœƒè©±æ–‡ä»¶ç›®éŒ„ä¸­
   cd sessions
   mkdir backup_%date:~0,4%%date:~5,2%%date:~8,2%
   copy *.session backup_%date:~0,4%%date:~5,2%%date:~8,2%\
   ```

2. **åˆªé™¤èˆŠæœƒè©±æ–‡ä»¶**
   ```cmd
   # åˆªé™¤æ‰€æœ‰ .session æ–‡ä»¶
   del *.session
   ```

3. **é‡æ–°é‹è¡Œå·¥ä½œç¯€é»è…³æœ¬**
   - è…³æœ¬æœƒå˜—è©¦é‡æ–°é€£æ¥ Telegram
   - æ‚¨éœ€è¦è¼¸å…¥é©—è­‰ç¢¼ä¾†é‡æ–°ç™»éŒ„æ¯å€‹å¸³è™Ÿ

---

## ğŸ”‘ å„ªå…ˆç´š 3: ä¿®å¾© API_ID/API_HASH æœªè¨­ç½®å•é¡Œ

### å•é¡Œæè¿°
å³ä½¿ Excel æ–‡ä»¶ä¸­åŒ…å« `api_id` å’Œ `api_hash`ï¼Œå·¥ä½œç¯€é»ä»é¡¯ç¤º `API ID: NOT SET` å’Œ `API Hash: NOT SET`ã€‚

### ä¿®å¾©æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: æª¢æŸ¥ Excel æ–‡ä»¶æ ¼å¼

ç¢ºä¿ Excel æ–‡ä»¶ï¼ˆ`pc-001.xlsx` å’Œ `pc-002.xlsx`ï¼‰åŒ…å«ä»¥ä¸‹åˆ—ï¼š

| api_id | api_hash | phone | enabled |
|--------|----------|-------|---------|
| 30390800 | your_api_hash_here | 639277358115 | True |
| 38485760 | your_api_hash_here | 639952948592 | True |

**æª¢æŸ¥æ­¥é©Ÿï¼š**

1. æ‰“é–‹ Excel æ–‡ä»¶
2. ç¢ºèªç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œè¡Œï¼š`api_id`, `api_hash`, `phone`
3. ç¢ºèªæ¯å€‹å¸³è™Ÿçš„ `api_id` å’Œ `api_hash` éƒ½æœ‰å€¼
4. ä¿å­˜æ–‡ä»¶

#### æ–¹æ¡ˆ 2: è¨­ç½®ç’°å¢ƒè®Šé‡ï¼ˆå¦‚æœå·¥ä½œç¯€é»æ”¯æŒï¼‰

åœ¨å•Ÿå‹•å·¥ä½œç¯€é»ä¹‹å‰ï¼Œè¨­ç½®ç’°å¢ƒè®Šé‡ï¼š

**Windows (CMD):**
```cmd
set TELEGRAM_API_ID=30390800
set TELEGRAM_API_HASH=your_api_hash_here
```

**Windows (PowerShell):**
```powershell
$env:TELEGRAM_API_ID="30390800"
$env:TELEGRAM_API_HASH="your_api_hash_here"
```

#### æ–¹æ¡ˆ 3: æª¢æŸ¥å·¥ä½œç¯€é»ä»£ç¢¼é‚è¼¯

å¦‚æœå·¥ä½œç¯€é»ä»£ç¢¼å¾ Excel è®€å– API_ID å’Œ API_HASHï¼Œä½†æ²’æœ‰æ­£ç¢ºè¨­ç½®ï¼Œå¯èƒ½éœ€è¦ä¿®æ”¹ä»£ç¢¼ã€‚

**æª¢æŸ¥é»ï¼š**

1. å·¥ä½œç¯€é»æ˜¯å¦æ­£ç¢ºè®€å– Excel æ–‡ä»¶ä¸­çš„ `api_id` å’Œ `api_hash`ï¼Ÿ
2. è®€å–å¾Œæ˜¯å¦æ­£ç¢ºå‚³éçµ¦ Telethon Clientï¼Ÿ
3. æ˜¯å¦åœ¨å…¨å±€è¨­ç½®ä¸­æ‡‰ç”¨äº†é€™äº›å€¼ï¼Ÿ

---

## ğŸ–¥ï¸ å„ªå…ˆç´š 4: ä¿®å¾©å·¥ä½œç¯€é»é€£æ¥å•é¡Œ

### ç¢ºä¿å·¥ä½œç¯€é»å¯ä»¥é€£æ¥åˆ°æœå‹™å™¨

åœ¨**é›»è…¦001**å’Œ**é›»è…¦002**ä¸Šï¼š

#### 1. æª¢æŸ¥ç¶²çµ¡é€£æ¥

```cmd
# æ¸¬è©¦æœå‹™å™¨é€£æ¥
ping aikz.usdt2026.cc

# æ¸¬è©¦ HTTPS é€£æ¥
curl https://aikz.usdt2026.cc/api/v1/health
```

#### 2. æª¢æŸ¥å·¥ä½œç¯€é»é…ç½®

ç¢ºèªå·¥ä½œç¯€é»è…³æœ¬ä¸­çš„é…ç½®ï¼š

```python
SERVER_URL = "https://aikz.usdt2026.cc"  # ç¢ºä¿æ˜¯ HTTPS
NODE_ID = "PC-001"  # æˆ– "PC-002"
```

#### 3. æª¢æŸ¥é˜²ç«ç‰†è¨­ç½®

ç¢ºä¿ Windows é˜²ç«ç‰†å…è¨±å·¥ä½œç¯€é»è…³æœ¬è¨ªå•ç¶²çµ¡ï¼š

1. æ‰“é–‹ã€ŒWindows Defender é˜²ç«ç‰†ã€
2. é»æ“Šã€Œå…è¨±æ‡‰ç”¨é€šéé˜²ç«ç‰†ã€
3. æ‰¾åˆ° Python æˆ–æ‚¨çš„å·¥ä½œç¯€é»ç¨‹åº
4. ç¢ºä¿ã€Œå°ˆç”¨ã€å’Œã€Œå…¬ç”¨ã€ç¶²çµ¡éƒ½è¢«å‹¾é¸

---

## ğŸ“‹ å®Œæ•´ä¿®å¾©æª¢æŸ¥æ¸…å–®

### æœå‹™å™¨ç«¯ï¼ˆå¾Œç«¯ï¼‰

- [ ] å¾Œç«¯æœå‹™ `luckyred-api` æ­£åœ¨é‹è¡Œ
- [ ] ç«¯å£ 8000 æ­£åœ¨ç›£è½
- [ ] å¾Œç«¯å¥åº·æª¢æŸ¥ `/health` è¿”å›æˆåŠŸ
- [ ] Nginx æ­£ç¢ºä»£ç† `/api/` åˆ°å¾Œç«¯
- [ ] å‰ç«¯å¯ä»¥è¨ªå• `https://aikz.usdt2026.cc/api/v1/workers/`

### é›»è…¦001

- [ ] Telethon åº«å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- [ ] Excel æ–‡ä»¶ `pc-001.xlsx` æ ¼å¼æ­£ç¢º
- [ ] API_ID å’Œ API_HASH åœ¨ Excel ä¸­æœ‰å€¼
- [ ] å·¥ä½œç¯€é»è…³æœ¬æ­£åœ¨é‹è¡Œ
- [ ] å·¥ä½œç¯€é»å¯ä»¥é€£æ¥åˆ° `https://aikz.usdt2026.cc`
- [ ] æœƒè©±æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ²’æœ‰ç‰ˆæœ¬éŒ¯èª¤
- [ ] å¸³è™Ÿèƒ½å¤ ç²å– Telegram ID

### é›»è…¦002

- [ ] Telethon åº«å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
- [ ] Excel æ–‡ä»¶ `pc-002.xlsx` æ ¼å¼æ­£ç¢º
- [ ] API_ID å’Œ API_HASH åœ¨ Excel ä¸­æœ‰å€¼
- [ ] å·¥ä½œç¯€é»è…³æœ¬æ­£åœ¨é‹è¡Œ
- [ ] å·¥ä½œç¯€é»å¯ä»¥é€£æ¥åˆ° `https://aikz.usdt2026.cc`
- [ ] æœƒè©±æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰æ²’æœ‰ç‰ˆæœ¬éŒ¯èª¤
- [ ] å¸³è™Ÿèƒ½å¤ ç²å– Telegram ID

---

## ğŸš€ å¿«é€Ÿä¿®å¾©è…³æœ¬

### æœå‹™å™¨ç«¯ä¿®å¾©è…³æœ¬

åœ¨æœå‹™å™¨ä¸Šå‰µå»ºä¸¦åŸ·è¡Œ `fix-backend.sh`:

```bash
#!/bin/bash
echo "ä¿®å¾©å¾Œç«¯æœå‹™..."

# é‡å•Ÿå¾Œç«¯æœå‹™
sudo systemctl restart luckyred-api

# ç­‰å¾…æœå‹™å•Ÿå‹•
sleep 5

# æª¢æŸ¥ç‹€æ…‹
if sudo systemctl is-active --quiet luckyred-api; then
    echo "âœ… å¾Œç«¯æœå‹™å·²å•Ÿå‹•"
    curl http://localhost:8000/health
else
    echo "âŒ å¾Œç«¯æœå‹™å•Ÿå‹•å¤±æ•—ï¼ŒæŸ¥çœ‹æ—¥èªŒï¼š"
    sudo journalctl -u luckyred-api -n 20 --no-pager
fi
```

### Windows ç«¯ä¿®å¾©è…³æœ¬

åœ¨**é›»è…¦001**å’Œ**é›»è…¦002**ä¸Šå‰µå»º `fix-worker.bat`:

```batch
@echo off
echo ä¿®å¾©å·¥ä½œç¯€é»...

echo [1/4] æ›´æ–° Telethon åº«...
python -m pip install --upgrade telethon

echo [2/4] æ¸¬è©¦æœå‹™å™¨é€£æ¥...
ping -n 1 aikz.usdt2026.cc

echo [3/4] æª¢æŸ¥ Excel æ–‡ä»¶...
if exist pc-001.xlsx (
    echo æ‰¾åˆ° pc-001.xlsx
) else (
    echo âš ï¸ æœªæ‰¾åˆ° pc-001.xlsxï¼Œè«‹ç¢ºèªæ–‡ä»¶å­˜åœ¨
)

if exist pc-002.xlsx (
    echo æ‰¾åˆ° pc-002.xlsx
) else (
    echo âš ï¸ æœªæ‰¾åˆ° pc-002.xlsxï¼Œè«‹ç¢ºèªæ–‡ä»¶å­˜åœ¨
)

echo [4/4] ä¿®å¾©å®Œæˆï¼
echo è«‹é‡æ–°é‹è¡Œå·¥ä½œç¯€é»è…³æœ¬
pause
```

---

## ğŸ” è¨ºæ–·å‘½ä»¤

### æª¢æŸ¥å·¥ä½œç¯€é»ç‹€æ…‹

åœ¨ç¶²é å‰ç«¯ï¼Œè¨ªå•ï¼š
- `https://aikz.usdt2026.cc/api/v1/workers/` - æŸ¥çœ‹æ‰€æœ‰å·¥ä½œç¯€é»
- `https://aikz.usdt2026.cc/api/v1/workers/PC-001` - æŸ¥çœ‹ PC-001 ç‹€æ…‹
- `https://aikz.usdt2026.cc/api/v1/workers/PC-002` - æŸ¥çœ‹ PC-002 ç‹€æ…‹

### æª¢æŸ¥å¾Œç«¯æ—¥èªŒ

```bash
# å¯¦æ™‚æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ
sudo journalctl -u luckyred-api -f

# æŸ¥çœ‹æœ€è¿‘çš„éŒ¯èª¤
sudo journalctl -u luckyred-api -p err -n 50
```

### æª¢æŸ¥å·¥ä½œç¯€é»æ—¥èªŒ

åœ¨**é›»è…¦001**å’Œ**é›»è…¦002**ä¸Šï¼ŒæŸ¥çœ‹å·¥ä½œç¯€é»ç¨‹åºçš„è¼¸å‡ºæ—¥èªŒï¼Œå°‹æ‰¾ï¼š
- `[TELETHON]` ç›¸é—œéŒ¯èª¤
- `API ID: NOT SET` è­¦å‘Š
- é€£æ¥æœå‹™å™¨å¤±æ•—çš„éŒ¯èª¤

---

## ğŸ“ å¦‚æœå•é¡Œä»ç„¶å­˜åœ¨

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥é©Ÿä¿®å¾©å¾Œå•é¡Œä»ç„¶å­˜åœ¨ï¼Œè«‹æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **å¾Œç«¯æœå‹™æ—¥èªŒ**ï¼š
   ```bash
   sudo journalctl -u luckyred-api -n 100 > backend_logs.txt
   ```

2. **å·¥ä½œç¯€é»æ—¥èªŒ**ï¼šå¾é›»è…¦001å’Œé›»è…¦002çš„ CMD çª—å£è¤‡è£½å®Œæ•´çš„æ—¥èªŒè¼¸å‡º

3. **ç¶²çµ¡æ¸¬è©¦çµæœ**ï¼š
   ```bash
   # åœ¨æœå‹™å™¨ä¸Š
   curl -v https://aikz.usdt2026.cc/api/v1/health
   ```

4. **Excel æ–‡ä»¶æ ¼å¼**ï¼šç¢ºèª Excel æ–‡ä»¶çš„åˆ—çµæ§‹

5. **Telethon ç‰ˆæœ¬**ï¼š
   ```bash
   python -m pip show telethon
   ```

---

## âœ… æˆåŠŸæ¨™èªŒ

ä¿®å¾©æˆåŠŸå¾Œï¼Œæ‚¨æ‡‰è©²çœ‹åˆ°ï¼š

1. âœ… å‰ç«¯æ§åˆ¶å°æ²’æœ‰ 502 éŒ¯èª¤
2. âœ… ç¶²é å¯ä»¥é¡¯ç¤ºå·¥ä½œç¯€é»åˆ—è¡¨ï¼ˆPC-001 å’Œ PC-002ï¼‰
3. âœ… æ¯å€‹å·¥ä½œç¯€é»é¡¯ç¤ºã€Œåœ¨ç·šã€ç‹€æ…‹
4. âœ… å¸³è™Ÿåˆ—è¡¨é¡¯ç¤ºæ­£ç¢ºçš„ Telegram IDï¼ˆä¸å†æ˜¯ N/Aï¼‰
5. âœ… å¯ä»¥é€šéç¶²é æ§åˆ¶å·¥ä½œç¯€é»å’Œå¸³è™Ÿ

---

æœ€å¾Œæ›´æ–°ï¼š2025-12-17
