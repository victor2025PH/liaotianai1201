# 401 认证失败问题分析

## 问题描述

所有 API 请求返回 401 Unauthorized 错误：
- `/api/v1/group-ai/accounts` → 401
- `/api/v1/group-ai/servers` → 401
- `/api/v1/group-ai/scripts` → 401

错误信息：
- "认证失败,请重新登录"
- "无法验证身份"

## 问题分析

### 好消息
✅ **Nginx 配置修复成功**：API 请求现在能正确转发到后端（不再是 404）

### 问题原因
401 错误通常由以下原因导致：
1. **用户未登录**：localStorage 中没有有效的 access_token
2. **Token 过期**：之前保存的 token 已过期
3. **Token 丢失**：浏览器清除缓存或使用无痕模式导致 token 丢失
4. **后端服务重启**：如果后端重启，可能需要重新登录

## 解决方案

### 方法 1：重新登录（最简单）

1. **访问登录页面**：
   ```
   http://aikz.usdt2026.cc/login
   ```

2. **使用默认账号登录**：
   - 邮箱：`admin@example.com`
   - 密码：`changeme123`

3. **登录成功后**，系统会自动：
   - 保存 token 到 localStorage
   - 重定向到首页
   - API 请求会自动携带 token

### 方法 2：检查并修复认证

如果重新登录后仍有问题，检查：

#### 1. 检查后端服务状态
```bash
sudo systemctl status liaotian-backend
```

#### 2. 检查后端日志
```bash
sudo journalctl -u liaotian-backend -n 50 | grep -i auth
```

#### 3. 测试登录 API
```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123"
```

应该返回：
```json
{
  "access_token": "..."
}
```

#### 4. 检查后端认证配置
```bash
# 检查是否禁用了认证
sudo grep -i "disable_auth" /home/ubuntu/liaotian/admin-backend/.env
```

## 快速修复步骤

### 在浏览器中：

1. **清除 localStorage**（如果需要）：
   ```javascript
   // 在浏览器控制台执行
   localStorage.clear()
   ```

2. **访问登录页面**：
   ```
   http://aikz.usdt2026.cc/login
   ```

3. **登录**：
   - 邮箱：`admin@example.com`
   - 密码：`changeme123`

4. **验证登录**：
   - 打开开发者工具（F12）→ Application → Local Storage
   - 应该看到 `access_token` 键

### 在服务器上验证：

```bash
# 1. 检查后端服务
sudo systemctl status liaotian-backend

# 2. 测试登录端点
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123"

# 3. 如果登录失败，检查后端日志
sudo journalctl -u liaotian-backend -n 100
```

## 预期结果

重新登录后：
- ✅ API 请求返回 200（不是 401）
- ✅ 页面正常加载
- ✅ 数据正常显示
- ✅ WebSocket 连接成功

## 总结

**当前状态：**
- ✅ Nginx 配置已修复（API 请求正确转发）
- ❌ 认证失败（需要重新登录）

**下一步：**
1. 访问 `http://aikz.usdt2026.cc/login`
2. 使用 `admin@example.com` / `changeme123` 登录
3. 验证 API 请求是否正常

