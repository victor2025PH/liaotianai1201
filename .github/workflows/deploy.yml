name: Deploy to Server

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'tgmini20251220/**'
      - 'hbwy20251220/**'
      - 'aizkw20251219/**'
      - '.github/workflows/deploy-three-sites.yml'
  workflow_dispatch:
    inputs:
      deploy_single:
        description: '部署单个 aizkw 项目'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            echo "=========================================="
            echo "🚀 开始部署"
            echo "时间: $(date)"
            echo "=========================================="
            echo ""
            
            # 项目目录
            PROJECT_DIR="/home/ubuntu/aizkw20251219"
            
            # 检查项目目录是否存在
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "❌ 项目目录不存在: $PROJECT_DIR"
              echo "正在创建目录并克隆项目..."
              mkdir -p "$(dirname "$PROJECT_DIR")"
              cd "$(dirname "$PROJECT_DIR")"
              git clone https://github.com/victor2025PH/liaotianai1201.git "$(basename "$PROJECT_DIR")" || {
                echo "❌ Git clone 失败"
                exit 1
              }
            fi
            
            # 进入项目目录
            echo "📁 进入项目目录: $PROJECT_DIR"
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录"
              exit 1
            }
            
            echo "当前目录: $(pwd)"
            echo ""
            
            # 检查是否是 git 仓库
            if [ ! -d ".git" ]; then
              echo "❌ 当前目录不是 git 仓库"
              echo "正在初始化 git 仓库..."
              git init
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            # 拉取最新代码
            echo "📥 [1/5] 拉取最新代码..."
            echo "----------------------------------------"
            
            # 获取远程分支信息
            git fetch origin main || git fetch origin || true
            
            # 强制重置到远程 main 分支
            echo "强制同步到 origin/main..."
            git reset --hard origin/main || {
              echo "⚠️  git reset 失败，尝试 git pull..."
              git pull origin main || {
                echo "❌ Git pull 失败"
                exit 1
              }
            }
            
            # 再次拉取确保最新
            git pull origin main || {
              echo "⚠️  Git pull 失败，但继续执行..."
            }
            
            echo "✅ 代码同步完成"
            echo "最新提交: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # 检查 package.json 是否存在（扁平结构，直接在项目根目录）
            if [ ! -f "$PROJECT_DIR/package.json" ]; then
              echo "❌ package.json 不存在于项目根目录: $PROJECT_DIR"
              echo "检查项目结构..."
              ls -la "$PROJECT_DIR" | head -20
              exit 1
            fi
            
            echo "✅ 找到 package.json"
            echo ""
            
            # 安装依赖（在项目根目录）
            echo "📦 [2/5] 安装依赖..."
            echo "----------------------------------------"
            
            # 确保在项目根目录
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录"
              exit 1
            }
            
            # 安装依赖
            npm install || {
              echo "❌ npm install 失败"
              exit 1
            }
            
            echo "✅ 依赖安装完成"
            echo ""
            
            # 构建前端（在项目根目录）
            echo "🔨 [3/5] 构建前端..."
            echo "----------------------------------------"
            
            # 设置 Node.js 内存限制（防止内存溢出）
            export NODE_OPTIONS="--max-old-space-size=3072"
            
            npm run build || {
              echo "❌ npm run build 失败"
              exit 1
            }
            
            echo "✅ 前端构建完成"
            echo ""
            
            # 检查构建输出（Vite 项目通常是 dist 目录，Next.js 是 .next 目录）
            if [ -d "dist" ]; then
              echo "✅ 构建输出目录存在: dist"
              echo "构建输出大小: $(du -sh dist | cut -f1)"
              IS_NEXTJS=false
              IS_VITE=true
            elif [ -d ".next" ]; then
              echo "✅ 构建输出目录存在: .next"
              IS_NEXTJS=true
              IS_VITE=false
              
              # 验证 Next.js 构建完整性
              if [ -f ".next/BUILD_ID" ]; then
                BUILD_ID=$(cat .next/BUILD_ID)
                echo "✅ BUILD_ID: $BUILD_ID"
              else
                echo "⚠️  警告: BUILD_ID 不存在，构建可能不完整"
              fi
              
              # 检查 standalone 输出
              if [ -f ".next/standalone/server.js" ]; then
                echo "✅ standalone/server.js 存在"
              else
                echo "⚠️  警告: standalone/server.js 不存在"
                echo "检查 standalone 目录..."
                ls -la .next/standalone/ 2>/dev/null | head -10 || echo "standalone 目录不存在"
              fi
            else
              echo "❌ 错误: 未找到 dist 或 .next 目录，构建可能失败"
              echo "检查当前目录内容:"
              ls -la | head -20
              exit 1
            fi
            
            # 如果是 Next.js 项目，需要启动应用服务器
            if [ "$IS_NEXTJS" = "true" ]; then
              echo ""
              echo "🚀 [4/5] 启动 Next.js 应用服务器..."
              echo "----------------------------------------"
              
              # 停止可能运行在端口 3000 的进程
              if sudo lsof -i :3000 >/dev/null 2>&1; then
                echo "停止占用端口 3000 的进程..."
                sudo lsof -ti :3000 | xargs sudo kill -9 2>/dev/null || true
                sleep 2
              fi
              
              # 停止并删除 PM2 旧进程
              pm2 delete frontend 2>/dev/null || true
              
              # 确保日志目录存在
              mkdir -p "$PROJECT_DIR/logs"
              
              # 检查 standalone 输出
              if [ -f ".next/standalone/server.js" ]; then
                echo "✅ 检测到 standalone 模式，使用 node .next/standalone/server.js"
                USE_STANDALONE=true
              else
                echo "⚠️  standalone/server.js 不存在，检查是否有 .next 目录..."
                if [ -d ".next" ]; then
                  echo "✅ .next 目录存在，但 standalone 输出可能未生成"
                  echo "检查构建输出..."
                  ls -la .next/ | head -10
                  USE_STANDALONE=false
                else
                  echo "❌ .next 目录不存在，构建可能失败"
                  exit 1
                fi
              fi
              
              # 使用 PM2 启动（如果可用）
              if command -v pm2 >/dev/null 2>&1; then
                echo "使用 PM2 启动应用..."
                cd "$PROJECT_DIR"
                
                if [ "$USE_STANDALONE" = "true" ]; then
                  # standalone 模式：使用环境变量，不要传递命令行参数
                  pm2 start "node .next/standalone/server.js" \
                    --name frontend \
                    --interpreter node \
                    --env NODE_ENV=production \
                    --env PORT=3000 \
                    --env HOSTNAME=0.0.0.0 \
                    --env NODE_OPTIONS="--max-old-space-size=3072" \
                    --error "$PROJECT_DIR/logs/frontend-error.log" \
                    --output "$PROJECT_DIR/logs/frontend-out.log" \
                    --merge-logs \
                    --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
                    echo "⚠️  PM2 启动失败，查看错误..."
                    pm2 logs frontend --lines 10 --nostream 2>/dev/null || true
                    exit 1
                  }
                else
                  # 标准模式：使用 npm start
                  pm2 start npm \
                    --name frontend \
                    -- start \
                    --env NODE_ENV=production \
                    --env PORT=3000 \
                    --env NODE_OPTIONS="--max-old-space-size=3072" \
                    --error "$PROJECT_DIR/logs/frontend-error.log" \
                    --output "$PROJECT_DIR/logs/frontend-out.log" \
                    --merge-logs \
                    --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
                    echo "⚠️  PM2 启动失败，查看错误..."
                    pm2 logs frontend --lines 10 --nostream 2>/dev/null || true
                    exit 1
                  }
                fi
                
                pm2 save || true
                echo "✅ PM2 应用已启动"
                pm2 list | grep frontend || true
                
                # 等待启动
                echo "等待应用启动..."
                sleep 8
                
                # 检查 PM2 状态
                pm2 describe frontend | grep -E "status|pid|uptime" || true
                
              else
                # 使用 nohup 后台启动
                echo "使用 nohup 后台启动应用..."
                cd "$PROJECT_DIR"
                
                # 设置环境变量
                export NODE_ENV=production
                export PORT=3000
                export HOSTNAME=0.0.0.0
                export NODE_OPTIONS="--max-old-space-size=3072"
                
                if [ "$USE_STANDALONE" = "true" ]; then
                  nohup node .next/standalone/server.js > "$PROJECT_DIR/logs/frontend-out.log" 2> "$PROJECT_DIR/logs/frontend-error.log" &
                else
                  nohup npm start > "$PROJECT_DIR/logs/frontend-out.log" 2> "$PROJECT_DIR/logs/frontend-error.log" &
                fi
                
                APP_PID=$!
                echo "应用进程 PID: $APP_PID"
                sleep 8
                
                # 检查进程是否还在运行
                if ps -p $APP_PID > /dev/null 2>&1; then
                  echo "✅ 应用已启动（PID: $APP_PID）"
                else
                  echo "❌ 应用启动失败，查看日志:"
                  tail -30 "$PROJECT_DIR/logs/frontend-error.log" 2>/dev/null || true
                  exit 1
                fi
              fi
              
              # 检查端口 3000 是否在监听
              echo "检查端口 3000..."
              sleep 2
              if sudo lsof -i :3000 >/dev/null 2>&1; then
                echo "✅ 端口 3000 正在监听"
                # 测试连接
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000 || echo "000")
                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                  echo "✅ 应用响应正常 (HTTP $HTTP_CODE)"
                else
                  echo "⚠️  应用响应异常 (HTTP $HTTP_CODE)"
                fi
              else
                echo "❌ 端口 3000 未在监听，应用可能未成功启动"
                echo "查看最新日志:"
                if command -v pm2 >/dev/null 2>&1; then
                  pm2 logs frontend --lines 20 --nostream 2>/dev/null || true
                else
                  tail -30 "$PROJECT_DIR/logs/frontend-error.log" 2>/dev/null || true
                fi
                exit 1
              fi
              
              echo ""
            fi

            # 如果是 Vite 项目，需要启动静态文件服务
            if [ "$IS_VITE" = "true" ]; then
              echo ""
              echo "🚀 [4/5] 启动 Vite 静态文件服务..."
              echo "----------------------------------------"
              
              # 检查 serve 是否安装
              if ! command -v serve >/dev/null 2>&1; then
                echo "⚠️  serve 未安装，安装 serve..."
                sudo npm install -g serve
              fi
              
              # 检查 PM2 是否安装
              if ! command -v pm2 >/dev/null 2>&1; then
                echo "⚠️  PM2 未安装，安装 PM2..."
                sudo npm install -g pm2
                pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
              fi
              
              # 确定端口（从项目配置或使用默认 3000）
              FRONTEND_PORT=3000
              if [ -f "vite.config.ts" ]; then
                # 尝试从 vite.config.ts 读取端口配置
                CONFIG_PORT=$(grep -oP "port:\s*\K\d+" vite.config.ts 2>/dev/null | head -1 || echo "")
                if [ -n "$CONFIG_PORT" ] && [ "$CONFIG_PORT" -gt 0 ] && [ "$CONFIG_PORT" -lt 65536 ]; then
                  FRONTEND_PORT=$CONFIG_PORT
                fi
              elif [ -f "vite.config.js" ]; then
                # 尝试从 vite.config.js 读取端口配置
                CONFIG_PORT=$(grep -oP "port:\s*\K\d+" vite.config.js 2>/dev/null | head -1 || echo "")
                if [ -n "$CONFIG_PORT" ] && [ "$CONFIG_PORT" -gt 0 ] && [ "$CONFIG_PORT" -lt 65536 ]; then
                  FRONTEND_PORT=$CONFIG_PORT
                fi
              fi
              
              echo "使用端口: $FRONTEND_PORT"
              
              # 停止可能运行在端口的进程
              if sudo lsof -i :$FRONTEND_PORT >/dev/null 2>&1; then
                echo "停止占用端口 $FRONTEND_PORT 的进程..."
                sudo lsof -ti :$FRONTEND_PORT | xargs sudo kill -9 2>/dev/null || true
                sleep 2
              fi
              
              # 停止并删除 PM2 旧进程
              pm2 delete frontend 2>/dev/null || true
              
              # 确保日志目录存在
              mkdir -p "$PROJECT_DIR/logs"
              
              # 确认当前目录和 dist 文件夹
              echo "当前工作目录: $(pwd)"
              echo "检查 dist 目录..."
              if [ ! -d "$PROJECT_DIR/dist" ]; then
                echo "❌ dist 目录不存在: $PROJECT_DIR/dist"
                echo "当前目录内容:"
                ls -la "$PROJECT_DIR" | head -20
                exit 1
              fi
              echo "✅ dist 目录存在: $PROJECT_DIR/dist"
              echo "dist 目录大小: $(du -sh $PROJECT_DIR/dist | cut -f1)"
              
              # 进入项目目录
              cd "$PROJECT_DIR" || {
                echo "❌ 无法进入项目目录: $PROJECT_DIR"
                exit 1
              }
              
              # 生成启动脚本（直接在脚本中写入路径和端口，避免参数传递问题）
              echo "生成启动脚本..."
              START_SCRIPT="$PROJECT_DIR/start-frontend.sh"
              printf '#!/bin/bash\n# 前端服务启动脚本\n# 使用全局 serve 命令启动静态文件服务\nset -e\nDIST_DIR="%s"\nPORT=%s\n# 检查 serve 命令是否存在\nif ! command -v serve >/dev/null 2>&1; then\n  echo "错误: serve 命令未找到，请先安装: npm install -g serve"\n  exit 1\nfi\n# 检查 dist 目录是否存在\nif [ ! -d "$DIST_DIR" ]; then\n  echo "错误: dist 目录不存在: $DIST_DIR"\n  exit 1\nfi\n# 启动 serve（移除不支持的 --no-open 选项）\nexec serve -s "$DIST_DIR" -l "$PORT" --no-clipboard\n' "$PROJECT_DIR/dist" "$FRONTEND_PORT" > "$START_SCRIPT"
              
              chmod +x "$START_SCRIPT"
              echo "✅ 启动脚本已生成: $START_SCRIPT"
              echo "启动脚本内容:"
              cat "$START_SCRIPT"
              echo ""
              
              # 使用 PM2 启动脚本（不需要传递参数，路径已写入脚本）
              echo "使用 PM2 启动前端服务..."
              pm2 start "$START_SCRIPT" \
                --name frontend \
                --error "$PROJECT_DIR/logs/frontend-error.log" \
                --output "$PROJECT_DIR/logs/frontend-out.log" \
                --merge-logs \
                --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
                echo "⚠️  PM2 启动失败，查看错误..."
                pm2 logs frontend --lines 50 --nostream 2>/dev/null || true
                echo "查看 PM2 进程状态:"
                pm2 list || true
                exit 1
              }
              
              pm2 save || true
              echo "✅ PM2 应用已启动"
              pm2 list | grep frontend || true
              
              # 立即检查 PM2 状态
              echo "检查 PM2 进程状态..."
              sleep 2
              PM2_STATUS=$(pm2 describe frontend 2>/dev/null | grep -E "status|restarts" || echo "")
              echo "PM2 状态: $PM2_STATUS"
              if echo "$PM2_STATUS" | grep -q "errored\|stopped"; then
                echo "⚠️  PM2 进程状态异常，查看日志..."
                pm2 logs frontend --lines 30 --nostream 2>/dev/null || true
              fi
              
              # 等待启动（延长等待时间，给 Node.js 应用更多启动时间）
              echo "等待服务启动..."
              sleep 13
              
              # 检查端口是否在监听
              echo "检查端口 $FRONTEND_PORT..."
              sleep 2
              # 验证端口号是有效数字
              if ! [[ "$FRONTEND_PORT" =~ ^[0-9]+$ ]] || [ "$FRONTEND_PORT" -lt 1 ] || [ "$FRONTEND_PORT" -gt 65535 ]; then
                echo "❌ 无效的端口号: $FRONTEND_PORT"
                echo "使用默认端口 3000"
                FRONTEND_PORT=3000
              fi
              if sudo lsof -i :$FRONTEND_PORT >/dev/null 2>&1; then
                echo "✅ 端口 $FRONTEND_PORT 正在监听"
                # 测试连接
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$FRONTEND_PORT || echo "000")
                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                  echo "✅ 应用响应正常 (HTTP $HTTP_CODE)"
                else
                  echo "⚠️  应用响应异常 (HTTP $HTTP_CODE)"
                  pm2 logs frontend --lines 10 --nostream 2>/dev/null || true
                fi
              else
                echo "❌ 端口 $FRONTEND_PORT 未在监听，应用可能未成功启动"
                echo "=========================================="
                echo "🔍 详细错误诊断..."
                echo "=========================================="
                echo "PM2 进程状态:"
                pm2 list || true
                echo ""
                echo "PM2 进程详情:"
                pm2 describe frontend || true
                echo ""
                echo "PM2 最新日志 (最后 50 行):"
                pm2 logs frontend --lines 50 --nostream 2>/dev/null || true
                echo ""
                echo "检查进程是否在运行:"
                ps aux | grep -E "serve|frontend" | grep -v grep || true
                echo ""
                echo "检查端口占用:"
                sudo lsof -i :$FRONTEND_PORT || echo "端口未被占用"
                echo ""
                echo "查看错误日志文件:"
                tail -50 "$PROJECT_DIR/logs/frontend-error.log" 2>/dev/null || echo "错误日志文件不存在"
                echo ""
                echo "查看输出日志文件:"
                tail -50 "$PROJECT_DIR/logs/frontend-out.log" 2>/dev/null || echo "输出日志文件不存在"
                exit 1
              fi
              
              echo ""
            fi

            # 重载 Nginx
            echo "🔄 [5/5] 重载 Nginx..."
            echo "----------------------------------------"
            
            # 检查 Nginx 是否安装
            if ! command -v nginx >/dev/null 2>&1; then
              echo "⚠️  Nginx 未安装，安装 Nginx..."
              sudo apt-get update -qq
              sudo apt-get install -y nginx || {
                echo "❌ Nginx 安装失败"
                exit 1
              }
            fi
            echo "✅ Nginx 已安装: $(nginx -v 2>&1 || echo '已安装')"
            
            # 检查 Nginx 服务状态
            NGINX_STATUS=$(sudo systemctl is-active nginx 2>/dev/null || echo "inactive")
            echo "Nginx 服务状态: $NGINX_STATUS"
            
            if [ "$NGINX_STATUS" = "active" ]; then
              echo "✅ Nginx 服务正在运行，执行 reload..."
              if sudo systemctl reload nginx 2>&1; then
                echo "✅ Nginx reload 成功"
              else
                echo "⚠️  Nginx reload 失败，尝试 restart..."
                if sudo systemctl restart nginx 2>&1; then
                  echo "✅ Nginx restart 成功"
                else
                  echo "❌ Nginx restart 失败"
                  echo "查看 Nginx 状态:"
                  sudo systemctl status nginx --no-pager -l || true
                  echo "查看 Nginx 错误日志:"
                  sudo tail -20 /var/log/nginx/error.log 2>/dev/null || true
                  exit 1
                fi
              fi
            else
              echo "⚠️  Nginx 服务未运行，启动 Nginx..."
              sudo systemctl enable nginx || true
              
              if sudo systemctl start nginx 2>&1; then
                echo "✅ Nginx 服务已启动"
              else
                echo "❌ Nginx start 失败，查看状态..."
                sudo systemctl status nginx --no-pager -l || true
                echo "查看 Nginx 错误日志:"
                sudo tail -20 /var/log/nginx/error.log 2>/dev/null || true
                echo "尝试重新安装并启动 Nginx..."
                sudo apt-get update -qq
                sudo apt-get install -y nginx || {
                  echo "❌ Nginx 安装失败"
                  exit 1
                }
                sudo systemctl enable nginx
                if sudo systemctl start nginx 2>&1; then
                  echo "✅ Nginx 服务已启动"
                else
                  echo "❌ Nginx 启动失败"
                  sudo systemctl status nginx --no-pager -l || true
                  exit 1
                fi
              fi
            fi
            
            echo "✅ Nginx 重载完成"
            echo ""
            
            # 验证服务状态
            echo "🔍 验证服务状态..."
            echo "----------------------------------------"
            
            # 检查 Nginx 状态
            if sudo systemctl is-active --quiet nginx; then
              echo "✅ Nginx 服务运行中"
            else
              echo "⚠️  Nginx 服务未运行"
            fi
            
            # 检查端口占用
            if sudo lsof -i :80 >/dev/null 2>&1; then
              echo "✅ 端口 80 已被占用（Nginx 可能正在运行）"
            else
              echo "⚠️  端口 80 未被占用"
            fi
            
            echo ""
            echo "=========================================="
            echo "✅ 部署完成！"
            echo "时间: $(date)"
            echo "=========================================="
