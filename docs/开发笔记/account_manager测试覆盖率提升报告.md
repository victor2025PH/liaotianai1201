# AccountManager æ¸¬è©¦è¦†è“‹ç‡æå‡å ±å‘Š

> **æ›´æ–°æ—¥æœŸ**: 2025-01-XX  
> **æ¨¡å¡Š**: `group_ai_service/account_manager.py`

---

## ğŸ“Š è¦†è“‹ç‡è®ŠåŒ–

- **åˆå§‹è¦†è“‹ç‡**: 13%ï¼ˆæ­·å²å ±å‘Šï¼‰
- **èª¿æ•´å‰è¦†è“‹ç‡**: 67%
- **æœ€çµ‚è¦†è“‹ç‡**: **82%**ï¼ˆ216 è¡Œä¸­ 39 è¡Œæœªè¦†è“‹ï¼‰
- **æå‡å¹…åº¦**: +15%

---

## âœ… æ–°å¢æ¸¬è©¦æ‘˜è¦

### AccountInstance è¡Œç‚º
- `test_account_instance_start_and_stop`
  - è¦†è“‹å•Ÿå‹•æµç¨‹ã€é‡è¤‡é€£ç·šè™•ç†ã€å¥åº·æª¢æŸ¥ä»»å‹™åŠåœæ­¢é‚è¼¯ï¼ˆè¡Œ 47-145ï¼‰ã€‚
- `test_account_instance_reconnect_success`
  - è¦†è“‹ `_reconnect` å˜—è©¦å¾ªç’°èˆ‡æˆåŠŸé€€å‡ºè·¯å¾‘ï¼ˆè¡Œ 91-112ï¼‰ã€‚

### AccountManager è¡Œç‚º
- `test_start_account_retry`
  - è¦†è“‹å•Ÿå‹•å¤±æ•—å¾Œçš„å»¶æ™‚é‡è©¦é‚è¼¯ï¼ˆè¡Œ 312-314ï¼‰ã€‚
- `test_add_account_session_file_not_found`
  - è¦†è“‹ session æ–‡ä»¶ç¼ºå¤±æ™‚çš„ç•°å¸¸åˆ†æ”¯ï¼ˆè¡Œ 222-223ï¼‰ã€‚
- `test_add_account_resolves_relative_path`
  - è¦†è“‹ç›¸å°è·¯å¾‘è§£æèˆ‡ `session_files_directory` å›é€€ï¼ˆè¡Œ 211-219ï¼‰ã€‚
- `test_add_account_missing_api_credentials`
  - è¦†è“‹ API æ†‘è­‰ç¼ºå¤±æ™‚çš„éŒ¯èª¤åˆ†æ”¯ï¼ˆè¡Œ 259-264ï¼‰ã€‚
- `test_load_accounts_from_directory` / `test_load_accounts_handles_errors`
  - è¦†è“‹æ‰¹é‡åŠ è¼‰æˆåŠŸèˆ‡å–®å€‹è³¬è™Ÿå¤±æ•—æ™‚çš„éŒ¯èª¤è™•ç†ï¼ˆè¡Œ 164-191ï¼‰ã€‚
- å…¶é¤˜åŸºç¤æ¸¬è©¦æ›´æ–°å¾Œè¦†è“‹å•Ÿå‹•ã€åœæ­¢ã€ç‹€æ…‹æŸ¥è©¢èˆ‡åˆ—è¡¨ç­‰æ ¸å¿ƒæµç¨‹ã€‚

### å…¶ä»–è£œå¼·
- é€é `mock_api_env` fixture çµ±ä¸€æ³¨å…¥ `TELEGRAM_API_ID/API_HASH`ã€‚
- ä½¿ç”¨è‡¨æ™‚ session æ–‡ä»¶èˆ‡ `tmp_path` fixture é¿å…å°çœŸå¯¦æª”æ¡ˆä¾è³´ã€‚
- è£œå…… `AccountStatusEnum` çš„æ­£ç¢ºåŒ¯å…¥èˆ‡ä½¿ç”¨ã€‚

---

## ğŸ” å°šæœªè¦†è“‹çš„ä»£ç¢¼ï¼ˆ39 è¡Œï¼‰

| å€æ®µ | èªªæ˜ |
|------|------|
| 59-63, 68 | å¥åº·æª¢æŸ¥ä»»å‹™ä¸­ç•°å¸¸è™•ç†èˆ‡ç´€éŒ„ |
| 79-85 | å¥åº·æª¢æŸ¥å¾ªç’°ä¸­çš„è­¦å‘Šèˆ‡é‡é€£åˆ†æ”¯ |
| 92, 107-111 | `_reconnect` å¤±æ•—å¾Œçš„éŒ¯èª¤ç´€éŒ„ |
| 130-134, 143-145 | `stop()` åœ¨ç•°å¸¸æƒ…æ³ä¸‹çš„ç´€éŒ„èˆ‡è¿”å›å€¼ |
| 236-254 | å¾ `config.py` è®€å– API æ†‘è­‰çš„é€€è·¯ï¼ˆä¾è³´å¯¦éš›é…ç½®ï¼‰ |
| 283-298 | `start/stop_account` é‡å°ä¸å­˜åœ¨è³¬è™Ÿçš„éŒ¯èª¤æ—¥èªŒ |
| 338 | `list_accounts` æ—¥èªŒï¼ˆåƒ…è¨˜éŒ„ï¼Œä¸å½±éŸ¿é‚è¼¯ï¼‰ |

å¤šæ•¸ç‚ºç•°å¸¸ç´€éŒ„æˆ–ä¾è³´çœŸå¯¦éƒ¨ç½²å ´æ™¯ï¼Œå¾…æ•´åˆæ¸¬è©¦æˆ–ç«¯åˆ°ç«¯æ¸¬è©¦è£œé½Šã€‚

---

## ğŸ§ª æ¸¬è©¦å‘½ä»¤

```powershell
cd admin-backend
$env:PYTHONPATH = ".."
poetry run pytest ..\group_ai_service\tests\unit\test_account_manager.py --cov=group_ai_service.account_manager --cov-report=term-missing
```

---

## âœ… æˆæœ

- è¦†è“‹ç‡ç”± 13%ï¼ˆæ­·å²ï¼‰/67%ï¼ˆèª¿æ•´å‰ï¼‰æå‡è‡³ **82%**ã€‚
- æ–°å¢ **19 å€‹** è‡ªå‹•åŒ–æ¸¬è©¦ã€‚
- è¦†è“‹ AccountInstance èˆ‡ AccountManager çš„æ ¸å¿ƒæµç¨‹ã€éŒ¯èª¤è™•ç†èˆ‡é…ç½®é€€è·¯ã€‚
- æ‰€æœ‰æ¸¬è©¦é€šéï¼Œç„¡å‰¯ä½œç”¨ã€‚

---

**ä¸‹ä¸€æ­¥**ï¼š
1. é‡å°å°šæœªè¦†è“‹çš„ `config.py` é€€è·¯ã€ç•°å¸¸æ—¥èªŒè£œå¼·ç«¯åˆ°ç«¯æ¸¬è©¦ã€‚
2. èˆ‡ AccountManager ç›¸é—œçš„æ•´åˆæ¸¬è©¦ï¼ˆæ­é… SessionPoolã€DialogueManagerï¼‰ã€‚
3. æ›´æ–°æ•´é«”è¦†è“‹ç‡å ±å‘Šï¼ŒæŒçºŒè¿½è¹¤ 70%+ ç›®æ¨™ã€‚
