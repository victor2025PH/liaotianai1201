name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            echo "=========================================="
            echo "🚀 开始部署"
            echo "时间: $(date)"
            echo "=========================================="
            echo ""
            
            # 项目目录
            PROJECT_DIR="/home/ubuntu/aizkw20251219"
            
            # 检查项目目录是否存在
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "❌ 项目目录不存在: $PROJECT_DIR"
              echo "正在创建目录并克隆项目..."
              mkdir -p "$(dirname "$PROJECT_DIR")"
              cd "$(dirname "$PROJECT_DIR")"
              git clone https://github.com/victor2025PH/liaotianai1201.git "$(basename "$PROJECT_DIR")" || {
                echo "❌ Git clone 失败"
                exit 1
              }
            fi
            
            # 进入项目目录
            echo "📁 进入项目目录: $PROJECT_DIR"
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录"
              exit 1
            }
            
            echo "当前目录: $(pwd)"
            echo ""
            
            # 检查是否是 git 仓库
            if [ ! -d ".git" ]; then
              echo "❌ 当前目录不是 git 仓库"
              echo "正在初始化 git 仓库..."
              git init
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            # 拉取最新代码
            echo "📥 [1/4] 拉取最新代码..."
            echo "----------------------------------------"
            
            # 获取远程分支信息
            git fetch origin main || git fetch origin || true
            
            # 强制重置到远程 main 分支
            echo "强制同步到 origin/main..."
            git reset --hard origin/main || {
              echo "⚠️  git reset 失败，尝试 git pull..."
              git pull origin main || {
                echo "❌ Git pull 失败"
                exit 1
              }
            }
            
            # 再次拉取确保最新
            git pull origin main || {
              echo "⚠️  Git pull 失败，但继续执行..."
            }
            
            echo "✅ 代码同步完成"
            echo "最新提交: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # 检查 package.json 是否存在（扁平结构，直接在项目根目录）
            if [ ! -f "$PROJECT_DIR/package.json" ]; then
              echo "❌ package.json 不存在于项目根目录: $PROJECT_DIR"
              echo "检查项目结构..."
              ls -la "$PROJECT_DIR" | head -20
              exit 1
            fi
            
            echo "✅ 找到 package.json"
            echo ""
            
            # 安装依赖（在项目根目录）
            echo "📦 [2/4] 安装依赖..."
            echo "----------------------------------------"
            
            # 确保在项目根目录
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录"
              exit 1
            }
            
            # 安装依赖
            npm install || {
              echo "❌ npm install 失败"
              exit 1
            }
            
            echo "✅ 依赖安装完成"
            echo ""
            
            # 构建前端（在项目根目录）
            echo "🔨 [3/4] 构建前端..."
            echo "----------------------------------------"
            
            # 设置 Node.js 内存限制（防止内存溢出）
            export NODE_OPTIONS="--max-old-space-size=3072"
            
            npm run build || {
              echo "❌ npm run build 失败"
              exit 1
            }
            
            echo "✅ 前端构建完成"
            echo ""
            
            # 检查构建输出（Vite 项目通常是 dist 目录，Next.js 是 .next 目录）
            if [ -d "dist" ]; then
              echo "✅ 构建输出目录存在: dist"
              IS_NEXTJS=false
            elif [ -d ".next" ]; then
              echo "✅ 构建输出目录存在: .next"
              IS_NEXTJS=true
            else
              echo "⚠️  警告: 未找到 dist 或 .next 目录，但继续部署"
              IS_NEXTJS=false
            fi
            
            # 如果是 Next.js 项目，需要启动应用服务器
            if [ "$IS_NEXTJS" = "true" ]; then
              echo ""
              echo "🚀 [4/5] 启动 Next.js 应用服务器..."
              echo "----------------------------------------"
              
              # 停止可能运行在端口 3000 的进程
              if sudo lsof -i :3000 >/dev/null 2>&1; then
                echo "停止占用端口 3000 的进程..."
                sudo lsof -ti :3000 | xargs sudo kill -9 2>/dev/null || true
                sleep 2
              fi
              
              # 设置环境变量
              export NODE_ENV=production
              export PORT=3000
              export NODE_OPTIONS="--max-old-space-size=3072"
              
              # 检查 standalone 输出
              if [ -f ".next/standalone/server.js" ]; then
                echo "使用 standalone 模式启动..."
                START_CMD="node .next/standalone/server.js"
              else
                echo "使用标准模式启动..."
                START_CMD="npm start"
              fi
              
              # 使用 PM2 启动（如果可用）
              if command -v pm2 >/dev/null 2>&1; then
                echo "使用 PM2 启动应用..."
                
                # 确保日志目录存在
                mkdir -p "$PROJECT_DIR/logs"
                
                # 停止并删除旧进程
                pm2 delete frontend 2>/dev/null || true
                
                # 启动应用
                cd "$PROJECT_DIR"
                pm2 start "$START_CMD" --name frontend -- \
                  --port 3000 \
                  --hostname 0.0.0.0 || {
                  echo "⚠️  PM2 启动失败，尝试 nohup..."
                  nohup $START_CMD > "$PROJECT_DIR/logs/frontend-out.log" 2> "$PROJECT_DIR/logs/frontend-error.log" &
                  sleep 5
                }
                
                pm2 save || true
                echo "✅ PM2 应用已启动"
                pm2 list | grep frontend || true
              else
                # 使用 nohup 后台启动
                echo "使用 nohup 后台启动应用..."
                mkdir -p "$PROJECT_DIR/logs"
                cd "$PROJECT_DIR"
                nohup $START_CMD > "$PROJECT_DIR/logs/frontend-out.log" 2> "$PROJECT_DIR/logs/frontend-error.log" &
                APP_PID=$!
                echo "应用进程 PID: $APP_PID"
                sleep 5
                
                # 检查进程是否还在运行
                if ps -p $APP_PID > /dev/null 2>&1; then
                  echo "✅ 应用已启动（PID: $APP_PID）"
                else
                  echo "⚠️  应用启动可能失败，查看日志:"
                  tail -20 "$PROJECT_DIR/logs/frontend-error.log" 2>/dev/null || true
                fi
              fi
              
              # 等待应用启动并检查端口
              echo "等待应用启动..."
              sleep 5
              
              if sudo lsof -i :3000 >/dev/null 2>&1; then
                echo "✅ 端口 3000 正在监听"
              else
                echo "⚠️  警告: 端口 3000 未在监听，应用可能未成功启动"
              fi
              
              echo ""
            fi
            
            # 重载 Nginx
            echo "🔄 [5/5] 重载 Nginx..."
            echo "----------------------------------------"
            
            sudo systemctl reload nginx || {
              echo "⚠️  Nginx reload 失败，尝试 restart..."
              sudo systemctl restart nginx || {
                echo "❌ Nginx restart 失败"
                exit 1
              }
            }
            
            echo "✅ Nginx 重载完成"
            echo ""
            
            # 验证服务状态
            echo "🔍 验证服务状态..."
            echo "----------------------------------------"
            
            # 检查 Nginx 状态
            if sudo systemctl is-active --quiet nginx; then
              echo "✅ Nginx 服务运行中"
            else
              echo "⚠️  Nginx 服务未运行"
            fi
            
            # 检查端口占用
            if sudo lsof -i :80 >/dev/null 2>&1; then
              echo "✅ 端口 80 已被占用（Nginx 可能正在运行）"
            else
              echo "⚠️  端口 80 未被占用"
            fi
            
            echo ""
            echo "=========================================="
            echo "✅ 部署完成！"
            echo "时间: $(date)"
            echo "=========================================="
