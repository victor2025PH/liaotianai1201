# 監控告警系統完善報告

> **完成日期**: 2025-01-XX  
> **狀態**: ✅ 全部完成

---

## 完成項目總覽

本次完善了監控告警系統，實現了以下功能：

1. ✅ **擴展告警規則** - 新增4種告警規則類型
2. ✅ **實現告警通知機制** - 支持郵件、Telegram、Webhook三種通知方式
3. ✅ **可配置的告警閾值** - 所有閾值可通過配置文件調整

---

## 詳細實現說明

### 1. ✅ 擴展告警規則

**文件**: `group_ai_service/monitor_service.py`

**新增告警規則類型**:

#### 1.1 賬號錯誤率告警（已存在，已優化）
- **錯誤級別**: 錯誤率超過配置閾值（默認 50%）
- **警告級別**: 錯誤率超過配置閾值（默認 20%）
- **可配置**: `alert_error_rate_threshold`, `alert_warning_rate_threshold`

#### 1.2 賬號離線告警（新增）
- **觸發條件**: 離線率超過配置閾值（默認 30%）
- **計算方式**: `離線率 = (總賬號數 - 在線賬號數) / 總賬號數`
- **可配置**: `alert_account_offline_threshold`, `alert_account_inactive_seconds`

#### 1.3 系統級錯誤數告警（已存在，已優化）
- **觸發條件**: 系統總錯誤數超過配置閾值（默認 100）
- **可配置**: `alert_system_errors_threshold`

#### 1.4 響應時間告警（新增）
- **觸發條件**: 平均響應時間超過配置閾值（默認 5000ms）
- **可配置**: `alert_response_time_threshold`

#### 1.5 紅包參與失敗率告警（新增）
- **觸發條件**: 紅包參與失敗率超過配置閾值（默認 30%）
- **計算方式**: 從事件日誌中統計紅包參與失敗次數
- **可配置**: `alert_redpacket_failure_rate_threshold`

#### 1.6 消息處理異常告警（新增）
- **觸發條件**: 最近1小時內消息處理錯誤數超過配置閾值（默認 10次）
- **計算方式**: 從事件日誌中統計最近1小時的消息處理錯誤
- **可配置**: `alert_message_processing_error_threshold`

**關鍵代碼**:
```python
def _check_default_rules(self, system_metrics: SystemMetrics) -> List[Alert]:
    """檢查默認硬編碼規則（向後兼容，使用配置文件中的閾值）"""
    # 從配置文件讀取閾值
    config = get_group_ai_config()
    error_rate_threshold = config.alert_error_rate_threshold
    account_offline_threshold = config.alert_account_offline_threshold
    # ... 其他閾值 ...
    
    # 1. 檢查賬號錯誤率
    # 2. 檢查賬號離線
    # 3. 檢查系統級錯誤數
    # 4. 檢查響應時間
    # 5. 檢查紅包參與失敗率
    # 6. 檢查消息處理異常
```

---

### 2. ✅ 實現告警通知機制

**文件**: `group_ai_service/notification_service.py` (新建)

**支持的通知方式**:

#### 2.1 郵件通知
- **功能**: 發送 HTML 格式的告警郵件
- **配置項**:
  - `alert_email_enabled`: 是否啟用郵件通知
  - `alert_email_smtp_host`: SMTP 服務器地址
  - `alert_email_smtp_port`: SMTP 端口（默認 587）
  - `alert_email_smtp_user`: SMTP 用戶名
  - `alert_email_smtp_password`: SMTP 密碼
  - `alert_email_from`: 發件人郵箱
  - `alert_email_to`: 收件人郵箱（逗號分隔）

#### 2.2 Telegram 通知
- **功能**: 通過 Telegram Bot 發送告警消息
- **配置項**:
  - `alert_telegram_enabled`: 是否啟用 Telegram 通知
  - `alert_telegram_bot_token`: Telegram Bot Token
  - `alert_telegram_chat_id`: Telegram Chat ID

#### 2.3 Webhook 通知
- **功能**: 發送 JSON 格式的告警數據到 Webhook URL
- **配置項**:
  - `alert_webhook_enabled`: 是否啟用 Webhook 通知
  - `alert_webhook_url`: Webhook URL

**關鍵代碼**:
```python
class NotificationService:
    """告警通知服務"""
    
    async def send_email(self, subject: str, body: str, html_body: Optional[str] = None, recipients: Optional[List[str]] = None) -> bool:
        """發送郵件通知"""
        # ... 實現 ...
    
    async def send_telegram(self, message: str, chat_id: Optional[str] = None) -> bool:
        """發送 Telegram 通知"""
        # ... 實現 ...
    
    async def send_webhook(self, payload: Dict[str, Any], url: Optional[str] = None) -> bool:
        """發送 Webhook 通知"""
        # ... 實現 ...
    
    async def send_alert_notification(self, alert: Dict[str, Any], notification_method: Optional[str] = None, notification_target: Optional[str] = None) -> bool:
        """發送告警通知（支持多種方式）"""
        # 根據 notification_method 選擇通知方式
        # "email", "telegram", "webhook", "all"
```

---

### 3. ✅ 可配置的告警閾值

**文件**: `group_ai_service/config.py`

**新增配置項**:

```python
# 告警配置
# 錯誤率告警閾值
alert_error_rate_threshold: float = 0.5  # 錯誤率超過 50% 觸發錯誤告警
alert_warning_rate_threshold: float = 0.2  # 錯誤率超過 20% 觸發警告告警
alert_system_errors_threshold: int = 100  # 系統總錯誤數超過此值觸發告警

# 賬號離線告警閾值
alert_account_offline_threshold: float = 0.3  # 離線率超過 30% 觸發告警
alert_account_inactive_seconds: int = 300  # 賬號無活動超過此秒數視為離線

# 響應時間告警閾值（毫秒）
alert_response_time_threshold: float = 5000.0  # 平均響應時間超過 5 秒觸發告警

# 紅包參與失敗率告警閾值
alert_redpacket_failure_rate_threshold: float = 0.3  # 紅包參與失敗率超過 30% 觸發告警

# 消息處理異常告警閾值
alert_message_processing_error_threshold: int = 10  # 每小時消息處理錯誤數超過此值觸發告警

# 通知配置
alert_notification_enabled: bool = True  # 是否啟用告警通知
alert_email_enabled: bool = False  # 是否啟用郵件通知
alert_telegram_enabled: bool = False  # 是否啟用 Telegram 通知
alert_webhook_enabled: bool = False  # 是否啟用 Webhook 通知

# 郵件通知配置
alert_email_smtp_host: Optional[str] = None
alert_email_smtp_port: int = 587
alert_email_smtp_user: Optional[str] = None
alert_email_smtp_password: Optional[str] = None
alert_email_from: Optional[str] = None
alert_email_to: Optional[str] = None  # 逗號分隔的多個郵箱

# Telegram 通知配置
alert_telegram_bot_token: Optional[str] = None
alert_telegram_chat_id: Optional[str] = None

# Webhook 通知配置
alert_webhook_url: Optional[str] = None
```

**配置方式**:
- 通過 `.env` 文件配置（使用 `GROUP_AI_` 前綴）
- 通過環境變量配置
- 支持動態讀取，無需重啟服務

---

## 修改文件清單

1. `group_ai_service/config.py` - 新增告警配置項
2. `group_ai_service/monitor_service.py` - 擴展告警規則和通知機制
3. `group_ai_service/notification_service.py` - 新建通知服務模塊

---

## 使用示例

### 配置告警閾值

在 `.env` 文件中配置：

```bash
# 告警閾值配置
GROUP_AI_ALERT_ERROR_RATE_THRESHOLD=0.5
GROUP_AI_ALERT_WARNING_RATE_THRESHOLD=0.2
GROUP_AI_ALERT_ACCOUNT_OFFLINE_THRESHOLD=0.3
GROUP_AI_ALERT_RESPONSE_TIME_THRESHOLD=5000.0
GROUP_AI_ALERT_REDPACKET_FAILURE_RATE_THRESHOLD=0.3
GROUP_AI_ALERT_MESSAGE_PROCESSING_ERROR_THRESHOLD=10

# 啟用郵件通知
GROUP_AI_ALERT_EMAIL_ENABLED=true
GROUP_AI_ALERT_EMAIL_SMTP_HOST=smtp.example.com
GROUP_AI_ALERT_EMAIL_SMTP_PORT=587
GROUP_AI_ALERT_EMAIL_SMTP_USER=alerts@example.com
GROUP_AI_ALERT_EMAIL_SMTP_PASSWORD=your_password
GROUP_AI_ALERT_EMAIL_FROM=alerts@example.com
GROUP_AI_ALERT_EMAIL_TO=admin@example.com,ops@example.com

# 啟用 Telegram 通知
GROUP_AI_ALERT_TELEGRAM_ENABLED=true
GROUP_AI_ALERT_TELEGRAM_BOT_TOKEN=your_bot_token
GROUP_AI_ALERT_TELEGRAM_CHAT_ID=your_chat_id

# 啟用 Webhook 通知
GROUP_AI_ALERT_WEBHOOK_ENABLED=true
GROUP_AI_ALERT_WEBHOOK_URL=https://your-webhook-url.com/alerts
```

### 使用監控服務

```python
from group_ai_service import MonitorService

# 創建監控服務
monitor = MonitorService()

# 記錄事件
monitor.record_message("account_1", "received", success=True)
monitor.record_reply("account_1", reply_time=1.5, success=True)
monitor.record_redpacket("account_1", success=False)

# 檢查告警（會自動發送通知）
alerts = monitor.check_alerts()

# 獲取最近的告警
recent_alerts = monitor.get_recent_alerts(limit=10)
```

---

## 告警規則詳情

### 規則列表

| 規則類型 | 觸發條件 | 告警級別 | 默認閾值 |
|---------|---------|---------|---------|
| 賬號錯誤率 | 錯誤率 > 閾值 | error/warning | 50% / 20% |
| 賬號離線 | 離線率 > 閾值 | warning | 30% |
| 系統錯誤數 | 總錯誤數 > 閾值 | error | 100 |
| 響應時間 | 平均響應時間 > 閾值 | warning | 5000ms |
| 紅包失敗率 | 失敗率 > 閾值 | warning | 30% |
| 消息處理異常 | 每小時錯誤數 > 閾值 | warning | 10次 |

---

## 通知格式示例

### 郵件通知

**主題**: 🔴 【告警】賬號 account_1 錯誤率過高: 55.00% (閾值: 50.00%)

**內容**:
```
告警詳情：
級別：ERROR
類型：error
消息：賬號 account_1 錯誤率過高: 55.00% (閾值: 50.00%)
時間：2025-01-XX 14:30:00
賬號：account_1
```

### Telegram 通知

```
🔴 告警通知

告警詳情：
級別：ERROR
類型：error
消息：賬號 account_1 錯誤率過高: 55.00% (閾值: 50.00%)
時間：2025-01-XX 14:30:00
賬號：account_1
```

### Webhook 通知

```json
{
  "type": "alert",
  "level": "error",
  "alert_type": "error",
  "message": "賬號 account_1 錯誤率過高: 55.00% (閾值: 50.00%)",
  "account_id": "account_1",
  "timestamp": "2025-01-XX 14:30:00",
  "data": {
    "alert_type": "error",
    "alert_level": "error",
    "message": "賬號 account_1 錯誤率過高: 55.00% (閾值: 50.00%)",
    "account_id": "account_1",
    "timestamp": "2025-01-XX 14:30:00"
  }
}
```

---

## 測試建議

### 1. 告警規則測試

```python
from group_ai_service import MonitorService
from datetime import timedelta

monitor = MonitorService()

# 模擬高錯誤率
for i in range(10):
    monitor.record_message("test_account", "received", success=False)

# 檢查告警
alerts = monitor.check_alerts()
print(f"觸發的告警數: {len(alerts)}")
```

### 2. 通知機制測試

```python
from group_ai_service.notification_service import get_notification_service

notification_service = get_notification_service()

# 測試郵件通知
await notification_service.send_email(
    subject="測試告警",
    body="這是一條測試告警消息",
    recipients=["test@example.com"]
)

# 測試 Telegram 通知
await notification_service.send_telegram(
    message="🔴 測試告警消息",
    chat_id="your_chat_id"
)

# 測試 Webhook 通知
await notification_service.send_webhook(
    payload={"type": "test", "message": "測試消息"},
    url="https://your-webhook-url.com"
)
```

---

## 性能優化

### 異步通知發送

- 所有通知發送都在線程池中異步執行，不阻塞主流程
- 使用 `ThreadPoolExecutor` 執行異步函數
- 通知失敗不會影響告警檢查流程

### 配置緩存

- 通知服務在初始化時加載配置
- 避免每次發送通知時都讀取配置文件

---

## 後續優化建議

### 短期（1週內）

- [ ] 添加告警靜默機制（避免重複告警）
- [ ] 添加告警聚合（相同類型的告警合併發送）
- [ ] 添加告警恢復通知

### 中期（2-4週）

- [ ] 實現告警規則的動態配置（通過 API）
- [ ] 添加告警歷史記錄（持久化到數據庫）
- [ ] 實現告警級別升級機制

### 長期（1-2個月）

- [ ] 添加告警儀表板
- [ ] 實現告警分析報告
- [ ] 支持自定義告警規則（通過腳本）

---

## 總結

監控告警系統已完善，現在支持：

1. **6種告警規則**: 錯誤率、離線、系統錯誤、響應時間、紅包失敗率、消息處理異常
2. **3種通知方式**: 郵件、Telegram、Webhook
3. **完全可配置**: 所有閾值和通知方式都可以通過配置文件調整
4. **異步通知**: 不阻塞主流程
5. **向後兼容**: 保留原有功能，新增功能可選啟用

系統現在具備完整的監控告警能力，可以及時發現和通知系統異常。

---

**狀態**: ✅ 監控告警系統完善完成，可以投入使用

