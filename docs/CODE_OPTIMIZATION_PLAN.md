# 代码优化计划

> **创建日期**: 2025-12-22  
> **状态**: 进行中

## 📊 优化概览

### 发现的问题

1. **脚本重复严重** (`scripts/server/` 目录)
   - 117+ 个脚本文件
   - 大量功能重复的脚本（如多个 fix-backend、diagnose、deploy 脚本）
   - 缺乏统一的脚本框架

2. **后端工具函数重复**
   - 多个模块中有相似的日志、重试、备份功能
   - 缺乏统一的工具库

3. **部署逻辑分散**
   - 多个部署脚本实现相似功能
   - 缺乏统一的部署框架

## 🎯 优化目标

### 第一阶段：脚本整合（高优先级）

#### 1.1 统一后端修复脚本
- **合并**: `fix_backend.sh`, `fix_backend_deps.sh`, `check-and-restart-backend.sh`
- **创建**: `scripts/server/unified-backend-manager.sh`
- **功能**: 
  - 依赖安装/修复
  - 服务启动/重启
  - 健康检查
  - 日志查看

#### 1.2 统一诊断脚本
- **合并**: 所有 `diagnose-*.sh` 脚本（20+ 个）
- **创建**: `scripts/server/unified-diagnostic.sh`
- **功能**:
  - 后端诊断
  - 前端诊断
  - Nginx 诊断
  - 系统资源诊断
  - 网络连接诊断

#### 1.3 统一部署脚本
- **合并**: `deploy.sh`, `deploy_all_files.sh`, `deploy_from_github.sh`, `initial-deploy.sh`
- **创建**: `scripts/server/unified-deploy.sh`
- **功能**:
  - 代码拉取
  - 依赖安装
  - 构建
  - 服务启动
  - 验证

#### 1.4 统一 Nginx 管理脚本
- **合并**: 所有 `fix-nginx-*.sh`, `configure-nginx-*.sh` 脚本
- **创建**: `scripts/server/unified-nginx-manager.sh`
- **功能**:
  - 配置生成
  - 配置修复
  - SSL 证书管理
  - 代理配置

### 第二阶段：后端代码优化（中优先级）

#### 2.1 统一工具库
- **创建**: `admin-backend/app/core/common_utils.py`
- **整合**:
  - 日志配置（统一 logger 设置）
  - 重试机制（统一 retry 装饰器）
  - 文件备份（统一 backup 函数）
  - 配置管理（统一 config 加载）

#### 2.2 统一错误处理
- **创建**: `admin-backend/app/core/error_handler.py`
- **功能**:
  - 统一异常类
  - 统一错误响应格式
  - 统一错误日志记录

### 第三阶段：清理和文档（低优先级）

#### 3.1 清理废弃脚本
- 标记废弃脚本为 `deprecated/`
- 更新 README 指向新脚本

#### 3.2 创建使用文档
- 统一脚本使用指南
- API 文档更新

## 📝 实施计划

### 立即执行（今天）

1. ✅ 创建优化计划文档
2. ⏳ 创建统一后端管理脚本
3. ⏳ 创建统一诊断脚本
4. ⏳ 创建统一部署脚本
5. ⏳ 创建统一 Nginx 管理脚本

### 本周完成

1. 后端工具库整合
2. 错误处理统一
3. 废弃脚本清理

### 下周完成

1. 文档更新
2. 测试验证
3. 优化报告

## 🔄 迁移策略

1. **保留旧脚本**（标记为 deprecated）
2. **新脚本提供完整功能**
3. **逐步迁移使用**
4. **3个月后删除旧脚本**

## 📈 预期收益

- **脚本数量**: 从 117+ 减少到 ~20 个核心脚本
- **维护成本**: 降低 70%
- **代码复用**: 提高 80%
- **错误率**: 降低 50%
