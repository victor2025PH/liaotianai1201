# æ•¸æ“šåº«è¡¨ç¼ºå¤±å•é¡Œè¨ºæ–·å’Œä¿®å¾©

> **æ—¥æœŸ**: 2025-12-01  
> **å•é¡Œ**: `no such table: group_ai_accounts`

---

## ğŸ“Š å•é¡Œåˆ†æ

### è¨ºæ–·çµæœ

1. âœ… **ä»£ç¢¼å·²æ›´æ–°** - `get_account_status` ç«¯é»å·²åŒ…å«æ•¸æ“šåº«æª¢æŸ¥
2. âŒ **æ•¸æ“šåº«è¡¨ä¸å­˜åœ¨** - `group_ai_accounts` è¡¨æœªå‰µå»º

### éŒ¯èª¤ä¿¡æ¯

```
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: group_ai_accounts
```

---

## ğŸ” è¨ºæ–·æ­¥é©Ÿ

### æ­¥é©Ÿ 1: æª¢æŸ¥æ•¸æ“šåº«æ–‡ä»¶ä½ç½®

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
echo "=== æª¢æŸ¥æ•¸æ“šåº«æ–‡ä»¶ ===" && \
find . -name "*.db" -type f 2>/dev/null | head -5 && \
echo "" && \
echo "=== æª¢æŸ¥ç’°å¢ƒè®Šé‡ ===" && \
python3 << 'PYEOF'
import os
from app.core.config import get_settings
settings = get_settings()
print(f"æ•¸æ“šåº« URL: {settings.database_url}")
PYEOF
```

### æ­¥é©Ÿ 2: æª¢æŸ¥ç¾æœ‰è¡¨

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
source /home/ubuntu/liaotian/admin-backend/.venv/bin/activate && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
python3 << 'PYEOF'
from app.db import engine
from sqlalchemy import inspect

inspector = inspect(engine)
tables = inspector.get_table_names()
print(f"æ•¸æ“šåº«ä¸­çš„è¡¨ ({len(tables)} å€‹):")
for table in tables:
    print(f"  - {table}")
PYEOF
```

---

## ğŸ”§ ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: åˆå§‹åŒ–æ•¸æ“šåº«è¡¨ï¼ˆæ¨è–¦ï¼‰

åŸ·è¡Œåˆå§‹åŒ–è…³æœ¬ï¼š

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
source /home/ubuntu/liaotian/admin-backend/.venv/bin/activate && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
python3 init_db_tables.py
```

### æ–¹æ¡ˆ 2: æ‰‹å‹•å‰µå»ºè¡¨

å¦‚æœ `init_db_tables.py` ä¸å­˜åœ¨æˆ–å¤±æ•—ï¼Œæ‰‹å‹•åŸ·è¡Œï¼š

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
source /home/ubuntu/liaotian/admin-backend/.venv/bin/activate && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
python3 << 'PYEOF'
from app.db import engine, Base
from app.models import group_ai  # ç¢ºä¿å°å…¥æ‰€æœ‰æ¨¡å‹
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

try:
    logger.info("é–‹å§‹å‰µå»ºæ•¸æ“šåº«è¡¨...")
    Base.metadata.create_all(bind=engine)
    logger.info("âœ… æ•¸æ“šåº«è¡¨å‰µå»ºæˆåŠŸï¼")
    
    # é©—è­‰è¡¨æ˜¯å¦å­˜åœ¨
    from sqlalchemy import inspect
    inspector = inspect(engine)
    tables = inspector.get_table_names()
    logger.info(f"æ•¸æ“šåº«ä¸­çš„è¡¨: {', '.join(tables)}")
    
    # æª¢æŸ¥é—œéµè¡¨
    required_tables = [
        'group_ai_scripts',
        'group_ai_accounts',
        'group_ai_script_versions',
        'group_ai_dialogue_history',
        'group_ai_redpacket_logs',
    ]
    
    missing_tables = [t for t in required_tables if t not in tables]
    if missing_tables:
        logger.error(f"âŒ ç¼ºå°‘è¡¨: {', '.join(missing_tables)}")
    else:
        logger.info("âœ… æ‰€æœ‰å¿…éœ€çš„è¡¨éƒ½å·²å‰µå»ºï¼")
        
except Exception as e:
    logger.error(f"âŒ å‰µå»ºæ•¸æ“šåº«è¡¨å¤±æ•—: {e}", exc_info=True)
PYEOF
```

---

## ğŸš€ å®Œæ•´è¨ºæ–·å’Œä¿®å¾©æµç¨‹

åŸ·è¡Œä»¥ä¸‹å®Œæ•´å‘½ä»¤ï¼š

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
echo "=== ã€æ­¥é©Ÿ 1ã€‘æª¢æŸ¥æ•¸æ“šåº«æ–‡ä»¶ ===" && \
find . -name "*.db" -type f 2>/dev/null | head -5 && \
echo "" && \
echo "=== ã€æ­¥é©Ÿ 2ã€‘æª¢æŸ¥ç¾æœ‰è¡¨ ===" && \
source /home/ubuntu/liaotian/admin-backend/.venv/bin/activate && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
python3 << 'PYEOF'
from app.db import engine
from sqlalchemy import inspect

inspector = inspect(engine)
tables = inspector.get_table_names()
print(f"æ•¸æ“šåº«ä¸­çš„è¡¨ ({len(tables)} å€‹):")
for table in tables:
    print(f"  - {table}")

if 'group_ai_accounts' not in tables:
    print("\nâŒ group_ai_accounts è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦åˆå§‹åŒ–")
else:
    print("\nâœ… group_ai_accounts è¡¨å­˜åœ¨")
PYEOF
echo "" && \
echo "=== ã€æ­¥é©Ÿ 3ã€‘åˆå§‹åŒ–æ•¸æ“šåº«è¡¨ ===" && \
if [ -f "init_db_tables.py" ]; then
    echo "ä½¿ç”¨ init_db_tables.py åˆå§‹åŒ–..."
    python3 init_db_tables.py
else
    echo "init_db_tables.py ä¸å­˜åœ¨ï¼Œæ‰‹å‹•å‰µå»ºè¡¨..."
    python3 << 'PYEOF'
from app.db import engine, Base
from app.models import group_ai
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

try:
    logger.info("é–‹å§‹å‰µå»ºæ•¸æ“šåº«è¡¨...")
    Base.metadata.create_all(bind=engine)
    logger.info("âœ… æ•¸æ“šåº«è¡¨å‰µå»ºæˆåŠŸï¼")
    
    from sqlalchemy import inspect
    inspector = inspect(engine)
    tables = inspector.get_table_names()
    logger.info(f"æ•¸æ“šåº«ä¸­çš„è¡¨: {', '.join(tables)}")
except Exception as e:
    logger.error(f"âŒ å‰µå»ºå¤±æ•—: {e}", exc_info=True)
PYEOF
fi
```

---

## âœ… é©—è­‰ä¿®å¾©

ä¿®å¾©å¾Œï¼Œé‡æ–°æ¸¬è©¦ï¼š

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
source /home/ubuntu/liaotian/admin-backend/.venv/bin/activate && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
python3 << 'PYEOF'
from app.db import SessionLocal
from app.models.group_ai import GroupAIAccount

db = SessionLocal()
try:
    # æ¸¬è©¦æŸ¥è©¢
    count = db.query(GroupAIAccount).count()
    print(f"âœ… æ•¸æ“šåº«è¡¨æ­£å¸¸ï¼Œå…±æœ‰ {count} å€‹è³¬è™Ÿ")
    
    # åˆ—å‡ºæ‰€æœ‰è³¬è™Ÿ
    accounts = db.query(GroupAIAccount).all()
    if accounts:
        print("\næ•¸æ“šåº«ä¸­çš„è³¬è™Ÿ:")
        for acc in accounts:
            print(f"  - {acc.account_id}: {acc.name or 'ç„¡åç¨±'}")
    else:
        print("\næ•¸æ“šåº«ä¸­æ²’æœ‰è³¬è™Ÿï¼ˆè¡¨å·²å‰µå»ºä½†ç‚ºç©ºï¼‰")
except Exception as e:
    print(f"âŒ æŸ¥è©¢å¤±æ•—: {e}")
finally:
    db.close()
PYEOF
```

---

**è«‹åŸ·è¡Œå®Œæ•´è¨ºæ–·å’Œä¿®å¾©æµç¨‹ï¼**
