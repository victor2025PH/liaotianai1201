# 賬號安全運行指南

> **更新日期**: 2025-01-16  
> **重要**: 本指南提供 Telegram 賬號安全運行的最佳實踐

---

## 📋 目錄

1. [測試劇本](#測試劇本)
2. [多服務器/電腦運行](#多服務器電腦運行)
3. [單台服務器安全運行數量](#單台服務器安全運行數量)
4. [防封號策略](#防封號策略)
5. [監控和預警](#監控和預警)

---

## 🧪 測試劇本

### 方法 1: 使用前端界面測試（推薦）

1. **訪問劇本管理頁面**
   - URL: `http://localhost:3000/group-ai/scripts`
   - 點擊「創建劇本」或選擇現有劇本

2. **使用測試功能**
   - 在劇本列表中，點擊「測試」按鈕
   - 輸入測試消息（例如："你好"）
   - 查看 AI 回復結果

3. **驗證劇本邏輯**
   - 測試不同場景的觸發條件
   - 檢查回復是否符合預期
   - 驗證角色分配是否正確

### 方法 2: 使用 API 測試

```bash
# 測試劇本
curl -X POST "http://localhost:8000/api/v1/group-ai/scripts/{script_id}/test" \
  -H "Content-Type: application/json" \
  -d '{"message_text": "你好"}'
```

### 方法 3: 在測試群組中測試

1. **創建測試群組**
   - 創建一個私有 Telegram 群組
   - 僅添加測試賬號

2. **添加測試賬號**
   - 將測試賬號加入群組
   - 確保賬號有發言權限

3. **發送測試消息**
   - 在群組中發送各種消息
   - 觀察 AI 回復行為
   - 檢查日誌確認處理流程

---

## 🌐 多服務器/電腦運行

### 架構設計

```
服務器1 (主控)
├── 後端 API 服務
├── 前端管理界面
└── 數據庫

服務器2 (賬號節點1)
├── 賬號 1-10
└── 本地日誌

服務器3 (賬號節點2)
├── 賬號 11-20
└── 本地日誌

服務器4 (賬號節點3)
├── 賬號 21-30
└── 本地日誌
```

### 部署方案

#### 方案 1: 集中式管理（推薦）

**主服務器**:
- 運行後端 API 和前端
- 管理所有賬號配置
- 存儲數據庫

**賬號節點**:
- 僅運行賬號實例
- 通過 API 獲取配置
- 上報狀態和日誌

**優點**:
- 統一管理
- 易於監控
- 配置集中

**缺點**:
- 依賴網絡連接
- 主服務器單點故障風險

#### 方案 2: 分布式管理

**每個節點**:
- 獨立運行後端和賬號
- 本地數據庫
- 通過消息隊列同步

**優點**:
- 高可用性
- 網絡故障不影響運行

**缺點**:
- 管理複雜
- 數據同步困難

### 實施步驟

#### 1. 準備 Session 文件

```bash
# 在主服務器上
# 1. 將 session 文件分發到各個節點
scp sessions/account_*.session user@node1:/path/to/sessions/
scp sessions/account_*.session user@node2:/path/to/sessions/

# 2. 設置文件權限
chmod 600 sessions/*.session
```

#### 2. 配置節點

**主服務器配置** (`admin-backend/.env`):
```env
# 允許遠程訪問
ALLOWED_ORIGINS=http://node1:8000,http://node2:8000

# 數據庫連接（共享）
DATABASE_URL=postgresql://user:pass@db-server:5432/group_ai
```

**節點配置** (`node/.env`):
```env
# API 服務器地址
API_BASE_URL=http://main-server:8000/api/v1

# 本地 Session 目錄
SESSION_FILES_DIRECTORY=/path/to/sessions

# 節點 ID
NODE_ID=node1
```

#### 3. 啟動服務

**主服務器**:
```bash
cd admin-backend
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**節點**:
```bash
# 方式1: 通過 API 獲取配置
python scripts/start_node.py --api-url http://main-server:8000

# 方式2: 直接運行賬號管理器
python -m group_ai_service.account_manager --config node_config.yaml
```

---

## 🔢 單台服務器安全運行數量

### Telegram 官方限制

根據 Telegram 的官方文檔和社區實踐：

| 運行方式 | 推薦數量 | 最大數量 | 風險等級 |
|---------|---------|---------|---------|
| **單 IP 單進程** | 1-3 個 | 5 個 | 低 |
| **單 IP 多進程** | 3-10 個 | 20 個 | 中 |
| **多 IP（代理）** | 10-50 個 | 100+ 個 | 低-中 |
| **分散式部署** | 無限制 | 無限制 | 低 |

### 安全運行建議

#### 🟢 低風險配置（推薦）

**單台服務器，單 IP**:
- **1-3 個賬號**: 最安全，幾乎無風險
- **3-5 個賬號**: 較安全，適合小規模運營
- **5-10 個賬號**: 需要謹慎，建議使用代理

**實施建議**:
```yaml
配置:
  賬號數量: 3-5 個
  IP 地址: 1 個固定 IP
  運行方式: 單進程，順序啟動
  間隔時間: 每個賬號啟動間隔 30-60 秒
  回復頻率: 每個賬號每小時不超過 50 條
```

#### 🟡 中風險配置

**單台服務器，多 IP（代理）**:
- **10-20 個賬號**: 需要良好的代理配置
- **20-50 個賬號**: 需要專業的 IP 管理

**實施建議**:
```yaml
配置:
  賬號數量: 10-20 個
  IP 地址: 每個賬號使用不同代理 IP
  代理類型: 住宅 IP 代理（推薦）> 數據中心代理
  運行方式: 並行運行，但控制並發數
  間隔時間: 啟動間隔 10-30 秒
  回復頻率: 每個賬號每小時不超過 30 條
```

#### 🔴 高風險配置（不推薦）

**單台服務器，單 IP，大量賬號**:
- **50+ 個賬號**: 高風險，容易被檢測
- **100+ 個賬號**: 極高風險，強烈不推薦

---

## 🛡️ 防封號策略

### 1. IP 地址管理

#### 使用代理服務器

**推薦配置**:
```python
# 每個賬號使用不同的代理
account_config = {
    "account_1": {
        "proxy": {
            "scheme": "socks5",
            "hostname": "proxy1.example.com",
            "port": 1080,
            "username": "user1",
            "password": "pass1"
        }
    },
    "account_2": {
        "proxy": {
            "scheme": "socks5",
            "hostname": "proxy2.example.com",
            "port": 1080,
            "username": "user2",
            "password": "pass2"
        }
    }
}
```

**代理類型選擇**:
- **住宅 IP 代理**: 最安全，價格較高
- **數據中心代理**: 較便宜，風險中等
- **移動 IP 代理**: 適合移動端賬號

#### IP 輪換策略

```python
# 定期輪換 IP（每 24 小時）
# 避免長時間使用同一 IP
```

### 2. 行為模擬

#### 回復頻率控制

```yaml
安全配置:
  每小時最大回復數: 30-50 條
  最小回復間隔: 3-5 秒
  隨機延遲: ±2 秒
  非工作時間降低頻率: 是
```

#### 回復模式多樣化

- 避免機械化回復
- 使用 AI 生成多樣化內容
- 模擬真人打字速度（添加延遲）
- 偶爾不回復（模擬不在線）

### 3. 賬號健康管理

#### 定期檢查

```python
# 每日健康檢查
- 檢查賬號在線狀態
- 檢查消息發送成功率
- 檢查錯誤率
- 檢查 API 調用限制
```

#### 自動恢復

```python
# 檢測到異常時自動處理
- 自動重連
- 降低回復頻率
- 暫停異常賬號
- 發送告警通知
```

### 4. 時間分布

#### 工作時間設置

```yaml
工作時間:
  開始: 09:00
  結束: 18:00
  時區: 根據目標用戶群組設置
  
非工作時間:
  回復頻率: 降低 50%
  僅回復重要消息: 是
```

#### 隨機化

```python
# 添加隨機性
- 啟動時間隨機延遲
- 回復時間隨機化
- 活動模式模擬真人作息
```

### 5. 賬號分散策略

#### 地理分布

```
服務器1 (亞洲): 賬號 1-10
服務器2 (歐洲): 賬號 11-20
服務器3 (美洲): 賬號 21-30
```

#### 時間分布

```
節點1: 處理 00:00-08:00 的賬號
節點2: 處理 08:00-16:00 的賬號
節點3: 處理 16:00-24:00 的賬號
```

---

## 📊 監控和預警

### 關鍵指標

#### 1. 賬號狀態監控

```python
監控指標:
  - 在線率: > 95%
  - 錯誤率: < 5%
  - 回復成功率: > 90%
  - API 調用限制: < 80%
```

#### 2. 行為異常檢測

```python
異常行為:
  - 短時間內大量回復
  - 回復內容重複
  - 錯誤率突然升高
  - 連接頻繁斷開
```

#### 3. 封號風險預警

```python
風險信號:
  - 收到 Telegram 警告
  - API 返回限流錯誤
  - 賬號被臨時限制
  - 異常的錯誤模式
```

### 告警設置

```yaml
告警規則:
  錯誤率 > 10%: 立即告警
  賬號離線 > 5 分鐘: 警告
  連續錯誤 > 3 次: 告警
  API 限流: 立即告警
  封號風險: 緊急告警
```

---

## 📝 最佳實踐總結

### ✅ 推薦做法

1. **單台服務器運行 3-5 個賬號**（最安全）
2. **使用住宅 IP 代理**（如果運行多個賬號）
3. **控制回復頻率**（每小時不超過 50 條）
4. **添加隨機延遲**（模擬真人行為）
5. **定期檢查賬號健康**（每日）
6. **分散部署**（多服務器運行）
7. **監控和告警**（及時發現問題）

### ❌ 避免做法

1. **單 IP 運行大量賬號**（> 10 個）
2. **高頻率機械化回復**（容易被檢測）
3. **忽略錯誤和警告**（導致封號）
4. **使用相同配置**（所有賬號行為一致）
5. **不監控賬號狀態**（無法及時發現問題）

---

## 🔗 相關文檔

- [測試指南](./TESTING_GUIDE.md)
- [部署指南](./DEPLOYMENT_GUIDE.md)
- [監控指南](./MONITORING_GUIDE.md)

---

## ⚠️ 免責聲明

本指南提供的建議基於社區實踐和經驗總結，不保證 100% 防止封號。使用時請：

1. 遵守 Telegram 服務條款
2. 合理使用 API
3. 尊重其他用戶
4. 承擔使用風險

---

**最後更新**: 2025-01-16  
**維護者**: 開發團隊

