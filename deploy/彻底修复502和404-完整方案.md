# 彻底修复502和404问题 - 完整方案

## 执行位置
**所有命令都在远程服务器 `ubuntu@165.154.233.55` 上执行**

## 任务一：修复 502 Bad Gateway

### 步骤1: 检查前端端口配置

```bash
cd ~/liaotian/saas-demo
grep '"dev"' package.json
```

如果显示 `"dev": "next dev -p 3000"`，说明端口配置正确。否则需要修复。

### 步骤2: 重启后端服务

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5
curl http://localhost:8000/health
```

应该返回 `{"status":"ok"}` 或类似内容。

### 步骤3: 重启前端服务

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev\|node.*3000" || true
sleep 2
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15
curl -I http://localhost:3000
```

应该返回 `HTTP/1.1 200 OK` 或 `304 Not Modified`。

### 步骤4: 重载Nginx

```bash
sudo systemctl reload nginx
```

### 步骤5: 验证所有服务

```bash
echo "后端健康检查:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

echo "前端服务:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000

echo "域名访问:"
curl -s -o /dev/null -w '%{http_code}\n' http://aikz.usdt2026.cc/group-ai/accounts
```

所有状态码应该是 200、302 或 304，不应该是 502。

## 任务二：修复 404 账号不存在问题

### 步骤1: 登录并获取token

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate

TOKEN=$(curl -s -X POST 'http://localhost:8000/api/v1/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin@example.com&password=changeme123' | \
  python3 -c 'import sys, json; print(json.load(sys.stdin)["access_token"])')

echo "Token: ${TOKEN:0:30}..."
```

### 步骤2: 获取账号列表

```bash
curl -s "http://localhost:8000/api/v1/group-ai/accounts?page=1&page_size=100" \
  -H "Authorization: Bearer $TOKEN" > /tmp/group_ai_accounts.json

echo "账号列表已保存到 /tmp/group_ai_accounts.json"
```

### 步骤3: 检查账号是否存在

```bash
python3 << 'EOF'
import json

with open('/tmp/group_ai_accounts.json', 'r') as f:
    accounts = json.load(f)

if isinstance(accounts, list):
    account_ids = [acc.get('account_id') for acc in accounts if acc.get('account_id')]
    print(f"找到 {len(account_ids)} 个账号")
    if account_ids:
        print(f"第一个账号ID: {account_ids[0]}")
        target_id = "639277358115"
        if target_id in account_ids:
            print(f"✓ 账号 {target_id} 存在")
        else:
            print(f"✗ 账号 {target_id} 不存在")
            print(f"将使用账号 {account_ids[0]} 进行替换")
EOF
```

### 步骤4: 搜索并替换代码中的引用

如果账号不存在，搜索代码中的引用：

```bash
cd ~/liaotian

echo "搜索前端代码..."
grep -rn "639277358115" saas-demo/src 2>/dev/null | head -10

echo "搜索后端代码..."
grep -rn "639277358115" admin-backend/app 2>/dev/null | head -10
```

如果找到引用，获取第一个真实账号ID并替换：

```bash
FIRST_ACCOUNT_ID=$(python3 << 'EOF'
import json
with open('/tmp/group_ai_accounts.json', 'r') as f:
    accounts = json.load(f)
if isinstance(accounts, list) and accounts:
    print(accounts[0].get('account_id', ''))
EOF
)

echo "将替换: 639277358115 -> $FIRST_ACCOUNT_ID"

# 替换前端代码
find saas-demo/src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) \
  -exec sed -i "s/639277358115/$FIRST_ACCOUNT_ID/g" {} + 2>/dev/null || true

# 替换后端代码
find admin-backend/app -type f -name "*.py" \
  -exec sed -i "s/639277358115/$FIRST_ACCOUNT_ID/g" {} + 2>/dev/null || true

echo "代码已更新"
```

### 步骤5: 重启后端服务（如果代码被修改）

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5
curl http://localhost:8000/health
```

### 步骤6: 验证修复

```bash
# 使用真实的账号ID测试
REAL_ACCOUNT_ID=$(python3 << 'EOF'
import json
with open('/tmp/group_ai_accounts.json', 'r') as f:
    accounts = json.load(f)
if isinstance(accounts, list) and accounts:
    print(accounts[0].get('account_id', ''))
EOF
)

curl -X PUT "http://localhost:8000/api/v1/group-ai/accounts/$REAL_ACCOUNT_ID" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"script_id":"test-script","server_id":"computer_001"}' \
  -v
```

应该返回 200 或 201，而不是 404。

## 一键执行脚本

已创建脚本：`deploy/修复502和404-分步执行.sh`

在服务器上执行：

```bash
bash ~/liaotian/deploy/修复502和404-分步执行.sh
```

## 验证清单

- [ ] 后端服务返回 200 (http://localhost:8000/health)
- [ ] 前端服务返回 200 或 304 (http://localhost:3000)
- [ ] 域名访问返回 200、302 或 304 (http://aikz.usdt2026.cc/group-ai/accounts)
- [ ] PUT请求不再返回 404
