# 马尼拉服务器手动部署步骤

## 服务器信息
- **主机**: 165.154.233.55
- **用户**: ubuntu
- **密码**: Along2025!!!

## 步骤 1: 连接到服务器

```bash
ssh ubuntu@165.154.233.55
# 输入密码: Along2025!!!
```

## 步骤 2: 安装必要工具

```bash
# 更新包列表
sudo apt-get update

# 安装必要工具
sudo apt-get install -y python3-venv unzip curl

# 安装 nvm 和 Node.js 20
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 加载 nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

# 安装 Node.js 20
nvm install 20
nvm use 20
nvm alias default 20

# 验证安装
python3 --version
node --version
npm --version
```

## 步骤 3: 清理旧文件（如果需要）

```bash
# 停止旧服务
sudo systemctl stop admin-backend smart-tg-frontend 2>/dev/null || true

# 清理旧目录（可选，如果需要重新开始）
# rm -rf /home/ubuntu/admin-backend /home/ubuntu/saas-demo
```

## 步骤 4: 部署后端

### 4.1 解压后端代码

```bash
# 进入主目录
cd /home/ubuntu

# 解压后端代码
tar -xzf admin-backend-deploy-clean.tar.gz

# 检查解压后的目录名
ls -d admin-backend*

# 如果目录名不是 admin-backend，重命名它
# 例如：mv admin-backend-deploy-clean admin-backend
# 或者：mv liaotian20251126/admin-backend-deploy admin-backend
```

### 4.2 创建虚拟环境并安装依赖

```bash
# 进入后端目录
cd /home/ubuntu/admin-backend

# 创建虚拟环境
python3 -m venv .venv

# 激活虚拟环境
source .venv/bin/activate

# 升级 pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt
```

### 4.3 配置环境变量

```bash
# 创建 .env 文件
cat > .env << 'EOF'
DATABASE_URL=sqlite:///./data/app.db
SECRET_KEY=$(openssl rand -hex 32)
CORS_ORIGINS=["http://localhost:3000","http://165.154.233.55:3000","http://165.154.233.55:8000"]
EOF

# 生成密钥（如果需要）
SECRET_KEY=$(openssl rand -hex 32)
sed -i "s/\$(openssl rand -hex 32)/$SECRET_KEY/" .env
```

### 4.4 配置 systemd 服务

```bash
# 创建 systemd 服务文件
sudo tee /etc/systemd/system/admin-backend.service > /dev/null << 'EOF'
[Unit]
Description=Smart TG Admin Backend
After=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/admin-backend
Environment="PATH=/home/ubuntu/admin-backend/.venv/bin:/usr/local/bin:/usr/bin:/bin"
EnvironmentFile=-/home/ubuntu/admin-backend/.env
ExecStart=/home/ubuntu/admin-backend/.venv/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 重新加载 systemd
sudo systemctl daemon-reload

# 启用服务（开机自启）
sudo systemctl enable admin-backend

# 启动服务
sudo systemctl start admin-backend

# 检查服务状态
sudo systemctl status admin-backend

# 查看日志（如果需要）
# sudo journalctl -u admin-backend -f
```

### 4.5 验证后端

```bash
# 检查端口
sudo ss -tlnp | grep 8000

# 健康检查
curl http://localhost:8000/health
```

## 步骤 5: 部署前端

### 5.1 解压前端代码

```bash
# 进入主目录
cd /home/ubuntu

# 解压前端代码
unzip -q -o frontend.zip

# 检查解压后的目录名
ls -d saas-demo*

# 如果目录名不是 saas-demo，重命名它
# 例如：mv saas-demo-* saas-demo
```

### 5.2 安装依赖

```bash
# 进入前端目录
cd /home/ubuntu/saas-demo

# 确保使用 Node.js 20
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
nvm use 20

# 安装依赖
npm install
```

### 5.3 配置环境变量

```bash
# 创建 .env.local 文件
cat > .env.local << 'EOF'
NEXT_PUBLIC_API_BASE_URL=http://165.154.233.55:8000/api/v1
EOF
```

### 5.4 构建前端

```bash
# 确保使用 Node.js 20
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
nvm use 20

# 构建前端（这可能需要几分钟）
npm run build
```

### 5.5 配置 systemd 服务

```bash
# 获取 Node.js 路径
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
NODE_PATH=$(which node)

# 创建 systemd 服务文件
sudo tee /etc/systemd/system/smart-tg-frontend.service > /dev/null << EOF
[Unit]
Description=Smart TG Frontend Service (Next.js)
After=network.target admin-backend.service

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/saas-demo
Environment="PATH=$NODE_PATH:/usr/local/bin:/usr/bin:/bin"
Environment="NODE_ENV=production"
EnvironmentFile=-/home/ubuntu/saas-demo/.env.local
ExecStart=$NODE_PATH .next/standalone/server.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 重新加载 systemd
sudo systemctl daemon-reload

# 启用服务（开机自启）
sudo systemctl enable smart-tg-frontend

# 启动服务
sudo systemctl start smart-tg-frontend

# 检查服务状态
sudo systemctl status smart-tg-frontend

# 查看日志（如果需要）
# sudo journalctl -u smart-tg-frontend -f
```

### 5.6 验证前端

```bash
# 检查端口
sudo ss -tlnp | grep 3000

# 健康检查
curl -I http://localhost:3000
```

## 步骤 6: 验证部署

```bash
# 检查服务状态
sudo systemctl status admin-backend smart-tg-frontend

# 检查端口监听
sudo ss -tlnp | grep -E ':8000|:3000'

# 后端健康检查
curl http://localhost:8000/health

# 前端健康检查
curl -I http://localhost:3000

# 查看服务日志（如果有问题）
sudo journalctl -u admin-backend -n 20 --no-pager
sudo journalctl -u smart-tg-frontend -n 20 --no-pager
```

## 访问地址

部署完成后，可以通过以下地址访问：

- **前端**: http://165.154.233.55:3000
- **后端**: http://165.154.233.55:8000
- **API 文档**: http://165.154.233.55:8000/docs

## 常见问题排查

### 问题1: 后端服务无法启动

```bash
# 检查虚拟环境
ls -la /home/ubuntu/admin-backend/.venv/bin/python3

# 检查依赖
source /home/ubuntu/admin-backend/.venv/bin/activate
pip list

# 手动测试启动
cd /home/ubuntu/admin-backend
source .venv/bin/activate
python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 问题2: 前端服务无法启动

```bash
# 检查 Node.js 版本
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
node --version

# 检查构建产物
ls -la /home/ubuntu/saas-demo/.next/standalone/

# 手动测试启动
cd /home/ubuntu/saas-demo
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
node .next/standalone/server.js
```

### 问题3: 端口被占用

```bash
# 查看占用端口的进程
sudo lsof -i :8000
sudo lsof -i :3000

# 杀死占用进程
sudo kill -9 <PID>
```

### 问题4: 权限问题

```bash
# 确保文件所有者正确
sudo chown -R ubuntu:ubuntu /home/ubuntu/admin-backend
sudo chown -R ubuntu:ubuntu /home/ubuntu/saas-demo
```

## 服务管理命令

```bash
# 启动服务
sudo systemctl start admin-backend
sudo systemctl start smart-tg-frontend

# 停止服务
sudo systemctl stop admin-backend
sudo systemctl stop smart-tg-frontend

# 重启服务
sudo systemctl restart admin-backend
sudo systemctl restart smart-tg-frontend

# 查看服务状态
sudo systemctl status admin-backend
sudo systemctl status smart-tg-frontend

# 查看服务日志
sudo journalctl -u admin-backend -f
sudo journalctl -u smart-tg-frontend -f

# 禁用开机自启
sudo systemctl disable admin-backend
sudo systemctl disable smart-tg-frontend

# 启用开机自启
sudo systemctl enable admin-backend
sudo systemctl enable smart-tg-frontend
```

## 快速检查清单

完成部署后，检查以下项目：

- [ ] 后端服务状态: `systemctl status admin-backend` 显示 `active (running)`
- [ ] 前端服务状态: `systemctl status smart-tg-frontend` 显示 `active (running)`
- [ ] 端口 8000 监听: `ss -tlnp | grep 8000`
- [ ] 端口 3000 监听: `ss -tlnp | grep 3000`
- [ ] 后端健康检查: `curl http://localhost:8000/health` 返回 `{"status":"ok"}`
- [ ] 前端健康检查: `curl -I http://localhost:3000` 返回 `HTTP 200`
- [ ] 外部访问: 浏览器可以访问 http://165.154.233.55:3000

