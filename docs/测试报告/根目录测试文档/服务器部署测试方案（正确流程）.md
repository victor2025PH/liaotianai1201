# 服务器部署测试方案（正确流程）

## 用户指出的问题

**测试session文件应该是在服务器上部署和启动，不应该在本地启动测试。**

## 正确的测试流程

### 步骤1：批量创建账号（自动分配到服务器）

1. **扫描本地session文件**
   - 从本地 `sessions/` 目录扫描
   - 显示可用session文件列表

2. **批量创建账号**
   - 选择多个session文件
   - 点击"批量创建"按钮
   - **系统会自动**：
     - 使用 `IntelligentAllocator` 智能分配服务器
     - 使用 `SessionUploader` 上传session文件到服务器
     - 在数据库中创建账号记录（包含 `server_id`）
     - **账号在服务器上，不在本地AccountManager中**

### 步骤2：在服务器上启动账号

1. **查看账号列表**
   - 确认账号已分配到服务器（`server_id` 不为空）
   - 确认账号状态

2. **启动账号**
   - 点击"启动"按钮
   - **系统应该**：
     - 检查账号的 `server_id`
     - 如果 `server_id` 存在，在服务器上启动账号
     - 如果 `server_id` 不存在，在本地启动（旧逻辑）

### 步骤3：在服务器上测试建群和聊天

1. **创建群组**
   - 账号在服务器上运行
   - 创建群组时，使用服务器上的账号client

2. **测试按剧本聊天**
   - 发送测试消息到群组
   - 服务器上的账号检测到消息
   - 服务器上的账号按照剧本自动回复

## 需要检查的功能

### 1. 账号创建时的服务器分配 ✅
- ✅ `IntelligentAllocator` 已实现
- ✅ `SessionUploader` 已实现
- ✅ 创建账号时自动分配 `server_id`

### 2. 账号启动时的服务器处理 ⚠️
- ⚠️  需要检查 `start_account` API是否支持服务器启动
- ⚠️  需要检查是否有远程启动服务器的机制

### 3. 服务器上的账号管理 ⚠️
- ⚠️  需要检查服务器上的账号如何管理
- ⚠️  需要检查服务器上的账号状态如何同步

## 当前问题

### 问题1：start_account可能还在本地启动
- 需要检查 `start_account` API的实现
- 如果账号有 `server_id`，应该在服务器上启动

### 问题2：测试脚本在本地测试
- 之前的测试脚本直接在本地启动账号
- 应该：账号应该在服务器上启动和测试

## 正确的测试方案

### 方案1：通过前端界面测试（推荐）

1. **批量创建账号**
   - 使用前端界面批量选择session文件
   - 系统自动分配到服务器
   - 确认账号的 `server_id` 已设置

2. **启动账号**
   - 在账号列表中点击"启动"按钮
   - 系统应该在服务器上启动账号

3. **测试建群和聊天**
   - 创建群组
   - 发送测试消息
   - 观察服务器上的账号是否自动回复

### 方案2：通过API测试（需要检查服务器启动逻辑）

1. **创建账号（自动分配服务器）**
   ```powershell
   POST /api/v1/group-ai/accounts
   {
     "account_id": "test_account",
     "session_file": "sessions/test.session",
     "script_id": "000新人欢迎剧本"
   }
   # 系统会自动分配服务器并上传session文件
   ```

2. **启动账号（应该在服务器上启动）**
   ```powershell
   POST /api/v1/group-ai/accounts/{account_id}/start
   # 如果account有server_id，应该在服务器上启动
   ```

3. **测试建群和聊天**
   - 使用新的API端点发送测试消息
   - 服务器上的账号应该自动回复

## 下一步

1. **检查start_account API**
   - 确认是否支持服务器启动
   - 如果不支持，需要修改

2. **调整测试方案**
   - 创建针对服务器部署的测试脚本
   - 测试服务器上的账号功能

3. **验证服务器分配**
   - 确认账号创建时是否自动分配到服务器
   - 确认session文件是否上传到服务器

