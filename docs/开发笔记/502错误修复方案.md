# 502 Bad Gateway é”™è¯¯ä¿®å¤æ–¹æ¡ˆ

> **é”™è¯¯**: è®¿é—® `http://aikz.usdt2026.cc/group-ai/accounts` æ—¶æ˜¾ç¤º 502 Bad Gateway

---

## ğŸ” é—®é¢˜åˆ†æ

502 Bad Gateway é”™è¯¯é€šå¸¸è¡¨ç¤ºï¼š
1. **åç«¯æœåŠ¡æœªè¿è¡Œ** - FastAPI æœåŠ¡ï¼ˆç«¯å£ 8000ï¼‰æ²¡æœ‰å¯åŠ¨
2. **å‰ç«¯æœåŠ¡æœªè¿è¡Œ** - Next.js æœåŠ¡ï¼ˆç«¯å£ 3000ï¼‰æ²¡æœ‰å¯åŠ¨
3. **Nginx é…ç½®é—®é¢˜** - åå‘ä»£ç†é…ç½®é”™è¯¯æˆ–æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡

---

## âœ… ä¿®å¤æ­¥éª¤

### åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

#### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:8000/health

# æ£€æŸ¥å‰ç«¯æœåŠ¡
curl http://localhost:3000

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep -E 'uvicorn|next|node.*300'
```

#### 2. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate

# åœæ­¢ç°æœ‰è¿›ç¨‹
pkill -f "uvicorn.*app.main:app" || true

# å¯åŠ¨åç«¯
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &

# éªŒè¯
sleep 5
curl http://localhost:8000/health
```

#### 3. å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd ~/liaotian/saas-demo

# åœæ­¢ç°æœ‰è¿›ç¨‹
pkill -f "next.*dev\|node.*3000" || true

# å¦‚æœè¿˜æ²¡æœ‰æ„å»ºï¼Œå…ˆæ„å»º
if [ ! -d ".next" ]; then
    npm run build
fi

# å¯åŠ¨å‰ç«¯
nohup npm run dev > /tmp/frontend.log 2>&1 &

# éªŒè¯
sleep 10
curl http://localhost:3000
```

#### 4. æ£€æŸ¥å¹¶é‡è½½ Nginx

```bash
# æ£€æŸ¥ Nginx çŠ¶æ€
sudo systemctl status nginx

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½
sudo systemctl reload nginx
```

---

## ğŸš€ å¿«é€Ÿä¿®å¤è„šæœ¬

å·²åˆ›å»ºä»¥ä¸‹ä¿®å¤è„šæœ¬ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥æ‰§è¡Œï¼š

### æ–¹æ³• 1: ä½¿ç”¨å®Œæ•´ä¿®å¤è„šæœ¬

```bash
cd ~/liaotian
git pull origin master
chmod +x å®Œæ•´ä¿®å¤502å¹¶éªŒè¯.sh
bash å®Œæ•´ä¿®å¤502å¹¶éªŒè¯.sh
```

### æ–¹æ³• 2: ä½¿ç”¨å¿«é€Ÿä¿®å¤è„šæœ¬

```bash
cd ~/liaotian
git pull origin master
chmod +x å¿«é€Ÿä¿®å¤502-åˆ†æ­¥æ‰§è¡Œ.sh
bash å¿«é€Ÿä¿®å¤502-åˆ†æ­¥æ‰§è¡Œ.sh
```

### æ–¹æ³• 3: ä½¿ç”¨æœåŠ¡æ£€æŸ¥è„šæœ¬

```bash
cd ~/liaotian
git pull origin master
chmod +x æ£€æŸ¥å¹¶ä¿®å¤æœåŠ¡-æœ€ç»ˆç‰ˆ.sh
bash æ£€æŸ¥å¹¶ä¿®å¤æœåŠ¡-æœ€ç»ˆç‰ˆ.sh
```

---

## ğŸ“‹ Nginx é…ç½®

å½“å‰ Nginx é…ç½®åº”è¯¥åŒ…å«ï¼š

```nginx
server {
    listen 80;
    server_name aikz.usdt2026.cc;

    # å‰ç«¯
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300;
    }

    # åç«¯ API
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 300;
    }

    location /health {
        proxy_pass http://127.0.0.1:8000/health;
    }
}
```

é…ç½®æ–‡ä»¶ä½ç½®ï¼š`/etc/nginx/sites-enabled/default`

---

## ğŸ”§ ä½¿ç”¨ systemd æœåŠ¡ï¼ˆæ¨èï¼‰

### åˆ›å»ºåç«¯æœåŠ¡

åˆ›å»ºæ–‡ä»¶ `/etc/systemd/system/group-ai-backend.service`:

```ini
[Unit]
Description=Group AI Backend Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/admin-backend
Environment="PATH=/home/ubuntu/liaotian/admin-backend/.venv/bin"
ExecStart=/home/ubuntu/liaotian/admin-backend/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl enable group-ai-backend
sudo systemctl start group-ai-backend
sudo systemctl status group-ai-backend
```

### åˆ›å»ºå‰ç«¯æœåŠ¡

åˆ›å»ºæ–‡ä»¶ `/etc/systemd/system/group-ai-frontend.service`:

```ini
[Unit]
Description=Group AI Frontend Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="PATH=/usr/bin:/usr/local/bin"
Environment="PORT=3000"
ExecStart=/usr/bin/npm run dev
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl enable group-ai-frontend
sudo systemctl start group-ai-frontend
sudo systemctl status group-ai-frontend
```

---

## âœ… éªŒè¯æ­¥éª¤

ä¿®å¤åï¼ŒéªŒè¯ä»¥ä¸‹å†…å®¹ï¼š

1. **åç«¯æœåŠ¡**
   ```bash
   curl http://localhost:8000/health
   # åº”è¯¥è¿”å›: {"status":"ok"}
   ```

2. **å‰ç«¯æœåŠ¡**
   ```bash
   curl http://localhost:3000
   # åº”è¯¥è¿”å› HTML å†…å®¹
   ```

3. **é€šè¿‡åŸŸåè®¿é—®**
   ```bash
   curl http://aikz.usdt2026.cc/group-ai/accounts
   # åº”è¯¥è¿”å›é¡µé¢å†…å®¹ï¼Œè€Œä¸æ˜¯ 502 é”™è¯¯
   ```

4. **æµè§ˆå™¨è®¿é—®**
   - è®¿é—® `http://aikz.usdt2026.cc/group-ai/accounts`
   - åº”è¯¥æ­£å¸¸åŠ è½½é¡µé¢

---

## ğŸ“ æ—¥å¿—æ–‡ä»¶

- åç«¯æ—¥å¿—ï¼š`/tmp/backend.log` æˆ– `/tmp/backend_fix.log`
- å‰ç«¯æ—¥å¿—ï¼š`/tmp/frontend.log` æˆ– `/tmp/frontend_fix.log`
- Nginx é”™è¯¯æ—¥å¿—ï¼š`/var/log/nginx/error.log`

æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
# åç«¯æ—¥å¿—
tail -f /tmp/backend.log

# å‰ç«¯æ—¥å¿—
tail -f /tmp/frontend.log

# Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. ç«¯å£å·²è¢«å ç”¨

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :8000
sudo lsof -i :3000

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>
```

### 2. è™šæ‹Ÿç¯å¢ƒä¸å­˜åœ¨

```bash
cd ~/liaotian/admin-backend
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 3. å‰ç«¯æ„å»ºå¤±è´¥

```bash
cd ~/liaotian/saas-demo
rm -rf .next node_modules
npm install
npm run build
```

---

## ğŸ”„ è‡ªåŠ¨åŒ–ä¿®å¤

æ‰€æœ‰ä¿®å¤è„šæœ¬å·²åˆ›å»ºå¹¶æ¨é€åˆ°ä»“åº“ã€‚åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd ~/liaotian
git pull origin master

# é€‰æ‹©ä»»ä¸€ä¿®å¤è„šæœ¬
bash å®Œæ•´ä¿®å¤502å¹¶éªŒè¯.sh
```

---

**çŠ¶æ€**: âœ… æ‰€æœ‰ä¿®å¤è„šæœ¬å·²å‡†å¤‡å°±ç»ª  
**ä¸‹ä¸€æ­¥**: åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¿®å¤è„šæœ¬æˆ–æ‰‹åŠ¨å¯åŠ¨æœåŠ¡
