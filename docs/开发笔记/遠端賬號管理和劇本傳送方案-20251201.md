# 遠端賬號管理和劇本傳送方案

> **日期**: 2025-12-01  
> **需求**: 後台管理遠端服務器和其他電腦上的 Telegram 賬號

---

## 📋 需求分析

### 核心需求

1. **讀取遠端賬號運行信息**
   - 從遠端服務器/其他電腦獲取賬號列表
   - 獲取賬號運行狀態（在線/離線/錯誤）
   - 獲取賬號統計信息（消息數、回復數等）

2. **劇本傳送**
   - 將劇本推送到遠端節點
   - 遠端節點自動更新劇本
   - 支持批量推送

3. **會話管理**
   - 同步會話文件到遠端
   - 管理遠端會話文件
   - 會話文件備份和恢復

---

## 🏗️ 架構設計

### 現有架構

1. **Workers API** (`/api/v1/workers`)
   - Worker 節點心跳機制
   - 命令隊列系統
   - 節點狀態管理

2. **Servers API** (`/api/v1/group-ai/servers`)
   - 服務器狀態查詢
   - SSH 連接管理

3. **Accounts API** (`/api/v1/group-ai/accounts`)
   - 賬號管理
   - 賬號分配

### 需要增強的功能

1. **遠端賬號同步**
   - 從 Worker 節點獲取賬號列表
   - 同步賬號狀態到數據庫
   - 實時狀態更新

2. **劇本傳送機制**
   - 劇本文件推送到遠端
   - 遠端節點劇本更新 API
   - 批量劇本推送

3. **會話管理**
   - 會話文件上傳到遠端
   - 會話文件下載
   - 會話文件同步

---

## 🔧 實現方案

### 方案 1: 基於 Workers API 的遠端賬號同步

**流程**:
1. Worker 節點通過心跳上報賬號列表
2. 後台接收心跳，同步賬號信息到數據庫
3. 前端顯示所有賬號（本地+遠端）

**優點**:
- 利用現有心跳機制
- 實時同步
- 無需額外 API 調用

**實現**:
- 增強 `WorkerHeartbeatRequest` 包含詳細賬號信息
- 在心跳處理中同步賬號到數據庫

### 方案 2: 劇本傳送機制

**流程**:
1. 後台選擇劇本和目標節點
2. 通過命令隊列發送劇本推送命令
3. Worker 節點接收命令，下載劇本
4. Worker 節點更新本地劇本並重載

**實現**:
- 添加劇本推送命令到 Workers API
- 實現劇本文件傳輸（HTTP 下載或 SSH 傳輸）
- Worker 節點實現劇本更新邏輯

### 方案 3: 會話管理

**流程**:
1. 上傳會話文件到後台
2. 後台分配會話到遠端節點
3. 通過 SSH 或 HTTP 傳輸會話文件
4. 遠端節點加載會話

**實現**:
- 增強現有的 Session 上傳功能
- 添加會話文件傳輸到遠端的功能
- 實現會話文件同步機制

---

## 📝 詳細實現計劃

### 階段 1: 遠端賬號同步（優先級：高）

#### 1.1 增強 Worker 心跳數據

**修改**: `admin-backend/app/api/workers.py`

```python
class WorkerHeartbeatRequest(BaseModel):
    node_id: str
    status: str
    account_count: int
    accounts: List[Dict[str, Any]]  # 詳細賬號信息
    # 賬號信息應包含：
    # - account_id
    # - status (online/offline/error)
    # - script_id
    # - message_count
    # - reply_count
    # - last_activity
    # - session_file
```

#### 1.2 實現賬號同步邏輯

**新增**: 在心跳處理中同步賬號到數據庫

```python
async def sync_accounts_from_worker(node_id: str, accounts: List[Dict], db: Session):
    """從 Worker 節點同步賬號到數據庫"""
    for account_data in accounts:
        # 檢查賬號是否存在
        # 如果不存在，創建記錄
        # 如果存在，更新狀態
```

#### 1.3 前端顯示遠端賬號

**修改**: `saas-demo/src/app/group-ai/accounts/page.tsx`
- 顯示賬號來源（本地/遠端）
- 顯示賬號所在節點
- 支持按節點過濾

---

### 階段 2: 劇本傳送（優先級：高）

#### 2.1 實現劇本推送 API

**新增**: `admin-backend/app/api/group_ai/script_deployment.py`

```python
@router.post("/deploy/{script_id}")
async def deploy_script_to_nodes(
    script_id: str,
    node_ids: List[str],
    # 推送劇本到指定節點
)
```

#### 2.2 實現劇本傳輸

**方式 1**: HTTP 下載（推薦）
- 後台提供劇本下載 URL
- Worker 節點通過命令獲取 URL
- Worker 節點下載並更新劇本

**方式 2**: SSH 傳輸
- 通過 SSH 直接傳輸文件
- 適用於內網環境

#### 2.3 前端劇本推送 UI

**新增**: 在劇本管理頁面添加「推送到節點」功能
- 選擇目標節點
- 顯示推送進度
- 推送結果反饋

---

### 階段 3: 會話管理（優先級：中）

#### 3.1 會話文件傳輸

**增強**: `admin-backend/app/api/group_ai/session_uploader.py`
- 支持上傳到遠端節點
- 支持會話文件同步

#### 3.2 會話管理 API

**新增**: 會話文件管理端點
- 下載會話文件
- 同步會話文件
- 會話文件備份

---

## 🚀 立即開始實現

### 第一步：增強 Worker 心跳同步賬號

**文件**: `admin-backend/app/api/workers.py`

**修改內容**:
1. 在 `worker_heartbeat` 函數中添加賬號同步邏輯
2. 同步賬號信息到數據庫
3. 更新賬號狀態

---

## 📋 使用場景

### 場景 1: 查看遠端賬號

1. Worker 節點發送心跳（包含賬號列表）
2. 後台自動同步賬號到數據庫
3. 前端顯示所有賬號（標記來源節點）

### 場景 2: 推送劇本到遠端

1. 在後台選擇劇本
2. 選擇目標節點
3. 點擊「推送」
4. 遠端節點自動下載並更新劇本

### 場景 3: 管理遠端會話

1. 上傳會話文件到後台
2. 分配會話到遠端節點
3. 遠端節點自動加載會話

---

**建議立即開始實現階段 1：遠端賬號同步！**
