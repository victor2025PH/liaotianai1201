name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 55m
          script_stop: true
          debug: true
          envs: GITHUB_REPO=${{ github.repository }},SERVER_HOST=${{ secrets.SERVER_HOST }}
          script: |
            # é‡åˆ°ä»»ä½•å‘½ä»¤é”™è¯¯(éé€»è¾‘åˆ¤æ–­)åˆ™é€€å‡º
            set -e
            
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # 1. è¿›å…¥ç›®å½•å¹¶æ›´æ–°ä»£ç 
            cd "$PROJECT_DIR"
            git fetch origin main
            git reset --hard origin/main
            
            # 2. ä¿®å¤æƒé™ (å¿½ç•¥é”™è¯¯)
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR" || true
            
            # 3. æ„å»ºå‰ç«¯
            echo "ğŸ“¦ æ„å»ºå‰ç«¯..."
            cd saas-demo
            
            # æš´åŠ›æ¸…ç† (ä¸ç®¡æœ‰æ²¡æœ‰ï¼Œåˆ äº†å†è¯´)
            rm -f .next/lock
            # æš´åŠ›æ€è¿›ç¨‹ (å¦‚æœæ€ä¸åˆ°ï¼Œå¿½ç•¥é”™è¯¯)
            pkill -f "next build" || true
            
            # å®‰è£…ä¸æ„å»º
            npm install --prefer-offline --no-audit
            npm run build
            
            # æš´åŠ›å¤åˆ¶é™æ€èµ„æº (Standalone è¡¥ä¸)
            echo "ğŸ“‚ å¤„ç†é™æ€èµ„æº..."
            mkdir -p .next/standalone/.next/static
            # ä½¿ç”¨ || true é˜²æ­¢æŸäº›æ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´æŠ¥é”™
            cp -r .next/static/* .next/standalone/.next/static/ || true
            cp -r public .next/standalone/ || true
            cd ..
            
            # 4. åç«¯ä¾èµ–
            echo "ğŸ å®‰è£…åç«¯ä¾èµ–..."
            cd admin-backend
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            cd ..
            
            # 5. é‡å¯æœåŠ¡
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            sudo systemctl restart luckyred-api
            sudo systemctl restart liaotian-frontend
            sudo systemctl restart nginx
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
