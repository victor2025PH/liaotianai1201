# æ¸¸æˆå¼•å¯¼åŠŸèƒ½å®ç°

> **åˆ›å»ºæ—¥æœŸ**: 2025-11-16  
> **çŠ¶æ€**: å·²å®ŒæˆåŸºç¡€å®ç°

---

## åŠŸèƒ½æ¦‚è¿°

æ¸¸æˆå¼•å¯¼åŠŸèƒ½æ˜¯åœ¨çº¢åŒ…æ¸¸æˆè¿‡ç¨‹ä¸­æä¾›å®æ—¶èŠå¤©å¼•å¯¼ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£æ¸¸æˆè§„åˆ™å¹¶ç§¯æå‚ä¸ã€‚è¿™æ˜¯çº¢åŒ…æ¸¸æˆåŠŸèƒ½å¼€å‘ä¸­çš„æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡ã€‚

---

## å®ç°å†…å®¹

### 1. GameGuideService æœåŠ¡ç±»

**æ–‡ä»¶**: `group_ai_service/game_guide_service.py`

**åŠŸèƒ½**:
- å¤„ç†æ¸¸æˆäº‹ä»¶ï¼ˆæ¸¸æˆå¼€å§‹ã€çº¢åŒ…å‘é€ã€çº¢åŒ…è¢«é¢†å–ã€æ¸¸æˆç»“æŸã€ç»“æœå…¬å¸ƒï¼‰
- ç”Ÿæˆå¼•å¯¼æ¶ˆæ¯
- å‘é€å¼•å¯¼æ¶ˆæ¯åˆ°ç¾¤ç»„

**ä¸»è¦æ–¹æ³•**:
- `handle_game_event(event)`: ç»Ÿä¸€äº‹ä»¶å¤„ç†å…¥å£
- `on_game_start(event)`: æ¸¸æˆå¼€å§‹å¼•å¯¼
- `on_redpacket_sent(event)`: çº¢åŒ…å‘é€å¼•å¯¼
- `on_redpacket_claimed(event)`: çº¢åŒ…è¢«é¢†å–å¼•å¯¼ï¼ˆåŒ…å«å¿«æŠ¢å®Œæé†’ï¼‰
- `on_game_end(event)`: æ¸¸æˆç»“æŸå¼•å¯¼
- `on_result_announced(event)`: ç»“æœå…¬å¸ƒå¼•å¯¼
- `send_custom_guide(group_id, message, account_id)`: å‘é€è‡ªå®šä¹‰å¼•å¯¼æ¶ˆæ¯

**å¼•å¯¼æ¶ˆæ¯æ¨¡æ¿**:
- æ¸¸æˆå¼€å§‹ï¼šæ¬¢è¿æ¶ˆæ¯å’Œæ¸¸æˆè§„åˆ™è¯´æ˜
- çº¢åŒ…å‘é€ï¼šçº¢åŒ…ä¿¡æ¯ï¼ˆé‡‘é¢ã€ä»½æ•°ã€å‰©ä½™ï¼‰
- çº¢åŒ…å¿«æŠ¢å®Œï¼šå‰©ä½™ä»½æ•°æé†’ï¼ˆâ‰¤3ä»½æ—¶ï¼‰
- æ¸¸æˆç»“æŸï¼šæ„Ÿè°¢æ¶ˆæ¯å’Œæ¸¸æˆç»Ÿè®¡
- ç»“æœå…¬å¸ƒï¼šç»“æœæ‘˜è¦å’Œæ’è¡Œæ¦œæç¤º

---

### 2. ServiceManager é›†æˆ

**æ–‡ä»¶**: `group_ai_service/service_manager.py`

**ä¿®æ”¹å†…å®¹**:
- åœ¨ `__init__` ä¸­åˆå§‹åŒ– `GameGuideService`
- æ›´æ–°æ‰€æœ‰äº‹ä»¶å¤„ç†æ–¹æ³•ï¼Œè°ƒç”¨ `GameGuideService` çš„å¯¹åº”æ–¹æ³•ï¼š
  - `handle_game_start()` â†’ `game_guide_service.on_game_start()`
  - `handle_redpacket_sent()` â†’ `game_guide_service.on_redpacket_sent()`
  - `handle_redpacket_claimed()` â†’ `game_guide_service.on_redpacket_claimed()`
  - `handle_game_end()` â†’ `game_guide_service.on_game_end()`
  - `handle_result_announced()` â†’ `game_guide_service.on_result_announced()`

---

### 3. Webhook API æ›´æ–°

**æ–‡ä»¶**: `admin-backend/app/api/group_ai/game_webhook.py`

**ä¿®æ”¹å†…å®¹**:
- ç®€åŒ–äº‹ä»¶å¤„ç†é€»è¾‘
- ç›´æ¥åˆ›å»º `GameEvent` å¯¹è±¡å¹¶è°ƒç”¨ `ServiceManager` çš„äº‹ä»¶å¤„ç†æ–¹æ³•
- ç§»é™¤äº†é‡å¤çš„äº‹ä»¶å¤„ç†ä»£ç 

---

## å·¥ä½œæµç¨‹

```
æ¸¸æˆç³»ç»Ÿå‘é€äº‹ä»¶
    â†“
Webhook API æ¥æ”¶ (/api/v1/game-webhook/events)
    â†“
åˆ›å»º GameEvent å¯¹è±¡
    â†“
ServiceManager.handle_*_event()
    â†“
GameGuideService.on_*()
    â†“
è·å–ç›‘å¬ç¾¤ç»„çš„è´¦å·
    â†“
é€šè¿‡ Pyrogram Client å‘é€å¼•å¯¼æ¶ˆæ¯
    â†“
ç¾¤ç»„æ”¶åˆ°å¼•å¯¼æ¶ˆæ¯
```

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. é€šè¿‡ Webhook æ¥æ”¶æ¸¸æˆäº‹ä»¶

```bash
POST /api/v1/game-webhook/events
Content-Type: application/json

{
  "event_type": "GAME_START",
  "event_id": "event_123",
  "group_id": -1001234567890,
  "game_id": "game_456",
  "timestamp": "2025-11-16T10:00:00Z",
  "payload": {}
}
```

### 2. æ‰‹åŠ¨å‘é€å¼•å¯¼æ¶ˆæ¯

```python
from group_ai_service.service_manager import ServiceManager

service_manager = ServiceManager.get_instance()
guide_service = service_manager.game_guide_service

# å‘é€è‡ªå®šä¹‰å¼•å¯¼æ¶ˆæ¯
await guide_service.send_custom_guide(
    group_id=-1001234567890,
    message="ğŸ‰ æ­å–œï¼çº¢åŒ…å·²å‘æ”¾ï¼",
    account_id="account_123"  # å¯é€‰ï¼ŒæŒ‡å®šè´¦å·
)
```

---

## é…ç½®è¦æ±‚

æ— éœ€é¢å¤–é…ç½®ï¼Œ`GameGuideService` ä¼šè‡ªåŠ¨åˆå§‹åŒ–ã€‚

å¦‚æœéœ€è¦åœ¨å¼•å¯¼æ¶ˆæ¯ä¸­è‡ªå®šä¹‰å†…å®¹ï¼Œå¯ä»¥ä¿®æ”¹ `game_guide_service.py` ä¸­çš„ `_load_templates()` æ–¹æ³•ã€‚

---

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•æ¸¸æˆå¼€å§‹å¼•å¯¼**
   - å‘é€ `GAME_START` äº‹ä»¶
   - éªŒè¯ç¾¤ç»„æ”¶åˆ°æ¬¢è¿æ¶ˆæ¯

2. **æµ‹è¯•çº¢åŒ…å‘é€å¼•å¯¼**
   - å‘é€ `REDPACKET_SENT` äº‹ä»¶
   - éªŒè¯ç¾¤ç»„æ”¶åˆ°çº¢åŒ…ä¿¡æ¯

3. **æµ‹è¯•å¿«æŠ¢å®Œæé†’**
   - å‘é€ `REDPACKET_CLAIMED` äº‹ä»¶ï¼ˆå‰©ä½™â‰¤3ä»½ï¼‰
   - éªŒè¯ç¾¤ç»„æ”¶åˆ°æé†’æ¶ˆæ¯

4. **æµ‹è¯•æ¸¸æˆç»“æŸå¼•å¯¼**
   - å‘é€ `GAME_END` äº‹ä»¶
   - éªŒè¯ç¾¤ç»„æ”¶åˆ°ç»“æŸæ¶ˆæ¯

---

## ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **å¼•å¯¼æ¶ˆæ¯ä¸ªæ€§åŒ–**
   - åŸºäºç”¨æˆ·å†å²è¡Œä¸ºå®šåˆ¶æ¶ˆæ¯
   - æ”¯æŒå¤šè¯­è¨€

2. **å¼•å¯¼é¢‘ç‡æ§åˆ¶**
   - é¿å…æ¶ˆæ¯è¿‡äºé¢‘ç¹
   - å®ç°æ™ºèƒ½å»é‡

3. **å¼•å¯¼æ•ˆæœç»Ÿè®¡**
   - è®°å½•å¼•å¯¼æ¶ˆæ¯å‘é€æƒ…å†µ
   - åˆ†æç”¨æˆ·å“åº”ç‡

---

**å®ç°å®Œæˆï¼** æ¸¸æˆå¼•å¯¼åŠŸèƒ½å·²é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡ Webhook æ¥æ”¶æ¸¸æˆäº‹ä»¶å¹¶è‡ªåŠ¨å‘é€å¼•å¯¼æ¶ˆæ¯ã€‚

