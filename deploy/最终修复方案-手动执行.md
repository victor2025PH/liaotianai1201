# 最终修复502错误 - 手动执行指南

## 问题确认

页面仍然显示 **502 Bad Gateway**，说明Next.js服务没有正常启动。

## 请在服务器上执行以下命令

由于SSH输出被抑制，请在服务器上**手动执行**以下命令：

### 步骤1：查找standalone目录

```bash
cd /home/ubuntu/liaotian/saas-demo
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
FULL_STANDALONE_DIR="/home/ubuntu/liaotian/saas-demo/$STANDALONE_DIR"
echo "Standalone目录: $FULL_STANDALONE_DIR"
```

**记录输出**：将显示的`$FULL_STANDALONE_DIR`路径记录下来。

### 步骤2：停止服务并复制静态文件

```bash
sudo systemctl stop liaotian-frontend
mkdir -p "$STANDALONE_DIR/.next/static"
cp -r .next/static/* "$STANDALONE_DIR/.next/static/"
ls -la "$STANDALONE_DIR/.next/static/chunks/adc3be135379192a.js"
```

**预期结果**：应该显示文件存在。

### 步骤3：更新systemd服务配置

**重要**：将下面的`$FULL_STANDALONE_DIR`替换为步骤1中记录的实际路径。

```bash
# 备份原配置
sudo cp /etc/systemd/system/liaotian-frontend.service /etc/systemd/system/liaotian-frontend.service.bak

# 更新配置（替换下面的路径为实际路径）
sudo tee /etc/systemd/system/liaotian-frontend.service > /dev/null <<'EOFSERVICE'
[Unit]
Description=Liaotian Frontend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=REPLACE_WITH_FULL_STANDALONE_DIR
Environment=PORT=3000
Environment="NVM_DIR=$HOME/.nvm"
Environment="PATH=$HOME/.nvm/versions/node/v20.19.6/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node server.js
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOFSERVICE
```

**或者使用sed替换**（更简单）：

```bash
# 先创建临时文件
cat > /tmp/liaotian-frontend.service <<EOFSERVICE
[Unit]
Description=Liaotian Frontend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=$FULL_STANDALONE_DIR
Environment=PORT=3000
Environment="NVM_DIR=\$HOME/.nvm"
Environment="PATH=\$HOME/.nvm/versions/node/v20.19.6/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node server.js
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOFSERVICE

# 复制到systemd目录
sudo cp /tmp/liaotian-frontend.service /etc/systemd/system/liaotian-frontend.service
```

### 步骤4：重新加载并启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl start liaotian-frontend
sleep 5
```

### 步骤5：检查服务状态

```bash
sudo systemctl status liaotian-frontend --no-pager | head -20
```

**预期结果**：
- `Active: active (running)` - 服务正在运行 ✅
- `Active: inactive (dead)` - 服务未运行 ❌

### 步骤6：检查端口监听

```bash
ss -tlnp | grep ':3000'
```

**预期结果**：应该看到端口3000被监听。

### 步骤7：测试静态文件访问

```bash
curl -I http://localhost:3000/_next/static/chunks/adc3be135379192a.js
```

**预期结果**：应该返回 `HTTP/1.1 200 OK`。

## 如果服务仍然无法启动

### 查看详细日志

```bash
sudo journalctl -u liaotian-frontend -n 50 --no-pager
```

查找错误信息，常见错误：
- `Cannot find module` - 模块缺失
- `EACCES` - 权限问题
- `ENOENT` - 文件不存在

### 手动测试服务器启动

```bash
cd "$FULL_STANDALONE_DIR"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
nvm use 20
node server.js
```

**预期结果**：应该看到类似以下输出：
```
▲ Next.js 16.0.2
- Local:        http://localhost:3000
- Network:      http://0.0.0.0:3000
✓ Ready in 96ms
```

如果有错误，会显示错误信息。

## 一键执行脚本

如果上述步骤太复杂，可以使用已创建的脚本：

```bash
# 上传脚本到服务器
scp deploy/服务器上直接执行-修复502.sh ubuntu@165.154.233.55:/tmp/fix_502.sh

# 在服务器上执行
ssh ubuntu@165.154.233.55 "chmod +x /tmp/fix_502.sh && bash /tmp/fix_502.sh"
```

## 验证修复成功

修复成功后：
1. ✅ 服务状态为 `active (running)`
2. ✅ 端口3000被监听
3. ✅ 页面不再显示502错误
4. ✅ 浏览器控制台没有502错误

## 如果仍然失败

请提供以下信息：
1. `sudo systemctl status liaotian-frontend` 的完整输出
2. `sudo journalctl -u liaotian-frontend -n 50 --no-pager` 的完整输出
3. 手动执行 `node server.js` 时的输出（如果有错误）

这样我可以根据具体情况提供针对性的修复方案。

