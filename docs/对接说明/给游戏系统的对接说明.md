# 给游戏系统的对接说明文档

> **创建日期**: 2025-11-15  
> **目标**: 说明我们的系统如何对接游戏系统，以及游戏系统是否需要调整

---

## 对接概述

我们的系统（聊天AI群聊程序）需要与您的红包游戏系统对接，实现以下功能：
1. 检测游戏系统中的红包
2. 使用导入的账号参与红包游戏
3. 获取红包参与结果

---

## 对接方式（按推荐顺序）

### 方式1：数据库对接（推荐，无需游戏系统改动）✅

**原理**：我们的系统直接查询游戏系统的数据库，获取活跃红包信息。

**优点**：
- ✅ **游戏系统无需任何改动**
- ✅ 实时查询，准确可靠
- ✅ 性能好，延迟低

**要求**：
- 需要数据库访问权限（建议只读权限）
- 数据库连接字符串

**数据库表结构要求**：
- `envelopes` 表：包含 `id`, `chat_id`, `sender_tg_id`, `mode`, `total_amount`, `shares`, `status`, `is_finished`, `activated_at` 等字段
- `envelope_shares` 表：包含 `envelope_id`, `user_tg_id`, `amount`, `grabbed_at` 等字段

**我们需要的配置**：
```bash
GAME_DATABASE_URL=sqlite:///./path/to/your/data.sqlite
# 或 PostgreSQL/MySQL 连接字符串
```

---

### 方式2：Telegram 按钮检测（默认，无需游戏系统改动）✅

**原理**：我们的系统通过 Telegram API 检测消息中的红包按钮（`callback_data: hb:grab:{envelope_id}`）。

**优点**：
- ✅ **游戏系统无需任何改动**
- ✅ 自动检测，实时响应
- ✅ 无需额外配置

**工作原理**：
1. 我们的系统监听群组消息
2. 检测消息中的内联按钮
3. 查找 `callback_data` 格式为 `hb:grab:{envelope_id}` 的按钮
4. 提取 `envelope_id` 作为红包 ID

**要求**：
- 红包消息必须包含内联按钮
- 按钮 `callback_data` 格式：`hb:grab:{envelope_id}`

---

### 方式3：直接调用游戏系统函数（可选，无需游戏系统改动）✅

**原理**：我们的系统直接导入并调用游戏系统的 `grab_share()` 函数。

**优点**：
- ✅ **游戏系统无需任何改动**
- ✅ 直接调用，性能好
- ✅ 无需 HTTP API

**要求**：
- 游戏系统代码路径
- Python 环境兼容

**我们需要的配置**：
```bash
GAME_SYSTEM_PATH=E:/002-工作文件/重要程序/红包系统机器人/037重新开发新功能
```

---

### 方式4：HTTP API 对接（需要游戏系统提供 API）⚠️

**原理**：游戏系统提供 HTTP API，我们的系统通过 API 查询和参与。

**优点**：
- ✅ 解耦，安全
- ✅ 可以控制访问权限

**缺点**：
- ❌ **需要游戏系统实现 API 接口**

**需要的 API 接口**：

#### 1. 获取游戏状态
```
GET /api/v1/redpacket-game/status/{group_id}

响应：
{
  "game_status": "ACTIVE" | "IDLE",
  "current_game_id": "123",
  "active_redpackets": [
    {
      "redpacket_id": "123",
      "group_id": -1001234567890,
      "game_id": "123",
      "amount": 100.0,
      "count": 10,
      "claimed_count": 5,
      "remaining_count": 5,
      "game_type": "normal",
      "expires_at": "2025-11-15T10:00:00Z"
    }
  ],
  "statistics": {}
}
```

#### 2. 参与红包
```
POST /api/v1/redpacket-game/participate

请求体：
{
  "account_id": "123456789",
  "redpacket_id": "123",
  "group_id": -1001234567890
}

响应：
{
  "success": true,
  "amount": 10.5,
  "token": "USDT",
  "is_last": false
}
```

**认证方式**：
- API Key（Bearer Token）
- 或其他认证方式

---

## 推荐方案

### 方案A：数据库对接（最简单，推荐）✅

**游戏系统需要做的**：
- ✅ **无需任何改动**
- ✅ 只需提供数据库访问权限（建议只读）

**我们的系统配置**：
```bash
GAME_DATABASE_URL=sqlite:///./path/to/your/data.sqlite
```

**工作流程**：
1. 我们的系统查询 `envelopes` 表获取活跃红包
2. 调用游戏系统的 `grab_share()` 函数参与（如果配置了代码路径）
3. 或通过 Telegram API 点击按钮参与

---

### 方案B：Telegram 按钮检测（默认，无需配置）✅

**游戏系统需要做的**：
- ✅ **无需任何改动**
- ✅ 保持现有的按钮格式即可

**工作流程**：
1. 我们的系统检测消息中的按钮
2. 提取 `envelope_id`
3. 通过 Telegram API 点击按钮参与

---

## 游戏系统需要调整的情况

### 情况1：提供 HTTP API（可选）

如果游戏系统希望提供 HTTP API 接口，需要实现：
- `GET /api/v1/redpacket-game/status/{group_id}` - 获取游戏状态
- `POST /api/v1/redpacket-game/participate` - 参与红包

**实现建议**：
- 使用 FastAPI 或 Flask 实现
- 添加 API Key 认证
- 返回 JSON 格式数据

### 情况2：Webhook 事件通知（可选）

如果游戏系统希望主动推送事件，可以实现 Webhook：

**我们提供的 Webhook 端点**：
```
POST /api/v1/game-webhook/events
```

**事件格式**：
```json
{
  "event_type": "REDPACKET_SENT" | "REDPACKET_CLAIMED" | "GAME_START" | "GAME_END",
  "event_id": "uuid",
  "group_id": -1001234567890,
  "game_id": "123",
  "timestamp": "2025-11-15T10:00:00Z",
  "payload": {
    "envelope_id": "123",
    "amount": 100.0,
    "user_id": 123456789
  }
}
```

---

## 总结

### 游戏系统无需改动的情况 ✅

1. **数据库对接**（推荐）
   - 只需提供数据库访问权限
   - 无需代码改动

2. **Telegram 按钮检测**（默认）
   - 无需任何改动
   - 保持现有按钮格式

3. **直接调用函数**
   - 无需改动
   - 只需提供代码路径

### 游戏系统需要调整的情况 ⚠️

1. **提供 HTTP API**（可选）
   - 需要实现 API 接口
   - 需要添加认证

2. **Webhook 事件通知**（可选）
   - 需要实现 Webhook 推送
   - 需要配置 Webhook URL

---

## 建议

**推荐方案**：使用**数据库对接**（方式1）

**理由**：
- ✅ 游戏系统无需任何改动
- ✅ 实时、准确、性能好
- ✅ 实现简单，只需提供数据库访问权限

**实施步骤**：
1. 游戏系统提供数据库连接字符串（建议只读权限）
2. 我们的系统配置 `GAME_DATABASE_URL`
3. 完成对接，开始使用

---

## 联系方式

如有任何问题或需要调整，请联系我们。

---

**结论**：**游戏系统无需改动**即可完成对接！我们推荐使用数据库对接方式，只需提供数据库访问权限即可。

