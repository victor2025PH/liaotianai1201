# 服务器部署测试正确流程

## 用户指出的关键问题

**测试session文件应该是在服务器上部署和启动，不应该在本地启动测试。**

## 系统架构分析

### 账号创建流程（已实现）

```
1. 用户选择session文件
   ↓
2. 调用 create_account API
   ↓
3. IntelligentAllocator.allocate_account() 智能分配服务器
   - 使用剧本亲和性策略
   - 选择最合适的服务器
   ↓
4. SessionUploader 上传session文件到服务器
   - 通过SSH上传到服务器
   - 保存远程路径
   ↓
5. 在数据库中创建账号记录
   - server_id 已设置
   - session_file 是远程路径
   ↓
6. 账号在服务器上，不在本地AccountManager中
```

### 账号启动流程（当前问题）

**当前实现**：
```
1. 调用 start_account API
   ↓
2. 检查 AccountManager 中是否存在
   ↓
3. 如果不存在，从数据库加载到 AccountManager
   ↓
4. 在本地 AccountManager 中启动账号 ❌
```

**应该的实现**：
```
1. 调用 start_account API
   ↓
2. 检查账号的 server_id
   ↓
3. 如果 server_id 存在：
   - 在服务器上启动账号 ✅
   - 不在本地 AccountManager 中启动
   ↓
4. 如果 server_id 不存在：
   - 在本地 AccountManager 中启动（旧逻辑）
```

## 当前问题

### 问题1：start_account 在本地启动账号
- ❌ 即使账号有 `server_id`，也在本地启动
- ✅ 应该：检查 `server_id`，如果在服务器上，远程启动

### 问题2：测试流程不正确
- ❌ 在本地测试session文件
- ✅ 应该：session文件部署到服务器，在服务器上测试

## 正确的测试流程

### 步骤1：批量创建账号（自动分配到服务器）

1. **扫描本地session文件**
   - 从 `sessions/` 目录扫描
   - 显示可用session文件列表

2. **批量创建账号**
   - 选择多个session文件
   - 点击"批量创建"按钮
   - **系统会自动**：
     - 智能分配服务器
     - 上传session文件到服务器
     - 创建账号记录（包含 `server_id`）

3. **验证服务器分配**
   - 检查账号列表
   - 确认每个账号的 `server_id` 已设置
   - 确认 `session_file` 是远程路径

### 步骤2：在服务器上启动账号

**需要修改 `start_account` API**：
- 检查账号的 `server_id`
- 如果 `server_id` 存在，通过SSH在服务器上启动账号
- 如果 `server_id` 不存在，在本地启动（旧逻辑）

### 步骤3：在服务器上测试建群和聊天

1. **创建群组**
   - 账号在服务器上运行
   - 创建群组时，使用服务器上的账号client

2. **测试按剧本聊天**
   - 发送测试消息到群组
   - 服务器上的账号检测到消息
   - 服务器上的账号按照剧本自动回复

## 需要修改的代码

### 1. start_account API

需要修改 `admin-backend/app/api/group_ai/accounts.py` 中的 `start_account` 函数：

```python
@router.post("/{account_id}/start")
async def start_account(...):
    # 检查账号的 server_id
    db_account = db.query(GroupAIAccount).filter(...).first()
    
    if db_account and db_account.server_id:
        # 在服务器上启动账号
        # 通过SSH连接到服务器
        # 在服务器上执行启动命令
        return await start_account_on_server(account_id, db_account.server_id)
    else:
        # 在本地启动账号（旧逻辑）
        return await start_account_local(account_id, ...)
```

### 2. 服务器启动函数

需要创建 `start_account_on_server` 函数：
- 通过SSH连接到服务器
- 在服务器上执行启动命令
- 返回启动结果

## 测试方案调整

### 正确的测试流程

1. **批量创建账号（自动分配到服务器）**
   - 使用前端界面批量选择session文件
   - 系统自动分配到服务器
   - 验证 `server_id` 已设置

2. **在服务器上启动账号**
   - 修改 `start_account` API支持服务器启动
   - 通过API启动账号
   - 验证账号在服务器上运行

3. **在服务器上测试建群和聊天**
   - 创建群组
   - 发送测试消息
   - 观察服务器上的账号自动回复

## 下一步

1. **修改 start_account API**
   - 检查 `server_id`
   - 如果存在，在服务器上启动
   - 如果不存在，在本地启动

2. **创建服务器启动函数**
   - 通过SSH连接服务器
   - 在服务器上执行启动命令

3. **调整测试方案**
   - 创建针对服务器部署的测试脚本
   - 测试服务器上的账号功能

