# 502问题 - 完整修复指南

## 问题现象

- `curl -I http://localhost:3000` 返回 "Connection refused"
- `curl -I http://aikz.usdt2026.cc/group-ai/accounts` 返回 502 Bad Gateway
- **根本原因**: 前端服务没有在3000端口运行

## 诊断步骤

### 1. 检查前端服务状态

```bash
ssh ubuntu@165.154.233.55

cd ~/liaotian/saas-demo

# 检查进程
ps aux | grep -E 'next.*dev|node.*3000' | grep -v grep

# 检查端口
sudo ss -tlnp | grep 3000

# 测试连接
curl -I http://localhost:3000
```

### 2. 查看前端日志

```bash
tail -100 /tmp/frontend.log
```

### 3. 检查配置

```bash
cd ~/liaotian/saas-demo

# 检查package.json
grep '"dev"' package.json
# 应该看到: "dev": "next dev -p 3000"

# 检查Node.js和npm
node -v
npm -v

# 检查依赖
ls -d node_modules/.bin/next
```

## 常见错误原因和修复

### 原因1: 缺少依赖模块

**症状**: 
- 日志显示 `Cannot find module` 或 `Module not found`
- `node_modules` 目录不存在或损坏

**修复**:
```bash
cd ~/liaotian/saas-demo
npm install
```

### 原因2: 端口配置错误

**症状**: 
- package.json中dev脚本端口不是3000

**修复**:
```bash
cd ~/liaotian/saas-demo
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.scripts.dev = 'next dev -p 3000';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n', 'utf8');
"
```

### 原因3: 端口被占用

**症状**: 
- 日志显示 `Port 3000 is already in use` 或 `EADDRINUSE`
- 端口3000被其他进程占用

**修复**:
```bash
# 查找占用端口的进程
sudo lsof -ti:3000
sudo ss -tlnp | grep 3000

# 停止所有相关进程
pkill -f "next.*dev|node.*3000"
```

### 原因4: 代码语法错误

**症状**: 
- 日志显示 `SyntaxError` 或 `Parse error`
- 启动时立即崩溃

**修复**: 
- 查看具体错误信息
- 修复对应的代码文件

### 原因5: 服务启动后崩溃

**症状**: 
- 进程启动后立即退出
- 日志中有错误信息

**修复**: 
- 查看 `/tmp/frontend.log` 中的错误
- 根据错误信息修复

## 完整修复流程

### 步骤1: 诊断

```bash
cd ~/liaotian/saas-demo

# 1. 检查进程
ps aux | grep -E 'next.*dev|node.*3000' | grep -v grep || echo "无前端进程"

# 2. 检查端口
sudo ss -tlnp | grep 3000 || echo "端口3000未监听"

# 3. 查看日志
tail -100 /tmp/frontend.log || echo "日志文件不存在"

# 4. 检查配置
grep '"dev"' package.json
node -v
npm -v
ls -d node_modules/.bin/next 2>/dev/null || echo "Next.js未安装"
```

### 步骤2: 停止旧进程

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
sleep 2
```

### 步骤3: 安装依赖（如果需要）

```bash
cd ~/liaotian/saas-demo

# 如果node_modules不存在或Next.js未安装
if [ ! -d node_modules ] || [ ! -f node_modules/.bin/next ]; then
    echo "安装依赖..."
    npm install
fi
```

### 步骤4: 前台测试运行

```bash
cd ~/liaotian/saas-demo

# 前台运行，观察输出
npm run dev
```

**观察要点**:
- 是否显示 "Ready on http://localhost:3000"
- 是否有错误信息
- 进程是否稳定运行

**如果进程退出，查看错误**:
- `Cannot find module` → 运行 `npm install`
- `Port already in use` → 停止占用端口的进程
- `Syntax error` → 修复代码错误

### 步骤5: 后台启动

当前台测试成功（看到 "Ready" 消息）后：

```bash
cd ~/liaotian/saas-demo

# 停止前台进程（Ctrl+C）
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 后台启动
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15

# 验证
curl -I http://localhost:3000
```

应该返回 HTTP 200 或 304

### 步骤6: 重载Nginx并验证

```bash
# 重载Nginx
sudo systemctl reload nginx
sleep 3

# 验证域名访问
curl -I http://aikz.usdt2026.cc/group-ai/accounts
curl -I http://aikz.usdt2026.cc/
```

应该返回 HTTP 200、302 或 304，不再是 502

## 一键修复脚本

已创建以下修复脚本：

### 1. 完整诊断和修复脚本

```bash
bash ~/liaotian/deploy/彻底诊断并修复502.sh
```

### 2. 简化版修复脚本

```bash
bash ~/liaotian/deploy/修复502-简化版.sh
```

### 3. 分步诊断脚本

```bash
bash ~/liaotian/deploy/诊断502-分步执行.sh

# 查看诊断结果
cat /tmp/diagnose_step1.txt  # 进程和端口
cat /tmp/diagnose_step2.txt  # 日志
cat /tmp/diagnose_step3.txt  # 配置
cat /tmp/diagnose_step4.txt  # 前台运行输出
cat /tmp/diagnose_step5.txt  # 连接测试
```

## 从零启动所有服务的完整命令

```bash
#!/bin/bash
# 在远程服务器 ubuntu@165.154.233.55 上执行

# 1. 启动后端服务
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5

# 验证后端
curl -s http://localhost:8000/health || echo "后端启动失败"

# 2. 启动前端服务
cd ~/liaotian/saas-demo

# 停止旧进程
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 确保依赖已安装
if [ ! -d node_modules ] || [ ! -f node_modules/.bin/next ]; then
    echo "安装依赖..."
    npm install
fi

# 后台启动
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 20

# 验证前端
curl -I http://localhost:3000 | head -5 || echo "前端启动失败"

# 3. 重载Nginx
sudo systemctl reload nginx
sleep 3

# 4. 验证所有服务
echo "后端健康检查:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

echo "前端服务:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000

echo "域名访问:"
curl -s -o /dev/null -w '%{http_code}\n' http://aikz.usdt2026.cc/group-ai/accounts
```

## 验证修复是否成功

### 本地验证

```bash
# 后端
curl -I http://localhost:8000/health
# 应该返回: HTTP/1.1 200 OK

# 前端
curl -I http://localhost:3000
# 应该返回: HTTP/1.1 200 OK 或 304 Not Modified
```

### 域名验证

```bash
curl -I http://aikz.usdt2026.cc/group-ai/accounts
curl -I http://aikz.usdt2026.cc/
# 应该返回: HTTP/1.1 200 OK 或 302 Found 或 304 Not Modified（不是502）
```

## 总结

**导致 dev 无法在 3000 端口稳定运行的根本原因**通常是：

1. **前端服务未启动** - 最常见
2. **依赖未安装** - node_modules不存在或损坏
3. **端口被占用** - 其他进程占用了3000端口
4. **端口配置错误** - package.json中dev脚本端口不是3000
5. **代码错误** - 语法错误或运行时错误导致进程崩溃

**修复步骤**：

1. 停止旧进程
2. 安装依赖（如果需要）
3. 修复端口配置（如果需要）
4. 前台测试运行
5. 后台启动
6. 重载Nginx
7. 验证服务状态

---

**重要提示**: 所有操作都在远程服务器 `ubuntu@165.154.233.55` 上执行！
