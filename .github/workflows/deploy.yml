name: Deploy Full Stack

on:
  push:
    branches:
      - main
    paths:
      - 'saas-demo/**'
      - 'admin-backend/**'
      - 'agent/**'
      - 'aizkw20251219/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'éƒ¨ç½²åç«¯ (admin-backend)'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'éƒ¨ç½²å‰ç«¯ (saas-demo)'
        required: false
        default: true
        type: boolean
      deploy_aizkw:
        description: 'éƒ¨ç½² aizkw é¡¹ç›®åˆ° 3003 ç«¯å£'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸš€ å…¨æ ˆéƒ¨ç½²"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""
            
            PROJECT_ROOT="/home/ubuntu/telegram-ai-system"
            
            # ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•å­˜åœ¨
            if [ ! -d "$PROJECT_ROOT" ]; then
              echo "âŒ é¡¹ç›®æ ¹ç›®å½•ä¸å­˜åœ¨: $PROJECT_ROOT"
              echo "æ­£åœ¨åˆ›å»ºç›®å½•å¹¶å…‹éš†é¡¹ç›®..."
              mkdir -p "$PROJECT_ROOT"
              cd "$PROJECT_ROOT"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "âŒ Git clone å¤±è´¥"
                exit 1
              }
            fi
            
            # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
            echo "ğŸ“ [1/8] è¿›å…¥é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || {
              echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®æ ¹ç›®å½•"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo ""
            echo "ğŸ“¥ [2/8] æ‹‰å–æœ€æ–°ä»£ç ..."
            echo "----------------------------------------"
            
            if [ ! -d ".git" ]; then
              echo "âš ï¸  å½“å‰ç›®å½•ä¸æ˜¯ git ä»“åº“ï¼Œåˆå§‹åŒ–..."
              git init || true
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            git fetch origin main || git fetch origin || true
            git stash || true
            git reset --hard origin/main || {
              echo "âš ï¸  git reset å¤±è´¥ï¼Œå°è¯• git pull..."
              git pull origin main || {
                echo "âš ï¸  Git pull å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
              }
            }
            
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
            echo "æœ€æ–°æäº¤: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # ============================================
            # éƒ¨ç½²åç«¯ (admin-backend)
            # ============================================
            if [ "${{ github.event.inputs.deploy_backend }}" != "false" ] && [ -d "admin-backend" ]; then
              echo "ğŸ”§ [3/8] éƒ¨ç½²åç«¯æœåŠ¡..."
              echo "----------------------------------------"
              
              cd "$PROJECT_ROOT/admin-backend"
              
              # æ£€æŸ¥ requirements.txt
              if [ ! -f "requirements.txt" ]; then
                echo "âš ï¸  requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡åç«¯éƒ¨ç½²"
              else
                # å®‰è£…/æ›´æ–°ä¾èµ–
                echo "å®‰è£… Python ä¾èµ–..."
                pip3 install -r requirements.txt --break-system-packages --quiet || {
                  echo "âš ï¸  ä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
                }
                
                # åœæ­¢æ—§çš„åç«¯è¿›ç¨‹
                echo "åœæ­¢æ—§çš„åç«¯è¿›ç¨‹..."
                pm2 delete backend 2>/dev/null || true
                pkill -f 'uvicorn.*app.main:app' 2>/dev/null || true
                if sudo lsof -i :8000 >/dev/null 2>&1; then
                  sudo lsof -ti :8000 | xargs sudo kill -9 2>/dev/null || true
                  sleep 2
                fi
                
                # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
                mkdir -p "$PROJECT_ROOT/logs"
                
                # ä½¿ç”¨ PM2 å¯åŠ¨åç«¯
                echo "å¯åŠ¨åç«¯æœåŠ¡ (ç«¯å£ 8000)..."
                pm2 start python3 \
                  --name backend \
                  --interpreter python3 \
                  --error "$PROJECT_ROOT/logs/backend-error.log" \
                  --output "$PROJECT_ROOT/logs/backend-out.log" \
                  --merge-logs \
                  --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
                  -- -m uvicorn app.main:app --host 0.0.0.0 --port 8000 || {
                  echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯..."
                  pm2 logs backend --lines 50 --nostream 2>/dev/null || true
                  exit 1
                }
                
                pm2 save || true
                echo "âœ… åç«¯æœåŠ¡å·²å¯åŠ¨"
                sleep 5
                
                # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
                if curl -s http://127.0.0.1:8000/health >/dev/null 2>&1; then
                  echo "âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
                else
                  echo "âš ï¸  åç«¯æœåŠ¡å¯èƒ½æœªå®Œå…¨å¯åŠ¨"
                fi
              fi
              echo ""
            fi
            
            # ============================================
            # éƒ¨ç½²å‰ç«¯ (saas-demo)
            # ============================================
            if [ "${{ github.event.inputs.deploy_frontend }}" != "false" ] && [ -d "saas-demo" ]; then
              echo "ğŸ¨ [4/8] éƒ¨ç½²å‰ç«¯æœåŠ¡..."
              echo "----------------------------------------"
              
              cd "$PROJECT_ROOT/saas-demo"
              
              # æ£€æŸ¥ package.json
              if [ ! -f "package.json" ]; then
                echo "âš ï¸  package.json ä¸å­˜åœ¨ï¼Œè·³è¿‡å‰ç«¯éƒ¨ç½²"
              else
                # å®‰è£…ä¾èµ–
                echo "å®‰è£… Node.js ä¾èµ–..."
                npm install --quiet || {
                  echo "âš ï¸  ä¾èµ–å®‰è£…å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
                }
                
                # æ„å»ºå‰ç«¯
                echo "æ„å»ºå‰ç«¯..."
                export NODE_OPTIONS="--max-old-space-size=3072"
                npm run build || {
                  echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥"
                  exit 1
                }
                
                # æ£€æŸ¥æ„å»ºè¾“å‡º
                if [ ! -d ".next" ] && [ ! -d "dist" ]; then
                  echo "âŒ æ„å»ºè¾“å‡ºç›®å½•ä¸å­˜åœ¨"
                  exit 1
                fi
                
                echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
                
                # åœæ­¢æ—§çš„å‰ç«¯è¿›ç¨‹
                echo "åœæ­¢æ—§çš„å‰ç«¯è¿›ç¨‹..."
                pm2 delete saas-demo-frontend 2>/dev/null || true
                pkill -f 'next.*start|node.*3000' 2>/dev/null || true
                if sudo lsof -i :3000 >/dev/null 2>&1; then
                  sudo lsof -ti :3000 | xargs sudo kill -9 2>/dev/null || true
                  sleep 2
                fi
                
                # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
                mkdir -p "$PROJECT_ROOT/logs"
                
                # ä½¿ç”¨ PM2 å¯åŠ¨å‰ç«¯
                echo "å¯åŠ¨å‰ç«¯æœåŠ¡ (ç«¯å£ 3000)..."
                if [ -d ".next/standalone" ]; then
                  # Next.js standalone æ¨¡å¼
                  pm2 start node \
                    --name saas-demo-frontend \
                    --error "$PROJECT_ROOT/logs/saas-demo-frontend-error.log" \
                    --output "$PROJECT_ROOT/logs/saas-demo-frontend-out.log" \
                    --merge-logs \
                    --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
                    -- .next/standalone/server.js || {
                    echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥"
                    exit 1
                  }
                else
                  # ä½¿ç”¨ npm start
                  pm2 start npm \
                    --name saas-demo-frontend \
                    --error "$PROJECT_ROOT/logs/saas-demo-frontend-error.log" \
                    --output "$PROJECT_ROOT/logs/saas-demo-frontend-out.log" \
                    --merge-logs \
                    --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
                    -- start || {
                    echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥"
                    exit 1
                  }
                fi
                
                pm2 save || true
                echo "âœ… å‰ç«¯æœåŠ¡å·²å¯åŠ¨"
                sleep 5
                
                # æ£€æŸ¥å‰ç«¯æœåŠ¡
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000 || echo "000")
                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                  echo "âœ… å‰ç«¯æœåŠ¡å“åº”æ­£å¸¸ (HTTP $HTTP_CODE)"
                else
                  echo "âš ï¸  å‰ç«¯æœåŠ¡å“åº”å¼‚å¸¸ (HTTP $HTTP_CODE)"
                fi
              fi
              echo ""
            fi
            
            # ============================================
            # éƒ¨ç½² aizkw (åŸæœ‰é€»è¾‘)
            # ============================================
            if [ "${{ github.event.inputs.deploy_aizkw }}" != "false" ] && [ -d "aizkw20251219" ]; then
              echo "ğŸ“¦ [5/8] éƒ¨ç½² aizkw é¡¹ç›®..."
              echo "----------------------------------------"
              
              SITE_DIR="aizkw20251219"
              PROJECT_DIR="$PROJECT_ROOT/$SITE_DIR"
              TARGET_PORT=3003
              PM2_NAME="aizkw-frontend"
              
              cd "$PROJECT_DIR" || {
                echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®å­ç›®å½•"
                exit 1
              }
              
              # å®‰è£…ä¾èµ–
              echo "å®‰è£…ä¾èµ–..."
              npm install --quiet || {
                echo "âš ï¸  ä¾èµ–å®‰è£…å¤±è´¥"
                exit 1
              }
              
              # æ„å»ºé¡¹ç›®
              echo "æ„å»ºé¡¹ç›®..."
              export NODE_OPTIONS="--max-old-space-size=3072"
              npm run build || {
                echo "âŒ æ„å»ºå¤±è´¥"
                exit 1
              }
              
              if [ ! -d "dist" ]; then
                echo "âŒ dist ç›®å½•ä¸å­˜åœ¨"
                exit 1
              fi
              
              echo "âœ… æ„å»ºå®Œæˆ"
              
              # æ£€æŸ¥å¹¶å®‰è£… serve
              if ! command -v serve >/dev/null 2>&1; then
                echo "å®‰è£… serve..."
                sudo npm install -g serve
              fi
              
              # åœæ­¢æ—§è¿›ç¨‹
              pm2 delete "$PM2_NAME" 2>/dev/null || true
              if sudo lsof -i :$TARGET_PORT >/dev/null 2>&1; then
                sudo lsof -ti :$TARGET_PORT | xargs sudo kill -9 2>/dev/null || true
                sleep 2
              fi
              
              # å¯åŠ¨æœåŠ¡
              mkdir -p "$PROJECT_ROOT/logs"
              pm2 start serve \
                --name "$PM2_NAME" \
                --error "$PROJECT_ROOT/logs/${PM2_NAME}-error.log" \
                --output "$PROJECT_ROOT/logs/${PM2_NAME}-out.log" \
                --merge-logs \
                --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
                -- -s "$PROJECT_DIR/dist" -l $TARGET_PORT || {
                echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥"
                exit 1
              }
              
              pm2 save || true
              echo "âœ… aizkw æœåŠ¡å·²å¯åŠ¨"
              echo ""
            fi
            
            # ============================================
            # éªŒè¯æ‰€æœ‰æœåŠ¡
            # ============================================
            echo "ğŸ” [6/8] éªŒè¯æ‰€æœ‰æœåŠ¡..."
            echo "----------------------------------------"
            pm2 list
            echo ""
            
            echo "ç«¯å£ç›‘å¬çŠ¶æ€:"
            sudo lsof -i :8000 -i :3000 -i :3003 2>/dev/null || echo "æ— æ³•æ£€æŸ¥ç«¯å£çŠ¶æ€"
            echo ""
            
            # ============================================
            # é‡å¯ Nginx
            # ============================================
            echo "ğŸŒ [7/8] é‡å¯ Nginx..."
            echo "----------------------------------------"
            sudo nginx -t && sudo systemctl restart nginx || {
              echo "âš ï¸  Nginx é‡å¯å¤±è´¥"
            }
            echo "âœ… Nginx å·²é‡å¯"
            echo ""
            
            # ============================================
            # å®Œæˆ
            # ============================================
            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""
            echo "æœåŠ¡çŠ¶æ€:"
            echo "  åç«¯: http://127.0.0.1:8000"
            echo "  å‰ç«¯: http://127.0.0.1:3000"
            echo "  aizkw: http://127.0.0.1:3003"
            echo ""
            echo "PM2 çŠ¶æ€:"
            pm2 list
            echo ""
            echo "éªŒè¯å‘½ä»¤:"
            echo "  pm2 list"
            echo "  curl -I http://127.0.0.1:8000/health"
            echo "  curl -I http://127.0.0.1:3000"
