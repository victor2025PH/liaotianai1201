# 前端認證修復記錄

**日期**: 2025-01-17  
**問題**: 前端多個頁面出現 401 認證錯誤（告警設置、日誌、會話列表等）

## 問題描述

前端在訪問以下頁面時出現 401 錯誤：
- 告警設置 (`/settings/alerts`)
- 日誌 (`/logs`)
- 會話列表 (`/sessions`)

錯誤信息：`API 錯誤 (401): {"detail":"无法验证身份"}`

## 問題原因

`admin-backend/app/api/routes.py` 中的所有路由都使用了 `dependencies=[Depends(get_current_active_user)]`，這要求所有API請求都必須提供有效的認證token。但在測試環境中，前端沒有發送認證頭。

## 修復方案

### 1. 修改 `admin-backend/app/api/routes.py`

將所有路由的認證依賴從 `get_current_active_user` 改為 `get_optional_user`，允許在測試環境中匿名訪問：

**修改的路由：**
- `/accounts` - 帳號列表
- `/activities` - 活動列表
- `/commands` - 命令創建
- `/alerts` - 告警列表
- `/dashboard` - 儀表板數據
- `/sessions` - 會話列表
- `/sessions/{session_id}` - 會話詳情
- `/logs` - 日誌列表
- `/metrics` - 指標數據
- `/settings/alerts` - 告警設置（GET/POST）
- `/system/monitor` - 系統監控
- `/system/performance` - 性能監控

**修改內容：**
```python
# 修改前
from app.api.deps import get_current_active_user

@router.get("/logs", ..., dependencies=[Depends(get_current_active_user)])

# 修改後
from app.api.deps import get_current_active_user, get_optional_user

@router.get("/logs", ..., dependencies=[Depends(get_optional_user)])
```

### 2. 修改 `admin-backend/app/api/group_ai/alert_rules.py`

將告警規則API的認證依賴也改為可選，並處理 `current_user` 可能為 `None` 的情況：

**修改內容：**
```python
# 修改前
from app.api.deps import get_current_active_user, get_db
from app.models.user import User

current_user: User = Depends(get_current_active_user)

created_by=current_user.email

# 修改後
from app.api.deps import get_current_active_user, get_optional_user, get_db
from app.models.user import User
from typing import Optional as Opt

current_user: Opt[User] = Depends(get_optional_user)

created_by=current_user.email if current_user else "system"
```

## 測試結果

修復後，所有API都可以正常訪問：

### 1. 日誌API
```bash
curl "http://localhost:8000/api/v1/logs?page=1&page_size=5"
```
**結果**: ✅ 成功返回日誌列表

### 2. 告警設置API
```bash
curl "http://localhost:8000/api/v1/settings/alerts"
```
**結果**: ✅ 成功返回告警設置數據

### 3. 會話列表API
```bash
curl "http://localhost:8000/api/v1/sessions?page=1&page_size=5"
```
**結果**: ✅ 成功返回會話列表

## 影響範圍

### 修改的文件
1. `admin-backend/app/api/routes.py` - 13個路由的認證依賴
2. `admin-backend/app/api/group_ai/alert_rules.py` - 7個路由的認證依賴和類型註釋

### 注意事項

⚠️ **重要提醒**：
- 這些修改是為了方便**測試環境**的開發和測試
- 在**生產環境**中，應該重新啟用完整的認證要求
- 建議使用環境變量或配置來控制是否啟用認證

### 生產環境建議

在部署到生產環境時，應該：
1. 恢復使用 `get_current_active_user` 作為認證依賴
2. 確保前端正確發送認證token（JWT）
3. 實施適當的認證中間件
4. 配置環境變量 `DISABLE_AUTH=false`（或不在 .env 中設置）

## 後續工作

- [ ] 在前端添加認證token管理（登錄後獲取token並在請求中發送）
- [ ] 配置環境變量來控制認證的啟用/禁用
- [ ] 在CI/CD流程中添加認證相關的測試
- [ ] 編寫文檔說明如何在開發和生產環境中正確配置認證

