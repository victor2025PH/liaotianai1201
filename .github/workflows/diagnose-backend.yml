name: Diagnose Backend Service

on:
  workflow_dispatch:  # 允许手动触发
  push:
    paths:
      - '.github/workflows/diagnose-backend.yml'
      - 'scripts/server/diagnose-backend.sh'

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Diagnose and Fix Backend
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 10m
          debug: true
          script: |
            set -e
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            BACKEND_DIR="$PROJECT_DIR/admin-backend"
            USER="ubuntu"
            
            echo "=========================================="
            echo "后端服务诊断和修复"
            echo "=========================================="
            echo ""
            
            # 1. 查看错误日志
            echo "1️⃣ 查看后端错误日志..."
            echo "----------------------------------------"
            sudo -u $USER pm2 logs backend --lines 50 --nostream 2>&1 || echo "⚠️  无法获取日志（服务可能未启动）"
            echo ""
            
            # 2. 检查并修复配置文件 (.env)
            echo "2️⃣ 检查并修复配置文件..."
            echo "----------------------------------------"
            cd "$BACKEND_DIR" || exit 1
            
            if [ ! -f .env ]; then
                echo "⚠️  缺少 .env 文件，正在从 env.example 复制..."
                if [ -f env.example ]; then
                    cp env.example .env
                    echo "✅ 已从 env.example 创建 .env 文件"
                else
                    echo "❌ 错误：env.example 文件不存在"
                    exit 1
                fi
            else
                echo "✅ .env 文件已存在"
            fi
            echo ""
            
            # 2.5. 安装并启动 Redis（如果需要）
            echo "2.5️⃣ 检查 Redis 服务..."
            echo "----------------------------------------"
            if ! command -v redis-server &> /dev/null; then
                echo "🔧 安装 Redis..."
                sudo DEBIAN_FRONTEND=noninteractive apt-get update -q
                sudo DEBIAN_FRONTEND=noninteractive apt-get install -y redis-server
            fi
            sudo systemctl start redis-server || true
            sudo systemctl enable redis-server || true
            if sudo systemctl is-active --quiet redis-server; then
                echo "✅ Redis 服务已启动"
            else
                echo "⚠️  Redis 服务启动失败"
                sudo systemctl status redis-server --no-pager -l | head -10 || true
            fi
            echo ""
            
            # 3. 重启后端
            echo "3️⃣ 重启后端服务..."
            echo "----------------------------------------"
            sudo -u $USER pm2 restart backend || {
                echo "⚠️  PM2 restart 失败，尝试重新启动..."
                sudo -u $USER pm2 delete backend 2>/dev/null || true
                cd "$PROJECT_DIR"
                sudo -u $USER pm2 start ecosystem.config.js --only backend
            }
            sudo -u $USER pm2 save
            echo "⏳ 等待服务启动 (5秒)..."
            sleep 5
            echo ""
            
            # 4. 验证端口
            echo "4️⃣ 验证端口 8000 是否正在监听..."
            echo "----------------------------------------"
            if command -v netstat &> /dev/null; then
                sudo netstat -tulpn | grep 8000 || echo "❌ 端口 8000 未被监听"
            elif command -v ss &> /dev/null; then
                sudo ss -tulpn | grep 8000 || echo "❌ 端口 8000 未被监听"
            else
                echo "⚠️  未找到 netstat 或 ss 命令，使用 lsof 检查..."
                sudo lsof -i:8000 || echo "❌ 端口 8000 未被监听"
            fi
            echo ""
            
            # 5. 检查服务状态
            echo "5️⃣ 检查 PM2 服务状态..."
            echo "----------------------------------------"
            sudo -u $USER pm2 list
            echo ""
            
            # 6. 最终检查 - 后端日志
            echo "6️⃣ 最终检查 - 后端日志（最后 20 行）..."
            echo "----------------------------------------"
            sudo -u $USER pm2 logs backend --lines 20 --nostream 2>&1 || echo "⚠️  无法获取日志"
            echo ""
            
            echo "=========================================="
            echo "诊断完成！"
            echo "=========================================="
