#!/bin/bash
# ============================================================
# 删除新发现的恶意软件文件
# ============================================================

set +e

echo "=========================================="
echo "🔥 删除新发现的恶意软件文件"
echo "=========================================="
echo ""

# 新发现的可疑文件
SUSPICIOUS_FILES=("/data/4pVffo7" "/data/T1ID" "/data/ZaAxbGP")

# 1. 列出当前文件
echo "[1/5] 检查文件状态..."
for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  发现文件: $file"
        ls -lh "$file" | awk '{print "    大小: " $5 ", 权限: " $1 ", 修改时间: " $6 " " $7 " " $8}'
    else
        echo "  文件不存在: $file"
    fi
done
echo ""

# 2. 终止所有相关进程
echo "[2/5] 终止所有相关进程..."
for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        FILE_NAME=$(basename "$file")
        
        # 终止使用该文件的进程
        PIDS=$(sudo lsof "$file" 2>/dev/null | awk 'NR>1 {print $2}' | sort -u || true)
        for pid in $PIDS; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                echo "  终止进程 PID: $pid (使用文件: $FILE_NAME)"
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
        
        # 终止命令中包含文件名的进程
        sudo pkill -9 -f "$FILE_NAME" 2>/dev/null || true
        sudo killall -9 "$FILE_NAME" 2>/dev/null || true
        
        # 终止所有同名进程
        pgrep -f "$FILE_NAME" | while read pid; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                echo "  终止进程 PID: $pid"
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
    fi
done

sleep 3
echo "  ✅ 进程终止完成"
echo ""

# 3. 移除文件特殊属性
echo "[3/5] 移除文件特殊属性..."
for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  处理: $file"
        # 移除所有特殊属性
        sudo chattr -a -i -u -s "$file" 2>/dev/null || true
        # 确保文件可写
        sudo chmod 644 "$file" 2>/dev/null || true
    fi
done
echo "  ✅ 属性移除完成"
echo ""

# 4. 强制删除文件
echo "[4/5] 强制删除文件..."
DELETED=0
FAILED=0

for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  删除: $file"
        
        DELETE_SUCCESS=false
        
        # 方法 1: 标准删除
        if sudo rm -f "$file" 2>/dev/null; then
            sleep 0.5
            if [ ! -f "$file" ]; then
                DELETE_SUCCESS=true
                echo "    ✅ 删除成功"
            fi
        fi
        
        # 如果方法 1 失败，尝试方法 2（覆盖删除）
        if [ "$DELETE_SUCCESS" = false ] && [ -f "$file" ]; then
            echo "    ⚠️  标准删除失败，尝试覆盖删除..."
            if sudo dd if=/dev/zero of="$file" bs=1M count=10 2>/dev/null; then
                sync
                sleep 0.5
                if sudo rm -f "$file" 2>/dev/null; then
                    sleep 0.5
                    if [ ! -f "$file" ]; then
                        DELETE_SUCCESS=true
                        echo "    ✅ 覆盖删除成功"
                    fi
                fi
            fi
        fi
        
        # 如果方法 2 失败，尝试方法 3（unlink）
        if [ "$DELETE_SUCCESS" = false ] && [ -f "$file" ]; then
            echo "    ⚠️  覆盖删除失败，尝试 unlink..."
            if sudo unlink "$file" 2>/dev/null; then
                sync
                sleep 0.5
                if [ ! -f "$file" ]; then
                    DELETE_SUCCESS=true
                    echo "    ✅ unlink 删除成功"
                fi
            fi
        fi
        
        # 同步文件系统
        sync
        sync
        sleep 1
        
        # 最终验证
        if [ "$DELETE_SUCCESS" = true ] || [ ! -f "$file" ]; then
            DELETED=$((DELETED+1))
        else
            FAILED=$((FAILED+1))
            echo "    ❌ 所有删除方法均失败"
        fi
    fi
done

echo ""
if [ "$DELETED" -gt 0 ]; then
    echo "  ✅ 成功删除 $DELETED 个文件"
fi
if [ "$FAILED" -gt 0 ]; then
    echo "  ⚠️  $FAILED 个文件删除失败"
fi
echo ""

# 5. 最终验证
echo "[5/5] 最终验证..."
sync
sync
sleep 2

# 强制刷新目录缓存
ls /data/ >/dev/null 2>&1 || true
sleep 1

REMAINING=0
for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        REMAINING=$((REMAINING+1))
        echo "  ❌ 文件仍存在: $file"
    else
        echo "  ✅ 文件已删除: $file"
    fi
done

echo ""
echo "=========================================="
if [ "$REMAINING" -eq 0 ]; then
    echo "✅ 所有可疑文件已成功删除！"
    echo "=========================================="
    echo ""
    echo "建议后续操作:"
    echo "  1. 检查定时任务: crontab -l"
    echo "  2. 检查系统启动项: systemctl list-unit-files | grep enabled"
    echo "  3. 运行安全扫描: sudo rkhunter --check"
    echo "  4. 更改所有密码"
    echo "  5. 监控系统资源: top"
else
    echo "⚠️  仍有 $REMAINING 个文件无法删除"
    echo "=========================================="
    echo ""
    echo "建议操作:"
    echo "  1. 重启系统后立即运行此脚本"
    echo "  2. 检查是否有隐藏进程: ps aux | grep -E '4pVffo7|T1ID|ZaAxbGP'"
    echo "  3. 检查文件系统: sudo fsck /dev/vdb"
fi
echo ""

