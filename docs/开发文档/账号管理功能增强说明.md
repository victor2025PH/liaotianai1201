# 账号管理功能增强说明

## 概述

本次更新为账号管理页面添加了以下核心功能：
1. **从所有节点读取账号**：自动从Workers API读取所有服务器和本地电脑的账号
2. **合并显示**：在账号列表中同时显示数据库账号和Worker节点账号
3. **角色分配集成**：在账号管理中直接分配角色，无需跳转到其他页面
4. **自动加载角色**：选择剧本时自动加载该剧本的所有角色
5. **智能角色分配**：支持自动分配和手动指定角色

## 功能详情

### 1. 从所有节点读取账号

#### 实现方式
- 调用 `/api/v1/workers/` API 获取所有Worker节点状态
- 遍历每个在线节点的 `accounts` 列表
- 提取账号信息（phone, first_name, status, role_name等）
- 与数据库账号列表进行去重（通过phone_number或account_id匹配）

#### 账号来源标识
- **数据库账号**：正常显示，有完整的账号信息
- **Worker节点账号**：显示"Worker节点"标签，背景色略有不同，便于区分

#### 显示位置
- Worker节点账号显示在账号列表的底部
- 账号卡片显示节点ID（`node_id`）
- 状态显示为账号的实际在线状态

### 2. 角色分配功能

#### 角色加载
- **自动加载**：选择剧本时自动调用 `extractRoles` API提取角色列表
- **缓存机制**：已加载的角色列表会被缓存，避免重复请求
- **实时显示**：在剧本选择框下方显示该剧本包含的所有角色

#### 角色分配方式

**方式1：手动分配（推荐）**
1. 点击账号行的"角色分配"按钮（Users图标）
2. 如果账号已分配剧本，自动加载该剧本的角色列表
3. 点击角色卡片即可分配
4. 已分配的角色会高亮显示

**方式2：自动分配**
- 在批量操作中，可以为多个账号自动分配角色
- 系统会根据角色权重和账号数量智能分配

#### 角色显示
- 在账号列表的"剧本"列中，如果账号已分配角色，会显示角色名称的Badge
- 角色信息会实时更新，无需刷新页面

### 3. 剧本选择增强

#### 自动角色加载
- 在"添加账号"对话框中，选择剧本后自动加载角色列表
- 在"编辑账号"对话框中，选择或更改剧本时也会自动加载角色
- 角色列表显示在剧本选择框下方，以Badge形式展示

#### 角色信息展示
```
剧本包含 6 个角色：
[小柒] [米米] [浩哥] [小雨] [阿强] [老张]
```

### 4. Worker节点账号处理

#### 账号识别
- Worker节点账号通过 `source: 'worker'` 标识
- 显示节点ID（`node_id`）而不是服务器ID
- 背景色略有不同，便于区分

#### 账号操作
- **创建账号**：点击"+"按钮，可以将Worker节点账号添加到数据库
- **分配剧本**：为Worker节点账号分配剧本后，可以分配角色
- **分配角色**：分配剧本后，可以像数据库账号一样分配角色

## 使用流程

### 完整流程示例

1. **查看所有账号**
   - 页面加载时自动从数据库和所有Worker节点读取账号
   - 账号列表显示所有账号，包括数据库账号和Worker节点账号

2. **为账号分配剧本**
   - 点击"添加账号"或"编辑"按钮
   - 选择剧本，系统自动加载该剧本的角色列表
   - 保存后，账号已分配剧本

3. **为账号分配角色**
   - 点击账号行的"角色分配"按钮（Users图标）
   - 系统自动加载该账号剧本的所有角色
   - 点击角色卡片即可分配
   - 已分配的角色会高亮显示

4. **批量操作**
   - 选择多个账号
   - 可以批量更新剧本
   - 可以批量分配角色（自动模式）

## 技术实现

### API调用

```typescript
// 获取Workers列表
const workersData = await getWorkers()

// 提取角色
const rolesData = await extractRoles(scriptId)

// 创建角色分配
const assignment = await createAssignment({
  script_id: scriptId,
  account_ids: [accountId],
  mode: "manual",
  manual_assignments: { [accountId]: roleId }
})
```

### 状态管理

```typescript
// Worker账号列表
const [workerAccounts, setWorkerAccounts] = useState<Array<Account & { node_id: string, source: 'worker' }>>([])

// 角色列表（按剧本缓存）
const [allRoles, setAllRoles] = useState<Record<string, Role[]>>({})

// 角色分配映射
const [accountRoleAssignments, setAccountRoleAssignments] = useState<Record<string, string>>({})
```

### 角色名称获取

```typescript
const getAccountRoleName = (account: Account): string | null => {
  if (!account.script_id || !accountRoleAssignments[account.account_id]) {
    return null
  }
  const roleId = accountRoleAssignments[account.account_id]
  const roles = allRoles[account.script_id] || []
  const role = roles.find(r => r.role_id === roleId)
  return role ? role.role_name : null
}
```

## 界面说明

### 账号列表表格

| 列名 | 说明 |
|------|------|
| 账号数据 | 显示头像、名称、用户名、手机号、账号ID |
| 状态 | 在线/离线/错误状态 |
| 剧本 | 显示剧本ID，如果已分配角色，显示角色名称Badge |
| 服务器 | 显示服务器/节点ID |
| 群组數 | 账号加入的群组数量 |
| 消息数 | 账号发送的消息数量 |
| 回复數 | 账号回复的消息数量 |
| 操作 | 启动/停止、编辑、设置、角色分配、创建群组等 |

### 角色分配对话框

- **标题**：显示账号ID和剧本ID
- **角色列表**：以卡片形式展示所有可用角色
- **当前角色**：如果已分配角色，显示当前角色信息
- **操作**：点击角色卡片即可分配

### Worker节点账号标识

- **标签**：显示"Worker节点"Badge
- **背景色**：略深的背景色，便于区分
- **节点信息**：显示节点ID（`node_id`）

## 注意事项

### ⚠️ 重要提醒

1. **Worker节点账号去重**
   - 系统会自动检查Worker节点账号是否已在数据库中
   - 如果已在数据库中，不会重复显示
   - 如果不在数据库中，会显示为Worker节点账号

2. **角色分配前提**
   - 账号必须先分配剧本，才能分配角色
   - 如果账号没有剧本，角色分配按钮会被禁用

3. **角色缓存**
   - 角色列表会被缓存，避免重复请求
   - 如果剧本更新，需要刷新页面以重新加载角色

4. **Worker节点账号创建**
   - Worker节点账号需要先创建为数据库账号，才能进行完整管理
   - 点击"+"按钮可以将Worker节点账号添加到数据库

5. **角色分配持久化**
   - 角色分配会保存到数据库
   - 刷新页面后，角色分配信息会保留

## 后续优化建议

1. **自动同步Worker账号**
   - 可以添加自动同步功能，将Worker节点账号自动创建为数据库账号

2. **角色分配方案**
   - 可以保存常用的角色分配方案，快速应用到多个账号

3. **批量角色分配**
   - 可以批量选择账号和角色，一次性完成分配

4. **角色统计**
   - 显示每个角色的分配情况统计

5. **角色冲突检测**
   - 检测是否有多个账号分配了同一个角色（如果剧本要求唯一角色）

## 总结

本次更新实现了：
- ✅ 从所有节点读取账号
- ✅ 合并显示数据库账号和Worker节点账号
- ✅ 角色分配功能集成到账号管理
- ✅ 选择剧本时自动加载角色列表
- ✅ 支持自动和手动角色分配
- ✅ 角色信息实时显示

所有功能已集成到账号管理页面，用户可以在一个页面完成所有操作，无需跳转到其他页面。

