# 创建剧本 HTTP 500 错误修复报告

## 问题总结

**问题现象：** 前端在创建剧本时，`POST /api/v1/group-ai/scripts` 接口返回 HTTP 500 Internal Server Error。

**根本原因：**

1. **返回值类型不一致** ⚠️ **主要原因**
   - `enhanced_converter.convert_with_enhanced_detection()` 的类型声明为 `Dict[str, Any]`，但实际返回 `(converted_data, warnings)` 元组
   - `normalize_script_yaml` 函数中直接解包：`converted_data, warnings = ...`，如果返回格式不一致会导致 `ValueError: too many values to unpack`
   - 同样的问题也存在于 `validate_and_fix()` 的返回值处理

2. **错误分类不当**
   - 格式/结构错误（可预期的）应该返回 HTTP 400，而不是 500
   - 只有完全意外的内部错误才应该返回 500

## 修复方案

### 1. 修复返回值兼容处理

**文件：** `admin-backend/app/api/group_ai/scripts.py`

**修改位置：** `normalize_script_yaml` 函数

**修改内容：**

#### 1.1 `convert_with_enhanced_detection` 返回值处理

```python
# 修改前：
converted_data, warnings = enhanced_converter.convert_with_enhanced_detection(...)

# 修改后：
result = enhanced_converter.convert_with_enhanced_detection(...)

# 兼容处理返回值：可能是元组或字典
if isinstance(result, tuple) and len(result) == 2:
    converted_data, warnings = result
elif isinstance(result, dict):
    converted_data = result
    warnings = []
else:
    raise ValueError(f"convert_with_enhanced_detection 返回了意外的类型: {type(result)}")
```

#### 1.2 `validate_and_fix` 返回值处理

```python
# 修改前：
validated_data, validation_warnings = enhanced_converter.validate_and_fix(converted_data)

# 修改后：
validation_result = enhanced_converter.validate_and_fix(converted_data)

# 兼容处理返回值：可能是元组或字典
if isinstance(validation_result, tuple) and len(validation_result) == 2:
    validated_data, validation_warnings = validation_result
elif isinstance(validation_result, dict):
    validated_data = validation_result
    validation_warnings = []
else:
    raise ValueError(f"validate_and_fix 返回了意外的类型: {type(validation_result)}")
```

#### 1.3 异常处理优化

```python
# 修改前：所有异常都返回 500
except Exception as e:
    raise HTTPException(status_code=500, ...)

# 修改后：区分可预期的格式错误和内部错误
except ValueError as e:
    # 可预期的格式/结构错误，返回 400
    raise HTTPException(status_code=400, ...)
except Exception as e:
    # 完全意外的内部错误，返回 500
    raise HTTPException(status_code=500, ...)
```

### 2. 修复类型声明

**文件：** `group_ai_service/enhanced_format_converter.py`

**修改内容：**

#### 2.1 `convert_with_enhanced_detection` 类型声明

```python
# 修改前：
def convert_with_enhanced_detection(...) -> Dict[str, Any]:

# 修改后：
def convert_with_enhanced_detection(...) -> Tuple[Dict[str, Any], List[str]]:
```

#### 2.2 添加 Tuple 导入

```python
# 修改前：
from typing import Dict, Any, Optional, List

# 修改后：
from typing import Dict, Any, Optional, List, Tuple
```

## 测试验证

### 1. 单元测试

**文件：** `admin-backend/tests/api/group_ai/test_normalize_script_yaml.py`

**测试用例：**

1. ✅ **旧格式 YAML 测试**（包含 `roles`）
   - 验证能正确转换为新格式
   - 验证不会抛出 500 错误

2. ✅ **新格式 YAML 测试**（包含 `scenes`，用于 000新人欢迎剧本）
   - 验证能直接通过规范化
   - 验证包含必要的字段

3. ✅ **无效格式 YAML 测试**
   - 验证返回 400 而不是 500
   - 验证错误信息清晰

### 2. 接口测试

**测试样本：** 000新人欢迎剧本

```yaml
script_id: 000新人欢迎剧本
version: "1.0"
description: 000新人欢迎剧本
scenes:
  - id: scene1
    triggers:
      - type: message
    responses:
      - template: 欢迎新人
        speaker: si
```

**测试结果：**

- ✅ `POST /api/v1/group-ai/scripts` 返回 201 Created
- ✅ 响应包含正确的 `script_id`、`name`、`scene_count`
- ✅ 不再出现 HTTP 500 错误

### 3. 前端测试

- ✅ 通过前端页面创建"000新人欢迎剧本"成功
- ✅ 如果格式错误，前端显示后端返回的 400 错误信息，而不是"HTTP 500"

## 修改文件清单

1. `admin-backend/app/api/group_ai/scripts.py`
   - 修改 `normalize_script_yaml` 函数的返回值处理逻辑
   - 优化异常处理，区分 400 和 500 错误

2. `group_ai_service/enhanced_format_converter.py`
   - 修改 `convert_with_enhanced_detection` 的类型声明
   - 添加 `Tuple` 类型导入

3. `admin-backend/tests/api/group_ai/test_normalize_script_yaml.py`（新增）
   - 添加单元测试验证修复效果

## 修复效果

### 修复前
- ❌ 创建剧本时返回 HTTP 500
- ❌ 错误信息不清晰
- ❌ 无法区分格式错误和内部错误

### 修复后
- ✅ 创建剧本成功返回 201
- ✅ 格式错误返回 400，错误信息清晰
- ✅ 只有真正的内部错误才返回 500
- ✅ 兼容处理返回值类型，避免解包失败

## 后续建议

1. **统一返回值规范**
   - 建议所有转换/验证函数统一返回格式（元组或字典）
   - 确保类型声明与实际返回值一致

2. **增强错误处理**
   - 继续优化错误分类逻辑
   - 提供更详细的错误提示

3. **完善测试覆盖**
   - 增加更多边界情况测试
   - 覆盖各种 YAML 格式转换场景

## 测试截图/说明

**测试时间：** 2025-01-20

**测试环境：**
- 后端：FastAPI (uvicorn)
- 前端：Next.js
- Python 版本：3.13.9

**测试结果：**
- ✅ 单元测试全部通过
- ✅ 接口测试返回 201
- ✅ 前端创建剧本成功

**验证样本：**
- 旧格式 YAML（包含 `roles`）✅
- 新格式 YAML（包含 `scenes`，000新人欢迎剧本）✅
- 无效格式 YAML（返回 400）✅

**修复的关键问题：**
1. `convert_with_enhanced_detection` 返回值类型不匹配（类型声明为 `Dict`，实际返回 `Tuple`）
2. `validate_and_fix` 返回值处理缺少兼容性检查
3. `format_converter.convert` 方法不存在，应使用 `convert_old_format_to_new`
4. 异常处理未区分可预期的格式错误（400）和内部错误（500）

**修改的文件：**
1. `admin-backend/app/api/group_ai/scripts.py` - normalize_script_yaml 函数
2. `group_ai_service/enhanced_format_converter.py` - convert_with_enhanced_detection 类型声明
3. `admin-backend/tests/api/group_ai/test_normalize_script_yaml.py` - 新增单元测试

