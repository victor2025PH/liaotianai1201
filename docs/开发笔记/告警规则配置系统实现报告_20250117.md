# å‘Šè­¦è§„åˆ™é…ç½®ç³»ç»Ÿå®ç°æŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2025-01-17  
> **å®ç°çŠ¶æ€**: âœ… åŸºç¡€åŠŸèƒ½å·²å®Œæˆ  
> **æŠ¥å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ“Š å®Œæˆæ¦‚è¿°

### å®ç°çš„åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å‘Šè­¦è§„åˆ™æ•°æ®æ¨¡å‹ | âœ… å®Œæˆ | `GroupAIAlertRule` æ¨¡å‹ |
| å‘Šè­¦è§„åˆ™ Schema | âœ… å®Œæˆ | Pydantic Schema |
| å‘Šè­¦è§„åˆ™ CRUD API | âœ… å®Œæˆ | å®Œæ•´çš„ REST API |
| æ•°æ®åº“è¿ç§» | âœ… å®Œæˆ | Alembic è¿ç§»è„šæœ¬ |
| API è·¯ç”±æ³¨å†Œ | âœ… å®Œæˆ | å·²æ³¨å†Œåˆ°è·¯ç”± |

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å‘Šè­¦è§„åˆ™æ•°æ®æ¨¡å‹

**æ–‡ä»¶**: `admin-backend/app/models/group_ai.py`

**æ¨¡å‹**: `GroupAIAlertRule`

**å­—æ®µ**:
- `id`: UUIDï¼Œä¸»é”®
- `name`: è§„åˆ™åç§°ï¼ˆå”¯ä¸€ï¼‰
- `rule_type`: è§„åˆ™ç±»å‹ï¼ˆerror_rate, response_time, system_errors, account_offline ç­‰ï¼‰
- `alert_level`: å‘Šè­¦çº§åˆ«ï¼ˆerror, warning, infoï¼‰
- `threshold_value`: é˜ˆå€¼
- `threshold_operator`: æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆ>, >=, <, <=, ==, !=ï¼‰
- `enabled`: æ˜¯å¦å¯ç”¨
- `notification_method`: é€šçŸ¥æ–¹å¼ï¼ˆemail, webhook, telegramï¼‰
- `notification_target`: é€šçŸ¥ç›®æ ‡
- `rule_conditions`: è§„åˆ™æ¡ä»¶ï¼ˆJSON æ ¼å¼ï¼Œæ”¯æŒå¤æ‚æ¡ä»¶ï¼‰
- `description`: è§„åˆ™æè¿°
- `created_by`: åˆ›å»ºè€…
- `created_at`: åˆ›å»ºæ—¶é—´
- `updated_at`: æ›´æ–°æ—¶é—´

**ç´¢å¼•**:
- `name` å”¯ä¸€ç´¢å¼•
- `rule_type` ç´¢å¼•
- `enabled` ç´¢å¼•

---

### 2. å‘Šè­¦è§„åˆ™ Schema

**æ–‡ä»¶**: `admin-backend/app/schemas/alert_rule.py`

**Schema**:
- `AlertRuleBase`: åŸºç¡€ Schema
- `AlertRuleCreate`: åˆ›å»ºå‘Šè­¦è§„åˆ™ Schema
- `AlertRuleUpdate`: æ›´æ–°å‘Šè­¦è§„åˆ™ Schema
- `AlertRule`: å‘Šè­¦è§„åˆ™ Schemaï¼ˆè¿”å›ï¼‰
- `AlertRuleList`: å‘Šè­¦è§„åˆ™åˆ—è¡¨ Schema

---

### 3. å‘Šè­¦è§„åˆ™ CRUD API

**æ–‡ä»¶**: `admin-backend/app/crud/alert_rule.py`

**å‡½æ•°**:
- `create_alert_rule()`: åˆ›å»ºå‘Šè­¦è§„åˆ™
- `get_alert_rule()`: æ ¹æ® ID è·å–è§„åˆ™
- `get_alert_rule_by_name()`: æ ¹æ®åç§°è·å–è§„åˆ™
- `list_alert_rules()`: åˆ—å‡ºè§„åˆ™ï¼ˆæ”¯æŒåˆ†é¡µå’Œç­›é€‰ï¼‰
- `get_enabled_alert_rules()`: è·å–æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
- `update_alert_rule()`: æ›´æ–°è§„åˆ™
- `delete_alert_rule()`: åˆ é™¤è§„åˆ™

---

### 4. å‘Šè­¦è§„åˆ™ REST API

**æ–‡ä»¶**: `admin-backend/app/api/group_ai/alert_rules.py`

**ç«¯ç‚¹**:
- `POST /api/v1/group-ai/alert-rules/` - åˆ›å»ºå‘Šè­¦è§„åˆ™
- `GET /api/v1/group-ai/alert-rules/` - åˆ—å‡ºå‘Šè­¦è§„åˆ™ï¼ˆæ”¯æŒåˆ†é¡µã€ç­›é€‰ï¼‰
- `GET /api/v1/group-ai/alert-rules/{rule_id}` - è·å–å‘Šè­¦è§„åˆ™è¯¦æƒ…
- `PUT /api/v1/group-ai/alert-rules/{rule_id}` - æ›´æ–°å‘Šè­¦è§„åˆ™
- `DELETE /api/v1/group-ai/alert-rules/{rule_id}` - åˆ é™¤å‘Šè­¦è§„åˆ™
- `POST /api/v1/group-ai/alert-rules/{rule_id}/enable` - å¯ç”¨å‘Šè­¦è§„åˆ™
- `POST /api/v1/group-ai/alert-rules/{rule_id}/disable` - ç¦ç”¨å‘Šè­¦è§„åˆ™

**è®¤è¯**: æ‰€æœ‰ç«¯ç‚¹éƒ½éœ€è¦è®¤è¯ï¼ˆä½¿ç”¨ `get_current_active_user`ï¼‰

---

### 5. æ•°æ®åº“è¿ç§»

**æ–‡ä»¶**: `admin-backend/alembic/versions/fc673460c426_add_alert_rules_table.py`

**è¿ç§»å†…å®¹**:
- åˆ›å»º `group_ai_alert_rules` è¡¨
- åˆ›å»ºç›¸å…³ç´¢å¼•
- æ”¯æŒå›æ»šï¼ˆdowngradeï¼‰

**è¿è¡Œè¿ç§»**:
```bash
cd admin-backend
poetry run alembic upgrade head
```

---

### 6. API è·¯ç”±æ³¨å†Œ

**æ–‡ä»¶**: `admin-backend/app/api/group_ai/__init__.py`

**è·¯ç”±å‰ç¼€**: `/api/v1/group-ai/alert-rules`

**æ ‡ç­¾**: `alert-rules`

---

## ğŸ“‹ API ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºå‘Šè­¦è§„åˆ™

```bash
POST /api/v1/group-ai/alert-rules/
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "è´¦å·é”™è¯¯ç‡å‘Šè­¦",
  "rule_type": "error_rate",
  "alert_level": "warning",
  "threshold_value": 0.2,
  "threshold_operator": ">",
  "enabled": true,
  "notification_method": "email",
  "notification_target": "admin@example.com",
  "description": "å½“è´¦å·é”™è¯¯ç‡è¶…è¿‡ 20% æ—¶å‘é€å‘Šè­¦"
}
```

### åˆ—å‡ºå‘Šè­¦è§„åˆ™

```bash
GET /api/v1/group-ai/alert-rules/?page=1&page_size=20&enabled=true&rule_type=error_rate
Authorization: Bearer <token>
```

### æ›´æ–°å‘Šè­¦è§„åˆ™

```bash
PUT /api/v1/group-ai/alert-rules/{rule_id}
Content-Type: application/json
Authorization: Bearer <token>

{
  "threshold_value": 0.3,
  "enabled": false
}
```

### å¯ç”¨/ç¦ç”¨å‘Šè­¦è§„åˆ™

```bash
POST /api/v1/group-ai/alert-rules/{rule_id}/enable
Authorization: Bearer <token>

POST /api/v1/group-ai/alert-rules/{rule_id}/disable
Authorization: Bearer <token>
```

---

## âš ï¸ å¾…å®Œæˆçš„å·¥ä½œ

### 1. é›†æˆå‘Šè­¦è§„åˆ™åˆ°è§¦å‘é€»è¾‘

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

**ä»»åŠ¡**:
- ä¿®æ”¹ `group_ai_service/monitor_service.py` çš„ `check_alerts()` æ–¹æ³•
- ä»æ•°æ®åº“è¯»å–å¯ç”¨çš„å‘Šè­¦è§„åˆ™
- æ ¹æ®è§„åˆ™è¿›è¡Œå‘Šè­¦æ£€æŸ¥
- æ›¿æ¢ç¡¬ç¼–ç çš„é˜ˆå€¼ï¼ˆ0.5, 0.2, 100 ç­‰ï¼‰

**å½“å‰çŠ¶æ€**: 
- ç›‘æ§æœåŠ¡ä½¿ç”¨ç¡¬ç¼–ç é˜ˆå€¼
- éœ€è¦æ”¹ä¸ºä»æ•°æ®åº“è¯»å–è§„åˆ™

**é¢„è®¡å·¥ä½œé‡**: 2-3 å°æ—¶

---

### 2. å‘Šè­¦è§„åˆ™è§¦å‘é€»è¾‘å®ç°

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

**ä»»åŠ¡**:
- å®ç°è§„åˆ™æ¡ä»¶è¯„ä¼°
- æ”¯æŒä¸åŒçš„è§„åˆ™ç±»å‹ï¼ˆerror_rate, response_time, system_errors ç­‰ï¼‰
- å®ç°é€šçŸ¥å‘é€ï¼ˆemail, webhook, telegramï¼‰

**é¢„è®¡å·¥ä½œé‡**: 3-5 å°æ—¶

---

### 3. å‰ç«¯å‘Šè­¦è§„åˆ™é…ç½®ç•Œé¢

**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½

**ä»»åŠ¡**:
- åˆ›å»ºå‘Šè­¦è§„åˆ™ç®¡ç†é¡µé¢
- æ”¯æŒåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è§„åˆ™
- æ”¯æŒå¯ç”¨/ç¦ç”¨è§„åˆ™
- è§„åˆ™åˆ—è¡¨å±•ç¤º

**é¢„è®¡å·¥ä½œé‡**: 1-2 å¤©

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

1. `admin-backend/app/models/group_ai.py` - æ·»åŠ  `GroupAIAlertRule` æ¨¡å‹
2. `admin-backend/app/schemas/alert_rule.py` - å‘Šè­¦è§„åˆ™ Schema
3. `admin-backend/app/crud/alert_rule.py` - å‘Šè­¦è§„åˆ™ CRUD æ“ä½œ
4. `admin-backend/app/api/group_ai/alert_rules.py` - å‘Šè­¦è§„åˆ™ API
5. `admin-backend/alembic/versions/fc673460c426_add_alert_rules_table.py` - æ•°æ®åº“è¿ç§»

### ä¿®æ”¹æ–‡ä»¶

1. `admin-backend/app/api/group_ai/__init__.py` - æ³¨å†Œå‘Šè­¦è§„åˆ™è·¯ç”±
2. `admin-backend/app/schemas/__init__.py` - å¯¼å‡ºå‘Šè­¦è§„åˆ™ Schema

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   cd admin-backend
   poetry run alembic upgrade head
   ```

2. **æµ‹è¯• API**
   - ä½¿ç”¨ Postman æˆ– curl æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹
   - éªŒè¯åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤åŠŸèƒ½

### çŸ­æœŸï¼ˆ1-2 å¤©ï¼‰

3. **é›†æˆå‘Šè­¦è§„åˆ™åˆ°è§¦å‘é€»è¾‘**
   - ä¿®æ”¹ `monitor_service.py`
   - å®ç°è§„åˆ™è¯„ä¼°é€»è¾‘

4. **å®ç°é€šçŸ¥å‘é€**
   - Email é€šçŸ¥
   - Webhook é€šçŸ¥
   - Telegram é€šçŸ¥

### ä¸­æœŸï¼ˆ1 å‘¨ï¼‰

5. **å‰ç«¯ç•Œé¢å¼€å‘**
   - å‘Šè­¦è§„åˆ™ç®¡ç†é¡µé¢
   - è§„åˆ™é…ç½®è¡¨å•

---

## âœ… æˆåŠŸè¦ç‚¹

1. **å®Œæ•´çš„æ•°æ®æ¨¡å‹**
   - æ”¯æŒçµæ´»çš„è§„åˆ™é…ç½®
   - æ”¯æŒå¤šç§è§„åˆ™ç±»å‹
   - æ”¯æŒå¤æ‚çš„è§„åˆ™æ¡ä»¶ï¼ˆJSONï¼‰

2. **å®Œæ•´çš„ CRUD API**
   - æ ‡å‡†çš„ REST API
   - æ”¯æŒåˆ†é¡µå’Œç­›é€‰
   - æ”¯æŒå¯ç”¨/ç¦ç”¨

3. **æ•°æ®åº“è¿ç§»**
   - å®Œæ•´çš„è¿ç§»è„šæœ¬
   - æ”¯æŒå›æ»š

---

## ğŸ“Š æµ‹è¯•å»ºè®®

### API æµ‹è¯•

```bash
# åˆ›å»ºè§„åˆ™
curl -X POST http://localhost:8000/api/v1/group-ai/alert-rules/ \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•è§„åˆ™",
    "rule_type": "error_rate",
    "threshold_value": 0.2
  }'

# åˆ—å‡ºè§„åˆ™
curl http://localhost:8000/api/v1/group-ai/alert-rules/ \
  -H "Authorization: Bearer <token>"
```

### æ•°æ®åº“æµ‹è¯•

```bash
# æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»º
sqlite3 admin.db ".schema group_ai_alert_rules"

# æ£€æŸ¥ç´¢å¼•
sqlite3 admin.db ".indexes group_ai_alert_rules"
```

---

**æŠ¥å‘Šç”Ÿæˆå®Œæˆæ—¶é—´**: 2025-01-17  
**å½“å‰çŠ¶æ€**: ğŸŸ¢ å‘Šè­¦è§„åˆ™é…ç½®ç³»ç»ŸåŸºç¡€åŠŸèƒ½å·²å®Œæˆï¼Œç­‰å¾…é›†æˆåˆ°è§¦å‘é€»è¾‘

