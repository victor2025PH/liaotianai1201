# 分配剧本修复 - 下一步测试指南

## 修复完成状态

### ✅ 已完成的修复

1. **后端API修复** (`admin-backend/app/api/group_ai/accounts.py`)
   - ✅ 添加 `session_file` 字段到 `AccountUpdateRequest`
   - ✅ 增强 `update_account` 函数，支持从远程服务器扫描并创建账号记录
   - ✅ 支持账号在数据库中但不在AccountManager中的情况

2. **前端代码修复** (`saas-demo/src/app/group-ai/accounts/page.tsx`)
   - ✅ 在分配剧本时传递 `server_id`

3. **服务状态**
   - ✅ 后端服务已重启
   - ✅ 前端服务已重启
   - ✅ 网站可正常访问

## 测试步骤

### 1. 测试分配剧本功能

1. **打开账号管理页面**
   - 访问：http://aikz.usdt2026.cc/group-ai/accounts

2. **选择一个Worker节点账号**
   - 在账号列表中找到显示 "Worker节点" 标签的账号
   - 这些账号通常不在数据库中，但显示在列表中

3. **点击"分配剧本"按钮**
   - 应该弹出"分配剧本"对话框
   - 对话框中显示账号信息（账号ID、名称、节点等）

4. **选择剧本和角色**
   - 选择一个剧本
   - （可选）选择一个角色

5. **点击"分配剧本"按钮**
   - 系统应该：
     - 自动从远程服务器扫描账号
     - 创建数据库记录
     - 分配剧本ID
     - 如果选择了角色，同时分配角色
   - 显示成功消息

### 2. 验证结果

1. **检查账号是否在数据库中出现**
   - 刷新页面后，该账号应该出现在数据库账号列表中（不再显示 "Worker节点" 标签）

2. **检查剧本分配**
   - 账号的"关联剧本"字段应该显示分配的剧本ID

3. **检查角色分配**（如果选择了角色）
   - 账号应该已分配对应的角色

## 如果遇到问题

### 问题1：仍然显示"賬號不存在"

**可能原因**：
- 修复代码未正确部署到服务器
- `server_id` 未正确传递
- 远程服务器无法访问或账号不在服务器上

**解决方法**：
1. 检查后端日志：`tail -50 /tmp/backend_with_fix.log`
2. 检查账号是否在远程服务器上运行
3. 验证 `server_id` 是否正确

### 问题2：账号创建成功但剧本未分配

**可能原因**：
- 数据库更新失败
- 缓存未清除

**解决方法**：
1. 刷新页面
2. 检查数据库记录：账号的 `script_id` 字段

### 问题3：角色分配失败

**可能原因**：
- 剧本ID不正确
- 角色ID不存在于剧本中

**解决方法**：
1. 先只分配剧本，不分配角色
2. 剧本分配成功后，再单独分配角色

## 成功标准

✅ 分配剧本时不再显示"賬號不存在"错误  
✅ 账号自动创建到数据库  
✅ 剧本ID正确分配  
✅ 角色正确分配（如果选择了角色）  
✅ 账号在列表中正常显示，不再显示 "Worker节点" 标签

## 后续优化

1. **自动同步机制**：定期自动同步Worker节点账号到数据库
2. **批量分配**：支持批量为多个账号分配剧本
3. **验证机制**：分配前验证账号和剧本的有效性

---

**修复已完成，可以进行测试！**
