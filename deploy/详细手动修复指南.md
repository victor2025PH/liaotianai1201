# 详细手动修复指南

## 概述

本指南将详细说明如何手动修复前端服务启动失败的问题。按照步骤逐一执行，确保每个步骤都成功后再进行下一步。

---

## 第一步：登录服务器

### 方法1：使用SSH密钥（推荐）

```bash
ssh ubuntu@165.154.233.55
```

如果提示输入密码，说明SSH密钥未配置，请使用密码登录。

### 方法2：使用密码登录

```bash
ssh ubuntu@165.154.233.55
# 输入密码
```

---

## 第二步：检查当前状态

### 2.1 检查服务状态

```bash
sudo systemctl status liaotian-frontend
```

**预期结果**：
- 如果显示 `active (running)` - 服务正常运行，无需修复
- 如果显示 `activating (auto-restart)` 或 `failed` - 需要修复

### 2.2 查看服务日志

```bash
sudo journalctl -u liaotian-frontend -n 50 --no-pager
```

**查看关键信息**：
- 查找 `error`、`failed`、`exit code` 等关键词
- 记录错误信息，用于后续修复

### 2.3 检查构建目录

```bash
cd /home/ubuntu/liaotian/saas-demo
ls -la .next
```

**预期结果**：
- 如果 `.next` 目录存在且有内容 - 构建已完成
- 如果 `.next` 目录不存在或为空 - 需要重新构建

### 2.4 检查构建ID

```bash
test -f .next/BUILD_ID && echo "构建成功" || echo "构建失败"
```

---

## 第三步：停止服务

```bash
sudo systemctl stop liaotian-frontend
```

**验证**：
```bash
sudo systemctl status liaotian-frontend
```

应该显示 `inactive (dead)` 或 `stopped`。

---

## 第四步：检查代码文件

### 4.1 检查账号管理页面文件

```bash
cd /home/ubuntu/liaotian/saas-demo
ls -lh src/app/group-ai/accounts/page.tsx
```

**验证文件存在**：
- 如果文件不存在，需要上传文件
- 如果文件存在，检查文件大小和修改时间

### 4.2 检查语法错误（重复代码）

```bash
grep -n "workerAccounts.map" src/app/group-ai/accounts/page.tsx
```

**预期结果**：
- 应该只出现 **1次**（在第1777行左右）
- 如果出现多次，说明有重复代码，需要修复

### 4.3 检查文件完整性

```bash
# 检查文件末尾是否正确闭合
tail -20 src/app/group-ai/accounts/page.tsx
```

**预期结果**：
- 文件应该以 `}` 和 `)` 正确闭合
- 不应该有未闭合的括号或标签

---

## 第五步：修复代码问题（如果需要）

### 5.1 如果发现重复代码

使用文本编辑器打开文件：

```bash
nano src/app/group-ai/accounts/page.tsx
```

或者使用vi：

```bash
vi src/app/group-ai/accounts/page.tsx
```

**查找重复代码**：
1. 按 `Ctrl+W`（nano）或 `/`（vi）搜索 `workerAccounts.map`
2. 应该只找到一处（大约在第1777行）
3. 如果找到多处，删除重复的部分

**正确的代码结构应该是**：
```typescript
<TableBody>
  {/* 数据库账号 */}
  {accounts.map((account) => (
    <TableRow key={account.account_id}>
      {/* ... 账号数据 ... */}
    </TableRow>
  ))}
  
  {/* Worker节点账号 */}
  {workerAccounts.map((account) => (
    <TableRow key={`worker-${account.account_id}-${account.node_id}`}>
      {/* ... Worker账号数据 ... */}
    </TableRow>
  ))}
</TableBody>
```

**保存文件**：
- nano: `Ctrl+O` 保存，`Ctrl+X` 退出
- vi: 按 `Esc`，输入 `:wq` 保存并退出

### 5.2 如果文件不存在或需要上传

**从本地上传文件**（在本地PowerShell中执行）：

```powershell
scp saas-demo/src/app/group-ai/accounts/page.tsx ubuntu@165.154.233.55:/home/ubuntu/liaotian/saas-demo/src/app/group-ai/accounts/page.tsx
scp saas-demo/src/lib/api/group-ai.ts ubuntu@165.154.233.55:/home/ubuntu/liaotian/saas-demo/src/lib/api/group-ai.ts
```

---

## 第六步：准备构建环境

### 6.1 加载Node.js环境

```bash
# 加载nvm
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

# 使用Node.js 20
nvm use 20

# 验证版本
node --version
npm --version
```

**预期结果**：
- `node --version` 应该显示 `v20.x.x`
- `npm --version` 应该显示 `10.x.x`

### 6.2 清理旧构建

```bash
cd /home/ubuntu/liaotian/saas-demo
rm -rf .next
rm -rf node_modules/.cache
```

**验证**：
```bash
ls -la .next 2>/dev/null || echo "构建目录已清理"
```

---

## 第七步：重新构建

### 7.1 执行构建

```bash
cd /home/ubuntu/liaotian/saas-demo
npm run build
```

**构建过程**：
- 这可能需要 **3-10分钟**，请耐心等待
- 会显示构建进度和警告信息
- 如果有错误，会显示详细的错误信息

### 7.2 检查构建结果

**方法1：检查构建ID**
```bash
test -f .next/BUILD_ID && echo "构建成功" || echo "构建失败"
```

**方法2：检查构建目录**
```bash
ls -la .next
```

**预期结果**：
- `.next` 目录应该存在
- `.next/BUILD_ID` 文件应该存在
- `.next/static` 目录应该存在且有内容

### 7.3 如果构建失败

**查看详细错误**：
```bash
npm run build 2>&1 | grep -i error | head -20
```

**常见错误及解决方法**：

1. **TypeScript语法错误**
   ```
   Error: Type error: ...
   ```
   - 检查代码语法
   - 修复TypeScript类型错误

2. **缺少依赖**
   ```
   Module not found: Can't resolve ...
   ```
   - 运行 `npm install` 安装依赖

3. **内存不足**
   ```
   JavaScript heap out of memory
   ```
   - 增加Node.js内存限制：`NODE_OPTIONS=--max_old_space_size=4096 npm run build`

---

## 第八步：配置服务

### 8.1 检查服务配置文件

```bash
cat /etc/systemd/system/liaotian-frontend.service
```

**预期配置应该类似**：
```ini
[Unit]
Description=Liaotian Frontend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="NODE_ENV=production"
Environment="PORT=3000"
ExecStart=/usr/bin/npm start
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 8.2 如果配置不正确，修改配置

```bash
sudo nano /etc/systemd/system/liaotian-frontend.service
```

**关键配置项**：
- `WorkingDirectory`: 应该是 `/home/ubuntu/liaotian/saas-demo`
- `ExecStart`: 应该是 `/usr/bin/npm start` 或使用nvm的完整路径
- `User`: 应该是 `ubuntu`

**如果使用nvm，ExecStart应该改为**：
```ini
ExecStart=/bin/bash -c "source $HOME/.nvm/nvm.sh && nvm use 20 && npm start"
```

**保存并退出**：
- nano: `Ctrl+O` 保存，`Ctrl+X` 退出

### 8.3 重新加载systemd配置

```bash
sudo systemctl daemon-reload
```

---

## 第九步：启动服务

### 9.1 启动服务

```bash
sudo systemctl start liaotian-frontend
```

### 9.2 等待几秒钟

```bash
sleep 5
```

### 9.3 检查服务状态

```bash
sudo systemctl status liaotian-frontend
```

**预期结果**：
- 状态应该显示 `active (running)`
- 不应该有错误信息

### 9.4 如果服务启动失败

**查看详细日志**：
```bash
sudo journalctl -u liaotian-frontend -n 50 --no-pager
```

**常见问题**：

1. **构建目录不存在**
   - 确保 `.next` 目录存在
   - 重新执行构建步骤

2. **端口被占用**
   ```bash
   sudo lsof -i :3000
   ```
   - 如果端口被占用，停止占用端口的进程

3. **权限问题**
   ```bash
   sudo chown -R ubuntu:ubuntu /home/ubuntu/liaotian/saas-demo
   ```

---

## 第十步：验证服务

### 10.1 检查端口监听

```bash
sudo netstat -tlnp | grep ':3000'
```

或者：

```bash
sudo ss -tlnp | grep ':3000'
```

**预期结果**：
- 应该显示端口3000正在监听
- 进程应该是 `node` 或 `npm`

### 10.2 测试本地访问

```bash
curl http://localhost:3000
```

**预期结果**：
- 应该返回HTML内容（不是502错误）
- 如果返回502，检查Nginx配置

### 10.3 检查Nginx配置

```bash
sudo nginx -t
```

**验证Nginx配置**：
```bash
sudo cat /etc/nginx/sites-available/default | grep -A 10 "location /"
```

**预期配置**：
```nginx
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

### 10.4 重启Nginx（如果需要）

```bash
sudo systemctl restart nginx
sudo systemctl status nginx
```

---

## 第十一步：验证浏览器访问

### 11.1 清除浏览器缓存

1. 按 `Ctrl+Shift+Delete` 打开清除数据对话框
2. 选择"缓存的图片和文件"
3. 点击"清除数据"

### 11.2 强制刷新页面

1. 按 `Ctrl+F5` 强制刷新
2. 或按 `F12` 打开开发者工具，右键刷新按钮选择"清空缓存并硬性重新加载"

### 11.3 访问网站

访问：`http://aikz.usdt2026.cc`

**预期结果**：
- 应该正常显示页面（不是502错误）
- 可以正常访问账号管理页面

---

## 故障排查清单

如果仍然有问题，请检查：

- [ ] 服务状态是否为 `active (running)`
- [ ] 端口3000是否正在监听
- [ ] 构建是否成功（`.next/BUILD_ID` 存在）
- [ ] 代码文件是否正确（无语法错误）
- [ ] Nginx配置是否正确
- [ ] Nginx服务是否运行
- [ ] 防火墙是否允许端口3000
- [ ] 浏览器缓存是否已清除

---

## 快速命令参考

```bash
# 完整修复流程（一键执行）
cd /home/ubuntu/liaotian/saas-demo && \
sudo systemctl stop liaotian-frontend && \
export NVM_DIR="$HOME/.nvm" && \
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && \
nvm use 20 && \
rm -rf .next node_modules/.cache && \
npm run build && \
test -f .next/BUILD_ID && echo "构建成功" || echo "构建失败" && \
sudo systemctl daemon-reload && \
sudo systemctl start liaotian-frontend && \
sleep 5 && \
sudo systemctl status liaotian-frontend --no-pager | head -20
```

---

## 联系支持

如果按照以上步骤仍然无法解决问题，请：

1. 收集错误信息：
   ```bash
   sudo journalctl -u liaotian-frontend -n 100 --no-pager > /tmp/frontend-errors.log
   ```

2. 检查构建日志：
   ```bash
   cd /home/ubuntu/liaotian/saas-demo && npm run build 2>&1 | tee /tmp/build.log
   ```

3. 提供以下信息：
   - 服务状态输出
   - 构建错误日志
   - 服务日志

