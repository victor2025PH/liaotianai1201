# 🧧 自動紅包群組互動使用指南

## 功能概述

本系統支持 AI 帳號自動：
- ✅ **自動建群** - 一個帳號創建群組，其他帳號自動加入
- ✅ 監聽群消息
- ✅ 自動搶紅包（檢測到紅包鏈接後自動領取）
- ✅ 自動發紅包（按設定間隔發送）
- ✅ 自動聊天互動（隨機發送預設消息）
- ✅ 加入指定群組

## ⚠️ 重要：API 憑證要求

**每個帳號必須使用獨立的 API_ID 和 API_HASH！**

不允許多個帳號共用同一套 API 憑證，這是為了：
1. 避免 Telegram 封號風險
2. 確保每個帳號獨立運行
3. 符合 Telegram 服務條款

如何獲取獨立的 API 憑證：
1. 用每個帳號登入 https://my.telegram.org
2. 創建新的應用（Application）
3. 獲取該帳號專屬的 api_id 和 api_hash

---

## 快速開始

### 1. 準備文件

確保 `sessions` 目錄包含：
- `.session` 文件（Telegram 登入憑證）
- `accounts.xlsx` 文件（帳號配置，**每個帳號必須有獨立的 API 憑證**）

### 2. 配置環境變量

創建 `.env` 文件或設置環境變量：

```bash
# 紅包 API 配置
REDPACKET_API_URL=http://api.usdt2026.cc
REDPACKET_API_KEY=test-key-2024

# Sessions 目錄
SESSIONS_DIR=./sessions

# 自動建群設置
AUTO_CREATE_GROUP=true    # 啟動時自動建群
GROUP_NAME=               # 群組名稱，空則自動生成

# 目標群組（如果不自動建群）
TARGET_GROUP=https://t.me/+邀請碼

# 自動化設置
AUTO_GRAB=true      # 自動搶紅包
AUTO_SEND=false     # 自動發紅包
AUTO_CHAT=true      # 自動聊天

# 搶紅包延遲（秒）
GRAB_DELAY_MIN=1
GRAB_DELAY_MAX=5

# 發紅包間隔（秒）
SEND_INTERVAL=300

# 發紅包金額範圍
SEND_AMOUNT_MIN=1
SEND_AMOUNT_MAX=5
```

### 3. 安裝依賴

```bash
pip install telethon httpx openpyxl
```

### 4. 啟動

```bash
python start_auto_redpacket.py
```

---

## Excel 配置格式

| 欄位 | 必需 | 說明 |
|------|------|------|
| phone | ✅ 必需 | 電話號碼，用於匹配 session 文件 |
| api_id | ✅ 必需 | Telegram API ID（**每個帳號必須獨立**） |
| api_hash | ✅ 必需 | Telegram API Hash（**每個帳號必須獨立**） |
| user_id | 可選 | Telegram 數字 ID（自動填充） |
| username | 可選 | 用戶名（自動填充） |
| name | 可選 | 昵稱（自動填充） |
| enabled | 可選 | 是否啟用（1=是，0=否） |

### ⚠️ API 憑證規則

系統啟動時會自動驗證：
- ✅ 每個帳號都有 api_id 和 api_hash
- ✅ 所有帳號的 API 憑證都是唯一的
- ❌ 如果發現重複的 API 憑證，系統將拒絕啟動

### 示例（正確 - 每個帳號獨立 API）：

| phone | api_id | api_hash | user_id | enabled |
|-------|--------|----------|---------|---------|
| 639277358115 | **30390800** | **471481f784e6d78893e53b88ee43e62b** | | 1 |
| 639543603735 | **38485760** | **2d43d7d9a5612d99ca4bfe46622248d7** | | 1 |
| 639876543210 | **42156789** | **9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d** | | 1 |

### 示例（錯誤 - API 憑證重複）：

| phone | api_id | api_hash | enabled |
|-------|--------|----------|---------|
| 639277358115 | 30390800 | 471481f784e6d78893e53b88ee43e62b | 1 |
| 639543603735 | **30390800** | **471481f784e6d78893e53b88ee43e62b** | 1 | ❌ 重複！

這樣的配置會導致啟動失敗，並顯示錯誤信息。

---

## 功能說明

### 自動建群

當 `AUTO_CREATE_GROUP=true` 時，系統會：
1. 選擇第一個帳號作為群組創建者
2. 創建超級群組（支持更多功能）
3. 自動邀請其他 AI 帳號加入
4. 生成群組邀請鏈接

**啟動輸出示例：**
```
🏠 正在創建測試群組...

==================================================
🎉 測試群組創建成功！
   名稱: 🧧 紅包測試群 1204143
   ID: -1001234567890
   邀請鏈接: https://t.me/+AbCdEfGhIjK
   創建者: 639277358115
==================================================

正在確保所有帳號都在群組中...
加入結果: 6/6 個帳號在群組中
```

### 自動搶紅包

當群消息中包含紅包關鍵詞和鏈接時，系統會：
1. 檢測紅包鏈接
2. 等待隨機延遲（模擬真人）
3. 調用紅包 API 領取
4. 可選：發送感謝消息

**關鍵詞識別：**
- 紅包、红包、🧧、💰
- 發紅包、发红包、搶紅包、抢红包
- lucky、packet、hongbao

**鏈接格式：**
- `https://t.me/luckyred_bot/app?startapp=p_UUID`
- `https://mini.usdt2026.cc/packets/UUID`
- 任何包含 UUID 格式的鏈接

### 自動發紅包

當 `AUTO_SEND=true` 時，系統會：
1. 按設定間隔（默認 300 秒）發送紅包
2. 隨機金額（1-5 USDT）
3. 隨機份數（3-5 份）
4. 檢查餘額是否足夠

### 自動聊天

當 `AUTO_CHAT=true` 時，系統會：
1. 在活躍群組中隨機發送消息
2. 間隔 30-120 秒
3. 使用預設的聊天模板

**預設消息模板：**
- 大家好！今天運氣怎麼樣？
- 紅包來啦！手速要快～
- 感謝老闆發紅包！🧧
- 哈哈，搶到了！
- 等等...

---

## 命令行參數

也可以通過命令行覆蓋環境變量：

```bash
# 指定 sessions 目錄
SESSIONS_DIR=/path/to/sessions python start_auto_redpacket.py

# 禁用自動聊天
AUTO_CHAT=false python start_auto_redpacket.py

# 指定目標群組
TARGET_GROUP=https://t.me/+xxxxx python start_auto_redpacket.py
```

---

## 日誌說明

系統會輸出詳細日誌：

```
2025-12-04 14:30:00 [INFO] 從 Excel 載入了 6 個帳號配置
2025-12-04 14:30:01 [INFO] 找到 6 個 session 文件
2025-12-04 14:30:02 [INFO] ✅ 帳號已連接: ai_user_1 (ID: 639277358115)
2025-12-04 14:30:03 [INFO] [用戶 639277358115] 開始監聽群消息...
2025-12-04 14:30:15 [INFO] [用戶 639277358115] 檢測到紅包: 2306e0c2-1a09-4b20-a772-xxx
2025-12-04 14:30:17 [INFO] [用戶 639277358115] 等待 2.3秒 後搶紅包...
2025-12-04 14:30:19 [INFO] [用戶 639277358115] 搶紅包成功！獲得 0.35 USDT
2025-12-04 14:31:00 [INFO] 📊 狀態: 6 帳號在線, 3 個活躍群組, 5 個紅包已領取
```

---

## 注意事項

1. **API 限流**：Telegram 對 API 調用有限制，系統已內置延遲機制
2. **帳號安全**：不要洩露 session 文件和 API 憑證
3. **餘額檢查**：發紅包前會檢查餘額，避免失敗
4. **群組權限**：確保 AI 帳號有權限在群內發送消息

---

## 問題排查

### Q: 無法連接帳號
A: 檢查 session 文件是否有效，API ID/Hash 是否正確

### Q: 搶不到紅包
A: 可能紅包已被搶完，或延遲太長。調整 `GRAB_DELAY_MIN/MAX`

### Q: 發送消息失敗
A: 檢查帳號是否被群組禁言或限制

### Q: 餘額不足
A: 聯繫紅包後端團隊充值 AI 帳號

---

## 後續開發

### 已完成 ✅
- [x] 每個帳號獨立 API 憑證驗證
- [x] 自動建群功能
- [x] AI 帳號自動加入群組
- [x] 自動搶紅包
- [x] 自動發紅包
- [x] 自動聊天互動

### 進行中 🔄
- [ ] 更智能的聊天 AI（基於劇本系統）
- [ ] 紅包遊戲策略（炸彈紅包識別）

### 計劃中 📋
- [ ] **自動拉真實用戶進群**（根據聊天進度觸發）
- [ ] **帳號自主建群**（根據業務邏輯自動創建多個群組）
- [ ] 群組管理功能（踢人、禁言等）
- [ ] Web 控制面板
- [ ] 數據統計和報表

---

## 架構說明

```
┌─────────────────────────────────────────────────────────────┐
│                    start_auto_redpacket.py                  │
│                      （主啟動腳本）                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────┐    ┌──────────────────────────────┐  │
│  │ worker_group_    │    │ worker_auto_redpacket.py     │  │
│  │ manager.py       │    │ （紅包和聊天自動化）          │  │
│  │ （群組管理）      │    │                              │  │
│  │                  │    │  - 消息監聽                   │  │
│  │ - 建群           │    │  - 搶紅包                     │  │
│  │ - 邀請成員       │    │  - 發紅包                     │  │
│  │ - 獲取邀請鏈接   │    │  - 聊天互動                   │  │
│  └──────────────────┘    └──────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                   accounts.xlsx                       │  │
│  │          （帳號配置 - 獨立 API 憑證）                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

*文檔更新時間：2025-12-04*
