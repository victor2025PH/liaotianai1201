# 監控頁面修復記錄

**日期**: 2025-01-17  
**問題**: 群組 AI 監控頁面出現 HTTP 404 錯誤

## 問題描述

前端監控頁面 (`/group-ai/monitor`) 顯示 "HTTP 404" 錯誤，無法加載監控數據。

## 問題原因

### 1. API 路徑不匹配

前端調用的 API 路徑與後端實際路由不一致：

**前端調用**（錯誤）：
- `${API_BASE}/monitor/accounts` → `http://localhost:8000/api/v1/group-ai/monitor/accounts`

**後端實際路由**（正確）：
- `/api/v1/group-ai/monitor/accounts/metrics` （路由定義為 `/accounts/metrics`，前綴為 `/group-ai/monitor`）

### 2. 接口定義不匹配

前端 `AccountMetrics` 接口定義包含後端不存在的字段：
- `success_count: number` - 後端沒有此字段
- `average_reply_time: number` - 後端沒有此字段
- `uptime_seconds: number` - 後端沒有此字段

前端 `SystemMetrics` 接口定義字段名稱與後端不一致：
- 前端：`total_redpacket: number`
- 後端：`total_redpackets: number`（複數形式）

## 修復方案

### 1. 修正 API 路徑

**文件**: `saas-demo/src/lib/api/group-ai.ts`

**修改前**:
```typescript
export async function getAccountMetrics(accountId?: string): Promise<AccountMetrics[]> {
  const url = accountId
    ? `${API_BASE}/monitor/accounts?account_id=${accountId}`
    : `${API_BASE}/monitor/accounts`
  // ...
}
```

**修改後**:
```typescript
export async function getAccountMetrics(accountId?: string): Promise<AccountMetrics[]> {
  const url = accountId
    ? `${API_BASE}/monitor/accounts/metrics?account_id=${accountId}`
    : `${API_BASE}/monitor/accounts/metrics`
  // ...
}
```

### 2. 修正接口定義

**文件**: `saas-demo/src/lib/api/group-ai.ts`

**AccountMetrics 接口**:
```typescript
// 修改前
export interface AccountMetrics {
  account_id: string
  message_count: number
  reply_count: number
  redpacket_count: number
  success_count: number        // ❌ 後端沒有
  error_count: number
  average_reply_time: number   // ❌ 後端沒有
  last_activity?: string
  uptime_seconds: number       // ❌ 後端沒有
}

// 修改後
export interface AccountMetrics {
  account_id: string
  message_count: number
  reply_count: number
  redpacket_count: number
  error_count: number
  last_activity?: string
}
```

**SystemMetrics 接口**:
```typescript
// 修改前
export interface SystemMetrics {
  // ...
  total_redpacket: number  // ❌ 應該是複數
  // ...
}

// 修改後
export interface SystemMetrics {
  // ...
  total_redpackets: number  // ✅ 匹配後端
  // ...
}
```

### 3. 修復前端頁面邏輯

**文件**: `saas-demo/src/app/group-ai/monitor/page.tsx`

由於後端沒有 `success_count` 字段，需要從其他字段計算：

```typescript
// 修改前
const successRate = total > 0
  ? ((metrics.success_count / total) * 100).toFixed(1)
  : "0.0"

// 修改後
const successCount = total - metrics.error_count
const successRate = total > 0
  ? ((successCount / total) * 100).toFixed(1)
  : "0.0"
```

## 測試結果

### API 端點測試

1. **系統指標 API**:
```bash
curl "http://localhost:8000/api/v1/group-ai/monitor/system"
```
**結果**: ✅ 成功返回系統指標數據

2. **賬號指標 API**:
```bash
curl "http://localhost:8000/api/v1/group-ai/monitor/accounts/metrics"
```
**結果**: ✅ 成功返回賬號指標列表（空數組，因為沒有活躍賬號）

3. **告警列表 API**:
```bash
curl "http://localhost:8000/api/v1/group-ai/monitor/alerts?limit=20"
```
**結果**: ✅ 成功返回告警列表（空數組，因為沒有告警）

## 後端 API 路由參考

### 監控相關路由

所有監控相關路由都在 `/api/v1/group-ai/monitor` 前綴下：

- `GET /api/v1/group-ai/monitor/system` - 獲取系統指標
- `GET /api/v1/group-ai/monitor/accounts/metrics` - 獲取賬號指標列表
- `GET /api/v1/group-ai/monitor/accounts/metrics?account_id={id}` - 獲取特定賬號指標
- `GET /api/v1/group-ai/monitor/alerts` - 獲取告警列表
- `POST /api/v1/group-ai/monitor/alerts/{alert_id}/resolve` - 解決告警
- `POST /api/v1/group-ai/monitor/alerts/check` - 執行告警規則檢查

## 影響範圍

### 修改的文件
1. `saas-demo/src/lib/api/group-ai.ts` - API 路徑和接口定義
2. `saas-demo/src/app/group-ai/monitor/page.tsx` - 頁面邏輯

### 注意事項

⚠️ **重要提醒**：
- 確保前端接口定義與後端 Pydantic 模型保持一致
- 在添加新字段時，需要同時更新前端和後端
- 建議使用 TypeScript 生成工具（如 `openapi-typescript`）自動生成類型定義

## 後續建議

1. **類型安全**:
   - 考慮使用 OpenAPI/Swagger 自動生成 TypeScript 類型定義
   - 添加運行時類型驗證（如 Zod）

2. **API 文檔**:
   - 確保後端 API 文檔（Swagger/OpenAPI）是最新的
   - 前端開發時參考 API 文檔而非直接猜測字段

3. **測試覆蓋**:
   - 添加前端 API 調用的單元測試
   - 添加集成測試驗證前後端數據結構匹配

