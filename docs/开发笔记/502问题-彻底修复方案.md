# 502问题 - 彻底修复方案

## 执行位置

**所有命令都在远程服务器 `ubuntu@165.154.233.55` 上执行**

## 问题现象

- `curl http://localhost:3000` 返回 "Connection refused"
- `curl http://aikz.usdt2026.cc/group-ai/accounts` 返回 502 Bad Gateway
- 说明：前端服务没有在3000端口运行

## 根本原因分析

502错误的常见原因：

1. **前端服务未启动** - 最可能的原因
2. **前端服务启动后崩溃** - 代码错误、依赖问题
3. **端口配置错误** - package.json中端口不是3000
4. **依赖未安装** - node_modules不存在或损坏
5. **环境问题** - Node.js版本不兼容

## 完整修复步骤

### 步骤1: 检查前端服务状态

```bash
cd ~/liaotian/saas-demo
ps aux | grep -E 'next.*dev|node.*3000' | grep -v grep
sudo ss -tlnp | grep 3000
curl -I http://localhost:3000
```

### 步骤2: 查看前端日志

```bash
tail -100 /tmp/frontend.log
```

### 步骤3: 检查配置

```bash
cd ~/liaotian/saas-demo
grep '"dev"' package.json
node -v
npm -v
ls -d node_modules 2>/dev/null || echo "node_modules不存在"
```

### 步骤4: 修复端口配置（如果需要）

如果package.json中的dev脚本不是 `"next dev -p 3000"`，修复：

```bash
cd ~/liaotian/saas-demo
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.scripts.dev = 'next dev -p 3000';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n', 'utf8');
"
```

### 步骤5: 安装依赖（如果需要）

如果node_modules不存在或Next.js未安装：

```bash
cd ~/liaotian/saas-demo
npm install
```

### 步骤6: 停止旧进程并前台运行

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
sleep 2
npm run dev
```

观察输出，看是否有错误。如果进程退出，查看错误信息。

### 步骤7: 根据错误修复

**如果错误是 "Cannot find module"**:
```bash
npm install
```

**如果错误是 "Port already in use"**:
```bash
# 找到占用端口的进程
sudo lsof -i :3000
# 或者
sudo ss -tlnp | grep 3000
# 停止进程
kill -9 <PID>
```

**如果错误是 "Syntax error"**:
- 查看具体错误信息
- 修复代码中的语法错误

### 步骤8: 后台启动前端

当前台测试成功后：

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
sleep 2
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15
curl -I http://localhost:3000
```

应该返回 HTTP 200 或 304。

### 步骤9: 重载Nginx并验证

```bash
sudo systemctl reload nginx
sleep 3
curl -I http://aikz.usdt2026.cc/group-ai/accounts
curl -I http://aikz.usdt2026.cc/
```

应该返回 HTTP 200、302 或 304，不再是 502。

## 一键修复脚本

已创建自动化脚本：

```bash
bash ~/liaotian/deploy/修复502-彻底诊断和修复.sh
```

这个脚本会自动：
1. 检查服务状态
2. 查看日志
3. 检查配置
4. 安装依赖（如果需要）
5. 前台测试运行
6. 分析错误
7. 后台启动
8. 验证服务
9. 重载Nginx
10. 验证域名访问

## 常见错误和解决方案

### 错误1: "Cannot find module"

**原因**: 依赖未安装

**解决**:
```bash
cd ~/liaotian/saas-demo
npm install
```

### 错误2: "Port 3000 already in use"

**原因**: 端口被占用

**解决**:
```bash
# 查找占用进程
sudo lsof -i :3000
# 停止进程
kill -9 <PID>
```

### 错误3: "Syntax error"

**原因**: 代码有语法错误

**解决**: 查看错误信息，修复代码

### 错误4: "ENOENT: no such file or directory"

**原因**: 文件或目录不存在

**解决**: 检查文件路径是否正确

## 从零启动服务的完整命令

```bash
#!/bin/bash
# 在远程服务器 ubuntu@165.154.233.55 上执行

# 1. 启动后端
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5

# 2. 启动前端
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 确保依赖已安装
if [ ! -d node_modules ] || [ ! -f node_modules/.bin/next ]; then
    npm install
fi

nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15

# 3. 重载Nginx
sudo systemctl reload nginx

# 4. 验证
echo "后端:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

echo "前端:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000

echo "域名:"
curl -s -o /dev/null -w '%{http_code}\n' http://aikz.usdt2026.cc/group-ai/accounts
```

---

**重要**: 所有命令都在远程服务器上执行！
