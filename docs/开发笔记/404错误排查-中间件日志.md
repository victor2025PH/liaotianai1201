# 404 错误排查 - 添加中间件日志

## 问题

用户分配剧本时仍然出现 404 错误，但后端日志中没有记录到请求。这说明请求可能：
1. 没有到达后端
2. 在路由匹配之前就被拦截
3. 被 Nginx 或其他代理拦截

## 解决方案

### 1. 添加中间件日志

在 `app/main.py` 中添加 HTTP 中间件，记录所有 PUT 请求到 `/accounts/`：

```python
@app.middleware("http")
async def log_accounts_requests(request: Request, call_next):
    import logging
    logger = logging.getLogger(__name__)
    
    # 记录 PUT 请求到 /accounts
    if request.method == "PUT" and "/accounts/" in str(request.url.path):
        logger.info(f"[MIDDLEWARE] PUT 请求到达: {request.url.path}")
        # 记录请求体
        body = await request.body()
        if body:
            body_dict = json.loads(body)
            logger.info(f"[MIDDLEWARE] 请求体: {json.dumps(body_dict, ensure_ascii=False)}")
    
    response = await call_next(request)
    
    if request.method == "PUT" and "/accounts/" in str(request.url.path):
        logger.info(f"[MIDDLEWARE] PUT 响应状态: {response.status_code}")
    
    return response
```

### 2. 增强 update_account 日志

在 `update_account` 函数中添加更详细的日志：

```python
logger.info(f"[UPDATE_ACCOUNT] 收到更新賬號請求: account_id={account_id}")
logger.info(f"[UPDATE_ACCOUNT] server_id={request.server_id}, session_file={request.session_file}")
```

### 3. 权限检查日志

添加权限检查失败的日志：

```python
try:
    check_permission(current_user, PermissionCode.ACCOUNT_UPDATE.value, db)
except HTTPException as e:
    logger.error(f"[UPDATE_ACCOUNT] 權限檢查失敗: {e.detail}, status_code={e.status_code}")
    raise
```

## 调试步骤

### 1. 查看中间件日志

```bash
tail -f /tmp/backend_middleware.log | grep -E "MIDDLEWARE|UPDATE_ACCOUNT"
```

如果看到 `[MIDDLEWARE] PUT 请求到达`，说明请求到达了后端。  
如果没有，说明请求没有到达后端，可能是 Nginx 或认证问题。

### 2. 查看完整的请求日志

```bash
tail -f /tmp/backend_middleware.log | grep -E "PUT|accounts|639277358115"
```

### 3. 检查 Nginx 日志

```bash
sudo tail -f /var/log/nginx/error.log | grep -E "PUT|accounts|404"
```

## 可能的问题

### 问题1：请求未到达后端

**症状**：中间件日志中没有记录

**可能原因**：
- Nginx 配置问题
- 路由配置错误
- 请求被 CORS 拦截

### 问题2：认证失败

**症状**：中间件有记录，但 `update_account` 函数没有执行

**可能原因**：
- Token 无效
- 权限不足
- 用户不存在

### 问题3：路由不匹配

**症状**：中间件有记录，但路由没有匹配

**可能原因**：
- URL 路径不匹配
- 路由注册顺序问题

## 下一步

1. **用户再次尝试分配剧本**
2. **查看中间件日志**：`tail -f /tmp/backend_middleware.log`
3. **根据日志输出定位问题**

## 日志文件位置

- **后端日志**：`/tmp/backend_middleware.log`
- **标准日志**：`logs/backend.log`
- **Nginx 日志**：`/var/log/nginx/error.log`
