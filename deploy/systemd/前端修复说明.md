# 前端认证检查问题修复说明

## 问题描述
前端页面卡在"檢查認證狀態..."，无法正常加载。

## 问题原因
`layout-wrapper.tsx` 中的认证检查逻辑有 bug：
- 当用户未登录且不在登录页时，会尝试重定向，但 `checking` 状态没有被设置为 `false`
- 导致页面一直显示加载状态

## 修复方案

### 已修复的文件
- `saas-demo/src/components/layout-wrapper.tsx`

### 修复内容
1. 在未登录重定向前，先设置 `setChecking(false)` 避免卡住
2. 无论是否认证，都应该停止检查状态
3. 在 useEffect 依赖数组中添加 `authState`

### 部署步骤

#### 方法1: 使用 SSH 手动上传（推荐）

1. 连接到服务器：
```bash
ssh ubuntu@165.154.254.99
```

2. 备份原文件：
```bash
cd /home/ubuntu/saas-demo
cp src/components/layout-wrapper.tsx src/components/layout-wrapper.tsx.bak
```

3. 编辑文件：
```bash
nano src/components/layout-wrapper.tsx
```

4. 应用以下修复：
   - 在第 21 行后添加：`setChecking(false); // 先停止檢查狀態，避免卡住`
   - 将第 33-35 行的条件判断改为：`// 無論是否認證，都應該停止檢查狀態` 和 `setChecking(false);`
   - 将第 77 行的依赖数组改为：`}, [pathname, router, isLoginPage, authState]);`

5. 确保使用 Node.js 20：
```bash
source ~/.nvm/nvm.sh
nvm use 20
```

6. 重新构建：
```bash
cd /home/ubuntu/saas-demo
npm run build
```

7. 重启服务：
```bash
sudo systemctl restart smart-tg-frontend
```

#### 方法2: 使用 SCP 上传

在本地执行：
```bash
scp saas-demo/src/components/layout-wrapper.tsx ubuntu@165.154.254.99:/home/ubuntu/saas-demo/src/components/
```

然后在服务器上执行步骤 5-7。

## 验证修复

1. 清除浏览器缓存
2. 访问 http://165.154.254.99:3000
3. 应该能够正常跳转到登录页面，而不是卡在"檢查認證狀態..."

## 如果仍然有问题

1. 按 F12 打开浏览器控制台，查看是否有 JavaScript 错误
2. 在控制台执行：`localStorage.clear()` 清除本地存储
3. 检查服务状态：`sudo systemctl status smart-tg-frontend`
4. 查看服务日志：`sudo journalctl -u smart-tg-frontend -f`

