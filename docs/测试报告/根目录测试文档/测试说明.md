# 按剧本聊天功能测试说明

## 当前状态

### ✅ 已完成
1. 创建新的API端点：`POST /api/v1/group-ai/groups/send-test-message`
2. 更新前端API客户端
3. 创建测试脚本

### ⚠️ 需要注意
1. **后端服务需要重启**以加载新的API端点
2. API认证问题需要检查（可能是token格式或权限问题）

## 测试方法

### 方法1：通过浏览器界面测试（推荐）

1. **打开账号管理页面**
   - 访问：http://localhost:3000/group-ai/accounts
   - 登录（如果需要）

2. **找到在线账号**
   - 查找状态为"online"的账号
   - 如果账号没有群组，点击"創建群組"按钮创建群组

3. **发送测试消息**
   - 可以使用浏览器开发者工具调用API
   - 或者等待前端界面添加"发送测试消息"按钮

### 方法2：使用PowerShell脚本测试

**前提条件**：
- 后端服务已重启（加载新的API端点）
- API认证问题已解决

**运行命令**：
```powershell
pwsh -File "测试按剧本聊天功能（完整版）.ps1"
```

### 方法3：直接使用curl测试

```bash
# 1. 登录获取token
TOKEN=$(curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123" \
  | jq -r '.access_token')

# 2. 发送测试消息
curl -X POST "http://localhost:8000/api/v1/group-ai/groups/send-test-message" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "账号ID",
    "group_id": 群组ID,
    "message": "你好",
    "wait_for_reply": true,
    "wait_timeout": 10
  }'
```

## API端点说明

### POST /api/v1/group-ai/groups/send-test-message

**请求参数**：
```json
{
  "account_id": "string",      // 账号ID（必填）
  "group_id": number,          // 群组ID（必填）
  "message": "string",         // 消息内容（必填）
  "wait_for_reply": boolean,   // 是否等待回复（可选，默认false）
  "wait_timeout": number       // 等待超时时间（秒，可选，默认10）
}
```

**响应**：
```json
{
  "account_id": "string",
  "group_id": number,
  "message_id": number,
  "success": true,
  "message": "测试消息已發送，已檢測到回復",
  "reply_received": true,
  "reply_count_before": 0,
  "reply_count_after": 1
}
```

## 下一步

1. **重启后端服务**以加载新的API端点
2. **解决API认证问题**（如果需要）
3. **运行测试**验证功能
4. **在前端界面添加测试按钮**（可选）

## 相关文件

- `admin-backend/app/api/group_ai/groups.py` - 后端API端点
- `saas-demo/src/lib/api/group-ai.ts` - 前端API客户端
- `测试按剧本聊天功能（完整版）.ps1` - 测试脚本
- `问题分析和解决方案总结.md` - 详细分析文档

