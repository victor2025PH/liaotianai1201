#!/bin/bash
# ============================================================
# 完整恶意软件清理流程（包含诊断和删除）
# ============================================================

set -e

echo "=========================================="
echo "🛡️  完整恶意软件清理流程"
echo "=========================================="
echo ""

SUSPICIOUS_FILES=("/data/MUTA71VL" "/data/CX81yM9aE" "/data/UY")

# 步骤 1: 诊断
echo "[步骤 1/4] 诊断文件状态..."
bash scripts/server/diagnose-file-persistence.sh
echo ""

# 步骤 2: 终止所有相关进程
echo "[步骤 2/4] 终止所有相关进程..."
for file in "${SUSPICIOUS_FILES[@]}"; do
    FILE_NAME=$(basename "$file")
    
    # 终止所有相关进程
    sudo pkill -9 -f "$FILE_NAME" 2>/dev/null || true
    sudo killall -9 "$FILE_NAME" 2>/dev/null || true
    
    # 终止使用该文件的进程
    if [ -f "$file" ]; then
        PIDS=$(sudo lsof "$file" 2>/dev/null | awk 'NR>1 {print $2}' | sort -u || true)
        for pid in $PIDS; do
            if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
                sudo kill -9 "$pid" 2>/dev/null || true
            fi
        done
    fi
done

sleep 3
echo "  ✅ 进程终止完成"
echo ""

# 步骤 3: 使用 inode 强制删除
echo "[步骤 3/4] 使用 inode 强制删除文件..."
bash scripts/server/force-delete-with-inode.sh
echo ""

# 步骤 4: 最终验证和清理
echo "[步骤 4/4] 最终验证和清理..."
sync
sync
sleep 2

# 强制刷新目录缓存
ls /data/ >/dev/null 2>&1 || true
sleep 1

REMAINING=0
for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        REMAINING=$((REMAINING+1))
        echo "  ⚠️  文件仍存在: $file"
        
        # 最后尝试：覆盖并删除
        echo "    尝试最后的方法：覆盖并删除..."
        sudo dd if=/dev/zero of="$file" bs=1M count=10 2>/dev/null || true
        sync
        sudo rm -f "$file" 2>/dev/null || true
        sync
        sleep 1
        
        if [ -f "$file" ]; then
            echo "    ❌ 仍然无法删除"
            echo "    建议："
            echo "      1. 重启系统后立即删除"
            echo "      2. 检查文件系统: sudo fsck /dev/vdb"
            echo "      3. 检查是否有隐藏进程: ps aux | grep -E 'MUTA71VL|CX81yM9aE'"
        else
            echo "    ✅ 删除成功"
        fi
    else
        echo "  ✅ 文件已删除: $file"
    fi
done

echo ""
if [ "$REMAINING" -eq 0 ]; then
    echo "=========================================="
    echo "✅ 所有可疑文件已成功删除"
    echo "=========================================="
    echo ""
    echo "建议后续操作:"
    echo "  1. 运行验证脚本: bash scripts/server/verify-cleanup.sh"
    echo "  2. 更改所有密码"
    echo "  3. 运行安全扫描: sudo rkhunter --check"
    echo "  4. 监控系统资源使用情况"
else
    echo "=========================================="
    echo "⚠️  仍有 $REMAINING 个文件无法删除"
    echo "=========================================="
    echo ""
    echo "建议操作:"
    echo "  1. 重启系统后立即运行此脚本"
    echo "  2. 检查系统日志: sudo journalctl -xe"
    echo "  3. 检查是否有进程持续重新创建文件"
    echo "  4. 考虑使用 Live CD 启动后删除文件"
fi
echo ""

