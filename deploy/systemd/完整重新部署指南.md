# 马尼拉服务器完整重新部署指南

## 当前状态

✅ **已完成**:
- 代码已上传到服务器: `/home/ubuntu/liaotian20251126/`
- 服务器环境已准备（Node.js 20, Python 3）

⏳ **待完成**:
- 后端代码部署（从 `full-backend-deploy` 或 `admin-backend-deploy`）
- 前端代码部署（从 `frontend.zip` 解压）
- 安装依赖、构建、配置服务

## 如果您要重新上传文件

### 方法1: 使用 SCP 上传（推荐）

在本地 PowerShell 执行：

```powershell
# 1. 上传整个目录（如果需要）
scp -r "C:\Users\Administrator\Desktop\liaotian20251126" ubuntu@165.154.233.55:/home/ubuntu/

# 或者只上传需要的文件
# 上传后端
scp -r "C:\Users\Administrator\Desktop\liaotian20251126\full-backend-deploy" ubuntu@165.154.233.55:/home/ubuntu/

# 上传前端压缩包
scp "C:\Users\Administrator\Desktop\liaotian20251126\frontend.zip" ubuntu@165.154.233.55:/home/ubuntu/
```

### 方法2: 使用 Web SSH 上传

1. 登录云服务器控制台
2. 使用 Web SSH 连接
3. 使用 `rz` 命令上传文件，或使用 FTP/SFTP 客户端

## 完整部署步骤（上传完成后）

### 步骤1: SSH 连接到服务器

```bash
ssh ubuntu@165.154.233.55
# 密码: Along2025!!!
```

### 步骤2: 清理旧文件（可选）

```bash
# 停止服务
sudo systemctl stop admin-backend smart-tg-frontend

# 备份旧目录（如果需要）
sudo mv /home/ubuntu/admin-backend /home/ubuntu/admin-backend.old
sudo mv /home/ubuntu/saas-demo /home/ubuntu/saas-demo.old
```

### 步骤3: 部署后端

```bash
# 进入代码目录
cd /home/ubuntu/liaotian20251126

# 复制后端代码（使用 full-backend-deploy，更完整）
cp -r full-backend-deploy /home/ubuntu/admin-backend

# 或者使用 admin-backend-deploy
# cp -r admin-backend-deploy /home/ubuntu/admin-backend

# 进入后端目录
cd /home/ubuntu/admin-backend

# 创建虚拟环境
python3 -m venv .venv
source .venv/bin/activate

# 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 配置 .env 文件
cat > .env << 'EOF'
DATABASE_URL=sqlite:///./data/app.db
SECRET_KEY=$(openssl rand -hex 32)
CORS_ORIGINS=["http://localhost:3000","http://165.154.233.55:3000","http://165.154.233.55:8000"]
EOF

# 启动服务（如果使用 systemd）
sudo systemctl restart admin-backend
# 或者手动启动
# source .venv/bin/activate
# uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 步骤4: 部署前端

```bash
# 进入代码目录
cd /home/ubuntu/liaotian20251126

# 解压前端
cd /home/ubuntu
unzip -q liaotian20251126/frontend.zip -d .
# 如果解压后目录名不同，重命名
mv saas-demo* saas-demo 2>/dev/null || true

# 进入前端目录
cd /home/ubuntu/saas-demo

# 确保使用 Node.js 20
source ~/.nvm/nvm.sh
nvm use 20

# 安装依赖
npm install

# 配置 .env.local
echo "NEXT_PUBLIC_API_BASE_URL=http://165.154.233.55:8000/api/v1" > .env.local

# 构建前端
npm run build

# 启动服务（如果使用 systemd）
sudo systemctl restart smart-tg-frontend
# 或者手动启动（standalone 模式）
# node .next/standalone/server.js
```

### 步骤5: 验证部署

```bash
# 检查服务状态
sudo systemctl status admin-backend smart-tg-frontend

# 检查端口
sudo ss -tlnp | grep -E ':8000|:3000'

# 健康检查
curl http://localhost:8000/health
curl -I http://localhost:3000
```

## 一键部署脚本

上传完成后，可以在服务器上执行以下脚本：

```bash
#!/bin/bash
# 完整部署脚本

set -e

echo "开始部署..."

# 1. 部署后端
echo "部署后端..."
cd /home/ubuntu/liaotian20251126
cp -r full-backend-deploy /home/ubuntu/admin-backend
cd /home/ubuntu/admin-backend
python3 -m venv .venv
source .venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

cat > .env << 'EOF'
DATABASE_URL=sqlite:///./data/app.db
SECRET_KEY=$(openssl rand -hex 32)
CORS_ORIGINS=["http://localhost:3000","http://165.154.233.55:3000"]
EOF

sudo systemctl restart admin-backend

# 2. 部署前端
echo "部署前端..."
cd /home/ubuntu
unzip -q liaotian20251126/frontend.zip -d .
cd saas-demo
source ~/.nvm/nvm.sh
nvm use 20
npm install
echo "NEXT_PUBLIC_API_BASE_URL=http://165.154.233.55:8000/api/v1" > .env.local
npm run build
sudo systemctl restart smart-tg-frontend

echo "部署完成！"
echo "前端: http://165.154.233.55:3000"
echo "后端: http://165.154.233.55:8000"
```

## 访问地址

部署完成后访问：
- **前端**: http://165.154.233.55:3000
- **后端**: http://165.154.233.55:8000
- **API 文档**: http://165.154.233.55:8000/docs

## 故障排查

如果遇到问题：

1. **查看服务日志**:
   ```bash
   sudo journalctl -u admin-backend -f
   sudo journalctl -u smart-tg-frontend -f
   ```

2. **检查端口占用**:
   ```bash
   sudo ss -tlnp | grep -E ':8000|:3000'
   ```

3. **检查文件权限**:
   ```bash
   ls -la /home/ubuntu/admin-backend
   ls -la /home/ubuntu/saas-demo
   ```

