# 马尼拉服务器完整部署步骤

## 服务器信息
- **主机**: 165.154.233.55
- **用户**: ubuntu
- **SSH**: `ssh ubuntu@165.154.233.55`

## 部署步骤

### 步骤 1: 连接到服务器

#### 方法A: 使用 SSH（如果可用）
```powershell
ssh ubuntu@165.154.233.55
```

#### 方法B: 使用 Web SSH（推荐）
1. 登录云服务器控制台
2. 找到马尼拉服务器 (165.154.233.55)
3. 点击"连接"或"Web SSH"

### 步骤 2: 上传修复后的文件

#### 方法A: 使用 SCP（从本地 PowerShell）
```powershell
scp saas-demo/src/components/layout-wrapper.tsx ubuntu@165.154.233.55:/home/ubuntu/saas-demo/src/components/
```

#### 方法B: 使用 Web SSH 编辑文件
登录后执行：
```bash
cd /home/ubuntu/saas-demo/src/components
cp layout-wrapper.tsx layout-wrapper.tsx.bak
nano layout-wrapper.tsx
```

在 nano 中：
1. 按 `Ctrl+K` 多次删除所有内容
2. 打开本地文件 `deploy/systemd/fix_layout_wrapper.txt`
3. 复制全部内容（Ctrl+A, Ctrl+C）
4. 在 Web SSH 中按 `Ctrl+V` 粘贴
5. 按 `Ctrl+O` 保存
6. 按 `Enter` 确认
7. 按 `Ctrl+X` 退出

### 步骤 3: 重新构建前端

```bash
# 进入前端目录
cd /home/ubuntu/saas-demo

# 确保使用 Node.js 20
source ~/.nvm/nvm.sh
nvm use 20

# 如果没有 Node.js 20，安装它
# nvm install 20
# nvm use 20
# nvm alias default 20

# 重新构建
npm run build
```

### 步骤 4: 重启服务

```bash
# 重启前端服务
sudo systemctl restart smart-tg-frontend

# 等待几秒
sleep 3

# 检查服务状态
sudo systemctl status smart-tg-frontend
```

### 步骤 5: 验证部署

1. 访问前端: http://165.154.233.55:3000
2. 访问后端: http://165.154.233.55:8000
3. 清除浏览器缓存
4. 如果仍然卡在认证检查，在浏览器控制台执行: `localStorage.clear()`

## 一键部署脚本（在服务器上执行）

如果已经通过 SSH 或 Web SSH 连接到服务器，可以执行：

```bash
cd /home/ubuntu/saas-demo

# 备份
cp src/components/layout-wrapper.tsx src/components/layout-wrapper.tsx.bak

# 编辑文件（需要手动粘贴代码）
nano src/components/layout-wrapper.tsx

# 然后执行构建和重启
source ~/.nvm/nvm.sh
nvm use 20
npm run build
sudo systemctl restart smart-tg-frontend
sudo systemctl status smart-tg-frontend
```

## 故障排查

### 问题1: 文件上传失败
- 检查目录是否存在: `ls -la /home/ubuntu/saas-demo/src/components/`
- 检查权限: `ls -la /home/ubuntu/saas-demo/src/components/layout-wrapper.tsx`

### 问题2: 构建失败
- 检查 Node.js 版本: `node --version` (需要 >= 20.9.0)
- 检查依赖: `npm install`
- 查看详细错误: `npm run build 2>&1 | tee build.log`

### 问题3: 服务无法启动
- 查看日志: `sudo journalctl -u smart-tg-frontend -f`
- 检查端口: `sudo ss -tlnp | grep 3000`
- 检查服务配置: `sudo systemctl cat smart-tg-frontend`

### 问题4: 前端仍然卡在认证检查
1. 确认文件已正确上传: `grep "setChecking(false)" /home/ubuntu/saas-demo/src/components/layout-wrapper.tsx`
2. 确认构建成功: `ls -la /home/ubuntu/saas-demo/.next/`
3. 清除浏览器缓存和 localStorage
4. 检查浏览器控制台错误（F12）

## 验证修复

部署完成后，检查文件是否包含修复：
```bash
grep -n "setChecking(false); // 先停止檢查狀態" /home/ubuntu/saas-demo/src/components/layout-wrapper.tsx
```

如果输出显示行号，说明修复已应用。

