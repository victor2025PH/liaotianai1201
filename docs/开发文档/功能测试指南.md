# Telegram注册系统 - 功能测试指南

## 快速启动

### 1. 启动后端服务

在终端1中运行：

```bash
cd admin-backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**验证**: 访问 http://localhost:8000/docs 应该能看到Swagger API文档

### 2. 启动前端服务

在终端2中运行：

```bash
cd admin-frontend
npm run dev
```

**验证**: 访问 http://localhost:5173 应该能看到前端页面

## 测试步骤

### 步骤1: 登录系统

1. 打开浏览器访问前端地址
2. 使用有效账号登录
3. 确认登录成功

### 步骤2: 访问注册页面

1. 点击左侧菜单"账户中心"
2. 点击"Telegram注册"标签页
3. 确认页面正常加载

**预期结果**:
- 页面显示三个步骤：配置信息 → 验证码验证 → 完成
- 手机号输入框显示
- 服务器选择下拉框显示
- 高级选项可展开

### 步骤3: 填写注册信息

1. **手机号**: 输入格式正确的手机号（含国家代码）
   - 正确格式: `+1234567890`
   - 错误格式: `1234567890` (缺少+号)

2. **国家代码**: 选择对应的国家代码
   - 例如: `+1` (美国/加拿大)

3. **服务器**: 从下拉列表选择服务器节点
   - 例如: `worker-01`

4. **高级选项** (可选):
   - API ID
   - API Hash
   - Session名称
   - 代理配置

### 步骤4: 开始注册

1. 点击"开始注册"按钮
2. 观察页面变化

**预期结果**:
- 按钮显示加载状态
- 如果成功: 跳转到步骤2（验证码输入）
- 显示倒计时
- 显示风险评分
- 如果失败: 显示错误提示

**可能的错误**:
- "手机号格式无效"
- "已达到速率限制"
- "风险评分过高，注册被阻止"
- "服务器连接失败"

### 步骤5: 输入验证码

1. 查看手机收到的验证码
2. 在输入框中输入验证码（5-6位数字）
3. 点击"验证"按钮

**预期结果**:
- 如果验证码正确: 跳转到步骤3（完成）
- 如果验证码错误: 显示错误提示
- 如果验证码过期: 显示过期提示

**特殊情况**:
- 如果需要两步验证: 会显示密码输入框
- 输入两步验证密码后继续

### 步骤6: 完成注册

**预期结果**:
- 显示成功消息
- 显示Session文件信息:
  - Session名称
  - 服务器节点
  - 文件大小
- 显示"注册新的账号"按钮

## 测试场景

### 场景1: 正常注册流程

1. ✅ 输入有效手机号
2. ✅ 选择服务器
3. ✅ 开始注册
4. ✅ 输入验证码
5. ✅ 完成注册

### 场景2: 手机号格式验证

- ❌ 输入 `1234567890` (缺少+号) → 应显示格式错误
- ❌ 输入 `+123` (太短) → 应显示格式错误
- ✅ 输入 `+1234567890` → 应通过验证

### 场景3: 速率限制

- 快速连续注册多次 → 应触发速率限制
- 显示等待时间提示

### 场景4: 风险评分

- 观察风险评分显示
- 高风险时应显示警告

### 场景5: 验证码过期

- 等待5分钟后输入验证码 → 应显示过期提示

### 场景6: 取消注册

- 在验证码输入步骤点击"重新开始" → 应重置表单

## API测试

### 使用Swagger UI测试

1. 访问 http://localhost:8000/docs
2. 找到 `telegram-registration` 标签
3. 测试各个端点:

#### POST /telegram-registration/start

**请求体**:
```json
{
  "phone": "+1234567890",
  "country_code": "+1",
  "node_id": "worker-01",
  "api_id": null,
  "api_hash": null,
  "session_name": null,
  "use_proxy": false,
  "proxy_url": null
}
```

**预期响应**:
```json
{
  "registration_id": "uuid-string",
  "status": "code_sent",
  "message": "验证码已发送",
  "phone_code_hash": "hash-string",
  "expires_in": 300,
  "risk_score": 25
}
```

#### POST /telegram-registration/verify

**请求体**:
```json
{
  "registration_id": "uuid-string",
  "code": "12345",
  "password": null
}
```

#### GET /telegram-registration/status/{registration_id}

**预期响应**:
```json
{
  "registration_id": "uuid-string",
  "status": "code_sent",
  "message": "等待验证码输入",
  "phone": "+1234567890",
  "node_id": "worker-01",
  "created_at": "2025-11-22T12:00:00",
  "updated_at": "2025-11-22T12:00:00",
  "expires_at": "2025-11-22T12:05:00",
  "risk_score": 25
}
```

## 问题排查

### 后端服务无法启动

1. 检查端口8000是否被占用
2. 检查Python依赖是否安装完整
3. 查看错误日志

### API返回401错误

- 需要在请求头中添加认证token
- 在Swagger UI中点击"Authorize"按钮
- 输入有效的JWT token

### 前端页面无法加载

1. 检查前端服务是否启动
2. 检查浏览器控制台错误
3. 检查API地址配置

### 注册失败

1. 检查服务器配置 (`data/master_config.json`)
2. 检查服务器SSH连接
3. 检查服务器上的pyrogram是否安装
4. 查看后端日志

## 测试检查清单

- [ ] 后端服务启动成功
- [ ] 前端服务启动成功
- [ ] API文档可访问
- [ ] 注册页面可访问
- [ ] 表单验证正常
- [ ] 开始注册功能正常
- [ ] 验证码输入功能正常
- [ ] 完成注册功能正常
- [ ] 错误处理正常
- [ ] 倒计时显示正常
- [ ] 风险评分显示正常

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
测试环境: [描述]

测试结果:
- 后端服务: [通过/失败]
- 前端页面: [通过/失败]
- 注册流程: [通过/失败]
- 异常处理: [通过/失败]

发现的问题:
1. [问题描述]
2. [问题描述]

建议:
1. [建议内容]
2. [建议内容]
```

