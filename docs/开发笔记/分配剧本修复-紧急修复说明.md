# 分配剧本修复 - 紧急修复说明

## 问题描述

用户反馈在分配剧本时仍然出现"账号 639277358115 不存在"的错误。虽然已修复后端支持从远程服务器扫描并创建账号，但前端可能没有正确传递 `server_id`。

## 问题分析

从错误图片看到：
- 账号显示节点：**computer_001**
- 账号ID：**639277358115**
- 错误：**账号 639277358115 不存在**

可能原因：
1. Worker账号对象有 `node_id` 字段，但 `server_id` 可能未正确设置或传递
2. 前端在传递 `server_id` 时，如果 `server_id` 为空，应该使用 `node_id` 作为备用

## 修复方案

### 前端修复

修改 `saas-demo/src/app/group-ai/accounts/page.tsx` 第1392行：

**修改前：**
```typescript
server_id: selectedAccountForRole.server_id || undefined,
```

**修改后：**
```typescript
server_id: selectedAccountForRole.server_id || (selectedAccountForRole as any).node_id || undefined,
```

这样可以确保：
- 优先使用 `server_id`
- 如果 `server_id` 不存在，使用 `node_id` 作为备用
- Worker账号的 `node_id` 就是服务器ID（如 "computer_001"）

### 验证步骤

1. **检查前端代码**：
   ```bash
   grep -A 2 "server_id.*selectedAccountForRole" src/app/group-ai/accounts/page.tsx
   ```

2. **重启前端服务**：
   ```bash
   pkill -f 'next.*dev|node.*3000'
   npm run dev > /tmp/frontend.log 2>&1 &
   ```

3. **测试分配剧本**：
   - 选择一个Worker节点账号（显示节点为 "computer_001"）
   - 点击"分配剧本"
   - 选择剧本和角色
   - 点击"分配剧本"
   - 应该成功，不再显示"账号不存在"错误

## 后端验证

后端代码已经支持：
- 检查 `request.server_id` 是否存在
- 如果存在，从 `SessionUploader.servers` 中查找服务器
- 扫描服务器上的账号
- 如果找到账号，创建数据库记录

## 日志检查

如果仍然失败，检查后端日志：
```bash
tail -100 /tmp/backend_with_fix.log | grep -E "639277358115|不存在|server_id"
```

可能的错误：
- "服务器 {server_id} 不存在" - 说明 `server_id` 不在 `SessionUploader.servers` 中
- "账号 {account_id} 不存在於服務器 {server_id} 上" - 说明账号不在服务器上

## 状态

✅ 前端修复已应用（使用 `node_id` 作为 `server_id` 的备用）  
✅ 前端服务已重启  
⏳ 等待用户测试
