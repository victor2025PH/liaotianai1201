# WebSocket 配置修复 - 完成说明

## 已创建的修复脚本

1. **`deploy/全自动修复.bat`** - Windows 批处理文件（推荐使用）
2. **`deploy/全自动修复WebSocket配置_v2.py`** - Python 修复脚本
3. **`deploy/执行修复并显示结果.py`** - 简化版修复脚本

## 使用方法

### 方法 1：双击运行批处理文件（最简单）

直接双击运行：`deploy/全自动修复.bat`

### 方法 2：命令行运行

```bash
cd "E:\002-工作文件\重要程序\聊天AI群聊程序"
python deploy/全自动修复WebSocket配置_v2.py
```

## 脚本功能

脚本会自动执行以下步骤：

1. ✅ 连接服务器
2. ✅ 检查当前 location 块数量
3. ✅ 如果只有 1 个，跳过修复
4. ✅ 如果有 2 个或更多：
   - 备份配置文件
   - 保留第一个 location 块
   - 删除所有重复的 location 块（包括前面的注释）
   - 测试 Nginx 配置语法
   - 重载 Nginx 服务
   - 显示最终配置

## 验证修复

修复完成后，可以通过以下方式验证：

### 1. 在服务器上验证

```bash
# SSH 连接到服务器
ssh ubuntu@165.154.233.55

# 检查 location 数量（应该只有 1 个）
sudo grep -c 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 测试配置
sudo nginx -t

# 查看最终配置
sudo grep -A 15 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
```

### 2. 在前端浏览器验证

1. 打开前端应用：http://aikz.usdt2026.cc
2. 打开开发者工具（F12）
3. 切换到 Network 标签
4. 筛选 WS (WebSocket) 连接
5. 刷新页面
6. 检查连接状态：
   - ✅ **成功**：状态码 101 (Switching Protocols)
   - ❌ **失败**：状态码 400/404/502 等，或连接失败

## 如果修复失败

如果脚本执行后仍有问题，可以：

1. **查看备份文件**：
   ```bash
   ls -la /etc/nginx/sites-available/aikz.usdt2026.cc.bak.*
   ```

2. **手动恢复备份**：
   ```bash
   sudo cp /etc/nginx/sites-available/aikz.usdt2026.cc.bak.auto /etc/nginx/sites-available/aikz.usdt2026.cc
   ```

3. **手动编辑**：
   ```bash
   sudo nano /etc/nginx/sites-available/aikz.usdt2026.cc
   ```
   删除第二个重复的 `location /api/v1/notifications/ws` 块

## 预期结果

修复成功后：
- ✅ 配置文件中只有 1 个 `location /api/v1/notifications/ws` 块
- ✅ `nginx -t` 测试通过
- ✅ Nginx 服务正常运行
- ✅ 前端 WebSocket 连接成功（状态码 101）

## 下一步

修复完成后：
1. 在前端浏览器中刷新页面
2. 检查 WebSocket 连接是否成功
3. 如果仍有问题，查看浏览器控制台的错误信息
4. 检查后端日志：`sudo journalctl -u liaotian-backend -n 50`

