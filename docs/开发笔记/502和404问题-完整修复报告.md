# 502和404问题 - 完整修复报告

## 执行位置

**所有修复操作都在远程服务器 `ubuntu@165.154.233.55` 上执行**

## 任务一：修复 502 Bad Gateway

### 根本原因分析

502错误通常由以下原因导致：
1. **前端服务未在3000端口运行**
2. **后端服务未在8000端口运行**
3. **Nginx配置错误或未重载**
4. **服务启动后崩溃**

### 修复步骤

#### 步骤1: 验证前端端口配置

```bash
cd ~/liaotian/saas-demo
grep '"dev"' package.json
```

应该看到：`"dev": "next dev -p 3000"`

如果端口不是3000，修复：
```bash
# 使用node修复（推荐）
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.scripts.dev = 'next dev -p 3000';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n', 'utf8');
"
```

#### 步骤2: 重启后端服务

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5
curl http://localhost:8000/health
```

预期输出：`{"status":"ok"}` 或类似JSON

#### 步骤3: 重启前端服务

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev\|node.*3000" || true
sleep 2
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15
curl -I http://localhost:3000
```

预期输出：`HTTP/1.1 200 OK` 或 `304 Not Modified`

#### 步骤4: 重载Nginx

```bash
sudo systemctl reload nginx
```

#### 步骤5: 验证所有服务

```bash
echo "后端健康检查:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

echo "前端服务:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000

echo "域名访问:"
curl -s -o /dev/null -w '%{http_code}\n' http://aikz.usdt2026.cc/group-ai/accounts
```

所有状态码应该是 **200、302 或 304**，不应该是 **502**。

### 修改的文件

- `saas-demo/package.json` - 确保dev脚本使用 `-p 3000`（如果原本不是）

## 任务二：修复 404 账号不存在问题

### 根本原因分析

404错误 `"賬號 639277358115 不存在"` 的原因：
1. **账号ID 639277358115 确实不存在** - 在AccountManager和数据库中都不存在
2. **代码中硬编码了这个账号ID** - 前端或后端代码中使用了不存在的账号ID
3. **未提供 server_id** - 导致后端无法从远程服务器扫描并创建账号记录

### 修复步骤

#### 步骤1: 登录并获取账号列表

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate

# 登录获取token
TOKEN=$(curl -s -X POST 'http://localhost:8000/api/v1/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin@example.com&password=changeme123' | \
  python3 -c 'import sys, json; print(json.load(sys.stdin)["access_token"])')

# 获取账号列表
curl -s "http://localhost:8000/api/v1/group-ai/accounts?page=1&page_size=100" \
  -H "Authorization: Bearer $TOKEN" > /tmp/group_ai_accounts.json

# 查看账号列表
python3 << 'EOF'
import json
with open('/tmp/group_ai_accounts.json', 'r') as f:
    accounts = json.load(f)
if isinstance(accounts, list):
    account_ids = [acc.get('account_id') for acc in accounts if acc.get('account_id')]
    print(f"找到 {len(account_ids)} 个账号")
    for acc_id in account_ids[:10]:
        print(f"  - {acc_id}")
EOF
```

#### 步骤2: 检查目标账号是否存在

```bash
TARGET_ID="639277358115"
if grep -q "$TARGET_ID" /tmp/group_ai_accounts.json; then
    echo "✓ 账号 $TARGET_ID 存在"
else
    echo "✗ 账号 $TARGET_ID 不存在，需要修复"
fi
```

#### 步骤3: 搜索代码中的引用

```bash
cd ~/liaotian

echo "搜索前端代码..."
grep -rn "639277358115" saas-demo/src 2>/dev/null | head -10

echo "搜索后端代码..."
grep -rn "639277358115" admin-backend/app 2>/dev/null | head -10
```

#### 步骤4: 获取真实存在的账号ID

```bash
FIRST_ACCOUNT_ID=$(python3 << 'EOF'
import json
with open('/tmp/group_ai_accounts.json', 'r') as f:
    accounts = json.load(f)
if isinstance(accounts, list) and accounts:
    print(accounts[0].get('account_id', ''))
EOF
)

echo "将使用账号ID: $FIRST_ACCOUNT_ID"
```

#### 步骤5: 替换代码中的硬编码ID（方案A）

如果找到了真实存在的账号ID，替换所有引用：

```bash
TARGET_ID="639277358115"
REAL_ID="$FIRST_ACCOUNT_ID"  # 从上一步获取

# 替换前端代码
cd ~/liaotian
find saas-demo/src -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) \
  -exec sed -i "s/$TARGET_ID/$REAL_ID/g" {} + 2>/dev/null || true

# 替换后端代码
find admin-backend/app -type f -name "*.py" \
  -exec sed -i "s/$TARGET_ID/$REAL_ID/g" {} + 2>/dev/null || true

echo "代码已更新"
```

#### 步骤6: 重启后端服务

如果代码被修改：

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5
curl http://localhost:8000/health
```

#### 步骤7: 验证修复

```bash
# 使用真实账号ID测试PUT请求
curl -X PUT "http://localhost:8000/api/v1/group-ai/accounts/$REAL_ID" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"script_id":"test-script","server_id":"computer_001"}' \
  -v
```

应该返回 **200 或 201**，而不是 **404**。

### 修改的文件

根据搜索结果，可能修改的文件：
- `saas-demo/src/app/group-ai/accounts/page.tsx` - 如果前端代码中有硬编码
- `admin-backend/app/api/group_ai/accounts.py` - 如果后端代码中有硬编码
- 其他配置文件（.json, .yaml等） - 如果配置中有硬编码

## 一键执行脚本

已创建自动化脚本：

### 脚本位置

```bash
~/liaotian/deploy/一键修复502和404.sh
```

### 执行方式

```bash
# 在远程服务器上执行
ssh ubuntu@165.154.233.55
bash ~/liaotian/deploy/一键修复502和404.sh
```

### 脚本功能

1. ✅ 自动重启后端服务
2. ✅ 自动重启前端服务
3. ✅ 自动重载Nginx
4. ✅ 自动验证服务状态
5. ✅ 自动获取账号列表
6. ✅ 自动搜索并替换硬编码的账号ID
7. ✅ 自动重启后端（如果代码被修改）
8. ✅ 自动验证修复结果

## 从零启动服务的命令清单

```bash
#!/bin/bash
# 在远程服务器 ubuntu@165.154.233.55 上执行

# 1. 启动后端服务
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5

# 2. 启动前端服务
cd ~/liaotian/saas-demo
pkill -f "next.*dev\|node.*3000" || true
sleep 2
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15

# 3. 重载Nginx
sudo systemctl reload nginx

# 4. 验证服务
echo "后端健康检查:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

echo "前端服务:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000

echo "域名访问:"
curl -s -o /dev/null -w '%{http_code}\n' http://aikz.usdt2026.cc/group-ai/accounts
```

## 修复后的验证

### 502问题验证

```bash
# 在远程服务器上执行
curl -I http://localhost:8000/health      # 应该返回 200
curl -I http://localhost:3000             # 应该返回 200 或 304
curl -I http://aikz.usdt2026.cc/group-ai/accounts  # 应该返回 200、302 或 304（不是502）
```

### 404问题验证

```bash
# 在远程服务器上执行
# 1. 登录获取token
TOKEN=$(curl -s -X POST 'http://localhost:8000/api/v1/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin@example.com&password=changeme123' | \
  python3 -c 'import sys, json; print(json.load(sys.stdin)["access_token"])')

# 2. 获取真实账号ID
REAL_ID=$(curl -s "http://localhost:8000/api/v1/group-ai/accounts?page=1&page_size=100" \
  -H "Authorization: Bearer $TOKEN" | \
  python3 -c 'import sys, json; data=json.load(sys.stdin); print(data[0].get("account_id", "") if isinstance(data, list) and data else "")')

# 3. 测试PUT请求
curl -X PUT "http://localhost:8000/api/v1/group-ai/accounts/$REAL_ID" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"script_id":"test-script","server_id":"computer_001"}' \
  -v

# 应该返回 200 或 201，而不是 404
```

## 已创建的文档和脚本

### 文档
1. `docs/开发笔记/502和404问题-完整修复报告.md` - 本文档
2. `docs/开发笔记/彻底修复502和404-执行指南.md` - 执行指南
3. `docs/开发笔记/命令执行位置说明.md` - 执行位置说明
4. `deploy/彻底修复502和404-完整方案.md` - 完整修复方案

### 脚本
1. `deploy/一键修复502和404.sh` - 一键自动化修复脚本（推荐使用）
2. `deploy/彻底修复502和404问题.sh` - 详细bash脚本
3. `deploy/彻底修复502和404问题.py` - Python版本脚本
4. `deploy/修复502和404-分步执行.sh` - 分步执行脚本

## 预期修复结果

### ✅ 502问题修复后

- 后端服务正常运行在8000端口
- 前端服务正常运行在3000端口
- Nginx正确代理到前端
- 域名访问返回200/302/304，不再是502

### ✅ 404问题修复后

- 代码中不再使用不存在的账号ID
- PUT请求可以成功更新账号
- 账号ID使用真实存在的账号
- 不再返回"賬號不存在"的404错误

---

**重要提示**: 所有操作都在远程服务器 `ubuntu@165.154.233.55` 上执行！
