# 401 认证失败问题完整诊断与修复方案

## 问题描述

访问 `http://aikz.usdt2026.cc/group-ai/accounts` 时，所有 group-ai 相关接口返回 401 Unauthorized：
- `GET /api/v1/group-ai/accounts?page_size=100` → 401
- `GET /api/v1/group-ai/accounts/scan-sessions` → 401
- `GET /api/v1/group-ai/servers/ai` → 401
- `GET /api/v1/group-ai/credits` → 401

## 代码分析

### 1. 后端认证逻辑

**文件位置：** `admin-backend/app/api/deps.py`

**关键代码：**
```python
# 第 17 行
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login", auto_error=True)

# 第 26-96 行：get_current_user 函数
def get_current_user(
    token: str = Depends(oauth2_scheme),  # auto_error=True 时，token 不会是 None
    credentials: Optional[HTTPAuthorizationCredentials] = Depends(http_bearer),
    db: Session = Depends(get_db_session)
):
    # ...
    if not auth_token:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="无法验证身份",
            headers={"WWW-Authenticate": "Bearer"},
        )
```

**认证机制：**
- 使用 `OAuth2PasswordBearer`，`auto_error=True`
- 从请求的 `Authorization: Bearer <token>` header 中提取 token
- 如果没有 token 或 token 无效，直接抛出 401

**文件位置：** `admin-backend/app/api/group_ai/accounts.py`

**关键代码：**
```python
# 第 45 行
from app.api.deps import get_current_active_user

# 第 158 行（示例端点）
@router.get("/", response_model=AccountListResponse)
async def list_accounts(
    current_user: User = Depends(get_current_active_user),
    # ...
):
    check_permission(current_user, PermissionCode.ACCOUNT_VIEW.value, db)
    # ...
```

**结论：** 所有 group-ai 接口都依赖 `get_current_active_user`，需要有效的 JWT token。

### 2. 前端认证发送

**文件位置：** `saas-demo/src/lib/api/client.ts`

**关键代码：**
```typescript
// 第 10-21 行
export function getAuthHeaders(): HeadersInit {
  const token = getToken()  // 从 localStorage 获取
  const headers: HeadersInit = {
    "Content-Type": "application/json",
  }
  
  if (token) {
    headers["Authorization"] = `Bearer ${token}`
  }
  
  return headers
}
```

**文件位置：** `saas-demo/src/lib/api/group-ai.ts`

**关键代码：**
```typescript
// 第 81-100 行
export async function getAccounts(params?: AccountListParams): Promise<Account[]> {
  const { fetchWithAuth } = await import("./client")
  // ...
  const response = await fetchWithAuth(url, {
    headers: {
      "Content-Type": "application/json",
    },
  })
  // ...
}
```

**结论：** 前端正确使用 `fetchWithAuth`，应该会发送 `Authorization: Bearer <token>` header。

### 3. CORS 配置

**文件位置：** `admin-backend/app/main.py`

**关键代码：**
```python
# 第 105-117 行
cors_origins = settings.cors_origins.split(",") if settings.cors_origins else []
if not cors_origins:
    cors_origins = ["http://localhost:3000", "http://localhost:3001", "http://localhost:5173"]

app.add_middleware(
    CORSMiddleware,
    allow_origins=cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**文件位置：** `admin-backend/app/core/config.py`

**关键代码：**
```python
# 第 21 行
cors_origins: str = "http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:8080"
```

**问题：** 生产域名 `http://aikz.usdt2026.cc` 不在 CORS 允许列表中！

## 可能的原因

### 原因 1：CORS 配置缺失（最可能）

**问题：** 后端 CORS 配置中没有包含 `http://aikz.usdt2026.cc`，导致：
- 预检请求（OPTIONS）可能被拒绝
- 即使预检通过，响应头中缺少正确的 `Access-Control-Allow-Origin`，浏览器会阻止请求
- 或者 CORS 中间件阻止了请求，导致 Authorization header 没有到达后端

**验证方法：**
```bash
# 在服务器上检查后端 .env 文件
sudo grep CORS_ORIGINS /home/ubuntu/liaotian/admin-backend/.env
```

### 原因 2：Nginx 过滤了 Authorization header

**问题：** Nginx 配置可能没有正确传递 `Authorization` header 到后端。

**验证方法：**
```bash
# 检查 Nginx 配置
sudo grep -A 10 "location /api/" /etc/nginx/sites-available/aikz.usdt2026.cc
```

### 原因 3：前端没有 token

**问题：** 用户未登录或 token 已过期，localStorage 中没有有效的 `access_token`。

**验证方法：**
在浏览器控制台执行：
```javascript
localStorage.getItem('access_token')
```

### 原因 4：Token 格式错误

**问题：** Token 存在但格式不正确（例如缺少 "Bearer " 前缀，或 token 本身无效）。

## 修复方案

### 修复 1：更新后端 CORS 配置（必须）

**步骤 1：** 修改后端 `.env` 文件

在服务器上执行：
```bash
# 备份当前配置
sudo cp /home/ubuntu/liaotian/admin-backend/.env /home/ubuntu/liaotian/admin-backend/.env.bak.$(date +%Y%m%d_%H%M%S)

# 检查当前 CORS_ORIGINS 配置
sudo grep CORS_ORIGINS /home/ubuntu/liaotian/admin-backend/.env

# 添加生产域名（如果不存在）
sudo sed -i 's|CORS_ORIGINS=.*|CORS_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:8080,http://aikz.usdt2026.cc|' /home/ubuntu/liaotian/admin-backend/.env

# 或者如果 CORS_ORIGINS 不存在，添加新行
if ! sudo grep -q "CORS_ORIGINS" /home/ubuntu/liaotian/admin-backend/.env; then
    echo "CORS_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:8080,http://aikz.usdt2026.cc" | sudo tee -a /home/ubuntu/liaotian/admin-backend/.env
fi
```

**步骤 2：** 重启后端服务

```bash
sudo systemctl restart liaotian-backend
sudo systemctl status liaotian-backend
```

### 修复 2：确保 Nginx 传递 Authorization header（检查）

**检查 Nginx 配置：**

```bash
# 查看完整的 /api/ location 配置
sudo grep -A 15 "location /api/" /etc/nginx/sites-available/aikz.usdt2026.cc
```

**确保配置包含：**
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # 确保 Authorization header 被传递（默认应该传递，但显式设置更安全）
    proxy_set_header Authorization $http_authorization;
    proxy_read_timeout 300;
}
```

**如果缺少 `proxy_set_header Authorization`，添加它：**

```bash
# 使用 sed 添加（如果不存在）
if ! sudo grep -q "proxy_set_header Authorization" /etc/nginx/sites-available/aikz.usdt2026.cc; then
    sudo sed -i '/location \/api\/ {/,/}/ {
        /proxy_set_header X-Forwarded-Proto/a\    proxy_set_header Authorization $http_authorization;
    }' /etc/nginx/sites-available/aikz.usdt2026.cc
fi

# 测试配置
sudo nginx -t

# 重新加载 Nginx
sudo systemctl reload nginx
```

### 修复 3：验证前端 token（检查）

**在浏览器中验证：**

1. 打开 `http://aikz.usdt2026.cc/group-ai/accounts`
2. 打开开发者工具（F12）→ Console
3. 执行：
   ```javascript
   console.log('Token:', localStorage.getItem('access_token'))
   ```
4. 如果返回 `null`，需要重新登录

**重新登录：**
1. 访问 `http://aikz.usdt2026.cc/login`
2. 使用 `admin@example.com` / `changeme123` 登录
3. 登录后，再次检查 token

### 修复 4：启用后端认证调试日志（可选，用于诊断）

**在服务器上修改后端 `.env`：**

```bash
# 添加调试日志配置
if ! sudo grep -q "DEBUG_AUTH_LOGS" /home/ubuntu/liaotian/admin-backend/.env; then
    echo "DEBUG_AUTH_LOGS=true" | sudo tee -a /home/ubuntu/liaotian/admin-backend/.env
fi

# 重启后端
sudo systemctl restart liaotian-backend

# 查看日志
sudo journalctl -u liaotian-backend -f | grep "AUTH DEBUG"
```

## 完整修复脚本

创建一个自动化修复脚本：

```bash
#!/bin/bash
# 修复 401 认证问题

echo "============================================================"
echo "修复 401 认证问题"
echo "============================================================"

# 1. 备份配置
echo ">>> [1] 备份配置..."
sudo cp /home/ubuntu/liaotian/admin-backend/.env /home/ubuntu/liaotian/admin-backend/.env.bak.$(date +%Y%m%d_%H%M%S)
sudo cp /etc/nginx/sites-available/aikz.usdt2026.cc /etc/nginx/sites-available/aikz.usdt2026.cc.bak.$(date +%Y%m%d_%H%M%S)

# 2. 更新 CORS 配置
echo ">>> [2] 更新 CORS 配置..."
if sudo grep -q "CORS_ORIGINS" /home/ubuntu/liaotian/admin-backend/.env; then
    # 如果已存在，检查是否包含生产域名
    if ! sudo grep "CORS_ORIGINS" /home/ubuntu/liaotian/admin-backend/.env | grep -q "aikz.usdt2026.cc"; then
        # 追加生产域名
        sudo sed -i 's|CORS_ORIGINS=\(.*\)|CORS_ORIGINS=\1,http://aikz.usdt2026.cc|' /home/ubuntu/liaotian/admin-backend/.env
        echo "[OK] 已添加生产域名到 CORS_ORIGINS"
    else
        echo "[OK] CORS_ORIGINS 已包含生产域名"
    fi
else
    # 如果不存在，添加新行
    echo "CORS_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:5173,http://localhost:8080,http://aikz.usdt2026.cc" | sudo tee -a /home/ubuntu/liaotian/admin-backend/.env
    echo "[OK] 已添加 CORS_ORIGINS 配置"
fi

# 3. 确保 Nginx 传递 Authorization header
echo ">>> [3] 检查 Nginx 配置..."
if ! sudo grep -q "proxy_set_header Authorization" /etc/nginx/sites-available/aikz.usdt2026.cc; then
    # 在 /api/ location 中添加 Authorization header
    sudo sed -i '/location \/api\/ {/,/proxy_read_timeout/ {
        /proxy_set_header X-Forwarded-Proto/a\    proxy_set_header Authorization $http_authorization;
    }' /etc/nginx/sites-available/aikz.usdt2026.cc
    echo "[OK] 已添加 Authorization header 传递"
else
    echo "[OK] Nginx 已配置 Authorization header 传递"
fi

# 4. 测试 Nginx 配置
echo ">>> [4] 测试 Nginx 配置..."
if sudo nginx -t; then
    echo "[OK] Nginx 配置测试通过"
    sudo systemctl reload nginx
    echo "[OK] Nginx 已重新加载"
else
    echo "[错误] Nginx 配置测试失败，请检查配置"
    exit 1
fi

# 5. 重启后端服务
echo ">>> [5] 重启后端服务..."
sudo systemctl restart liaotian-backend
sleep 2
if sudo systemctl is-active --quiet liaotian-backend; then
    echo "[OK] 后端服务已重启"
else
    echo "[错误] 后端服务启动失败"
    sudo systemctl status liaotian-backend --no-pager | head -20
    exit 1
fi

# 6. 验证配置
echo ">>> [6] 验证配置..."
echo "CORS_ORIGINS:"
sudo grep CORS_ORIGINS /home/ubuntu/liaotian/admin-backend/.env
echo ""
echo "Nginx Authorization header:"
sudo grep -A 2 "proxy_set_header Authorization" /etc/nginx/sites-available/aikz.usdt2026.cc || echo "未找到（可能使用默认传递）"

echo ""
echo "============================================================"
echo "修复完成！"
echo "============================================================"
echo ""
echo "下一步："
echo "1. 在浏览器中访问 http://aikz.usdt2026.cc/login 重新登录"
echo "2. 登录后访问 http://aikz.usdt2026.cc/group-ai/accounts"
echo "3. 检查浏览器控制台，确认 API 请求是否成功"
```

## 验证步骤

### 1. 服务器端验证

```bash
# 检查后端 CORS 配置
sudo grep CORS_ORIGINS /home/ubuntu/liaotian/admin-backend/.env

# 检查后端服务状态
sudo systemctl status liaotian-backend

# 检查后端日志（查看认证相关日志）
sudo journalctl -u liaotian-backend -n 50 | grep -i "auth\|401\|unauthorized"

# 测试登录 API（应该返回 token）
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=changeme123"
```

### 2. 浏览器端验证

1. **清除缓存并重新登录：**
   - 访问 `http://aikz.usdt2026.cc/login`
   - 使用 `admin@example.com` / `changeme123` 登录

2. **检查 token：**
   - 打开开发者工具（F12）→ Console
   - 执行：`localStorage.getItem('access_token')`
   - 应该返回一个 JWT token 字符串

3. **检查网络请求：**
   - 打开开发者工具（F12）→ Network
   - 访问 `http://aikz.usdt2026.cc/group-ai/accounts`
   - 查看 `/api/v1/group-ai/accounts` 请求：
     - **Request Headers** 中应该有 `Authorization: Bearer <token>`
     - **Response** 应该是 200（不是 401）

4. **检查 CORS：**
   - 在 Network 标签中，查看响应头：
     - `Access-Control-Allow-Origin: http://aikz.usdt2026.cc`
     - `Access-Control-Allow-Credentials: true`

## 预期结果

修复后：
- ✅ API 请求返回 200（不是 401）
- ✅ 响应头包含正确的 CORS 头
- ✅ 页面正常加载数据
- ✅ 浏览器控制台没有认证错误

## 总结

**最可能的原因：** CORS 配置中没有包含生产域名 `http://aikz.usdt2026.cc`。

**修复优先级：**
1. **必须：** 更新后端 CORS 配置，添加生产域名
2. **检查：** 确保 Nginx 传递 Authorization header
3. **验证：** 确保用户已登录，localStorage 中有有效的 token

