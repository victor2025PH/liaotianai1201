# .txt文件转换功能升级方案

## 问题分析总结

### 1. 技术原因详细分析

#### 1.1 格式兼容性问题
**问题描述**：
- .txt文件是纯文本格式，不包含任何YAML结构标识
- 转换器无法识别文本中的对话结构
- 无法区分哪些是角色，哪些是对话内容

**影响**：
- 转换后的YAML可能缺少必要的字段结构
- 无法正确提取场景和响应
- 生成的triggers可能为空或缺少type字段

#### 1.2 内容结构识别问题
**问题描述**：
- 纯文本对话内容没有明确的结构标识（如YAML的key-value）
- 无法自动识别对话模式（角色: 内容）
- 无法区分触发条件和响应内容

**影响**：
- 转换后可能无法正确提取场景
- 无法识别角色信息
- 无法生成正确的triggers结构

#### 1.3 字符编码问题
**问题描述**：
- .txt文件可能使用不同的编码（GBK、UTF-8、Big5等）
- Windows记事本默认使用GBK编码
- 读取时可能出现乱码或字符丢失

**影响**：
- 转换后的内容不完整
- 包含乱码字符
- 无法正确解析中文字符

#### 1.4 转换算法局限性
**问题描述**：
- 当前转换算法主要针对YAML格式
- 对纯文本的支持不足
- AI转换提示词没有强调纯文本处理

**影响**：
- 纯文本无法正确转换为结构化YAML
- 转换后的YAML结构不完整
- 缺少triggers的type字段

#### 1.5 验证机制不完善
**问题描述**：
- 转换后没有充分验证所有必要字段
- 特别是triggers中的type字段验证不足
- 缺少自动修复机制

**影响**：
- 缺少字段的YAML仍能通过转换
- 但在创建时失败（"觸發條件缺少 type"）
- 用户体验差

### 2. 具体失败原因

根据错误信息"觸發條件缺少 type"，具体原因如下：

1. **转换后的场景缺少triggers字段**
   - 转换算法可能没有为每个场景生成triggers
   - 或者triggers字段为空列表

2. **triggers字段缺少type属性**
   - 转换后的triggers可能只包含部分字段
   - type字段是必填字段，但转换时可能遗漏

3. **纯文本内容无法识别对话结构**
   - .txt文件中的对话内容没有明确的角色标识
   - 无法区分哪些是触发条件，哪些是响应内容

4. **AI转换提示词不完整**
   - 当前AI转换提示词可能没有强调必须包含type字段
   - 生成的YAML结构可能不完整

## 已实施的解决方案

### 方案1：创建TextParser纯文本解析器 ✅

#### 1.1 功能特性
- **对话模式识别**：支持多种对话格式
  - `角色: 内容`
  - `[角色] 内容`
  - `【角色】内容`
  - `1. 角色: 内容`

- **角色规范化**：自动识别并规范化角色名称
  - 管理员、审核员、接待员等
  - 支持中英文角色名称

- **编码检测**：自动检测文件编码
  - UTF-8、GBK、GB2312、Big5等
  - 统一转换为UTF-8

- **内容清理**：预处理文本内容
  - 移除BOM标记
  - 规范化换行符
  - 清理多余空行

#### 1.2 转换逻辑
```python
# 1. 解析对话
dialogues = text_parser.parse_text_to_dialogue(content)

# 2. 转换为场景
scenes = text_parser.convert_dialogues_to_scenes(
    dialogues, 
    script_id, 
    script_name
)

# 3. 确保每个场景都有完整的triggers
# 每个场景自动添加: triggers: [{"type": "message"}]
```

### 方案2：增强格式检测 ✅

#### 2.1 对话文本识别
- 检查前10行是否匹配对话模式
- 如果至少3行匹配，识别为对话文本
- 使用专门的文本解析器处理

#### 2.2 格式类型分类
- `new_yaml`: 新格式YAML（无需转换）
- `old_yaml_list`: 旧格式列表
- `old_yaml_dict`: 旧格式字典
- `plain_text_dialogue`: 对话格式纯文本（新增）
- `plain_text`: 普通纯文本
- `markdown`: Markdown格式

### 方案3：改进转换算法 ✅

#### 3.1 增强AI转换提示词
- 明确要求必须包含所有必要字段
- **特别强调triggers必须包含type字段**
- 提供完整的YAML结构示例
- 区分纯文本和YAML格式的处理

#### 3.2 纯文本专门处理
- 优先使用TextParser解析纯文本
- 如果TextParser失败，降级到AI转换
- AI转换时使用专门的纯文本提示词

### 方案4：增强验证机制 ✅

#### 4.1 转换后验证
- 验证所有场景是否包含triggers
- **验证每个trigger是否包含type字段**
- 自动修复缺失的字段
- 生成详细的警告信息

#### 4.2 创建前验证
- 在创建剧本前进行完整验证
- 提供详细的错误信息
- 自动修复常见问题

#### 4.3 验证逻辑
```python
# 确保每个场景都有triggers
if "triggers" not in scene:
    scene["triggers"] = [{"type": "message"}]

# 确保triggers不为空
if len(scene["triggers"]) == 0:
    scene["triggers"] = [{"type": "message"}]

# 确保每个trigger都有type
for trigger in scene["triggers"]:
    if "type" not in trigger:
        trigger["type"] = "message"
```

## 功能升级详情

### 1. TextParser纯文本解析器

#### 支持的对话格式
1. **标准格式**：`角色: 内容`
2. **方括号格式**：`[角色] 内容`
3. **中文括号格式**：`【角色】内容`
4. **编号格式**：`1. 角色: 内容`

#### 编码支持
- UTF-8（推荐）
- GBK/GB2312（Windows记事本默认）
- Big5（繁体中文）
- Latin-1（备用）

#### 角色识别
- 自动识别常见角色（管理员、审核员等）
- 规范化角色名称
- 统计角色出现次数

### 2. 增强的格式检测

#### 检测流程
```
1. 检查是否为新格式YAML
   ↓ 否
2. 检查是否为旧格式YAML
   ↓ 否
3. 检查是否为Markdown
   ↓ 否
4. 检查是否为对话格式文本
   ↓ 是 → 使用TextParser
   ↓ 否
5. 尝试YAML解析
   ↓ 失败
6. 识别为普通纯文本 → 使用AI转换
```

### 3. 改进的转换算法

#### AI转换提示词改进
- 明确要求每个场景必须有triggers
- 强调每个trigger必须有type字段
- 提供默认值：`{"type": "message"}`
- 区分纯文本和YAML格式处理

#### 规则转换改进
- 为纯文本添加默认转换规则
- 确保每个场景都有完整的triggers
- 自动填充缺失的必填字段

### 4. 增强的验证机制

#### 验证项目
- ✅ script_id类型验证
- ✅ version类型验证
- ✅ scenes结构验证
- ✅ **每个场景的triggers验证**
- ✅ **每个trigger的type字段验证**
- ✅ responses结构验证
- ✅ 自动修复缺失字段

#### 自动修复
- 缺失triggers → 添加默认trigger
- triggers为空 → 添加默认trigger
- trigger缺少type → 添加type字段
- response缺少template → 尝试提取或添加空值

## 使用示例

### 示例1：标准对话格式
```
管理员: 欢迎加入我们的团队
审核员: 请完成以下任务
用户: 好的，我会完成的
```

**转换后**：
```yaml
script_id: converted_script
version: "1.0"
scenes:
  - id: scene_1
    triggers:
      - type: message
    responses:
      - template: 欢迎加入我们的团队
  - id: scene_2
    triggers:
      - type: message
    responses:
      - template: 请完成以下任务
```

### 示例2：方括号格式
```
[管理员] 欢迎加入
[审核员] 请完成任务
```

**转换后**：
```yaml
script_id: converted_script
version: "1.0"
scenes:
  - id: scene_1
    triggers:
      - type: message
    responses:
      - template: 欢迎加入
```

## 测试建议

### 测试场景1：标准.txt文件
1. 创建包含"角色: 内容"格式的.txt文件
2. 使用UTF-8编码保存
3. 上传文件并点击"智能转换"
4. **预期**：成功转换，每个场景都有完整的triggers

### 测试场景2：GBK编码文件
1. 使用Windows记事本创建.txt文件（GBK编码）
2. 包含中文对话内容
3. 上传并转换
4. **预期**：自动检测编码并正确转换

### 测试场景3：混合格式
1. 包含多种对话格式的文本
2. 上传并转换
3. **预期**：正确识别所有对话并转换

### 测试场景4：缺少type字段的YAML
1. 上传转换后但缺少type字段的YAML
2. 点击创建
3. **预期**：自动修复并成功创建

## 后续优化计划

### 短期优化（1-2周）
1. **批量转换支持**
   - 支持一次上传多个文件
   - 批量转换和验证

2. **转换预览**
   - 转换前后对比视图
   - 差异高亮显示

3. **转换历史**
   - 保存转换历史
   - 支持回滚

### 中期优化（1个月）
1. **更多格式支持**
   - DOCX文件解析
   - PDF文件解析（OCR）
   - HTML文件解析

2. **智能场景分割**
   - 根据对话内容自动分割场景
   - 识别对话主题变化

3. **自定义转换规则**
   - 用户自定义对话格式
   - 保存常用转换模板

### 长期优化（3个月+）
1. **AI增强识别**
   - 使用AI识别对话意图
   - 自动生成更合适的triggers

2. **多语言支持**
   - 支持更多语言的角色识别
   - 多语言对话格式

3. **实时转换**
   - 输入时实时预览转换结果
   - 即时验证和修复

## 总结

通过实施以上方案，系统现在能够：
- ✅ 正确识别和处理.txt纯文本文件
- ✅ 自动检测文件编码
- ✅ 识别对话格式并转换为结构化YAML
- ✅ 确保每个场景都有完整的triggers和type字段
- ✅ 自动修复缺失的字段
- ✅ 提供详细的错误提示和处理建议

这些改进确保了.txt文件能够成功转换并创建剧本。

