name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - List files to verify deploy.sh exists
        run: |
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== Listing scripts/server directory ==="
          ls -la scripts/server/ || echo "scripts/server directory not found"
          echo ""
          echo "=== Checking if deploy.sh exists ==="
          if [ -f "scripts/server/deploy.sh" ]; then
            echo "✅ deploy.sh found at scripts/server/deploy.sh"
            ls -lh scripts/server/deploy.sh
          else
            echo "❌ deploy.sh NOT found at scripts/server/deploy.sh"
            echo "Searching for deploy.sh..."
            find . -name "deploy.sh" -type f 2>/dev/null || echo "No deploy.sh found in repository"
          fi

      - name: Test SSH connection
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            echo "✅ SSH 連接測試成功"
            echo "服務器信息:"
            uname -a
            echo "當前目錄:"
            pwd

      - name: Upload deploy script to server (optional)
        uses: appleboy/scp-action@v0.1.7
        continue-on-error: true
        id: scp_upload
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          source: "scripts/server/deploy.sh"
          target: "/tmp"
          strip_components: 0
          debug: true

      - name: Execute deploy script (with fallback)
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        timeout-minutes: 50
        env:
          GITHUB_REPO: ${{ github.repository }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 40m
          script_stop: true
          debug: true
          envs: GITHUB_REPO,SERVER_HOST
          script: |
            echo "=== Checking uploaded files in /tmp ==="
            echo "Listing /tmp directory contents:"
            ls -la /tmp/ | grep -E "(deploy|script)" || ls -la /tmp/ | head -20
            echo ""
            echo "Searching for deploy.sh in /tmp:"
            DEPLOY_FILE=$(find /tmp -name "deploy.sh" -type f 2>/dev/null | head -1)
            if [ -n "$DEPLOY_FILE" ]; then
              echo "✅ Found deploy.sh at: $DEPLOY_FILE"
              ls -lh "$DEPLOY_FILE"
              echo ""
              echo "=== Copying to /tmp/deploy.sh ==="
              cp "$DEPLOY_FILE" /tmp/deploy.sh
              chmod +x /tmp/deploy.sh
              echo "✅ File ready at /tmp/deploy.sh"
            elif [ -f "/tmp/deploy.sh" ]; then
              echo "✅ /tmp/deploy.sh already exists"
              ls -lh /tmp/deploy.sh
              chmod +x /tmp/deploy.sh
            else
              echo "⚠️ deploy.sh NOT found in /tmp, trying to download from GitHub..."
              # 備用方案：直接從 GitHub 下載腳本
              if command -v curl >/dev/null 2>&1; then
                curl -o /tmp/deploy.sh -L "https://raw.githubusercontent.com/$GITHUB_REPO/main/scripts/server/deploy.sh" || {
                  echo "❌ Failed to download deploy.sh from GitHub"
                  echo "Full /tmp directory listing:"
                  ls -la /tmp/
                  exit 1
                }
              elif command -v wget >/dev/null 2>&1; then
                wget -O /tmp/deploy.sh "https://raw.githubusercontent.com/$GITHUB_REPO/main/scripts/server/deploy.sh" || {
                  echo "❌ Failed to download deploy.sh from GitHub"
                  echo "Full /tmp directory listing:"
                  ls -la /tmp/
                  exit 1
                }
              else
                echo "❌ Neither curl nor wget available, cannot download deploy.sh"
                exit 1
              fi
              chmod +x /tmp/deploy.sh
              echo "✅ Downloaded and prepared deploy.sh"
            fi
            echo ""
            echo "=== Running deploy script ==="
            bash /tmp/deploy.sh
