# 修复重复的 WebSocket location 配置

## 问题
Nginx 配置中有两个重复的 `location /api/v1/notifications/ws` 块，导致配置测试失败：
```
duplicate location "/api/v1/notifications/ws" in /etc/nginx/sites-enabled/aikz.usdt2026.cc:21
```

## 解决方案

### 方法 1：手动删除（推荐）

1. **SSH 连接到服务器：**
   ```bash
   ssh ubuntu@165.154.233.55
   ```

2. **编辑配置文件：**
   ```bash
   sudo nano /etc/nginx/sites-available/aikz.usdt2026.cc
   ```

3. **找到重复的配置块：**
   应该能看到两个 `location /api/v1/notifications/ws` 块：
   - 第一个（保留）：大约在第 87-99 行
   - 第二个（删除）：大约在第 101-114 行

4. **删除第二个配置块：**
   - 删除从 `# WebSocket 支持 - 通知服务` 注释开始
   - 到对应的 `}` 结束的整个块（包括注释）

5. **保存并退出：**
   - 按 `Ctrl+O` 保存
   - 按 `Ctrl+X` 退出

6. **测试配置：**
   ```bash
   sudo nginx -t
   ```

7. **重载 Nginx：**
   ```bash
   sudo systemctl reload nginx
   ```

### 方法 2：使用 sed 命令删除

```bash
# 备份
sudo cp /etc/nginx/sites-available/aikz.usdt2026.cc /etc/nginx/sites-available/aikz.usdt2026.cc.bak

# 找到第二个 location 块的行号
sudo grep -n 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 假设第二个在 102 行，删除从 101 行（注释）到 114 行（结束的 }）
sudo sed -i '101,114d' /etc/nginx/sites-available/aikz.usdt2026.cc

# 测试
sudo nginx -t

# 重载
sudo systemctl reload nginx
```

### 方法 3：使用 Python 脚本

运行修复脚本：
```bash
cd "E:\002-工作文件\重要程序\聊天AI群聊程序"
python deploy/fix_duplicate_simple.py
```

## 验证

修复后，执行以下命令验证：

```bash
# 1. 检查是否只有一个 location
sudo grep -c 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
# 应该输出: 1

# 2. 测试配置
sudo nginx -t
# 应该显示: syntax is ok

# 3. 查看最终配置
sudo grep -A 15 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
# 应该只显示一个 location 块
```

## 最终配置应该类似：

```nginx
location /api/v1/notifications/ws {
    proxy_pass http://127.0.0.1:8000/api/v1/notifications/ws;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_buffering off;
}
```

**注意：** 只应该有一个这样的块！

