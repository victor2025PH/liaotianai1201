# 502 錯誤 - Nginx 配置檢查

> **日期**: 2025-12-01  
> **狀況**: 後端服務正常，但網頁仍顯示 502

---

## 📊 診斷結果

- ✅ 後端服務正在運行（進程 ID: 980923）
- ✅ 後端健康檢查通過
- ✅ 端口 8000 正在監聽
- ❌ 網頁仍顯示 502

**結論**: 問題在 Nginx 配置或 Nginx 與後端的連接。

---

## 🔍 檢查 Nginx 配置

執行以下命令檢查 Nginx 配置：

```bash
echo "=== 檢查 Nginx 配置 ===" && \
echo "" && \
echo "【1】查找 Nginx 配置文件..." && \
ls -la /etc/nginx/sites-enabled/ && \
echo "" && \
echo "【2】檢查 proxy_pass 配置..." && \
sudo grep -r "proxy_pass" /etc/nginx/sites-enabled/ /etc/nginx/conf.d/ 2>/dev/null | head -20 && \
echo "" && \
echo "【3】檢查 Nginx 錯誤日誌..." && \
sudo tail -30 /var/log/nginx/error.log | grep -i "502\|bad gateway\|upstream\|connect" && \
echo "" && \
echo "【4】檢查 Nginx 訪問日誌..." && \
sudo tail -10 /var/log/nginx/access.log | tail -5
```

---

## 🔧 可能的問題和修復

### 問題 1: proxy_pass 指向錯誤

**檢查**:
```bash
sudo grep -A 10 "location.*api\|location.*/" /etc/nginx/sites-enabled/default
```

**修復**: 確保 `proxy_pass` 指向 `http://127.0.0.1:8000` 或 `http://localhost:8000`

### 問題 2: Nginx 配置語法錯誤

**檢查**:
```bash
sudo nginx -t
```

**修復**: 根據錯誤信息修復配置

### 問題 3: Nginx 未重載配置

**修復**:
```bash
sudo nginx -s reload
```

### 問題 4: 防火牆或 SELinux 問題

**檢查**:
```bash
sudo iptables -L -n | grep 8000
sudo getenforce  # 如果返回 Enforcing，可能是 SELinux 問題
```

---

## 🚀 完整檢查和修復命令

```bash
echo "=== Nginx 配置檢查和修復 ===" && \
echo "" && \
echo "【步驟 1】檢查 Nginx 配置語法..." && \
sudo nginx -t && \
echo "" && \
echo "【步驟 2】檢查 proxy_pass 配置..." && \
sudo grep -A 5 "proxy_pass" /etc/nginx/sites-enabled/* /etc/nginx/conf.d/* 2>/dev/null && \
echo "" && \
echo "【步驟 3】檢查 Nginx 錯誤日誌..." && \
sudo tail -20 /var/log/nginx/error.log && \
echo "" && \
echo "【步驟 4】測試後端連接（從 Nginx 角度）..." && \
curl -v http://127.0.0.1:8000/health 2>&1 | head -15 && \
echo "" && \
echo "【步驟 5】重載 Nginx 配置..." && \
sudo nginx -s reload && \
echo "✅ Nginx 配置已重載" && \
echo "" && \
echo "【驗證】測試網頁訪問..." && \
echo "請在瀏覽器中訪問後台，檢查是否還有 502 錯誤"
```

---

**執行上述命令，告訴我結果！**
