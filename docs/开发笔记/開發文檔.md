# Smart TG Business AI 開發文檔與升級方案

- [1. 系統概述](#系統概述)
- [2. 核心架構](#核心架構)
- [3. 執行流程](#執行流程)
- [4. 功能模組詳解](#功能模組詳解)
- [5. 數據存儲與結構](#數據存儲與結構)
- [6. 外部依賴與運行環境](#外部依賴與運行環境)
- [7. 部署與配置建議](#部署與配置建議)
- [8. 日誌、監控與備份](#日誌監控與備份)
- [9. 已知問題與風險](#已知問題與風險)
- [10. 升級方向總覽](#升級方向總覽)
- [11. 升級方案設計](#升級方案設計)
- [12. 風險與緩解計畫](#風險與緩解計畫)
- [13. 測試策略與質量保障](#測試策略與質量保障)
- [14. 後續待辦與建議](#後續待辦與建議)
- [15. 附錄](#附錄)

## 系統概述
Smart TG Business AI 是面向 Telegram 與多平台擴展的真人化業務聊天與分身矩陣系統。核心目標為支援批量好友拓展、智能對話、標籤成長、語音表情輸出、數據雙視圖管理與自動備份，並預留多平台接入能力。

## 核心架構
- **應用入口層**：`main.py` 以 Pyrogram 建立 Telegram Bot/Client，負責事件循環與消息處理。
- **配置層**：`config.py` 定義路徑常量、第三方 API 憑證、風控參數與 YAML 內容池入口，並負責目錄初始化。
- **業務模組層 (`utils/`)**：
  - 聊天上下文與資料庫管理：`ai_context_manager.py`、`db_manager.py`
  - Prompt 與 AI 交互：`prompt_manager.py`、`business_ai.py`
  - 用戶運營工具：`friend_auto_add.py`、`friend_greet.py`、`auto_batch_greet_and_reply.py`、`tag_analyzer.py`
  - 媒體輸出：`tts_voice.py`、`emoji_manager.py`
  - 配套工具：`excel_manager.py`、`logger.py`、`yaml_config.py` 等
- **資料層**：SQLite (`data/chat_history.db`) 及 Excel (`data/friends.xlsx`) 同時維護用戶與對話資訊。
- **內容池層**：`ai_models/` 內以 YAML 管理身份、Few-shot、FAQ 等靈活配置。

### 概念架構圖（文字）
```
Telegram Client (Pyrogram)
    └─ 主事件循環 (main.py)
        ├─ 配置/常量 (config.py)
        ├─ 聊天上下文 & DB (ai_context_manager.py / db_manager.py)
        ├─ Prompt 組合與 OpenAI 調用 (prompt_manager.py / business_ai.py)
        ├─ 多媒體輸出 (tts_voice.py / emoji_manager.py)
        ├─ 運營任務 (friend_auto_add.py / friend_greet.py / tag_analyzer.py / auto_backup.py)
        └─ 日誌與備份 (logger.py / auto_backup.py)
```

## 執行流程
1. **啟動初始化**：`main.py` 啟動時載入 `config.auto_init_dirs()`、`auto_init_db()`、`auto_init_excel()` 及 YAML 模板。
2. **事件註冊**：利用 Pyrogram `Client` 註冊私訊消息處理器。
3. **消息處理**：
   - 讀取或初始化用戶資料 (`get_user_profile`)。
   - 狀態機判斷是否處於等待姓名狀態，必要時調用識名模型。
   - 正常對話流程時寫入歷史、構建 Prompt、調用 OpenAI 生成回覆，並拆句；預設僅發送文字，必要時附帶 TTS 語音（每小時最多 10 條，除非使用者明確要求語音回覆）。
   - 若使用者主動要求語音，系統會忽略當前語音次數上限並生成一段自然語音（透過 TTS 合成）；若語音生成失敗則回退至純文字並記錄日誌。
   - 若使用者詢問「你是不是機器人」等，系統會直接以真人口吻否認並記錄對話歷史，避免交由大模型回覆造成暴露風險。
4. **日誌與錯誤處理**：透過 `logger` 模組記錄操作與錯誤。
5. **拓展任務**：其他腳本（好友自動添加、批量歡迎、標籤分析、定時備份）以獨立模組觸發。

```49:108:main.py
    @app.on_message(filters.private & filters.incoming)
    async def handle_private_message(client, message):
        ...
        if current_state == 'waiting_for_name':
            ...
            extracted_name = await ai_extract_name_from_reply(text)
        ...
        ai_reply = await ai_business_reply(user_id, user_profile, use_name_in_prompt=use_name_in_prompt)
        short_sentences = split_reply_sentences(ai_reply, max_len=2)
        for short_reply in short_sentences:
            await message.reply(short_reply)
        tts_text = generate_tts_text(ai_reply, max_len=3)
        tts_path = await generate_voice(tts_text, voice="onyx")
        ...
```

## 功能模組詳解

### 4.1 配置與全域常量 (`config.py`)
- 定義工程根目錄、資料/備份/靜態資源位置。
- 保存 Telegram API、OpenAI、騰訊 API 憑證與業務風控參數。
- 自動初始化必要目錄。
- 新增 `TELEGRAM_SESSION_STRING`／`TELEGRAM_SESSION_FILE` 支援無頭 Session 管理；並將 `ADD_FRIENDS_RATE_PER_MINUTE`、`GREET_RATE_PER_MINUTE`、`AUTO_REPLY_RATE_PER_MINUTE`、`TAG_ANALYZE_RATE_PER_MINUTE` 及各項輪詢間隔 (`AUTO_GREET_INTERVAL_SECONDS` 等) 外置為可配置參數，便於依照真人運營節奏調整節流。
- **安全風險**：憑證硬編碼于檔案中，需優先整改。

### 4.2 聊天上下文與資料層
- **`db_manager.py`**：建立 `users`、`chat_history`、`tags` 三張表，提供新增用戶、更新 profile、匯出 Excel 等操作。
- **`ai_context_manager.py`**：負責聊天紀錄初始化與 CRUD，雖採 `async def` 包裝，但實際呼叫同步 `sqlite3`，在事件循環中可能造成阻塞。
- **`excel_manager.py`**：維護雙語表頭 Excel，支援初始化、匯入匯出與資料同步。

### 4.3 Prompt 與 AI 呼叫
- **`prompt_manager.py`**：組裝身份設定、Few-shot、重複問候處理、TTS 模板等。
- **`business_ai.py`**：使用 `AsyncOpenAI` 呼叫對話模型、回覆優化與冷場策略；另以較便宜模型完成姓名抽取。

#### 4.3.1 多輪話術與語感標記升級
- `dialogue_scene_scripts.yaml` 新增 `warmup_story_share`、`soft_pitch_sequence`、`interest_followup`、`after_trial_checkin`、`hesitation_reassure` 等場景，強化破冰第二輪、柔性導流、體驗後關懷與猶豫安撫。
- Prompt 組裝時會隨機抽取「Topic Inspirations」提供 2-3 個生活化話題 Seed，避免重複套話。
- 新增 `tone_markers`（warmup / regular / bridge_interest / ack_voice / comfort / story_mode / honor_request），由 `build_dynamic_prompt` 依對話階段、觸發意圖、語音情境自動串入「Tone Guide」，指引模型控制語速與情緒。
- Few-shot 範例同步補進「猶豫是否要玩」與「完成後如何回報」場景，確保模型理解最新腳本。
- `generate_tts_text` 會根據語境產生節奏化句子、自然語助詞與 `hint`，並輸出建議 voice；`tts_voice.generate_voice` 加入淡入淡出、底噪與語速微調，使輸出更貼近真人。
- 新增 `tools/voice_script_builder.py`，支援 `[pause 0.6]`、`[smile]` 等標記轉換為最終語音稿，方便營運編寫真人錄音或進階 TTS 指令。

### 4.4 用戶運營與自動化
- **好友拓展**：`friend_auto_add.py` 與 Excel 結合批量加好友，成功後同步 DB 與 Excel。
- **歡迎與陪伴**：`friend_greet.py` 執行自動歡迎詞與成長關懷。
- **批量問候/回覆**：`auto_batch_greet_and_reply.py` 結合 Excel 狀態執行問候與未讀回覆。
- **標籤分析**：`tag_analyzer.py` 根據關鍵詞自動補全標籤；現已改為 async 版本並透過 `update_user_tag_async` 寫回資料庫。
- `main.py` 內建 `BackgroundTaskManager`，啟動後會以 `asyncio.create_task` 並行執行歡迎、批量問候、標籤分析與備份排程，並針對例外自動重啟；相關速率與輪詢間隔透過 `.env` 調控。

```1:40:utils/tag_analyzer.py
from utils.db_manager import get_user_history, update_user_tag
...
    update_user_tag(user_id, ",".join(all_tags))
```

### 4.5 媒體輸出
- **`tts_voice.py`**：透過 OpenAI TTS 生成語音，寫入 `voices/`，使用 executor 避免阻塞。
- **`emoji_manager.py`**：掃描表情分組資料夾，自動推算表情資源與觸發頻率。
- **媒體輸出**：`tts_voice.py`（TTS 語音合成）、`emoji_manager.py`、`utils/speech_to_text.py`（語音轉寫）。

### 4.6 內容池 (`ai_models/intro_segments.yaml`)
- 提供身份敘述、Few-shot、商務 FAQ、冷場話術、禁止詞等，支援後續擴充。

### 4.7 日誌管理 (`utils/logger.py`)
- 控制台與日誌檔案雙寫；使用 `TimedRotatingFileHandler` 保留 30 天。

### 4.8 備份模組 (`utils/auto_backup.py`)
- `backup_once()` 支援單次備份並回傳檔案路徑；`schedule_auto_backup()` 以 asyncio 排程週期備份，支援 `stop_event` 與驗證回調。`main.py` 啟動時自動掛載排程任務，備份完成會在 log 中記錄輸出路徑。

## 數據存儲與結構
- **SQLite (`chat_history.db`)**：
  - `users(user_id, first_name, nickname, tags, bio, remark, country, add_time, recent_chat, friend_status)`
  - `chat_history(id, user_id, timestamp, role, content)`
  - `tags(tag_id, user_id, tag, create_time)`
- **Excel (`friends.xlsx`)**：欄位包含 `用户ID(user_id)`、`昵称(nickname)`、`标签(tags)`、`入库时间(add_time)`、`最新对话(recent_chat)`、`好友分组(friend_status)`。
- **語音與表情資源**：`voices/` 動態生成語音，`photos/xiaotong/emoji/` 管理表情池。

## 外部依賴與運行環境
- **Python 套件**：Pyrogram、OpenAI (>=1.3.7)、pandas、openpyxl、aiohttp、httpx、schedule、python-telegram-bot 等。
- **平台 API**：
  - Telegram：需 `api_id`、`api_hash`、session。
  - OpenAI：chat 與 TTS 服務。
  - 騰訊雲 API 憑證現存但尚未使用。
- **環境需求**：建議 Python 3.10+，具備 sqlite3、ffmpeg（若後續音訊處理需用）。

## 部署與配置建議
- 將 `config.py` 中敏感資訊改為環境變數或 `.env` 檔；程式於啟動時讀取。
- 配置虛擬環境並安裝 `requirements.txt`。
- `.env` 需新增 Telegram Session 字串/檔案參數與節流、輪詢設定；多實例部署時請依實際配額調整上限。
- 本地開發需安裝 `pre-commit` 與 `detect-secrets`，並執行 `pre-commit install` 以自動阻擋敏感資訊提交。
- 版本升級前執行 `python -m scripts.run_migrations`，自動備份並套用資料庫遷移。
- 建議使用 systemd / PM2 / Docker 進行守護進程部署，並確保 `voices/`、`logs/`、`backup/` 存儲空間。
- 使用反向代理或 Bastion 主機保護 Telegram Session 憑證。
- 若監控負載高，需配置 Redis 或外部訊息佇列以分流。

## 日誌監控與備份
- 日誌：`logs/bot.log` 每日輪替，建議外掛 ELK / Loki 進行集中管理。
- 備份：`auto_backup.schedule_auto_backup()` 已由主流程啟動，支援 stop event 與 validator；備份成果會在 log 中標註輸出檔案，建議搭配雲端或 NAS 做二次備援。
- 監控建議：增加 Prometheus 指標或自訂 webhook 監控異常。

## 已知問題與風險
- **缺失函式**：`db_manager.py` 無 `update_user_tag` 實作，導致 `friend_greet.py`、`tag_analyzer.py` ImportError（阻塞相關功能）。
- **憑證硬編碼**：OpenAI、Telegram、騰訊憑證暴露於庫中，存在重大安全與合規風險。
- **同步 IO 阻塞**：資料庫操作在 async 路徑中使用同步 `sqlite3`，大量並發時可能阻塞事件循環。
- **錯誤處理不足**：AI 調用、TTS 生成錯誤時缺乏重試、降級策略。
- **測試缺口**：缺少單元測試、整合測試與自動化驗證。
- **多平台延展性**：目前僅實作 Telegram 流程，多平台支援仍為規劃階段。
- **備份未啟動**：主程式未啟動備份執行緒，可能導致數據未被定期備份。

## 升級方向總覽
- **安全合規**：憑證管理、權限控制、日誌脫敏。
- **架構穩定性**：非阻塞資料層、任務佇列化、配置中心化。
- **智能體驗**：Prompt 引擎優化、模型升級、多模態輸出。
- **運營效率**：多平台整合、自動打標/CRM、可視化後台。
- **運維體系**：自動化部署、告警監控、備份策略強化。

## 升級方案設計

### 11.1 架構與可靠性升級
| 里程碑 | 週期 | 主要內容 |
| --- | --- | --- |
| Phase 0：安全基線 | 第 1 週 | 移除硬編碼憑證、導入 `.env`；掃描密鑰外洩；建立基礎權限策略 |
| Phase 1：資料層優化 | 第 2-3 週 | 將 sqlite 操作切換至異步連線池 (aiosqlite) 或外部 DB；補實 `update_user_tag`；加上 transaction 與索引；導入遷移腳本 |
| Phase 2：任務佇列化 | 第 4-5 週 | 將 TTS、備份、批量歡迎等長任務移至背景工作 (Celery/Redis 或 asyncio task queue)；加入重試與告警 |
| Phase 3：配置與模組化 | 第 6 週 | 建立配置中心；拆分平台介面抽象層，準備多平台接入；撰寫 API interface contract |

### 11.2 智能體驗升級
- **Prompt 管理後台**：建立 YAML 熱更新與 Web 管理面板，支援版本化。
- **模型策略**：評估 OpenAI gpt-4.1 / gpt-4o-mini 或本地 LLM；建立多模型路由（輕量姓名抽取 vs 核心對話）。
- **語音與表情**：引入多語音庫、聲紋切換；表情池 AI 分類與自動標籤。
- **對話記憶**：整合摘要與長期記憶數據，過濾敏感內容。

### 11.3 多平台與運營增強
- **平台抽象層**：定義 `ChannelAdapter` 介面實作 Telegram / WeCom / WhatsApp。
- **CRM 與數據視圖**：建置 Web dashboard，整合標籤、互動頻率、AI 建議。
- **自動化任務**：支援日程提醒、群發策略、成長劇本引擎。

### 11.4 安全與合規
- 導入 Secrets Manager（如 AWS Secrets Manager / Vault）。
- 建立審計日誌與敏感詞監測。
- 建置 GDPR/個資合規流程（刪除請求、自動匿名化）。
- 自動化備份加密與跨區域災備演練。

### 11.5 交付節點
- **每階段交付**：技術文檔、部署腳本、回歸測試報告。
- **驗收指標**：API 成功率、消息延遲、任務吞吐、備份成功率、憑證掃描結果。

### 11.6 Session 帳號紅包遊戲互動方案

#### 背景說明
- 既有紅包遊戲機器人以 Bot 身份執行設定與結算，缺乏真人化互動與群內帶動氛圍，營運希望藉由多名真人分身提高黏著。
- 需求為讓 Telegram Session 帳號（非 Bot）加入遊戲，同步在群組內聊天、主持與搶紅包，打造更自然的互動體驗。
- Session 帳號需遵守 Telegram 規範，控制自動化節奏並安全保存 `.session` 檔案，同時與現有主系統保持協調，避免互相干擾。

#### 技術方案概要
- **角色定位**：Session 帳號扮演真人分身，可依場景充當普通玩家或主持人，參與紅包活動與群聊互動。
- **互動框架**：
  - 建立獨立的 `Session Interaction Service`（SIS）管理多帳號登入、監聽與調度。
  - 現有紅包 Bot 保留遊戲設定與獎勵結算；透過中介層（REST API / Message Queue）與 SIS 溝通。
  - SIS 監聽群組訊息，解析紅包事件或指令，指派帳號執行聊天回覆、搶包與公告，並回報結果給 Bot。
- **核心模組**：
  1. Session 生成與匯入：CLI/工具輸入 `api_id`、`api_hash`、手機門號，生成 `.session` 並加密儲存；支援批量導入與狀態標記。
  2. 帳號池管理：維護帳號資訊、節流參數、角色標籤；偵測登入失效或受限並通知重登。
  3. 群組互動：多帳號併發監聽群訊，依策略（輪詢、權重、主持列表）決定回覆帳號並控制發言頻率。
  4. 紅包調度：接收遊戲啟動事件，執行搶包流程、回傳結果、發布排行榜；處理延遲、重試與異常紀錄。
  5. 監控與安全：紀錄操作日誌、收斂 API 429/420、提供告警與分析報表。
- **資料流**：群組 → Bot → 中介層 → SIS → Session 帳號；SIS → 中介層 → Bot，形成閉環協調。
- **安全措施**：Session 檔案加密儲存、權限分級、節流控制、遵循官方 ToS 避免大量自動化造成封鎖。

#### 預期目標
- 支援 ≥10 個 Session 帳號同時在線並參與指定群組紅包遊戲。
- 紅包觸發至 Session 回應延遲 < 2 秒；結果公告延遲 < 5 秒。
- 建立完整的帳號管理、錯誤監控與重登入流程，確保服務穩定。
- 提供可量測指標（每日互動次數、紅包參與率等）給營運分析。

#### 開發里程碑與節點計畫（啟動日：2025-11-12）
- **Week 1：環境搭建與 Session 管理**
  - 目標：完成 Session 生成工具、帳號資料庫 Schema、登入驗證流程。
  - 交付：`Session Interaction Service` 初版架構、CLI 生成／匯入腳本、帳號狀態看板（CLI 或 API）。
  - 每日追蹤：登入成功/失敗統計、節流參數調整、日誌與安全基線確認。
  - 週末評審：驗證 ≥3 個帳號穩定登入並保持在線。
- **Week 2：多帳號群組互動骨幹**
  - 目標：實作群訊監聽、訊息路由、角色調度；建立中介層 API 與紅包 Bot 初步對接。
  - 交付：Session 帳號回應基本指令；中介層事件流；簡易策略（輪詢／權重）配置。
  - 每日追蹤：訊息延遲監控、API 429 日誌、協程並發調校。
  - 週末評審：在沙箱群組完成 Session 帳號互動示範（問候、回覆、主持）。
  - 工作拆解：
    1. W2-1 任務拆解與週內里程碑：細化多客戶端啟動、訊息路由、策略調度的子任務與交付。
    2. W2-2 Session Client Pool 原型：實作用於同時啟動多個 Pyrogram Client 的模組，處理登入、重連與並發事件。
    3. W2-3 中介層事件模型：定義 Bot ↔ Session 服務之間的事件格式（JSON schema）、傳輸方式（REST/Message Queue）、錯誤回報流程。
    4. W2-4 訊息調度與節流設計：確立輪詢／權重／主持帳號策略，設定 per-account 與 per-group 節流參數，並撰寫對應測試案例。
- **Week 3：紅包遊戲整合與併發優化**
  - 目標：接入紅包事件；實作搶包流程、結果回報、排行榜公告；強化節流與異常處理。
  - 交付：紅包搶包端到端流程、遊戲狀態儲存（Redis/DB）、錯誤重試策略。
  - 每日追蹤：記錄紅包觸發→回應耗時，調整重試與退回機制。
  - 週末評審：完成 ≥5 帳號、≥3 場紅包遊戲測試，產出生效報告。
  - 工作拆解：
    1. W3-1 任務規劃與測試里程碑：明確紅包事件處理流程、端到端測試條件與量化指標。
    2. W3-2 紅包事件整合：實作 SIS 接收 Bot 的 `redpacket.event`，調度 Session 帳號執行搶包、公告、結果回報。
    3. W3-3 併發與節流優化：調整 RateLimiter 與重試策略，建立模擬場景（多帳號同時搶包、FloodWait、API 錯誤）。
    4. W3-4 端到端測試與報告：至少 5 帳號、3 場紅包遊戲，記錄耗時、成功率與異常處理，匯整成果。
- **Week 4：測試、部署與營運支持**
  - 目標：撰寫自動化/壓力/異常恢復測試；完成部署手冊與運維 SOP；建立監控告警。
  - 交付：測試報告、部署腳本、營運手冊、正式上線版本。
  - 每日追蹤：測試進度、缺陷修復、營運環境準備。
  - 週末評審：最終評估會議，確認上線策略與後續優化路線。
  - 工作拆解：
    1. W4-1 測試與部署交付規劃：統整本週交付項目、定義測試與部署里程碑。
    2. W4-2 自動化與壓力測試：撰寫涵蓋 Session 互動與紅包流程的測試腳本，並執行壓力/異常恢復測試。
    3. W4-3 部署腳本與 SOP：提供 Docker / shell 腳本、環境設定流程、緊急回滾步驟。
    4. W4-4 監控告警與上線報告：設立指標監控（登入狀態、事件延遲、錯誤率）、建立告警機制並整理上線報告。

#### 追蹤與評審機制
- **每日進度追蹤**：採 stand-up / 共用看板模式，紀錄當日完成事項、阻礙與隔日計畫。
- **每週評審會議**：固定週五審視量化指標（登入成功率、訊息延遲、測試覆蓋率）與風險緩解成效，調整下一週計畫。
- **關鍵檢核點**：
  1. Week 1 末：Session 登入流程、安全基線確認。
  2. Week 2 末：群組互動骨幹與中介層通訊穩定。
  3. Week 3 末：紅包遊戲整合延遲與成功率達標。
  4. Week 4 末：測試與部署流程通過、監控告警就緒。

## 風險與緩解計畫
- **資料遷移風險**：制定備援機制，遷移前冷備份；提供回滾腳本。
- **API 成本上升**：引入模型路由與訊息分級策略，必要時整合自建模型。
- **多平台複雜度**：模組化 adapter，先行 PoC Telegram→WeCom，再擴展。
- **運營合規**：與法務評估自動加好友、批量消息的地區限制。

## 測試策略與質量保障
- **單元測試**：覆蓋資料層、Prompt 組裝、任務排程。
- **整合測試**：使用 Telegram sandbox 模擬對話流程。
- **負載測試**：模擬高併發消息，驗證事件循環與資料庫阻塞。
- **安全測試**：憑證掃描、敏感資料檢測、API 權限測試。
- **回歸流程**：建立 CI/CD，於 merge 前自動執行 `python -m pytest --cov=utils --cov-report=term-missing`，確保整體覆蓋率維持 80% 以上並納入備份排程用例。

## 後續待辦與建議
- 實作 `update_user_tag` 並檢查相關調用。
- 將憑證移至環境變數，並更新部署文檔。
- 啟用 `auto_backup.start_backup_thread()`，並加入排程控制。
- 編寫完整 README（啟動指令、環境配置、任務說明）。
- 補充資料庫索引（`users.tags`、`chat_history.user_id` 等）。
- 設計異常告警（Webhook/Slack/Telegram 自身告警）。
- 使用者帳號模式暫以純文字推送群組/網站/機器人連結，待後續切換 Bot Token 或雙 Client 架構後恢復 Inline Button，並評估訊息頻率與權限。
- 補強語音請求測試腳本，驗證 TTS 合成在高峰時段與強制語音情境下的穩定性。

## 檔案與模組一覽

| 檔案 / 目錄 | 主要功能 | 關聯模組 / 使用場景 |
|-------------|-----------|-----------------------|
| `main.py` | 建立 Pyrogram Client，處理 Telegram 訊息（文字、語音、圖片）並串接 STT / Vision / AI 回覆。 | 呼叫 `utils.speech_to_text`、`utils.business_ai`、`utils.ai_context_manager`，應用於所有即時對話。 |
| `config.py` | 讀取 `.env`、設定路徑及第三方金鑰，並初始化目錄。 | 被所有模組引用作統一配置來源。 |
| `docs/` | 專案文檔、環境設定樣板、安全規範。 | 內部維運、部署與安全遵循。 |
| `data/` | SQLite (`chat_history.db`) 與使用者名單 (`friends.xlsx`). | 對話紀錄查詢、CRM 相關工具。 |
| `utils/ai_context_manager.py` | 管理對話歷史 CRUD、輪次計算。 | 給 `main.py`、`business_ai` 讀寫上下文。 |
| `utils/business_ai.py` | 組合 prompt、呼叫 OpenAI 生成回覆，整合圖片分析。 | 依賴 `utils.prompt_manager` 與 `config`; 對話核心。 |
| `utils/prompt_manager.py` | 人格設定、話術模板、場景腳本、TTS 文本生成。支援 YAML 外部化與多語。 | 被 `business_ai`、`main.py` 使用；`tools/dialogue_scene_editor.py` 編輯。 |
| `utils/speech_to_text.py` | 語音轉文字：非阻塞 ffmpeg 正規化、主/備模型切換、詳細錯誤回傳。 | `main.py` 處理語音訊息；`bot_stt.py`、`tmp_stt.py` 單獨測試。 |
| `utils/media_utils.py` | 將音訊正規化為 16kHz mono WAV，並提供檔案清理。 | `utils.speech_to_text` 的前處理。 |
| `utils/db_manager.py` | 使用 aiosqlite 管理使用者資料表與標籤更新。 | 由 `main.py` 及其他運營工具呼叫。 |
| `utils/logger.py` | 封裝 logging 設定，提供檔案 / 控制台輸出。 | `main.py` 啟動時設定統一日誌格式。 |
| `utils/auto_*` (`auto_backup`, `auto_batch_greet_and_reply`, `friend_auto_add`, `friend_greet`) | 附加運營腳本：自動備份、批量招呼、好友管理。 | 定時任務或手動啟動的營運流程。 |
| `utils/excel_manager.py` | 讀寫 Excel 名單，結合 asyncio 執行緒調度。 | 使用者基本資料與 CRM 標籤同步。 |
| `utils/emoji_manager.py` | Emoji 相關工具與貼圖管理。 | 對話回覆中插入表情符號。 |
| `utils/tag_analyzer.py` | 分析對話標籤與使用者群體。 | 運營報表與用戶分層。 |
| `utils/tts_voice.py` | 封裝 OpenAI TTS 呼叫，輸出語音檔。 | `main.py` 回覆語音、`business_ai` 情緒化語音。 |
| `utils/yaml_config.py` | YAML 內容初始化與存取小工具。 | 提供 `prompt_manager` 與其他模組載入模板。 |
| `scripts/run_migrations.py` | 資料庫備份與遷移流程（版本控制、備份目錄）。 | 每次部署或 schema 變更前執行。 |
| `scripts/login.py` | 協助 Pyrogram session 登入，支援驗證碼流程。 | 重新建立 Telegram session、處理權限錯誤。 |
| `tools/validate_dialogue_yaml.py` | 驗證 `dialogue_scene_scripts.yaml` 結構。 | Dev/PM 調整話術後執行，確保格式正確。 |
| `tools/dialogue_scene_editor.py` | CLI 編輯話術（列出、增刪場景）。 | 非工程使用者維護腳本與多語內容。 |
| `tools/voice_script_builder.py` | 將含 `[pause]` / `[smile]` 等標記的語音稿轉換為最終 TTS 文字。 | 協助營運撰寫真人或合成語音稿，保持節奏一致。 |
| `bot_stt.py` | 單獨測試 STT 模組，指定音訊檔輸出轉寫結果。 | 排查語音辨識問題、驗證模型授權。 |
| `inspect_session.py` / `tmp_*` | 臨時調試腳本、產生測試音訊。 | 本地除錯使用，不建議納入正式流程。 |
| `voices/` | 儲存語音輸出檔案與範例音訊。 | 提供回覆語音或測試 STT。 |
| `downloads/` | 存放 Telegram 下載的圖片、語音原始檔。 | STT 與 Vision 的輸入來源。 |
| `logs/` | `bot.log` 等日誌檔案。 | 啟動/錯誤追蹤、營運檢視。 |

> 註：`backup/`、`static/`、`photos/` 為資料資源或保留目錄，未主動執行程式碼。

### 語音訊息處理流程
- **下載與正規化**：`main.py` 收到語音後會下載檔案，交由 `utils.speech_to_text.transcribe_audio`；該函式透過 `asyncio.to_thread` 執行 `normalize_audio`，以 ffmpeg 轉成 16kHz/Mono WAV，避免阻塞 Pyrogram 事件迴圈。  
- **主/備模型切換**：`transcribe_audio` 先以 `OPENAI_STT_PRIMARY`（預設 `gpt-4o-mini-transcribe`）呼叫 OpenAI STT API，若失敗或回傳空值，會帶著錯誤資訊自動切換至 `OPENAI_STT_FALLBACK`（預設 `whisper-1`），並回傳 `{"text", "model", "language", "error"}` 的結構化結果。  
- **品質檢測與重錄提示**：`main.py` 會根據語音時長與檔案大小判斷品質（過短 / 過長 / 過大），若不符合門檻會立即回覆提示訊息，請使用者重新錄製，並避免把不完整的內容送入 AI。  
- **上下文銜接**：`main.py` 取得轉寫內容後，會將文字與模型資訊寫入 `context_info` 供 `ai_business_reply` 使用，並將成功結果以 `[語音轉文字]` 形式寫入 `chat_history`；若有品質問題則記錄 `[語音品質異常: issue]` 方便追蹤。  
- **主動語音策略**：依據對話輪次、是否鏡像回覆語音、文字長度及使用者強制要求等條件，由 `decide_voice_strategy()` 評估是否啟動語音回覆，並於日誌中記錄策略原因；同時遵守每小時最多 10 則語音與可選的全域開關。  
- **工具測試**：`bot_stt.py` 與 `tmp_stt.py` 可單獨測試 STT，輸出選用模型與錯誤訊息，方便排查權限或音訊品質問題。
- **影片音訊抽取**：若使用者傳送短影片或動畫，系統會抽取音訊、同樣套用品質檢測與轉寫流程，歷史中會記錄 `[影片轉文字]` 結果，若音訊抽取失敗則回覆提示訊息。  

### 圖片識別流程
- **資料蒐集**：`main.py` 下載用戶圖片至 `downloads/`，並將語境（歷史摘要、對話階段、觸發意圖）透過 `context_info` 傳給 `utils.business_ai.analyze_image_message`。  
- **Responses API**：`analyze_image_message` 採用 OpenAI Responses 介面上傳 `data URI`，並逐段解析 `resp.output[..].content[..].text`，避免舊版 `output_text` 失效。  
- **模型授權**：`OPENAI_VISION_MODEL` 預設 `gpt-4o-mini`，若帳戶未開通會收到 401/403。程式會自動嘗試 `gpt-4o-mini` 候選並在 log 中記錄錯誤，仍無法成功時回傳 `NO_REPLY`，主流程因此不會回覆。  
- **分類與回覆策略**：Vision 輸出 JSON，區分 `chat_screenshot`、`person_photo`、`poster_or_promo`、`other_scene`。對於截圖／人物照會記錄關鍵資訊與失敗原因並僅在能分析時回覆；若判定與當前話題無關，系統僅留作上下文而不回覆用戶。  
- **內容判斷**：若模型回傳空字串或判定圖片與對話無關，會轉為 `NO_REPLY` 以免產生無意義回覆；正常結果則記錄在日誌與歷史，後續提示詞可引用。

## 附錄

### A. 主要檔案一覽
- `main.py`：Telegram Client 主入口。
- `config.py`：全局配置與目錄初始化。
- `utils/`：
  - `ai_context_manager.py`、`db_manager.py`、`excel_manager.py`
  - `prompt_manager.py`、`business_ai.py`
  - `friend_auto_add.py`、`friend_greet.py`、`tag_analyzer.py`
  - `tts_voice.py`、`emoji_manager.py`、`auto_backup.py`、`logger.py`
- `ai_models/`：`intro_segments.yaml`、`dialogue_scene_scripts.yaml`（場景話術配置）
- `data/`：`chat_history.db`、`friends.xlsx`
- `backup/`、`logs/`、`voices/`：備份、日誌、語音資源。
- `tools/validate_dialogue_yaml.py`：場景話術 YAML 驗證工具。
- `tools/dialogue_scene_editor.py`：場景話術管理工具（list / add / new / remove）。

### B. 敏感配置示意
```19:34:config.py
API_ID = 17478348
API_HASH = "..."  # 建議改為環境變數
OPENAI_API_KEY = "sk-proj-...redacted..."
TENCENT_SECRET_ID = "..."
TENCENT_SECRET_KEY = "..."
```

---

本文件旨在提供全面系統理解、現況診斷與升級路徑，落實後可顯著提升安全性、可維運性與業務擴展能力。

