# 分配剧本问题 - 服务启动和日志查看指南

## 问题

分配剧本时显示"账号不存在"错误（404），需要查看后端日志来诊断问题。

## 快速启动服务

### 方法1：一键启动脚本（推荐）

```bash
bash ~/liaotian/deploy/强制启动并诊断服务.sh
```

这个脚本会：
- 清理所有旧进程
- 启动后端服务（端口 8000）
- 启动前端服务（端口 3000）
- 验证代码修复
- 显示服务状态

### 方法2：手动启动

#### 启动后端

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f 'uvicorn.*app.main:app' || true
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &
```

#### 启动前端

```bash
cd ~/liaotian/saas-demo
pkill -f 'next.*dev|node.*3000' || true
nohup npm run dev > /tmp/frontend.log 2>&1 &
```

## 查看日志

### 查看实时日志（分配剧本相关）

```bash
bash ~/liaotian/deploy/查看分配剧本实时日志.sh
```

或者直接使用：

```bash
tail -f /tmp/backend_final.log | grep -E "MIDDLEWARE|UPDATE_ACCOUNT|server_id|账号ID匹配|639277358115"
```

### 查看所有后端日志

```bash
tail -f /tmp/backend_final.log
```

### 查看最近50行日志

```bash
tail -50 /tmp/backend_final.log
```

### 搜索特定账号

```bash
grep "639277358115" /tmp/backend_final.log
```

## 测试步骤

1. **确保服务运行**：
   ```bash
   ps aux | grep -E 'uvicorn|next.*dev' | grep -v grep
   ```

2. **查看日志**：
   ```bash
   tail -f /tmp/backend_final.log | grep -E "MIDDLEWARE|UPDATE_ACCOUNT|server_id|账号ID匹配"
   ```

3. **在浏览器中操作**：
   - 刷新页面（Ctrl+Shift+R）
   - 选择账号并点击"分配剧本"
   - 选择剧本和角色
   - 点击"分配剧本"

4. **观察日志输出**：
   应该看到类似以下日志：
   ```
   [MIDDLEWARE] PUT 请求到达: /api/v1/group-ai/accounts/639277358115
   [UPDATE_ACCOUNT] 收到更新賬號請求: account_id=639277358115
   [UPDATE_ACCOUNT] server_id=computer_001
   开始扫描服务器 computer_001
   扫描结果: 找到 X 个账号
   账号ID列表: ['639277358115', ...]
   账号ID匹配: 目标='639277358115', 类型=str, 找到=True
   ```

## 常见问题

### 日志文件不存在

如果 `/tmp/backend_final.log` 不存在：
1. 后端服务可能没有启动
2. 运行启动脚本：`bash ~/liaotian/deploy/强制启动并诊断服务.sh`

### 没有日志输出

如果请求后没有日志：
1. 请求可能没有到达后端（检查 Nginx 配置）
2. 后端服务可能没有运行（检查进程）
3. 检查 Nginx 错误日志：`sudo tail -50 /var/log/nginx/error.log`

### 404 错误

如果仍然出现 404：
1. 查看日志中的详细信息
2. 检查 `server_id` 是否正确传递
3. 检查服务器列表中是否有该服务器
4. 检查账号ID是否匹配

## 日志文件位置

- **后端日志**：`/tmp/backend_final.log`
- **前端日志**：`/tmp/frontend.log`
- **Nginx 错误日志**：`/var/log/nginx/error.log`
- **标准日志**：`~/liaotian/admin-backend/logs/backend.log`

## 相关脚本

- `deploy/强制启动并诊断服务.sh` - 强制启动服务
- `deploy/查看分配剧本实时日志.sh` - 查看实时日志
- `deploy/一键启动并测试分配剧本.sh` - 启动并测试
