name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 55m
          script_stop: true
          debug: true
          envs: GITHUB_REPO=${{ github.repository }},SERVER_HOST=${{ secrets.SERVER_HOST }}
          script: |
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            GITHUB_REPO="${GITHUB_REPO:-victor2025PH/liaotianai1201}"
            
            echo "=========================================="
            echo "开始部署 - $(date)"
            echo "=========================================="
            echo "项目目录: $PROJECT_DIR"
            echo "GitHub 仓库: $GITHUB_REPO"
            echo ""
            
            # ============ 检查 DNS ============
            echo "[0/5] 检查 DNS 连接"
            echo "----------------------------------------"
            if ! nslookup github.com >/dev/null 2>&1; then
              echo "❌ DNS 解析失败：无法解析 github.com"
              echo "请检查服务器 DNS 配置（应配置为 8.8.8.8）"
              echo "当前 DNS 配置:"
              cat /etc/resolv.conf 2>/dev/null || echo "无法读取 /etc/resolv.conf"
              exit 1
            fi
            echo "✅ DNS 解析正常"
            echo ""
            
            # ============ 进入项目目录 ============
            echo "[1/5] 进入项目目录"
            echo "----------------------------------------"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "❌ 项目目录不存在: $PROJECT_DIR"
              echo "请先手动克隆仓库或检查路径"
              exit 1
            fi
            
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录: $PROJECT_DIR"
              exit 1
            }
            echo "✅ 当前目录: $(pwd)"
            echo ""
            
            # ============ 拉取最新代码 ============
            echo "[2/5] 拉取最新代码"
            echo "----------------------------------------"
            git pull origin main || {
              echo "❌ Git pull 失败"
              exit 1
            }
            echo "✅ 代码已更新"
            echo "最新提交: $(git log -1 --oneline)"
            echo ""
            
            # ============ 构建前端 ============
            echo "[3/5] 构建前端"
            echo "----------------------------------------"
            if [ -d "saas-demo" ]; then
              cd saas-demo
              echo "安装前端依赖..."
              npm install --prefer-offline --no-audit --no-fund || {
                echo "⚠️  npm install 失败，继续尝试构建..."
              }
              echo "构建前端项目..."
              export NODE_OPTIONS="--max-old-space-size=2048"
              npm run build || {
                echo "❌ 前端构建失败"
                exit 1
              }
              cd ..
              echo "✅ 前端构建完成"
            else
              echo "⚠️  saas-demo 目录不存在，跳过前端构建"
            fi
            echo ""
            
            # ============ 安装后端依赖 ============
            echo "[4/5] 安装后端依赖"
            echo "----------------------------------------"
            if [ -d "admin-backend" ]; then
              cd admin-backend
              if [ -d "venv" ] && [ -f "venv/bin/activate" ]; then
                source venv/bin/activate
                echo "安装 Python 依赖..."
                pip install -r requirements.txt --quiet || {
                  echo "⚠️  部分依赖安装失败，继续..."
                }
                cd ..
                echo "✅ 后端依赖安装完成"
              else
                echo "⚠️  虚拟环境不存在，跳过依赖安装"
                cd ..
              fi
            else
              echo "⚠️  admin-backend 目录不存在，跳过后端依赖安装"
            fi
            echo ""
            
            # ============ 重启服务 ============
            echo "[5/5] 重启服务"
            echo "----------------------------------------"
            echo "重启后端服务..."
            sudo systemctl restart luckyred-api && echo "✅ luckyred-api 已重启" || echo "⚠️  luckyred-api 重启失败"
            
            echo "重启前端服务..."
            sudo systemctl restart liaotian-frontend && echo "✅ liaotian-frontend 已重启" || echo "⚠️  liaotian-frontend 重启失败"
            
            echo "重启 Nginx..."
            sudo systemctl restart nginx && echo "✅ nginx 已重启" || echo "⚠️  nginx 重启失败"
            
            echo ""
            echo "等待服务启动 (5秒)..."
            sleep 5
            echo ""
            
            # ============ HTTPS 验证 ============
            echo "=========================================="
            echo "HTTPS 验证（端口 443）"
            echo "=========================================="
            DOMAIN="${SERVER_HOST:-aikz.usdt2026.cc}"
            echo "测试 HTTPS 访问..."
            
            HTTPS_LOGIN_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${DOMAIN}/login" 2>/dev/null || echo "000")
            if [ "$HTTPS_LOGIN_CODE" = "200" ] || [ "$HTTPS_LOGIN_CODE" = "302" ] || [ "$HTTPS_LOGIN_CODE" = "301" ]; then
              echo "✅ HTTPS /login: HTTP $HTTPS_LOGIN_CODE"
            else
              echo "⚠️  HTTPS /login: HTTP $HTTPS_LOGIN_CODE (可能需要等待服务完全启动)"
            fi
            
            HTTPS_API_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://${DOMAIN}/api/v1/health" 2>/dev/null || echo "000")
            if [ "$HTTPS_API_CODE" = "200" ] || [ "$HTTPS_API_CODE" = "401" ] || [ "$HTTPS_API_CODE" = "404" ]; then
              echo "✅ HTTPS /api/v1/health: HTTP $HTTPS_API_CODE"
            else
              echo "⚠️  HTTPS /api/v1/health: HTTP $HTTPS_API_CODE (可能需要等待服务完全启动)"
            fi
            
            echo ""
            echo "=========================================="
            echo "✅ 部署完成 - $(date)"
            echo "=========================================="
            exit 0
