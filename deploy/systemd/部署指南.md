# Systemd éƒ¨ç½²æŒ‡å—

> **éƒ¨ç½²æ–¹å¼**: systemd æœåŠ¡ï¼ˆLinuxï¼‰  
> **ä¸ä½¿ç”¨ Docker**

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. æœåŠ¡å™¨è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (Ubuntu 20.04+ / CentOS 7+ / Debian 10+)
- **Python**: 3.11+
- **Node.js**: 18+
- **æ•°æ®åº“**: PostgreSQL æˆ– SQLite
- **ç”¨æˆ·**: å»ºè®®åˆ›å»ºä¸“ç”¨ç”¨æˆ· `www-data` æˆ– `smart-tg`

### 2. ç›®å½•ç»“æ„

```
/opt/smart-tg/
â”œâ”€â”€ admin-backend/          # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ .venv/             # Python è™šæ‹Ÿç¯å¢ƒ
â”‚   â”œâ”€â”€ .env               # åç«¯ç¯å¢ƒå˜é‡
â”‚   â””â”€â”€ ...
â”œâ”€â”€ saas-demo/              # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ .env.local         # å‰ç«¯ç¯å¢ƒå˜é‡
â”‚   â”œâ”€â”€ .next/             # Next.js æ„å»ºè¾“å‡º
â”‚   â””â”€â”€ ...
â”œâ”€â”€ data/                   # æ•°æ®ç›®å½•
â””â”€â”€ logs/                   # æ—¥å¿—ç›®å½•
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ

```bash
# 1. åˆ›å»ºç›®å½•
sudo mkdir -p /opt/smart-tg/{admin-backend,saas-demo,data,logs}
sudo chown -R www-data:www-data /opt/smart-tg

# 2. å®‰è£…ç³»ç»Ÿä¾èµ–
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y python3.11 python3.11-venv python3-pip nodejs npm nginx

# CentOS/RHEL
sudo yum install -y python3.11 python3-pip nodejs npm nginx
```

### æ­¥éª¤ 2: éƒ¨ç½²åç«¯

```bash
# 1. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
# å‡è®¾ä»£ç åœ¨ /opt/smart-tg/admin-backend

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
cd /opt/smart-tg/admin-backend
python3.11 -m venv .venv
source .venv/bin/activate

# 3. å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“ã€JWT ç­‰

# 5. åˆå§‹åŒ–æ•°æ®åº“
python init_db_tables.py
python -m alembic upgrade head
```

### æ­¥éª¤ 3: éƒ¨ç½²å‰ç«¯

```bash
# 1. ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
# å‡è®¾ä»£ç åœ¨ /opt/smart-tg/saas-demo

# 2. å®‰è£…ä¾èµ–
cd /opt/smart-tg/saas-demo
npm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.local
# ç¼–è¾‘ .env.localï¼Œè®¾ç½® NEXT_PUBLIC_API_BASE_URL

# 4. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build
```

### æ­¥éª¤ 4: é…ç½® systemd æœåŠ¡

```bash
# 1. å¤åˆ¶æœåŠ¡æ–‡ä»¶
sudo cp deploy/systemd/smart-tg-backend.service /etc/systemd/system/
sudo cp deploy/systemd/smart-tg-frontend.service /etc/systemd/system/

# 2. ä¿®æ”¹æœåŠ¡æ–‡ä»¶ä¸­çš„è·¯å¾„ï¼ˆå¦‚æœéœ€è¦ï¼‰
sudo nano /etc/systemd/system/smart-tg-backend.service
sudo nano /etc/systemd/system/smart-tg-frontend.service

# 3. é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# 4. å¯åŠ¨æœåŠ¡
sudo systemctl start smart-tg-backend
sudo systemctl start smart-tg-frontend

# 5. è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable smart-tg-backend
sudo systemctl enable smart-tg-frontend

# 6. æ£€æŸ¥çŠ¶æ€
sudo systemctl status smart-tg-backend
sudo systemctl status smart-tg-frontend
```

### æ­¥éª¤ 5: é…ç½® Nginx åå‘ä»£ç†ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# åˆ›å»º Nginx é…ç½®
sudo nano /etc/nginx/sites-available/smart-tg

# é…ç½®å†…å®¹ï¼š
server {
    listen 80;
    server_name your-domain.com;

    # å‰ç«¯
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # åç«¯ API
    location /api {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/smart-tg /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

## ğŸ” æœåŠ¡ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# åç«¯æœåŠ¡
sudo systemctl status smart-tg-backend

# å‰ç«¯æœåŠ¡
sudo systemctl status smart-tg-frontend
```

### å¯åŠ¨/åœæ­¢/é‡å¯æœåŠ¡

```bash
# åç«¯
sudo systemctl start smart-tg-backend
sudo systemctl stop smart-tg-backend
sudo systemctl restart smart-tg-backend

# å‰ç«¯
sudo systemctl start smart-tg-frontend
sudo systemctl stop smart-tg-frontend
sudo systemctl restart smart-tg-frontend
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# åç«¯æ—¥å¿—
sudo journalctl -u smart-tg-backend -f
sudo journalctl -u smart-tg-backend --since "1 hour ago"

# å‰ç«¯æ—¥å¿—
sudo journalctl -u smart-tg-frontend -f
sudo journalctl -u smart-tg-frontend --since "1 hour ago"
```

### æŸ¥çœ‹æœåŠ¡åˆ—è¡¨

```bash
# æŸ¥çœ‹æ‰€æœ‰ smart-tg ç›¸å…³æœåŠ¡
sudo systemctl list-units | grep smart-tg
```

---

## âœ… å¥åº·æ£€æŸ¥

### åç«¯å¥åº·æ£€æŸ¥

```bash
# æœ¬åœ°æ£€æŸ¥
curl http://localhost:8000/health

# é¢„æœŸå“åº”
# {"status":"healthy","timestamp":"2025-11-26T..."}
```

### å‰ç«¯å¥åº·æ£€æŸ¥

```bash
# æœ¬åœ°æ£€æŸ¥
curl http://localhost:3000

# åº”è¯¥è¿”å› HTML é¡µé¢
```

### API æ–‡æ¡£

```bash
# è®¿é—® API æ–‡æ¡£
curl http://localhost:8000/docs
# æˆ–æµè§ˆå™¨è®¿é—®: http://your-server:8000/docs
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# 1. æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo journalctl -u smart-tg-backend -n 50 --no-pager

# 2. æ£€æŸ¥æƒé™
ls -la /opt/smart-tg/
sudo chown -R www-data:www-data /opt/smart-tg

# 3. æ£€æŸ¥ç¯å¢ƒå˜é‡
sudo systemctl show smart-tg-backend | grep Environment

# 4. æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
cd /opt/smart-tg/admin-backend
source .venv/bin/activate
gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000
```

### ç«¯å£è¢«å ç”¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep :8000
sudo netstat -tlnp | grep :3000

# æ€æ­»å ç”¨è¿›ç¨‹
sudo kill -9 <PID>
```

### æƒé™é—®é¢˜

```bash
# ä¿®å¤æƒé™
sudo chown -R www-data:www-data /opt/smart-tg
sudo chmod -R 755 /opt/smart-tg
```

---

## ğŸ“ æ›´æ–°éƒ¨ç½²

### æ›´æ–°åç«¯

```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop smart-tg-backend

# 2. æ›´æ–°ä»£ç 
cd /opt/smart-tg/admin-backend
git pull  # æˆ–ä¸Šä¼ æ–°ä»£ç 

# 3. æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
source .venv/bin/activate
pip install -r requirements.txt

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
python -m alembic upgrade head

# 5. å¯åŠ¨æœåŠ¡
sudo systemctl start smart-tg-backend
```

### æ›´æ–°å‰ç«¯

```bash
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop smart-tg-frontend

# 2. æ›´æ–°ä»£ç 
cd /opt/smart-tg/saas-demo
git pull  # æˆ–ä¸Šä¼ æ–°ä»£ç 

# 3. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
npm install

# 4. é‡æ–°æ„å»º
npm run build

# 5. å¯åŠ¨æœåŠ¡
sudo systemctl start smart-tg-frontend
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **é˜²ç«å¢™é…ç½®**
   ```bash
   # åªå¼€æ”¾å¿…è¦ç«¯å£
   sudo ufw allow 80/tcp
   sudo ufw allow 443/tcp
   sudo ufw enable
   ```

2. **HTTPS é…ç½®**
   - ä½¿ç”¨ Let's Encrypt è·å– SSL è¯ä¹¦
   - é…ç½® Nginx æ”¯æŒ HTTPS

3. **ç¯å¢ƒå˜é‡å®‰å…¨**
   - ç¡®ä¿ `.env` æ–‡ä»¶æƒé™: `chmod 600 .env`
   - ä¸è¦å°† `.env` æäº¤åˆ° Git

4. **å®šæœŸå¤‡ä»½**
   ```bash
   # å¤‡ä»½æ•°æ®åº“
   pg_dump -U user database_name > backup.sql
   
   # å¤‡ä»½æ•°æ®ç›®å½•
   tar -czf data-backup.tar.gz /opt/smart-tg/data
   ```

---

## ğŸ“Š ç›‘æ§å»ºè®®

1. **æ—¥å¿—è½®è½¬**: é…ç½® logrotate
2. **ç›‘æ§å·¥å…·**: ä½¿ç”¨ Prometheus + Grafana
3. **å‘Šè­¦**: é…ç½®é‚®ä»¶æˆ– Webhook å‘Šè­¦

---

*éƒ¨ç½²æŒ‡å—æœ€åæ›´æ–°: 2025-11-26*

