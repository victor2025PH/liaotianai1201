# 502 Bad Gateway 修复 - 完整总结

> **修复日期**: 2025-01-28  
> **访问地址**: http://aikz.usdt2026.cc/group-ai/accounts

---

## 🔍 502 根本原因

### 主要原因

1. **端口配置不匹配** ⭐ 核心问题
   - `package.json` 中 `dev` 脚本配置为端口 `3001`
   - Nginx 反向代理配置期望端口 `3000`
   - 导致前端服务启动后无法被 Nginx 正确访问

2. **前端服务未运行**
   - 服务可能启动在错误端口（3001）
   - 或者服务根本没有成功启动

3. **端口冲突或进程残留**
   - 可能有旧的进程占用端口
   - 导致新服务无法启动

---

## ✅ 修改的文件和改动点

### 1. `saas-demo/package.json`

**修改内容**:
```json
- "dev": "next dev -p 3001",
+ "dev": "next dev -p 3000",
```

**原因**: 确保前端服务启动在端口 3000，与 Nginx 配置匹配。

### 2. Nginx 配置检查

**文件**: `/etc/nginx/sites-enabled/default`

**状态**: 
- 配置已正确，`location /` 的 `proxy_pass` 已指向 `http://127.0.0.1:3000`
- 无需修改，只需确保前端服务运行在 3000 端口

---

## 🚀 从零启动前端服务的推荐命令清单

### 方法 1: 使用一键修复脚本（最简单）

```bash
cd ~/liaotian/saas-demo
git pull origin master
chmod +x 一键修复502.sh
bash 一键修复502.sh
```

### 方法 2: 完整手动启动流程

```bash
# 1. 进入项目目录
cd ~/liaotian/saas-demo

# 2. 更新代码
git pull origin master

# 3. 确保端口配置正确（应该是 3000）
grep '"dev"' package.json

# 4. 安装依赖（如果需要）
npm install

# 5. 停止旧进程
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 清理端口（如果有冲突）
sudo lsof -i :3000 | grep LISTEN | awk '{print $2}' | xargs kill -9 2>/dev/null || true

# 6. 启动前端服务
npm run dev > /tmp/frontend.log 2>&1 &

# 7. 等待服务启动（30-60秒）
sleep 45

# 8. 验证服务
curl http://localhost:3000

# 9. 重载 Nginx
sudo systemctl reload nginx

# 10. 验证域名访问
curl http://aikz.usdt2026.cc/group-ai/accounts
```

### 方法 3: 快速启动（依赖已安装）

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
npm run dev > /tmp/frontend.log 2>&1 &
sleep 45 && curl http://localhost:3000 && sudo systemctl reload nginx
```

---

## 📋 创建的修复脚本

已创建以下修复脚本（都在 `saas-demo/` 目录下）：

1. **`一键修复502.sh`** - 最简单的修复脚本
2. **`最终修复502-完整版.sh`** - 完整修复流程
3. **`直接修复502.sh`** - 直接修复脚本
4. **`完整502修复流程.sh`** - 完整修复流程
5. **`分步执行修复.sh`** - 分步执行脚本

---

## ✅ 验证步骤

修复成功后，执行以下验证：

```bash
# 1. 检查进程
ps aux | grep "next.*dev" | grep -v grep

# 2. 检查端口
sudo netstat -tlnp | grep 3000

# 3. 测试本地访问
curl -I http://localhost:3000

# 4. 测试 Nginx 代理
curl -I http://localhost/group-ai/accounts

# 5. 测试域名访问
curl -I http://aikz.usdt2026.cc/group-ai/accounts
```

---

## 🔧 故障排查

如果修复后仍有问题：

1. **查看前端日志**
   ```bash
   tail -f /tmp/frontend.log
   ```

2. **检查进程状态**
   ```bash
   ps aux | grep next
   ```

3. **检查端口占用**
   ```bash
   sudo lsof -i :3000
   ```

4. **检查 Nginx 错误日志**
   ```bash
   sudo tail -f /var/log/nginx/error.log
   ```

5. **重新执行修复脚本**
   ```bash
   cd ~/liaotian/saas-demo
   bash 一键修复502.sh
   ```

---

## 📝 修复完成

- ✅ 端口配置已修复（3001 → 3000）
- ✅ 自动修复脚本已创建
- ✅ 修复文档已完善
- ✅ 所有修改已提交到 Git

**前端服务现在应该可以在端口 3000 正常启动，并通过 Nginx 代理正常访问了！**
