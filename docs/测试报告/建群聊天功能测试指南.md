# 建群聊天功能测试指南

> **生成日期**: 2025-01-21  
> **测试范围**: 账号自动建群和按剧本聊天功能

---

## 📋 测试前准备

### 1. 启动后端服务

```bash
cd admin-backend
poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**验证服务运行**:
```bash
curl http://localhost:8000/health
# 或
python -c "import requests; print(requests.get('http://localhost:8000/health').json())"
```

### 2. 确保有可用账号

- 账号需要在数据库中
- 账号最好处于 ONLINE 状态
- 账号需要配置剧本ID

### 3. 检查账号状态

访问: `http://localhost:8000/api/v1/group-ai/accounts`

---

## 🧪 测试步骤

### 方法一：使用Python测试脚本（推荐）

```bash
# 运行测试脚本
python test_group_chat.py
```

**测试脚本功能**:
1. ✅ 检查后端服务状态
2. ✅ 获取可用账号列表
3. ✅ 确保账号在线
4. ✅ 创建测试群组
5. ✅ 发送测试消息
6. ✅ 检查账号状态更新

### 方法二：使用API直接测试

#### 1. 获取可用账号

```bash
curl http://localhost:8000/api/v1/group-ai/accounts
```

#### 2. 创建测试群组

```bash
curl -X POST http://localhost:8000/api/v1/group-ai/groups/create \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "你的账号ID",
    "title": "测试群组-20250121",
    "description": "自动化测试创建的群组",
    "auto_reply": true
  }'
```

**预期响应**:
```json
{
  "account_id": "你的账号ID",
  "group_id": -1234567890,
  "group_title": "测试群组-20250121",
  "success": true,
  "message": "群組創建成功並已啟動群聊"
}
```

#### 3. 发送测试消息

```bash
curl -X POST http://localhost:8000/api/v1/group-ai/groups/send-test-message \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "你的账号ID",
    "group_id": -1234567890,
    "message": "你好",
    "wait_for_reply": true,
    "wait_timeout": 15
  }'
```

#### 4. 检查账号状态

```bash
curl http://localhost:8000/api/v1/group-ai/accounts/你的账号ID
```

### 方法三：使用Swagger UI测试

1. 打开浏览器访问: `http://localhost:8000/docs`
2. 找到 `groups` 标签
3. 测试以下端点:
   - `POST /api/v1/group-ai/groups/create` - 创建群组
   - `POST /api/v1/group-ai/groups/send-test-message` - 发送测试消息

---

## ✅ 测试验证点

### 1. 群组创建验证

- ✅ 群组创建成功，返回群组ID
- ✅ 群组已添加到账号的监听列表
- ✅ 自动启动群聊功能已启用

### 2. 消息发送验证

- ✅ 消息发送成功
- ✅ 账号能够接收消息
- ✅ 账号能够自动回复（如果剧本配置了）

### 3. 自动回复验证

- ✅ 账号按照剧本自动回复
- ✅ 回复内容符合剧本设定
- ✅ 角色分配正确

### 4. 状态更新验证

- ✅ 账号的群组数更新
- ✅ 账号的消息数更新
- ✅ 账号的回复数更新

---

## 📊 测试结果记录

### 测试账号信息
- **账号ID**: _______________
- **账号状态**: _______________
- **剧本ID**: _______________

### 群组创建结果
- **群组ID**: _______________
- **群组标题**: _______________
- **创建时间**: _______________
- **创建状态**: ✅ 成功 / ❌ 失败

### 消息测试结果
- **测试消息1**: "你好"
  - 发送状态: ✅ / ❌
  - 收到回复: ✅ / ❌
  - 回复内容: _______________

- **测试消息2**: "新人"
  - 发送状态: ✅ / ❌
  - 收到回复: ✅ / ❌
  - 回复内容: _______________

- **测试消息3**: "欢迎"
  - 发送状态: ✅ / ❌
  - 收到回复: ✅ / ❌
  - 回复内容: _______________

### 账号状态更新
- **群组数**: _______________
- **消息数**: _______________
- **回复数**: _______________

---

## ⚠️ 常见问题

### 1. 后端服务未运行

**错误**: `ConnectionRefusedError` 或 `无法连接`

**解决方案**:
```bash
cd admin-backend
poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 2. 账号不存在

**错误**: `404 - 賬號不存在`

**解决方案**:
- 检查账号ID是否正确
- 确认账号已在数据库中
- 检查账号是否已分配到服务器

### 3. 账号不在线

**错误**: `賬號未連接`

**解决方案**:
```bash
# 启动账号
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/账号ID/start
```

### 4. 群组创建失败

**错误**: `500 - 創建群組失敗`

**可能原因**:
- 账号未连接
- Telegram API限制
- Session文件问题

**解决方案**:
- 确保账号在线
- 检查账号的session文件
- 查看后端日志

### 5. 未收到自动回复

**可能原因**:
- 剧本未配置自动回复
- 触发条件不匹配
- 账号未正确监听群组

**验证方法**:
- 检查剧本配置
- 查看账号的监听列表
- 检查后端日志

---

## 📝 测试报告模板

### 测试信息
- **测试日期**: _______________
- **测试人员**: _______________
- **测试环境**: _______________

### 测试结果
- **群组创建**: ✅ 成功 / ❌ 失败
- **消息发送**: ✅ 成功 / ❌ 失败
- **自动回复**: ✅ 成功 / ❌ 失败

### 问题记录
1. _______________
2. _______________
3. _______________

### 改进建议
1. _______________
2. _______________
3. _______________

---

## 🔗 相关文档

- [建群和聊天功能测试最终报告](../建群和聊天功能测试最终报告.md)
- [服务器建群和聊天测试修复报告](../服务器建群和聊天测试修复报告.md)
- [Groups API文档](../../使用说明/验证Groups%20API路由指南.md)

---

**最后更新**: 2025-01-21

