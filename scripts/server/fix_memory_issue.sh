#!/bin/bash
# 修复内存不足问题

echo "=========================================="
echo "内存问题诊断和修复"
echo "=========================================="
echo ""

# 1. 检查内存使用
echo "1. 当前内存使用情况"
echo "----------------------------------------"
free -h
echo ""

# 2. 检查占用内存最多的进程
echo "2. 占用内存最多的进程（前10个）"
echo "----------------------------------------"
ps aux --sort=-%mem | head -n 11
echo ""

# 3. 检查 PM2 进程内存
echo "3. PM2 进程内存使用"
echo "----------------------------------------"
pm2 list 2>/dev/null || echo "PM2 未运行"
echo ""

# 4. 检查 Swap
echo "4. Swap 使用情况"
echo "----------------------------------------"
swapon --show
echo ""

# 5. 建议操作
echo "=========================================="
echo "建议操作"
echo "=========================================="
echo ""
echo "如果内存不足，建议："
echo ""
echo "1. 停止不必要的服务"
echo "   pm2 stop backend  # 临时停止后端（如果不需要）"
echo ""
echo "2. 使用更小的内存限制构建"
echo "   export NODE_OPTIONS='--max-old-space-size=1024'"
echo "   npm run build"
echo ""
echo "3. 或者考虑在本地构建后上传"
echo ""

