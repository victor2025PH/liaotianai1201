name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            echo "=========================================="
            echo "🚀 开始部署"
            echo "时间: $(date)"
            echo "=========================================="
            echo ""
            
            # 项目目录
            PROJECT_DIR="/home/ubuntu/aizkw20251219"
            
            # 检查项目目录是否存在
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "❌ 项目目录不存在: $PROJECT_DIR"
              echo "正在创建目录并克隆项目..."
              mkdir -p "$(dirname "$PROJECT_DIR")"
              cd "$(dirname "$PROJECT_DIR")"
              git clone https://github.com/victor2025PH/liaotianai1201.git "$(basename "$PROJECT_DIR")" || {
                echo "❌ Git clone 失败"
                exit 1
              }
            fi
            
            # 进入项目目录
            echo "📁 进入项目目录: $PROJECT_DIR"
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录"
              exit 1
            }
            
            echo "当前目录: $(pwd)"
            echo ""
            
            # 检查是否是 git 仓库
            if [ ! -d ".git" ]; then
              echo "❌ 当前目录不是 git 仓库"
              echo "正在初始化 git 仓库..."
              git init
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            # 拉取最新代码
            echo "📥 [1/5] 拉取最新代码..."
            echo "----------------------------------------"
            
            # 获取远程分支信息
            git fetch origin main || git fetch origin || true
            
            # 强制重置到远程 main 分支
            echo "强制同步到 origin/main..."
            git reset --hard origin/main || {
              echo "⚠️  git reset 失败，尝试 git pull..."
              git pull origin main || {
                echo "❌ Git pull 失败"
                exit 1
              }
            }
            
            # 再次拉取确保最新
            git pull origin main || {
              echo "⚠️  Git pull 失败，但继续执行..."
            }
            
            echo "✅ 代码同步完成"
            echo "最新提交: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # 检查 package.json 是否存在（扁平结构，直接在项目根目录）
            if [ ! -f "$PROJECT_DIR/package.json" ]; then
              echo "❌ package.json 不存在于项目根目录: $PROJECT_DIR"
              echo "检查项目结构..."
              ls -la "$PROJECT_DIR" | head -20
              exit 1
            fi
            
            echo "✅ 找到 package.json"
            echo ""
            
            # 停止可能运行的服务（PM2 或其他进程）
            echo "🛑 [2/6] 停止现有服务..."
            echo "----------------------------------------"
            
            # 停止 PM2 进程（如果存在）
            if command -v pm2 >/dev/null 2>&1; then
              echo "停止 PM2 进程..."
              pm2 stop all 2>/dev/null || true
              pm2 delete all 2>/dev/null || true
              echo "✅ PM2 进程已停止"
            else
              echo "⚠️  PM2 未安装，跳过"
            fi
            
            # 停止占用端口 3000 的进程
            if sudo lsof -i :3000 >/dev/null 2>&1; then
              echo "停止占用端口 3000 的进程..."
              sudo lsof -ti :3000 | xargs sudo kill -9 2>/dev/null || true
              sleep 2
              echo "✅ 端口 3000 已释放"
            fi
            
            echo ""
            
            # 安装依赖（在项目根目录）
            echo "📦 [3/6] 安装依赖..."
            echo "----------------------------------------"
            
            # 确保在项目根目录
            cd "$PROJECT_DIR" || {
              echo "❌ 无法进入项目目录"
              exit 1
            }
            
            # 安装依赖
            npm install || {
              echo "❌ npm install 失败"
              exit 1
            }
            
            echo "✅ 依赖安装完成"
            echo ""
            
            # 构建前端（在项目根目录）
            echo "🔨 [4/6] 构建前端..."
            echo "----------------------------------------"
            
            # 设置 Node.js 内存限制（防止内存溢出）
            export NODE_OPTIONS="--max-old-space-size=3072"
            
            npm run build || {
              echo "❌ npm run build 失败"
              exit 1
            }
            
            echo "✅ 前端构建完成"
            echo ""
            
            # 检查构建输出
            if [ ! -d ".next" ]; then
              echo "⚠️  警告: .next 目录不存在，构建可能未成功"
            else
              echo "✅ 构建输出目录存在: .next"
            fi
            
            # 重载 Nginx
            echo "🔄 [5/6] 重载 Nginx..."
            echo "----------------------------------------"
            
            sudo systemctl reload nginx || {
              echo "⚠️  Nginx reload 失败，尝试 restart..."
              sudo systemctl restart nginx || {
                echo "❌ Nginx restart 失败"
                exit 1
              }
            }
            
            echo "✅ Nginx 重载完成"
            echo ""
            
            # 验证服务状态
            echo "🔍 [6/6] 验证服务状态..."
            echo "----------------------------------------"
            
            # 检查 Nginx 状态
            if sudo systemctl is-active --quiet nginx; then
              echo "✅ Nginx 服务运行中"
            else
              echo "⚠️  Nginx 服务未运行"
            fi
            
            # 检查端口占用
            if sudo lsof -i :80 >/dev/null 2>&1; then
              echo "✅ 端口 80 已被占用（Nginx 可能正在运行）"
            else
              echo "⚠️  端口 80 未被占用"
            fi
            
            echo ""
            echo "=========================================="
            echo "✅ 部署完成！"
            echo "时间: $(date)"
            echo "=========================================="
