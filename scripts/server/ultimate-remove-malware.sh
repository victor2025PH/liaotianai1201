#!/bin/bash
# ============================================================
# 终极删除恶意软件脚本（最彻底的方法）
# ============================================================

set -e

echo "=========================================="
echo "🔥 终极删除恶意软件（最彻底方法）"
echo "=========================================="
echo ""

# 可疑文件列表
SUSPICIOUS_FILES=(
    "/data/MUTA71VL"
    "/data/CX81yM9aE"
    "/data/UY"
)

# 1. 终止所有相关进程（更彻底）
echo "[1/6] 彻底终止所有相关进程..."
for file in "${SUSPICIOUS_FILES[@]}"; do
    FILE_NAME=$(basename "$file")
    
    # 方法 1: 查找使用该文件的进程
    PIDS=$(lsof "$file" 2>/dev/null | awk 'NR>1 {print $2}' | sort -u || true)
    for pid in $PIDS; do
        if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
            echo "  终止进程 PID: $pid (使用文件: $FILE_NAME)"
            sudo kill -9 "$pid" 2>/dev/null || true
        fi
    done
    
    # 方法 2: 查找命令中包含文件名的进程
    PIDS=$(ps aux | grep -i "$FILE_NAME" | grep -v grep | awk '{print $2}' || true)
    for pid in $PIDS; do
        if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
            echo "  终止进程 PID: $pid (命令包含: $FILE_NAME)"
            sudo kill -9 "$pid" 2>/dev/null || true
        fi
    done
    
    # 方法 3: 查找所有可疑进程
    PIDS=$(pgrep -f "$FILE_NAME" 2>/dev/null || true)
    for pid in $PIDS; do
        if [ -n "$pid" ] && [ "$pid" != "$$" ]; then
            echo "  终止进程 PID: $pid (pgrep 找到: $FILE_NAME)"
            sudo kill -9 "$pid" 2>/dev/null || true
        fi
    done
done

# 等待进程完全终止
sleep 3
echo "  ✅ 进程终止完成"
echo ""

# 2. 检查文件系统状态
echo "[2/6] 检查文件系统状态..."
if mountpoint -q /data 2>/dev/null; then
    echo "  /data 是独立挂载点"
    MOUNT_INFO=$(mount | grep " /data ")
    echo "  挂载信息: $MOUNT_INFO"
    
    # 检查是否只读
    if echo "$MOUNT_INFO" | grep -q "ro,"; then
        echo "  ⚠️  /data 是只读挂载，尝试重新挂载为可写..."
        sudo mount -o remount,rw /data 2>/dev/null || echo "    重新挂载失败"
    fi
else
    echo "  /data 是普通目录"
fi
echo ""

# 3. 多重删除尝试
echo "[3/6] 多重删除尝试..."
DELETED=0
FAILED=0

for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  删除: $file"
        
        # 获取文件 inode
        FILE_INODE=$(stat -c %i "$file" 2>/dev/null || echo "")
        echo "    inode: $FILE_INODE"
        
        DELETE_SUCCESS=false
        
        # 尝试 1: 标准删除
        if sudo rm -f "$file" 2>/dev/null; then
            DELETE_SUCCESS=true
            echo "    ✅ 方法 1 (rm) 成功"
        fi
        
        # 同步并等待
        sync
        sleep 0.5
        
        # 验证是否删除
        if [ -f "$file" ] || [ -n "$FILE_INODE" ] && [ -n "$(find /data -inum "$FILE_INODE" 2>/dev/null)" ]; then
            DELETE_SUCCESS=false
            
            # 尝试 2: 覆盖后删除
            echo "    ⚠️  方法 1 失败，尝试方法 2 (覆盖删除)..."
            if sudo dd if=/dev/zero of="$file" bs=1M count=1 2>/dev/null; then
                sync
                if sudo rm -f "$file" 2>/dev/null; then
                    DELETE_SUCCESS=true
                    echo "    ✅ 方法 2 (覆盖删除) 成功"
                fi
            fi
        fi
        
        # 再次同步并等待
        sync
        sleep 1
        
        # 最终验证
        if [ -f "$file" ]; then
            DELETE_SUCCESS=false
        fi
        
        if [ "$DELETE_SUCCESS" = true ]; then
            DELETED=$((DELETED+1))
        else
            FAILED=$((FAILED+1))
            echo "    ❌ 所有删除方法均失败"
            echo "    文件状态:"
            ls -li "$file" 2>/dev/null || echo "      无法获取文件信息"
        fi
    else
        echo "    ✅ 文件不存在（可能已删除）"
    fi
done

echo ""
if [ "$DELETED" -gt 0 ]; then
    echo "  ✅ 成功删除 $DELETED 个文件"
fi
if [ "$FAILED" -gt 0 ]; then
    echo "  ⚠️  $FAILED 个文件删除失败"
fi
echo ""

# 4. 强制刷新文件系统缓存
echo "[4/6] 强制刷新文件系统缓存..."
sync
sync
# 触发目录重新读取
ls /data/ >/dev/null 2>&1 || true
sleep 2
echo "  ✅ 缓存刷新完成"
echo ""

# 5. 最终验证
echo "[5/6] 最终验证删除结果..."
REMAINING_FILES=0
for file in "${SUSPICIOUS_FILES[@]}"; do
    FILE_EXISTS=false
    
    # 多重检查
    if [ -f "$file" ]; then
        FILE_EXISTS=true
    fi
    if stat "$file" >/dev/null 2>&1; then
        FILE_EXISTS=true
    fi
    if test -f "$file"; then
        FILE_EXISTS=true
    fi
    
    if [ "$FILE_EXISTS" = true ]; then
        REMAINING_FILES=$((REMAINING_FILES+1))
        echo "  ❌ 文件仍存在: $file"
        echo "    尝试获取详细信息..."
        if ls -li "$file" >/dev/null 2>&1; then
            ls -li "$file"
            echo "    检查文件是否被占用:"
            sudo lsof "$file" 2>/dev/null || echo "      无进程占用"
        fi
    fi
done

if [ "$REMAINING_FILES" -eq 0 ]; then
    echo "  ✅ 所有可疑文件已删除"
else
    echo "  ⚠️  仍有 $REMAINING_FILES 个文件存在"
fi
echo ""

# 6. 检查是否有进程重新创建文件
echo "[6/6] 检查是否有进程重新创建文件..."
sleep 2
for file in "${SUSPICIOUS_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  ⚠️  文件被重新创建: $file"
        echo "    检查创建时间:"
        stat -c "      创建: %w, 修改: %y" "$file" 2>/dev/null || ls -l "$file"
        echo "    检查相关进程:"
        ps aux | grep -E "$(basename "$file")" | grep -v grep || echo "      未发现相关进程"
    fi
done
echo ""

# 总结
echo "=========================================="
echo "终极删除完成"
echo "=========================================="
echo ""

if [ "$REMAINING_FILES" -gt 0 ]; then
    echo "⚠️  仍有文件无法删除，可能的原因："
    echo "  1. 文件被内核或系统进程锁定"
    echo "  2. 文件系统错误或损坏"
    echo "  3. 文件被恶意进程持续重新创建"
    echo ""
    echo "建议操作："
    echo "  1. 重启系统后再次运行此脚本"
    echo "  2. 检查文件系统: sudo fsck /dev/vdb"
    echo "  3. 检查系统日志: sudo journalctl -xe"
    echo "  4. 如果文件持续被重新创建，检查定时任务和启动脚本"
else
    echo "✅ 所有可疑文件已成功删除"
    echo ""
    echo "建议后续操作:"
    echo "  1. 更改所有密码"
    echo "  2. 运行安全扫描: sudo rkhunter --check"
    echo "  3. 监控系统资源使用情况"
    echo "  4. 定期检查 /data 目录"
    echo "  5. 运行验证脚本: bash scripts/server/verify-cleanup.sh"
fi
echo ""

