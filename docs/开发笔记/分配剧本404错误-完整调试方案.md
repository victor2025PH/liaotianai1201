# 分配剧本404错误 - 完整调试方案

## 问题描述

用户尝试为 Worker 节点账号（Eve, 639277358115）分配剧本时，浏览器控制台显示：
```
Failed to load resource: the server responded with a status of 404 (Not Found) 
/api/v1/group-ai/accounts/639277358115:1
```

## API 路径验证

从代码分析，API 路径是正确的：
- 主路由：`/api/v1` (main.py)
- 群组AI路由：`/group-ai` (group_ai/__init__.py)
- 账号路由：`/accounts` (group_ai/__init__.py)
- 更新端点：`/{account_id}` (accounts.py)

**完整路径**：`PUT /api/v1/group-ai/accounts/{account_id}`

## 已实施的调试增强

### 1. 请求开始日志
```python
logger.info(f"收到更新賬號請求: account_id={account_id}, request={request.model_dump()}")
```

### 2. AccountManager 检查日志
```python
logger.info(f"賬號 {account_id} 在 AccountManager 中: {account_in_manager}")
```

### 3. server_id 传递日志
```python
logger.info(f"接收到的 server_id: {request.server_id}, 類型: {type(request.server_id)}")
logger.info(f"SessionUploader 中的服務器列表: {list(uploader.servers.keys())}")
```

### 4. 失败原因日志
```python
logger.warning(f"賬號 {account_id} 不存在，且未提供 server_id。request.server_id={request.server_id}")
```

## 调试步骤

### 步骤1：查看完整的请求日志

当用户再次尝试分配剧本时，查看日志：

```bash
tail -f /tmp/backend_full_debug.log | grep -E "收到更新賬號請求|account_id.*639277358115|server_id|不存在"
```

应该能看到：
1. 请求的完整信息（包括 server_id）
2. AccountManager 检查结果
3. 服务器列表
4. 失败的具体原因

### 步骤2：检查前端请求体

在浏览器开发者工具中：
1. 打开 Network 标签
2. 点击"分配剧本"按钮
3. 找到 `PUT /api/v1/group-ai/accounts/639277358115` 请求
4. 查看 Request Payload，确认是否包含 `server_id` 字段

预期应该看到：
```json
{
  "script_id": "...",
  "session_file": "...",
  "server_id": "computer_001"  // 或 node_id 的值
}
```

### 步骤3：验证服务器配置

在服务器上运行：

```bash
cd ~/liaotian/admin-backend
python3 -c "from app.api.group_ai.session_uploader import SessionUploader; uploader = SessionUploader(); print('服务器列表:', list(uploader.servers.keys()))"
```

确认 `computer_001` 是否在列表中。

### 步骤4：手动测试API

使用 curl 测试API（需要先获取认证token）：

```bash
curl -X PUT http://localhost:8000/api/v1/group-ai/accounts/639277358115 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "script_id": "test_script",
    "server_id": "computer_001"
  }'
```

查看后端日志输出。

## 可能的问题和解决方案

### 问题1：server_id 未传递

**症状**：日志显示 `request.server_id=None` 或 `未提供 server_id`

**原因**：
- 前端没有正确传递 `server_id`
- Worker 账号对象没有 `server_id` 或 `node_id` 字段

**解决方案**：
- 检查前端代码，确保传递了 `server_id` 或 `node_id`
- 检查 Worker 账号数据结构

### 问题2：server_id 值不匹配

**症状**：日志显示 `服务器 {server_id} 不存在`

**原因**：
- 传递的 `server_id` 值与 `SessionUploader.servers` 的键不匹配
- 服务器配置文件中没有该服务器

**解决方案**：
- 检查 `data/master_config.json` 中的服务器配置
- 确认服务器键名与前端传递的值一致

### 问题3：账号不在服务器上

**症状**：日志显示 `賬號 {account_id} 不存在於服務器 {server_id} 上`

**原因**：
- SSH 连接失败
- 账号的 session 文件不在服务器上
- 账号ID提取失败

**解决方案**：
- 检查 SSH 连接配置
- 手动 SSH 登录服务器，检查 session 文件
- 查看 `scan_server_accounts` 函数的详细日志

### 问题4：路由未匹配

**症状**：请求没有到达后端处理函数

**原因**：
- 路由配置错误
- 认证失败
- 中间件拦截

**解决方案**：
- 检查路由注册
- 检查认证token
- 查看完整的请求日志

## 下一步行动

1. **用户再次尝试分配剧本**
2. **查看完整日志**：`tail -100 /tmp/backend_full_debug.log`
3. **根据日志输出定位问题**
4. **修复具体问题**

## 日志文件位置

- **后端调试日志**：`/tmp/backend_full_debug.log`
- **完整日志**：`logs/backend.log`

## 状态

✅ 已添加详细的调试日志  
✅ 后端服务已重启  
✅ 日志文件已配置  
⏳ 等待用户测试并查看日志
