# 模块逻辑关系与操作顺序指南

## 📋 模块逻辑关系图

```
┌─────────────────┐
│   ① 剧本管理    │  ← 基础模块，必须先创建
│   (Scripts)     │
└────────┬────────┘
         │
         │ script_id
         ▼
┌─────────────────┐      ┌─────────────────┐
│   ② 账号列表    │ ◄─── │   ③ 角色分配    │
│   (Accounts)    │      │ (Role Assign)   │
└────────┬────────┘      └────────┬────────┘
         │                        │
         │                        │ 分配方案
         │                        ▼
         │              ┌─────────────────┐
         │              │  ④ 分配方案     │
         │              │ (Assignment     │
         │              │  Schemes)       │
         │              └────────┬────────┘
         │                       │
         │                       │ 应用方案
         │                       ▼
         │              ┌─────────────────┐
         │              │   ⑤ 自动化任务  │
         │              │ (Automation     │
         │              │  Tasks)         │
         └──────────────┴─────────────────┘
```

## 🔄 操作顺序（带数字标识）

### 阶段一：基础准备（①）

#### ①-1 创建/导入剧本
**操作位置**: 剧本管理 (`/group-ai/scripts`)
- **操作步骤**:
  1. 点击 "新建剧本" 或 "上传剧本"
  2. 填写剧本信息（剧本ID、名称、描述）
  3. 编写或导入 YAML 剧本内容
  4. 测试剧本是否正确
  5. 保存剧本
- **前置条件**: 无
- **后续依赖**: ②-1 创建账号时需要选择剧本

#### ①-2 配置剧本角色（可选）
**操作位置**: 剧本管理 (`/group-ai/scripts`)
- **操作步骤**:
  1. 编辑剧本 YAML 内容
  2. 在 `metadata.roles` 中定义角色
  3. 在场景和回复的 `metadata.role` 中指定角色
  4. 保存剧本
- **前置条件**: ①-1 已创建剧本
- **后续依赖**: ③-1 提取角色时使用

### 阶段二：账号管理（②）

#### ②-1 上传 Session 文件
**操作位置**: 账号列表 (`/group-ai/accounts`)
- **操作步骤**:
  1. 点击 "上传 Session" 或 "扫描 Session"
  2. 选择 Telegram Session 文件（.session）
  3. 等待上传/扫描完成
- **前置条件**: 已有 Telegram Session 文件
- **后续依赖**: ②-2 创建账号时需要 Session 文件

#### ②-2 创建账号
**操作位置**: 账号列表 (`/group-ai/accounts`)
- **操作步骤**:
  1. 点击 "+ 添加账号"
  2. 填写账号信息:
     - 账号ID（自定义）
     - 选择 Session 文件（从 ②-1）
     - **选择剧本**（从 ①-1，必需）
     - 配置其他参数（可选）
  3. 保存账号
- **前置条件**: 
  - ①-1 已创建剧本
  - ②-1 已上传 Session 文件
- **后续依赖**: 
  - ②-3 启动账号
  - ③-1 角色分配时需要账号列表

#### ②-3 启动账号
**操作位置**: 账号列表 (`/group-ai/accounts`)
- **操作步骤**:
  1. 在账号列表中点击 "启动" 按钮
  2. 系统验证:
     - 剧本是否存在 ✓
     - Session 文件是否存在 ✓
     - Telegram 连接是否正常 ✓
  3. 等待账号状态变为 "在线"
- **前置条件**: 
  - ②-2 已创建账号
  - ①-1 账号关联的剧本必须存在且有效
- **运行验证**: 
  - 如果显示 "無法加載劇本"，说明剧本不存在或无效
  - 检查账号关联的剧本是否正确

### 阶段三：角色分配（③）- 可选

#### ③-1 提取角色
**操作位置**: 角色分配 (`/group-ai/role-assignments`)
- **操作步骤**:
  1. 选择剧本（从 ①-1）
  2. 点击 "提取角色"
  3. 查看提取到的角色列表和统计信息
- **前置条件**: 
  - ①-1 已创建剧本
  - ①-2 剧本中已定义角色（可选）
- **后续依赖**: ③-2 创建分配方案时使用

#### ③-2 创建分配方案
**操作位置**: 角色分配 (`/group-ai/role-assignments`)
- **操作步骤**:
  1. 选择账号（从 ②-2）
  2. 选择分配模式（自动/手动）
  3. 如果是手动模式，为每个角色指定账号
  4. 点击 "创建分配方案"
  5. 查看分配方案摘要和验证结果
- **前置条件**: 
  - ③-1 已提取角色
  - ②-2 已创建账号
- **后续依赖**: 
  - ③-3 应用分配方案
  - ④-1 保存为分配方案（可选）

#### ③-3 应用分配方案
**操作位置**: 角色分配 (`/group-ai/role-assignments`)
- **操作步骤**:
  1. 在 "审阅方案" 标签页查看分配详情
  2. 确认分配方案无误
  3. 点击 "应用分配方案"
  4. 系统将角色信息写入账号配置
- **前置条件**: ③-2 已创建分配方案
- **运行效果**: 账号的 metadata 中会添加 `assigned_role_id` 和 `script_id`

### 阶段四：分配方案管理（④）- 可选

#### ④-1 保存分配方案
**操作位置**: 分配方案 (`/group-ai/role-assignment-schemes`)
- **操作步骤**:
  1. 从 ③-2 创建分配方案后，点击 "保存为方案"
  2. 或直接在分配方案页面创建新方案
  3. 填写方案名称和描述
  4. 保存方案
- **前置条件**: ③-2 已创建分配方案（可选）
- **后续依赖**: ④-2 应用方案到账号

#### ④-2 应用方案到账号
**操作位置**: 分配方案 (`/group-ai/role-assignment-schemes`)
- **操作步骤**:
  1. 选择已保存的分配方案
  2. 选择要应用的账号（可选，默认使用方案中的账号）
  3. 点击 "应用方案"
  4. 查看应用结果和历史记录
- **前置条件**: 
  - ④-1 已保存分配方案
  - ②-2 账号已存在
- **运行效果**: 批量将角色分配应用到多个账号

### 阶段五：自动化任务（⑤）- 可选

#### ⑤-1 创建自动化任务
**操作位置**: 自动化任务 (`/group-ai/automation-tasks`)
- **操作步骤**:
  1. 点击 "新建任务"
  2. 选择任务类型:
     - `account_start` - 自动启动账号
     - `account_stop` - 自动停止账号
     - `script_publish` - 自动发布剧本
     - `alert_check` - 检查告警
  3. 配置任务参数:
     - 任务名称和描述
     - 任务动作和配置
     - 调度配置（定时/触发）
     - 依赖任务（可选）
  4. 保存任务
- **前置条件**: 
  - ②-2 账号已创建（如果是账号相关任务）
  - ①-1 剧本已创建（如果是剧本相关任务）
- **后续依赖**: ⑤-2 启用任务

#### ⑤-2 启用/执行任务
**操作位置**: 自动化任务 (`/group-ai/automation-tasks`)
- **操作步骤**:
  1. 启用任务（开关按钮）
  2. 或手动执行任务（"执行" 按钮）
  3. 查看任务执行日志
- **前置条件**: ⑤-1 已创建任务
- **运行效果**: 自动执行配置的操作（如定时启动账号）

## 📊 运行顺序验证

### 正常流程验证

```
① 剧本管理
  ├─ ①-1 创建剧本 ✓
  └─ ①-2 配置角色（可选）✓

② 账号列表
  ├─ ②-1 上传 Session ✓
  ├─ ②-2 创建账号（关联剧本 ①-1）✓
  └─ ②-3 启动账号（验证剧本存在）✓

③ 角色分配（可选）
  ├─ ③-1 提取角色（从剧本 ①-1）✓
  ├─ ③-2 创建分配方案（使用账号 ②-2）✓
  └─ ③-3 应用分配方案（更新账号配置）✓

④ 分配方案（可选）
  ├─ ④-1 保存方案（从 ③-2）✓
  └─ ④-2 应用方案（批量应用到账号 ②-2）✓

⑤ 自动化任务（可选）
  ├─ ⑤-1 创建任务（依赖 ②-2 和 ①-1）✓
  └─ ⑤-2 启用任务（自动执行操作）✓
```

### 错误场景处理

#### 错误 1: 启动账号失败 - "無法加載劇本: 01111"
- **原因**: 账号关联的剧本不存在或无效
- **解决步骤**:
  1. 检查剧本管理页面，确认剧本 `01111` 是否存在
  2. 如果不存在，执行 ①-1 创建剧本
  3. 如果存在但无效，编辑剧本并保存
  4. 重新执行 ②-3 启动账号

#### 错误 2: 角色分配失败 - "剧本不存在"
- **原因**: 尝试提取角色的剧本不存在
- **解决步骤**:
  1. 先执行 ①-1 创建剧本
  2. 再执行 ③-1 提取角色

#### 错误 3: 应用分配方案失败 - "账号不存在"
- **原因**: 方案中指定的账号尚未创建
- **解决步骤**:
  1. 先执行 ②-2 创建账号
  2. 再执行 ④-2 应用方案

## 🎯 最佳实践建议

### 首次使用流程
1. **必须**: ①-1 创建剧本 → ②-1 上传 Session → ②-2 创建账号 → ②-3 启动账号
2. **推荐**: ①-2 配置角色 → ③-1 提取角色 → ③-2 创建分配方案 → ③-3 应用方案
3. **可选**: ④-1 保存方案 → ⑤-1 创建自动化任务

### 批量部署流程
1. ①-1 创建/导入剧本（一次）
2. ②-1 批量上传 Session 文件
3. ②-2 批量创建账号（使用同一剧本）
4. ③-1 提取角色 → ③-2 创建分配方案 → ④-1 保存方案
5. ④-2 批量应用方案到所有账号
6. ②-3 启动账号（或使用 ⑤-1 自动化任务）

### 日常维护流程
1. ⑤-2 查看自动化任务执行情况
2. ②-3 手动启动/停止账号（如需要）
3. ①-1 更新剧本（如需要）
4. ④-2 应用新的分配方案（如需要）

## 📝 注意事项

1. **剧本是基础**: 所有后续操作都依赖剧本，确保先创建并测试剧本
2. **账号关联剧本**: 创建账号时必须选择剧本，否则无法启动
3. **角色分配可选**: 如果不使用角色功能，可以跳过 ③ 和 ④
4. **自动化任务独立**: ⑤ 可以独立配置，不依赖角色分配
5. **顺序很重要**: 严格按照 ① → ② → ③ → ④ → ⑤ 的顺序操作，避免依赖错误
