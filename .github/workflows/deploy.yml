name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.2.0
        continue-on-error: false
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 55m
          script_stop: true
          debug: true
          envs: GITHUB_REPO=${{ github.repository }},SERVER_HOST=${{ secrets.SERVER_HOST }}
          script: |
            # é‡åˆ°ä»»ä½•å‘½ä»¤é”™è¯¯(éé€»è¾‘åˆ¤æ–­)åˆ™é€€å‡º
            set -e
            
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
            
            # 1. è¿›å…¥ç›®å½•å¹¶æ›´æ–°ä»£ç 
            cd "$PROJECT_DIR"
            git fetch origin main
            git reset --hard origin/main
            
            # 2. ä¿®å¤æƒé™ (å¿½ç•¥é”™è¯¯)
            sudo chown -R ubuntu:ubuntu "$PROJECT_DIR" || true
            
            # 3. æ„å»ºå‰ç«¯
            echo "ğŸ“¦ æ„å»ºå‰ç«¯..."
            cd saas-demo
            
            # 1. æ¸…ç†é”æ–‡ä»¶ï¼ˆä¸åœæ­¢æœåŠ¡ï¼Œå‡å°‘ä¸­æ–­æ—¶é—´ï¼‰
            rm -f .next/lock
            
            # 2. å®‰è£…ä¸æ„å»ºï¼ˆåœ¨æœåŠ¡è¿è¡Œçš„æƒ…å†µä¸‹æ„å»ºï¼‰
            npm install --prefer-offline --no-audit
            npm run build
            
            # æš´åŠ›å¤åˆ¶é™æ€èµ„æº (Standalone è¡¥ä¸)
            echo "ğŸ“‚ å¤„ç†é™æ€èµ„æº..."
            mkdir -p .next/standalone/.next/static
            # ä½¿ç”¨ || true é˜²æ­¢æŸäº›æ–‡ä»¶ä¸å­˜åœ¨å¯¼è‡´æŠ¥é”™
            cp -r .next/static/* .next/standalone/.next/static/ || true
            cp -r public .next/standalone/ || true
            cd ..
            
            # 4. åç«¯ä¾èµ–
            echo "ğŸ å®‰è£…åç«¯ä¾èµ–..."
            cd admin-backend
            source venv/bin/activate
            pip install -r requirements.txt --quiet
            cd ..
            
            # 5. é‡å¯æœåŠ¡ï¼ˆä½¿ç”¨ PM2ï¼‰
            echo "ğŸ”„ é‡å¯æœåŠ¡..."
            
            # åˆ‡æ¢åˆ° ubuntu ç”¨æˆ·æ‰§è¡Œ PM2 å‘½ä»¤
            # æ³¨æ„ï¼šPM2 éœ€è¦ä»¥è¿è¡ŒæœåŠ¡çš„ç”¨æˆ·èº«ä»½æ‰§è¡Œ
            sudo -u ubuntu bash << 'PM2_RESTART'
            cd /home/ubuntu/telegram-ai-system
            
            # é‡æ–°åŠ è½½ PM2 é…ç½®ï¼ˆå¦‚æœ ecosystem.config.js æœ‰å˜åŒ–ï¼‰
            pm2 reload ecosystem.config.js || pm2 restart ecosystem.config.js
            
            # ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨
            pm2 save
PM2_RESTART
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 5
            
            # æœ€åé‡å¯ Nginx
            sudo systemctl restart nginx
            sleep 2
            
            # 6. éªŒè¯æœåŠ¡çŠ¶æ€
            echo "ğŸ” éªŒè¯æœåŠ¡çŠ¶æ€..."
            
            # ä½¿ç”¨ PM2 æ£€æŸ¥æœåŠ¡çŠ¶æ€
            BACKEND_STATUS=$(sudo -u ubuntu pm2 jlist 2>/dev/null | grep -o '"name":"backend"[^}]*"status":"[^"]*"' | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
            FRONTEND_STATUS=$(sudo -u ubuntu pm2 jlist 2>/dev/null | grep -o '"name":"frontend"[^}]*"status":"[^"]*"' | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
            
            if [ "$BACKEND_STATUS" = "online" ] && [ "$FRONTEND_STATUS" = "online" ]; then
                echo "âœ… æ‰€æœ‰æœåŠ¡å·²æˆåŠŸå¯åŠ¨"
                sudo -u ubuntu pm2 status
            else
                echo "âš ï¸  éƒ¨åˆ†æœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨"
                echo "åç«¯çŠ¶æ€: $BACKEND_STATUS"
                echo "å‰ç«¯çŠ¶æ€: $FRONTEND_STATUS"
                echo ""
                echo "æŸ¥çœ‹ PM2 æ—¥å¿—ï¼š"
                sudo -u ubuntu pm2 logs --lines 10 --nostream
                
                # å°è¯•é‡æ–°å¯åŠ¨å¤±è´¥çš„æœåŠ¡
                echo ""
                echo "å°è¯•é‡æ–°å¯åŠ¨æœåŠ¡..."
                sudo -u ubuntu pm2 restart ecosystem.config.js
                sudo -u ubuntu pm2 save
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
