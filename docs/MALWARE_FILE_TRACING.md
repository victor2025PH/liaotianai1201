# 恶意软件文件追踪指南

## 问题描述

在 `/data/` 目录中发现了可疑的可执行文件：
- `4pVffo7` (3.8MB)
- `T1ID` (10KB)
- `ZaAxbGP` (2.8MB)

这些文件具有以下特征：
- 随机文件名
- 可执行权限 (`rwxr-xr-x`)
- 在非标准位置（`/data/` 目录）
- 可能被持续重新创建

## 追踪文件来源

### 步骤 1: 运行追踪脚本

```bash
cd /home/ubuntu/telegram-ai-system
git pull origin main

# 运行追踪脚本
bash scripts/server/trace-file-origin.sh
```

此脚本会检查：
1. 文件创建时间线
2. 系统日志中的创建记录
3. 定时任务（cron）
4. systemd 服务和定时器
5. 启动脚本（rc.local, .bashrc 等）
6. 网络连接和下载活动
7. 文件系统审计日志

### 步骤 2: 检查 Systemd 服务

```bash
# 检查服务文件
bash scripts/server/check-systemd-services.sh
```

检查以下服务：
- `liaotian-backend.service`
- `luckyred-api.service`
- `telegram-bot.service`

### 步骤 3: 实时监控文件创建

```bash
# 在后台运行监控脚本
bash scripts/server/monitor-data-directory.sh > /tmp/monitor.log 2>&1 &

# 或者在前台运行（可以看到实时输出）
bash scripts/server/monitor-data-directory.sh
```

监控脚本会：
- 实时检测 `/data/` 目录中的新文件
- 记录文件创建时间
- 检查使用该文件的进程
- 显示文件详细信息

## 可能的文件来源

### 1. 定时任务（Cron）

检查所有定时任务：

```bash
# 用户定时任务
crontab -l

# 系统定时任务
sudo cat /etc/crontab
sudo ls -la /etc/cron.d/
sudo ls -la /etc/cron.daily/
sudo ls -la /etc/cron.hourly/
sudo ls -la /etc/cron.weekly/
sudo ls -la /etc/cron.monthly/

# 搜索可疑内容
sudo grep -r "80.64.16.241\|unk.sh\|/data/\|curl.*http\|wget.*http" /etc/cron* 2>/dev/null
```

### 2. Systemd 定时器

```bash
# 列出所有启用的定时器
systemctl list-unit-files | grep enabled | grep timer

# 检查定时器内容
systemctl cat <timer-name>
```

### 3. 启动脚本

检查以下文件：

```bash
# 系统启动脚本
cat /etc/rc.local
cat ~/.bashrc
cat ~/.bash_profile
cat ~/.profile
cat /etc/profile

# 搜索可疑内容
grep -r "80.64.16.241\|unk.sh\|/data/\|curl.*http\|wget.*http" ~/.bash* /etc/profile /etc/rc.local 2>/dev/null
```

### 4. Systemd 服务

检查服务文件：

```bash
# 检查服务文件位置
systemctl status <service-name>

# 查看服务文件内容
systemctl cat <service-name>

# 检查服务的工作目录
systemctl show <service-name> | grep WorkingDirectory
```

### 5. 隐藏进程

```bash
# 检查所有进程
ps aux | grep -E "4pVffo7|T1ID|ZaAxbGP"

# 检查进程树
pstree -p

# 检查网络连接
ss -tunp | grep -E "80.64.16.241"
```

## 删除文件后是否会重新创建？

**是的，如果文件来源没有被清除，文件会被重新创建。**

### 验证方法

1. **删除文件并监控**：

```bash
# 删除文件
sudo rm -f /data/4pVffo7 /data/T1ID /data/ZaAxbGP

# 立即开始监控
bash scripts/server/monitor-data-directory.sh
```

2. **等待观察**：
   - 如果文件在几分钟内重新出现，说明有定时任务或服务在创建它们
   - 如果文件在系统重启后出现，说明有启动脚本在创建它们

3. **检查创建时间**：

```bash
# 如果文件重新出现，检查创建时间
stat /data/4pVffo7
stat /data/T1ID
stat /data/ZaAxbGP

# 对比系统日志
sudo journalctl --since "10 minutes ago" | grep -E "4pVffo7|T1ID|ZaAxbGP"
```

## 完整清理流程

### 1. 追踪来源

```bash
bash scripts/server/trace-file-origin.sh
```

### 2. 分析文件

```bash
bash scripts/server/analyze-suspicious-files.sh
```

### 3. 删除文件

```bash
bash scripts/server/delete-new-malware-files.sh
```

### 4. 删除来源（根据追踪结果）

```bash
# 删除可疑的定时任务
crontab -e  # 手动编辑删除

# 删除可疑的 systemd 定时器
sudo systemctl disable <malicious-timer>
sudo rm /etc/systemd/system/<malicious-timer>

# 删除可疑的启动脚本
# 编辑相应的文件并删除可疑内容
```

### 5. 监控验证

```bash
# 运行监控脚本，观察文件是否重新出现
bash scripts/server/monitor-data-directory.sh
```

### 6. 最终验证

```bash
bash scripts/server/verify-cleanup.sh
```

## 预防措施

1. **定期检查定时任务**：
   ```bash
   crontab -l
   sudo cat /etc/crontab
   ```

2. **监控系统资源**：
   ```bash
   top
   htop
   ```

3. **检查网络连接**：
   ```bash
   ss -tunp
   netstat -tunp
   ```

4. **运行安全扫描**：
   ```bash
   sudo rkhunter --check
   sudo chkrootkit
   ```

5. **设置文件系统监控**：
   ```bash
   # 安装 auditd
   sudo apt install auditd

   # 监控 /data/ 目录
   sudo auditctl -w /data/ -p wa -k data_monitor
   ```

## 常见问题

### Q: 文件删除后立即重新出现？

**A:** 说明有进程在监控并重新创建文件。需要：
1. 找到并终止该进程
2. 删除创建文件的脚本或定时任务
3. 检查是否有守护进程在运行

### Q: 文件在系统重启后重新出现？

**A:** 说明有启动脚本在创建文件。需要：
1. 检查 `/etc/rc.local`
2. 检查 `~/.bashrc`、`~/.bash_profile`、`~/.profile`
3. 检查 systemd 服务

### Q: 找不到文件来源？

**A:** 可能的原因：
1. 文件被加密或混淆
2. 来源在隐藏目录或临时目录
3. 来源通过内存执行（无文件）

建议：
- 使用 `strace` 追踪进程系统调用
- 使用 `tcpdump` 监控网络流量
- 使用 `auditd` 进行系统审计

## 相关脚本

- `scripts/server/trace-file-origin.sh` - 追踪文件来源
- `scripts/server/check-systemd-services.sh` - 检查 systemd 服务
- `scripts/server/monitor-data-directory.sh` - 监控目录
- `scripts/server/analyze-suspicious-files.sh` - 分析可疑文件
- `scripts/server/delete-new-malware-files.sh` - 删除文件
- `scripts/server/verify-cleanup.sh` - 验证清理结果

