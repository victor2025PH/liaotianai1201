name: Deploy Three Sites

on:
  push:
    branches:
      - main
    paths:
      - 'tgmini20251220/**'
      - 'hbwy20251220/**'
      - 'aizkw20251219/**'
      - '.github/workflows/deploy-three-sites.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      matrix:
        site:
          - name: tgmini
            dir: tgmini20251220
            domain: tgmini.usdt2026.cc
            port: 3001
            pm2_name: tgmini-frontend
          - name: hongbao
            dir: hbwy20251220
            domain: hongbao.usdt2026.cc
            port: 3002
            pm2_name: hongbao-frontend
          - name: aizkw
            dir: aizkw20251219
            domain: aikz.usdt2026.cc
            port: 3003
            pm2_name: aizkw-frontend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ${{ matrix.site.name }} to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '60s'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            SITE_NAME="${{ matrix.site.name }}"
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            SITE_DIR="$PROJECT_DIR/${{ matrix.site.dir }}"
            DOMAIN="${{ matrix.site.domain }}"
            PORT="${{ matrix.site.port }}"
            PM2_NAME="${{ matrix.site.pm2_name }}"
            
            echo "=========================================="
            echo "ğŸš€ éƒ¨ç½² $SITE_NAME"
            echo "åŸŸå: $DOMAIN"
            echo "ç«¯å£: $PORT"
            echo "ç›®å½•: $SITE_DIR"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
            echo ""
            
            # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
            cd "$PROJECT_DIR" || {
              echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ [1/6] æ‹‰å–æœ€æ–°ä»£ç ..."
            echo "----------------------------------------"
            
            # ç¡®ä¿é¡¹ç›®ç›®å½•å­˜åœ¨
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âš ï¸  é¡¹ç›®ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "âŒ Git clone å¤±è´¥"
                exit 1
              }
            else
              cd "$PROJECT_DIR"
              git fetch origin main || git fetch origin || true
              git reset --hard origin/main || git pull origin main || {
                echo "âš ï¸  Git pull å¤±è´¥ï¼Œå°è¯•ç»§ç»­..."
              }
            fi
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
            echo ""
            
            # æ£€æŸ¥ç«™ç‚¹ç›®å½•æ˜¯å¦å­˜åœ¨
            if [ ! -d "$SITE_DIR" ]; then
              echo "âŒ ç«™ç‚¹ç›®å½•ä¸å­˜åœ¨: $SITE_DIR"
              echo "å½“å‰é¡¹ç›®ç›®å½•å†…å®¹:"
              ls -la "$PROJECT_DIR" | head -20
              exit 1
            fi
            
            # è¿›å…¥ç«™ç‚¹ç›®å½•
            cd "$SITE_DIR" || {
              echo "âŒ æ— æ³•è¿›å…¥ç«™ç‚¹ç›®å½•: $SITE_DIR"
              exit 1
            }
            
            # æ£€æŸ¥ package.json
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json ä¸å­˜åœ¨"
              exit 1
            fi
            
            echo "âœ… æ‰¾åˆ° package.json"
            echo ""
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ [2/6] å®‰è£…ä¾èµ–..."
            echo "----------------------------------------"
            npm install || {
              echo "âŒ npm install å¤±è´¥"
              exit 1
            }
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            echo ""
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ”¨ [3/6] æ„å»ºé¡¹ç›®..."
            echo "----------------------------------------"
            export NODE_OPTIONS="--max-old-space-size=3072"
            npm run build || {
              echo "âŒ npm run build å¤±è´¥"
              exit 1
            }
            
            # æ£€æŸ¥æ„å»ºè¾“å‡º
            if [ ! -d "dist" ]; then
              echo "âŒ dist ç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
              exit 1
            fi
            echo "âœ… æ„å»ºå®Œæˆ"
            echo ""
            
            # åœæ­¢æ—§è¿›ç¨‹
            echo "ğŸ›‘ [4/6] åœæ­¢æ—§è¿›ç¨‹..."
            echo "----------------------------------------"
            pm2 delete "$PM2_NAME" 2>/dev/null || true
            
            # åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
            if sudo lsof -i :$PORT >/dev/null 2>&1; then
              echo "åœæ­¢å ç”¨ç«¯å£ $PORT çš„è¿›ç¨‹..."
              sudo lsof -ti :$PORT | xargs sudo kill -9 2>/dev/null || true
              sleep 2
            fi
            echo "âœ… æ—§è¿›ç¨‹å·²åœæ­¢"
            echo ""
            
            # å¯åŠ¨æœåŠ¡ï¼ˆä½¿ç”¨ serve æˆ– vite previewï¼‰
            echo "ğŸš€ [5/6] å¯åŠ¨æœåŠ¡..."
            echo "----------------------------------------"
            
            # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
            mkdir -p "$PROJECT_DIR/logs"
            
            # æ£€æŸ¥å¹¶å®‰è£… PM2
            if ! command -v pm2 >/dev/null 2>&1; then
              echo "å®‰è£… PM2..."
              sudo npm install -g pm2
              pm2 startup systemd -u ubuntu --hp /home/ubuntu || true
            fi
            
            # å®‰è£… serveï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            if ! command -v serve >/dev/null 2>&1; then
              echo "å®‰è£… serve..."
              sudo npm install -g serve
            fi
            
            # ä½¿ç”¨ PM2 å¯åŠ¨ serve
            pm2 start serve \
              --name "$PM2_NAME" \
              -- "$SITE_DIR/dist" \
              --listen $PORT \
              --single \
              --no-clipboard \
              --no-open \
              --env NODE_ENV=production \
              --error "$PROJECT_DIR/logs/${SITE_NAME}-error.log" \
              --output "$PROJECT_DIR/logs/${SITE_NAME}-out.log" \
              --merge-logs \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" || {
              echo "âš ï¸  PM2 å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯..."
              pm2 logs "$PM2_NAME" --lines 10 --nostream 2>/dev/null || true
              exit 1
            }
            
            pm2 save || true
            echo "âœ… æœåŠ¡å·²å¯åŠ¨"
            echo ""
            
            # ç­‰å¾…å¯åŠ¨
            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if sudo lsof -i :$PORT >/dev/null 2>&1; then
              echo "âœ… ç«¯å£ $PORT æ­£åœ¨ç›‘å¬"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:$PORT || echo "000")
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "âœ… æœåŠ¡å“åº”æ­£å¸¸ (HTTP $HTTP_CODE)"
              else
                echo "âš ï¸  æœåŠ¡å“åº”å¼‚å¸¸ (HTTP $HTTP_CODE)"
              fi
            else
              echo "âŒ ç«¯å£ $PORT æœªåœ¨ç›‘å¬"
              pm2 logs "$PM2_NAME" --lines 20 --nostream 2>/dev/null || true
              exit 1
            fi
            echo ""
            
            # é…ç½® Nginx
            echo "ğŸŒ [6/6] é…ç½® Nginx..."
            echo "----------------------------------------"
            
            # åˆ›å»º Nginx é…ç½®
            NGINX_CONFIG="/tmp/${SITE_NAME}.conf"
            
            # æ£€æŸ¥ SSL è¯ä¹¦æ˜¯å¦å­˜åœ¨
            SSL_CERT="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
            SSL_KEY="/etc/letsencrypt/live/$DOMAIN/privkey.pem"
            
            if [ -f "$SSL_CERT" ] && [ -f "$SSL_KEY" ]; then
              # SSL è¯ä¹¦å­˜åœ¨ï¼Œé…ç½® HTTPS
              cat > "$NGINX_CONFIG" << 'NGINX_EOF'
# HTTP to HTTPS redirect
server {
    listen 80;
    server_name $DOMAIN;
    
    # Let's Encrypt éªŒè¯è·¯å¾„
    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }
    
    # é‡å®šå‘æ‰€æœ‰ HTTP è¯·æ±‚åˆ° HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    # SSL è¯ä¹¦é…ç½®ï¼ˆç”± Certbot è‡ªåŠ¨ç®¡ç†ï¼‰
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
    
    # SSL å®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    client_max_body_size 50M;

    # å‰ç«¯åº”ç”¨
    location / {
        proxy_pass http://127.0.0.1:$PORT;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        proxy_read_timeout 86400;
    }
}
EOF
            
            # å¤åˆ¶é…ç½®åˆ° Nginx
            sudo cp "$NGINX_CONFIG" "/etc/nginx/sites-available/$DOMAIN"
            
            # åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if [ ! -L "/etc/nginx/sites-enabled/$DOMAIN" ]; then
              sudo ln -s "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
            fi
            
            # æ£€æŸ¥ Nginx æ˜¯å¦å®‰è£…
            if ! command -v nginx >/dev/null 2>&1; then
              echo "âš ï¸  Nginx æœªå®‰è£…ï¼Œå®‰è£… Nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # æ£€æŸ¥ Nginx æœåŠ¡çŠ¶æ€
            if ! sudo systemctl is-active --quiet nginx; then
              echo "âš ï¸  Nginx æœåŠ¡æœªè¿è¡Œï¼Œå¯åŠ¨ Nginx..."
              sudo systemctl enable nginx
              sudo systemctl start nginx || {
                echo "âŒ Nginx å¯åŠ¨å¤±è´¥"
                exit 1
              }
            fi
            
            # æµ‹è¯• Nginx é…ç½®
            sudo nginx -t || {
              echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
              exit 1
            }
            
            # é‡è½½ Nginx
            sudo systemctl reload nginx || {
              echo "âš ï¸  Nginx reload å¤±è´¥ï¼Œå°è¯• restart..."
              sudo systemctl restart nginx || {
                echo "âŒ Nginx restart å¤±è´¥"
                exit 1
              }
            }
            
            echo "âœ… Nginx é…ç½®å®Œæˆ"
            echo ""
            
            # éªŒè¯éƒ¨ç½²
            echo "ğŸ” éªŒè¯éƒ¨ç½²..."
            echo "----------------------------------------"
            pm2 list | grep "$PM2_NAME" || true
            echo ""
            
            echo "=========================================="
            echo "âœ… $SITE_NAME éƒ¨ç½²å®Œæˆï¼"
            echo "åŸŸå: https://$DOMAIN"
            echo "æ—¶é—´: $(date)"
            echo "=========================================="
