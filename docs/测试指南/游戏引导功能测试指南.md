# 游戏引导功能测试指南

> **创建日期**: 2025-11-16  
> **目标**: 完整测试游戏引导功能，包括账号导入、启动和实际消息发送

---

## 1. 账号保存位置

### 1.1 Session 文件保存位置

**默认位置**: `sessions/` 目录（项目根目录下）

**配置位置**: `group_ai_service/config.py`
```python
session_files_directory: str = "sessions"
```

**完整路径示例**:
```
E:\002-工作文件\重要程序\聊天AI群聊程序\sessions\
```

---

### 1.2 账号数据存储

**数据库存储**: 
- 账号配置存储在数据库中（通过 API 管理）
- Session 文件存储在文件系统的 `sessions/` 目录

**文件结构**:
```
项目根目录/
├── sessions/              # Session 文件目录
│   ├── account1.session
│   ├── account2.session
│   └── ...
├── group_ai_service/      # 服务代码
└── admin-backend/         # 后端 API
```

---

## 2. 测试准备步骤

### 步骤 1: 准备 Session 文件

#### 方式 A: 使用现有 Session 文件

1. **检查 sessions 目录**:
```bash
# 检查目录是否存在
ls sessions/

# 或 Windows PowerShell
dir sessions\
```

2. **如果没有 sessions 目录，创建它**:
```bash
mkdir sessions
```

3. **将 .session 文件放入 sessions/ 目录**:
   - 文件名格式: `{account_id}.session`
   - 例如: `test_account.session`

#### 方式 B: 通过前端上传 Session 文件

1. **启动后端服务**:
```bash
cd admin-backend
uvicorn app.main:app --reload
```

2. **访问前端页面**:
   - 打开浏览器: http://localhost:3000
   - 导航到: 群组AI → 账号管理

3. **上传 Session 文件**:
   - 点击"上传 Session"按钮
   - 选择 `.session` 文件
   - 文件会自动保存到 `sessions/` 目录

#### 方式 C: 通过 API 上传

```bash
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/upload-session \
  -F "file=@path/to/your/session.session"
```

---

### 步骤 2: 导入账号到系统

#### 方式 A: 通过前端界面

1. **访问账号管理页面**: http://localhost:3000/group-ai/accounts

2. **创建账号**:
   - 点击"新建账号"
   - 填写账号信息:
     - **账号ID**: 自定义（例如: `test_account`）
     - **Session 文件**: 选择已上传的 session 文件
     - **剧本ID**: 选择剧本（例如: `default`）
     - **群组ID**: 输入要监听的群组ID（例如: `-1001234567890`）

3. **保存账号**

#### 方式 B: 通过 API 创建账号

```bash
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/ \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": "test_account",
    "session_file": "test_account.session",
    "script_id": "default",
    "group_ids": [-1001234567890]
  }'
```

#### 方式 C: 批量导入（通过代码）

```python
from group_ai_service.account_manager import AccountManager

manager = AccountManager()
loaded = await manager.load_accounts_from_directory(
    directory="sessions",
    script_id="default",
    group_ids=[-1001234567890]  # 你的测试群组ID
)
print(f"成功加载 {len(loaded)} 个账号")
```

---

### 步骤 3: 启动账号

#### 方式 A: 通过前端界面

1. **访问账号管理页面**: http://localhost:3000/group-ai/accounts

2. **启动账号**:
   - 找到要测试的账号
   - 点击"启动"按钮
   - 等待账号状态变为"在线"

#### 方式 B: 通过 API 启动

```bash
curl -X POST http://localhost:8000/api/v1/group-ai/accounts/{account_id}/start
```

#### 方式 C: 通过代码启动

```python
from group_ai_service.account_manager import AccountManager

manager = AccountManager()
account = manager.accounts.get("test_account")
if account:
    success = await account.start()
    print(f"账号启动: {'成功' if success else '失败'}")
```

---

### 步骤 4: 验证账号状态

#### 检查账号是否在线

```python
from group_ai_service.account_manager import AccountManager

manager = AccountManager()
for account_id, account in manager.accounts.items():
    print(f"账号: {account_id}")
    print(f"  状态: {account.status.value}")
    print(f"  在线: {account.status.value == 'online'}")
    print(f"  群组: {account.config.group_ids}")
```

#### 通过 API 检查

```bash
curl http://localhost:8000/api/v1/group-ai/accounts/{account_id}/status
```

---

## 3. 测试游戏引导功能

### 测试 1: 运行测试脚本

```bash
python scripts/test_game_guide.py
```

**预期结果**:
- ✅ 所有测试用例通过
- ⚠️ 如果没有账号，会提示"群组没有可用的账号发送引导消息"

---

### 测试 2: 通过 Webhook 发送真实事件

#### 启动后端服务

```bash
cd admin-backend
uvicorn app.main:app --reload
```

#### 发送游戏开始事件

```bash
curl -X POST http://localhost:8000/api/v1/game-webhook/events \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "GAME_START",
    "event_id": "test_event_001",
    "group_id": -1001234567890,
    "game_id": "game_001",
    "timestamp": "2025-11-16T10:00:00Z",
    "payload": {}
  }'
```

**预期结果**:
- ✅ API 返回成功
- ✅ 如果账号已启动并监听该群组，群组中应该收到引导消息

---

### 测试 3: 完整游戏流程测试

#### 发送完整游戏事件序列

```bash
# 1. 游戏开始
curl -X POST http://localhost:8000/api/v1/game-webhook/events \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "GAME_START",
    "event_id": "test_001",
    "group_id": -1001234567890,
    "game_id": "game_001",
    "timestamp": "2025-11-16T10:00:00Z",
    "payload": {}
  }'

# 2. 红包发送
curl -X POST http://localhost:8000/api/v1/game-webhook/events \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "REDPACKET_SENT",
    "event_id": "test_002",
    "group_id": -1001234567890,
    "game_id": "game_001",
    "timestamp": "2025-11-16T10:01:00Z",
    "payload": {
      "redpacket_id": "rp_001",
      "amount": 100.0,
      "count": 10,
      "remaining_count": 10,
      "token": "USDT"
    }
  }'

# 3. 红包快抢完（剩余3份）
curl -X POST http://localhost:8000/api/v1/game-webhook/events \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "REDPACKET_CLAIMED",
    "event_id": "test_003",
    "group_id": -1001234567890,
    "game_id": "game_001",
    "timestamp": "2025-11-16T10:02:00Z",
    "payload": {
      "redpacket_id": "rp_001",
      "account_id": "user_123",
      "amount": 10.5,
      "token": "USDT",
      "remaining_count": 3
    }
  }'

# 4. 游戏结束
curl -X POST http://localhost:8000/api/v1/game-webhook/events \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "GAME_END",
    "event_id": "test_004",
    "group_id": -1001234567890,
    "game_id": "game_001",
    "timestamp": "2025-11-16T10:05:00Z",
    "payload": {
      "total_amount": 1000.0,
      "token": "USDT",
      "participants": 25,
      "redpacket_count": 1
    }
  }'

# 5. 结果公布
curl -X POST http://localhost:8000/api/v1/game-webhook/events \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "RESULT_ANNOUNCED",
    "event_id": "test_005",
    "group_id": -1001234567890,
    "game_id": "game_001",
    "timestamp": "2025-11-16T10:06:00Z",
    "payload": {
      "summary": "恭喜以下用户获得奖励！\n\n第一名: @user1 - 50 USDT\n第二名: @user2 - 30 USDT"
    }
  }'
```

**预期结果**:
- ✅ 群组中依次收到5条引导消息
- ✅ 消息内容符合模板
- ✅ 消息格式清晰易读

---

## 4. 快速测试脚本

创建一个快速测试脚本 `scripts/quick_test_guide.py`:

```python
"""
快速测试游戏引导功能
需要先导入并启动账号
"""
import asyncio
import sys
from pathlib import Path

project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from group_ai_service.service_manager import ServiceManager
from group_ai_service.game_api_client import GameEvent
from datetime import datetime

async def main():
    # 检查账号状态
    sm = ServiceManager.get_instance()
    print(f"账号数量: {len(sm.account_manager.accounts)}")
    
    # 列出所有账号
    for account_id, account in sm.account_manager.accounts.items():
        print(f"\n账号: {account_id}")
        print(f"  状态: {account.status.value}")
        print(f"  群组: {account.config.group_ids}")
        
        # 如果账号未启动，尝试启动
        if account.status.value != "online":
            print(f"  尝试启动账号...")
            success = await account.start()
            print(f"  启动结果: {'成功' if success else '失败'}")
    
    # 检查是否有在线账号
    online_accounts = [
        acc for acc in sm.account_manager.accounts.values()
        if acc.status.value == "online"
    ]
    
    if not online_accounts:
        print("\n⚠️  没有在线账号，无法发送测试消息")
        print("请先导入并启动账号")
        return
    
    # 测试群组ID（需要根据实际情况修改）
    test_group_id = -1001234567890
    
    # 检查是否有账号监听该群组
    accounts_for_group = [
        acc for acc in online_accounts
        if not acc.config.group_ids or test_group_id in acc.config.group_ids
    ]
    
    if not accounts_for_group:
        print(f"\n⚠️  没有账号监听群组 {test_group_id}")
        print("请配置账号的 group_ids")
        return
    
    print(f"\n✅ 找到 {len(accounts_for_group)} 个账号可以发送消息")
    
    # 发送测试事件
    event = GameEvent(
        event_type="GAME_START",
        event_id="quick_test_001",
        group_id=test_group_id,
        game_id="test_game",
        timestamp=datetime.now(),
        payload={}
    )
    
    print(f"\n发送游戏开始事件到群组 {test_group_id}...")
    await sm.handle_game_start(event)
    print("✅ 事件已发送，请检查群组是否收到消息")

if __name__ == "__main__":
    asyncio.run(main())
```

---

## 5. 常见问题排查

### 问题 1: 账号未启动

**症状**: 测试脚本提示"群组没有可用的账号发送引导消息"

**解决方法**:
1. 检查账号状态: 访问前端账号管理页面
2. 启动账号: 点击"启动"按钮
3. 等待状态变为"在线"

---

### 问题 2: 账号未监听群组

**症状**: 账号在线，但消息未发送

**解决方法**:
1. 检查账号的 `group_ids` 配置
2. 确保测试群组ID在 `group_ids` 列表中
3. 如果没有配置 `group_ids`，账号会监听所有群组

---

### 问题 3: Session 文件不存在

**症状**: 导入账号时提示"Session 文件不存在"

**解决方法**:
1. 检查 `sessions/` 目录是否存在
2. 确保 `.session` 文件在 `sessions/` 目录中
3. 检查文件名是否正确

---

### 问题 4: 账号连接失败

**症状**: 启动账号时失败

**解决方法**:
1. 检查 Session 文件是否有效
2. 检查 Telegram API 凭据是否正确
3. 检查网络连接

---

## 6. 测试检查清单

- [ ] `sessions/` 目录存在
- [ ] 至少有一个 `.session` 文件
- [ ] 账号已导入到系统
- [ ] 账号已配置群组ID
- [ ] 账号已启动（状态为"在线"）
- [ ] 后端服务正在运行
- [ ] 测试群组ID正确
- [ ] 可以访问 Webhook API

---

## 7. 下一步

测试完成后，可以：
1. 收集用户反馈
2. 优化引导消息内容
3. 测试多账号并发
4. 测试真实游戏场景

---

**测试准备完成！** 按照以上步骤即可开始测试游戏引导功能。

