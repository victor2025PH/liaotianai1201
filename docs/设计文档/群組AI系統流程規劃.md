# 群組AI系統流程規劃文檔

## 目錄

1. [系統概述](#系統概述)
2. [劇本管理流程](#劇本管理流程)
3. [帳號管理流程](#帳號管理流程)
4. [角色分配流程](#角色分配流程)
5. [劇本運行監控](#劇本運行監控)
6. [細緻化管理與功能配置](#細緻化管理與功能配置)
7. [常見問題與故障排查](#常見問題與故障排查)

---

## 系統概述

### 系統架構

群組AI系統是一個多層次的管理平台，核心組件包括：

- **劇本引擎**：解析和執行YAML格式的劇本文件
- **帳號管理器**：管理Telegram帳號的完整生命週期
- **對話管理器**：處理群組消息和AI響應
- **角色分配器**：智能分配劇本角色到帳號
- **監控服務**：實時追蹤系統運行狀態和指標

### 核心流程關係

```
劇本管理 → 帳號管理 → 角色分配 → 運行監控
    ↓          ↓          ↓          ↓
  劇本創建   帳號導入   角色提取   狀態監控
  劇本編輯   帳號配置   自動分配   指標收集
  劇本發布   帳號啟動   手動調整   告警處理
```

---

## 劇本管理流程

### 1. 劇本創建流程

#### 1.1 創建新劇本

**步驟：**

1. **進入劇本管理頁面**
   - 導航至：`/group-ai/scripts`
   - 點擊「+ 創建劇本」按鈕

2. **填寫劇本基本信息**
   - **劇本ID**：唯一標識符（建議格式：`script_YYYYMMDD_序號`）
   - **劇本名稱**：易於識別的名稱
   - **版本號**：遵循語義化版本（如：`1.0.0`）
   - **描述**：劇本用途和功能說明

3. **編寫劇本內容**
   - 使用YAML格式編寫
   - 支持場景定義、觸發條件、響應模板
   - 可定義角色和元數據

4. **驗證劇本格式**
   - 系統自動驗證YAML語法
   - 檢查必填字段完整性
   - 驗證場景邏輯正確性

5. **保存劇本**
   - 點擊「保存」按鈕
   - 系統自動生成創建時間戳
   - 劇本狀態：`草稿`

#### 1.2 劇本編輯流程

**步驟：**

1. **選擇劇本**
   - 在劇本列表中選擇目標劇本
   - 點擊「編輯」按鈕

2. **修改劇本內容**
   - 支持在線編輯器或上傳文件
   - 實時語法高亮和錯誤提示
   - 支持版本對比功能

3. **保存變更**
   - 點擊「保存」創建新版本
   - 或點擊「另存為」創建副本
   - 系統自動記錄變更歷史

#### 1.3 劇本版本管理

**版本控制規則：**

- **主版本號**：不兼容的API修改
- **次版本號**：向下兼容的功能性新增
- **修訂版本號**：向下兼容的問題修正

**版本操作：**

1. **查看版本歷史**
   - 點擊「版本歷史」查看所有版本
   - 顯示每個版本的創建時間、修改人、變更摘要

2. **回滾到舊版本**
   - 選擇目標版本
   - 點擊「恢復此版本」
   - 確認後創建新版本（基於舊版本）

3. **版本對比**
   - 選擇兩個版本進行對比
   - 高亮顯示差異內容
   - 支持逐行查看變更

### 2. 劇本存儲與組織

#### 2.1 劇本分類

**分類方式：**

- **按用途分類**：營銷、客服、娛樂、教育等
- **按狀態分類**：草稿、審核中、已發布、已停用
- **按標籤分類**：支持多標籤管理

#### 2.2 劇本搜索與篩選

**搜索功能：**

- **關鍵詞搜索**：劇本ID、名稱、描述
- **高級篩選**：
  - 按創建時間範圍
  - 按狀態篩選
  - 按標籤篩選
  - 按版本號篩選

### 3. 劇本審核與發布

#### 3.1 劇本審核流程

**審核步驟：**

1. **提交審核**
   - 劇本狀態變更為「審核中」
   - 系統自動檢查語法和邏輯錯誤
   - 生成審核報告

2. **審核檢查項**
   - YAML語法正確性
   - 場景邏輯完整性
   - 觸發條件合理性
   - 響應模板有效性
   - 角色定義完整性

3. **審核結果**
   - **通過**：狀態變更為「已發布」
   - **拒絕**：返回審核意見，狀態變更為「草稿」

#### 3.2 劇本發布

**發布操作：**

1. **選擇發布版本**
   - 確認要發布的版本號
   - 檢查版本兼容性

2. **發布前檢查**
   - 確認劇本已關聯帳號
   - 檢查角色分配完整性
   - 驗證群組配置

3. **執行發布**
   - 點擊「發布」按鈕
   - 系統自動更新關聯帳號的劇本
   - 記錄發布日誌

### 4. 劇本權限控制

#### 4.1 訪問權限

**權限級別：**

- **公開**：所有用戶可查看和使用
- **團隊**：僅團隊成員可訪問
- **私有**：僅創建者可訪問

#### 4.2 操作權限

**權限劃分：**

- **查看**：可查看劇本內容
- **編輯**：可修改劇本內容
- **刪除**：可刪除劇本
- **發布**：可發布劇本到生產環境

### 5. 劇本管理使用說明

#### 5.1 劇本格式規範

**YAML結構：**

```yaml
metadata:
  script_id: "script_001"
  name: "示例劇本"
  version: "1.0.0"
  description: "劇本描述"
  roles:
    - role_id: "role_001"
      role_name: "角色名稱"
      description: "角色描述"

scenes:
  - scene_id: "scene_001"
    triggers:
      - type: "keyword"
        keywords: ["關鍵詞1", "關鍵詞2"]
    responses:
      - role: "role_001"
        content: "響應內容"
        probability: 0.8
```

#### 5.2 常見問題

**Q1: 劇本保存失敗怎麼辦？**

- 檢查YAML語法是否正確
- 確認必填字段是否完整
- 查看錯誤日誌獲取詳細信息

**Q2: 如何批量導入劇本？**

- 使用「批量導入」功能
- 準備符合格式的JSON或YAML文件
- 系統自動驗證並導入

**Q3: 劇本版本衝突如何解決？**

- 使用版本對比功能查看差異
- 手動合併變更內容
- 或選擇保留其中一個版本

---

## 帳號管理流程

### 1. 帳號註冊與導入

#### 1.1 帳號註冊流程

**步驟：**

1. **準備Session文件**
   - 確保已獲取Telegram帳號的`.session`文件
   - 文件命名格式：`帳號ID.session`

2. **上傳Session文件**
   - 導航至：`/group-ai/accounts`
   - 點擊「+ 添加帳號」
   - 選擇「上傳Session文件」
   - 選擇本地`.session`文件
   - 點擊「上傳」

3. **填寫帳號信息**
   - **帳號ID**：唯一標識符（建議與session文件名一致）
   - **Session文件路徑**：系統自動填充
   - **關聯劇本**：選擇要使用的劇本
   - **目標群組**：輸入群組ID列表

4. **配置帳號參數**
   - **回復率**：AI響應概率（0-1）
   - **紅包功能**：是否啟用紅包參與
   - **紅包概率**：參與紅包的概率
   - **每小時最大回復數**：限制回復頻率
   - **最小回復間隔**：兩次回復間的最小時間間隔（秒）

5. **保存帳號**
   - 點擊「保存」按鈕
   - 系統驗證Session文件有效性
   - 帳號狀態：`離線`

#### 1.2 批量導入帳號

**步驟：**

1. **準備批量導入文件**
   - 格式：JSON或CSV
   - 包含字段：帳號ID、Session文件路徑、劇本ID、群組ID列表

2. **執行批量導入**
   - 點擊「批量導入」按鈕
   - 選擇導入文件
   - 點擊「開始導入」

3. **導入結果處理**
   - 查看導入報告
   - 處理失敗的帳號（重新導入或手動添加）
   - 驗證成功導入的帳號

#### 1.3 掃描Session目錄

**步驟：**

1. **配置Session目錄**
   - 在系統設置中配置Session文件存儲目錄
   - 或使用默認目錄：`sessions/`

2. **執行掃描**
   - 點擊「掃描Session」按鈕
   - 系統自動掃描目錄下的所有`.session`文件
   - 生成可導入帳號列表

3. **選擇導入帳號**
   - 勾選要導入的帳號
   - 批量配置劇本和群組
   - 點擊「批量導入」

### 2. 帳號配置與綁定

#### 2.1 帳號基本配置

**配置項：**

- **帳號ID**：唯一標識符（不可修改）
- **Session文件**：Telegram會話文件路徑
- **關聯劇本**：當前使用的劇本ID
- **目標群組**：帳號監聽的群組ID列表

#### 2.2 帳號運行參數

**參數說明：**

- **回復率（reply_rate）**：
  - 範圍：0.0 - 1.0
  - 默認值：0.8
  - 說明：AI響應消息的概率

- **紅包功能（redpacket_enabled）**：
  - 類型：布爾值
  - 默認值：false
  - 說明：是否啟用自動參與紅包功能

- **紅包概率（redpacket_probability）**：
  - 範圍：0.0 - 1.0
  - 默認值：0.5
  - 說明：收到紅包時參與的概率

- **每小時最大回復數（max_replies_per_hour）**：
  - 範圍：1 - 1000
  - 默認值：60
  - 說明：限制每小時最大回復次數

- **最小回復間隔（min_reply_interval）**：
  - 範圍：1 - 3600（秒）
  - 默認值：5
  - 說明：兩次回復之間的最小時間間隔

#### 2.3 帳號與劇本綁定

**綁定流程：**

1. **選擇帳號**
   - 在帳號列表中選擇目標帳號
   - 點擊「編輯」按鈕

2. **選擇劇本**
   - 在「關聯劇本」下拉框中選擇劇本
   - 或輸入劇本ID

3. **驗證綁定**
   - 系統檢查劇本是否存在
   - 驗證劇本版本兼容性
   - 檢查角色分配完整性

4. **保存綁定**
   - 點擊「保存」按鈕
   - 如果帳號正在運行，需要重啟以應用新劇本

### 3. 帳號狀態管理

#### 3.1 帳號狀態類型

**狀態定義：**

- **離線（offline）**：帳號未啟動，不處理消息
- **在線（online）**：帳號已啟動，正常處理消息
- **啟動中（starting）**：帳號正在啟動過程中
- **停止中（stopping）**：帳號正在停止過程中
- **錯誤（error）**：帳號運行出現錯誤

#### 3.2 啟動帳號

**啟動流程：**

1. **選擇帳號**
   - 在帳號列表中選擇目標帳號
   - 確認帳號狀態為「離線」

2. **檢查前置條件**
   - 確認Session文件存在且有效
   - 確認已關聯劇本
   - 確認劇本已發布
   - 確認目標群組配置正確

3. **執行啟動**
   - 點擊「啟動」按鈕
   - 系統自動執行以下操作：
     - 加載Session文件
     - 初始化Pyrogram客戶端
     - 加載劇本引擎
     - 初始化對話管理器
     - 啟動消息監聽

4. **驗證啟動結果**
   - 檢查帳號狀態是否變為「在線」
   - 查看啟動日誌確認無錯誤
   - 測試發送消息驗證響應

#### 3.3 停止帳號

**停止流程：**

1. **選擇帳號**
   - 在帳號列表中選擇目標帳號
   - 確認帳號狀態為「在線」

2. **執行停止**
   - 點擊「停止」按鈕
   - 系統自動執行以下操作：
     - 停止消息監聽
     - 關閉Pyrogram客戶端
     - 清理對話上下文
     - 保存運行數據

3. **驗證停止結果**
   - 檢查帳號狀態是否變為「離線」
   - 確認資源已釋放

#### 3.4 重啟帳號

**重啟流程：**

1. **選擇帳號**
   - 在帳號列表中選擇目標帳號

2. **執行重啟**
   - 點擊「重啟」按鈕
   - 系統自動執行：停止 → 等待 → 啟動

3. **適用場景**
   - 修改帳號配置後需要重啟
   - 更換劇本後需要重啟
   - 帳號出現錯誤需要恢復

### 4. 帳號批量操作

#### 4.1 批量啟動/停止

**操作步驟：**

1. **選擇帳號**
   - 在帳號列表中勾選多個帳號
   - 或使用「全選」功能

2. **執行批量操作**
   - 點擊「批量啟動」或「批量停止」
   - 確認操作

3. **監控執行進度**
   - 查看批量操作進度條
   - 查看每個帳號的執行結果
   - 處理失敗的帳號

#### 4.2 批量配置更新

**操作步驟：**

1. **選擇帳號**
   - 勾選要更新的帳號

2. **配置更新內容**
   - 選擇要更新的參數（回復率、紅包功能等）
   - 輸入新值

3. **執行更新**
   - 點擊「批量更新」
   - 系統自動應用到所有選中帳號

### 5. 帳號數據同步

#### 5.1 數據同步機制

**同步內容：**

- 帳號運行狀態
- 消息統計數據
- 回復統計數據
- 錯誤日誌

**同步頻率：**

- 實時同步：狀態變更、錯誤發生
- 定時同步：每5分鐘同步統計數據
- 手動同步：點擊「刷新」按鈕

#### 5.2 數據備份與恢復

**備份內容：**

- 帳號配置信息
- Session文件
- 運行歷史數據

**備份操作：**

1. **執行備份**
   - 點擊「備份帳號數據」
   - 選擇備份範圍（全部/選中帳號）
   - 選擇備份位置

2. **恢復備份**
   - 點擊「恢復帳號數據」
   - 選擇備份文件
   - 確認恢復範圍

### 6. 帳號管理使用說明

#### 6.1 操作指引

**添加帳號：**

1. 準備`.session`文件
2. 上傳Session文件或掃描目錄
3. 填寫帳號信息和配置參數
4. 保存並啟動帳號

**管理帳號：**

1. 使用搜索和篩選功能快速定位帳號
2. 批量操作提高效率
3. 定期檢查帳號狀態和運行指標
4. 及時處理錯誤和異常

#### 6.2 注意事項

**Session文件：**

- 確保Session文件完整且有效
- 定期備份Session文件
- 不要在多個帳號間共享Session文件

**帳號安全：**

- 保護Session文件安全，避免泄露
- 定期檢查帳號登錄狀態
- 發現異常及時停止帳號

**性能優化：**

- 合理設置回復率和頻率限制
- 避免過多帳號同時運行
- 監控系統資源使用情況

---

## 角色分配流程

### 1. 角色提取與識別

#### 1.1 自動提取角色

**提取流程：**

1. **選擇劇本**
   - 導航至：`/group-ai/role-assignments`
   - 在「提取角色」標籤頁選擇劇本
   - 點擊「提取角色」按鈕

2. **角色識別規則**
   - 從劇本`metadata.roles`中提取
   - 從場景`responses.role`中提取
   - 自動去重和合併

3. **角色信息生成**
   - **角色ID**：唯一標識符
   - **角色名稱**：角色顯示名稱
   - **台詞數量**：該角色的對話行數
   - **工作負載**：基於台詞數量的權重計算

4. **查看提取結果**
   - 顯示角色列表
   - 顯示每個角色的統計信息
   - 支持手動調整角色信息

#### 1.2 角色定義規範

**劇本中的角色定義：**

```yaml
metadata:
  roles:
    - role_id: "role_001"
      role_name: "客服小助手"
      description: "負責回答客戶問題"
  
scenes:
  - scene_id: "scene_001"
    responses:
      - role: "role_001"  # 或使用 role_id
        content: "您好，有什麼可以幫您的嗎？"
```

### 2. 角色分配策略

#### 2.1 自動分配模式

**分配算法：**

1. **角色數 ≤ 帳號數（一對一分配）**
   - 每個角色分配給一個帳號
   - 優先選擇在線且負載較低的帳號
   - 確保帳號能力與角色負載匹配

2. **角色數 > 帳號數（負載均衡分配）**
   - 計算總工作負載
   - 平均分配到可用帳號
   - 考慮帳號當前負載
   - 確保負載盡量均衡

**分配步驟：**

1. **選擇劇本和帳號**
   - 選擇已提取角色的劇本
   - 選擇要參與分配的帳號（可多選）

2. **選擇分配模式**
   - 選擇「自動分配」
   - 系統自動計算分配方案

3. **查看分配預覽**
   - 顯示每個帳號分配到的角色
   - 顯示每個帳號的總負載
   - 顯示負載均衡度指標

4. **確認分配**
   - 檢查分配方案是否合理
   - 點擊「應用分配」確認

#### 2.2 手動分配模式

**分配步驟：**

1. **選擇劇本和帳號**
   - 選擇已提取角色的劇本
   - 選擇要參與分配的帳號

2. **選擇分配模式**
   - 選擇「手動分配」

3. **手動分配角色**
   - 為每個角色選擇對應的帳號
   - 支持一個角色分配給多個帳號（負載分攤）
   - 支持一個帳號承擔多個角色

4. **驗證分配方案**
   - 系統自動驗證分配完整性
   - 檢查是否有遺漏的角色
   - 檢查是否有未分配的帳號

5. **應用分配**
   - 點擊「應用分配」按鈕
   - 系統更新帳號的劇本配置

### 3. 分配方案管理

#### 3.1 分配方案創建

**創建流程：**

1. **提取角色**
   - 從劇本中提取所有角色

2. **選擇帳號**
   - 選擇要參與分配的帳號列表

3. **生成分配方案**
   - 自動或手動創建分配方案
   - 系統生成分配摘要

4. **保存方案**
   - 方案自動保存到系統
   - 支持為方案命名和添加描述

#### 3.2 分配方案審查

**審查內容：**

- **分配完整性**：所有角色是否都已分配
- **負載均衡**：各帳號負載是否均衡
- **帳號狀態**：分配的帳號是否在線
- **劇本兼容性**：帳號是否已關聯對應劇本

**審查步驟：**

1. **查看分配摘要**
   - 總角色數
   - 總帳號數
   - 分配模式
   - 負載分布圖

2. **查看詳細分配**
   - 每個帳號分配到的角色列表
   - 每個角色的工作負載
   - 每個帳號的總負載

3. **驗證分配結果**
   - 檢查分配邏輯是否合理
   - 確認無遺漏或重複分配

#### 3.3 分配方案應用

**應用流程：**

1. **確認方案**
   - 在「審查方案」標籤頁查看方案
   - 確認方案正確無誤

2. **執行應用**
   - 點擊「應用分配」按鈕
   - 確認操作

3. **系統執行**
   - 更新帳號的劇本配置
   - 更新角色分配關係
   - 如果帳號在線，自動重啟以應用新配置

4. **驗證結果**
   - 檢查帳號配置是否更新成功
   - 驗證角色分配是否正確
   - 測試帳號響應是否正常

### 4. 角色變更與撤銷

#### 4.1 角色變更

**變更場景：**

- 劇本更新後角色發生變化
- 需要調整角色分配
- 帳號狀態變更需要重新分配

**變更流程：**

1. **重新提取角色**
   - 如果劇本已更新，重新提取角色
   - 對比新舊角色列表

2. **調整分配方案**
   - 基於現有分配方案進行調整
   - 或創建全新的分配方案

3. **應用變更**
   - 確認變更內容
   - 應用新的分配方案

#### 4.2 角色撤銷

**撤銷流程：**

1. **選擇要撤銷的角色**
   - 在分配方案中選擇角色
   - 或選擇整個分配方案

2. **執行撤銷**
   - 點擊「撤銷分配」按鈕
   - 確認操作

3. **清理配置**
   - 移除帳號的角色配置
   - 更新帳號狀態

### 5. 角色分配使用說明

#### 5.1 最佳實踐

**分配原則：**

1. **負載均衡**
   - 盡量讓各帳號負載均衡
   - 避免單個帳號負載過重

2. **帳號能力匹配**
   - 根據帳號性能分配角色
   - 重要角色分配給穩定帳號

3. **靈活調整**
   - 根據運行情況調整分配
   - 定期優化分配方案

#### 5.2 常見問題

**Q1: 角色數量大於帳號數量怎麼辦？**

- 系統會自動將多個角色分配給一個帳號
- 根據工作負載進行負載均衡分配
- 建議增加帳號數量以獲得更好的性能

**Q2: 如何調整已應用的分配方案？**

- 重新進入角色分配頁面
- 選擇「手動分配」模式
- 調整角色與帳號的對應關係
- 應用新的分配方案

**Q3: 分配後帳號不響應怎麼辦？**

- 檢查帳號是否在線
- 檢查帳號是否已關聯劇本
- 檢查角色分配是否正確
- 查看帳號日誌排查問題

---

## 劇本運行監控

### 1. 實時監控功能

#### 1.1 系統狀態監控

**監控指標：**

- **總帳號數**：系統中註冊的帳號總數
- **在線帳號數**：當前在線運行的帳號數
- **總消息數**：系統處理的總消息數
- **總回復數**：AI生成的總回復數
- **總紅包數**：參與的紅包總數
- **總錯誤數**：系統發生的總錯誤數
- **平均回復時間**：AI響應的平均時間（毫秒）

**監控界面：**

- 導航至：`/group-ai/monitor`
- 實時更新監控指標
- 支持按時間範圍篩選

#### 1.2 帳號級別監控

**監控指標：**

- **帳號狀態**：在線/離線/錯誤
- **消息統計**：接收消息數、回復消息數
- **紅包統計**：收到紅包數、參與紅包數
- **成功率**：成功處理的消息比例
- **錯誤統計**：錯誤次數、錯誤類型
- **運行時長**：帳號在線運行時間
- **最後活動時間**：最後一次處理消息的時間

**監控操作：**

1. **查看帳號詳情**
   - 點擊帳號進入詳情頁
   - 查看詳細運行數據

2. **篩選帳號**
   - 按狀態篩選（在線/離線/錯誤）
   - 按劇本篩選
   - 按時間範圍篩選

#### 1.3 劇本運行監控

**監控內容：**

- **劇本使用情況**：哪些帳號在使用該劇本
- **場景觸發統計**：各場景的觸發次數
- **角色活躍度**：各角色的響應次數
- **劇本性能**：平均響應時間、成功率

### 2. 監控指標定義

#### 2.1 性能指標

**響應時間指標：**

- **平均響應時間**：所有回復的平均耗時
- **最小響應時間**：最快回復的耗時
- **最大響應時間**：最慢回復的耗時
- **P95響應時間**：95%的回復在此時間內完成

**吞吐量指標：**

- **每小時消息數**：系統每小時處理的消息數
- **每小時回復數**：系統每小時生成的回復數
- **並發處理能力**：同時處理的消息數

#### 2.2 質量指標

**成功率指標：**

- **消息處理成功率**：成功處理的消息比例
- **回復生成成功率**：成功生成回復的比例
- **劇本執行成功率**：劇本場景執行成功的比例

**錯誤率指標：**

- **總錯誤率**：錯誤次數/總操作次數
- **錯誤類型分布**：各類錯誤的占比
- **錯誤趨勢**：錯誤率隨時間的變化

#### 2.3 業務指標

**參與度指標：**

- **紅包參與率**：參與紅包的比例
- **消息響應率**：響應消息的比例
- **角色活躍度**：各角色的響應頻率

**效果指標：**

- **用戶互動次數**：與AI互動的用戶數
- **平均對話輪數**：每次對話的平均輪數
- **用戶滿意度**：基於反饋的滿意度評分

### 3. 告警規則與處理

#### 3.1 告警規則配置

**告警類型：**

1. **狀態告警**
   - 帳號離線告警
   - 帳號錯誤告警
   - 劇本執行失敗告警

2. **性能告警**
   - 響應時間過長告警
   - 錯誤率過高告警
   - 吞吐量異常告警

3. **業務告警**
   - 回復率過低告警
   - 紅包參與異常告警
   - 用戶互動異常告警

**告警規則設置：**

1. **創建告警規則**
   - 導航至：`/group-ai/monitor/alerts`
   - 點擊「+ 創建告警規則」

2. **配置告警條件**
   - 選擇告警類型
   - 設置觸發條件（閾值）
   - 設置持續時間（避免短暫波動觸發）

3. **配置通知方式**
   - 郵件通知
   - 系統內通知
   - Webhook通知

4. **保存規則**
   - 點擊「保存」按鈕
   - 規則立即生效

#### 3.2 告警處理流程

**處理步驟：**

1. **接收告警**
   - 系統自動檢測觸發條件
   - 發送告警通知

2. **查看告警詳情**
   - 查看告警類型
   - 查看觸發條件
   - 查看相關帳號或劇本

3. **分析問題**
   - 查看相關日誌
   - 檢查系統狀態
   - 分析根本原因

4. **處理問題**
   - 執行修復操作
   - 重啟帳號
   - 調整配置

5. **確認解決**
   - 驗證問題已解決
   - 標記告警為「已解決」
   - 記錄處理過程

### 4. 日誌記錄與分析

#### 4.1 日誌類型

**系統日誌：**

- **啟動日誌**：帳號啟動過程的日誌
- **運行日誌**：正常運行過程的日誌
- **錯誤日誌**：錯誤和異常的日誌
- **性能日誌**：性能相關的日誌

**業務日誌：**

- **消息日誌**：接收和發送的消息
- **場景日誌**：劇本場景的觸發和執行
- **角色日誌**：角色的響應記錄

#### 4.2 日誌查看與分析

**查看日誌：**

1. **帳號日誌**
   - 在帳號詳情頁查看日誌
   - 支持按時間、級別、關鍵詞篩選

2. **系統日誌**
   - 導航至：`/logs`
   - 查看所有系統日誌
   - 支持高級篩選和搜索

3. **日誌導出**
   - 支持導出為CSV或JSON格式
   - 支持按時間範圍導出

**日誌分析：**

- **錯誤分析**：統計錯誤類型和頻率
- **性能分析**：分析響應時間趨勢
- **業務分析**：分析用戶互動模式

### 5. 異常處理與反饋

#### 5.1 異常檢測

**檢測機制：**

- **實時監控**：持續監控系統狀態
- **定時檢查**：定期檢查關鍵指標
- **事件觸發**：特定事件觸發檢查

**異常類型：**

- **連接異常**：無法連接到Telegram服務器
- **認證異常**：Session失效或認證失敗
- **執行異常**：劇本執行過程中的錯誤
- **資源異常**：系統資源不足

#### 5.2 異常處理

**處理策略：**

1. **自動恢復**
   - 輕微錯誤自動重試
   - 連接斷開自動重連
   - 臨時故障自動恢復

2. **告警通知**
   - 嚴重錯誤發送告警
   - 通知管理員處理

3. **降級處理**
   - 系統負載過高時降級服務
   - 優先保證核心功能

**處理流程：**

1. **檢測異常**
   - 系統自動檢測或手動發現

2. **記錄異常**
   - 記錄異常詳情到日誌
   - 更新監控指標

3. **嘗試恢復**
   - 執行自動恢復策略
   - 或等待手動處理

4. **驗證恢復**
   - 確認問題已解決
   - 驗證系統正常運行

### 6. 監控功能使用說明

#### 6.1 操作指引

**日常監控：**

1. 定期查看系統總體狀態
2. 檢查在線帳號運行情況
3. 關注錯誤和告警信息
4. 分析性能指標趨勢

**問題排查：**

1. 查看相關日誌獲取詳細信息
2. 檢查帳號狀態和配置
3. 分析錯誤模式和頻率
4. 參考故障排查指南

#### 6.2 最佳實踐

**監控配置：**

- 設置合理的告警閾值
- 避免過於敏感的告警規則
- 定期審查和優化告警規則

**日誌管理：**

- 定期清理舊日誌
- 保留重要日誌用於分析
- 使用日誌分析工具提高效率

---

## 細緻化管理與功能配置

### 1. 權限細分管理

#### 1.1 角色權限體系

**權限級別：**

- **超級管理員**：所有權限
- **管理員**：除系統配置外的所有權限
- **操作員**：帳號和劇本管理權限
- **查看者**：僅查看權限

**權限細分：**

- **劇本管理權限**：
  - 查看劇本
  - 創建劇本
  - 編輯劇本
  - 刪除劇本
  - 發布劇本

- **帳號管理權限**：
  - 查看帳號
  - 添加帳號
  - 編輯帳號
  - 刪除帳號
  - 啟動/停止帳號

- **角色分配權限**：
  - 查看分配方案
  - 創建分配方案
  - 應用分配方案
  - 撤銷分配方案

- **監控權限**：
  - 查看監控數據
  - 配置告警規則
  - 查看日誌
  - 導出數據

#### 1.2 權限分配流程

**分配步驟：**

1. **創建用戶角色**
   - 定義角色名稱和描述
   - 選擇權限集合

2. **分配用戶角色**
   - 為用戶分配角色
   - 或直接分配具體權限

3. **驗證權限**
   - 測試用戶權限是否正確
   - 確認權限限制生效

### 2. 多維篩選與搜索

#### 2.1 劇本篩選

**篩選維度：**

- **按狀態**：草稿、審核中、已發布、已停用
- **按時間**：創建時間、更新時間
- **按標籤**：多標籤組合篩選
- **按版本**：版本號範圍
- **按創建人**：創建者篩選

**搜索功能：**

- **關鍵詞搜索**：劇本ID、名稱、描述
- **全文搜索**：搜索劇本內容
- **高級搜索**：組合多個條件

#### 2.2 帳號篩選

**篩選維度：**

- **按狀態**：離線、在線、錯誤
- **按劇本**：關聯的劇本
- **按群組**：目標群組
- **按時間**：創建時間、最後活動時間
- **按性能**：消息數、回復數、錯誤數

**搜索功能：**

- **帳號ID搜索**：精確匹配
- **Session文件搜索**：按文件路徑搜索
- **組合搜索**：多條件組合

#### 2.3 監控數據篩選

**篩選維度：**

- **按時間範圍**：開始時間、結束時間
- **按帳號**：單個或多個帳號
- **按劇本**：單個或多個劇本
- **按指標類型**：消息、回復、錯誤等
- **按告警級別**：信息、警告、錯誤

### 3. 自動化任務配置

#### 3.1 定時任務

**任務類型：**

- **數據備份**：定期備份帳號和劇本數據
- **日誌清理**：定期清理舊日誌
- **狀態檢查**：定期檢查帳號狀態
- **性能報告**：定期生成性能報告

**配置步驟：**

1. **創建定時任務**
   - 選擇任務類型
   - 設置執行頻率（每天、每週、每月）
   - 設置執行時間

2. **配置任務參數**
   - 設置任務具體參數
   - 配置通知方式

3. **啟用任務**
   - 保存並啟用任務
   - 任務按計劃自動執行

#### 3.2 觸發式任務

**觸發條件：**

- **帳號上線**：帳號啟動時觸發
- **帳號下線**：帳號停止時觸發
- **錯誤發生**：特定錯誤發生時觸發
- **告警觸發**：告警規則觸發時執行

**任務操作：**

- **發送通知**：發送郵件或系統通知
- **執行腳本**：執行自定義腳本
- **調用API**：調用外部API
- **數據導出**：導出相關數據

### 4. 配置界面與參數調整

#### 4.1 系統配置

**配置項：**

- **Session目錄**：Session文件存儲目錄
- **日誌級別**：系統日誌級別
- **緩存配置**：Redis緩存配置
- **數據庫配置**：數據庫連接配置

**配置方式：**

1. **環境變量配置**
   - 通過`.env`文件配置
   - 支持不同環境的配置

2. **系統設置界面**
   - 導航至：`/settings`
   - 在線修改配置
   - 需要重啟服務生效

#### 4.2 帳號參數調整

**調整方式：**

1. **單個帳號調整**
   - 在帳號詳情頁編輯參數
   - 保存後立即生效（在線帳號需重啟）

2. **批量參數調整**
   - 選擇多個帳號
   - 批量設置參數值
   - 一鍵應用

3. **參數模板**
   - 創建參數模板
   - 應用模板到帳號
   - 快速配置相似帳號

#### 4.3 劇本參數調整

**調整內容：**

- **場景觸發條件**：關鍵詞、正則表達式
- **響應概率**：各響應的觸發概率
- **角色配置**：角色相關參數
- **元數據**：劇本元數據信息

### 5. 數據導出與報告

#### 5.1 數據導出

**導出類型：**

- **帳號數據**：帳號列表和配置
- **劇本數據**：劇本列表和內容
- **監控數據**：監控指標和統計
- **日誌數據**：系統和業務日誌

**導出格式：**

- **CSV格式**：適合Excel分析
- **JSON格式**：適合程序處理
- **PDF格式**：適合打印和分享

**導出操作：**

1. **選擇導出內容**
   - 選擇要導出的數據類型
   - 設置篩選條件

2. **選擇導出格式**
   - 選擇文件格式
   - 設置導出選項

3. **執行導出**
   - 點擊「導出」按鈕
   - 下載生成的文件

#### 5.2 報告生成

**報告類型：**

- **日報**：每日運行情況報告
- **週報**：每週運行情況報告
- **月報**：每月運行情況報告
- **自定義報告**：按需生成的報告

**報告內容：**

- **運行概況**：帳號狀態、消息統計
- **性能分析**：響應時間、吞吐量
- **錯誤分析**：錯誤類型和頻率
- **業務分析**：用戶互動、角色活躍度

**生成方式：**

1. **自動生成**
   - 配置定時任務
   - 系統自動生成報告
   - 發送到指定郵箱

2. **手動生成**
   - 選擇報告類型
   - 設置時間範圍
   - 點擊「生成報告」

---

## 常見問題與故障排查

### 1. 劇本管理問題

#### Q1: 劇本保存失敗

**可能原因：**
- YAML語法錯誤
- 必填字段缺失
- 文件大小超限

**解決方法：**
1. 檢查YAML語法，使用在線驗證工具
2. 確認所有必填字段已填寫
3. 檢查文件大小，必要時壓縮內容
4. 查看錯誤日誌獲取詳細信息

#### Q2: 劇本無法發布

**可能原因：**
- 劇本語法錯誤未修復
- 角色定義不完整
- 場景邏輯有問題

**解決方法：**
1. 運行劇本驗證工具檢查錯誤
2. 修復所有語法和邏輯錯誤
3. 確認角色定義完整
4. 重新提交審核

### 2. 帳號管理問題

#### Q1: 帳號無法啟動

**可能原因：**
- Session文件無效或損壞
- 帳號未關聯劇本
- 目標群組配置錯誤
- 系統資源不足

**解決方法：**
1. 檢查Session文件是否存在且有效
2. 確認帳號已關聯有效的劇本
3. 驗證目標群組ID是否正確
4. 檢查系統資源（內存、CPU）
5. 查看啟動日誌獲取詳細錯誤信息

#### Q2: 帳號頻繁離線

**可能原因：**
- Session失效
- 網絡連接不穩定
- Telegram服務器問題
- 帳號被限制

**解決方法：**
1. 重新獲取Session文件
2. 檢查網絡連接穩定性
3. 查看Telegram服務狀態
4. 檢查帳號是否被Telegram限制
5. 啟用自動重連功能

#### Q3: 帳號不響應消息

**可能原因：**
- 帳號未在線
- 劇本未正確加載
- 觸發條件不匹配
- 回復率設置過低

**解決方法：**
1. 確認帳號狀態為「在線」
2. 檢查劇本是否正確加載
3. 驗證消息是否匹配觸發條件
4. 檢查回復率配置
5. 查看帳號日誌排查問題

### 3. 角色分配問題

#### Q1: 角色提取失敗

**可能原因：**
- 劇本格式不正確
- 角色定義缺失
- 劇本文件損壞

**解決方法：**
1. 檢查劇本YAML格式
2. 確認劇本中包含角色定義
3. 驗證劇本文件完整性
4. 手動定義角色信息

#### Q2: 分配方案無法應用

**可能原因：**
- 帳號未在線
- 帳號未關聯劇本
- 角色定義不完整

**解決方法：**
1. 確認所有帳號狀態正常
2. 檢查帳號是否已關聯對應劇本
3. 驗證角色定義完整性
4. 查看應用日誌獲取錯誤信息

### 4. 監控問題

#### Q1: 監控數據不更新

**可能原因：**
- 監控服務未運行
- 數據同步延遲
- 緩存問題

**解決方法：**
1. 檢查監控服務狀態
2. 等待數據同步（最多5分鐘）
3. 手動刷新頁面
4. 清除瀏覽器緩存

#### Q2: 告警未觸發

**可能原因：**
- 告警規則配置錯誤
- 通知方式未配置
- 告警被標記為已解決

**解決方法：**
1. 檢查告警規則配置
2. 驗證觸發條件是否正確
3. 確認通知方式已配置
4. 測試告警規則是否正常

### 5. 系統性能問題

#### Q1: 系統響應緩慢

**可能原因：**
- 系統資源不足
- 數據庫查詢慢
- 緩存未生效
- 網絡延遲

**解決方法：**
1. 檢查系統資源使用情況
2. 優化數據庫查詢
3. 啟用Redis緩存
4. 檢查網絡連接
5. 考慮擴展系統資源

#### Q2: 帳號處理消息慢

**可能原因：**
- 劇本邏輯複雜
- AI響應慢
- 系統負載高
- 網絡延遲

**解決方法：**
1. 優化劇本邏輯
2. 檢查AI服務響應時間
3. 降低系統負載
4. 優化網絡連接
5. 調整帳號參數（降低回復率）

### 6. 故障排查流程

#### 6.1 問題診斷步驟

1. **收集信息**
   - 問題描述
   - 發生時間
   - 相關帳號或劇本
   - 錯誤消息

2. **查看日誌**
   - 系統日誌
   - 帳號日誌
   - 錯誤日誌

3. **檢查狀態**
   - 帳號狀態
   - 系統狀態
   - 服務狀態

4. **分析原因**
   - 對比正常情況
   - 查找相關文檔
   - 諮詢技術支持

5. **執行修復**
   - 應用修復方案
   - 驗證修復效果
   - 記錄處理過程

#### 6.2 緊急處理流程

**帳號大面積離線：**

1. 立即檢查系統狀態
2. 查看錯誤日誌
3. 檢查網絡連接
4. 嘗試重啟服務
5. 聯繫技術支持

**數據丟失：**

1. 停止相關操作
2. 檢查備份數據
3. 嘗試數據恢復
4. 驗證數據完整性
5. 修復數據問題

**安全問題：**

1. 立即停止相關帳號
2. 檢查系統日誌
3. 更改相關密碼
4. 通知管理員
5. 進行安全審計

---

## 附錄

### A. 快速參考

#### A.1 常用操作快捷鍵

- **刷新數據**：`F5` 或 `Ctrl+R`
- **搜索**：`Ctrl+F`
- **新建**：`Ctrl+N`
- **保存**：`Ctrl+S`
- **導出**：`Ctrl+E`

#### A.2 常用API端點

- **帳號列表**：`GET /api/v1/group-ai/accounts/`
- **劇本列表**：`GET /api/v1/group-ai/scripts/`
- **角色提取**：`POST /api/v1/group-ai/role-assignments/extract-roles`
- **系統監控**：`GET /api/v1/group-ai/monitor/system`

### B. 術語表

- **劇本（Script）**：定義AI行為的YAML配置文件
- **帳號（Account）**：Telegram帳號實例
- **角色（Role）**：劇本中定義的角色
- **場景（Scene）**：劇本中的一個對話場景
- **觸發（Trigger）**：觸發AI響應的條件
- **Session文件**：Telegram客戶端會話文件

### C. 版本歷史

- **v1.0.0**：初始版本，包含基本功能
- **v1.1.0**：添加角色分配功能
- **v1.2.0**：增強監控和告警功能

---

**文檔版本**：1.0.0  
**最後更新**：2024年  
**維護者**：系統開發團隊

