# 遠端賬號管理完整方案

> **日期**: 2025-12-01  
> **需求**: 後台管理遠端服務器和其他電腦上的 Telegram 賬號

---

## 🎯 核心需求

1. **讀取遠端賬號運行信息**
   - 從遠端服務器/其他電腦獲取賬號列表
   - 獲取賬號運行狀態（在線/離線/錯誤）
   - 獲取賬號統計信息（消息數、回復數等）

2. **劇本傳送**
   - 將劇本推送到遠端節點
   - 遠端節點自動更新劇本
   - 支持批量推送

3. **會話管理**
   - 同步會話文件到遠端
   - 管理遠端會話文件
   - 會話文件備份和恢復

---

## 🏗️ 系統架構

### 架構圖

```
┌─────────────────────────────────────────────────┐
│              後台管理系統（主節點）              │
│  - 賬號管理界面                                  │
│  - 劇本管理                                      │
│  - Worker 節點管理                              │
└────────────┬────────────────────────────────────┘
             │
             │ HTTP API + Redis
             │
    ┌────────┴────────┐
    │                 │
┌───▼─────┐    ┌──────▼──────┐
│ Worker  │    │   Worker    │
│ 節點 1  │    │   節點 2    │
│         │    │             │
│ 賬號 A  │    │  賬號 B     │
│ 賬號 B  │    │  賬號 C     │
│         │    │             │
│ 劇本 X  │    │  劇本 Y     │
└─────────┘    └─────────────┘
```

---

## 🔧 實現方案

### 1. 遠端賬號同步

#### 工作流程

1. **Worker 節點發送心跳**
   ```python
   POST /api/v1/workers/heartbeat
   {
     "node_id": "computer_001",
     "status": "online",
     "account_count": 3,
     "accounts": [
       {
         "account_id": "+1234567890",
         "status": "online",
         "script_id": "script_001",
         "message_count": 150,
         "reply_count": 45,
         "last_activity": "2025-12-01T18:00:00",
         "session_file": "/path/to/session.session"
       }
     ]
   }
   ```

2. **後台自動同步**
   - 接收心跳
   - 同步賬號信息到數據庫
   - 更新賬號狀態

3. **前端顯示**
   - 顯示所有賬號（本地+遠端）
   - 標記賬號來源節點
   - 實時更新狀態

#### 實現文件

- `admin-backend/app/api/group_ai/remote_account_sync.py` ✅ 已創建
- `admin-backend/app/api/workers.py` - 修改心跳處理

---

### 2. 劇本傳送

#### 工作流程

1. **後台推送劇本**
   - 選擇劇本
   - 選擇目標節點
   - 發送推送命令

2. **Worker 節點接收命令**
   - 從命令隊列獲取命令
   - 下載劇本文件
   - 更新本地劇本
   - 重載賬號（可選）

3. **推送結果反饋**
   - Worker 節點執行結果
   - 後台顯示推送狀態

#### 實現文件

- `admin-backend/app/api/group_ai/script_deployment.py` ✅ 已創建

---

### 3. 會話管理

#### 工作流程

1. **上傳會話文件**
   - 在後台上傳 `.session` 文件
   - 選擇目標節點
   - 傳輸會話文件

2. **會話文件同步**
   - 通過 SSH 或 HTTP 傳輸
   - 遠端節點保存會話文件
   - 遠端節點加載會話

3. **會話文件管理**
   - 下載會話文件
   - 備份會話文件
   - 刪除會話文件

---

## 📝 Worker 節點實現要求

### Worker 節點需要實現的功能

1. **心跳機制**
   - 每 30 秒發送心跳
   - 包含賬號列表和狀態

2. **命令處理**
   - 從命令隊列獲取命令
   - 執行命令（劇本更新、賬號控制等）
   - 反饋執行結果

3. **劇本下載**
   - 從後台下載劇本文件
   - 保存到本地
   - 更新賬號劇本

---

## 🚀 實施步驟

### 階段 1: 遠端賬號同步（已完成基礎）

- ✅ 創建 `remote_account_sync.py`
- ⏳ 修改 `workers.py` 心跳處理
- ⏳ 測試賬號同步

### 階段 2: 劇本傳送（已創建基礎）

- ✅ 創建 `script_deployment.py`
- ⏳ 實現劇本下載端點
- ⏳ 前端 UI 實現

### 階段 3: 會話管理（待實現）

- ⏳ 會話文件傳輸功能
- ⏳ 會話管理 UI

---

## 📋 使用場景示例

### 場景 1: 查看所有遠端賬號

1. Worker 節點每 30 秒發送心跳（包含賬號列表）
2. 後台自動同步賬號到數據庫
3. 前端顯示所有賬號，標記來源節點

### 場景 2: 推送劇本到所有節點

1. 在後台選擇劇本
2. 選擇「推送到所有節點」
3. 後台發送命令到所有 Worker 節點
4. Worker 節點自動下載並更新劇本

### 場景 3: 上傳會話到遠端節點

1. 在後台上傳 `.session` 文件
2. 選擇目標 Worker 節點
3. 後台通過命令隊列發送傳輸指令
4. Worker 節點接收並保存會話文件

---

**基礎架構已建立，可以開始完整實現！**
