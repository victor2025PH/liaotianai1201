# 服务器部署和测试方案

## 正确的测试流程

### 理解
用户指出：**测试session文件应该是在服务器上部署和启动，不应该在本地启动测试。**

### 正确的流程

1. **扫描本地session文件**
   - 从本地 `sessions/` 目录扫描session文件
   - 显示可用的session文件列表

2. **批量创建账号（自动分配到服务器）**
   - 选择多个session文件
   - 批量创建账号
   - **系统会自动将session文件上传到服务器并分配**
   - 账号会在服务器上创建，而不是本地

3. **在服务器上启动账号**
   - 账号创建后，session文件已在服务器上
   - 启动账号时，账号在服务器上运行
   - 不是在本地的AccountManager中运行

4. **在服务器上测试建群和聊天**
   - 账号在服务器上运行
   - 建群和聊天功能在服务器上执行
   - 通过API调用服务器上的账号

## 系统架构

### 账号创建流程
```
1. 用户选择session文件
   ↓
2. 调用 create_account API
   ↓
3. IntelligentAllocator 智能分配服务器
   ↓
4. SessionUploader 上传session文件到服务器
   ↓
5. 账号在数据库中创建（server_id已分配）
   ↓
6. 账号在服务器上，不在本地AccountManager中
```

### 账号启动流程
```
1. 用户点击"启动"按钮
   ↓
2. 调用 start_account API
   ↓
3. 系统检查账号的server_id
   ↓
4. 如果server_id存在，在服务器上启动账号
   ↓
5. 如果server_id不存在，在本地启动（旧逻辑）
```

## 当前问题

### 问题1：测试脚本在本地启动账号
- ❌ 之前的测试脚本直接在本地启动账号
- ✅ 应该：账号应该在服务器上启动

### 问题2：测试流程不正确
- ❌ 在本地测试session文件
- ✅ 应该：session文件部署到服务器，在服务器上测试

## 正确的测试方案

### 步骤1：批量创建账号（自动分配到服务器）

1. **扫描session文件**
   ```powershell
   # 扫描本地sessions目录
   Get-ChildItem -Path "sessions" -Filter "*.session"
   ```

2. **批量创建账号**
   - 使用前端界面批量选择session文件
   - 点击"批量创建"按钮
   - 系统会自动：
     - 智能分配服务器
     - 上传session文件到服务器
     - 在数据库中创建账号记录（包含server_id）

### 步骤2：在服务器上启动账号

1. **查看账号列表**
   - 确认账号已分配到服务器（server_id不为空）
   - 确认账号状态

2. **启动账号**
   - 点击"启动"按钮
   - 系统会在服务器上启动账号
   - 不是在本地的AccountManager中启动

### 步骤3：在服务器上测试建群和聊天

1. **创建群组**
   - 账号在服务器上运行
   - 创建群组时，使用服务器上的账号client

2. **测试按剧本聊天**
   - 发送测试消息到群组
   - 服务器上的账号检测到消息
   - 服务器上的账号按照剧本自动回复

## 需要检查的功能

### 1. 服务器分配功能
- ✅ 检查 `IntelligentAllocator` 是否正常工作
- ✅ 检查 `SessionUploader` 是否正常上传
- ✅ 检查账号创建时是否自动分配server_id

### 2. 服务器启动功能
- ⚠️  检查 `start_account` API是否支持服务器启动
- ⚠️  检查是否有远程启动服务器的机制

### 3. 服务器上的账号管理
- ⚠️  检查服务器上的账号如何管理
- ⚠️  检查服务器上的账号状态如何同步

## 下一步

1. **检查服务器分配功能**
   - 验证账号创建时是否自动分配到服务器
   - 验证session文件是否上传到服务器

2. **检查服务器启动功能**
   - 验证账号启动时是否在服务器上启动
   - 验证服务器上的账号状态

3. **调整测试方案**
   - 创建针对服务器部署的测试脚本
   - 测试服务器上的账号建群和聊天功能

