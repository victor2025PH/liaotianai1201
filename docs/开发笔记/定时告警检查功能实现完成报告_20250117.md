# å®šæ—¶å‘Šè­¦æ£€æŸ¥åŠŸèƒ½å®ç°å®ŒæˆæŠ¥å‘Š

> **ç”Ÿæˆæ—¶é—´**: 2025-01-17  
> **å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ  
> **æŠ¥å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ“Š å®Œæˆæ¦‚è¿°

### å®ç°çš„åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡ | âœ… å®Œæˆ | è‡ªåŠ¨å®šæœŸæ‰§è¡Œå‘Šè­¦è§„åˆ™æ£€æŸ¥ |
| ç¯å¢ƒå˜é‡é…ç½® | âœ… å®Œæˆ | å¯é…ç½®æ£€æŸ¥é—´éš”å’Œå¯ç”¨çŠ¶æ€ |
| å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ | âœ… å®Œæˆ | FastAPI å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨æœåŠ¡ |
| æ‰‹åŠ¨æ§åˆ¶æ¥å£ | âœ… å®Œæˆ | API æ¥å£å¯åŠ¨/åœæ­¢/æŸ¥è¯¢çŠ¶æ€ |

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡

**æ–‡ä»¶**: `admin-backend/app/services/scheduled_alert_checker.py`

**åŠŸèƒ½**:
- âœ… å®šæœŸæ‰§è¡Œå‘Šè­¦è§„åˆ™æ£€æŸ¥
- âœ… ä»æ•°æ®åº“è¯»å–å¯ç”¨çš„å‘Šè­¦è§„åˆ™
- âœ… è‡ªåŠ¨å‘é€é€šçŸ¥ï¼ˆå¦‚æœè§„åˆ™è§¦å‘ï¼‰
- âœ… æ”¯æŒå¯åŠ¨å’Œåœæ­¢
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**ä¸»è¦æ–¹æ³•**:
- `start()` - å¯åŠ¨å®šæ—¶æœåŠ¡
- `stop()` - åœæ­¢å®šæ—¶æœåŠ¡
- `check_once()` - æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ£€æŸ¥
- `_check_alerts()` - æ‰§è¡Œå‘Šè­¦æ£€æŸ¥
- `_run_periodic()` - å‘¨æœŸæ€§è¿è¡Œ

---

### 2. ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: `admin-backend/app/core/config.py`

**æ–°å¢é…ç½®**:
- `alert_check_interval_seconds`: æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 300 ç§’ï¼ˆ5 åˆ†é’Ÿï¼‰
- `alert_check_enabled`: æ˜¯å¦å¯ç”¨å®šæ—¶å‘Šè­¦æ£€æŸ¥ï¼Œé»˜è®¤å¯ç”¨

**æ–‡ä»¶**: `docs/env.example`

**æ–°å¢é…ç½®è¯´æ˜**:
```bash
# æ˜¯å¦å¯ç”¨å®šæ—¶å‘Šè­¦æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œé»˜è®¤: trueï¼‰
ALERT_CHECK_ENABLED=true

# å‘Šè­¦æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼Œå¯é€‰ï¼Œé»˜è®¤: 300ï¼Œå³ 5 åˆ†é’Ÿï¼‰
ALERT_CHECK_INTERVAL_SECONDS=300
```

---

### 3. FastAPI é›†æˆ

**æ–‡ä»¶**: `admin-backend/app/main.py`

**æ”¹è¿›**:
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡
- âœ… å…³é—­æ—¶è‡ªåŠ¨åœæ­¢å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**ä»£ç **:
```python
@app.on_event("startup")
async def on_startup() -> None:
    # ... å…¶ä»–å¯åŠ¨é€»è¾‘ ...
    
    # å•Ÿå‹•å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
    if settings.alert_check_enabled:
        try:
            from app.services.scheduled_alert_checker import get_scheduled_checker
            checker = get_scheduled_checker()
            checker.start()
            logger.info(f"å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™å·²å•Ÿå‹•ï¼Œæª¢æŸ¥é–“éš”: {checker.interval_seconds} ç§’")
        except Exception as e:
            logger.warning(f"å•Ÿå‹•å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™å¤±æ•—: {e}", exc_info=True)


@app.on_event("shutdown")
async def on_shutdown() -> None:
    """æ‡‰ç”¨é—œé–‰æ™‚åœæ­¢å®šæ™‚ä»»å‹™"""
    try:
        from app.services.scheduled_alert_checker import get_scheduled_checker
        checker = get_scheduled_checker()
        if checker.is_running:
            checker.stop()
            logger.info("å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™å·²åœæ­¢")
    except Exception as e:
        logger.warning(f"åœæ­¢å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™å¤±æ•—: {e}", exc_info=True)
```

---

### 4. API æ§åˆ¶æ¥å£

**æ–‡ä»¶**: `admin-backend/app/api/group_ai/monitor.py`

**æ–°å¢ç«¯ç‚¹**:

#### 1. è·å–å®šæ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€

```http
GET /api/v1/group-ai/monitor/scheduled-checker/status
```

**å“åº”**:
```json
{
  "enabled": true,
  "interval_seconds": 300,
  "status": "running"
}
```

---

#### 2. å¯åŠ¨å®šæ—¶æ£€æŸ¥æœåŠ¡

```http
POST /api/v1/group-ai/monitor/scheduled-checker/start
```

**å“åº”**:
```json
{
  "message": "å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™å·²å•Ÿå‹•",
  "status": "running",
  "interval_seconds": 300
}
```

---

#### 3. åœæ­¢å®šæ—¶æ£€æŸ¥æœåŠ¡

```http
POST /api/v1/group-ai/monitor/scheduled-checker/stop
```

**å“åº”**:
```json
{
  "message": "å®šæ™‚å‘Šè­¦æª¢æŸ¥æœå‹™å·²åœæ­¢",
  "status": "stopped"
}
```

---

## ğŸ”§ å·¥ä½œåŸç†

### 1. å¯åŠ¨æµç¨‹

1. FastAPI åº”ç”¨å¯åŠ¨
2. `on_startup` äº‹ä»¶è§¦å‘
3. æ£€æŸ¥ `alert_check_enabled` é…ç½®
4. å¦‚æœå¯ç”¨ï¼Œå¯åŠ¨å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡
5. åˆ›å»º asyncio Taskï¼Œå¼€å§‹å‘¨æœŸæ€§æ£€æŸ¥

### 2. æ£€æŸ¥æµç¨‹

1. ç­‰å¾…æ£€æŸ¥é—´éš”ï¼ˆé»˜è®¤ 300 ç§’ï¼‰
2. ä»æ•°æ®åº“è¯»å–å¯ç”¨çš„å‘Šè­¦è§„åˆ™
3. ä½¿ç”¨ `monitor_service.check_alerts()` æ‰§è¡Œæ£€æŸ¥
4. å¦‚æœè§¦å‘å‘Šè­¦ï¼Œè‡ªåŠ¨å‘é€é€šçŸ¥ï¼ˆEmail/Webhook/Telegramï¼‰
5. è®°å½•æ—¥å¿—
6. ç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯

### 3. åœæ­¢æµç¨‹

1. FastAPI åº”ç”¨å…³é—­
2. `on_shutdown` äº‹ä»¶è§¦å‘
3. è®¾ç½® `stop_event`
4. å–æ¶ˆ asyncio Task
5. æ¸…ç†èµ„æº

---

## ğŸ“‹ ä½¿ç”¨æ–¹å¼

### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```bash
# å¯ç”¨å®šæ—¶å‘Šè­¦æ£€æŸ¥ï¼ˆé»˜è®¤: trueï¼‰
ALERT_CHECK_ENABLED=true

# è®¾ç½®æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼Œé»˜è®¤: 300ï¼Œå³ 5 åˆ†é’Ÿï¼‰
ALERT_CHECK_INTERVAL_SECONDS=300
```

---

### 2. åˆ›å»ºå‘Šè­¦è§„åˆ™

ä½¿ç”¨ API åˆ›å»ºå‘Šè­¦è§„åˆ™ï¼š

```bash
POST /api/v1/group-ai/alert-rules/
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "è´¦å·é”™è¯¯ç‡è­¦å‘Š",
  "rule_type": "error_rate",
  "alert_level": "warning",
  "threshold_value": 0.2,
  "threshold_operator": ">",
  "enabled": true,
  "notification_method": "email",
  "notification_target": "admin@example.com",
  "description": "å½“è´¦å·é”™è¯¯ç‡è¶…è¿‡ 20% æ—¶å‘é€é‚®ä»¶å‘Šè­¦"
}
```

---

### 3. å¯åŠ¨åº”ç”¨

```bash
cd admin-backend
poetry run uvicorn app.main:app --reload
```

å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡å°†è‡ªåŠ¨å¯åŠ¨ã€‚

---

### 4. æ‰‹åŠ¨æ§åˆ¶

**æŸ¥çœ‹çŠ¶æ€**:
```bash
GET /api/v1/group-ai/monitor/scheduled-checker/status
Authorization: Bearer <token>
```

**å¯åŠ¨æœåŠ¡**:
```bash
POST /api/v1/group-ai/monitor/scheduled-checker/start
Authorization: Bearer <token>
```

**åœæ­¢æœåŠ¡**:
```bash
POST /api/v1/group-ai/monitor/scheduled-checker/stop
Authorization: Bearer <token>
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

1. `admin-backend/app/services/scheduled_alert_checker.py` - å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡

### ä¿®æ”¹æ–‡ä»¶

1. `admin-backend/app/core/config.py` - æ·»åŠ å®šæ—¶å‘Šè­¦æ£€æŸ¥é…ç½®
2. `admin-backend/app/main.py` - é›†æˆå¯åŠ¨å’Œå…³é—­äº‹ä»¶
3. `admin-backend/app/api/group_ai/monitor.py` - æ·»åŠ æ§åˆ¶æ¥å£
4. `docs/env.example` - æ·»åŠ é…ç½®è¯´æ˜

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. äº‹ä»¶å¾ªç¯

å®šæ—¶å‘Šè­¦æ£€æŸ¥æœåŠ¡ä½¿ç”¨ asyncio Taskï¼Œéœ€è¦ç¡®ä¿ï¼š
- FastAPI åº”ç”¨è¿è¡Œåœ¨ asyncio äº‹ä»¶å¾ªç¯ä¸­
- å¯åŠ¨æ—¶äº‹ä»¶å¾ªç¯å·²è¿è¡Œ

### 2. æ•°æ®åº“è¿æ¥

æ¯æ¬¡æ£€æŸ¥éƒ½ä¼šåˆ›å»ºæ–°çš„æ•°æ®åº“ä¼šè¯ï¼š
- ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸
- åŠæ—¶å…³é—­ä¼šè¯ï¼Œé¿å…è¿æ¥æ³„æ¼

### 3. é”™è¯¯å¤„ç†

- æ£€æŸ¥å¤±è´¥ä¸ä¼šå½±å“åº”ç”¨è¿è¡Œ
- é”™è¯¯ä¼šè®°å½•åˆ°æ—¥å¿—
- æœåŠ¡ä¼šç»§ç»­è¿è¡Œï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ£€æŸ¥

### 4. æ€§èƒ½è€ƒè™‘

- æ£€æŸ¥é—´éš”ä¸åº”è¿‡çŸ­ï¼ˆå»ºè®® >= 60 ç§’ï¼‰
- å¤§é‡è§„åˆ™å¯èƒ½å½±å“æ€§èƒ½
- å»ºè®®ç›‘æ§æ£€æŸ¥æ‰§è¡Œæ—¶é—´

---

## ğŸ¯ ç‰¹æ€§

### 1. è‡ªåŠ¨å¯åŠ¨

- âœ… åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨
- âœ… æ— éœ€æ‰‹åŠ¨å¹²é¢„
- âœ… å¯é€šè¿‡ç¯å¢ƒå˜é‡ç¦ç”¨

### 2. çµæ´»é…ç½®

- âœ… å¯é…ç½®æ£€æŸ¥é—´éš”
- âœ… å¯å¯ç”¨/ç¦ç”¨æœåŠ¡
- âœ… æ”¯æŒè¿è¡Œæ—¶æ§åˆ¶

### 3. é”™è¯¯å¤„ç†

- âœ… å¼‚å¸¸ä¸å½±å“åº”ç”¨è¿è¡Œ
- âœ… è¯¦ç»†é”™è¯¯æ—¥å¿—
- âœ… è‡ªåŠ¨æ¢å¤æœºåˆ¶

### 4. é›†æˆé€šçŸ¥

- âœ… è‡ªåŠ¨å‘é€é€šçŸ¥ï¼ˆå¦‚æœè§„åˆ™è§¦å‘ï¼‰
- âœ… æ”¯æŒå¤šç§é€šçŸ¥æ–¹å¼
- âœ… å¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡ä¸»æµç¨‹

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é€šçŸ¥æœåŠ¡å®ç°æŠ¥å‘Š](./é€šçŸ¥æœåŠ¡å®ç°å®ŒæˆæŠ¥å‘Š_20250117.md)
- [å‘Šè­¦è§„åˆ™é…ç½®ç³»ç»Ÿ](./å‘Šè­¦è§„åˆ™é…ç½®ç³»ç»Ÿå®ç°æŠ¥å‘Š_20250117.md)
- [å‘Šè­¦è§„åˆ™é›†æˆ](./å‘Šè­¦è§„åˆ™é›†æˆå®ŒæˆæŠ¥å‘Š_20250117.md)

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´æµç¨‹

1. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   ALERT_CHECK_ENABLED=true
   ALERT_CHECK_INTERVAL_SECONDS=300
   ```

2. **åˆ›å»ºå‘Šè­¦è§„åˆ™**
   ```bash
   POST /api/v1/group-ai/alert-rules/
   {
     "name": "è´¦å·é”™è¯¯ç‡è­¦å‘Š",
     "rule_type": "error_rate",
     "notification_method": "email",
     "notification_target": "admin@example.com"
   }
   ```

3. **å¯åŠ¨åº”ç”¨**
   ```bash
   poetry run uvicorn app.main:app --reload
   ```

4. **éªŒè¯æœåŠ¡**
   ```bash
   GET /api/v1/group-ai/monitor/scheduled-checker/status
   # è¿”å›: {"enabled": true, "interval_seconds": 300, "status": "running"}
   ```

5. **æ¥æ”¶å‘Šè­¦**
   - å®šæ—¶æ£€æŸ¥æ‰§è¡Œ
   - å¦‚æœè§„åˆ™è§¦å‘ï¼Œè‡ªåŠ¨å‘é€é€šçŸ¥
   - æŸ¥çœ‹æ—¥å¿—ç¡®è®¤

---

## âœ… æˆåŠŸè¦ç‚¹

1. **è‡ªåŠ¨åŒ–**
   - æ— éœ€æ‰‹åŠ¨è§¦å‘
   - åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹
   - åå°æŒç»­è¿è¡Œ

2. **çµæ´»æ€§**
   - å¯é…ç½®æ£€æŸ¥é—´éš”
   - å¯å¯ç”¨/ç¦ç”¨
   - æ”¯æŒè¿è¡Œæ—¶æ§åˆ¶

3. **å¯é æ€§**
   - é”™è¯¯ä¸å½±å“åº”ç”¨
   - è¯¦ç»†æ—¥å¿—è®°å½•
   - è‡ªåŠ¨æ¢å¤æœºåˆ¶

4. **é›†æˆæ€§**
   - ä¸å‘Šè­¦è§„åˆ™ç³»ç»Ÿé›†æˆ
   - ä¸é€šçŸ¥æœåŠ¡é›†æˆ
   - æ— ç¼å·¥ä½œæµç¨‹

---

**æŠ¥å‘Šç”Ÿæˆå®Œæˆæ—¶é—´**: 2025-01-17  
**å½“å‰çŠ¶æ€**: ğŸŸ¢ å®šæ—¶å‘Šè­¦æ£€æŸ¥åŠŸèƒ½å·²å®Œæˆï¼Œæ”¯æŒè‡ªåŠ¨å®šæœŸæ£€æŸ¥å’Œæ‰‹åŠ¨æ§åˆ¶

