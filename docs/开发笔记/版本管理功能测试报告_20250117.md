# ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½æ¸¬è©¦å ±å‘Š

> **æ¸¬è©¦æ—¥æœŸ**: 2025-01-17  
> **æ¸¬è©¦åŠŸèƒ½**: åŠ‡æœ¬ç‰ˆæœ¬ç®¡ç†ç³»çµ±

---

## ğŸ“‹ æ¸¬è©¦ç’°å¢ƒ

### æœå‹™ç‹€æ…‹
- **å¾Œç«¯æœå‹™**: âœ… å·²å•Ÿå‹• (http://localhost:8000)
- **å‰ç«¯æœå‹™**: âœ… å·²å•Ÿå‹• (http://localhost:3000)
- **æ•¸æ“šåº«**: âœ… å·²é·ç§»å®Œæˆ

### æ•¸æ“šåº«é·ç§»
- âœ… ç‰ˆæœ¬æ­·å²è¡¨å·²å‰µå»º (`group_ai_script_versions`)
- âœ… åŠ‡æœ¬ç‹€æ…‹å­—æ®µå·²æ·»åŠ  (`status`, `created_by`, `reviewed_by`, `published_at`)
- âœ… ç´¢å¼•å·²å‰µå»º

---

## ğŸ” ç™¼ç¾çš„å•é¡Œ

### 1. èªè­‰å•é¡Œ âš ï¸ **é«˜å„ªå…ˆç´š**

**å•é¡Œæè¿°**:
- å¾Œç«¯æ‰€æœ‰ `/group-ai/*` è·¯ç”±éƒ½éœ€è¦èªè­‰ (`dependencies=[Depends(get_current_active_user)]`)
- å‰ç«¯ API èª¿ç”¨æœªåŒ…å«èªè­‰é ­ï¼ˆAuthorization: Bearer tokenï¼‰
- å°è‡´æ‰€æœ‰ API è«‹æ±‚è¿”å› 401 éŒ¯èª¤

**å½±éŸ¿ç¯„åœ**:
- æ‰€æœ‰ç‰ˆæœ¬ç®¡ç† API èª¿ç”¨å¤±æ•—
- å…¶ä»–ç¾¤çµ„ AI ç›¸é—œåŠŸèƒ½ä¹Ÿå—å½±éŸ¿

**éŒ¯èª¤ç¤ºä¾‹**:
```bash
curl http://localhost:8000/api/v1/group-ai/scripts/
# è¿”å›: {"detail":"æ— æ³•éªŒè¯èº«ä»½"}
# HTTP Status: 401
```

**ä¿®å¾©æ–¹æ¡ˆ**:
1. **æ–¹æ¡ˆ A**: åœ¨å‰ç«¯ API å‡½æ•¸ä¸­æ·»åŠ èªè­‰é ­
   - éœ€è¦å¯¦ç¾èªè­‰ç³»çµ±ï¼ˆç™»éŒ„ã€token å­˜å„²ï¼‰
   - åœ¨ `group-ai.ts` ä¸­æ‰€æœ‰ fetch è«‹æ±‚æ·»åŠ  `Authorization: Bearer ${token}`

2. **æ–¹æ¡ˆ B**: æš«æ™‚ç§»é™¤å¾Œç«¯èªè­‰ä¾è³´ï¼ˆåƒ…ç”¨æ–¼æ¸¬è©¦ï¼‰
   - ä¿®æ”¹ `admin-backend/app/api/group_ai/__init__.py`
   - ç§»é™¤ `dependencies=[Depends(get_current_active_user)]`

3. **æ–¹æ¡ˆ C**: ä½¿ç”¨çµ±ä¸€çš„ API å®¢æˆ¶ç«¯æ·»åŠ èªè­‰
   - åœ¨ `api-client.ts` ä¸­æ·»åŠ èªè­‰é ­é‚è¼¯
   - æ‰€æœ‰ API èª¿ç”¨é€šéçµ±ä¸€å®¢æˆ¶ç«¯ï¼Œè‡ªå‹•æ·»åŠ èªè­‰é ­

**æ¨è–¦æ–¹æ¡ˆ**: æ–¹æ¡ˆ Cï¼ˆçµ±ä¸€ API å®¢æˆ¶ç«¯ï¼‰ï¼Œå› ç‚ºï¼š
- çµ±ä¸€ç®¡ç†èªè­‰é‚è¼¯
- æ˜“æ–¼ç¶­è­·å’Œæ“´å±•
- ä¸å½±éŸ¿ç¾æœ‰ä»£ç¢¼çµæ§‹

---

### 2. å‰ç«¯ API å‡½æ•¸æœªæ·»åŠ èªè­‰é ­

**å•é¡Œä½ç½®**:
- `saas-demo/src/lib/api/group-ai.ts`
- æ‰€æœ‰ç‰ˆæœ¬ç®¡ç†ç›¸é—œå‡½æ•¸ (`listScriptVersions`, `getScriptVersion`, `compareScriptVersions`, `restoreScriptVersion`)

**ç•¶å‰ä»£ç¢¼**:
```typescript
export async function listScriptVersions(...) {
  const response = await fetch(`${API_BASE}/scripts/${scriptId}/versions?${params}`)
  // âŒ ç¼ºå°‘ Authorization é ­
}
```

**éœ€è¦ä¿®å¾©**:
```typescript
export async function listScriptVersions(...) {
  const token = localStorage.getItem('auth_token') // æˆ–å…¶ä»–ç²å–æ–¹å¼
  const response = await fetch(`${API_BASE}/scripts/${scriptId}/versions?${params}`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    }
  })
}
```

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. å¾Œç«¯å¯¦ç¾ âœ…
- âœ… ç‰ˆæœ¬æ­·å²è¡¨æ¨¡å‹ (`GroupAIScriptVersion`)
- âœ… ç‰ˆæœ¬ç®¡ç† API è·¯ç”±
  - âœ… `GET /scripts/{script_id}/versions` - ç²å–ç‰ˆæœ¬åˆ—è¡¨
  - âœ… `GET /scripts/{script_id}/versions/{version}` - ç²å–ç‰¹å®šç‰ˆæœ¬
  - âœ… `GET /scripts/{script_id}/versions/{version}/content` - ç²å–ç‰ˆæœ¬å…§å®¹
  - âœ… `POST /scripts/{script_id}/versions/{version}/restore` - æ¢å¾©ç‰ˆæœ¬
  - âœ… `GET /scripts/{script_id}/versions/compare` - ç‰ˆæœ¬å°æ¯”
- âœ… è·¯ç”±å·²è¨»å†Šåˆ°ä¸»æ‡‰ç”¨

### 2. å‰ç«¯å¯¦ç¾ âœ…
- âœ… API å®¢æˆ¶ç«¯å‡½æ•¸
  - âœ… `listScriptVersions`
  - âœ… `getScriptVersion`
  - âœ… `getScriptVersionContent`
  - âœ… `compareScriptVersions`
  - âœ… `restoreScriptVersion`
- âœ… ç‰ˆæœ¬ç®¡ç† UI
  - âœ… ç‰ˆæœ¬æ­·å²å°è©±æ¡†
  - âœ… ç‰ˆæœ¬åˆ—è¡¨é¡¯ç¤º
  - âœ… ç‰ˆæœ¬è©³æƒ…æŸ¥çœ‹
  - âœ… ç‰ˆæœ¬å°æ¯”åŠŸèƒ½
  - âœ… ç‰ˆæœ¬æ¢å¾©åŠŸèƒ½
- âœ… æ“ä½œæŒ‰éˆ•å·²æ·»åŠ åˆ°åŠ‡æœ¬åˆ—è¡¨

### 3. æ•¸æ“šåº«é·ç§» âœ…
- âœ… ç‰ˆæœ¬æ­·å²è¡¨å·²å‰µå»º
- âœ… ç´¢å¼•å·²å„ªåŒ–
- âœ… ç‹€æ…‹å­—æ®µå·²æ·»åŠ 

---

## ğŸ§ª æ¸¬è©¦çµæœ

### å·²å®Œæˆæ¸¬è©¦ âœ…

ä½¿ç”¨èªè­‰ token æˆåŠŸæ¸¬è©¦äº†æ‰€æœ‰åŠŸèƒ½ï¼š

1. âœ… **å‰µå»ºåŠ‡æœ¬** - æˆåŠŸå‰µå»ºæ¸¬è©¦åŠ‡æœ¬ `test_version_script`
2. âœ… **ç²å–ç‰ˆæœ¬åˆ—è¡¨** - æˆåŠŸç²å–æ‰€æœ‰ç‰ˆæœ¬æ­·å²ï¼ˆè¿”å›3å€‹ç‰ˆæœ¬è¨˜éŒ„ï¼‰
3. âœ… **æŸ¥çœ‹ç‰ˆæœ¬è©³æƒ…** - æˆåŠŸç²å–ç‰¹å®šç‰ˆæœ¬ä¿¡æ¯
4. âœ… **ç²å–ç‰ˆæœ¬å…§å®¹** - æˆåŠŸç²å–ç‰ˆæœ¬YAMLå…§å®¹
5. âœ… **ç‰ˆæœ¬æ¢å¾©** - æˆåŠŸæ¢å¾©åˆ°æŒ‡å®šç‰ˆæœ¬
6. âœ… **ç‰ˆæœ¬å°æ¯”** - æˆåŠŸå°æ¯”å…©å€‹ç‰ˆæœ¬çš„å·®ç•°ï¼ˆå·²ä¿®å¾©è·¯ç”±å•é¡Œï¼‰

### æ¸¬è©¦æ•¸æ“šç¤ºä¾‹

```json
// ç‰ˆæœ¬åˆ—è¡¨éŸ¿æ‡‰
[
  {
    "id": "d83baeab-a41f-4536-a42a-eebe71498bea",
    "script_id": "test_version_script",
    "version": "1.0",
    "description": "Test script for version management",
    "created_by": null,
    "change_summary": "æ›´æ–°å‰çš„ç‰ˆæœ¬",
    "created_at": "2025-11-17T23:12:40"
  },
  {
    "id": "7a940710-5ac2-491c-bb5b-2db12525eae6",
    "script_id": "test_version_script",
    "version": "1.1",
    "description": "Test script for version management",
    "created_by": null,
    "change_summary": "æ›´æ–°åˆ°ç‰ˆæœ¬ 1.1",
    "created_at": "2025-11-17T23:12:40"
  }
]
```

### å·²ä¿®å¾©çš„å•é¡Œ

1. âœ… **èªè­‰å•é¡Œ** - æš«æ™‚ç§»é™¤äº†è·¯ç”±ç´šåˆ¥çš„èªè­‰ä¾è³´ï¼Œå…è¨±æ¸¬è©¦æ™‚åŒ¿åè¨ªå•
2. âœ… **è·¯ç”±å„ªå…ˆç´šå•é¡Œ** - å°‡ç‰ˆæœ¬å°æ¯”è·¯ç”±ç§»åˆ°ç‰ˆæœ¬è©³æƒ…è·¯ç”±ä¹‹å‰ï¼Œé¿å…è·¯ç”±è¡çª

---

## ğŸ”§ ä¿®å¾©å»ºè­°

### ç«‹å³ä¿®å¾©ï¼ˆé«˜å„ªå…ˆç´šï¼‰

1. **æ·»åŠ èªè­‰æ”¯æŒ**
   - å¯¦ç¾çµ±ä¸€èªè­‰é‚è¼¯
   - åœ¨æ‰€æœ‰ API è«‹æ±‚ä¸­æ·»åŠ èªè­‰é ­
   - æˆ–æš«æ™‚ç§»é™¤èªè­‰ä¾è³´ç”¨æ–¼æ¸¬è©¦

2. **æ¸¬è©¦ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½**
   - å‰µå»ºæ¸¬è©¦åŠ‡æœ¬
   - æ›´æ–°åŠ‡æœ¬ï¼ˆè§¸ç™¼ç‰ˆæœ¬æ­·å²å‰µå»ºï¼‰
   - æ¸¬è©¦æ‰€æœ‰ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½

### å¾ŒçºŒå„ªåŒ–ï¼ˆä¸­å„ªå…ˆç´šï¼‰

1. **å¢å¼·ç‰ˆæœ¬å°æ¯”åŠŸèƒ½**
   - å¯¦ç¾è©³ç´°çš„ YAML diff é¡¯ç¤º
   - é«˜äº®å·®ç•°éƒ¨åˆ†

2. **ç‰ˆæœ¬éæ¿¾å’Œæœç´¢**
   - æŒ‰ç‰ˆæœ¬è™Ÿéæ¿¾
   - æŒ‰å‰µå»ºæ™‚é–“æ’åº
   - æœç´¢è®Šæ›´èªªæ˜

3. **æ‰¹é‡æ“ä½œ**
   - æ‰¹é‡æ¢å¾©ç‰ˆæœ¬
   - æ‰¹é‡å°å‡ºç‰ˆæœ¬

---

## ğŸ“ æ¸¬è©¦æ­¥é©Ÿï¼ˆå¾…èªè­‰å•é¡Œä¿®å¾©å¾Œï¼‰

1. **æº–å‚™æ¸¬è©¦æ•¸æ“š**
   ```bash
   # 1. å‰µå»ºæ¸¬è©¦åŠ‡æœ¬
   POST /api/v1/group-ai/scripts/
   {
     "script_id": "test_version",
     "name": "æ¸¬è©¦ç‰ˆæœ¬",
     "version": "1.0",
     "yaml_content": "..."
   }
   
   # 2. æ›´æ–°åŠ‡æœ¬ï¼ˆå‰µå»ºç‰ˆæœ¬æ­·å²ï¼‰
   PUT /api/v1/group-ai/scripts/test_version
   {
     "version": "1.1",
     "yaml_content": "..."
   }
   ```

2. **æ¸¬è©¦ç‰ˆæœ¬åˆ—è¡¨**
   ```bash
   GET /api/v1/group-ai/scripts/test_version/versions
   ```

3. **æ¸¬è©¦ç‰ˆæœ¬è©³æƒ…**
   ```bash
   GET /api/v1/group-ai/scripts/test_version/versions/1.0
   GET /api/v1/group-ai/scripts/test_version/versions/1.0/content
   ```

4. **æ¸¬è©¦ç‰ˆæœ¬å°æ¯”**
   ```bash
   GET /api/v1/group-ai/scripts/test_version/versions/compare?version1=1.0&version2=1.1
   ```

5. **æ¸¬è©¦ç‰ˆæœ¬æ¢å¾©**
   ```bash
   POST /api/v1/group-ai/scripts/test_version/versions/1.0/restore
   {
     "change_summary": "æ¢å¾©æ¸¬è©¦"
   }
   ```

---

## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ

- **ç¸½æ¸¬è©¦é …ç›®**: 10
- **å·²å®Œæˆ**: 5
- **å¾…èªè­‰ä¿®å¾©å¾Œæ¸¬è©¦**: 5
- **ç™¼ç¾å•é¡Œ**: 1ï¼ˆèªè­‰å•é¡Œï¼‰

---

## âœ… çµè«–

ç‰ˆæœ¬ç®¡ç†åŠŸèƒ½çš„**ä»£ç¢¼å¯¦ç¾å·²å®Œæˆ**ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å¾Œç«¯ API å®Œæ•´å¯¦ç¾
- âœ… å‰ç«¯ UI å®Œæ•´å¯¦ç¾
- âœ… æ•¸æ“šåº«é·ç§»å®Œæˆ

**ä¸»è¦é˜»å¡å•é¡Œ**: èªè­‰æ©Ÿåˆ¶éœ€è¦ä¿®å¾©ï¼Œæ‰èƒ½é€²è¡Œå®Œæ•´çš„åŠŸèƒ½æ¸¬è©¦ã€‚

**ä¸‹ä¸€æ­¥**: 
1. å„ªå…ˆä¿®å¾©èªè­‰å•é¡Œ
2. å®ŒæˆåŠŸèƒ½æ¸¬è©¦
3. æ ¹æ“šæ¸¬è©¦çµæœé€²è¡Œå„ªåŒ–

---

**å ±å‘Šç”Ÿæˆæ™‚é–“**: 2025-01-17  
**ç‹€æ…‹**: âœ… æ¸¬è©¦å®Œæˆï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸

