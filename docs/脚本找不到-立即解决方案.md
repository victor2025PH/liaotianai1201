# âš¡ è„šæœ¬æ‰¾ä¸åˆ° - ç«‹å³è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `sudo bash scripts/setup_nginx_and_systemd.sh` æ—¶å‡ºç°ï¼š
```
bash: scripts/setup_nginx_and_systemd.sh: No such file or directory
```

## âœ… ç«‹å³è§£å†³æ–¹æ¡ˆï¼ˆ3 ç§æ–¹æ³•ï¼‰

### æ–¹æ³• 1: ç›´æ¥ä» GitHub æ‹‰å–è„šæœ¬æ–‡ä»¶ï¼ˆæœ€å¿«ï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd ~/liaotian

# æ–¹æ³• 1A: ä½¿ç”¨ git checkout ä»è¿œç¨‹æ£€å‡º
git fetch origin main
git checkout origin/main -- scripts/setup_nginx_and_systemd.sh 2>/dev/null || echo "æ–‡ä»¶ä¸åœ¨è¿œç¨‹ä»“åº“"

# æ–¹æ³• 1B: å¦‚æœä¸Šé¢å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶åŒæ­¥
git reset --hard origin/main
git clean -fd

# éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh scripts/setup_nginx_and_systemd.sh

# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œæ·»åŠ æ‰§è¡Œæƒé™å¹¶è¿è¡Œ
chmod +x scripts/setup_nginx_and_systemd.sh
sudo bash scripts/setup_nginx_and_systemd.sh
```

### æ–¹æ³• 2: ç›´æ¥åˆ›å»ºè„šæœ¬å†…å®¹ï¼ˆæœ€å¯é ï¼‰

å¦‚æœ Git æ‹‰å–å¤±è´¥ï¼Œå¯ä»¥ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºè„šæœ¬ï¼š

```bash
cd ~/liaotian

# åˆ›å»º scripts ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p scripts

# ç›´æ¥æ‰§è¡Œé…ç½®ï¼ˆä¸€è¡Œå‘½ä»¤ï¼‰
sudo bash -c '
PROJECT_DIR="/home/ubuntu/liaotian"
NGINX_CONF="/etc/nginx/sites-available/liaotian"
SYSTEMD_DIR="/etc/systemd/system"

# å®‰è£… Nginx
apt-get update && apt-get install -y nginx

# åˆ›å»º Nginx é…ç½®
cat > "$NGINX_CONF" << "EOFNGINX"
upstream frontend { server localhost:3000; keepalive 64; }
upstream backend { server localhost:8000; keepalive 64; }
server {
    listen 80; server_name 165.154.233.55; client_max_body_size 50M;
    location / {
        proxy_pass http://frontend; proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade";
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s; proxy_send_timeout 60s; proxy_read_timeout 60s;
    }
    location /api {
        proxy_pass http://backend; proxy_http_version 1.1;
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /health { proxy_pass http://backend/health; access_log off; }
    location /docs { proxy_pass http://backend/docs; }
    access_log /var/log/nginx/liaotian-access.log;
    error_log /var/log/nginx/liaotian-error.log;
}
EOFNGINX
ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/liaotian
nginx -t && systemctl reload nginx

# åˆ›å»ºå‰ç«¯æœåŠ¡
cat > "$SYSTEMD_DIR/liaotian-frontend.service" << "EOFFRONTEND"
[Unit]
Description=Liaotian Frontend Service
After=network.target liaotian-backend.service
[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="NODE_ENV=production" Environment="PORT=3000"
ExecStart=/bin/bash -c "if [ -d /home/ubuntu/liaotian/saas-demo/.next/standalone ]; then cd /home/ubuntu/liaotian/saas-demo/.next/standalone && PORT=3000 /usr/bin/node server.js; else cd /home/ubuntu/liaotian/saas-demo && /usr/bin/npm start; fi"
Restart=always RestartSec=10
[Install]
WantedBy=multi-user.target
EOFFRONTEND

# åˆ›å»ºåç«¯æœåŠ¡
cat > "$SYSTEMD_DIR/liaotian-backend.service" << "EOFBACKEND"
[Unit]
Description=Liaotian Backend API Service
After=network.target
[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/admin-backend
ExecStart=/usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always RestartSec=10
[Install]
WantedBy=multi-user.target
EOFBACKEND

# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
systemctl daemon-reload
systemctl enable liaotian-backend liaotian-frontend
systemctl stop liaotian-frontend 2>/dev/null || true
systemctl stop liaotian-backend 2>/dev/null || true
pkill -f "next-server" 2>/dev/null || true
pkill -f "uvicorn" 2>/dev/null || true
sleep 3
systemctl start liaotian-backend
sleep 5
systemctl start liaotian-frontend
echo "âœ… é…ç½®å®Œæˆï¼"
'
```

### æ–¹æ³• 3: ä½¿ç”¨å®Œæ•´é…ç½®è„šæœ¬æ–‡ä»¶ï¼ˆæœ€æ¸…æ™°ï¼‰

å¦‚æœä¸Šé¢çš„æ–¹æ³•å¤ªé•¿ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶è„šæœ¬æ–‡ä»¶ï¼š

```bash
cd ~/liaotian

# åˆ›å»ºå®Œæ•´çš„é…ç½®è„šæœ¬
cat > /tmp/setup_config.sh << 'EOF'
#!/bin/bash
set -e
PROJECT_DIR="/home/ubuntu/liaotian"
apt-get update && apt-get install -y nginx

# Nginx é…ç½®
cat > /etc/nginx/sites-available/liaotian << 'EOFNGINX'
upstream frontend { server localhost:3000; keepalive 64; }
upstream backend { server localhost:8000; keepalive 64; }
server {
    listen 80; server_name 165.154.233.55; client_max_body_size 50M;
    location / {
        proxy_pass http://frontend; proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade";
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /api {
        proxy_pass http://backend; proxy_http_version 1.1;
        proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location /health { proxy_pass http://backend/health; }
    location /docs { proxy_pass http://backend/docs; }
    access_log /var/log/nginx/liaotian-access.log;
    error_log /var/log/nginx/liaotian-error.log;
}
EOFNGINX
ln -sf /etc/nginx/sites-available/liaotian /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx

# Systemd æœåŠ¡ï¼ˆå‰ç«¯ï¼‰
cat > /etc/systemd/system/liaotian-frontend.service << 'EOFFRONTEND'
[Unit]
Description=Liaotian Frontend Service
After=network.target liaotian-backend.service
[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="NODE_ENV=production" Environment="PORT=3000"
ExecStart=/bin/bash -c "if [ -d /home/ubuntu/liaotian/saas-demo/.next/standalone ]; then cd /home/ubuntu/liaotian/saas-demo/.next/standalone && PORT=3000 /usr/bin/node server.js; else cd /home/ubuntu/liaotian/saas-demo && /usr/bin/npm start; fi"
Restart=always RestartSec=10
[Install]
WantedBy=multi-user.target
EOFFRONTEND

# Systemd æœåŠ¡ï¼ˆåç«¯ï¼‰
cat > /etc/systemd/system/liaotian-backend.service << 'EOFBACKEND'
[Unit]
Description=Liaotian Backend API Service
After=network.target
[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/admin-backend
ExecStart=/usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always RestartSec=10
[Install]
WantedBy=multi-user.target
EOFBACKEND

systemctl daemon-reload
systemctl enable liaotian-backend liaotian-frontend
systemctl stop liaotian-frontend 2>/dev/null || true
systemctl stop liaotian-backend 2>/dev/null || true
pkill -f "next-server" 2>/dev/null || true
pkill -f "uvicorn" 2>/dev/null || true
sleep 3
systemctl start liaotian-backend
sleep 5
systemctl start liaotian-frontend
echo "âœ… é…ç½®å®Œæˆï¼"
EOF

chmod +x /tmp/setup_config.sh
sudo bash /tmp/setup_config.sh
```

## ğŸ” è¯Šæ–­æ­¥éª¤

å¦‚æœä»ç„¶æœ‰é—®é¢˜ï¼Œå…ˆè¯Šæ–­ï¼š

```bash
cd ~/liaotian

# 1. æ£€æŸ¥ç›®å½•ç»“æ„
pwd
ls -la

# 2. æ£€æŸ¥ scripts ç›®å½•
ls -la scripts/ 2>/dev/null || echo "scripts ç›®å½•ä¸å­˜åœ¨"

# 3. æ£€æŸ¥ Git çŠ¶æ€
git status
git branch
git remote -v

# 4. æ£€æŸ¥è¿œç¨‹ä»“åº“ä¸­æ˜¯å¦æœ‰è¿™ä¸ªæ–‡ä»¶
git ls-tree -r origin/main --name-only | grep setup_nginx

# 5. å¼ºåˆ¶æ‹‰å–æ‰€æœ‰æ–‡ä»¶
git fetch origin main
git reset --hard origin/main
ls -la scripts/setup_nginx_and_systemd.sh
```

## âœ… éªŒè¯é…ç½®æˆåŠŸ

é…ç½®å®Œæˆåï¼ŒéªŒè¯ï¼š

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status liaotian-frontend
sudo systemctl status liaotian-backend

# æ£€æŸ¥ç«¯å£
ss -tlnp | grep :80
ss -tlnp | grep :3000
ss -tlnp | grep :8000

# æµ‹è¯•è®¿é—®
curl http://localhost/health
curl http://localhost/api/health
```

---

**æ¨èä½¿ç”¨æ–¹æ³• 1 æˆ–æ–¹æ³• 2ï¼Œå®ƒä»¬æœ€å¯é ï¼**
