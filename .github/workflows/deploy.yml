name: Deploy Full Stack

on:
  push:
    branches:
      - main
    paths:
      - 'saas-demo/**'
      - 'admin-backend/**'
      - 'agent/**'
      - 'aizkw20251219/**'
      - 'hbwy20251220/**'
      - 'tgmini20251220/**'
      - '.github/workflows/deploy.yml'
      - 'scripts/deploy_full.sh'
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'éƒ¨ç½²åç«¯ (admin-backend)'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'éƒ¨ç½²å‰ç«¯ (saas-demo)'
        required: false
        default: true
        type: boolean
      deploy_aizkw:
        description: 'éƒ¨ç½² aizkw é¡¹ç›®åˆ° 3003 ç«¯å£'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '45m'
          command_timeout: '45m'
          use_insecure_cipher: false
          script_stop: false
          debug: true
          envs: PYTHONUNBUFFERED=1,DEBIAN_FRONTEND=noninteractive
          script: |
            set -e
            
            # è¿æ¥æˆåŠŸåç«‹å³è¾“å‡ºï¼Œç¡®è®¤ SSH è¿æ¥æ­£å¸¸
            echo "SSH è¿æ¥å·²å»ºç«‹"
            echo "æœåŠ¡å™¨æ—¶é—´: $(date)"
            echo "å½“å‰ç”¨æˆ·: $(whoami)"
            echo "å·¥ä½œç›®å½•: $(pwd)"
            echo ""
            
            PROJECT_ROOT="/home/ubuntu/telegram-ai-system"
            
            # ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•å­˜åœ¨
            if [ ! -d "$PROJECT_ROOT" ]; then
              echo "âŒ é¡¹ç›®æ ¹ç›®å½•ä¸å­˜åœ¨: $PROJECT_ROOT"
              echo "æ­£åœ¨åˆ›å»ºç›®å½•å¹¶å…‹éš†é¡¹ç›®..."
              mkdir -p "$PROJECT_ROOT"
              cd "$PROJECT_ROOT"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "âŒ Git clone å¤±è´¥"
                exit 1
              }
            fi
            
            # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
            echo "ğŸ“ è¿›å…¥é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || {
              echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®æ ¹ç›®å½•"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            if [ ! -d ".git" ]; then
              echo "âš ï¸  å½“å‰ç›®å½•ä¸æ˜¯ git ä»“åº“ï¼Œåˆå§‹åŒ–..."
              git init || true
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            git fetch origin main || git fetch origin || true
            git stash || true
            git reset --hard origin/main || {
              echo "âš ï¸  git reset å¤±è´¥ï¼Œå°è¯• git pull..."
              git pull origin main || {
                echo "âš ï¸  Git pull å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
              }
            }
            
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
            echo "æœ€æ–°æäº¤: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
            if [ -f "scripts/deploy_full.sh" ]; then
              chmod +x scripts/deploy_full.sh
              echo "âœ… éƒ¨ç½²è„šæœ¬æƒé™å·²è®¾ç½®"
            else
              echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: scripts/deploy_full.sh"
              exit 1
            fi
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆä½¿ç”¨ unbuffered æ¨¡å¼ç¡®ä¿å®æ—¶è¾“å‡ºï¼‰
            echo ""
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            echo "=========================================="
            echo "å½“å‰æ—¶é—´: $(date)"
            echo "è„šæœ¬è·¯å¾„: $(pwd)/scripts/deploy_full.sh"
            echo "è„šæœ¬å­˜åœ¨: $([ -f scripts/deploy_full.sh ] && echo 'æ˜¯' || echo 'å¦')"
            echo ""
            
            # è®¾ç½®è„šæœ¬ä¸ºå¯æ‰§è¡Œ
            chmod +x scripts/deploy_full.sh
            
            # ç›´æ¥æ‰§è¡Œè„šæœ¬ï¼ˆè„šæœ¬å†…éƒ¨ä¼šå®šæœŸè¾“å‡ºè¿›åº¦ï¼Œä¿æŒSSHè¿æ¥æ´»è·ƒï¼‰
            bash scripts/deploy_full.sh
            EXIT_CODE=$?
            
            echo ""
            echo "=========================================="
            echo "è„šæœ¬æ‰§è¡Œå®Œæˆï¼Œé€€å‡ºç : $EXIT_CODE"
            echo "å½“å‰æ—¶é—´: $(date)"
            echo ""
            
            # æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
            echo "ğŸ“Š å½“å‰æœåŠ¡çŠ¶æ€:"
            pm2 list || true
            echo ""
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… éƒ¨ç½²è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
              # éªŒè¯å…³é”®ç«¯å£
              echo "ğŸ” éªŒè¯å…³é”®ç«¯å£..."
              for port in 8000 3000 3001 3002 3003; do
                if nc -z 127.0.0.1 $port 2>/dev/null; then
                  echo "  âœ… ç«¯å£ $port æ­£åœ¨ç›‘å¬"
                else
                  echo "  âš ï¸  ç«¯å£ $port æœªç›‘å¬"
                fi
              done
              echo ""
              echo "â³ ç­‰å¾… SSH è¿æ¥ä¼˜é›…å…³é—­..."
              sleep 3
              exit 0
            else
              echo "âŒ éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : $EXIT_CODE)"
              echo "æŸ¥çœ‹æœ€è¿‘æ—¥å¿—:"
              pm2 logs --lines 30 --nostream 2>/dev/null || true
              echo ""
              echo "â³ ç­‰å¾… SSH è¿æ¥ä¼˜é›…å…³é—­..."
              sleep 3
              exit $EXIT_CODE
            fi
