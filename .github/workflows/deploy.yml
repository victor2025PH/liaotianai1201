name: Deploy to Server

on:
  push:
    branches:
      - main
    paths:
      - 'admin-backend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ~/telegram-ai-system/admin-backend || {
              echo "âŒ Error: Project directory not found"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main || {
              echo "âš ï¸  Git pull failed, trying to resolve conflicts..."
              git stash || true
              git pull origin main || exit 1
            }
            
            # æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if [ -d "venv" ]; then
              echo "ðŸ”§ Activating virtual environment..."
              source venv/bin/activate
            elif [ -d ".venv" ]; then
              echo "ðŸ”§ Activating virtual environment..."
              source .venv/bin/activate
            else
              echo "âš ï¸  No virtual environment found, using system Python"
            fi
            
            # æ›´æ–°ä¾èµ–
            echo "ðŸ“¦ Installing/updating dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æžœä½¿ç”¨ Alembicï¼‰
            if [ -f "alembic.ini" ]; then
              echo "ðŸ”„ Running database migrations..."
              alembic upgrade head || echo "âš ï¸  Migration failed, continuing..."
            fi
            
            # é‡å¯æœåŠ¡
            echo "ðŸ”„ Restarting service..."
            sudo systemctl restart telegram-backend || {
              echo "âš ï¸  Service restart failed, trying alternative method..."
              # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ supervisor æˆ–ç›´æŽ¥å¯åŠ¨
              pkill -f "uvicorn app.main:app" || true
              sleep 2
            }
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ Waiting for service to start..."
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ðŸ” Checking service status..."
            sudo systemctl status telegram-backend --no-pager || {
              echo "âš ï¸  Service status check failed"
            }
            
            # å¥åº·æ£€æŸ¥
            echo "ðŸ¥ Health check..."
            curl -f http://localhost:8000/health || curl -f http://localhost:8000/healthz || {
              echo "âš ï¸  Health check failed, but deployment completed"
            }
            
            echo "âœ… Deployment completed!"

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
