name: Deploy Full Stack

on:
  push:
    branches:
      - main
    paths:
      - 'saas-demo/**'
      - 'admin-backend/**'
      - 'agent/**'
      - 'aizkw20251219/**'
      - 'hbwy20251220/**'
      - 'tgmini20251220/**'
      - '.github/workflows/deploy.yml'
      - 'scripts/deploy_full.sh'
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: '部署后端 (admin-backend)'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: '部署前端 (saas-demo)'
        required: false
        default: true
        type: boolean
      deploy_aizkw:
        description: '部署 aizkw 项目到 3003 端口'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '45m'
          command_timeout: '45m'
          use_insecure_cipher: true
          script_stop: false
          debug: true
          envs: |
            PYTHONUNBUFFERED=1
            DEBIAN_FRONTEND=noninteractive
          script: |
            set -e
            
            PROJECT_ROOT="/home/ubuntu/telegram-ai-system"
            
            # 确保项目根目录存在
            if [ ! -d "$PROJECT_ROOT" ]; then
              echo "❌ 项目根目录不存在: $PROJECT_ROOT"
              echo "正在创建目录并克隆项目..."
              mkdir -p "$PROJECT_ROOT"
              cd "$PROJECT_ROOT"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "❌ Git clone 失败"
                exit 1
              }
            fi
            
            # 进入项目根目录
            echo "📁 进入项目根目录: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || {
              echo "❌ 无法进入项目根目录"
              exit 1
            }
            
            # 拉取最新代码
            echo "📥 拉取最新代码..."
            if [ ! -d ".git" ]; then
              echo "⚠️  当前目录不是 git 仓库，初始化..."
              git init || true
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            git fetch origin main || git fetch origin || true
            git stash || true
            git reset --hard origin/main || {
              echo "⚠️  git reset 失败，尝试 git pull..."
              git pull origin main || {
                echo "⚠️  Git pull 失败，但继续执行..."
              }
            }
            
            echo "✅ 代码同步完成"
            echo "最新提交: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # 赋予脚本执行权限
            if [ -f "scripts/deploy_full.sh" ]; then
              chmod +x scripts/deploy_full.sh
              echo "✅ 部署脚本权限已设置"
            else
              echo "❌ 部署脚本不存在: scripts/deploy_full.sh"
              exit 1
            fi
            
            # 执行部署脚本（使用 unbuffered 模式确保实时输出）
            echo ""
            echo "🚀 开始执行部署脚本..."
            echo "=========================================="
            echo "当前时间: $(date)"
            echo ""
            
            # 使用 unbuffered 模式执行脚本，确保输出实时刷新
            if bash -c 'set -e; export PYTHONUNBUFFERED=1; exec bash scripts/deploy_full.sh'; then
              EXIT_CODE=0
            else
              EXIT_CODE=$?
            fi
            
            echo ""
            echo "=========================================="
            echo "脚本执行完成，退出码: $EXIT_CODE"
            echo "当前时间: $(date)"
            echo ""
            
            # 无论成功或失败，都显示服务状态
            echo "📊 当前服务状态:"
            pm2 list || true
            echo ""
            
            if [ $EXIT_CODE -eq 0 ]; then
              echo "✅ 部署脚本执行成功"
              # 验证关键端口
              echo "🔍 验证关键端口..."
              for port in 8000 3000 3001 3002 3003; do
                if nc -z 127.0.0.1 $port 2>/dev/null; then
                  echo "  ✅ 端口 $port 正在监听"
                else
                  echo "  ⚠️  端口 $port 未监听"
                fi
              done
              echo ""
              exit 0
            else
              echo "❌ 部署脚本执行失败 (退出码: $EXIT_CODE)"
              echo "查看最近日志:"
              pm2 logs --lines 30 --nostream 2>/dev/null || true
              echo ""
              echo "查看部署日志文件（如果存在）:"
              tail -n 50 /tmp/deploy.log 2>/dev/null || echo "日志文件不存在"
              exit $EXIT_CODE
            fi
