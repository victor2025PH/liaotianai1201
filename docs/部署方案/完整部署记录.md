# å®Œæ•´éƒ¨ç½²è®°å½•

> **ç”Ÿæˆæ—¶é—´**: 2025-01-16  
> **éƒ¨ç½²ç³»ç»Ÿ**: è‡ªåŠ¨åŒ–å®Œæ•´éƒ¨ç½²ç³»ç»Ÿ

---

## ğŸ“‹ éƒ¨ç½²æµç¨‹

### 1. ç³»ç»ŸåŒ…å®‰è£…

è‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ä»¥ä¸‹ç³»ç»ŸåŒ…ï¼š

- `build-essential` - ç¼–è¯‘å·¥å…·é›†
- `python3-dev` - Pythonå¼€å‘å¤´æ–‡ä»¶
- `python3-venv` - Pythonè™šæ‹Ÿç¯å¢ƒæ”¯æŒ
- `curl` - ä¸‹è½½å·¥å…·
- `gcc` - Cç¼–è¯‘å™¨
- `g++` - C++ç¼–è¯‘å™¨
- `make` - æ„å»ºå·¥å…·

### 2. è™šæ‹Ÿç¯å¢ƒåˆ›å»º

- åˆ é™¤æ—§è™šæ‹Ÿç¯å¢ƒ
- ä½¿ç”¨ `python3 -m venv venv` åˆ›å»ºæ–°ç¯å¢ƒ
- è®¾ç½®æ­£ç¡®çš„æƒé™

### 3. pipå®‰è£…

- å¦‚æœè™šæ‹Ÿç¯å¢ƒä¸­æ²¡æœ‰pipï¼Œä½¿ç”¨ `get-pip.py` å®‰è£…
- å‡çº§pipã€setuptoolsã€wheelåˆ°æœ€æ–°ç‰ˆæœ¬

### 4. PythonåŒ…å®‰è£…

è‡ªåŠ¨å®‰è£…ä»¥ä¸‹PythonåŒ…ï¼ˆä»requirements.txtè¯»å–ï¼‰ï¼š

#### æ ¸å¿ƒä¾èµ–
- `pyrogram>=2.0.0` - Telegramå®¢æˆ·ç«¯åº“
- `tgcrypto>=1.2.5` - TelegramåŠ å¯†åº“ï¼ˆéœ€è¦ç¼–è¯‘ï¼‰
- `fastapi>=0.104.0` - Webæ¡†æ¶
- `uvicorn[standard]>=0.24.0` - ASGIæœåŠ¡å™¨
- `pydantic>=2.0.0` - æ•°æ®éªŒè¯
- `pydantic-settings>=2.0.0` - è®¾ç½®ç®¡ç†

#### æ•°æ®åº“
- `sqlalchemy>=2.0.0` - ORM
- `alembic>=1.12.0` - æ•°æ®åº“è¿ç§»
- `aiosqlite>=0.19.0` - å¼‚æ­¥SQLite

#### ç¼“å­˜
- `redis>=5.0.0` - Rediså®¢æˆ·ç«¯
- `hiredis>=2.2.0` - RedisåŠ é€Ÿ

#### AIç›¸å…³
- `openai>=1.0.0` - OpenAI API
- `tiktoken>=0.5.0` - Tokenè®¡æ•°

#### å·¥å…·
- `python-dotenv>=1.0.0` - ç¯å¢ƒå˜é‡
- `pyyaml>=6.0` - YAMLè§£æ
- `aiofiles>=23.2.0` - å¼‚æ­¥æ–‡ä»¶æ“ä½œ
- `httpx>=0.25.0` - HTTPå®¢æˆ·ç«¯
- `prometheus-client>=0.19.0` - ç›‘æ§æŒ‡æ ‡

### 5. å¯åŠ¨è„šæœ¬

åˆ›å»º `/opt/group-ai/start.sh`ï¼š

```bash
#!/bin/bash
cd /opt/group-ai
source /opt/group-ai/venv/bin/activate
export PYTHONPATH=/opt/group-ai:$PYTHONPATH

if [ -d "group_ai_service" ]; then
    cd group_ai_service
    /opt/group-ai/venv/bin/python -c "from service_manager import ServiceManager; sm = ServiceManager(); sm.start()"
else
    echo "Worker service placeholder - waiting..."
    sleep infinity
fi
```

### 6. SystemdæœåŠ¡

åˆ›å»º `/etc/systemd/system/group-ai-worker.service`ï¼š

```ini
[Unit]
Description=Group AI Worker Node Service
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/opt/group-ai
Environment="PATH=/opt/group-ai/venv/bin"
Environment="PYTHONPATH=/opt/group-ai"
ExecStart=/opt/group-ai/start.sh
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 7. æœåŠ¡å¯åŠ¨

- é‡æ–°åŠ è½½systemd: `sudo systemctl daemon-reload`
- å¯ç”¨æœåŠ¡: `sudo systemctl enable group-ai-worker`
- å¯åŠ¨æœåŠ¡: `sudo systemctl restart group-ai-worker`
- æ£€æŸ¥çŠ¶æ€: `sudo systemctl is-active group-ai-worker`

---

## ğŸ“ è‡ªåŠ¨è®°å½•

### requirements.txtæ›´æ–°

æ‰€æœ‰å®‰è£…çš„PythonåŒ…ä¼šè‡ªåŠ¨è®°å½•åˆ° `group_ai_service/requirements.txt`ï¼š

```txt
# Auto-installed packages
pyrogram>=2.0.0
tgcrypto>=1.2.5
...
```

### éƒ¨ç½²æ—¥å¿—

æ‰€æœ‰éƒ¨ç½²æ­¥éª¤éƒ½ä¼šè®°å½•åˆ° `data/deploy_log.json`ï¼š

```json
{
  "deployments": [
    {
      "timestamp": "2025-01-16T20:00:00",
      "node_id": "worker-01",
      "step": "ç³»ç»ŸåŒ…æ£€æŸ¥",
      "status": "å®Œæˆ",
      "details": "å·²å®‰è£…: build-essential, python3-dev, ..."
    },
    ...
  ]
}
```

---

## ğŸ”„ ä¸‹ä¸€ä¸ªæœåŠ¡å™¨éƒ¨ç½²

### æ–¹æ³•1: ä½¿ç”¨è‡ªåŠ¨åŒ–è„šæœ¬

```bash
python scripts/deployment/auto_deploy_complete.py
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. æ£€æµ‹å¹¶å®‰è£…æ‰€æœ‰ç³»ç»Ÿä¾èµ–
2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
3. ä»requirements.txtå®‰è£…æ‰€æœ‰PythonåŒ…
4. åˆ›å»ºå¯åŠ¨è„šæœ¬å’ŒsystemdæœåŠ¡
5. å¯åŠ¨æœåŠ¡å¹¶ç›‘æ§æ—¥å¿—

### æ–¹æ³•2: æ‰‹åŠ¨å¤åˆ¶

1. **å¤åˆ¶requirements.txt**:
   ```bash
   cp group_ai_service/requirements.txt /path/to/new/server/
   ```

2. **å®‰è£…ç³»ç»ŸåŒ…**:
   ```bash
   sudo apt-get update
   sudo apt-get install -y build-essential python3-dev python3-venv curl gcc g++ make
   ```

3. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   pip install --upgrade pip setuptools wheel
   pip install -r requirements.txt
   ```

4. **å¤åˆ¶å¯åŠ¨è„šæœ¬å’ŒsystemdæœåŠ¡æ–‡ä»¶**ï¼ˆä»éƒ¨ç½²æ—¥å¿—ä¸­è·å–ï¼‰

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **tgcryptoç¼–è¯‘å¤±è´¥**
   - åŸå› : ç¼ºå°‘gccæˆ–build-essential
   - è§£å†³: è‡ªåŠ¨å®‰è£…build-essentialå’Œpython3-dev

2. **è™šæ‹Ÿç¯å¢ƒä¸å®Œæ•´**
   - åŸå› : python3-venvæœªå®‰è£…
   - è§£å†³: è‡ªåŠ¨å®‰è£…python3-venv

3. **pipä¸å¯ç”¨**
   - åŸå› : è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæ—¶pipæœªå®‰è£…
   - è§£å†³: ä½¿ç”¨get-pip.pyè‡ªåŠ¨å®‰è£…

4. **æœåŠ¡æ— æ³•å¯åŠ¨**
   - æ£€æŸ¥æ—¥å¿—: `sudo journalctl -u group-ai-worker -n 50`
   - æ£€æŸ¥æƒé™: `ls -la /opt/group-ai/venv/bin/`
   - æ£€æŸ¥Pythonè·¯å¾„: `/opt/group-ai/venv/bin/python --version`

---

## ğŸ“Š éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç³»ç»ŸåŒ…å·²å®‰è£…
- [ ] è™šæ‹Ÿç¯å¢ƒå·²åˆ›å»º
- [ ] pipå·²å®‰è£…å¹¶å‡çº§
- [ ] PythonåŒ…å·²å®‰è£…
- [ ] å¯åŠ¨è„šæœ¬å·²åˆ›å»º
- [ ] SystemdæœåŠ¡å·²åˆ›å»ºå¹¶å¯ç”¨
- [ ] æœåŠ¡å·²å¯åŠ¨å¹¶è¿è¡Œ
- [ ] requirements.txtå·²æ›´æ–°
- [ ] éƒ¨ç½²æ—¥å¿—å·²è®°å½•

---

**æœ€åæ›´æ–°**: 2025-01-16

