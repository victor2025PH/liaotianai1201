# 502 Bad Gateway 錯誤診斷和修復指南

> **日期**: 2025-12-01  
> **問題**: 後台無法登入，出現 502 Bad Gateway 錯誤

---

## 🔍 問題分析

### 502 錯誤含義

**502 Bad Gateway** 表示 Nginx（反向代理）無法從後端應用服務器獲取有效響應。

### 常見原因

1. **後端服務未運行** - 最常見
2. **後端服務崩潰** - 進程異常退出
3. **端口配置錯誤** - Nginx 指向錯誤的端口
4. **後端服務未監聽** - 服務運行但未監聽端口
5. **網絡問題** - 防火牆或網絡配置問題
6. **後端服務過載** - 服務無響應

---

## 🔧 診斷步驟

### 步驟 1: 檢查後端服務狀態

```bash
# 檢查後端進程
ps aux | grep "uvicorn.*app.main:app" | grep -v grep

# 如果沒有進程，後端未運行
```

### 步驟 2: 檢查端口監聽

```bash
# 檢查端口 8000 是否監聽
lsof -i :8000

# 或使用 netstat
netstat -tlnp | grep 8000
```

### 步驟 3: 測試後端健康檢查

```bash
# 直接測試後端
curl http://localhost:8000/health

# 如果失敗，後端服務有問題
```

### 步驟 4: 檢查 Nginx 配置

```bash
# 檢查 Nginx 配置中的 proxy_pass
grep -A 5 "proxy_pass" /etc/nginx/sites-enabled/default

# 確認指向正確的後端地址和端口
```

### 步驟 5: 檢查 Nginx 錯誤日誌

```bash
# 查看 Nginx 錯誤日誌
tail -50 /var/log/nginx/error.log | grep -i "502\|bad gateway\|upstream"
```

### 步驟 6: 檢查後端日誌

```bash
# 查看後端日誌
tail -50 /tmp/backend_final2.log
# 或
tail -50 /tmp/backend.log
```

---

## 🚀 快速診斷腳本

執行以下腳本進行完整診斷：

```bash
cd /home/ubuntu/liaotian/deployment-package && \
bash deploy/診斷502錯誤-立即執行.sh
```

---

## 🔧 修復方案

### 方案 1: 後端服務未運行

**症狀**: 進程不存在，端口未監聽

**修復**:
```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
source /home/ubuntu/liaotian/admin-backend/.venv/bin/activate && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
export JWT_SECRET='kLZdZJCzq8qev_isfbrxjSshcHGiMDMA8Uok8f55RXc' && \
export ADMIN_DEFAULT_PASSWORD='Along2021!!!' && \
nohup /home/ubuntu/liaotian/admin-backend/.venv/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final2.log 2>&1 &
```

### 方案 2: 端口配置錯誤

**症狀**: 後端運行在不同端口，Nginx 配置錯誤

**修復**:
1. 確認後端實際監聽的端口
2. 修改 Nginx 配置中的 `proxy_pass` 指向正確端口
3. 重載 Nginx: `sudo nginx -s reload`

### 方案 3: 後端服務崩潰

**症狀**: 進程存在但無法響應

**修復**:
1. 查看後端日誌找出錯誤原因
2. 修復錯誤
3. 重啟後端服務

### 方案 4: Nginx 配置錯誤

**症狀**: Nginx 日誌顯示連接失敗

**修復**:
檢查並修復 Nginx 配置：
```nginx
location /api {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

---

## ✅ 驗證修復

修復後，驗證步驟：

1. **檢查後端健康**:
   ```bash
   curl http://localhost:8000/health
   ```

2. **檢查 Nginx 狀態**:
   ```bash
   sudo nginx -t  # 測試配置
   sudo systemctl status nginx  # 檢查狀態
   ```

3. **測試網頁訪問**:
   - 訪問後台登錄頁面
   - 確認不再出現 502 錯誤

---

## 📋 常見問題

### Q: 後端服務啟動後立即退出

**A**: 檢查日誌文件，常見原因：
- 數據庫連接失敗
- 環境變量缺失
- 端口被佔用
- 代碼錯誤

### Q: Nginx 配置正確但仍有 502

**A**: 檢查：
- 後端服務是否真的在運行
- 防火牆是否阻止連接
- SELinux 是否阻止連接（如果啟用）

### Q: 間歇性 502 錯誤

**A**: 可能是：
- 後端服務過載
- 超時設置過短
- 資源不足（內存/CPU）

---

## 🔗 相關文件

- `deploy/診斷502錯誤-立即執行.sh` - 診斷腳本
- Nginx 配置文件: `/etc/nginx/sites-enabled/default`
- 後端日誌: `/tmp/backend_final2.log`

---

**執行診斷腳本，根據結果進行修復！**
