name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 55m
          script_stop: true
          debug: true
          script: |
            # set -x  # Â∑≤ÈóúÈñâË™øË©¶Ê®°ÂºèÔºåÊ∏õÂ∞ëÊó•Ë™åËº∏Âá∫
            set -o pipefail
            # ‰∏ç‰ΩøÁî® set -eÔºåÂõ†ÁÇ∫ÂÆÉÊúÉËàáÊ¢ù‰ª∂Âà§Êñ∑ [ ] Áî¢ÁîüË°ùÁ™Å
            # ÊàëÂÄë‰ΩøÁî®ÊâãÂãïÈåØË™§Ê™¢Êü•‰æÜËôïÁêÜÈóúÈçµÂëΩ‰ª§ÁöÑÂ§±Êïó
            
            handle_error() {
              echo "‚ùå Error at: $1"
              echo "Exit code: $?"
              exit 1
            }
            
            echo "=========================================="
            echo "Starting deployment - $(date)"
            echo "=========================================="
            
            echo "Testing SSH connection..."
            if ! whoami; then
              echo "‚ùå SSH connection failed"
              handle_error "SSH connection test"
            fi
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            echo "‚úÖ SSH connection successful"
            
            echo "=========================================="
            echo "Step 1: Check project directory"
            echo "=========================================="
            PROJECT_DIR="/home/ubuntu/telegram-ai-system"
            
            # Áõ¥Êé•ÂòóË©¶ÈÄ≤ÂÖ•ÁõÆÈåÑÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÂÖãÈöÜ
            if cd "$PROJECT_DIR" 2>/dev/null; then
              echo "‚úÖ Project directory exists"
            else
              echo "Project directory not found, cloning..."
              cd /home/ubuntu || handle_error "cd to /home/ubuntu"
              if ! timeout 10m git clone https://github.com/${{ github.repository }}.git telegram-ai-system; then
                echo "‚ùå Git clone failed or timeout"
                handle_error "git clone"
              fi
              cd "$PROJECT_DIR" || handle_error "cd to project directory"
            fi
            
            # Ê∏ÖÁêÜ /home/ubuntu/ ‰∏ãÁöÑÈáçË§áÊñá‰ª∂ÔºàËàäÁöÑÊâãÂãïÈÉ®ÁΩ≤ÈÅ∫ÁïôÔºâ
            echo ""
            echo "Ê∏ÖÁêÜËàäÁöÑÈÉ®ÁΩ≤Êñá‰ª∂ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ..."
            # È°ØÂºèÈÄ≤ÂÖ•ÁõÆÈåÑÔºåÈÅøÂÖçÁõ∏Â∞çË∑ØÂæëÂïèÈ°å
            cd /home/ubuntu 2>/dev/null || true
            
            for dir in admin-backend saas-demo deploy scripts; do
              target="/home/ubuntu/$dir"
              # ÈÇèËºØÔºöÂ¶ÇÊûúÁõÆÊ®ôÂ≠òÂú®‰∏îÊòØÁõÆÈåÑ (-d)Ôºå‰∏¶‰∏î ÂÆÉ‰∏çÊòØËªüÈèàÊé• (! -L)
              if [ -d "$target" ] && [ ! -L "$target" ]; then
                echo "‚ö†Ô∏è  ÁôºÁèæËàäÁöÑÈÉ®ÁΩ≤ÁõÆÈåÑ: $target"
                echo "   ÈÄôÂèØËÉΩÊòØËàäÁöÑÊâãÂãïÈÉ®ÁΩ≤ÈÅ∫ÁïôÔºåÂª∫Ë≠∞ÊâãÂãïÊ™¢Êü•ÂæåÂà™Èô§"
              fi || true
            done
            
            # ËøîÂõûÈ†ÖÁõÆÁõÆÈåÑ
            cd "$PROJECT_DIR" || handle_error "cd to project directory"
            
            echo ""
            echo "=========================================="
            echo "Step 2: Pull latest code"
            echo "=========================================="
            if ! timeout 5m git fetch origin main; then
              echo "‚ö†Ô∏è  Git fetch failed or timeout, retrying..."
              git remote set-url origin https://github.com/${{ github.repository }}.git
              if ! timeout 5m git fetch origin main; then
                echo "‚ùå Git fetch failed or timeout"
                handle_error "git fetch"
              fi
            fi
            if ! timeout 1m git reset --hard origin/main; then
              echo "‚ùå Git reset failed or timeout"
              handle_error "git reset"
            fi
            echo "‚úÖ Code updated to latest version"
            timeout 10s git log -1 --oneline || true
            
            echo ""
            echo "=========================================="
            echo "Step 3: Update backend dependencies"
            echo "=========================================="
            if [ -d "admin-backend" ]; then
              cd admin-backend
              # Â¶ÇÊûú venv ‰∏çÂ≠òÂú®Êàñ activate Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂâáÈáçÊñ∞ÂâµÂª∫
              if [ ! -d "venv" ] || [ ! -f "venv/bin/activate" ]; then
                echo "Creating virtual environment (venv is missing or broken)..."
                rm -rf venv  # ÂÆâÂÖ®Ëµ∑Ë¶ãÔºåÂÖàÂà™Èô§ÂèØËÉΩÂ≠òÂú®ÁöÑÂ£ûÁõÆÈåÑ
                # ÂòóË©¶ÂâµÂª∫ËôõÊì¨Áí∞Â¢ÉÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÂÆâË£ù python3-venv ÂåÖ
                if ! python3 -m venv venv 2>/dev/null; then
                  echo "python3-venv not available, installing python3-venv package..."
                  timeout 2m sudo apt-get update -qq && timeout 5m sudo apt-get install -y python3-venv || {
                    echo "‚ùå Failed to install python3-venv"
                    handle_error "install python3-venv"
                  }
                  # ÈáçÊñ∞ÂòóË©¶ÂâµÂª∫ËôõÊì¨Áí∞Â¢É
                  python3 -m venv venv || {
                    echo "‚ùå Failed to create virtual environment after installing python3-venv"
                    handle_error "create venv"
                  }
                fi
              fi
              
              # Check and install ffmpeg (Safe pattern for ssh-action)
              command -v ffmpeg >/dev/null 2>&1 || {
                echo "Installing system ffmpeg..."
                timeout 2m sudo apt-get update -qq
                timeout 5m sudo apt-get install -y ffmpeg
              }
              
              source venv/bin/activate
              echo "Updating Python packages..."
              timeout 2m pip install --quiet --upgrade pip || echo "‚ö†Ô∏è  pip upgrade failed or timeout, continuing..."
              timeout 10m pip install --quiet -r requirements.txt --timeout=300 --cache-dir=/tmp/pip-cache || {
                echo "‚ö†Ô∏è  Some dependencies failed or timeout, continuing..."
              }
              cd ..
              echo "‚úÖ Backend dependencies updated"
            else
              echo "‚ö†Ô∏è  admin-backend directory not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 4: Update Bot dependencies"
            echo "=========================================="
            if [ -f "requirements.txt" ]; then
              # Â¶ÇÊûú venv ‰∏çÂ≠òÂú®Êàñ activate Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂâáÈáçÊñ∞ÂâµÂª∫
              if [ ! -d "venv" ] || [ ! -f "venv/bin/activate" ]; then
                echo "Creating virtual environment (venv is missing or broken)..."
                rm -rf venv  # ÂÆâÂÖ®Ëµ∑Ë¶ãÔºåÂÖàÂà™Èô§ÂèØËÉΩÂ≠òÂú®ÁöÑÂ£ûÁõÆÈåÑ
                # ÂòóË©¶ÂâµÂª∫ËôõÊì¨Áí∞Â¢ÉÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÂÆâË£ù python3-venv ÂåÖ
                if ! python3 -m venv venv 2>/dev/null; then
                  echo "python3-venv not available, installing python3-venv package..."
                  timeout 2m sudo apt-get update -qq && timeout 5m sudo apt-get install -y python3-venv || {
                    echo "‚ùå Failed to install python3-venv"
                    handle_error "install python3-venv"
                  }
                  # ÈáçÊñ∞ÂòóË©¶ÂâµÂª∫ËôõÊì¨Áí∞Â¢É
                  python3 -m venv venv || {
                    echo "‚ùå Failed to create virtual environment after installing python3-venv"
                    handle_error "create venv"
                  }
                fi
              fi
              
              # Check and install ffmpeg (Safe pattern for ssh-action)
              command -v ffmpeg >/dev/null 2>&1 || {
                echo "Installing system ffmpeg..."
                timeout 2m sudo apt-get update -qq
                timeout 5m sudo apt-get install -y ffmpeg
              }
              
              source venv/bin/activate
              timeout 2m pip install --quiet --upgrade pip || echo "‚ö†Ô∏è  pip upgrade failed or timeout, continuing..."
              timeout 10m pip install --quiet -r requirements.txt --timeout=300 --cache-dir=/tmp/pip-cache || {
                echo "‚ö†Ô∏è  Some dependencies failed or timeout, continuing..."
              }
              echo "‚úÖ Bot dependencies updated"
            else
              echo "‚ö†Ô∏è  Bot requirements.txt not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 5: Deploy frontend"
            echo "=========================================="
            if [ -d "saas-demo" ]; then
              cd saas-demo
              
              # Êô∫ËÉΩË∑≥ÈÅéÂâçÁ´ØÊßãÂª∫ÔºöÊ™¢Êü•ÂâçÁ´Ø‰ª£Á¢ºÊòØÂê¶ÊúâËÆäÂãï
              FRONTEND_CHANGED=true
              if git diff --quiet HEAD^ HEAD -- saas-demo 2>/dev/null; then
                # Ê™¢Êü• .next ÁõÆÈåÑÊòØÂê¶Â≠òÂú®‰∏îÂÆåÊï¥
                if [ -d ".next/standalone" ] && [ -d ".next/static" ]; then
                  FRONTEND_CHANGED=false
                  echo "‚è© Frontend code unchanged, skipping build..."
                  echo "‚úÖ Reusing existing build artifacts"
                else
                  echo "üî® Frontend code unchanged but build artifacts missing, rebuilding..."
                fi
              else
                echo "üî® Frontend code changed, rebuilding..."
              fi
              
              if [ "$FRONTEND_CHANGED" = "true" ]; then
                echo "Installing frontend dependencies..."
                if [ -d "node_modules" ]; then
                  echo "Using incremental install..."
                  timeout 15m npm ci --prefer-offline --no-audit --no-fund || timeout 15m npm install --prefer-offline --no-audit --no-fund || {
                    echo "‚ö†Ô∏è  Dependency installation timeout or failed, continuing..."
                  }
                else
                  echo "First-time install..."
                  timeout 20m npm install --prefer-offline --no-audit --no-fund || {
                    echo "‚ö†Ô∏è  Dependency installation timeout or failed, continuing..."
                  }
                fi
                
                echo "Building frontend project..."
                export NODE_OPTIONS="--max-old-space-size=2048"
                
                # Âº∫Âà∂Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑ Next.js ÊûÑÂª∫ÈîÅÔºåÈÅøÂÖç "Unable to acquire lock" ÈîôËØØ
                if [ -f ".next/lock" ]; then
                  echo "üßπ Found stale lock file, removing..."
                  rm -f .next/lock
                fi
                
                timeout 20m npm run build || {
                  echo "‚ö†Ô∏è  Build failed or timeout, but continuing..."
                }
              fi
              
              if [ -d ".next/standalone" ]; then
                echo "Preparing Standalone directory..."
                if [ -d "public" ]; then
                  cp -r public .next/standalone/ || true
                fi
                mkdir -p .next/standalone/.next
                if [ -d ".next/static" ]; then
                  cp -r .next/static .next/standalone/.next/ || true
                fi
                echo "‚úÖ Standalone directory ready"
              else
                echo "‚ö†Ô∏è  Standalone directory not found"
              fi
              
              cd ..
            else
              echo "‚ö†Ô∏è  saas-demo directory not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 6: Update Nginx config"
            echo "=========================================="
            if [ -f "deploy/nginx/aikz.conf" ]; then
              sudo cp deploy/nginx/aikz.conf /etc/nginx/sites-available/aikz.conf
              sudo ln -sf /etc/nginx/sites-available/aikz.conf /etc/nginx/sites-enabled/aikz.conf
              if timeout 30s sudo nginx -t 2>/dev/null; then
                timeout 30s sudo systemctl reload nginx 2>/dev/null && echo "‚úÖ Nginx config updated and reloaded" || echo "‚ö†Ô∏è  Nginx reload failed or timeout"
              else
                echo "‚ùå Nginx config test failed or timeout"
              fi
            else
              echo "‚ö†Ô∏è  deploy/nginx/aikz.conf not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 7: Deploy Systemd services"
            echo "=========================================="
            if [ -f "scripts/server/deploy-systemd.sh" ]; then
              timeout 5m sudo bash scripts/server/deploy-systemd.sh || echo "‚ö†Ô∏è  Systemd deployment failed or timeout, continuing..."
            else
              echo "‚ö†Ô∏è  deploy-systemd.sh not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 8: Restart services"
            echo "=========================================="
            
            echo "Restarting backend service..."
            # ‰ºòÂÖà‰ΩøÁî® luckyred-apiÔºåÂê¶Âàô‰ΩøÁî® telegram-backendÔºà‰ΩøÁî® systemctl cat ÈÅøÂÖçÁÆ°ÈÅì SIGPIPE ÈîôËØØÔºâ
            if systemctl cat luckyred-api.service >/dev/null 2>&1; then
              timeout 30s sudo systemctl restart luckyred-api && echo "‚úÖ Backend (luckyred-api) restarted" || echo "‚ö†Ô∏è  Backend restart failed or timeout"
            else
              timeout 30s sudo systemctl restart telegram-backend && echo "‚úÖ Backend (telegram-backend) restarted" || echo "‚ö†Ô∏è  Backend restart failed or timeout"
            fi
            
            echo "Restarting Bot service..."
            timeout 30s sudo systemctl restart telegram-bot && echo "‚úÖ Bot restarted" || echo "‚ö†Ô∏è  Bot restart failed or timeout"
            
            FRONTEND_SERVICE_NAME=""
            # ‰ΩøÁî® systemctl cat Ê£ÄÊü•ÊúçÂä°ÊòØÂê¶Â≠òÂú®ÔºàÈÅøÂÖçÁÆ°ÈÅì SIGPIPE ÈîôËØØÔºâ
            if systemctl cat liaotian-frontend.service >/dev/null 2>&1; then
              FRONTEND_SERVICE_NAME="liaotian-frontend"
            elif systemctl cat smart-tg-frontend.service >/dev/null 2>&1; then
              FRONTEND_SERVICE_NAME="smart-tg-frontend"
            fi
            
            if [ -n "$FRONTEND_SERVICE_NAME" ]; then
              echo "Restarting frontend service ($FRONTEND_SERVICE_NAME)..."
              timeout 30s sudo systemctl restart "$FRONTEND_SERVICE_NAME" && echo "‚úÖ Frontend restarted" || echo "‚ö†Ô∏è  Frontend restart failed or timeout"
            else
              echo "‚ö†Ô∏è  Frontend systemd service not found"
            fi
            
            echo ""
            echo "Waiting for services to start (3 seconds)..."
            sleep 3
            
            echo ""
            echo "=========================================="
            echo "Step 9: Check service status"
            echo "=========================================="
            
            echo "Checking backend service..."
            # ÈªòËÆ§ÁõÆÊ†áÊúçÂä°
            TARGET_SERVICE="telegram-backend"
            
            # ‰ΩøÁî® systemctl cat Ê£ÄÊü• luckyred-api ÊòØÂê¶Â≠òÂú®
            # ËøôÁßçÊñπÂºè‰∏çÈúÄË¶ÅÁÆ°ÈÅìÔºå‰∏ç‰ºöËß¶Âèë SIGPIPE ÈîôËØØ
            if systemctl cat luckyred-api.service >/dev/null 2>&1; then
              TARGET_SERVICE="luckyred-api"
            fi
            
            echo "Target Service detected: $TARGET_SERVICE"
            
            # ‰ΩøÁî® awk Á°Æ‰øùÂè™ÂèñÁ¨¨‰∏ÄË°åÁöÑÁ¨¨‰∏Ä‰∏™ÂçïËØçÔºåÂπ∂ÂâîÈô§ÊâÄÊúâÁ©∫ÁôΩÂ≠óÁ¨¶
            # ‰ΩøÁî® || true ÂøΩÁï• systemctl is-active ÁöÑÈùûÈõ∂ÈÄÄÂá∫Á†ÅÔºàpipefail ÂÖºÂÆπÔºâ
            BACKEND_STATUS=$(systemctl is-active "$TARGET_SERVICE" 2>/dev/null | awk 'NR==1 {print $1}' || true)
            # Â¶ÇÊûú‰∏∫Á©∫ÂàôÈªòËÆ§‰∏∫ inactive
            if [ -z "$BACKEND_STATUS" ]; then BACKEND_STATUS="inactive"; fi
            echo "Backend Status: $BACKEND_STATUS"
            
            # Â¶ÇÊûúÊúçÂä°Ê≠£Âú®ÂêØÂä®‰∏≠ÔºåÁ≠âÂæÖÊúÄÂ§ö 60 Áßí
            if [ "$BACKEND_STATUS" = "activating" ]; then
              echo "‚è≥ Backend service is activating, waiting up to 60 seconds..."
              for i in {1..60}; do
                sleep 1
                BACKEND_STATUS=$(systemctl is-active "$TARGET_SERVICE" 2>/dev/null | awk 'NR==1 {print $1}' || true)
                if [ -z "$BACKEND_STATUS" ]; then BACKEND_STATUS="inactive"; fi
                
                # Âè™Âú®Áä∂ÊÄÅÂèòÂåñÊó∂ÊâìÂç∞ÔºåÈÅøÂÖçÂà∑Â±èÔºàÊØè 5 ÁßíÊâìÂç∞‰∏ÄÊ¨°Ôºâ
                if [ $((i % 5)) -eq 0 ]; then
                  echo "  Attempt $i/60: Status = $BACKEND_STATUS"
                fi
                
                if [ "$BACKEND_STATUS" = "active" ]; then
                  echo "‚úÖ Service started successfully!"
                  break
                elif [ "$BACKEND_STATUS" = "failed" ]; then
                  echo "‚ùå Service failed to start (status: failed)"
                  break
                elif [ "$BACKEND_STATUS" != "activating" ] && [ "$BACKEND_STATUS" != "active" ]; then
                  # Â¶ÇÊûúÁä∂ÊÄÅ‰∏çÂÜçÊòØ activating Êàñ activeÔºå‰πüÈÄÄÂá∫Âæ™ÁéØ
                  echo "‚ö†Ô∏è  Service status changed to: $BACKEND_STATUS"
                  break
                fi
              done
              
              # Âæ™ÁéØÁªìÊùüÂêéÂÜçÊ¨°Ê£ÄÊü•Áä∂ÊÄÅ
              BACKEND_STATUS=$(systemctl is-active "$TARGET_SERVICE" 2>/dev/null | awk 'NR==1 {print $1}' || true)
              if [ -z "$BACKEND_STATUS" ]; then BACKEND_STATUS="inactive"; fi
              echo "Final status after wait: $BACKEND_STATUS"
            fi
            
            # ÊúÄÁªàÊ£ÄÊü•Áä∂ÊÄÅ - Á°Æ‰øùÁä∂ÊÄÅÂèòÈáèÊòØÊúÄÊñ∞ÁöÑ
            BACKEND_STATUS=$(systemctl is-active "$TARGET_SERVICE" 2>/dev/null | awk 'NR==1 {print $1}' || true)
            if [ -z "$BACKEND_STATUS" ]; then BACKEND_STATUS="inactive"; fi
            
            if [ "$BACKEND_STATUS" = "active" ]; then
              echo "‚úÖ Backend service ($TARGET_SERVICE) is running"
              # ÂÅ•Â∫∑Ê£ÄÊü•
              if timeout 10s curl -s -f --max-time 5 http://localhost:8000/health > /dev/null 2>&1; then
                echo "‚úÖ Backend health check: Passed"
              else
                echo "‚ö†Ô∏è  Backend health check: Failed (Service is up but API not responding)"
                echo "‚¨áÔ∏è Last 20 lines of logs:"
                sudo journalctl -u "$TARGET_SERVICE" -n 20 --no-pager || true
              fi
            else
              # Á´ãÂç≥ËæìÂá∫ÈîôËØØ‰ø°ÊÅØÔºåÈÅøÂÖçË¢´Êà™Êñ≠
              echo ""
              echo "=========================================="
              echo "ERROR: Backend service ($TARGET_SERVICE) failed to start!"
              echo "Final Status: $BACKEND_STATUS"
              echo "=========================================="
              
              # ÂÖàËæìÂá∫ÊúÄÂÖ≥ÈîÆÁöÑÈîôËØØ‰ø°ÊÅØÔºàjournalctl ÁöÑÊúÄÂêé 15 Ë°åÔºâ
              echo ""
              echo "ERROR LOGS (Last 15 lines):"
              sudo journalctl -u "$TARGET_SERVICE" -n 15 --no-pager --no-hostname 2>&1 | tail -15 || echo "  (No logs)"
              
              # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®ÔºàÂÖ≥ÈîÆËØäÊñ≠Ôºâ
              echo ""
              echo "FILE CHECK:"
              UVCORN_EXISTS=$([ -f "$PROJECT_DIR/admin-backend/venv/bin/uvicorn" ] && echo "YES" || echo "NO")
              ENV_EXISTS=$([ -f "$PROJECT_DIR/admin-backend/.env" ] && echo "YES" || echo "NO")
              DIR_EXISTS=$([ -d "$PROJECT_DIR/admin-backend" ] && echo "YES" || echo "NO")
              echo "  uvicorn: $UVCORN_EXISTS"
              echo "  .env: $ENV_EXISTS"
              echo "  WorkingDir: $DIR_EXISTS"
              
              # Python ËØ≠Ê≥ïÊ£ÄÊü•ÔºàÂø´ÈÄüÊ£ÄÊü•Ôºâ
              echo ""
              echo "PYTHON SYNTAX:"
              cd "$PROJECT_DIR/admin-backend" 2>/dev/null || true
              if python3 -m py_compile app/api/group_ai/servers.py 2>&1 >/dev/null; then
                echo "  OK"
              else
                echo "  ERROR:"
                python3 -m py_compile app/api/group_ai/servers.py 2>&1 | head -3 || true
              fi
              
              # ÊúçÂä°ÈÖçÁΩÆÔºàÂè™ÊòæÁ§∫ÂÖ≥ÈîÆÈÉ®ÂàÜÔºâ
              echo ""
              echo "SERVICE CONFIG:"
              sudo systemctl cat "$TARGET_SERVICE" 2>&1 | grep -E "(ExecStart|WorkingDirectory|User|EnvironmentFile)" | head -5 || echo "  (N/A)"
              
              # Âº∫Âà∂Âà∑Êñ∞Âπ∂ÈÄÄÂá∫
              echo ""
              echo "=========================================="
              sync 2>/dev/null || true
              exit 1
            fi
            
            echo ""
            echo "Checking Bot service..."
            # ‰ΩøÁî® awk Á°Æ‰øùÂè™ÂèñÁ¨¨‰∏ÄË°åÁöÑÁ¨¨‰∏Ä‰∏™ÂçïËØçÔºåÂπ∂ÂâîÈô§ÊâÄÊúâÁ©∫ÁôΩÂ≠óÁ¨¶
            # ‰ΩøÁî® || true ÂøΩÁï• systemctl is-active ÁöÑÈùûÈõ∂ÈÄÄÂá∫Á†ÅÔºàpipefail ÂÖºÂÆπÔºâ
            BOT_STATUS=$(systemctl is-active telegram-bot 2>/dev/null | awk 'NR==1 {print $1}' || true)
            # Â¶ÇÊûú‰∏∫Á©∫ÂàôÈªòËÆ§‰∏∫ inactive
            if [ -z "$BOT_STATUS" ]; then BOT_STATUS="inactive"; fi
            echo "Bot Status: $BOT_STATUS"
            if [ "$BOT_STATUS" = "active" ]; then
              echo "‚úÖ Bot service: Running"
            else
              echo "‚ùå Bot service: Not running"
              echo "‚¨áÔ∏è Bot Logs:"
              sudo journalctl -u telegram-bot -n 50 --no-pager || true
              handle_error "Bot service failed to start"
            fi
            
            echo ""
            echo "Checking frontend service..."
            FRONTEND_SERVICE=""
            # ‰ΩøÁî® systemctl cat Ê£ÄÊü•ÊúçÂä°ÊòØÂê¶Â≠òÂú®ÔºàÈÅøÂÖçÁÆ°ÈÅì SIGPIPE ÈîôËØØÔºâ
            if systemctl cat liaotian-frontend.service >/dev/null 2>&1; then
              FRONTEND_SERVICE="liaotian-frontend"
            elif systemctl cat smart-tg-frontend.service >/dev/null 2>&1; then
              FRONTEND_SERVICE="smart-tg-frontend"
            fi
            
            if [ -n "$FRONTEND_SERVICE" ]; then
              # ‰ΩøÁî® awk Á°Æ‰øùÂè™ÂèñÁ¨¨‰∏ÄË°åÁöÑÁ¨¨‰∏Ä‰∏™ÂçïËØçÔºåÂπ∂ÂâîÈô§ÊâÄÊúâÁ©∫ÁôΩÂ≠óÁ¨¶
              # ‰ΩøÁî® || true ÂøΩÁï• systemctl is-active ÁöÑÈùûÈõ∂ÈÄÄÂá∫Á†ÅÔºàpipefail ÂÖºÂÆπÔºâ
              FRONTEND_STATUS=$(systemctl is-active "$FRONTEND_SERVICE" 2>/dev/null | awk 'NR==1 {print $1}' || true)
              # Â¶ÇÊûú‰∏∫Á©∫ÂàôÈªòËÆ§‰∏∫ inactive
              if [ -z "$FRONTEND_STATUS" ]; then FRONTEND_STATUS="inactive"; fi
              echo "Frontend Status: $FRONTEND_STATUS"
              if [ "$FRONTEND_STATUS" = "active" ]; then
                echo "‚úÖ Frontend service ($FRONTEND_SERVICE): Running"
                HTTP_CODE=$(timeout 10s curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://localhost:3000 2>/dev/null || echo "000")
                if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                  echo "‚úÖ Frontend HTTP response: Normal (HTTP $HTTP_CODE)"
                else
                  echo "‚ö†Ô∏è  Frontend HTTP response: Abnormal (HTTP $HTTP_CODE)"
                  echo "‚¨áÔ∏è Last 20 lines of logs:"
                  sudo journalctl -u "$FRONTEND_SERVICE" -n 20 --no-pager || true
                fi
              else
                echo "‚ùå Frontend service ($FRONTEND_SERVICE): Not running"
                echo "‚¨áÔ∏è Frontend Logs:"
                sudo journalctl -u "$FRONTEND_SERVICE" -n 50 --no-pager || true
                handle_error "Frontend service failed to start"
              fi
            else
              echo "‚ö†Ô∏è  Frontend systemd service not found"
            fi
            
            echo ""
            echo "=========================================="
            echo "Deployment completed - $(date)"
            echo "=========================================="
            echo "‚úÖ Code updated"
            echo "‚úÖ Services restarted"
            echo ""
            echo "Service URLs:"
            echo "  - Frontend: http://${{ secrets.SERVER_HOST }}"
            echo "  - Backend API: http://${{ secrets.SERVER_HOST }}:8000"
            echo "  - API Docs: http://${{ secrets.SERVER_HOST }}:8000/docs"
