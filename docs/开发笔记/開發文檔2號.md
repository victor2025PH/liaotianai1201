# 企业后台管理系统开发文档（2号）

## 1. 项目概述
- **目标**：构建服务运营团队、技术支持与管理员的统一后台，提供账户管理、红包活动数据、告警面板与指令控制能力。
- **范围**：前端 Web 后台、后端 API/服务层、数据整合（Session 服务、Redpacket Bot、监控平台）、监控与运维支持。
- **迭代方式**：敏捷开发（2~3 周 Sprint），持续交付与快速反馈。

## 2. 用户角色与权限
| 角色       | 核心目标                     | 权限范围（示例）                                                |
| ---------- | ---------------------------- | ---------------------------------------------------------------- |
| 运营人员   | 监控活动表现、手动干预业务   | 查看账户/活动、查看告警、下发常规指令                           |
| 技术支持   | 排查问题、调试与恢复服务     | 运营权限 + 查看告警详情、执行高级指令、读取技术日志             |
| 管理员     | 管理配置与权限、控制上下线   | 全部权限：用户管理、告警规则、节流策略、系统设置与部署控制     |

> 采用 RBAC 模型，可扩展审计、只读等角色。

## 3. 功能模块规划
1. **仪表板**
   - 当日关键指标：在线账户数、进行中红包活动、未处理告警
   - 快速导航：查看告警、活动详情、指令控制台

2. **账户中心**
   - 账户列表（筛选：角色、状态）
   - 账户详情：基本信息、节流配置、操作日志
   - 操作：启用/停用、重置 Session、角色调整

3. **红包活动**
   - 活动总览：发放次数、成功率、平均响应时间
   - 活动详情：参与账户、日志、异常原因
   - 数据导出：按日/周/月生成报表

4. **告警中心**
   - 告警列表：级别、状态、通知渠道
   - 告警详情：触发指标、分派记录、处理进度
   - 告警规则配置：阈值、告警方式、关联操作

5. **指令控制台**
   - 单账户指令：文本消息、执行脚本、重新连接
   - 批量操作：群发公告、批量启停
   - 指令历史与回执：记录执行结果、失败重试

6. **系统设置（扩展）**
   - 用户与权限管理
   - API Key / 集成配置
   - 系统参数：节流阈值、监控配置

## 4. 数据源与 API 盘点
| 数据项           | 现有来源                     | 待整合/新增接口                 |
| ---------------- | ---------------------------- | -------------------------------- |
| Session 账户数据 | `session_accounts.db` / CLI  | REST API：列表、详情、操作       |
| 红包活动记录     | Redpacket Bot / MQ           | REST API：活动列表、详情、统计   |
| 监控指标         | Prometheus `/metrics`       | 指标查询 API 或缓存数据服务     |
| 告警数据         | 告警系统（待定）             | 告警 CRUD API、日志查询          |
| 操作日志         | Session 服务日志             | 日志查询 API、审计记录           |

> 需要统一后端服务层整合各数据源，提供规范化 API。

## 5. 信息架构与原型
- **信息架构**：仪表板 → 账户中心 → 红包活动 → 告警中心 → 指令控制台 → 系统设置
- **原型迭代建议**：
  - 使用 Figma 快速搭建核心页面（仪表板、账户列表、活动详情、告警列表、指令控制台）
  - 与运营、技术团队进行场景评审
  - 关注界面信息层级与交互流程（例如告警处理、批量操作的确认反馈）

## 6. 技术选型
### 6.1 前端
- 框架：React + Ant Design（或 Vue + Element Plus）
- 状态管理：Redux Toolkit / Zustand（React）或 Pinia（Vue）
- 图表：AntV G2、ECharts 等
- 认证：JWT + Refresh token，结合后端权限验证

### 6.2 后端
- 框架：FastAPI / NestJS / Django REST Framework
- 数据库：PostgreSQL（主库）+ Redis（缓存/队列）
- API 规范：
  - RESTful 接口，统一响应结构（code/message/data）
  - 捕获异常并返回标准错误码
  - 权限校验、操作审计
- 安全机制：角色权限验证、敏感操作二次确认、操作日志记录

### 6.3 监控与运维
- Prometheus + Grafana（指标展示）
- 告警：Telegram Bot / Slack Webhook / Email
- 日志：集中式日志（ELK/ Loki）或标准文件 + 日志轮转

## 7. 开发计划与迭代
### 7.1 MVP（2~3 周）
1. 登录与权限框架
2. 仪表板核心指标
3. 账户列表 & 详情 + 基本操作（启停、节流配置查看）
4. 指令控制台（单账户文本指令）
5. 红包活动列表概览
6. 后端 API：账户查询、指令下发、活动查询
7. 自动化测试与 QA 场景覆盖

### 7.2 后续迭代
- 第二阶段：告警中心、告警规则管理、通知配置
- 第三阶段：报表导出、批量操作增强、操作审计
- 长期规划：多平台接入、营运策略分析、智能推荐

### 7.3 开发流程
1. 需求评审 → 原型评审 → 技术评审
2. 开发 → 自测 → QA → 上线 → 复盘
3. Git Flow 管理、CI 自动化测试、代码审查
4. 测试策略：单元测试、集成测试、E2E 测试
5. 上线流程：按照 `docs/monitoring_and_release.md` 执行上线、观察期、告警验证

## 8. 风险与缓解
- **Session 操作安全**：引入操作审计、权限审批、自动备份
- **告警噪音**：设定合理阈值，支持告警合并和冷却时间
- **系统性能**：对热点接口引入缓存，进行压力测试与参数调优
- **数据一致性**：明确数据同步策略，关键数据需具备回滚方案

## 9. 后续动作
1. 整理原型与需求细化，启动 UX 设计
2. 搭建基础工程项目（前后端脚手架、CI/CD、基础监控）
3. 安排 MVP 开发任务（任务分配与 Sprint 计划）
4. 确立测试与上线机制（责任人、目标环境、回滚流程）

## 10. 可视化测试方案（前端 E2E）
- **框架与配置**：引入 Playwright，配置 `playwright.config.ts` 以自动启动 Vite 开发服务器，并在测试中通过 `page.route` 拦截后端 API，确保无后端依赖即可复现 UI 交互。
- **核心场景**：覆盖仪表板统计展示、侧边菜单跳转、账户表格渲染、活动/告警看板呈现等关键页面，测试脚本位于 `admin-frontend/tests/e2e/dashboard.spec.ts`。
- **执行方式**：
  - 安装依赖后执行 `npm run test:e2e`，自动生成 Playwright HTML 报表。
  - 使用 `npm run test:e2e:ui` 进入可视化调试界面，逐步回放步骤。
  - 通过 `npm run test:e2e:report` 打开最近一次测试的可视化报告（包含截图、Trace）。
- **环境参数**：默认拦截 Mock API，如需连线真实后端可设置 `PLAYWRIGHT_API_BASE_URL`，并通过 `PLAYWRIGHT_HOST`、`PLAYWRIGHT_PORT` 调整测试服务器监听。
- **CI 建议**：在流水线上加入 `npm run test:e2e` 步骤，并将报表上传到制品库或对象存储，确保可追溯的 UI 测试记录。

## 11. 持续整合流程
- **工作流配置**：`.github/workflows/ci.yml` 分為三個 job：
  1. `Lint and Build`：安裝 Python/Poetry 與 Node 環境，執行 `poetry run ruff check .`、`poetry run black --check app tests`，以及前端的 `npm run lint`、`npm run build`，確保程式風格與編譯品質。
  2. `Backend Tests`：依賴前一 job，於 `admin-backend` 執行 `poetry run pytest --cov=app --cov-report=xml`，並上傳 `coverage.xml` 為 `backend-coverage` artefact。
  3. `Frontend E2E`：依賴前兩個 job，於 `admin-frontend` 執行 `npm run test:e2e`，並上傳 `playwright-report`。
- **報表瀏覽**：下載 artefact 後，可本地以 VS Code 或瀏覽器開啟 `coverage.xml`（搭配 Coverage 外掛）與 Playwright HTML 報表（`npx playwright show-report`）。
- **擴充建議**：後續可加入安全掃描、Docker 映像打包與部署觸發邏輯，並考慮導入 SonarQube / Codecov 以強化指標管理。

---

此开发文档作为企业后台管理系统的规划蓝图，覆盖需求分析、技术方案、迭代规划与风险控制，为后续需求细化与开发执行提供统一依据。 

