# å®æ—¶å‘Šè­¦é€šçŸ¥åŠŸèƒ½å¼€å‘å®ŒæˆæŠ¥å‘Š

> **å®Œæˆæ—¥æœŸ**: 2025-11-19  
> **ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
> **çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å¢å¼ºçš„ Telegram Bot å®æ—¶å‘Šè­¦é€šçŸ¥åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‘Šè­¦èšåˆã€å†·å´æœºåˆ¶ã€è‡ªåŠ¨é‡è¯•ã€æ‰¹é‡å‘é€ç­‰ç‰¹æ€§ï¼Œæ˜¾è‘—æå‡äº†å‘Šè­¦é€šçŸ¥çš„å¯é æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

---

## å·²å®Œæˆçš„å·¥ä½œ

### 1. Telegram å‘Šè­¦æœåŠ¡æ¨¡å—

#### âœ… `admin-backend/app/services/telegram_alert_service.py` - æ ¸å¿ƒæœåŠ¡

**æ ¸å¿ƒç±»**: `TelegramAlertService`

**æ ¸å¿ƒåŠŸèƒ½**:

1. **å‘Šè­¦èšåˆ**:
   - å‘Šè­¦ç¼“å†²åŒºï¼ˆæœ€è¿‘100æ¡ï¼‰
   - å‘Šè­¦å†·å´æœºåˆ¶ï¼ˆ5åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªå‘é€ä¸€æ¬¡ï¼‰
   - è‡ªåŠ¨å»é‡

2. **æ¶ˆæ¯æ ¼å¼åŒ–**:
   - HTML æ ¼å¼æ¶ˆæ¯
   - è¡¨æƒ…ç¬¦å·æ ‡è¯†ï¼ˆğŸ”´ é”™è¯¯ã€ğŸŸ¡ è­¦å‘Šã€ğŸ”µ ä¿¡æ¯ï¼‰
   - è¯¦ç»†ä¿¡æ¯å±•ç¤º

3. **å‘é€æœºåˆ¶**:
   - è‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼Œæœ€å¤š3æ¬¡ï¼‰
   - é€Ÿç‡é™åˆ¶å¤„ç†ï¼ˆ429 é”™è¯¯è‡ªåŠ¨ç­‰å¾…ï¼‰
   - æ‰¹é‡å‘é€ï¼ˆé¿å…æ¶ˆæ¯è¿‡å¤šï¼‰

4. **ç»Ÿè®¡ä¿¡æ¯**:
   - å‘é€æˆåŠŸæ•°
   - å‘é€å¤±è´¥æ•°
   - è¢«æŠ‘åˆ¶çš„å‘Šè­¦æ•°

**å‘Šè­¦å†·å´æœºåˆ¶**:
- ç›¸åŒå‘Šè­¦åœ¨5åˆ†é’Ÿå†…åªå‘é€ä¸€æ¬¡
- åŸºäºå‘Šè­¦ç±»å‹ã€è´¦å·IDå’Œæ¶ˆæ¯å†…å®¹ç”Ÿæˆå”¯ä¸€é”®
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸå†·å´è®°å½•

**æ‰¹é‡å‘é€**:
- å¦‚æœå‘Šè­¦æ•°é‡ > 5ï¼Œå…ˆå‘é€æ‘˜è¦
- ç„¶åå‘é€å‰5ä¸ªè¯¦ç»†å‘Šè­¦
- é¿å…æ¶ˆæ¯è¿‡å¤šå¯¼è‡´åˆ·å±

### 2. å‘Šè­¦æ£€æŸ¥é›†æˆ

#### âœ… `admin-backend/app/api/group_ai/monitor.py` - å‘Šè­¦æ£€æŸ¥é›†æˆ

**é›†æˆç‚¹**:
- æ‰‹åŠ¨å‘Šè­¦æ£€æŸ¥æ—¶è‡ªåŠ¨å‘é€ Telegram é€šçŸ¥
- æ›´æ–° Prometheus æŒ‡æ ‡ï¼ˆ`alerts_total`, `alerts_active`ï¼‰

#### âœ… `admin-backend/app/services/scheduled_alert_checker.py` - å®šæ—¶æ£€æŸ¥é›†æˆ

**é›†æˆç‚¹**:
- å®šæ—¶å‘Šè­¦æ£€æŸ¥æ—¶è‡ªåŠ¨å‘é€ Telegram é€šçŸ¥
- æ‰¹é‡å‘é€å‘Šè­¦ï¼ˆé¿å…æ¶ˆæ¯è¿‡å¤šï¼‰

### 3. API ç«¯ç‚¹

#### âœ… `admin-backend/app/api/group_ai/telegram_alerts.py` - ç®¡ç† API

**ç«¯ç‚¹**:

1. **`GET /api/v1/group-ai/telegram-alerts/stats`**:
   - è·å– Telegram å‘Šè­¦ç»Ÿè®¡ä¿¡æ¯
   - è¿”å›ï¼šå¯ç”¨çŠ¶æ€ã€å‘é€æ•°ã€å¤±è´¥æ•°ã€æŠ‘åˆ¶æ•°ç­‰

2. **`POST /api/v1/group-ai/telegram-alerts/test`**:
   - æµ‹è¯• Telegram å‘Šè­¦å‘é€
   - æ”¯æŒæŒ‡å®š Chat IDï¼ˆå¯é€‰ï¼‰
   - è¿”å›å‘é€ç»“æœ

### 4. é…ç½®æ”¯æŒ

#### âœ… `admin-backend/app/core/config.py` - é…ç½®æ›´æ–°

**æ–°å¢é…ç½®é¡¹**:
- `telegram_chat_id`: Telegram Chat IDï¼ˆç”¨äºæ¥æ”¶å‘Šè­¦é€šçŸ¥ï¼‰

**é…ç½®ä¼˜å…ˆçº§**:
1. `admin-backend` é…ç½®ä¸­çš„ `telegram_chat_id`
2. `group_ai_service` é…ç½®ä¸­çš„ `alert_telegram_chat_id`

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### å‘Šè­¦å†·å´æœºåˆ¶

**å”¯ä¸€é”®ç”Ÿæˆ**:
```python
alert_key = f"{alert_type}:{account_id}:{hash(message[:50])}"
```

**å†·å´æ—¶é—´**:
- é»˜è®¤ï¼š5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰
- å¯é…ç½®

**å†·å´è®°å½•æ¸…ç†**:
- è‡ªåŠ¨æ¸…ç†è¶…è¿‡1å°æ—¶çš„å†·å´è®°å½•
- é¿å…å†…å­˜æ³„æ¼

### æ¶ˆæ¯æ ¼å¼åŒ–

**HTML æ ¼å¼ç¤ºä¾‹**:
```html
ğŸ”´ <b>å‘Šè­¦é€šçŸ¥</b>

<b>ç´šåˆ¥ï¼š</b>ERROR
<b>é¡å‹ï¼š</b>account_error
<b>æ™‚é–“ï¼š</b>2025-11-19 10:30:00
<b>è³¬è™Ÿï¼š</b>account_123

<b>æ¶ˆæ¯ï¼š</b>
è³¬è™Ÿ account_123 é€£æ¥å¤±æ•—

<b>è©³æƒ…ï¼š</b>
  â€¢ error_type: ConnectionError
  â€¢ retry_count: 3
```

### é‡è¯•æœºåˆ¶

**æŒ‡æ•°é€€é¿**:
- ç¬¬1æ¬¡é‡è¯•: 2ç§’
- ç¬¬2æ¬¡é‡è¯•: 4ç§’
- ç¬¬3æ¬¡é‡è¯•: 8ç§’

**é€Ÿç‡é™åˆ¶å¤„ç†**:
- æ£€æµ‹ 429 é”™è¯¯
- è§£æ `Retry-After` å¤´
- è‡ªåŠ¨ç­‰å¾…åé‡è¯•

### æ‰¹é‡å‘é€é€»è¾‘

**æ‘˜è¦æ¶ˆæ¯**:
- å¦‚æœå‘Šè­¦æ•°é‡ > 5ï¼Œå…ˆå‘é€æ‘˜è¦
- æ‘˜è¦åŒ…å«æ€»å‘Šè­¦æ•°å’Œæ˜¾ç¤ºæ•°é‡

**è¯¦ç»†å‘Šè­¦**:
- åªå‘é€å‰5ä¸ªè¯¦ç»†å‘Šè­¦
- é¿å…æ¶ˆæ¯è¿‡å¤š

---

## ä½¿ç”¨åœºæ™¯

### 1. é…ç½® Telegram Bot

**æ­¥éª¤**:
1. åˆ›å»º Telegram Botï¼ˆé€šè¿‡ @BotFatherï¼‰
2. è·å– Bot Token
3. è·å– Chat IDï¼ˆå‘é€æ¶ˆæ¯ç»™ @userinfobot æˆ–ä½¿ç”¨ç¾¤ç»„ IDï¼‰
4. é…ç½®ç¯å¢ƒå˜é‡

**ç¯å¢ƒå˜é‡**:
```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here
```

### 2. æµ‹è¯•å‘Šè­¦å‘é€

```bash
# æµ‹è¯•å‘Šè­¦å‘é€
curl -X POST http://localhost:8000/api/v1/group-ai/telegram-alerts/test \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

```bash
# è·å–ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:8000/api/v1/group-ai/telegram-alerts/stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4. è‡ªåŠ¨å‘Šè­¦é€šçŸ¥

å‘Šè­¦ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨å‘é€ï¼š
- å®šæ—¶å‘Šè­¦æ£€æŸ¥å‘ç°æ–°å‘Šè­¦
- æ‰‹åŠ¨è§¦å‘å‘Šè­¦æ£€æŸ¥å‘ç°æ–°å‘Šè­¦
- ç³»ç»Ÿé”™è¯¯è§¦å‘å‘Šè­¦

---

## å‘Šè­¦æ¶ˆæ¯ç¤ºä¾‹

### é”™è¯¯å‘Šè­¦

```
ğŸ”´ å‘Šè­¦é€šçŸ¥

ç´šåˆ¥ï¼šERROR
é¡å‹ï¼šaccount_error
æ™‚é–“ï¼š2025-11-19 10:30:00
è³¬è™Ÿï¼šaccount_123

æ¶ˆæ¯ï¼š
è³¬è™Ÿ account_123 é€£æ¥å¤±æ•—ï¼Œå·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸

è©³æƒ…ï¼š
  â€¢ error_type: ConnectionError
  â€¢ retry_count: 3
  â€¢ last_error: Network unreachable
```

### è­¦å‘Šå‘Šè­¦

```
ğŸŸ¡ å‘Šè­¦é€šçŸ¥

ç´šåˆ¥ï¼šWARNING
é¡å‹ï¼šaccount_offline
æ™‚é–“ï¼š2025-11-19 10:30:00
è³¬è™Ÿï¼šaccount_456

æ¶ˆæ¯ï¼š
è³¬è™Ÿ account_456 å·²é›¢ç·šè¶…é 5 åˆ†é˜
```

### æ‰¹é‡å‘Šè­¦æ‘˜è¦

```
ğŸ”µ å‘Šè­¦é€šçŸ¥

ç´šåˆ¥ï¼šINFO
é¡å‹ï¼šsummary
æ™‚é–“ï¼š2025-11-19 10:30:00

æ¶ˆæ¯ï¼š
æ£€æµ‹åˆ° 10 ä¸ªå‘Šè­¦ï¼Œä»¥ä¸‹æ˜¯å‰ 5 ä¸ª

è©³æƒ…ï¼š
  â€¢ total_alerts: 10
  â€¢ showing: 5
```

---

## æ€§èƒ½ç‰¹æ€§

### å‘Šè­¦èšåˆ

- **å†·å´æœºåˆ¶**: é¿å…ç›¸åŒå‘Šè­¦é‡å¤å‘é€
- **æ‰¹é‡å‘é€**: é¿å…æ¶ˆæ¯è¿‡å¤š
- **æ‘˜è¦æ¨¡å¼**: å‘Šè­¦è¿‡å¤šæ—¶å‘é€æ‘˜è¦

### å¯é æ€§

- **è‡ªåŠ¨é‡è¯•**: ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•
- **é€Ÿç‡é™åˆ¶å¤„ç†**: è‡ªåŠ¨å¤„ç† Telegram é€Ÿç‡é™åˆ¶
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†

### èµ„æºå ç”¨

- **å†…å­˜**: å‘Šè­¦ç¼“å†²åŒºæœ€å¤š100æ¡
- **å†·å´è®°å½•**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•
- **ç½‘ç»œ**: å¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡ä¸»æµç¨‹

---

## ç»Ÿè®¡ä¿¡æ¯

**ç»Ÿè®¡æŒ‡æ ‡**:
- `sent`: å‘é€æˆåŠŸæ•°
- `failed`: å‘é€å¤±è´¥æ•°
- `suppressed`: è¢«æŠ‘åˆ¶çš„å‘Šè­¦æ•°ï¼ˆå†·å´æœŸå†…ï¼‰
- `buffer_size`: å‘Šè­¦ç¼“å†²åŒºå¤§å°
- `cooldown_size`: å†·å´è®°å½•æ•°é‡

**æŸ¥çœ‹ç»Ÿè®¡**:
```bash
GET /api/v1/group-ai/telegram-alerts/stats
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "enabled": true,
  "sent": 150,
  "failed": 2,
  "suppressed": 45,
  "buffer_size": 50,
  "cooldown_size": 12
}
```

---

## æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•

```bash
# 1. æµ‹è¯•å‘Šè­¦å‘é€
curl -X POST http://localhost:8000/api/v1/group-ai/telegram-alerts/test \
  -H "Authorization: Bearer YOUR_TOKEN"

# 2. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
curl http://localhost:8000/api/v1/group-ai/telegram-alerts/stats \
  -H "Authorization: Bearer YOUR_TOKEN"

# 3. è§¦å‘å‘Šè­¦æ£€æŸ¥
curl -X POST http://localhost:8000/api/v1/group-ai/monitor/alerts/check \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 2. å†·å´æœºåˆ¶æµ‹è¯•

- [ ] å‘é€ç›¸åŒå‘Šè­¦ï¼ŒéªŒè¯5åˆ†é’Ÿå†…åªå‘é€ä¸€æ¬¡
- [ ] å‘é€ä¸åŒå‘Šè­¦ï¼ŒéªŒè¯éƒ½èƒ½æ­£å¸¸å‘é€
- [ ] ç­‰å¾…5åˆ†é’Ÿåï¼ŒéªŒè¯ç›¸åŒå‘Šè­¦å¯ä»¥å†æ¬¡å‘é€

### 3. æ‰¹é‡å‘é€æµ‹è¯•

- [ ] è§¦å‘å¤šä¸ªå‘Šè­¦ï¼ˆ> 5ä¸ªï¼‰ï¼ŒéªŒè¯å‘é€æ‘˜è¦
- [ ] è§¦å‘å°‘é‡å‘Šè­¦ï¼ˆ< 5ä¸ªï¼‰ï¼ŒéªŒè¯å…¨éƒ¨å‘é€

---

## å·²çŸ¥é—®é¢˜

1. **Chat ID è·å–**: éœ€è¦æ‰‹åŠ¨è·å– Chat IDï¼ˆå¯ä»¥é€šè¿‡ @userinfobotï¼‰
2. **ç¾¤ç»„é€šçŸ¥**: éœ€è¦å°† Bot æ·»åŠ åˆ°ç¾¤ç»„å¹¶è·å–ç¾¤ç»„ ID
3. **æ¶ˆæ¯é•¿åº¦**: Telegram æ¶ˆæ¯æœ€å¤§é•¿åº¦ 4096 å­—ç¬¦ï¼ˆå·²å¤„ç†ï¼‰

---

## ä¸‹ä¸€æ­¥è®¡åˆ’

### å¯é€‰ä¼˜åŒ–

1. **å‘Šè­¦è§„åˆ™é…ç½®**:
   - æ”¯æŒä¸ºä¸åŒå‘Šè­¦ç±»å‹é…ç½®ä¸åŒçš„ Chat ID
   - æ”¯æŒå‘Šè­¦çº§åˆ«è¿‡æ»¤

2. **å‘Šè­¦æ¨¡æ¿**:
   - æ”¯æŒè‡ªå®šä¹‰å‘Šè­¦æ¶ˆæ¯æ¨¡æ¿
   - æ”¯æŒå¤šè¯­è¨€

3. **å‘Šè­¦å†å²**:
   - è®°å½•å‘Šè­¦å‘é€å†å²
   - æ”¯æŒå‘Šè­¦æŸ¥è¯¢å’Œç»Ÿè®¡

---

## ç›¸å…³æ–‡ä»¶

- `admin-backend/app/services/telegram_alert_service.py` - Telegram å‘Šè­¦æœåŠ¡
- `admin-backend/app/api/group_ai/telegram_alerts.py` - ç®¡ç† API
- `admin-backend/app/api/group_ai/monitor.py` - å‘Šè­¦æ£€æŸ¥é›†æˆ
- `admin-backend/app/services/scheduled_alert_checker.py` - å®šæ—¶æ£€æŸ¥é›†æˆ
- `admin-backend/app/core/config.py` - é…ç½®æ”¯æŒ

---

## æ€»ç»“

å®æ—¶å‘Šè­¦é€šçŸ¥åŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°ç³»ç»Ÿä¸­ã€‚è¯¥åŠŸèƒ½æä¾›äº†ï¼š

- âœ… å¢å¼ºçš„ Telegram Bot å‘Šè­¦é€šçŸ¥
- âœ… å‘Šè­¦èšåˆå’Œå†·å´æœºåˆ¶ï¼ˆé¿å…å‘Šè­¦é£æš´ï¼‰
- âœ… è‡ªåŠ¨é‡è¯•å’Œé€Ÿç‡é™åˆ¶å¤„ç†
- âœ… æ‰¹é‡å‘é€ï¼ˆé¿å…æ¶ˆæ¯è¿‡å¤šï¼‰
- âœ… ç»Ÿè®¡ä¿¡æ¯å’Œæµ‹è¯•æ¥å£
- âœ… ä¸ç°æœ‰å‘Šè­¦ç³»ç»Ÿå®Œç¾é›†æˆ

ç³»ç»Ÿå‘Šè­¦é€šçŸ¥èƒ½åŠ›å¾—åˆ°æ˜¾è‘—æå‡ï¼Œèƒ½å¤ŸåŠæ—¶ã€å¯é åœ°å°†å‘Šè­¦ä¿¡æ¯å‘é€åˆ° Telegramï¼Œå¸®åŠ©è¿ç»´äººå‘˜å¿«é€Ÿå“åº”é—®é¢˜ã€‚

---

**æŠ¥å‘Šç»“æŸ**

