# 502 错误 - 问题已找到：端口占用

## 问题诊断结果

从日志可以看到：

✅ **后端服务可以正常启动**：
- 模块导入成功：`OK`
- 服务启动成功：`INFO:     Application startup complete.`

❌ **但是端口被占用**：
- `ERROR: [Errno 98] error while attempting to bind on address ('0.0.0.0', 8000): address already in use`

## 解决方案

### 步骤1：清理所有旧进程

在服务器上执行：

```bash
# 清理后端进程
pkill -9 -f 'uvicorn.*app.main:app'
pkill -9 -f 'python.*uvicorn'

# 清理端口
sudo lsof -ti:8000 | xargs kill -9 2>/dev/null || true

# 等待2秒
sleep 2

# 验证端口已释放
sudo ss -tlnp | grep 8000 || echo "端口8000已空闲"
```

### 步骤2：后台启动后端服务

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate

# 后台启动
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &

# 等待8秒
sleep 8

# 验证服务
curl http://localhost:8000/health
```

应该返回 `{"status":"ok"}` 或类似响应。

### 步骤3：启动前端服务（如果未运行）

```bash
cd ~/liaotian/saas-demo

# 清理旧进程
pkill -f 'next.*dev|node.*3000' || true
sleep 2

# 启动前端
nohup npm run dev > /tmp/frontend.log 2>&1 &

# 等待15秒
sleep 15

# 验证
curl http://localhost:3000
```

### 步骤4：使用一键脚本（推荐）

```bash
bash ~/liaotian/deploy/清理并启动所有服务.sh
```

这个脚本会自动：
- 清理所有旧进程和端口占用
- 启动后端服务
- 启动前端服务
- 验证服务状态

## 当前状态

从你的终端输出可以看到：

1. **服务可以启动** - 前台启动成功
2. **需要清理端口** - 8000端口被占用
3. **需要后台运行** - 当前是前台运行，按 Ctrl+C 会停止

## 立即执行的命令

### 在第一个终端（如果服务还在前台运行）

按 `Ctrl+C` 停止前台服务，然后执行：

```bash
# 清理并后台启动
pkill -9 -f uvicorn
cd ~/liaotian/admin-backend
source .venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &
sleep 8
curl http://localhost:8000/health
```

### 或者使用一键脚本

```bash
bash ~/liaotian/deploy/清理并启动所有服务.sh
```

## 验证

启动后，验证：

```bash
# 1. 检查进程
ps aux | grep uvicorn | grep -v grep

# 2. 检查端口
sudo ss -tlnp | grep 8000

# 3. 健康检查
curl http://localhost:8000/health

# 4. 检查浏览器
# 访问: http://aikz.usdt2026.cc/group-ai/accounts
```

## 预期结果

✅ 后端进程运行中  
✅ 端口8000监听中  
✅ 健康检查返回 `{"status":"ok"}`  
✅ 浏览器不再显示 502 错误

## 如果仍然失败

查看日志：

```bash
tail -100 /tmp/backend_final.log
```

查找是否有其他错误信息。

---

**问题已定位！请执行上述步骤清理端口并重新启动服务。**
