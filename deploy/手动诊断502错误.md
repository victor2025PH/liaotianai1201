# 手动诊断502错误

## 当前问题

页面显示 **502 Bad Gateway**，说明Nginx无法连接到Next.js服务器（端口3000）。

## 诊断步骤

请在服务器上依次执行以下命令：

### 1. 检查服务状态

```bash
sudo systemctl status liaotian-frontend --no-pager
```

**预期结果**：
- 如果服务是 `active (running)`，说明服务正在运行
- 如果服务是 `failed` 或 `inactive`，说明服务没有启动

### 2. 查看服务日志

```bash
sudo journalctl -u liaotian-frontend -n 50 --no-pager
```

**查找**：
- 错误信息（Error）
- 警告信息（Warning）
- 启动失败的原因

### 3. 检查端口监听

```bash
ss -tlnp | grep ':3000'
```

**预期结果**：
- 应该看到 `:3000` 端口被监听
- 如果没有输出，说明服务没有监听端口

### 4. 检查standalone目录和静态文件

```bash
cd /home/ubuntu/liaotian/saas-demo

# 查找standalone目录
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
echo "Standalone目录: $STANDALONE_DIR"

# 检查静态文件
ls -la "$STANDALONE_DIR/.next/static/chunks/adc3be135379192a.js"
```

**预期结果**：
- 应该显示文件存在
- 如果文件不存在，需要复制静态文件

### 5. 检查systemd服务配置

```bash
cat /etc/systemd/system/liaotian-frontend.service
```

**检查**：
- `WorkingDirectory` 应该指向standalone目录
- `ExecStart` 应该正确启动server.js
- `Environment` 变量是否正确

### 6. 尝试手动启动服务器（测试）

```bash
cd /home/ubuntu/liaotian/saas-demo
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
cd "$STANDALONE_DIR"

# 加载NVM
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
nvm use 20

# 手动启动服务器
node server.js
```

**预期结果**：
- 如果服务器能启动，会看到类似 "Ready on http://localhost:3000" 的消息
- 如果有错误，会显示错误信息

**注意**：按 `Ctrl+C` 停止测试服务器

## 常见问题和解决方案

### 问题1：服务状态为 `failed`

**可能原因**：
- server.js文件不存在
- Node.js路径不正确
- 工作目录不正确

**解决方案**：
```bash
# 检查server.js是否存在
find /home/ubuntu/liaotian/saas-demo/.next/standalone -name 'server.js'

# 检查Node.js路径
which node
/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node --version

# 检查systemd服务配置
sudo systemctl edit liaotian-frontend
```

### 问题2：端口3000未监听

**可能原因**：
- 服务启动失败
- 服务崩溃

**解决方案**：
```bash
# 查看详细日志
sudo journalctl -u liaotian-frontend -n 100 --no-pager

# 尝试手动启动查看错误
cd /home/ubuntu/liaotian/saas-demo
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
cd "$STANDALONE_DIR"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
nvm use 20
node server.js
```

### 问题3：静态文件不存在

**解决方案**：
```bash
cd /home/ubuntu/liaotian/saas-demo
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
mkdir -p "$STANDALONE_DIR/.next/static"
cp -r .next/static/* "$STANDALONE_DIR/.next/static/"
```

### 问题4：工作目录不正确

**解决方案**：
```bash
# 查找standalone目录
STANDALONE_DIR=$(find /home/ubuntu/liaotian/saas-demo/.next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
echo "Standalone目录: $STANDALONE_DIR"

# 修改systemd服务配置
sudo systemctl edit liaotian-frontend
```

添加以下内容：
```ini
[Service]
WorkingDirectory=$STANDALONE_DIR
```

然后：
```bash
sudo systemctl daemon-reload
sudo systemctl restart liaotian-frontend
```

## 快速修复脚本

如果诊断后发现问题，可以执行以下快速修复：

```bash
cd /home/ubuntu/liaotian/saas-demo

# 1. 停止服务
sudo systemctl stop liaotian-frontend

# 2. 查找standalone目录
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
echo "Standalone目录: $STANDALONE_DIR"

# 3. 复制静态文件
mkdir -p "$STANDALONE_DIR/.next/static"
cp -r .next/static/* "$STANDALONE_DIR/.next/static/"

# 4. 检查并修复systemd服务配置
# （根据诊断结果修改）

# 5. 重启服务
sudo systemctl daemon-reload
sudo systemctl start liaotian-frontend
sleep 5

# 6. 检查状态
sudo systemctl status liaotian-frontend --no-pager | head -20
ss -tlnp | grep ':3000'
```

## 请提供诊断结果

执行上述诊断命令后，请提供：
1. `systemctl status` 的输出
2. `journalctl` 日志中的错误信息
3. `ss -tlnp | grep ':3000'` 的输出
4. 手动启动 `node server.js` 时的输出（如果有错误）

这样我可以根据具体情况提供针对性的修复方案。

