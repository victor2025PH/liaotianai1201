# ðŸ”§ æœåŠ¡å¯åŠ¨é—®é¢˜ä¿®å¤æŒ‡å—

## ðŸŽ¯ é—®é¢˜åˆ†æž

æ ¹æ®æ—¥å¿—ï¼Œå‘çŽ°ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç«¯å£ 3000 è¢«å ç”¨**ï¼šå‰ç«¯æœåŠ¡æ— æ³•å¯åŠ¨
   - é”™è¯¯ï¼š`EADDRINUSE: address already in use 0.0.0.0:3000`
   - åŽŸå› ï¼šæœ‰å…¶ä»–è¿›ç¨‹æ­£åœ¨ä½¿ç”¨ç«¯å£ 3000

2. **Systemd é…ç½®é”™è¯¯**ï¼š
   - é”™è¯¯ï¼š`Failed to parse service restart specifier, ignoring: always RestartSec=10`
   - åŽŸå› ï¼š`Restart=always` å’Œ `RestartSec=10` å†™åœ¨äº†åŒä¸€è¡Œ

3. **æœåŠ¡ä¸æ–­é‡å¯**ï¼š
   - å‰ç«¯æœåŠ¡é‡å¯è®¡æ•°å™¨è¾¾åˆ° 7434+
   - å› ä¸ºç«¯å£å†²çªå¯¼è‡´å¯åŠ¨å¤±è´¥ï¼Œsystemd ä¸æ–­å°è¯•é‡å¯

---

## âœ… ç«‹å³ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ³• 1: ä½¿ç”¨ä¿®å¤è„šæœ¬ï¼ˆæŽ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd ~/liaotian

# å¦‚æžœè„šæœ¬å­˜åœ¨
sudo bash scripts/fix_service_issues.sh

# æˆ–è€…ç›´æŽ¥æ‰§è¡Œä¿®å¤å‘½ä»¤ï¼ˆè§æ–¹æ³• 2ï¼‰
```

### æ–¹æ³• 2: æ‰‹åŠ¨ä¿®å¤ï¼ˆä¸€æ­¥ä¸€æ­¥ï¼‰

#### æ­¥éª¤ 1: åœæ­¢æ‰€æœ‰æœåŠ¡å’Œè¿›ç¨‹

```bash
# åœæ­¢ systemd æœåŠ¡
sudo systemctl stop liaotian-frontend
sudo systemctl stop liaotian-backend

# æŸ¥æ‰¾å¹¶åœæ­¢å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹
PORT_3000_PID=$(ss -tlnp | grep :3000 | grep -oP 'pid=\K[0-9]+' | head -1)
if [ -n "$PORT_3000_PID" ]; then
    echo "æ‰¾åˆ°å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹: $PORT_3000_PID"
    sudo kill -9 "$PORT_3000_PID"
fi

# å¼ºåˆ¶åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
sudo pkill -f "next-server" 2>/dev/null || true
sudo pkill -f "node.*next" 2>/dev/null || true
sudo pkill -f "npm start" 2>/dev/null || true
sudo pkill -f "uvicorn" 2>/dev/null || true
sleep 3
```

#### æ­¥éª¤ 2: ä¿®å¤ Systemd æœåŠ¡æ–‡ä»¶

**ä¿®å¤å‰ç«¯æœåŠ¡æ–‡ä»¶ï¼š**

```bash
sudo nano /etc/systemd/system/liaotian-frontend.service
```

ç¡®ä¿ `Restart=always` å’Œ `RestartSec=10` æ˜¯**åˆ†å¼€çš„ä¸¤è¡Œ**ï¼š

```ini
[Unit]
Description=Liaotian Frontend Service (Next.js)
After=network.target liaotian-backend.service
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="PATH=/usr/bin:/bin"
Environment="NODE_ENV=production"
Environment="PORT=3000"
ExecStart=/bin/bash -c "if [ -d /home/ubuntu/liaotian/saas-demo/.next/standalone ]; then cd /home/ubuntu/liaotian/saas-demo/.next/standalone && PORT=3000 /usr/bin/node server.js; else cd /home/ubuntu/liaotian/saas-demo && /usr/bin/npm start; fi"
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=liaotian-frontend

[Install]
WantedBy=multi-user.target
```

**æ³¨æ„**ï¼š`Restart=always` å’Œ `RestartSec=10` å¿…é¡»æ˜¯**ä¸¤è¡Œ**ï¼Œä¸èƒ½å†™åœ¨ä¸€èµ·ï¼

#### æ­¥éª¤ 3: é‡æ–°åŠ è½½ systemd å¹¶å¯åŠ¨æœåŠ¡

```bash
# é‡æ–°åŠ è½½ systemd
sudo systemctl daemon-reload

# éªŒè¯ç«¯å£æ˜¯å¦ç©ºé—²
ss -tlnp | grep :3000
ss -tlnp | grep :8000

# å¯åŠ¨åŽç«¯æœåŠ¡
sudo systemctl start liaotian-backend
sleep 5

# å¯åŠ¨å‰ç«¯æœåŠ¡
sudo systemctl start liaotian-frontend
sleep 5

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status liaotian-backend
sudo systemctl status liaotian-frontend
```

---

## ðŸ” å®Œæ•´çš„ä¿®å¤å‘½ä»¤ï¼ˆä¸€æ¡é¾™ï¼‰

åœ¨æœåŠ¡å™¨ä¸Šç›´æŽ¥æ‰§è¡Œï¼š

```bash
cd ~/liaotian && sudo bash -c '
echo "=== åœæ­¢æ‰€æœ‰æœåŠ¡å’Œè¿›ç¨‹ ==="
systemctl stop liaotian-frontend 2>/dev/null || true
systemctl stop liaotian-backend 2>/dev/null || true

# æŸ¥æ‰¾å¹¶åœæ­¢å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹
PORT_3000_PID=$(ss -tlnp | grep :3000 | grep -oP "pid=\K[0-9]+" | head -1)
if [ -n "$PORT_3000_PID" ]; then
    echo "åœæ­¢å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹: $PORT_3000_PID"
    kill -9 "$PORT_3000_PID" 2>/dev/null || true
fi

pkill -f "next-server" 2>/dev/null || true
pkill -f "node.*next" 2>/dev/null || true
pkill -f "npm start" 2>/dev/null || true
pkill -f "uvicorn" 2>/dev/null || true
sleep 3

echo ""
echo "=== ä¿®å¤ Systemd æœåŠ¡æ–‡ä»¶ ==="

# ä¿®å¤å‰ç«¯æœåŠ¡ï¼ˆç¡®ä¿ Restart é…ç½®æ­£ç¡®ï¼‰
cat > /etc/systemd/system/liaotian-frontend.service << "EOFFRONTEND"
[Unit]
Description=Liaotian Frontend Service (Next.js)
After=network.target liaotian-backend.service
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/saas-demo
Environment="PATH=/usr/bin:/bin"
Environment="NODE_ENV=production"
Environment="PORT=3000"
ExecStart=/bin/bash -c "if [ -d /home/ubuntu/liaotian/saas-demo/.next/standalone ]; then cd /home/ubuntu/liaotian/saas-demo/.next/standalone && PORT=3000 /usr/bin/node server.js; else cd /home/ubuntu/liaotian/saas-demo && /usr/bin/npm start; fi"
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=liaotian-frontend

[Install]
WantedBy=multi-user.target
EOFFRONTEND

# ä¿®å¤åŽç«¯æœåŠ¡
cat > /etc/systemd/system/liaotian-backend.service << "EOFBACKEND"
[Unit]
Description=Liaotian Backend API Service (FastAPI)
After=network.target
Wants=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/liaotian/admin-backend
Environment="PATH=/usr/bin:/bin"
ExecStart=/usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --timeout-keep-alive 120
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=liaotian-backend

[Install]
WantedBy=multi-user.target
EOFBACKEND

echo "âœ… æœåŠ¡æ–‡ä»¶å·²ä¿®å¤"

echo ""
echo "=== é‡æ–°åŠ è½½ systemd ==="
systemctl daemon-reload

echo ""
echo "=== å¯åŠ¨æœåŠ¡ ==="
systemctl start liaotian-backend
sleep 5
systemctl start liaotian-frontend
sleep 5

echo ""
echo "=== éªŒè¯çŠ¶æ€ ==="
systemctl is-active liaotian-backend && echo "âœ… åŽç«¯è¿è¡Œä¸­" || echo "âŒ åŽç«¯æœªè¿è¡Œ"
systemctl is-active liaotian-frontend && echo "âœ… å‰ç«¯è¿è¡Œä¸­" || echo "âŒ å‰ç«¯æœªè¿è¡Œ"

ss -tlnp | grep :3000 && echo "âœ… ç«¯å£ 3000 ç›‘å¬" || echo "âŒ ç«¯å£ 3000 æœªç›‘å¬"
ss -tlnp | grep :8000 && echo "âœ… ç«¯å£ 8000 ç›‘å¬" || echo "âŒ ç«¯å£ 8000 æœªç›‘å¬"

echo ""
echo "âœ… ä¿®å¤å®Œæˆï¼"
'
```

---

## ðŸ” è¯Šæ–­å‘½ä»¤

å¦‚æžœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œæ‰§è¡Œä»¥ä¸‹è¯Šæ–­ï¼š

```bash
# 1. æŸ¥çœ‹å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹
sudo ss -tlnp | grep :3000
sudo lsof -i :3000

# 2. æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u liaotian-frontend -n 50 --no-pager
sudo journalctl -u liaotian-backend -n 50 --no-pager

# 3. æ£€æŸ¥æœåŠ¡æ–‡ä»¶é…ç½®
sudo systemd-analyze verify liaotian-frontend.service
sudo systemd-analyze verify liaotian-backend.service

# 4. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status liaotian-frontend -l
sudo systemctl status liaotian-backend -l
```

---

## ðŸ“ å¸¸è§é—®é¢˜

### Q1: ç«¯å£ä¸€ç›´è¢«å ç”¨æ€Žä¹ˆåŠžï¼Ÿ

**è§£å†³**ï¼š
```bash
# æŸ¥æ‰¾æ‰€æœ‰å ç”¨ç«¯å£ 3000 çš„è¿›ç¨‹
sudo lsof -i :3000

# æˆ–è€…ä½¿ç”¨ ss
sudo ss -tlnp | grep :3000

# å¼ºåˆ¶åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
sudo pkill -9 -f "node.*3000"
sudo pkill -9 -f "next"
```

### Q2: Systemd é…ç½®é”™è¯¯æ€Žä¹ˆæ£€æŸ¥ï¼Ÿ

**è§£å†³**ï¼š
```bash
# éªŒè¯æœåŠ¡æ–‡ä»¶
sudo systemd-analyze verify liaotian-frontend.service

# æ£€æŸ¥è¯­æ³•
sudo systemctl daemon-reload
sudo systemctl status liaotian-frontend
```

### Q3: æœåŠ¡å¯åŠ¨åŽç«‹å³é€€å‡ºï¼Ÿ

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u liaotian-frontend -f

# æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨å‘½ä»¤
cd ~/liaotian/saas-demo
npm start
```

---

## âœ… ä¿®å¤åŽéªŒè¯

ä¿®å¤å®ŒæˆåŽï¼ŒéªŒè¯æ‰€æœ‰æœåŠ¡ï¼š

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status liaotian-frontend
sudo systemctl status liaotian-backend

# æ£€æŸ¥ç«¯å£
ss -tlnp | grep -E ":(3000|8000|80)"

# æµ‹è¯• HTTP
curl http://localhost:8000/health
curl http://localhost:3000
curl http://localhost/health
```

---

**æœ€åŽæ›´æ–°**: 2025-12-07
