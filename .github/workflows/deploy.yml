name: Deploy Full Stack

on:
  push:
    branches:
      - main
    paths:
      - 'saas-demo/**'
      - 'admin-backend/**'
      - 'agent/**'
      - 'aizkw20251219/**'
      - 'hbwy20251220/**'
      - 'tgmini20251220/**'
      - '.github/workflows/deploy.yml'
      - 'scripts/deploy_full.sh'
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'éƒ¨ç½²åç«¯ (admin-backend)'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'éƒ¨ç½²å‰ç«¯ (saas-demo)'
        required: false
        default: true
        type: boolean
      deploy_aizkw:
        description: 'éƒ¨ç½² aizkw é¡¹ç›®åˆ° 3003 ç«¯å£'
        required: false
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: '30m'
          command_timeout: '30m'
          use_insecure_cipher: true
          script_stop: true
          debug: true
          script: |
            set -e
            
            PROJECT_ROOT="/home/ubuntu/telegram-ai-system"
            
            # ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•å­˜åœ¨
            if [ ! -d "$PROJECT_ROOT" ]; then
              echo "âŒ é¡¹ç›®æ ¹ç›®å½•ä¸å­˜åœ¨: $PROJECT_ROOT"
              echo "æ­£åœ¨åˆ›å»ºç›®å½•å¹¶å…‹éš†é¡¹ç›®..."
              mkdir -p "$PROJECT_ROOT"
              cd "$PROJECT_ROOT"
              git clone https://github.com/victor2025PH/liaotianai1201.git . || {
                echo "âŒ Git clone å¤±è´¥"
                exit 1
              }
            fi
            
            # è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
            echo "ğŸ“ è¿›å…¥é¡¹ç›®æ ¹ç›®å½•: $PROJECT_ROOT"
            cd "$PROJECT_ROOT" || {
              echo "âŒ æ— æ³•è¿›å…¥é¡¹ç›®æ ¹ç›®å½•"
              exit 1
            }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            if [ ! -d ".git" ]; then
              echo "âš ï¸  å½“å‰ç›®å½•ä¸æ˜¯ git ä»“åº“ï¼Œåˆå§‹åŒ–..."
              git init || true
              git remote add origin https://github.com/victor2025PH/liaotianai1201.git || true
            fi
            
            git fetch origin main || git fetch origin || true
            git stash || true
            git reset --hard origin/main || {
              echo "âš ï¸  git reset å¤±è´¥ï¼Œå°è¯• git pull..."
              git pull origin main || {
                echo "âš ï¸  Git pull å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
              }
            }
            
            echo "âœ… ä»£ç åŒæ­¥å®Œæˆ"
            echo "æœ€æ–°æäº¤: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            echo ""
            
            # èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
            if [ -f "scripts/deploy_full.sh" ]; then
              chmod +x scripts/deploy_full.sh
              echo "âœ… éƒ¨ç½²è„šæœ¬æƒé™å·²è®¾ç½®"
            else
              echo "âŒ éƒ¨ç½²è„šæœ¬ä¸å­˜åœ¨: scripts/deploy_full.sh"
              exit 1
            fi
            
            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            echo ""
            echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
            echo "=========================================="
            bash scripts/deploy_full.sh
            echo "=========================================="
            echo "âœ… éƒ¨ç½²è„šæœ¬æ‰§è¡Œå®Œæˆ"
