# 剧本加载问题修复报告

## 修复时间
2025-11-21 20:44

## 问题描述
启动账号时出现错误："無法加載劇本: 000新人欢迎剧本"

## 根本原因分析

1. **ScriptParser 不支持字典格式的 scenes**
   - 解析器只支持列表格式：`scenes: [{id: scene1, ...}, {id: scene2, ...}]`
   - 但实际 YAML 文件使用字典格式：`scenes: {scene1: {...}, scene2: {...}}`

2. **ServiceManager 路径解析问题**
   - 只查找当前工作目录下的剧本文件
   - 后端服务从 `admin-backend` 目录启动，无法找到项目根目录的剧本文件

3. **数据库中的 yaml_content 格式错误**
   - 数据库中的剧本内容格式不正确（scenes 是列表格式，但内容不完整）

4. **ServiceManager 缓存问题**
   - 即使提供了新的 yaml_content，仍可能使用缓存的旧版本

## 修复内容

### 1. 修复 ScriptParser 支持字典格式 scenes
**文件**: `group_ai_service/script_parser.py`

**修改内容**:
```python
# 支持兩種格式：列表格式和字典格式
if isinstance(scenes_data, dict):
    # 字典格式：scenes: {scene1: {...}, scene2: {...}}
    for scene_id, scene_data in scenes_data.items():
        if isinstance(scene_data, dict):
            if 'id' not in scene_data:
                scene_data = scene_data.copy()
                scene_data['id'] = scene_id
            scene = self._parse_scene(scene_data)
            scenes[scene.id] = scene
elif isinstance(scenes_data, list):
    # 列表格式：scenes: [{id: scene1, ...}, {id: scene2, ...}]
    for scene_data in scenes_data:
        scene = self._parse_scene(scene_data)
        scenes[scene.id] = scene
```

### 2. 修复 ServiceManager 路径解析
**文件**: `group_ai_service/service_manager.py`

**修改内容**:
- 支持多个路径查找剧本文件：
  - 当前工作目录：`ai_models/group_scripts/{script_id}.yaml`
  - 项目根目录：`Path(__file__).parent.parent / ai_models/group_scripts/{script_id}.yaml`
  - 配置目录：从配置中读取的 `scripts_directory`

### 3. 修复数据库中的 yaml_content
- 使用正确的 YAML 格式更新了数据库中的剧本内容
- 验证显示 scenes 数量从 1 个增加到 4 个

### 4. 修复 ServiceManager 缓存逻辑
**文件**: `group_ai_service/service_manager.py`

**修改内容**:
```python
# 如果提供了新的 yaml_content，清除緩存以確保使用最新內容
if yaml_content:
    self._scripts_cache.pop(script_id, None)
```

## 测试结果

### 测试1: 剧本加载验证
- ✅ 剧本ID: 000新人欢迎剧本
- ✅ YAML格式: 正确（字典格式）
- ✅ YAML长度: 2785 字符

### 测试2: 启动账号
- ✅ **剧本加载问题已修复！**
- 之前的错误: "無法加載劇本: 000新人欢迎剧本"
- 现在的错误: "Telegram 連接失敗（請檢查 session 文件是否有效）"
- **说明**: 剧本加载问题已解决，现在是 Telegram 连接问题（不同的问题）

### 测试3: 账号状态
- ✅ 账号ID: 639641837416
- ✅ 剧本ID: 000新人欢迎剧本（已正确关联）
- ⚠️ 状态: error (Telegram连接失败，这是另一个问题)

### 测试4: 剧本解析功能
- ✅ 剧本解析成功
- ✅ script_id: 000新人欢迎剧本
- ✅ version: 1.1
- ✅ scenes数量: 4
- ✅ scene IDs: ['scene1', 'scene2', 'scene3', 'scene4']

## 修复验证

### 直接测试解析器
```python
# 测试脚本验证
✅ 剧本解析成功:
   script_id: 000新人欢迎剧本
   version: 1.1
   scenes数量: 4
   scene IDs: ['scene1', 'scene2', 'scene3', 'scene4']
```

### API 测试
- ✅ GET `/api/v1/group-ai/scripts/000新人欢迎剧本` - 成功
- ✅ POST `/api/v1/group-ai/accounts/639641837416/start` - 剧本加载成功（现在错误是 Telegram 连接）

## 结论

✅ **剧本加载问题已完全修复**

所有修复都已生效：
1. ScriptParser 现在支持字典格式的 scenes
2. ServiceManager 可以从多个路径查找剧本文件
3. 数据库中的 yaml_content 已更新为正确格式
4. ServiceManager 缓存逻辑已修复

**当前状态**: 剧本加载功能正常工作。启动账号时的错误现在是 Telegram 连接问题（session 文件不存在或无效），这是另一个独立的问题，不影响剧本加载功能。

## 后续建议

1. ✅ 剧本加载问题 - 已修复
2. ⚠️ Telegram 连接问题 - 需要检查 session 文件是否存在和有效
3. ⚠️ 如果 session 文件不存在，需要先创建或导入有效的 session 文件

