# 502 错误 - 立即修复指南

## 当前问题

- 浏览器显示 **502 Bad Gateway**
- 后端服务无法启动（curl 连接失败）
- 日志文件可能为空或不存在

## 立即执行的命令

### 在服务器上执行以下命令：

#### 1. 查看当前状态

```bash
# 检查进程
ps aux | grep uvicorn | grep -v grep

# 查看日志
tail -100 /tmp/backend_final.log 2>&1

# 检查端口
sudo ss -tlnp | grep 8000
```

#### 2. 清理并重新启动

```bash
cd ~/liaotian/admin-backend

# 清理旧进程
pkill -9 -f 'uvicorn.*app.main:app'
pkill -9 -f 'python.*uvicorn'
sudo lsof -ti:8000 | xargs kill -9 2>/dev/null || true
sleep 2

# 激活虚拟环境
source .venv/bin/activate

# 检查Python和uvicorn
python3 --version
which uvicorn

# 测试模块导入（查看错误）
python3 -c "from app.main import app; print('OK')" 2>&1
```

#### 3. 前台启动（查看实时错误）

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate

# 前台启动，观察错误输出
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

**注意**：前台启动会显示实时错误信息。按 `Ctrl+C` 停止。

#### 4. 后台启动（如果前台启动成功）

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate

# 后台启动
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &

# 等待5秒
sleep 5

# 检查健康状态
curl http://localhost:8000/health

# 如果失败，查看日志
tail -50 /tmp/backend_final.log
```

## 常见错误和解决方案

### 错误1：ModuleNotFoundError

**症状**：导入模块时出错

**解决**：
```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
pip install -r requirements.txt
```

### 错误2：端口被占用

**症状**：`Address already in use`

**解决**：
```bash
sudo lsof -ti:8000 | xargs kill -9
# 或
pkill -9 -f uvicorn
```

### 错误3：虚拟环境不存在

**症状**：`bash: .venv/bin/activate: No such file or directory`

**解决**：
```bash
cd ~/liaotian/admin-backend
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### 错误4：uvicorn 未安装

**症状**：`command not found: uvicorn`

**解决**：
```bash
source .venv/bin/activate
pip install uvicorn[standard]
```

### 错误5：启动后立即退出

**症状**：进程启动后立即消失

**解决**：
1. 前台启动查看错误：`uvicorn app.main:app --host 0.0.0.0 --port 8000`
2. 查看日志：`tail -100 /tmp/backend_final.log`
3. 检查 Python 导入错误

## 一键修复脚本

如果手动执行太复杂，使用脚本：

```bash
# 方法1：诊断问题
bash ~/liaotian/deploy/诊断后端启动失败.sh

# 方法2：自动修复并启动
bash ~/liaotian/deploy/修复并启动后端.sh
```

## 验证修复

启动成功后，验证：

```bash
# 1. 检查进程
ps aux | grep uvicorn | grep -v grep

# 2. 检查端口
sudo ss -tlnp | grep 8000

# 3. 健康检查
curl http://localhost:8000/health

# 应该返回: {"status":"ok"} 或类似
```

## 启动前端服务

后端修复后，启动前端：

```bash
cd ~/liaotian/saas-demo

# 清理旧进程
pkill -f 'next.*dev|node.*3000' || true
sleep 2

# 启动前端
nohup npm run dev > /tmp/frontend.log 2>&1 &

# 等待启动
sleep 15

# 验证
curl http://localhost:3000
```

## 完整启动流程

```bash
# 1. 清理所有旧进程
pkill -9 -f uvicorn
pkill -9 -f 'next.*dev'

# 2. 启动后端
cd ~/liaotian/admin-backend
source .venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 &
sleep 5
curl http://localhost:8000/health

# 3. 启动前端
cd ~/liaotian/saas-demo
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15
curl http://localhost:3000

# 4. 检查浏览器
# 访问: http://aikz.usdt2026.cc/group-ai/accounts
```

## 日志文件

- **后端日志**: `/tmp/backend_final.log`
- **前端日志**: `/tmp/frontend.log`

## 如果仍然失败

1. **查看完整日志**：
   ```bash
   tail -200 /tmp/backend_final.log
   ```

2. **前台启动查看错误**：
   ```bash
   cd ~/liaotian/admin-backend
   source .venv/bin/activate
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

3. **检查 Python 环境**：
   ```bash
   python3 --version
   which python3
   pip list | grep uvicorn
   ```

4. **检查代码**：
   ```bash
   cd ~/liaotian/admin-backend
   python3 -c "from app.main import app; print('OK')"
   ```

---

**请在服务器上执行上述命令，然后告诉我看到的错误信息！**
