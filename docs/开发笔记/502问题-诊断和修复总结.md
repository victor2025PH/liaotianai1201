# 502问题 - 诊断和修复总结

## 问题现象

- `curl -I http://localhost:3000` 返回 "Connection refused"
- `curl -I http://aikz.usdt2026.cc/group-ai/accounts` 返回 502 Bad Gateway
- 说明：前端服务没有在3000端口运行

## 诊断步骤

### 1. 检查前端服务状态

```bash
cd ~/liaotian/saas-demo
ps aux | grep -E 'next.*dev|node.*3000' | grep -v grep
sudo ss -tlnp | grep 3000
```

### 2. 查看前端日志

```bash
tail -100 /tmp/frontend.log
```

### 3. 检查配置和环境

```bash
cd ~/liaotian/saas-demo
grep '"dev"' package.json
node -v
npm -v
ls -d node_modules/.bin/next
```

### 4. 前台运行捕获错误

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
npm run dev
```

观察输出，如果进程退出，查看错误信息。

## 常见错误原因和修复

### 错误1: 缺少依赖模块

**错误信息**: `Cannot find module` 或 `Module not found`

**原因**: node_modules不存在或损坏

**修复**:
```bash
cd ~/liaotian/saas-demo
npm install
```

### 错误2: 端口被占用

**错误信息**: `Port 3000 is already in use` 或 `EADDRINUSE`

**原因**: 端口3000被其他进程占用

**修复**:
```bash
# 查找占用端口的进程
sudo lsof -ti:3000
# 或者
sudo ss -tlnp | grep 3000

# 停止进程
pkill -f "next.*dev|node.*3000"
# 或者强制杀死
sudo kill -9 $(sudo lsof -ti:3000)
```

### 错误3: 端口配置错误

**错误信息**: 服务在错误的端口运行

**原因**: package.json中dev脚本端口不是3000

**修复**:
```bash
cd ~/liaotian/saas-demo
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.scripts.dev = 'next dev -p 3000';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n', 'utf8');
"
```

### 错误4: 代码语法错误

**错误信息**: `SyntaxError` 或 `Parse error`

**原因**: 代码有语法错误

**修复**: 查看具体错误信息，修复对应的代码文件

### 错误5: 环境变量缺失

**错误信息**: `Environment variable not found`

**原因**: 缺少必要的环境变量

**修复**: 检查并设置环境变量文件（.env.local等）

## 完整修复流程

### 步骤1: 诊断

```bash
cd ~/liaotian/saas-demo

# 检查进程
ps aux | grep -E 'next.*dev|node.*3000' | grep -v grep

# 检查端口
sudo ss -tlnp | grep 3000

# 查看日志
tail -100 /tmp/frontend.log

# 检查配置
grep '"dev"' package.json
```

### 步骤2: 修复

```bash
cd ~/liaotian/saas-demo

# 停止旧进程
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 安装依赖（如果需要）
if [ ! -d node_modules ] || [ ! -f node_modules/.bin/next ]; then
    npm install
fi

# 修复端口配置（如果需要）
# 使用上面的node命令修复package.json
```

### 步骤3: 测试

```bash
cd ~/liaotian/saas-demo

# 前台运行测试
npm run dev
```

观察输出，确认看到 "Ready on http://localhost:3000"

### 步骤4: 后台启动

```bash
cd ~/liaotian/saas-demo

# 停止前台进程（Ctrl+C）
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 后台启动
nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15

# 验证
curl -I http://localhost:3000
```

应该返回 HTTP 200 或 304

### 步骤5: 重载Nginx并验证

```bash
# 重载Nginx
sudo systemctl reload nginx
sleep 3

# 验证域名访问
curl -I http://aikz.usdt2026.cc/group-ai/accounts
curl -I http://aikz.usdt2026.cc/
```

应该返回 HTTP 200、302 或 304，不再是 502

## 一键修复脚本

已创建自动化脚本：

```bash
bash ~/liaotian/deploy/彻底诊断并修复502.sh
```

或使用分步诊断脚本：

```bash
bash ~/liaotian/deploy/诊断502-分步执行.sh
# 然后查看结果
cat /tmp/diagnose_step1.txt
cat /tmp/diagnose_step2.txt
cat /tmp/diagnose_step3.txt
cat /tmp/diagnose_step4.txt
cat /tmp/diagnose_step5.txt
```

## 从零启动服务的命令

```bash
#!/bin/bash
# 在远程服务器 ubuntu@165.154.233.55 上执行

# 1. 启动后端
cd ~/liaotian/admin-backend
source .venv/bin/activate
pkill -f "uvicorn.*app.main:app" || true
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5

# 2. 启动前端
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 确保依赖已安装
if [ ! -d node_modules ] || [ ! -f node_modules/.bin/next ]; then
    npm install
fi

nohup npm run dev > /tmp/frontend.log 2>&1 &
sleep 15

# 3. 重载Nginx
sudo systemctl reload nginx

# 4. 验证
echo "后端:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:8000/health

echo "前端:"
curl -s -o /dev/null -w '%{http_code}\n' http://localhost:3000

echo "域名:"
curl -s -o /dev/null -w '%{http_code}\n' http://aikz.usdt2026.cc/group-ai/accounts
```

---

**重要**: 所有命令都在远程服务器上执行！
