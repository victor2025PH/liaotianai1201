# 帳號配置與資料管理功能實現記錄

**日期**: 2025-01-17  
**功能**: 帳號配置（關聯服務器、劇本）、帳號資料信息管理（頭像、用戶名等）

## 功能概述

實現了以下功能：
1. **帳號資料信息管理**：從 Telegram session 文件自動讀取帳號資料信息（頭像、用戶名、手機號等）
2. **帳號與服務器關聯**：支持將帳號分配到不同的服務器節點
3. **帳號與劇本關聯**：支持為帳號配置不同的劇本進行演繹
4. **帳號資料編輯**：支持在後台編輯帳號的顯示名稱和個人簡介

## 實現內容

### 1. 數據庫模型擴展

**文件**: `admin-backend/app/models/group_ai.py`

在 `GroupAIAccount` 模型中添加了以下字段：

- **服務器關聯**：
  - `server_id`: 關聯的服務器ID

- **帳號資料信息**：
  - `phone_number`: 手機號
  - `username`: Telegram用戶名
  - `first_name`: 名字
  - `last_name`: 姓氏
  - `display_name`: 顯示名稱（可編輯）
  - `avatar_url`: 頭像URL
  - `bio`: 個人簡介（可編輯）
  - `user_id`: Telegram用戶ID

### 2. 數據庫遷移

**文件**: `admin-backend/alembic/versions/ea5d525f9c2a_add_account_profile_and_server_fields.py`

創建了數據庫遷移文件，添加了新字段和索引：
- 添加 `server_id` 字段和索引
- 添加帳號資料信息字段（`phone_number`, `username`, `first_name`, `last_name`, `display_name`, `avatar_url`, `bio`, `user_id`）
- 添加 `user_id` 索引

**運行遷移**:
```bash
cd admin-backend
alembic upgrade head
```

### 3. Telegram 資料信息獲取工具

**文件**: `admin-backend/app/utils/telegram_profile.py`

創建了工具函數 `get_telegram_profile()`，從 session 文件讀取 Telegram 帳號資料信息：

- 使用 Pyrogram 連接 Telegram API
- 獲取帳號基本信息（手機號、用戶名、名字等）
- 獲取帳號頭像（下載到本地或保存文件ID）
- 獲取帳號個人簡介

**特點**：
- 異步支持
- 錯誤處理和日誌記錄
- 支持同步版本（`get_telegram_profile_sync()`）

### 4. API 更新

**文件**: `admin-backend/app/api/group_ai/accounts.py`

#### 4.1 請求/響應模型更新

**`AccountUpdateRequest`**:
- 添加 `server_id`: 服務器ID
- 添加 `display_name`: 顯示名稱（可編輯）
- 添加 `bio`: 個人簡介（可編輯）

**`AccountResponse`**:
- 添加 `server_id`: 關聯的服務器ID
- 添加所有帳號資料信息字段（`phone_number`, `username`, `first_name`, `last_name`, `display_name`, `avatar_url`, `bio`, `user_id`）

#### 4.2 創建帳號 API (`POST /api/v1/group-ai/accounts/`)

**新增功能**：
1. 自動獲取帳號資料信息：
   - 創建帳號時自動從 session 文件讀取 Telegram 資料信息
   - 保存到數據庫

2. 自動分配服務器：
   - 如果配置了遠程服務器，自動分配帳號到最適合的服務器
   - 保存服務器ID到數據庫

3. 數據庫記錄：
   - 創建帳號時同步創建數據庫記錄
   - 保存配置和資料信息

#### 4.3 更新帳號 API (`PUT /api/v1/group-ai/accounts/{account_id}`)

**新增功能**：
1. 更新配置：
   - 支持更新 `script_id`（劇本）
   - 支持更新 `server_id`（服務器）
   - 支持更新其他配置參數

2. 更新資料信息：
   - 支持更新 `display_name`（顯示名稱）
   - 支持更新 `bio`（個人簡介）

3. 數據庫同步：
   - 更新配置時同步更新數據庫記錄

#### 4.4 列出帳號 API (`GET /api/v1/group-ai/accounts/`)

**新增功能**：
- 從數據庫讀取帳號資料信息並返回
- 返回完整的帳號信息，包括資料和配置

## API 使用示例

### 創建帳號（自動獲取資料信息）

```bash
POST /api/v1/group-ai/accounts/
{
  "account_id": "account-001",
  "session_file": "sessions/123456789.session",
  "script_id": "script-001",
  "group_ids": [123456789, 987654321]
}
```

**響應**:
```json
{
  "account_id": "account-001",
  "session_file": "sessions/123456789.session",
  "script_id": "script-001",
  "server_id": "worker-01",
  "status": "offline",
  "group_count": 2,
  "message_count": 0,
  "reply_count": 0,
  "last_activity": null,
  "phone_number": "+1234567890",
  "username": "username",
  "first_name": "First",
  "last_name": "Last",
  "display_name": "First",
  "avatar_url": "avatars/123456789.jpg",
  "bio": "Personal bio",
  "user_id": 123456789
}
```

### 更新帳號配置

```bash
PUT /api/v1/group-ai/accounts/account-001
{
  "script_id": "script-002",
  "server_id": "worker-02",
  "display_name": "Custom Display Name",
  "bio": "Updated bio"
}
```

### 列出帳號

```bash
GET /api/v1/group-ai/accounts/?page=1&page_size=20
```

## 後續工作

### 前端實現（待完成）

1. **帳號列表頁面**：
   - 顯示帳號頭像
   - 顯示帳號用戶名和顯示名稱
   - 顯示關聯的劇本和服務器

2. **帳號編輯功能**：
   - 編輯顯示名稱
   - 編輯個人簡介
   - 選擇劇本
   - 選擇服務器

3. **帳號詳情頁面**：
   - 顯示完整資料信息
   - 顯示配置信息
   - 支持編輯和更新

### 數據庫遷移

**重要**：在部署前需要運行數據庫遷移：

```bash
cd admin-backend
alembic upgrade head
```

## 注意事項

1. **Pyrogram 依賴**：
   - 需要安裝 `pyrogram` 庫才能獲取帳號資料信息
   - 如果未安裝，會跳過資料信息獲取但不影響帳號創建

2. **API ID 和 Hash**：
   - 需要配置 `API_ID` 和 `API_HASH` 環境變量
   - 用於連接 Telegram API 獲取資料信息

3. **頭像存儲**：
   - 目前頭像下載到本地 `avatars/` 目錄
   - 生產環境建議使用對象存儲（如 S3）或 CDN

4. **性能考慮**：
   - 獲取資料信息可能需要幾秒鐘
   - 創建帳號時會異步獲取，不阻塞帳號創建流程

5. **錯誤處理**：
   - 如果獲取資料信息失敗，會記錄警告但不影響帳號創建
   - 可以稍後手動更新資料信息

## 測試建議

1. **單元測試**：
   - 測試 `get_telegram_profile()` 函數
   - 測試 API 端點

2. **集成測試**：
   - 測試創建帳號並獲取資料信息
   - 測試更新帳號配置和資料信息
   - 測試服務器自動分配

3. **手動測試**：
   - 使用真實 session 文件測試資料信息獲取
   - 測試帳號與劇本、服務器的關聯配置

