# 分配剧本完整修复方案

## 问题总结

用户在分配剧本时遇到 "账号不存在" 错误，虽然账号在节点管理和账号管理页面都可见。

## 根本原因

1. Worker 节点账号存在远程服务器上，但不在中央数据库
2. 分配剧本时，后端需要从远程服务器扫描并创建数据库记录
3. 前端可能没有正确传递 `server_id` 或 `node_id`
4. `session_file` 可能为空字符串，导致后端无法识别

## 完整修复方案

### 1. 前端修复

#### 1.1 增强 server_id 传递逻辑

```typescript
// 确保传递 server_id（优先使用 server_id，如果没有则使用 node_id）
const serverId = selectedAccountForRole.server_id || (selectedAccountForRole as any).node_id || undefined
console.log(`[分配剧本] 账号: ${selectedAccountForRole.account_id}, server_id: ${selectedAccountForRole.server_id}, node_id: ${(selectedAccountForRole as any).node_id}, 最终serverId: ${serverId}`)

await updateAccount(selectedAccountForRole.account_id, {
  script_id: formData.script_id,
  session_file: selectedAccountForRole.session_file || undefined,  // 如果是空字符串，传递 undefined
  server_id: serverId,  // 传递 server_id 或 node_id 以便从远程服务器创建记录
})
```

**改进点**：
- 添加调试日志，便于排查问题
- 将空字符串转换为 undefined，避免后端处理问题
- 明确使用 serverId 变量，确保逻辑清晰

#### 1.2 API 类型定义

在 `saas-demo/src/lib/api/group-ai.ts` 中添加 `session_file` 字段：

```typescript
export async function updateAccount(
  accountId: string,
  request: {
    script_id?: string
    server_id?: string
    session_file?: string  // Session文件路徑（用於從遠程服務器創建記錄）
    // ... 其他字段
  }
): Promise<Account>
```

### 2. 后端修复

#### 2.1 增强 update_account 函数

后端已添加完整的逻辑：

1. **检查 AccountManager**：先检查账号是否在内存中
2. **检查数据库**：如果不在内存中，检查数据库
3. **远程服务器扫描**：如果不在数据库中，但有 `server_id`，则扫描远程服务器
4. **创建数据库记录**：如果找到账号，创建数据库记录
5. **详细日志**：记录每个步骤的执行情况

关键代码：

```python
if request.server_id:
    logger.info(f"賬號 {account_id} 不在數據庫中，嘗試從遠程服務器 {request.server_id} 掃描並創建記錄")
    logger.info(f"接收到的 server_id: {request.server_id}, 類型: {type(request.server_id)}")
    
    uploader = SessionUploader()
    logger.info(f"SessionUploader 中的服務器列表: {list(uploader.servers.keys())}")
    
    if request.server_id in uploader.servers:
        server_node = uploader.servers[request.server_id]
        server_accounts = scan_server_accounts(server_node, db)
        server_account = next((acc for acc in server_accounts if acc.account_id == account_id), None)
        
        if server_account:
            # 创建数据库记录
            ...
```

#### 2.2 添加 session_file 字段支持

在 `AccountUpdateRequest` 中添加：

```python
session_file: Optional[str] = None  # Session文件路徑（用於從遠程服務器創建記錄）
```

### 3. Worker 账号数据结构

Worker 账号在创建时已包含必要的字段：

```typescript
{
  account_id: account_id,
  server_id: nodeId,        // 服务器ID
  node_id: nodeId,          // 节点ID（备用）
  session_file: "",         // Worker账号的session文件在节点上
  source: 'worker' as const
}
```

## 测试步骤

### 1. 查看浏览器控制台

分配剧本时，查看浏览器控制台，应该看到：
```
[分配剧本] 账号: 639277358115, server_id: computer_001, node_id: computer_001, 最终serverId: computer_001
```

### 2. 查看后端日志

```bash
tail -f /tmp/backend_full_debug.log | grep -E "收到更新賬號請求|639277358115|server_id|不存在"
```

应该看到：
- 接收到的请求详情
- server_id 的值
- 服务器列表
- 扫描结果

### 3. 验证流程

1. 选择 Worker 节点账号（如 Eve, 639277358115）
2. 点击"分配剧本"
3. 选择剧本和角色
4. 点击"分配剧本"按钮
5. 应该成功创建数据库记录并分配剧本

## 问题排查

### 问题1：server_id 为 undefined

**症状**：浏览器控制台显示 `最终serverId: undefined`

**解决方案**：
- 检查 Worker 账号对象是否包含 `server_id` 或 `node_id` 字段
- 检查账号数据结构

### 问题2：服务器不存在

**症状**：后端日志显示"服务器 {server_id} 不存在"

**解决方案**：
- 检查 `data/master_config.json` 中的服务器配置
- 确认服务器键名与传递的值一致

### 问题3：账号不在服务器上

**症状**：后端日志显示"账号不存在於服務器上"

**解决方案**：
- 检查 SSH 连接配置
- 手动验证账号是否在服务器上
- 检查 session 文件路径

## 状态

✅ 前端代码已修复（添加调试日志和更好的 server_id 处理）  
✅ 后端代码已完整（包含远程扫描逻辑）  
✅ API 类型定义已更新  
✅ 服务已重启  
⏳ 等待测试验证
