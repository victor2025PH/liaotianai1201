# 502 Bad Gateway 修复 - 工程师总结报告

> **修复日期**: 2025-01-28  
> **修复工程师**: 前端自愈系统  
> **访问地址**: http://aikz.usdt2026.cc/group-ai/accounts

---

## 🔍 502 根本原因

### 核心问题

1. **端口配置不匹配** ⭐ 主要原因
   - `package.json` 中 `dev` 脚本配置为端口 `3001`
   - Nginx 反向代理配置期望端口 `3000`
   - 导致前端服务启动在 3001 端口，而 Nginx 尝试连接 3000 端口，连接失败返回 502

2. **前端服务可能未正常运行**
   - 服务可能启动失败
   - 或者进程异常退出

3. **进程和端口冲突**
   - 可能有旧的进程残留
   - 端口被占用

---

## ✅ 修改的文件和改动点

### 1. 项目代码修改

#### `saas-demo/package.json`
**文件路径**: `saas-demo/package.json`  
**修改位置**: 第 6 行，`scripts.dev`

**修改前**:
```json
"dev": "next dev -p 3001",
```

**修改后**:
```json
"dev": "next dev -p 3000",
```

**原因**: 确保前端服务启动在端口 3000，与 Nginx 配置中的 `proxy_pass http://127.0.0.1:3000` 匹配。

### 2. Nginx 配置检查

**文件**: `/etc/nginx/sites-enabled/default`

**检查结果**:
- ✅ `location /` 的 `proxy_pass` 已正确指向 `http://127.0.0.1:3000`
- ✅ 配置结构正确，无需修改
- ✅ 只需确保前端服务运行在 3000 端口即可

**说明**: Nginx 配置中 `location /` 会代理所有请求（包括 `/group-ai/accounts`）到 Next.js 前端服务，Next.js 会自动处理路由。

---

## 🚀 从零启动前端服务的推荐命令清单

### 方法 1: 使用一键修复脚本（最简单 ⭐ 推荐）

```bash
cd ~/liaotian/saas-demo
git pull origin master
chmod +x 一键修复502.sh
bash 一键修复502.sh
```

### 方法 2: 完整手动启动流程（标准流程）

```bash
# 1. 进入项目目录
cd ~/liaotian/saas-demo

# 2. 更新代码（确保有最新的修复）
git pull origin master

# 3. 验证端口配置（应该是 3000）
grep '"dev"' package.json

# 4. 安装依赖（首次或依赖变更后）
npm install

# 5. 停止并清理旧进程
pkill -f "next.*dev|node.*3000" || true
sleep 2

# 清理端口冲突（如果有）
sudo lsof -i :3000 | grep LISTEN | awk '{print $2}' | xargs kill -9 2>/dev/null || true
sleep 2

# 6. 启动前端开发服务器
npm run dev > /tmp/frontend.log 2>&1 &

# 7. 等待服务启动（Next.js 通常需要 20-45 秒）
sleep 45

# 8. 验证服务是否正常运行
curl -I http://localhost:3000

# 9. 重新加载 Nginx 配置（如果修改过）
sudo systemctl reload nginx

# 10. 验证域名访问
curl -I http://aikz.usdt2026.cc/group-ai/accounts
```

### 方法 3: 快速启动（依赖已安装，仅重启服务）

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
npm run dev > /tmp/frontend.log 2>&1 &
sleep 45 && curl http://localhost:3000 && sudo systemctl reload nginx
```

### 方法 4: 服务器重启后的启动流程

```bash
# 服务器重启后，后端和前端都需要重新启动
# 1. 启动后端服务
cd ~/liaotian/admin-backend
source .venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &

# 2. 启动前端服务
cd ~/liaotian/saas-demo
npm run dev > /tmp/frontend.log 2>&1 &

# 3. 等待服务启动
sleep 60

# 4. 验证服务
curl http://localhost:8000/health
curl http://localhost:3000

# 5. 重载 Nginx
sudo systemctl reload nginx
```

---

## 📋 创建的修复脚本

已创建以下修复脚本（都在 `saas-demo/` 目录下）：

1. **`一键修复502.sh`** ⭐ 推荐使用
   - 最简单的修复脚本
   - 自动执行所有修复步骤

2. **`最终修复502-完整版.sh`**
   - 完整的修复流程
   - 包含详细的日志记录

3. **`直接修复502.sh`**
   - 直接修复脚本

4. **`完整502修复流程.sh`**
   - 完整的修复流程

5. **`分步执行修复.sh`**
   - 分步执行，清晰输出

---

## ✅ 验证修复成功

修复成功后，应该满足以下条件：

1. ✅ `package.json` 中 `dev` 脚本为 `next dev -p 3000`
2. ✅ 前端进程正在运行（`ps aux | grep "next.*dev"`）
3. ✅ 端口 3000 正在监听（`sudo netstat -tlnp | grep 3000`）
4. ✅ `curl http://localhost:3000` 返回 HTTP 200
5. ✅ `curl http://localhost/group-ai/accounts` 返回 HTTP 200 或 3xx
6. ✅ `curl http://aikz.usdt2026.cc/group-ai/accounts` 返回 HTTP 200 或 3xx
7. ✅ 浏览器访问不再显示 502 错误，页面正常加载

---

## 📝 修复流程总结

### 执行的修复步骤

1. ✅ **诊断问题**: 确认是端口配置不匹配导致的问题
2. ✅ **修复端口配置**: 将 `package.json` 中的端口从 3001 改为 3000
3. ✅ **检查 Nginx 配置**: 确认 Nginx 配置正确，无需修改
4. ✅ **创建修复脚本**: 创建多个自动修复脚本
5. ✅ **执行修复**: 在服务器上执行修复脚本
6. ✅ **验证修复**: 检查服务状态和访问状态

### 修改的文件

- **项目代码**: `saas-demo/package.json` (端口配置修复)
- **Nginx 配置**: 无需修改（配置已正确）

### 创建的脚本

- 5 个自动修复脚本
- 3 个修复文档

---

## 🔄 以后服务器重启后的启动命令

### 完整启动流程（后端 + 前端）

```bash
# === 启动后端服务 ===
cd ~/liaotian/admin-backend
source .venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &
sleep 5

# === 启动前端服务 ===
cd ~/liaotian/saas-demo
npm run dev > /tmp/frontend.log 2>&1 &
sleep 45

# === 验证服务 ===
curl http://localhost:8000/health
curl http://localhost:3000

# === 重载 Nginx ===
sudo systemctl reload nginx

# === 验证域名访问 ===
curl -I http://aikz.usdt2026.cc/group-ai/accounts
```

### 仅重启前端服务

```bash
cd ~/liaotian/saas-demo
pkill -f "next.*dev|node.*3000" || true
npm run dev > /tmp/frontend.log 2>&1 &
sleep 45 && curl http://localhost:3000 && sudo systemctl reload nginx
```

---

## ✅ 修复完成

- ✅ 端口配置已修复（3001 → 3000）
- ✅ 自动修复脚本已创建并执行
- ✅ Nginx 配置已验证（无需修改）
- ✅ 修复文档已完善
- ✅ 所有修改已提交到 Git 仓库

**前端服务现在应该可以在端口 3000 正常启动，并通过 Nginx 代理正常访问了！**

---

**修复工程师**: 前端自愈系统  
**修复完成时间**: 2025-01-28
