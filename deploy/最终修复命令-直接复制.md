# 最终修复命令 - 直接复制执行

## 问题

从日志可以看到：
- `Error: Cannot find module '/home/ubuntu/liaotian/saas-demo/server.js'`
- `WorkingDirectory=/home/ubuntu/liaotian/saas-demo` - **这是错误的！**

## 请在服务器上执行以下命令

```bash
cd /home/ubuntu/liaotian/saas-demo

# 1. 查找standalone目录
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
FULL_STANDALONE_DIR="/home/ubuntu/liaotian/saas-demo/$STANDALONE_DIR"
echo "Standalone目录: $FULL_STANDALONE_DIR"

# 2. 停止服务
sudo systemctl stop liaotian-frontend

# 3. 检查当前配置
echo "当前配置:"
cat /etc/systemd/system/liaotian-frontend.service | grep -E "WorkingDirectory|ExecStart"

# 4. 更新WorkingDirectory（重要！）
sudo sed -i "s|WorkingDirectory=.*|WorkingDirectory=$FULL_STANDALONE_DIR|" /etc/systemd/system/liaotian-frontend.service

# 5. 验证配置已更新
echo "更新后的配置:"
cat /etc/systemd/system/liaotian-frontend.service | grep -E "WorkingDirectory|ExecStart"

# 6. 验证server.js存在
ls -la "$FULL_STANDALONE_DIR/server.js"

# 7. 重新加载并启动
sudo systemctl daemon-reload
sudo systemctl start liaotian-frontend
sleep 5

# 8. 检查服务状态
sudo systemctl status liaotian-frontend --no-pager | head -20

# 9. 检查端口监听
ss -tlnp | grep ':3000'

# 10. 如果仍有错误，查看日志
sudo journalctl -u liaotian-frontend -n 20 --no-pager | tail -10
```

## 预期结果

### 成功的情况：
1. ✅ `WorkingDirectory=/home/ubuntu/liaotian/saas-demo/.next/standalone/liaotian/saas-demo`
2. ✅ `ExecStart=/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node server.js`
3. ✅ `server.js` 文件存在
4. ✅ 服务状态：`Active: active (running)`
5. ✅ 端口3000被监听

### 如果sed命令没有生效

可以手动编辑配置文件：

```bash
# 查找standalone目录
STANDALONE_DIR=$(find /home/ubuntu/liaotian/saas-demo/.next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
FULL_STANDALONE_DIR="/home/ubuntu/liaotian/saas-demo/$STANDALONE_DIR"
echo "Standalone目录: $FULL_STANDALONE_DIR"

# 备份配置
sudo cp /etc/systemd/system/liaotian-frontend.service /etc/systemd/system/liaotian-frontend.service.bak

# 手动创建新配置
sudo tee /etc/systemd/system/liaotian-frontend.service > /dev/null <<EOF
[Unit]
Description=Liaotian Frontend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=$FULL_STANDALONE_DIR
Environment=PORT=3000
Environment="NVM_DIR=\$HOME/.nvm"
Environment="PATH=\$HOME/.nvm/versions/node/v20.19.6/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node server.js
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# 重新加载并启动
sudo systemctl daemon-reload
sudo systemctl start liaotian-frontend
sleep 5
sudo systemctl status liaotian-frontend --no-pager | head -20
```

## 验证修复成功

修复成功后：
1. ✅ 服务状态为 `active (running)`
2. ✅ 端口3000被监听
3. ✅ 页面不再显示502错误
4. ✅ 浏览器可以正常访问

