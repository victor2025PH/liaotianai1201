# API 404 错误排查指南

## 问题描述

前端页面显示多个 API 端点返回 404 错误：
- `/api/v1/dashboard`
- `/api/v1/users/me`
- `/api/v1/notifications?skip=0&limit=20`
- `/api/v1/sessions?page=1&page_size=10`

## 快速诊断命令

在服务器上执行以下命令：

```bash
# 1. 检查后端服务状态
sudo systemctl status liaotian-backend

# 2. 检查后端是否监听端口 8000
sudo ss -tlnp | grep :8000

# 3. 测试后端 API（直接访问）
curl http://localhost:8000/health
curl http://localhost:8000/api/v1/dashboard

# 4. 测试通过 Nginx 访问
curl http://localhost/api/v1/health

# 5. 检查后端日志
sudo journalctl -u liaotian-backend -n 50

# 6. 检查 Nginx 错误日志
sudo tail -20 /var/log/nginx/error.log
```

## 可能的原因和解决方案

### 1. 后端服务未运行

**检查：**
```bash
sudo systemctl status liaotian-backend
```

**解决：**
```bash
# 启动服务
sudo systemctl start liaotian-backend

# 如果启动失败，查看日志
sudo journalctl -u liaotian-backend -n 100
```

### 2. 后端服务崩溃

**检查：**
```bash
# 查看进程
ps aux | grep -E 'uvicorn|python.*main.py'

# 查看崩溃日志
sudo journalctl -u liaotian-backend -n 100 | grep -i error
```

**解决：**
```bash
# 重启服务
sudo systemctl restart liaotian-backend

# 查看启动日志
sudo journalctl -u liaotian-backend -f
```

### 3. Nginx API 路由配置问题

**检查：**
```bash
sudo grep -A 10 'location /api/' /etc/nginx/sites-available/aikz.usdt2026.cc
```

**应该看到类似：**
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8000/api/;
    ...
}
```

**如果配置有问题，修复：**
```bash
sudo nano /etc/nginx/sites-available/aikz.usdt2026.cc
# 确保有 location /api/ 配置
# 然后重载
sudo nginx -t && sudo systemctl reload nginx
```

### 4. 后端服务监听地址错误

**检查后端配置：**
```bash
# 查看后端服务配置
sudo systemctl cat liaotian-backend | grep -A 5 ExecStart
```

**应该监听：**
- `0.0.0.0:8000` 或 `127.0.0.1:8000`

### 5. 端口被占用或防火墙问题

**检查：**
```bash
# 检查端口占用
sudo lsof -i :8000
sudo netstat -tlnp | grep :8000
```

## 快速修复命令

如果后端服务未运行：

```bash
# 重启后端服务
sudo systemctl restart liaotian-backend

# 等待几秒后检查状态
sleep 3
sudo systemctl status liaotian-backend

# 测试 API
curl http://localhost:8000/health
```

如果 Nginx 配置有问题：

```bash
# 检查配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

## 验证修复

修复后，执行：

```bash
# 1. 测试后端 API
curl http://localhost:8000/api/v1/dashboard

# 2. 测试通过 Nginx
curl http://localhost/api/v1/dashboard

# 3. 在前端浏览器中刷新页面
# 应该不再看到 404 错误
```

## 完整诊断脚本

执行 `deploy/快速诊断API404.sh` 进行完整诊断。

