# 账号管理和去重功能开发完成报告

> **开发日期**: 2025-01-20  
> **状态**: ✅ 功能开发完成

---

## 功能总结

已实现完整的账号管理和去重功能，包括：

1. ✅ **服务器账号扫描** - 扫描远程服务器上的账号文件
2. ✅ **账号去重验证** - 对比本地数据库和服务器账号，找出重复账号
3. ✅ **删除服务器账号** - 支持单个和批量删除服务器上的账号文件
4. ✅ **显示现有账号** - 列出所有账号（本地+服务器）
5. ✅ **自动分配和手动分配** - 完善分配功能

---

## 新增API接口

### 1. 扫描服务器账号

**接口**: `GET /api/v1/group-ai/account-management/scan-server-accounts`

**功能**: 扫描所有服务器或指定服务器上的账号文件

**参数**:
- `server_id` (可选): 指定服务器ID，如果不提供则扫描所有服务器

**响应**:
```json
[
  {
    "server_id": "worker-01",
    "accounts": [
      {
        "account_id": "639277356598",
        "session_file": "/home/ubuntu/sessions/639277356598.session",
        "server_id": "worker-01",
        "file_size": 1024,
        "modified_time": "2025-01-20T10:00:00"
      }
    ],
    "total_count": 1
  }
]
```

---

### 2. 对比账号（去重验证）

**接口**: `GET /api/v1/group-ai/account-management/compare-accounts`

**功能**: 对比本地数据库和服务器上的账号，找出重复账号

**参数**:
- `server_id` (可选): 指定服务器ID，如果不提供则对比所有服务器

**响应**:
```json
{
  "local_count": 10,
  "server_count": 15,
  "duplicate_count": 5,
  "comparisons": [
    {
      "account_id": "639277356598",
      "in_local": true,
      "in_server": true,
      "is_duplicate": true,
      "local_info": {
        "account_id": "639277356598",
        "session_file": "sessions/639277356598.session",
        "server_id": "worker-01",
        "script_id": "000新人欢迎剧本",
        "active": true
      },
      "server_info": {
        "account_id": "639277356598",
        "session_file": "/home/ubuntu/sessions/639277356598.session",
        "server_id": "worker-01",
        "file_size": 1024,
        "modified_time": "2025-01-20T10:00:00"
      }
    }
  ]
}
```

---

### 3. 删除服务器账号

**接口**: `DELETE /api/v1/group-ai/account-management/server-account`

**功能**: 删除服务器上的账号文件

**请求体**:
```json
{
  "server_id": "worker-01",
  "account_id": "639277356598",
  "confirm": true
}
```

**响应**:
```json
{
  "success": true,
  "message": "已删除服务器 worker-01 上的账号 639277356598",
  "deleted_file": "/home/ubuntu/sessions/639277356598.session"
}
```

---

### 4. 批量删除服务器账号

**接口**: `POST /api/v1/group-ai/account-management/batch-delete-server-accounts`

**功能**: 批量删除服务器上的账号文件

**参数**:
- `server_id`: 服务器ID
- `account_ids`: 账号ID列表（请求体）
- `confirm`: 需要设置为true才能删除

**请求体**:
```json
{
  "account_ids": ["639277356598", "639277356155"],
  "confirm": true
}
```

**响应**:
```json
{
  "success": true,
  "message": "成功删除 2 个账号",
  "deleted": ["639277356598", "639277356155"],
  "failed": [],
  "not_found": []
}
```

---

### 5. 列出所有账号

**接口**: `GET /api/v1/group-ai/account-management/list-all-accounts`

**功能**: 列出所有账号（本地+服务器）

**参数**:
- `include_local` (默认: true): 包含本地账号
- `include_server` (默认: true): 包含服务器账号
- `server_id` (可选): 指定服务器ID

**响应**:
```json
{
  "local_accounts": [
    {
      "account_id": "639277356598",
      "session_file": "sessions/639277356598.session",
      "server_id": "worker-01",
      "script_id": "000新人欢迎剧本",
      "active": true,
      "display_name": "测试账号",
      "username": "test_user",
      "phone_number": "+1234567890"
    }
  ],
  "server_accounts": [
    {
      "account_id": "639277356598",
      "session_file": "/home/ubuntu/sessions/639277356598.session",
      "server_id": "worker-01",
      "file_size": 1024,
      "modified_time": "2025-01-20T10:00:00"
    }
  ],
  "summary": {
    "local_count": 10,
    "server_count": 15,
    "total_count": 25
  }
}
```

---

## 自动分配和手动分配

### 自动分配

在创建账号时（`POST /api/v1/group-ai/accounts`），系统会自动使用智能分配引擎将账号分配到最优服务器。

**流程**:
1. 用户创建账号
2. 系统自动调用智能分配引擎
3. 根据负载、地理位置、剧本亲和性等因素选择最优服务器
4. 上传session文件到服务器
5. 保存分配结果到数据库

### 手动分配

使用分配API（`POST /api/v1/group-ai/allocation/allocate`）可以手动指定分配策略。

**请求体**:
```json
{
  "account_id": "639277356598",
  "session_file": "sessions/639277356598.session",
  "script_id": "000新人欢迎剧本",
  "strategy": "load_balance",  // load_balance, location, affinity, isolation
  "account_location": "LosAngeles"
}
```

---

## 核心功能实现

### 1. 账号ID提取

从session文件名中提取账号ID，支持多种格式：
- `639277356598.session`
- `639277356598.session.encrypted`
- `/path/to/639277356598.session`

### 2. 服务器账号扫描

通过SSH连接服务器，扫描sessions目录下的所有`.session`文件，获取文件信息和账号ID。

### 3. 账号去重验证

对比本地数据库和服务器上的账号，找出：
- 只在本地存在的账号
- 只在服务器存在的账号
- 在本地和服务器都存在的重复账号

### 4. 安全删除

删除操作需要确认（`confirm=true`），防止误删。

---

## 使用场景

### 场景1: 清理重复账号

1. 调用 `GET /api/v1/group-ai/account-management/compare-accounts` 找出重复账号
2. 查看对比结果，确认要删除的账号
3. 调用 `POST /api/v1/group-ai/account-management/batch-delete-server-accounts` 批量删除

### 场景2: 查看所有账号

调用 `GET /api/v1/group-ai/account-management/list-all-accounts` 查看所有账号（本地+服务器）

### 场景3: 扫描特定服务器

调用 `GET /api/v1/group-ai/account-management/scan-server-accounts?server_id=worker-01` 扫描特定服务器

---

## 文件清单

### 新增文件
1. `admin-backend/app/api/group_ai/account_management.py` - 账号管理和去重功能

### 修改文件
1. `admin-backend/app/api/group_ai/__init__.py` - 添加account_management路由

---

## 权限要求

所有接口都需要相应的权限：
- `ACCOUNT_VIEW`: 查看账号
- `ACCOUNT_DELETE`: 删除账号
- `ACCOUNT_UPDATE`: 分配账号

---

## 测试建议

1. **扫描服务器账号**: 测试扫描所有服务器和指定服务器
2. **账号对比**: 测试对比功能，验证重复账号检测
3. **删除账号**: 测试单个和批量删除功能
4. **列出账号**: 测试列出所有账号功能
5. **自动分配**: 测试创建账号时的自动分配
6. **手动分配**: 测试手动分配功能

---

## 注意事项

1. **删除操作不可逆**: 删除服务器上的账号文件后无法恢复，请谨慎操作
2. **需要确认**: 删除操作需要设置 `confirm=true`
3. **权限检查**: 所有操作都需要相应的权限
4. **SSH连接**: 需要确保服务器SSH连接正常

---

**开发完成时间**: 2025-01-20  
**开发人员**: AI Assistant  
**审核状态**: 待审核

