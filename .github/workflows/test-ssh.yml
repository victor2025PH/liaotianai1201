name: Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check Secrets
        run: |
          echo "Checking GitHub Secrets configuration..."
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "❌ SERVER_HOST not configured"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "❌ SERVER_USER not configured"
            exit 1
          fi
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "❌ SERVER_SSH_KEY not configured"
            exit 1
          fi
          echo "✅ All required Secrets are configured"
          echo "  SERVER_HOST: ${{ secrets.SERVER_HOST }}"
          echo "  SERVER_USER: ${{ secrets.SERVER_USER }}"
          echo "  SERVER_SSH_KEY: [configured, length: $(echo -n '${{ secrets.SERVER_SSH_KEY }}' | wc -c) characters]"
      
      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          timeout: 60s
          debug: true
          script: |
            echo "=========================================="
            echo "SSH Connection Test"
            echo "=========================================="
            echo "Test time: $(date)"
            echo ""
            echo "1. Testing basic connection..."
            echo "   Current user: $(whoami)"
            echo "   Current directory: $(pwd)"
            echo "   System info: $(uname -a)"
            echo ""
            echo "2. Testing filesystem access..."
            echo "   Home directory: $HOME"
            echo "   Disk space:"
            df -h / | tail -1
            echo ""
            echo "3. Testing network connection..."
            if command -v curl >/dev/null 2>&1; then
              echo "   curl available"
            else
              echo "   ⚠️  curl not available"
            fi
            echo ""
            echo "4. Testing Git..."
            if command -v git >/dev/null 2>&1; then
              echo "   Git version: $(git --version)"
            else
              echo "   ⚠️  Git not available"
            fi
            echo ""
            echo "5. Testing Python..."
            if command -v python3 >/dev/null 2>&1; then
              echo "   Python version: $(python3 --version)"
            else
              echo "   ⚠️  Python3 not available"
            fi
            echo ""
            echo "6. Testing Node.js..."
            if command -v node >/dev/null 2>&1; then
              echo "   Node.js version: $(node --version)"
            else
              echo "   ⚠️  Node.js not available"
            fi
            echo ""
            echo "=========================================="
            echo "✅ SSH connection test successful!"
            echo "=========================================="
