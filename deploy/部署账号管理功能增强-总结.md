# 账号管理功能增强 - 部署总结

## 部署文件清单

### 已修改的文件

1. **`saas-demo/src/lib/api/group-ai.ts`**
   - 添加了 `getWorkers()` 函数
   - 添加了 Workers API 相关的类型定义（`WorkerAccount`, `WorkerNode`, `WorkersResponse`）

2. **`saas-demo/src/app/group-ai/accounts/page.tsx`**
   - 添加了 `fetchWorkerAccounts()` 函数
   - 添加了角色分配相关状态和函数
   - 添加了角色分配对话框
   - 修改了账号列表显示逻辑
   - 添加了Worker节点账号的显示

## 部署步骤

### 方法1：使用批处理脚本（推荐）

```bash
.\deploy\部署账号管理功能增强.bat
```

### 方法2：使用Python脚本（详细输出）

```bash
python deploy/部署账号管理增强-详细版.py
```

### 方法3：手动部署

#### 步骤1：上传文件

```bash
# 上传 API 客户端文件
scp saas-demo/src/lib/api/group-ai.ts ubuntu@165.154.233.55:/home/ubuntu/liaotian/saas-demo/src/lib/api/group-ai.ts

# 上传账号管理页面
scp saas-demo/src/app/group-ai/accounts/page.tsx ubuntu@165.154.233.55:/home/ubuntu/liaotian/saas-demo/src/app/group-ai/accounts/page.tsx
```

#### 步骤2：重新构建前端

```bash
ssh ubuntu@165.154.233.55 "cd /home/ubuntu/liaotian/saas-demo && export NVM_DIR=\"$HOME/.nvm\" && [ -s \"$NVM_DIR/nvm.sh\" ] && . \"$NVM_DIR/nvm.sh\" && nvm use 20 && rm -rf .next && npm run build"
```

#### 步骤3：重启前端服务

```bash
ssh ubuntu@165.154.233.55 "sudo systemctl restart liaotian-frontend"
```

#### 步骤4：验证部署

```bash
# 检查服务状态
ssh ubuntu@165.154.233.55 "sudo systemctl status liaotian-frontend --no-pager | head -15"

# 检查文件是否存在
ssh ubuntu@165.154.233.55 "ls -lh /home/ubuntu/liaotian/saas-demo/src/lib/api/group-ai.ts"
ssh ubuntu@165.154.233.55 "ls -lh /home/ubuntu/liaotian/saas-demo/src/app/group-ai/accounts/page.tsx"

# 验证关键函数
ssh ubuntu@165.154.233.55 "grep -n 'getWorkers' /home/ubuntu/liaotian/saas-demo/src/lib/api/group-ai.ts | head -3"
ssh ubuntu@165.154.233.55 "grep -n 'fetchWorkerAccounts' /home/ubuntu/liaotian/saas-demo/src/app/group-ai/accounts/page.tsx | head -3"
```

## 验证部署结果

### 1. 检查文件上传

```bash
ssh ubuntu@165.154.233.55 "test -f /home/ubuntu/liaotian/saas-demo/src/lib/api/group-ai.ts && echo 'OK' || echo 'FAIL'"
ssh ubuntu@165.154.233.55 "test -f /home/ubuntu/liaotian/saas-demo/src/app/group-ai/accounts/page.tsx && echo 'OK' || echo 'FAIL'"
```

### 2. 检查服务状态

```bash
ssh ubuntu@165.154.233.55 "sudo systemctl is-active liaotian-frontend"
ssh ubuntu@165.154.233.55 "sudo systemctl is-active liaotian-backend"
```

### 3. 检查端口监听

```bash
ssh ubuntu@165.154.233.55 "sudo netstat -tlnp | grep ':3000'"
ssh ubuntu@165.154.233.55 "sudo netstat -tlnp | grep ':8000'"
```

### 4. 检查构建结果

```bash
ssh ubuntu@165.154.233.55 "test -d /home/ubuntu/liaotian/saas-demo/.next && echo '构建成功' || echo '构建失败'"
```

## 功能验证

### 浏览器端验证

1. **清除浏览器缓存**
   - 按 `Ctrl+Shift+Delete` 打开清除数据对话框
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **强制刷新页面**
   - 按 `Ctrl+F5` 强制刷新
   - 或按 `F12` 打开开发者工具，右键刷新按钮选择"清空缓存并硬性重新加载"

3. **验证功能**
   - 打开账号管理页面 (`/group-ai/accounts`)
   - 检查是否显示所有账号（包括Worker节点账号）
   - 点击"添加账号"，选择剧本，检查是否显示角色列表
   - 点击账号行的"角色分配"按钮，检查角色分配对话框是否正常显示

### 功能检查清单

- [ ] 账号列表显示数据库账号
- [ ] 账号列表显示Worker节点账号（如果有）
- [ ] Worker节点账号显示"Worker节点"标签
- [ ] 选择剧本时自动显示角色列表
- [ ] 角色分配对话框正常打开
- [ ] 可以为账号分配角色
- [ ] 已分配的角色在账号列表中显示

## 故障排查

### 问题1：账号列表不显示Worker节点账号

**可能原因**：
- Workers API 端点不可用
- Worker节点未在线
- 网络连接问题

**解决方法**：
```bash
# 检查Workers API是否可用
curl http://aikz.usdt2026.cc/api/v1/workers/

# 检查后端服务状态
ssh ubuntu@165.154.233.55 "sudo systemctl status liaotian-backend"
```

### 问题2：角色列表不显示

**可能原因**：
- 剧本中没有定义角色
- `extractRoles` API 调用失败
- 剧本ID不正确

**解决方法**：
- 检查剧本YAML文件是否包含 `metadata.roles` 或 `roles` 字段
- 检查浏览器控制台是否有错误
- 验证剧本ID是否正确

### 问题3：角色分配失败

**可能原因**：
- 账号未分配剧本
- 角色ID不存在
- 后端API错误

**解决方法**：
- 确保账号已分配剧本
- 检查角色ID是否在剧本的角色列表中
- 查看浏览器控制台和网络请求的错误信息

## 回滚步骤

如果部署出现问题，可以回滚到之前的版本：

```bash
# 1. 停止前端服务
ssh ubuntu@165.154.233.55 "sudo systemctl stop liaotian-frontend"

# 2. 恢复文件（如果有备份）
# scp backup/group-ai.ts ubuntu@165.154.233.55:/home/ubuntu/liaotian/saas-demo/src/lib/api/group-ai.ts
# scp backup/accounts-page.tsx ubuntu@165.154.233.55:/home/ubuntu/liaotian/saas-demo/src/app/group-ai/accounts/page.tsx

# 3. 重新构建
ssh ubuntu@165.154.233.55 "cd /home/ubuntu/liaotian/saas-demo && npm run build"

# 4. 重启服务
ssh ubuntu@165.154.233.55 "sudo systemctl start liaotian-frontend"
```

## 部署完成确认

部署完成后，请确认：

1. ✅ 文件已上传到服务器
2. ✅ 前端已重新构建（无错误）
3. ✅ 前端服务已重启
4. ✅ 浏览器可以正常访问页面
5. ✅ 新功能正常工作

## 联系支持

如果遇到问题，请：
1. 检查服务器日志：`sudo journalctl -u liaotian-frontend -n 50`
2. 检查浏览器控制台错误
3. 检查网络请求（F12 → Network）
4. 查看部署脚本的输出

