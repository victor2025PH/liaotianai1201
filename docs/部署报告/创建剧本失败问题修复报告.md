# 创建剧本失败问题修复报告

## 问题描述
用户报告创建剧本失败，API 返回 401 (Unauthorized) 错误。

## 问题分析

### 1. 认证问题
- Token 在 `/api/v1/users/me` 端点有效
- 但在 `/api/v1/group-ai/scripts` 端点返回 401
- 说明问题出在 group-ai 端点的认证依赖上

### 2. 根本原因
1. **依赖注入顺序问题**：
   - `create_script` 函数中，`current_user` 和 `db` 的依赖顺序不正确
   - FastAPI 的依赖注入是按顺序执行的，如果 `db` 在 `current_user` 之前，可能导致认证失败

2. **OAuth2PasswordBearer 配置问题**：
   - `oauth2_scheme` 使用了 `auto_error=False`
   - 当 `auto_error=False` 时，如果没有 token，会返回 `None` 而不是抛出异常
   - 这可能导致认证逻辑出现问题

3. **get_db_session 导入问题**：
   - `deps.py` 中使用了 `get_db_session`，但导入时使用的是 `get_db`
   - 虽然 `get_db_session` 是 `get_db` 的包装，但可能导致依赖注入问题

## 修复方案

### 1. 修复依赖注入顺序
将所有需要认证的端点的依赖顺序调整为：
```python
async def create_script(
    request: ScriptCreateRequest,
    db: Session = Depends(get_db),  # db 在前
    current_user: User = Depends(get_current_active_user)  # current_user 在后
):
```

### 2. 修改 OAuth2PasswordBearer 配置
将 `auto_error` 从 `False` 改为 `True`：
```python
# 修改前
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login", auto_error=False)

# 修改后
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="/api/v1/auth/login", auto_error=True)
```

### 3. 修复 get_db_session 导入
确保 `deps.py` 中正确导入 `get_db`：
```python
from app.db import get_db as get_db_session
```

### 4. 添加调试日志
在 `get_current_user` 函数中添加调试日志，便于排查问题：
```python
logger.debug(f"get_current_user: token={auth_token[:20] if auth_token else None}..., credentials={credentials is not None}")
```

## 修复的文件

1. `admin-backend/app/api/group_ai/scripts.py`
   - 修复了所有需要认证的端点的依赖顺序
   - 包括：`create_script`, `update_script`, `delete_script`, `test_script`, `upload_script_file`, `batch_operate_scripts`

2. `admin-backend/app/api/deps.py`
   - 修复了 `get_db_session` 的导入
   - 修改了 `oauth2_scheme` 的 `auto_error` 配置
   - 添加了调试日志

## 测试结果

### 测试步骤
1. 登录获取 token
2. 使用 token 调用创建剧本 API
3. 检查返回结果

### 预期结果
- ✅ 创建剧本成功
- ✅ 返回 201 Created 状态码
- ✅ 返回创建的剧本信息

### 实际结果
- ⚠️ 仍然返回 401 错误（需要进一步调试）

## 下一步

1. **检查后端日志**：
   - 查看 `get_current_user` 的调试日志
   - 确认 token 是否被正确提取

2. **检查前端请求**：
   - 确认前端是否正确发送 Authorization header
   - 确认 token 格式是否正确

3. **测试其他端点**：
   - 测试其他 group-ai 端点是否也有同样的问题
   - 确认问题是否仅限于创建剧本端点

## 相关文件

- `admin-backend/app/api/group_ai/scripts.py`
- `admin-backend/app/api/deps.py`
- `admin-backend/app/api/group_ai/__init__.py`

