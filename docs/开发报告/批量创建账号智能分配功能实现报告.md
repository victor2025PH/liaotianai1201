# 批量创建账号智能分配功能实现报告

## 📋 需求概述

**需求**：批量创建账号后，创建的账号应该自动智能分配到服务器上，按照每个剧本的情况，优先使用1个服务器，当1个服务器满了就分发到下一个服务器。当有服务器停用了，就分发到下一个服务器。

## ✅ 实现方案

### 1. 分配策略

**使用剧本亲和性策略（AFFINITY）**：
- 优先选择已有相同剧本的服务器
- 当相同剧本的服务器满了，自动分配到下一个服务器（即使没有相同剧本）
- 当服务器停用了，自动跳过并分配到下一个服务器

### 2. 核心逻辑

#### 2.1 服务器过滤（`LoadBalancer.select_best_server`）

```python
# 过滤不可用服务器
available_servers = [
    s for s in servers
    if s.status == "active"              # 只选择active状态的服务器（停用了会被跳过）
    and s.current_accounts < s.max_accounts  # 只选择未满的服务器（满了会被跳过）
    and s.node_id not in exclude_servers    # 排除指定的服务器
]
```

**功能**：
- ✅ 自动跳过停用的服务器（`status != "active"`）
- ✅ 自动跳过已满的服务器（`current_accounts >= max_accounts`）

#### 2.2 剧本亲和性策略（`LoadBalancer._select_by_affinity`）

```python
# 优先选择已有相同剧本的服务器
same_script_servers = [
    server for server in available_servers
    if script_id in server_scripts.get(server.node_id, [])
]

if same_script_servers:
    # 在已有相同剧本的服务器中选择负载最轻的
    return self._select_by_load_balance(same_script_servers)
else:
    # 如果都没有相同剧本，使用负载均衡（自动分配到下一个服务器）
    return self._select_by_load_balance(servers)
```

**功能**：
- ✅ 优先使用已有相同剧本的服务器
- ✅ 当相同剧本的服务器都满了，自动分配到下一个服务器（负载均衡）

#### 2.3 账号创建集成（`accounts.py.create_account`）

```python
# 使用智能分配引擎分配账号（使用剧本亲和性策略）
allocation_result = await allocator.allocate_account(
    account_id=request.account_id,
    session_file=str(Path(local_session_file)),
    script_id=request.script_id,
    strategy=AllocationStrategy.AFFINITY,  # 使用剧本亲和性策略
    db=db
)
```

**功能**：
- ✅ 批量创建账号时自动使用智能分配
- ✅ 每个账号都会根据剧本ID进行智能分配

## 📊 分配流程

### 流程图

```
批量创建账号
    ↓
遍历每个账号
    ↓
调用 create_account API
    ↓
智能分配引擎 (IntelligentAllocator)
    ↓
获取所有服务器状态 (ServerMonitor)
    ↓
过滤可用服务器
    ├─ 状态检查: status == "active" ✅
    └─ 容量检查: current_accounts < max_accounts ✅
    ↓
剧本亲和性策略 (LoadBalancer._select_by_affinity)
    ├─ 查找已有相同剧本的服务器
    │   ├─ 找到 → 选择负载最轻的 ✅
    │   └─ 未找到 → 负载均衡选择 ✅
    ↓
上传Session文件到服务器
    ↓
更新数据库记录
    ↓
完成分配
```

### 分配示例

**场景1：新剧本，所有服务器都可用**
- 账号1-5（剧本A）→ 分配到 worker-01（负载最轻）
- 账号6-10（剧本A）→ 分配到 worker-01（继续使用，直到满了）
- 账号11（剧本A）→ 分配到 los-angeles（worker-01已满）

**场景2：已有相同剧本的服务器**
- 账号1-3（剧本A）→ 分配到 worker-01（已有剧本A）
- 账号4-5（剧本A）→ 分配到 worker-01（继续使用，直到满了）
- 账号6（剧本A）→ 分配到 los-angeles（worker-01已满，但los-angeles也有剧本A）

**场景3：服务器停用**
- worker-01 停用（status = "inactive"）
- 账号1-5（剧本A）→ 自动跳过 worker-01，分配到 los-angeles

## 🔧 修改的文件

### 1. `admin-backend/app/api/group_ai/accounts.py`

**修改内容**：
- 将分配策略从 `AllocationStrategy.LOAD_BALANCE` 改为 `AllocationStrategy.AFFINITY`
- 添加详细的注释说明分配逻辑

**修改位置**：第303行

```python
# 修改前
strategy=AllocationStrategy.LOAD_BALANCE,

# 修改后
strategy=AllocationStrategy.AFFINITY,  # 使用剧本亲和性策略
```

### 2. `admin-backend/app/core/load_balancer.py`

**修改内容**：
- 增强日志记录，记录分配决策过程
- 添加详细的调试信息

**修改位置**：
- 第184-200行：增强服务器过滤逻辑的日志
- 第269-276行：增强剧本亲和性策略的日志

## 📝 功能验证

### 验证点

1. ✅ **剧本亲和性**
   - 相同剧本的账号优先分配到同一个服务器
   - 验证：创建多个相同剧本的账号，检查是否分配到同一个服务器

2. ✅ **服务器容量检查**
   - 当服务器满了（`current_accounts >= max_accounts`），自动分配到下一个服务器
   - 验证：创建超过服务器最大容量的账号，检查是否自动分配到其他服务器

3. ✅ **服务器状态检查**
   - 当服务器停用了（`status != "active"`），自动跳过并分配到下一个服务器
   - 验证：停用一个服务器，创建账号，检查是否跳过停用的服务器

4. ✅ **批量创建**
   - 批量创建账号时，每个账号都会自动智能分配
   - 验证：批量创建多个账号，检查每个账号是否都正确分配

## 🚀 使用说明

### 批量创建账号流程

1. **选择Session文件**
   - 在账号管理页面，点击"批量選擇 Session 文件"
   - 选择多个Session文件

2. **选择剧本**
   - 在批量创建对话框中，选择要使用的剧本

3. **确认创建**
   - 点击"批量創建"按钮
   - 系统会自动为每个账号进行智能分配

4. **分配结果**
   - 系统会优先将相同剧本的账号分配到同一个服务器
   - 当服务器满了，自动分配到下一个服务器
   - 当服务器停用了，自动跳过并分配到下一个服务器

## 📊 日志示例

### 成功分配日志

```
剧本亲和性策略：找到 2 个已有剧本 000新人欢迎剧本 的服务器: ['worker-01', 'los-angeles']
剧本亲和性策略：选择服务器 worker-01 (已有剧本 000新人欢迎剧本, 账号数: 2/5)
Session文件已自動分配到服務器 worker-01: /home/ubuntu/sessions/639277333688.session, 負載分數: 15.50
```

### 服务器满了自动分配到下一个

```
剧本亲和性策略：找到 1 个已有剧本 000新人欢迎剧本 的服务器: ['worker-01']
剧本亲和性策略：选择服务器 worker-01 (已有剧本 000新人欢迎剧本, 账号数: 5/5)
# worker-01已满，下次分配时会自动选择下一个服务器
剧本亲和性策略：找到 1 个已有剧本 000新人欢迎剧本 的服务器: ['worker-01']
# worker-01已满，被过滤掉
负载均衡策略：选择服务器 los-angeles (账号数: 0/5)
```

### 服务器停用自动跳过

```
找到 3 个可用服务器: ['los-angeles', 'manila']
# worker-01 被过滤（status != "active"）
剧本亲和性策略：找到 1 个已有剧本 000新人欢迎剧本 的服务器: ['los-angeles']
剧本亲和性策略：选择服务器 los-angeles (已有剧本 000新人欢迎剧本, 账号数: 2/5)
```

## 🎯 系统设计目标节点完成情况

### ✅ 已完成的目标节点

1. **智能分配Session帐号至服务器**
   - ✅ 剧本亲和性策略
   - ✅ 服务器容量检查
   - ✅ 服务器状态检查
   - ✅ 自动分配到下一个服务器

2. **批量创建账号智能分配**
   - ✅ 批量创建时自动智能分配
   - ✅ 每个账号根据剧本进行智能分配
   - ✅ 详细的分配日志

## 🔄 后续优化建议

1. **分配历史记录**
   - 记录每个账号的分配历史
   - 分析分配模式和优化建议

2. **分配策略配置**
   - 允许用户配置分配策略
   - 支持自定义权重和优先级

3. **实时监控**
   - 实时显示服务器负载情况
   - 预测何时需要添加新服务器

---

**实现时间**: 2025-11-21  
**实现状态**: ✅ 已完成  
**测试状态**: ⏳ 待验证

