# 测试部署流程执行指南

> **创建时间**: 2025-11-29  
> **目的**: 验证行尾符修复后的部署流程是否正常工作

---

## 📋 测试步骤

### 方式 1: 使用一键脚本（推荐）

#### 选项 A: 跳过推送（代码已在 GitHub）

```powershell
cd "e:\002-工作文件\重要程序\聊天AI群聊程序"
.\deploy\推送到GitHub并部署.ps1 -CommitMessage "测试行尾符修复" -SkipPush
```

#### 选项 B: 完整流程（包括推送）

```powershell
.\deploy\推送到GitHub并部署.ps1 -CommitMessage "测试行尾符修复后的部署流程"
```

#### 选项 C: 仅测试部署（不推送，代码已在 GitHub）

```powershell
.\deploy\测试部署流程-仅部署.ps1
```

---

### 方式 2: 手动在服务器上测试

如果一键脚本有问题，可以手动执行：

```bash
# SSH 登录服务器
ssh ubuntu@165.154.233.55

# 执行部署脚本
bash ~/liaotian/deploy/从GitHub拉取并部署.sh
```

---

## ✅ 验证标准

### 成功的标志

#### 1. 脚本上传成功 ✅

- 不再有文件上传错误
- 脚本文件成功创建在服务器上

#### 2. 脚本正常执行 ✅

**之前的问题**（已修复）:
```
/home/ubuntu/liaotian/deploy/从GitHub拉取并部署.sh: line 4: $'\r': command not found
```

**现在应该**:
- ✅ 不再出现 `$'\r': command not found` 错误
- ✅ 脚本可以正常解析和执行
- ✅ 所有步骤正常执行

#### 3. 代码成功拉取 ✅

预期输出:
```
【步骤2】从 GitHub 拉取最新代码...
  当前分支: master
  ✓ 代码拉取完成
  
  最近的提交:
  781dcf1 修复 Windows/Linux 行尾符兼容性问题
```

#### 4. 后端服务重启成功 ✅

预期输出:
```
【步骤4】重启后端服务...
  停止旧服务...
  清理 Python 缓存...
  启动新服务...
  后端进程 PID: xxxxx
  等待服务启动（最多30秒）...
  ✓ 后端服务已启动
```

#### 5. 健康检查通过 ✅

预期输出:
```
【步骤5】验证服务...
  ✓ 后端服务正常运行
  
  健康检查响应:
  {"status":"ok"}
```

---

## 🔍 验证步骤

### 步骤 1: 检查脚本行尾符

在服务器上执行：

```bash
# 检查文件类型（应该显示 ASCII text 或 executable）
file ~/liaotian/deploy/从GitHub拉取并部署.sh

# 检查是否还有 \r 字符（应该没有输出）
od -c ~/liaotian/deploy/从GitHub拉取并部署.sh | grep '\r'

# 检查脚本语法（应该没有错误）
bash -n ~/liaotian/deploy/从GitHub拉取并部署.sh
```

### 步骤 2: 验证代码版本

```bash
cd ~/liaotian
git log --oneline -3

# 应该看到最新的提交（包含行尾符修复）
# 781dcf1 修复 Windows/Linux 行尾符兼容性问题
```

### 步骤 3: 验证后端服务

```bash
# 检查服务进程
ps aux | grep uvicorn | grep -v grep

# 检查端口监听
sudo ss -tlnp | grep 8000

# 健康检查
curl -I http://localhost:8000/health
# 应该返回: HTTP/1.1 200 OK
```

### 步骤 4: 验证 UPSERT 功能

```bash
# 获取访问令牌
TOKEN=$(curl -s -X POST 'http://localhost:8000/api/v1/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin@example.com&password=changeme123' | \
  python3 -c 'import sys, json; print(json.load(sys.stdin)["access_token"])')

# 测试 UPSERT 功能（使用不存在的账号 ID）
curl -X PUT "http://localhost:8000/api/v1/group-ai/accounts/639277358115" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"script_id":"test-script","server_id":"computer_001"}' -v

# 应该返回 200 或 201，而不是 404
```

---

## ❌ 如果部署失败

### 问题 1: 脚本仍然有行尾符错误

**症状**: 仍然看到 `$'\r': command not found`

**解决方案**:
```bash
# 在服务器上手动转换
ssh ubuntu@165.154.233.55 "cd ~/liaotian && sed -i 's/\r$//' deploy/从GitHub拉取并部署.sh && chmod +x deploy/从GitHub拉取并部署.sh"
```

### 问题 2: Git 拉取失败

**症状**: `git pull` 失败

**检查**:
```bash
# 检查 Git 仓库状态
ssh ubuntu@165.154.233.55 "cd ~/liaotian && git status && git remote -v"
```

### 问题 3: 后端服务启动失败

**症状**: 服务无法启动或健康检查失败

**检查日志**:
```bash
# 查看后端日志
ssh ubuntu@165.154.233.55 "tail -50 /tmp/backend.log"
```

### 问题 4: SSH 连接问题

**症状**: 无法连接到服务器

**检查**:
- SSH 密钥是否正确配置
- 服务器 IP 是否正确
- 网络连接是否正常

---

## 📊 测试结果记录

### 测试时间
- 日期: _____________
- 时间: _____________

### 测试结果

- [ ] 脚本上传成功
- [ ] 脚本正常执行（无行尾符错误）
- [ ] 代码成功拉取
- [ ] 后端服务重启成功
- [ ] 健康检查通过
- [ ] UPSERT 功能正常

### 遇到的问题

（在此记录任何问题）

---

## 🎯 下一步

部署测试成功后：

1. **验证 UPSERT 功能**
   - 在前端界面测试分配剧本功能

2. **清理项目文件**
   - 整理 `deploy/` 目录
   - 归档临时脚本

3. **完善文档**
   - 更新部署文档
   - 记录部署流程

---

**更新时间**: 2025-11-29  
**状态**: 📝 测试指南
