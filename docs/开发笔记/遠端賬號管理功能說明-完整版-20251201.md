# é ç«¯è³¬è™Ÿç®¡ç†åŠŸèƒ½èªªæ˜ï¼ˆå®Œæ•´ç‰ˆï¼‰

> **æ—¥æœŸ**: 2025-12-01  
> **åŠŸèƒ½**: å¾Œå°ç®¡ç†é ç«¯æœå‹™å™¨å’Œå…¶ä»–é›»è…¦ä¸Šçš„ Telegram è³¬è™Ÿ

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½

1. **é ç«¯è³¬è™Ÿè‡ªå‹•åŒæ­¥**
   - Worker ç¯€é»é€šéå¿ƒè·³ä¸Šå ±è³¬è™Ÿåˆ—è¡¨
   - å¾Œå°è‡ªå‹•åŒæ­¥åˆ°æ•¸æ“šåº«
   - å‰ç«¯é¡¯ç¤ºæ‰€æœ‰è³¬è™Ÿï¼ˆæœ¬åœ°+é ç«¯ï¼‰

2. **åŠ‡æœ¬å‚³é€**
   - å¾Œå°æ¨é€åŠ‡æœ¬åˆ°é ç«¯ç¯€é»
   - é ç«¯ç¯€é»è‡ªå‹•ä¸‹è¼‰ä¸¦æ›´æ–°
   - æ”¯æŒæ‰¹é‡æ¨é€

3. **æœƒè©±ç®¡ç†**
   - ä¸Šå‚³æœƒè©±æ–‡ä»¶åˆ°é ç«¯
   - æœƒè©±æ–‡ä»¶åŒæ­¥
   - æœƒè©±æ–‡ä»¶ç®¡ç†

---

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### 1. é ç«¯è³¬è™ŸåŒæ­¥

#### å·¥ä½œæµç¨‹

```
Worker ç¯€é» (æ¯ 30 ç§’)
    â†“ ç™¼é€å¿ƒè·³ (åŒ…å«è³¬è™Ÿåˆ—è¡¨)
å¾Œå° Workers API
    â†“ èª¿ç”¨ remote_account_sync
æ•¸æ“šåº«åŒæ­¥
    â†“ æ›´æ–°/å‰µå»ºè³¬è™Ÿè¨˜éŒ„
å‰ç«¯é¡¯ç¤º (å¯¦æ™‚æ›´æ–°)
```

#### å¯¦ç¾æ–‡ä»¶

- `admin-backend/app/api/group_ai/remote_account_sync.py` âœ…
- `admin-backend/app/api/workers.py` âœ… (å·²å¢å¼·å¿ƒè·³è™•ç†)

#### Worker ç¯€é»å¿ƒè·³æ ¼å¼

```python
POST /api/v1/workers/heartbeat
{
  "node_id": "computer_001",
  "status": "online",
  "account_count": 3,
  "accounts": [
    {
      "account_id": "+1234567890",
      "status": "online",
      "script_id": "script_001",
      "message_count": 150,
      "reply_count": 45,
      "last_activity": "2025-12-01T18:00:00",
      "session_file": "/path/to/session.session",
      "group_ids": [123456789]
    }
  ]
}
```

---

### 2. åŠ‡æœ¬å‚³é€

#### å·¥ä½œæµç¨‹

```
å¾Œå°é¸æ“‡åŠ‡æœ¬å’Œç›®æ¨™ç¯€é»
    â†“ POST /api/v1/group-ai/scripts/deploy
å‘½ä»¤éšŠåˆ—ç™¼é€
    â†“ update_script å‘½ä»¤
Worker ç¯€é»ç²å–å‘½ä»¤
    â†“ å¾å‘½ä»¤éšŠåˆ—ç²å–
ä¸‹è¼‰åŠ‡æœ¬æ–‡ä»¶
    â†“ GET /api/v1/group-ai/scripts/{script_id}/download
æ›´æ–°æœ¬åœ°åŠ‡æœ¬
    â†“ ä¿å­˜ä¸¦é‡è¼‰
```

#### å¯¦ç¾æ–‡ä»¶

- `admin-backend/app/api/group_ai/script_deployment.py` âœ…
- â³ åŠ‡æœ¬ä¸‹è¼‰ç«¯é»ï¼ˆå¾…å¯¦ç¾ï¼‰

#### API ç«¯é»

- `POST /api/v1/group-ai/scripts/deploy` - æ¨é€åŠ‡æœ¬
- `GET /api/v1/group-ai/scripts/{script_id}/download` - ä¸‹è¼‰åŠ‡æœ¬ï¼ˆå¾…å¯¦ç¾ï¼‰

---

### 3. æœƒè©±ç®¡ç†

#### å·¥ä½œæµç¨‹

```
å¾Œå°ä¸Šå‚³æœƒè©±æ–‡ä»¶
    â†“ POST /api/v1/group-ai/accounts/upload-session
åˆ†é…æœƒè©±åˆ°ç¯€é»
    â†“ é€šéå‘½ä»¤éšŠåˆ—ç™¼é€
Worker ç¯€é»æ¥æ”¶
    â†“ ä¸‹è¼‰æœƒè©±æ–‡ä»¶
ä¿å­˜ä¸¦åŠ è¼‰æœƒè©±
```

#### å¯¦ç¾ç‹€æ…‹

- â³ æœƒè©±æ–‡ä»¶å‚³è¼¸ï¼ˆå¾…å¯¦ç¾ï¼‰
- âœ… æœƒè©±æ–‡ä»¶ä¸Šå‚³ï¼ˆå·²å­˜åœ¨ï¼‰

---

## ğŸ“‹ ä½¿ç”¨å ´æ™¯

### å ´æ™¯ 1: æŸ¥çœ‹é ç«¯è³¬è™Ÿé‹è¡Œç‹€æ…‹

**éœ€æ±‚**: åœ¨å¾Œå°æŸ¥çœ‹æ‰€æœ‰é ç«¯ç¯€é»çš„è³¬è™Ÿé‹è¡Œç‹€æ…‹

**æµç¨‹**:
1. Worker ç¯€é»æ¯ 30 ç§’ç™¼é€å¿ƒè·³ï¼ˆåŒ…å«è³¬è™Ÿåˆ—è¡¨ï¼‰
2. å¾Œå°è‡ªå‹•åŒæ­¥è³¬è™Ÿä¿¡æ¯åˆ°æ•¸æ“šåº«
3. å‰ç«¯é¡¯ç¤ºæ‰€æœ‰è³¬è™Ÿï¼Œæ¨™è¨˜ä¾†æºç¯€é»

**å¯¦ç¾**:
- âœ… å¿ƒè·³æ©Ÿåˆ¶å·²å¯¦ç¾
- âœ… è³¬è™ŸåŒæ­¥å·²å¯¦ç¾
- â³ å‰ç«¯é¡¯ç¤ºï¼ˆå¾…å¢å¼·ï¼‰

---

### å ´æ™¯ 2: æ¨é€åŠ‡æœ¬åˆ°é ç«¯ç¯€é»

**éœ€æ±‚**: å¾å¾Œå°æ¨é€åŠ‡æœ¬åˆ°é ç«¯ Worker ç¯€é»

**æµç¨‹**:
1. åœ¨å¾Œå°é¸æ“‡åŠ‡æœ¬
2. é¸æ“‡ç›®æ¨™ Worker ç¯€é»
3. é»æ“Šã€Œæ¨é€ã€
4. å¾Œå°ç™¼é€å‘½ä»¤åˆ° Worker ç¯€é»
5. Worker ç¯€é»ä¸‹è¼‰ä¸¦æ›´æ–°åŠ‡æœ¬

**å¯¦ç¾**:
- âœ… åŠ‡æœ¬æ¨é€ API å·²å¯¦ç¾
- â³ åŠ‡æœ¬ä¸‹è¼‰ç«¯é»ï¼ˆå¾…å¯¦ç¾ï¼‰
- â³ å‰ç«¯ UIï¼ˆå¾…å¯¦ç¾ï¼‰

---

### å ´æ™¯ 3: ä¸Šå‚³æœƒè©±åˆ°é ç«¯ç¯€é»

**éœ€æ±‚**: ä¸Šå‚³æœƒè©±æ–‡ä»¶åˆ°é ç«¯ç¯€é»ä¸¦è‡ªå‹•åŠ è¼‰

**æµç¨‹**:
1. åœ¨å¾Œå°ä¸Šå‚³ `.session` æ–‡ä»¶
2. é¸æ“‡ç›®æ¨™ Worker ç¯€é»
3. å¾Œå°é€šéå‘½ä»¤éšŠåˆ—ç™¼é€å‚³è¼¸æŒ‡ä»¤
4. Worker ç¯€é»æ¥æ”¶ä¸¦ä¿å­˜æœƒè©±æ–‡ä»¶

**å¯¦ç¾**:
- âœ… æœƒè©±ä¸Šå‚³å·²å­˜åœ¨
- â³ æœƒè©±å‚³è¼¸åˆ°é ç«¯ï¼ˆå¾…å¯¦ç¾ï¼‰

---

## ğŸš€ Worker ç¯€é»å¯¦ç¾ç¤ºä¾‹

### Worker ç¯€é»å¿ƒè·³ä»£ç¢¼

```python
import requests
import time
import asyncio
from datetime import datetime

NODE_ID = "computer_001"
MASTER_URL = "http://å¾Œå°åœ°å€/api/v1"

async def send_heartbeat():
    """ç™¼é€å¿ƒè·³åˆ°å¾Œå°"""
    # ç²å–æœ¬åœ°æ‰€æœ‰è³¬è™Ÿçš„é‹è¡Œä¿¡æ¯
    accounts = []
    for account_id in get_local_accounts():
        account_info = {
            "account_id": account_id,
            "status": get_account_status(account_id),  # "online" or "offline"
            "script_id": get_account_script(account_id),
            "message_count": get_message_count(account_id),
            "reply_count": get_reply_count(account_id),
            "last_activity": get_last_activity(account_id).isoformat() if get_last_activity(account_id) else None,
            "session_file": get_session_file(account_id),
            "group_ids": get_group_ids(account_id)
        }
        accounts.append(account_info)
    
    try:
        response = requests.post(
            f"{MASTER_URL}/workers/heartbeat",
            json={
                "node_id": NODE_ID,
                "status": "online",
                "account_count": len(accounts),
                "accounts": accounts
            },
            timeout=5
        )
        
        if response.status_code == 200:
            data = response.json()
            # è™•ç†å¾…åŸ·è¡Œå‘½ä»¤
            commands = data.get("pending_commands", [])
            await process_commands(commands)
    except Exception as e:
        print(f"ç™¼é€å¿ƒè·³å¤±æ•—: {e}")

async def process_commands(commands):
    """è™•ç†å¾å¾Œå°æ¥æ”¶çš„å‘½ä»¤"""
    for command in commands:
        action = command.get("action")
        params = command.get("params", {})
        
        if action == "update_script":
            # ä¸‹è¼‰ä¸¦æ›´æ–°åŠ‡æœ¬
            script_id = params.get("script_id")
            download_url = params.get("download_url")
            await download_and_update_script(script_id, download_url)
        elif action == "upload_session":
            # ä¸‹è¼‰ä¸¦ä¿å­˜æœƒè©±æ–‡ä»¶
            session_url = params.get("session_url")
            account_id = params.get("account_id")
            await download_and_save_session(session_url, account_id)

# æ¯ 30 ç§’ç™¼é€ä¸€æ¬¡å¿ƒè·³
async def heartbeat_loop():
    while True:
        await send_heartbeat()
        await asyncio.sleep(30)

# å•Ÿå‹•å¿ƒè·³å¾ªç’°
asyncio.run(heartbeat_loop())
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å¯¦ç¾è¨ˆåŠƒ

### å„ªå…ˆç´š 1: å®Œå–„ç¾æœ‰åŠŸèƒ½

1. **æ·»åŠ åŠ‡æœ¬ä¸‹è¼‰ç«¯é»**
   - åœ¨ `scripts.py` ä¸­æ·»åŠ  `GET /api/v1/group-ai/scripts/{script_id}/download`
   - è¿”å›åŠ‡æœ¬ YAML æ–‡ä»¶å…§å®¹

2. **å¢å¼·å‰ç«¯é¡¯ç¤º**
   - åœ¨è³¬è™Ÿåˆ—è¡¨æ¨™è¨˜ä¾†æºç¯€é»
   - æ”¯æŒæŒ‰ç¯€é»éæ¿¾

### å„ªå…ˆç´š 2: å¯¦ç¾æ–°åŠŸèƒ½

3. **æœƒè©±æ–‡ä»¶å‚³è¼¸**
   - æœƒè©±æ–‡ä»¶ä¸‹è¼‰ç«¯é»
   - æœƒè©±æ–‡ä»¶å‚³è¼¸å‘½ä»¤

4. **å‰ç«¯ UI å¢å¼·**
   - åŠ‡æœ¬æ¨é€ UI
   - æœƒè©±ç®¡ç† UI

---

**åŸºç¤æ¶æ§‹å·²å®Œæˆï¼Œå¯ä»¥é–‹å§‹å®Œæ•´å¯¦ç¾å’Œæ¸¬è©¦ï¼**
