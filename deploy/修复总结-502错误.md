# 修复502错误总结

## 问题分析

根据终端输出，发现了以下问题：

1. **服务已停止**：`Active: inactive (dead)`
2. **工作目录错误**：`WorkingDirectory=/home/ubuntu/liaotian/saas-demo` 应该是standalone目录
3. **静态文件未复制**：standalone目录缺少`.next/static`文件

## 根本原因

在Next.js standalone模式下：
- 服务器的工作目录应该是standalone目录本身（包含server.js的目录）
- 静态文件需要手动复制到standalone目录的`.next/static`下
- systemd服务的`WorkingDirectory`必须指向standalone目录

## 修复步骤

### 1. 查找standalone目录

```bash
cd /home/ubuntu/liaotian/saas-demo
STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname)
echo "Standalone目录: $STANDALONE_DIR"
```

### 2. 复制静态文件

```bash
mkdir -p "$STANDALONE_DIR/.next/static"
cp -r .next/static/* "$STANDALONE_DIR/.next/static/"
```

### 3. 修复systemd服务配置

```bash
FULL_STANDALONE_DIR="/home/ubuntu/liaotian/saas-demo/$STANDALONE_DIR"

# 备份原配置
sudo cp /etc/systemd/system/liaotian-frontend.service /etc/systemd/system/liaotian-frontend.service.bak

# 创建新配置
sudo tee /etc/systemd/system/liaotian-frontend.service > /dev/null <<EOF
[Unit]
Description=Liaotian Frontend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=$FULL_STANDALONE_DIR
Environment=PORT=3000
Environment="NVM_DIR=\$HOME/.nvm"
Environment="PATH=\$HOME/.nvm/versions/node/v20.19.6/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/home/ubuntu/.nvm/versions/node/v20.19.6/bin/node server.js
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```

**关键变化**：
- `WorkingDirectory` 从 `/home/ubuntu/liaotian/saas-demo` 改为 `$FULL_STANDALONE_DIR`
- `ExecStart` 从完整路径改为相对路径 `server.js`（因为工作目录已更改）

### 4. 重新加载并启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl start liaotian-frontend
sleep 5
sudo systemctl status liaotian-frontend --no-pager | head -15
```

## 验证

修复后应该：
1. ✅ 服务状态为 `active (running)`
2. ✅ 端口3000被监听：`ss -tlnp | grep ':3000'`
3. ✅ 静态文件可访问：`curl -I http://localhost:3000/_next/static/chunks/adc3be135379192a.js` 返回200
4. ✅ 页面不再显示502错误

## 自动化脚本

已创建 `deploy/完整修复502和静态文件.sh` 脚本，可以自动执行所有修复步骤。

## 预防措施

为了避免将来出现这个问题，建议：

1. **在构建脚本中自动复制静态文件**：
   ```bash
   npm run build && \
   STANDALONE_DIR=$(find .next/standalone -name 'server.js' -type f | head -1 | xargs dirname) && \
   mkdir -p "$STANDALONE_DIR/.next/static" && \
   cp -r .next/static/* "$STANDALONE_DIR/.next/static/"
   ```

2. **在部署脚本中自动更新systemd配置**：
   - 自动查找standalone目录
   - 自动更新`WorkingDirectory`
   - 自动更新`ExecStart`为相对路径

3. **使用Docker部署**（推荐）：
   - Dockerfile已经正确处理了静态文件和工作目录
   - 可以确保每次部署的一致性

