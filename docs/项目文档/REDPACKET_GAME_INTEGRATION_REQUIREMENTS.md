# 红包游戏系统集成功能需求文档

> **文档版本**: v1.0  
> **创建日期**: 2025-11-15  
> **适用系统**: Smart TG Business AI  
> **目标**: 实现与红包游戏系统的无缝对接

---

## 目录

1. [概述](#概述)
2. [系统架构设计](#系统架构设计)
3. [接口规范](#接口规范)
4. [账号导入与群组管理](#账号导入与群组管理)
5. [红包游戏集成](#红包游戏集成)
6. [实时聊天引导系统](#实时聊天引导系统)
7. [用户体验设计](#用户体验设计)
8. [安全与隐私](#安全与隐私)
9. [实施计划](#实施计划)
10. [测试策略](#测试策略)

---

## 概述

### 1.1 项目目标

实现 Smart TG Business AI 系统与红包游戏系统的无缝对接，使导入的 Telegram 账号能够：

1. **自动创建群组**：支持批量创建红包游戏群组
2. **自动加入群组**：导入账号自动加入指定群组
3. **参与红包游戏**：自动检测并参与群组内的红包活动
4. **实时聊天引导**：在游戏过程中提供智能聊天引导，帮助用户理解游戏规则

### 1.2 核心功能

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|--------|
| 账号批量导入 | 支持批量导入 .session 文件，自动创建账号实例 | P0 |
| 群组自动创建 | 使用导入账号自动创建 Telegram 群组 | P0 |
| 群组自动加入 | 导入账号自动加入指定群组 | P0 |
| 红包游戏检测 | 实时检测群组内的红包消息 | P0 |
| 红包参与策略 | 智能决策是否参与红包游戏 | P0 |
| 实时聊天引导 | 游戏过程中的智能对话引导 | P1 |
| 游戏状态同步 | 与红包游戏系统状态同步 | P0 |
| 数据统计与分析 | 游戏参与数据统计和分析 | P1 |

### 1.3 技术约束

- **平台**: Telegram (Pyrogram)
- **后端**: Python 3.11+, FastAPI
- **数据库**: SQLite (开发) / PostgreSQL (生产)
- **消息队列**: Redis (可选)
- **API 协议**: RESTful API, WebSocket (实时通信)

---

## 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    红包游戏系统                                │
│  (外部系统 - 提供游戏逻辑、红包发放、结果统计)                │
└──────────────────────┬──────────────────────────────────────┘
                       │ HTTP/WebSocket API
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              Smart TG Business AI 系统                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 账号管理模块  │  │ 群组管理模块  │  │ 红包处理模块  │      │
│  │              │  │              │  │              │      │
│  │ - 账号导入   │  │ - 群组创建   │  │ - 红包检测   │      │
│  │ - 账号启动   │  │ - 群组加入   │  │ - 参与策略   │      │
│  │ - 状态管理   │  │ - 群组配置   │  │ - 执行参与   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 对话管理模块  │  │ 引导系统模块  │  │ 监控服务模块  │      │
│  │              │  │              │  │              │      │
│  │ - 消息处理   │  │ - 引导生成   │  │ - 状态监控   │      │
│  │ - 上下文管理 │  │ - 规则解释   │  │ - 数据统计   │      │
│  │ - AI 回复    │  │ - 实时提示   │  │ - 告警通知   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Telegram API                              │
│  (群组、消息、红包交互)                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流设计

#### 2.2.1 账号导入流程

```
用户上传 .session 文件
    ↓
系统验证文件有效性
    ↓
创建 AccountInstance
    ↓
初始化 Pyrogram Client
    ↓
账号状态: OFFLINE
    ↓
用户启动账号
    ↓
连接 Telegram API
    ↓
账号状态: ONLINE
```

#### 2.2.2 群组创建与加入流程

```
选择账号（单个/批量）
    ↓
配置群组信息
    ├─ 群组名称
    ├─ 群组描述
    ├─ 成员列表（可选）
    └─ 游戏配置
    ↓
调用 Telegram API 创建群组
    ↓
创建成功 → 获取群组 ID
    ↓
自动加入指定账号
    ↓
同步群组信息到数据库
    ↓
开始监听群组消息
```

#### 2.2.3 红包游戏参与流程

```
群组消息监听
    ↓
检测红包消息
    ├─ 关键词检测
    ├─ 消息类型检测
    └─ 红包游戏系统事件
    ↓
解析红包信息
    ├─ 红包 ID
    ├─ 金额/数量
    ├─ 游戏类型
    └─ 参与条件
    ↓
策略评估
    ├─ 时间策略
    ├─ 频率策略
    ├─ 金额策略
    └─ 组合策略
    ↓
决定参与 → 执行抢红包
    ↓
记录参与结果
    ↓
更新统计数据
```

#### 2.2.4 聊天引导流程

```
游戏状态变化
    ├─ 游戏开始
    ├─ 红包发放
    ├─ 游戏进行中
    ├─ 游戏结束
    └─ 结果公布
    ↓
触发引导生成
    ├─ 规则解释
    ├─ 操作提示
    ├─ 状态提醒
    └─ 结果说明
    ↓
生成引导消息
    ├─ 文本内容
    ├─ 表情符号
    └─ 按钮链接（可选）
    ↓
发送到群组
    ↓
记录引导日志
```

---

## 接口规范

### 3.1 红包游戏系统 API

#### 3.1.1 游戏事件通知接口

**接口**: `POST /api/v1/redpacket-game/events`

**功能**: 接收红包游戏系统的事件通知

**请求格式**:
```json
{
  "event_type": "GAME_START|GAME_END|REDPACKET_SENT|REDPACKET_CLAIMED|RESULT_ANNOUNCED",
  "event_id": "uuid-string",
  "group_id": 123456789,
  "game_id": "game-uuid",
  "timestamp": "2025-11-15T10:00:00Z",
  "payload": {
    "redpacket_id": "rp-uuid",
    "amount": 100.00,
    "count": 10,
    "claimed_count": 5,
    "remaining_count": 5,
    "game_type": "normal|random|lucky",
    "announcement": "红包已发放，快来抢！",
    "result_summary": "游戏结束，共发放 100 元，10 人参与"
  }
}
```

**响应格式**:
```json
{
  "success": true,
  "message": "Event received",
  "event_id": "uuid-string"
}
```

#### 3.1.2 游戏状态查询接口

**接口**: `GET /api/v1/redpacket-game/status/{group_id}`

**功能**: 查询指定群组的游戏状态

**响应格式**:
```json
{
  "group_id": 123456789,
  "game_status": "IDLE|PREPARING|ACTIVE|ENDED",
  "current_game_id": "game-uuid",
  "active_redpackets": [
    {
      "redpacket_id": "rp-uuid",
      "amount": 100.00,
      "count": 10,
      "claimed_count": 5,
      "remaining_count": 5,
      "expires_at": "2025-11-15T10:05:00Z"
    }
  ],
  "statistics": {
    "total_games": 10,
    "total_amount": 1000.00,
    "total_participants": 50
  }
}
```

#### 3.1.3 参与结果上报接口

**接口**: `POST /api/v1/redpacket-game/participate`

**功能**: 上报账号参与红包游戏的结果

**请求格式**:
```json
{
  "account_id": "account-uuid",
  "redpacket_id": "rp-uuid",
  "group_id": 123456789,
  "result": {
    "success": true,
    "amount": 10.50,
    "timestamp": "2025-11-15T10:01:00Z"
  }
}
```

**响应格式**:
```json
{
  "success": true,
  "message": "Participation recorded"
}
```

### 3.2 内部 API 扩展

#### 3.2.1 群组创建接口

**接口**: `POST /api/v1/group-ai/groups/create`

**功能**: 使用指定账号创建 Telegram 群组

**请求格式**:
```json
{
  "account_id": "account-uuid",
  "group_name": "红包游戏群",
  "group_description": "欢迎加入红包游戏！",
  "initial_members": ["+1234567890", "+0987654321"],
  "game_config": {
    "auto_join_enabled": true,
    "redpacket_enabled": true,
    "guide_enabled": true
  }
}
```

**响应格式**:
```json
{
  "success": true,
  "group_id": 123456789,
  "group_username": "redpacket_game_group",
  "invite_link": "https://t.me/joinchat/...",
  "created_at": "2025-11-15T10:00:00Z"
}
```

#### 3.2.2 批量群组创建接口

**接口**: `POST /api/v1/group-ai/groups/batch-create`

**功能**: 批量创建群组

**请求格式**:
```json
{
  "accounts": ["account-uuid-1", "account-uuid-2"],
  "group_template": {
    "name_prefix": "红包游戏群",
    "description": "欢迎加入红包游戏！",
    "game_config": {
      "auto_join_enabled": true,
      "redpacket_enabled": true,
      "guide_enabled": true
    }
  },
  "create_count": 5
}
```

**响应格式**:
```json
{
  "success": true,
  "created_groups": [
    {
      "group_id": 123456789,
      "account_id": "account-uuid-1",
      "group_name": "红包游戏群 #1",
      "invite_link": "https://t.me/joinchat/..."
    }
  ],
  "failed": []
}
```

#### 3.2.3 群组加入接口

**接口**: `POST /api/v1/group-ai/groups/{group_id}/join`

**功能**: 指定账号加入群组

**请求格式**:
```json
{
  "account_ids": ["account-uuid-1", "account-uuid-2"],
  "invite_link": "https://t.me/joinchat/..."
}
```

**响应格式**:
```json
{
  "success": true,
  "joined_accounts": ["account-uuid-1", "account-uuid-2"],
  "failed": []
}
```

#### 3.2.4 聊天引导配置接口

**接口**: `POST /api/v1/group-ai/groups/{group_id}/guide-config`

**功能**: 配置群组的聊天引导规则

**请求格式**:
```json
{
  "guide_enabled": true,
  "guide_rules": [
    {
      "trigger": "GAME_START",
      "message_template": "游戏开始了！规则：{rules}",
      "delay_seconds": 0
    },
    {
      "trigger": "REDPACKET_SENT",
      "message_template": "红包已发放！金额：{amount}，数量：{count}",
      "delay_seconds": 2
    },
    {
      "trigger": "GAME_END",
      "message_template": "游戏结束！结果：{result_summary}",
      "delay_seconds": 5
    }
  ],
  "language": "zh|en"
}
```

**响应格式**:
```json
{
  "success": true,
  "config_id": "config-uuid"
}
```

---

## 账号导入与群组管理

### 4.1 账号导入规范

#### 4.1.1 Session 文件格式

- **文件扩展名**: `.session`
- **文件命名**: `{account_id}.session` 或 `{phone_number}.session`
- **存储位置**: `sessions/` 目录
- **文件大小**: 通常 1-10 KB
- **加密要求**: 支持加密存储（可选）

#### 4.1.2 账号导入流程

**步骤 1: 文件上传**
- 支持单个文件上传
- 支持批量文件上传（ZIP 压缩包）
- 文件大小限制: 单个文件 ≤ 1MB，批量 ≤ 50MB
- 文件格式验证: 检查文件扩展名和基本格式

**步骤 2: 文件验证**
- 验证 Session 文件有效性
- 检查文件是否已存在
- 验证账号是否已在系统中

**步骤 3: 账号创建**
- 提取账号信息（从 Session 文件或用户输入）
- 创建 AccountInstance
- 初始化 Pyrogram Client（不立即连接）
- 保存账号配置到数据库

**步骤 4: 状态设置**
- 账号初始状态: `OFFLINE`
- 等待用户手动启动或批量启动

#### 4.1.3 批量导入功能

**支持格式**:
- JSON 格式
- CSV 格式
- 目录扫描（自动扫描 `sessions/` 目录）

**JSON 格式示例**:
```json
{
  "accounts": [
    {
      "account_id": "account-001",
      "session_file": "sessions/account-001.session",
      "phone_number": "+1234567890",
      "script_id": "redpacket_game",
      "group_ids": [],
      "config": {
        "redpacket_enabled": true,
        "redpacket_probability": 0.8,
        "max_replies_per_hour": 30
      }
    }
  ]
}
```

**CSV 格式示例**:
```csv
account_id,session_file,phone_number,script_id,redpacket_enabled
account-001,sessions/account-001.session,+1234567890,redpacket_game,true
account-002,sessions/account-002.session,+0987654321,redpacket_game,true
```

### 4.2 群组创建功能

#### 4.2.1 单群组创建

**前置条件**:
- 账号状态为 `ONLINE`
- 账号具有创建群组的权限
- 账号未被 Telegram 限制

**创建流程**:
1. 验证账号状态
2. 调用 `client.create_group()` 或 `client.create_supergroup()`
3. 设置群组信息（名称、描述、头像）
4. 添加初始成员（可选）
5. 生成邀请链接
6. 保存群组信息到数据库
7. 开始监听群组消息

**错误处理**:
- 账号离线 → 提示启动账号
- 权限不足 → 提示权限问题
- Telegram 限制 → 等待限制解除后重试
- 网络错误 → 自动重试（最多 3 次）

#### 4.2.2 批量群组创建

**功能特点**:
- 支持为单个账号创建多个群组
- 支持为多个账号各创建一个群组
- 支持并发创建（控制并发数，避免触发限制）
- 自动生成群组名称（支持模板）

**并发控制**:
- 默认并发数: 3 个/账号
- 创建间隔: 5-10 秒/群组
- 失败重试: 最多 3 次，指数退避

**群组命名模板**:
- `{prefix} #{number}`: "红包游戏群 #1"
- `{prefix} {date}`: "红包游戏群 2025-11-15"
- `{prefix} {random}`: "红包游戏群 ABC123"

### 4.3 群组加入功能

#### 4.3.1 单账号加入

**加入方式**:
1. **邀请链接**: 使用 `client.join_chat(invite_link)`
2. **群组 ID**: 使用 `client.join_chat(group_id)`
3. **群组用户名**: 使用 `client.join_chat("@group_username")`

**加入流程**:
1. 验证账号状态
2. 验证群组信息（检查群组是否存在）
3. 执行加入操作
4. 验证加入成功（获取群组信息）
5. 更新账号的群组列表
6. 开始监听群组消息

#### 4.3.2 批量账号加入

**功能特点**:
- 支持多个账号同时加入同一群组
- 支持单个账号加入多个群组
- 并发控制，避免触发限制

**并发策略**:
- 默认并发数: 5 个/群组
- 加入间隔: 3-5 秒/账号
- 失败处理: 记录失败账号，支持重试

---

## 红包游戏集成

### 5.1 红包检测机制

#### 5.1.1 检测方法（API 对接，不使用关键词检测）

**检测方法**（按优先级）:
1. **游戏系统 API 查询**（主要方法）
   - 通过 `GameAPIClient.get_game_status()` 查询群组状态
   - 获取活跃红包列表
   - 实时同步游戏系统状态
   
2. **Telegram API 消息类型检测**（辅助方法）
   - 检测按钮消息（Inline Keyboard）中的红包按钮
   - 检测游戏消息（Game）类型
   - 检测消息实体（bot_command、url 等）

3. **游戏系统事件通知**（实时推送）
   - HTTP Webhook 接收游戏系统事件
   - WebSocket 实时事件（如果游戏系统支持）
   - 事件类型：GAME_START, REDPACKET_SENT, REDPACKET_CLAIMED, GAME_END, RESULT_ANNOUNCED

#### 5.1.2 红包信息解析

**解析内容**:
- 红包 ID（唯一标识）
- 红包金额（总金额、单个金额）
- 红包数量（总数、剩余数）
- 红包类型（普通、随机、拼手气）
- 参与条件（时间限制、人数限制）
- 过期时间

**解析方法**:
- 正则表达式提取（从消息文本）
- JSON 解析（从消息数据）
- API 查询（从红包游戏系统）

### 5.2 参与策略

#### 5.2.1 策略类型

**1. 随机策略 (RandomStrategy)**
- 基础概率: 可配置（默认 0.5）
- 适用场景: 简单场景，无特殊要求

**2. 时间策略 (TimeBasedStrategy)**
- 高峰期概率: 0.8（18:00-21:00）
- 非高峰期概率: 0.3
- 适用场景: 根据时间段调整参与积极性

**3. 频率策略 (FrequencyStrategy)**
- 每小时最大参与次数: 5 次
- 冷却时间: 300 秒
- 适用场景: 控制参与频率，避免过度活跃

**4. 金额策略 (AmountBasedStrategy)**
- 高金额概率: 0.9（≥ 50% 最大金额）
- 低金额概率: 0.3（< 50% 最大金额）
- 适用场景: 根据红包金额调整参与意愿

**5. 组合策略 (CompositeStrategy)**
- 多策略加权平均
- 可配置权重
- 适用场景: 复杂场景，综合考虑多个因素

#### 5.2.2 策略配置

**账号级配置**:
```json
{
  "account_id": "account-uuid",
  "redpacket_strategy": {
    "type": "composite",
    "strategies": [
      {"type": "time_based", "weight": 0.4},
      {"type": "amount_based", "weight": 0.4},
      {"type": "frequency", "weight": 0.2}
    ],
    "base_probability": 0.6
  }
}
```

**群组级配置**:
```json
{
  "group_id": 123456789,
  "redpacket_strategy": {
    "type": "random",
    "base_probability": 0.7
  }
}
```

### 5.3 参与执行

#### 5.3.1 执行流程

1. **检测红包** → 解析红包信息
2. **策略评估** → 计算参与概率
3. **随机决策** → 决定是否参与
4. **执行参与** → 调用 Telegram API 或游戏系统 API
5. **结果记录** → 保存参与结果
6. **状态同步** → 同步到游戏系统

#### 5.3.2 执行方法

**方法 1: Telegram 按钮点击**
```python
# 如果红包是按钮消息
await client.request_callback_answer(
    chat_id=group_id,
    message_id=message_id,
    callback_data=button_callback_data
)
```

**方法 2: 游戏系统 API**
```python
# 调用游戏系统的参与 API
response = await http_client.post(
    f"{GAME_API_URL}/redpackets/{redpacket_id}/participate",
    json={"account_id": account_id}
)
```

**方法 3: 消息回复**
```python
# 发送特定消息触发参与
await client.send_message(
    chat_id=group_id,
    text="/grab_redpacket",
    reply_to_message_id=redpacket_message_id
)
```

### 5.4 结果处理

#### 5.4.1 结果记录

**记录内容**:
- 红包 ID
- 账号 ID
- 参与时间
- 参与结果（成功/失败）
- 获得金额（如果成功）
- 错误信息（如果失败）

**存储位置**:
- 数据库表: `redpacket_participations`
- 日志文件: `logs/redpacket.log`
- 统计数据: 实时更新到监控系统

#### 5.4.2 结果上报

**上报时机**:
- 参与成功后立即上报
- 批量上报（每 10 条或每 1 分钟）
- 失败重试（最多 3 次）

**上报格式**:
```json
{
  "account_id": "account-uuid",
  "redpacket_id": "rp-uuid",
  "group_id": 123456789,
  "result": {
    "success": true,
    "amount": 10.50,
    "timestamp": "2025-11-15T10:01:00Z"
  }
}
```

---

## 实时聊天引导系统

### 6.1 引导触发机制

#### 6.1.1 触发事件

**游戏事件触发**:
- `GAME_START`: 游戏开始
- `GAME_END`: 游戏结束
- `REDPACKET_SENT`: 红包发放
- `REDPACKET_CLAIMED`: 红包被领取
- `RESULT_ANNOUNCED`: 结果公布

**用户行为触发**:
- 新成员加入群组
- 用户询问游戏规则
- 用户询问如何参与
- 用户询问游戏状态

**时间触发**:
- 游戏开始前 1 分钟提醒
- 游戏进行中定期提醒（每 5 分钟）
- 游戏结束后总结

#### 6.1.2 触发条件

**条件配置**:
```json
{
  "trigger": "GAME_START",
  "conditions": {
    "min_members": 5,
    "delay_seconds": 0,
    "only_once": true
  }
}
```

### 6.2 引导内容生成

#### 6.2.1 内容模板

**游戏开始模板**:
```
🎮 游戏开始了！

📋 游戏规则：
- 红包总金额：{total_amount} 元
- 红包数量：{total_count} 个
- 游戏类型：{game_type}

⏰ 参与时间：{duration} 分钟
👥 当前参与人数：{current_participants}

💡 提示：点击红包按钮即可参与！
```

**红包发放模板**:
```
🎉 红包已发放！

💰 金额：{amount} 元
📦 数量：{count} 个
⏱️ 剩余时间：{remaining_time} 秒

🚀 快来抢红包吧！
```

**游戏结束模板**:
```
🏁 游戏结束！

📊 游戏统计：
- 总参与人数：{total_participants}
- 总发放金额：{total_amount} 元
- 平均每人：{average_amount} 元

🎊 恭喜获奖用户！

💬 想再玩一次？等待下一轮游戏开始！
```

#### 6.2.2 多语言支持

**支持语言**:
- 中文（简体/繁体）
- 英文
- 其他语言（可扩展）

**语言检测**:
- 根据群组设置
- 根据用户消息语言
- 根据账号配置

#### 6.2.3 个性化定制

**定制选项**:
- 语气风格（正式/轻松/幽默）
- 表情符号使用
- 消息长度
- 发送频率

### 6.3 引导发送策略

#### 6.3.1 发送时机

**立即发送**:
- 游戏开始
- 红包发放
- 重要状态变化

**延迟发送**:
- 游戏开始前提醒（提前 1 分钟）
- 游戏进行中提醒（每 5 分钟）
- 游戏结束后总结（延迟 10 秒）

**条件发送**:
- 新成员加入时发送欢迎和规则说明
- 用户询问时发送相关引导
- 错误发生时发送帮助信息

#### 6.3.2 发送频率控制

**频率限制**:
- 同一类型引导：最多每 5 分钟 1 次
- 总引导消息：最多每 10 分钟 3 次
- 避免刷屏，保持群组活跃度

**智能去重**:
- 相同内容不重复发送
- 相似内容合并发送
- 根据群组活跃度调整频率

### 6.4 引导效果评估

#### 6.4.1 评估指标

- **发送成功率**: 引导消息成功发送的比例
- **用户响应率**: 用户对引导消息的响应比例
- **参与转化率**: 引导后用户参与游戏的比例
- **用户满意度**: 用户对引导内容的满意度

#### 6.4.2 优化机制

**A/B 测试**:
- 测试不同的引导内容
- 测试不同的发送时机
- 测试不同的语气风格

**数据分析**:
- 分析引导效果数据
- 识别最佳引导策略
- 持续优化引导内容

---

## 用户体验设计

### 7.1 管理界面设计

#### 7.1.1 账号导入界面

**功能布局**:
```
┌─────────────────────────────────────────┐
│  账号导入                                │
├─────────────────────────────────────────┤
│  [单文件上传]  [批量上传]  [目录扫描]    │
│                                          │
│  上传区域（拖拽或点击）                  │
│                                          │
│  已上传文件列表：                        │
│  ✓ account-001.session                  │
│  ✓ account-002.session                  │
│  ✗ account-003.session (无效)          │
│                                          │
│  [开始导入]  [清空列表]                  │
└─────────────────────────────────────────┘
```

**交互流程**:
1. 用户选择上传方式
2. 系统验证文件
3. 显示验证结果
4. 用户确认导入
5. 显示导入进度
6. 显示导入结果

#### 7.1.2 群组创建界面

**功能布局**:
```
┌─────────────────────────────────────────┐
│  创建群组                                │
├─────────────────────────────────────────┤
│  选择账号：                              │
│  ☑ account-001                          │
│  ☑ account-002                          │
│  ☐ account-003                          │
│                                          │
│  群组信息：                              │
│  名称: [红包游戏群        ]             │
│  描述: [欢迎加入红包游戏！]             │
│                                          │
│  游戏配置：                              │
│  ☑ 自动加入账号                         │
│  ☑ 启用红包功能                         │
│  ☑ 启用聊天引导                         │
│                                          │
│  [创建单个]  [批量创建]                  │
└─────────────────────────────────────────┘
```

**批量创建选项**:
- 创建数量: [5] 个
- 命名方式: [前缀+编号] ▼
- 自动分配账号: ☑

#### 7.1.3 游戏监控界面

**功能布局**:
```
┌─────────────────────────────────────────┐
│  游戏监控                                │
├─────────────────────────────────────────┤
│  群组列表：                              │
│  ┌───────────────────────────────────┐ │
│  │ 红包游戏群 #1                     │ │
│  │ 状态: 进行中 | 参与: 15/20        │ │
│  │ [查看详情] [发送引导]             │ │
│  └───────────────────────────────────┘ │
│                                          │
│  实时统计：                              │
│  总游戏数: 10                            │
│  总参与人数: 150                         │
│  总发放金额: 1000.00 元                  │
└─────────────────────────────────────────┘
```

### 7.2 引导内容设计

#### 7.2.1 视觉设计

**消息格式**:
- 使用表情符号增强视觉效果
- 使用 Markdown 格式化文本
- 使用按钮提供快速操作

**示例消息**:
```
🎮 游戏开始了！

📋 规则说明：
• 点击下方按钮参与
• 每人限领 1 次
• 金额随机分配

⏰ 剩余时间：5 分钟

[🎁 立即参与] [📖 查看规则]
```

#### 7.2.2 交互设计

**按钮设计**:
- 参与按钮: 直接触发参与操作
- 规则按钮: 显示详细规则
- 帮助按钮: 显示帮助信息

**回复设计**:
- 用户询问时智能回复
- 提供上下文相关的帮助
- 支持多轮对话

### 7.3 错误处理与提示

#### 7.3.1 错误提示

**账号错误**:
```
❌ 账号导入失败

原因：Session 文件无效
建议：请检查文件格式和内容
```

**群组创建错误**:
```
❌ 群组创建失败

原因：账号权限不足
建议：请检查账号状态和权限
```

**参与错误**:
```
❌ 参与失败

原因：红包已被领完
建议：等待下一轮游戏
```

#### 7.3.2 成功提示

**成功消息**:
```
✅ 账号导入成功

已导入 5 个账号
状态：离线（等待启动）
```

```
✅ 群组创建成功

群组 ID: 123456789
邀请链接: https://t.me/joinchat/...
```

```
🎉 参与成功！

获得金额：10.50 元
恭喜你！
```

---

## 安全与隐私

### 8.1 数据安全

#### 8.1.1 Session 文件安全

**存储安全**:
- 文件加密存储（可选）
- 访问权限控制
- 定期备份

**传输安全**:
- HTTPS 传输
- 文件上传大小限制
- 文件类型验证

**使用安全**:
- Session 文件仅用于 Telegram 连接
- 不泄露给第三方
- 账号信息脱敏显示

#### 8.1.2 账号信息安全

**信息保护**:
- 手机号码脱敏显示（+1234****890）
- 账号 ID 使用 UUID
- 敏感信息加密存储

**访问控制**:
- 基于角色的访问控制（RBAC）
- API 接口认证
- 操作日志记录

### 8.2 隐私保护

#### 8.2.1 用户隐私

**数据最小化**:
- 仅收集必要数据
- 不收集用户个人敏感信息
- 定期清理过期数据

**数据使用**:
- 数据仅用于系统功能
- 不用于其他商业目的
- 用户可请求删除数据

#### 8.2.2 群组隐私

**群组信息**:
- 群组 ID 加密存储
- 群组消息不长期保存
- 用户可退出群组

**成员隐私**:
- 不泄露成员信息
- 不记录成员详细数据
- 尊重成员隐私设置

### 8.3 合规要求

#### 8.3.1 Telegram 规则遵守

**账号使用**:
- 遵守 Telegram 服务条款
- 不进行垃圾消息发送
- 不进行恶意行为

**群组管理**:
- 遵守群组规则
- 不进行违规操作
- 及时处理违规内容

#### 8.3.2 数据保护法规

**GDPR 合规**:
- 用户数据可访问
- 用户数据可删除
- 数据泄露通知

**其他法规**:
- 遵守当地数据保护法规
- 定期进行合规审查
- 及时更新合规措施

---

## 实施计划

### 9.1 开发阶段

#### 阶段 1: 基础功能开发 (Week 1-2)

**任务清单**:
- [ ] 账号批量导入功能
- [ ] 群组创建功能
- [ ] 群组加入功能
- [ ] 基础红包检测功能

**交付物**:
- 账号导入 API
- 群组管理 API
- 基础红包处理模块

#### 阶段 2: 红包游戏集成 (Week 3-4)

**任务清单**:
- [ ] 红包游戏系统 API 对接
- [ ] 红包检测机制完善
- [ ] 参与策略实现
- [ ] 参与执行功能

**交付物**:
- 红包游戏 API 客户端
- 策略引擎
- 参与执行模块

#### 阶段 3: 聊天引导系统 (Week 5-6)

**任务清单**:
- [ ] 引导触发机制
- [ ] 引导内容生成
- [ ] 引导发送策略
- [ ] 引导效果评估

**交付物**:
- 引导系统模块
- 内容模板库
- 效果分析工具

#### 阶段 4: 界面与优化 (Week 7-8)

**任务清单**:
- [ ] 管理界面开发
- [ ] 用户体验优化
- [ ] 错误处理完善
- [ ] 性能优化

**交付物**:
- 完整管理界面
- 用户文档
- 性能测试报告

### 9.2 测试阶段

#### 单元测试
- 账号导入功能测试
- 群组创建功能测试
- 红包检测功能测试
- 引导生成功能测试

#### 集成测试
- 端到端流程测试
- API 接口测试
- 系统集成测试

#### 用户验收测试
- 功能验收测试
- 用户体验测试
- 性能验收测试

### 9.3 部署计划

#### 开发环境
- 本地开发环境搭建
- 测试数据准备
- 开发工具配置

#### 测试环境
- 测试环境部署
- 测试账号准备
- 测试用例执行

#### 生产环境
- 生产环境部署
- 数据迁移
- 监控配置
- 备份策略

---

## 测试策略

### 10.1 功能测试

#### 10.1.1 账号导入测试

**测试用例**:
1. 单个 Session 文件导入
2. 批量 Session 文件导入
3. 无效文件处理
4. 重复账号处理
5. 大文件处理

**预期结果**:
- 有效文件成功导入
- 无效文件正确拒绝
- 错误信息清晰明确

#### 10.1.2 群组创建测试

**测试用例**:
1. 单个群组创建
2. 批量群组创建
3. 权限不足处理
4. 网络错误处理
5. 并发创建测试

**预期结果**:
- 群组创建成功
- 错误情况正确处理
- 并发控制有效

#### 10.1.3 红包游戏测试

**测试用例**:
1. 红包检测准确性
2. 参与策略正确性
3. 参与执行成功率
4. 结果记录完整性
5. 状态同步准确性

**预期结果**:
- 红包检测准确
- 策略决策合理
- 参与执行成功
- 数据记录完整

#### 10.1.4 聊天引导测试

**测试用例**:
1. 引导触发准确性
2. 引导内容正确性
3. 引导发送时机
4. 多语言支持
5. 频率控制有效性

**预期结果**:
- 引导及时准确
- 内容清晰易懂
- 发送频率合理
- 多语言正确

### 10.2 性能测试

#### 10.2.1 负载测试

**测试场景**:
- 100 个账号同时在线
- 50 个群组同时运行
- 1000 条/分钟消息处理
- 100 个/分钟红包参与

**性能指标**:
- 响应时间 < 2 秒
- CPU 使用率 < 80%
- 内存使用率 < 70%
- 错误率 < 1%

#### 10.2.2 压力测试

**测试场景**:
- 逐步增加负载
- 达到系统极限
- 观察系统行为
- 记录性能数据

**测试目标**:
- 确定系统容量
- 识别性能瓶颈
- 验证稳定性

### 10.3 安全测试

#### 10.3.1 数据安全测试

**测试内容**:
- Session 文件加密
- 敏感信息保护
- 访问权限控制
- 数据泄露防护

#### 10.3.2 接口安全测试

**测试内容**:
- API 认证授权
- 输入验证
- SQL 注入防护
- XSS 攻击防护

### 10.4 用户体验测试

#### 10.4.1 界面测试

**测试内容**:
- 界面易用性
- 操作流程顺畅
- 错误提示清晰
- 响应速度

#### 10.4.2 引导效果测试

**测试内容**:
- 引导内容理解度
- 引导时机合适性
- 用户参与转化率
- 用户满意度

---

## 附录

### A. 数据模型

#### A.1 账号表 (group_ai_accounts)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| account_id | VARCHAR(100) | 账号 ID（唯一） |
| session_file | VARCHAR(500) | Session 文件路径 |
| phone_number | VARCHAR(20) | 手机号码（脱敏） |
| status | ENUM | 状态（OFFLINE/ONLINE/ERROR） |
| script_id | VARCHAR(100) | 关联剧本 ID |
| redpacket_enabled | BOOLEAN | 是否启用红包 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### A.2 群组表 (redpacket_groups)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| group_id | BIGINT | Telegram 群组 ID |
| group_name | VARCHAR(200) | 群组名称 |
| group_username | VARCHAR(100) | 群组用户名 |
| invite_link | VARCHAR(500) | 邀请链接 |
| owner_account_id | UUID | 创建账号 ID |
| game_config | JSON | 游戏配置 |
| guide_config | JSON | 引导配置 |
| created_at | TIMESTAMP | 创建时间 |

#### A.3 红包参与表 (redpacket_participations)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| account_id | UUID | 账号 ID |
| group_id | BIGINT | 群组 ID |
| redpacket_id | VARCHAR(100) | 红包 ID |
| game_id | VARCHAR(100) | 游戏 ID |
| amount | DECIMAL | 获得金额 |
| success | BOOLEAN | 是否成功 |
| error_message | TEXT | 错误信息 |
| participated_at | TIMESTAMP | 参与时间 |

### B. API 错误码

| 错误码 | HTTP 状态 | 说明 |
|--------|----------|------|
| ACCOUNT_NOT_FOUND | 404 | 账号不存在 |
| ACCOUNT_OFFLINE | 400 | 账号离线 |
| SESSION_INVALID | 400 | Session 文件无效 |
| GROUP_CREATE_FAILED | 500 | 群组创建失败 |
| GROUP_NOT_FOUND | 404 | 群组不存在 |
| REDPACKET_NOT_FOUND | 404 | 红包不存在 |
| REDPACKET_EXPIRED | 400 | 红包已过期 |
| PERMISSION_DENIED | 403 | 权限不足 |
| RATE_LIMIT_EXCEEDED | 429 | 请求频率过高 |
| INTERNAL_ERROR | 500 | 内部错误 |

### C. 配置示例

#### C.1 账号配置示例

```json
{
  "account_id": "account-001",
  "session_file": "sessions/account-001.session",
  "script_id": "redpacket_game",
  "redpacket_enabled": true,
  "redpacket_probability": 0.8,
  "redpacket_strategy": {
    "type": "composite",
    "strategies": [
      {"type": "time_based", "weight": 0.4},
      {"type": "amount_based", "weight": 0.4},
      {"type": "frequency", "weight": 0.2}
    ]
  },
  "max_replies_per_hour": 30,
  "min_reply_interval": 60
}
```

#### C.2 群组配置示例

```json
{
  "group_id": 123456789,
  "game_config": {
    "auto_join_enabled": true,
    "redpacket_enabled": true,
    "guide_enabled": true
  },
  "guide_config": {
    "language": "zh",
    "tone": "friendly",
    "emoji_enabled": true
  }
}
```

---

**文档版本**: v1.0  
**最后更新**: 2025-11-15  
**维护者**: Smart TG Business AI 开发团队

