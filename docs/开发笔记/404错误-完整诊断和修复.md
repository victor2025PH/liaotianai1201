# 404 错误 - 完整诊断和修复

## 问题

分配剧本时返回 404 Not Found 错误。

## 可能的原因

### 1. GET 请求获取账号详情时返回 404

- **原因**: `get_account` 只检查 AccountManager，不检查数据库
- **状态**: ✅ **已修复** - `get_account` 现在也检查数据库

### 2. PUT 请求更新账号时返回 404

- **原因**: 账号不在 AccountManager 和数据库中，且未提供 `server_id` 或 `server_id` 传递失败
- **状态**: ⏳ **需要验证** - `update_account` 已有远程扫描逻辑

## 修复内容

### 修复1: `get_account` 端点

**文件**: `admin-backend/app/api/group_ai/accounts.py`

- ✅ 添加数据库查询逻辑
- ✅ 如果账号在数据库中，返回账号详情
- ✅ 添加详细日志

### 修复2: `update_account` 日志增强

**文件**: `admin-backend/app/api/group_ai/accounts.py`

- ✅ 在最开始就记录日志
- ✅ 记录所有请求参数
- ✅ 记录权限检查结果

## 诊断步骤

### 1. 检查账号是否存在

```bash
cd ~/liaotian/admin-backend
source .venv/bin/activate
python3 << 'EOF'
from app.db import get_db
from app.models.group_ai import GroupAIAccount

db = next(get_db())
account_id = '639277358115'
account = db.query(GroupAIAccount).filter(GroupAIAccount.account_id == account_id).first()

if account:
    print(f'✓ 账号存在: {account.account_id}')
    print(f'  server_id: {account.server_id}')
    print(f'  script_id: {account.script_id}')
else:
    print(f'✗ 账号不存在')
EOF
```

### 2. 查看后端日志

```bash
tail -f /tmp/backend_final.log | grep -E "UPDATE_ACCOUNT|GET_ACCOUNT|server_id|404"
```

### 3. 检查前端请求

在浏览器控制台检查：
- 请求URL是否正确
- `server_id` 是否正确传递
- 认证token是否存在

## 测试步骤

1. **刷新浏览器** (Ctrl+Shift+R)
2. **尝试分配剧本**
3. **查看后端日志**:
   ```bash
   tail -f /tmp/backend_final.log | grep "UPDATE_ACCOUNT"
   ```
4. **查看浏览器控制台**，检查：
   - 请求URL
   - 请求参数
   - 响应状态码和错误信息

## 如果仍然404

### 检查日志

```bash
tail -100 /tmp/backend_final.log | grep -E "UPDATE_ACCOUNT|404|639277358115"
```

日志应该显示：
- 请求是否到达后端
- `server_id` 是否正确传递
- 账号是否在数据库中
- 扫描结果

### 手动测试

```bash
# 登录获取token
TOKEN=$(curl -s -X POST 'http://localhost:8000/api/v1/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -d 'username=admin@example.com&password=changeme123' | jq -r '.access_token')

# 测试PUT请求
curl -X PUT "http://localhost:8000/api/v1/group-ai/accounts/639277358115" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"script_id":"test-script","server_id":"computer_001"}'
```

## 状态

✅ `get_account` 端点已修复  
✅ `update_account` 日志已增强  
✅ 后端服务已重启  
⏳ **等待测试验证**

---

**修复完成！请刷新浏览器测试，并查看后端日志。**
