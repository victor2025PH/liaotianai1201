# å®Œæ•´ä¿®å¾©æµç¨‹ - ç«‹å³åŸ·è¡Œ

> **æ—¥æœŸ**: 2025-12-01  
> **å•é¡Œ**: cache.py ç¼ºå°‘ cached å‡½æ•¸ï¼Œå°è‡´å¾Œç«¯ç„¡æ³•å•Ÿå‹•

---

## ğŸš€ ä¸€éµä¿®å¾©ä¸¦é‡å•Ÿ

åŸ·è¡Œä»¥ä¸‹å®Œæ•´å‘½ä»¤ï¼š

```bash
cd /home/ubuntu/liaotian/deployment-package/admin-backend && \
echo "ã€1ã€‘ä¿®å¾© cache.py..." && \
python3 << 'PYEOF'
import sys
import shutil

cache_file = 'app/core/cache.py'

with open(cache_file, 'r', encoding='utf-8') as f:
    content = f.read()

if 'def cached(prefix: str = "cache"' in content:
    print("âœ… cached å‡½æ•¸å·²å­˜åœ¨")
else:
    print("âŒ æ·»åŠ  cached å‡½æ•¸...")
    shutil.copy(cache_file, cache_file + '.bak')
    
    additional = '''

def cached(prefix: str = "cache", ttl: Optional[int] = None, expire: Optional[int] = None):
    """ç·©å­˜è£é£¾å™¨ï¼ˆç¨ç«‹å‡½æ•¸ç‰ˆæœ¬ï¼‰"""
    ttl = ttl or expire
    cache_manager = get_cache_manager()
    return cache_manager.cached(prefix=prefix, ttl=ttl)


def invalidate_cache(pattern: str) -> int:
    """ä½¿ç·©å­˜å¤±æ•ˆ"""
    try:
        cache_manager = get_cache_manager()
        keys_to_delete = [k for k in cache_manager.memory_cache.keys() if pattern.replace("*", "") in k]
        for key in keys_to_delete:
            if key in cache_manager.memory_cache:
                del cache_manager.memory_cache[key]
        return len(keys_to_delete)
    except Exception as e:
        import logging
        logger = logging.getLogger(__name__)
        logger.warning(f"æ¸…é™¤ç·©å­˜å¤±æ•—: {e}")
        return 0
'''
    
    with open(cache_file, 'a', encoding='utf-8') as f:
        f.write(additional)
    print("âœ… å·²æ·»åŠ å‡½æ•¸")
PYEOF
echo "" && \
echo "ã€2ã€‘åœæ­¢èˆŠæœå‹™..." && \
pkill -f "uvicorn.*app.main:app" && sleep 3 && \
echo "ã€3ã€‘å•Ÿå‹•æ–°æœå‹™..." && \
VENV_PYTHON=/home/ubuntu/liaotian/admin-backend/.venv/bin/python3 && \
export PYTHONPATH=/home/ubuntu/liaotian/deployment-package && \
nohup "$VENV_PYTHON" -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend_final.log 2>&1 & \
sleep 5 && \
echo "ã€4ã€‘æª¢æŸ¥æœå‹™ç‹€æ…‹..." && \
curl http://localhost:8000/health
```

---

**åŸ·è¡Œé€™å€‹å®Œæ•´å‘½ä»¤ï¼Œå‘Šè¨´æˆ‘çµæœï¼**
