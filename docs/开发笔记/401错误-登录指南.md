# 401 错误 - 登录指南

## 当前状态

浏览器显示大量 401 Unauthorized 错误，所有 API 请求都被拒绝，因为用户还没有登录。

## 解决方案

### 方法1: 使用登录页面（推荐）

1. **在登录页面填写信息**:
   - 邮箱: `admin@example.com` (已预填)
   - 密码: `changeme123` (已预填)

2. **点击"登录"按钮**

3. **等待登录成功**:
   - 如果登录成功，浏览器会自动跳转到主页面
   - Token 会自动保存到 `localStorage` 中

4. **验证登录状态**:
   - 打开浏览器控制台 (F12)
   - 执行: `localStorage.getItem('access_token')`
   - 应该看到一个长的 token 字符串

### 方法2: 手动设置 Token（如果登录失败）

如果登录按钮没有响应或登录失败，可以使用以下方法：

#### 步骤1: 获取 Token

在浏览器控制台中执行以下代码：

```javascript
// 1. 先尝试登录获取token
fetch('http://aikz.usdt2026.cc/api/v1/auth/login', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
  body: 'username=admin@example.com&password=changeme123'
})
.then(res => res.json())
.then(data => {
  if (data.access_token) {
    // 2. 保存token到localStorage
    localStorage.setItem('access_token', data.access_token);
    console.log('✓ Token已保存!');
    console.log('Token:', data.access_token.substring(0, 20) + '...');
    
    // 3. 刷新页面
    window.location.reload();
  } else {
    console.error('✗ 登录失败:', data);
  }
})
.catch(err => {
  console.error('✗ 请求失败:', err);
});
```

#### 步骤2: 验证Token

```javascript
// 检查token是否已保存
const token = localStorage.getItem('access_token');
if (token) {
  console.log('✓ Token存在:', token.substring(0, 20) + '...');
  
  // 测试API请求
  fetch('http://aikz.usdt2026.cc/api/v1/group-ai/accounts/', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
  .then(res => {
    console.log('API响应状态:', res.status);
    return res.json();
  })
  .then(data => {
    console.log('✓ API请求成功!', data);
  })
  .catch(err => {
    console.error('✗ API请求失败:', err);
  });
} else {
  console.error('✗ Token不存在，请先登录');
}
```

### 方法3: 一键登录脚本（完整版）

在浏览器控制台中一次性执行：

```javascript
(async function() {
  try {
    console.log('开始登录...');
    
    // 登录
    const loginRes = await fetch('http://aikz.usdt2026.cc/api/v1/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'username=admin@example.com&password=changeme123'
    });
    
    const loginData = await loginRes.json();
    
    if (!loginData.access_token) {
      console.error('✗ 登录失败:', loginData);
      return;
    }
    
    // 保存token
    localStorage.setItem('access_token', loginData.access_token);
    console.log('✓ 登录成功! Token已保存');
    
    // 测试API
    const testRes = await fetch('http://aikz.usdt2026.cc/api/v1/group-ai/accounts/', {
      headers: {
        'Authorization': `Bearer ${loginData.access_token}`
      }
    });
    
    if (testRes.ok) {
      console.log('✓ API测试成功!');
      console.log('正在刷新页面...');
      setTimeout(() => window.location.reload(), 1000);
    } else {
      console.error('✗ API测试失败:', await testRes.text());
    }
  } catch (err) {
    console.error('✗ 错误:', err);
  }
})();
```

## 验证步骤

登录成功后：

1. **检查 localStorage**:
   ```javascript
   localStorage.getItem('access_token')
   ```

2. **检查页面是否加载**:
   - 刷新页面 (Ctrl+Shift+R)
   - 应该能看到账号列表，而不是401错误

3. **尝试分配剧本**:
   - 点击"分配剧本"按钮
   - 查看是否还有404错误

4. **查看后端日志**:
   ```bash
   tail -f /tmp/backend_final.log | grep -E "UPDATE_ACCOUNT|GET_ACCOUNT"
   ```

## 常见问题

### Q: 登录后还是401错误？

**A**: 检查：
1. Token 是否保存成功: `localStorage.getItem('access_token')`
2. Token 是否过期: 查看 token 的过期时间
3. 后端服务是否运行: `curl http://localhost:8000/health`

### Q: 登录按钮没有反应？

**A**: 
1. 打开浏览器控制台查看错误
2. 使用上面的手动登录脚本
3. 检查网络请求是否发送

### Q: Token 保存在哪里？

**A**: Token 保存在浏览器的 `localStorage` 中，key 为 `access_token`。

## 下一步

登录成功后：
1. ✅ 401 错误应该消失
2. ✅ 可以查看账号列表
3. ✅ 可以尝试分配剧本
4. ✅ 可以查看后端日志中的 `UPDATE_ACCOUNT` 记录

---

**重要**: 如果登录成功后仍然有401错误，请检查后端日志和Nginx配置。
