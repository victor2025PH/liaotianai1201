# 游戏系统对接配置示例

> **创建日期**: 2025-11-15

---

## 配置方式

### 方式1：数据库对接（推荐）

如果两个系统可以访问同一个数据库，或你有游戏系统数据库的访问权限，推荐使用数据库对接。

#### 配置步骤

1. **在 `.env` 文件中添加**：

```bash
# 游戏系统数据库 URL
GAME_DATABASE_URL=sqlite:///./path/to/game_system/data.sqlite

# 或者 PostgreSQL
# GAME_DATABASE_URL=postgresql://user:password@localhost:5432/game_db

# 或者 MySQL
# GAME_DATABASE_URL=mysql+pymysql://user:password@localhost:3306/game_db
```

2. **或者在配置文件中设置**：

```python
# group_ai_service/config.py
GROUP_AI_GAME_DATABASE_URL=sqlite:///./path/to/game_system/data.sqlite
```

#### 优点

- ✅ 实时查询活跃红包
- ✅ 不依赖消息内容
- ✅ 可以获取所有群组的红包状态
- ✅ 性能好

#### 注意事项

- 需要确保数据库连接字符串正确
- 建议使用只读权限的数据库用户
- 确保两个系统使用相同的数据库或可以访问游戏系统数据库

---

### 方式2：Telegram 按钮检测（默认）

如果无法访问数据库，系统会自动使用 Telegram 按钮检测。

#### 工作原理

1. 检测消息中的内联按钮
2. 查找 `callback_data` 格式为 `hb:grab:{envelope_id}` 的按钮
3. 提取 `envelope_id` 作为红包 ID

#### 优点

- ✅ 无需额外配置
- ✅ 准确检测红包消息
- ✅ 实时响应

#### 缺点

- ❌ 需要消息包含按钮
- ❌ 无法检测没有按钮的红包消息

---

### 方式3：HTTP API 对接（如果游戏系统提供）

如果游戏系统提供 HTTP API，可以使用 API 对接。

#### 配置步骤

1. **在 `.env` 文件中添加**：

```bash
# 游戏系统 API 配置
GROUP_AI_GAME_API_BASE_URL=http://localhost:8000
GROUP_AI_GAME_API_KEY=your_api_key_here
GROUP_AI_GAME_API_ENABLED=true
GROUP_AI_GAME_API_TIMEOUT=30
```

#### API 接口要求

游戏系统需要提供以下接口：

- `GET /api/v1/redpacket-game/status/{group_id}` - 获取游戏状态
- `POST /api/v1/redpacket-game/participate` - 参与红包

---

### 方式4：游戏系统代码路径（用于直接调用函数）

如果需要直接调用游戏系统的 `grab_share()` 函数，可以配置代码路径。

#### 配置步骤

1. **在 `.env` 文件中添加**：

```bash
# 游戏系统代码路径
GAME_SYSTEM_PATH=E:/002-工作文件/重要程序/红包系统机器人/037重新开发新功能
```

#### 工作原理

1. 将游戏系统代码路径添加到 Python 路径
2. 导入游戏系统的 `grab_share()` 函数
3. 直接调用函数参与红包

#### 优点

- ✅ 直接调用，性能好
- ✅ 无需 HTTP API

#### 缺点

- ❌ 需要游戏系统代码在 Python 路径中
- ❌ 两个系统需要兼容的 Python 环境

---

## 完整配置示例

### 推荐配置（数据库对接）

```bash
# .env 文件

# 游戏系统数据库（推荐）
GAME_DATABASE_URL=sqlite:///./E:/002-工作文件/重要程序/红包系统机器人/037重新开发新功能/data.sqlite

# 游戏系统代码路径（可选，用于直接调用函数）
GAME_SYSTEM_PATH=E:/002-工作文件/重要程序/红包系统机器人/037重新开发新功能
```

### 完整配置（所有方式）

```bash
# .env 文件

# 方式1: 数据库对接（推荐）
GAME_DATABASE_URL=sqlite:///./path/to/game_system/data.sqlite

# 方式2: HTTP API 对接（如果游戏系统提供）
GROUP_AI_GAME_API_BASE_URL=http://localhost:8000
GROUP_AI_GAME_API_KEY=your_api_key
GROUP_AI_GAME_API_ENABLED=true

# 方式3: 游戏系统代码路径（用于直接调用函数）
GAME_SYSTEM_PATH=E:/002-工作文件/重要程序/红包系统机器人/037重新开发新功能
```

---

## 验证配置

### 检查配置是否生效

1. **启动系统**，查看日志：

```
INFO: 游戏系统 API 客户端已初始化（数据库模式）: sqlite:///./...
```

或

```
INFO: 游戏系统 API 未启用或未配置，将使用 Telegram API 检测
```

2. **测试红包检测**：

在群组中发送红包消息，查看日志是否检测到红包。

3. **测试红包参与**：

确认账号参与红包后，查看日志是否成功。

---

## 故障排查

### 问题1：无法连接数据库

**错误信息**：
```
WARNING: 初始化游戏系统数据库连接失败: ...
```

**解决方案**：
- 检查数据库 URL 是否正确
- 检查数据库文件是否存在
- 检查数据库权限

### 问题2：无法导入游戏系统函数

**错误信息**：
```
WARNING: 无法导入游戏系统的 grab_share 函数
```

**解决方案**：
- 检查 `GAME_SYSTEM_PATH` 是否正确
- 检查游戏系统代码是否在 Python 路径中
- 检查游戏系统的依赖是否已安装

### 问题3：无法检测红包

**可能原因**：
- 消息不包含按钮
- 按钮格式不正确
- 数据库查询失败

**解决方案**：
- 检查消息是否包含 `hb:grab:{envelope_id}` 格式的按钮
- 检查数据库连接
- 查看详细日志

---

## 性能优化建议

1. **使用数据库连接池**：
   - 配置 SQLAlchemy 连接池参数
   - 设置合适的连接数

2. **添加缓存**：
   - 缓存游戏状态查询结果
   - 设置合理的缓存过期时间

3. **批量查询**：
   - 批量查询多个群组的红包状态
   - 减少数据库查询次数

---

**配置完成！** 现在系统已经可以对接游戏系统了。

