# 修复重复 WebSocket location 配置 - 执行命令

## 问题
从终端输出可以看到：
- `grep -c` 显示仍有 2 个 location 块
- `nginx -t` 仍然报错：`duplicate location "/api/v1/notifications/ws"`

## 解决方案

### 方法 1：在服务器上直接执行修复脚本

将以下内容保存为脚本并在服务器上执行：

```bash
# SSH 连接到服务器
ssh ubuntu@165.154.233.55

# 执行修复
sudo python3 << 'PYEOF'
import re

with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 找到所有 location 行
location_lines = []
for i, line in enumerate(lines):
    if 'location /api/v1/notifications/ws' in line:
        location_lines.append(i)

print(f'找到 {len(location_lines)} 个 location')

if len(location_lines) > 1:
    # 删除第二个 location 块
    start_idx = location_lines[1]
    
    # 向前查找注释
    block_start = start_idx
    if start_idx > 0 and '# WebSocket' in lines[start_idx - 1]:
        block_start = start_idx - 1
    
    # 向后查找结束
    brace_count = 0
    block_end = start_idx
    found_brace = False
    
    for i in range(start_idx, len(lines)):
        if '{' in lines[i]:
            brace_count += lines[i].count('{')
            found_brace = True
        if '}' in lines[i]:
            brace_count -= lines[i].count('}')
            if found_brace and brace_count == 0:
                block_end = i
                break
    
    print(f'删除行 {block_start+1} 到 {block_end+1}')
    
    # 删除
    new_lines = lines[:block_start] + lines[block_end+1:]
    
    with open('/etc/nginx/sites-available/aikz.usdt2026.cc', 'w', encoding='utf-8') as f:
        f.writelines(new_lines)
    
    print('已删除重复配置')
else:
    print('未发现重复')
PYEOF

# 验证
sudo grep -c 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
# 应该输出: 1

# 测试
sudo nginx -t

# 重载
sudo systemctl reload nginx
```

### 方法 2：手动编辑（最可靠）

```bash
# 1. 查看所有 location 的位置
sudo grep -n 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 2. 编辑文件
sudo nano /etc/nginx/sites-available/aikz.usdt2026.cc

# 3. 找到第二个 location 块（应该在 87 行之后）
# 4. 删除从注释 "# WebSocket 支持 - 通知服务" 开始到对应的 "}" 结束的整个块
# 5. 保存（Ctrl+O）并退出（Ctrl+X）

# 6. 验证
sudo grep -c 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc
# 应该输出: 1

# 7. 测试
sudo nginx -t

# 8. 重载
sudo systemctl reload nginx
```

### 方法 3：使用 sed 精确删除

```bash
# 1. 先找到第二个 location 的确切行号
sudo grep -n 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 假设第二个在 87 行，注释在 86 行，结束在 99 行
# 2. 删除（根据实际行号调整）
sudo sed -i '86,99d' /etc/nginx/sites-available/aikz.usdt2026.cc

# 3. 验证
sudo grep -c 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 4. 测试
sudo nginx -t

# 5. 重载
sudo systemctl reload nginx
```

## 验证修复

修复后执行：

```bash
# 应该只显示一个 location 块
sudo grep -A 15 'location /api/v1/notifications/ws' /etc/nginx/sites-available/aikz.usdt2026.cc

# 配置测试应该通过
sudo nginx -t

# Nginx 应该成功重载
sudo systemctl reload nginx
```

## 前端验证

修复后，在前端浏览器中：
1. 刷新页面
2. 打开开发者工具（F12）→ Network 标签
3. 筛选 WS (WebSocket)
4. 应该看到连接成功（状态码 101）
5. 控制台应该没有 WebSocket 错误

