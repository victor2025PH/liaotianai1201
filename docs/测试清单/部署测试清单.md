# 部署測試清單

## 測試程序列表

### 1. 後端API服務 (admin-backend)

**程序名稱**: `admin-backend`  
**啟動命令**: `cd admin-backend && python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload`  
**服務地址**: http://localhost:8000  
**健康檢查**: http://localhost:8000/health

#### 測試內容

1. **健康檢查**
   ```bash
   curl http://localhost:8000/health
   ```
   **預期結果**: `{"status":"ok"}`

2. **服務器列表API**
   ```bash
   curl http://localhost:8000/api/v1/group-ai/servers/
   ```
   **預期結果**: 返回服務器列表JSON

3. **帳號列表API**
   ```bash
   curl http://localhost:8000/api/v1/group-ai/accounts
   ```
   **預期結果**: 返回帳號列表JSON

4. **API文檔**
   - 訪問: http://localhost:8000/docs
   - 檢查所有API端點是否正常

---

### 2. 前端服務 (saas-demo)

**程序名稱**: `saas-demo`  
**啟動命令**: `cd saas-demo && npm run dev`  
**服務地址**: http://localhost:3000

#### 測試內容

1. **服務器管理頁面**
   - 訪問: http://localhost:3000/group-ai/servers
   - **測試項目**:
     - [ ] 頁面正常加載
     - [ ] 服務器列表正常顯示
     - [ ] 服務器狀態正確顯示（在線/離線/錯誤）
     - [ ] 每30秒自動刷新
     - [ ] 啟動/停止/重啟按鈕可用
     - [ ] 日誌查看功能正常
     - [ ] 錯誤日誌高亮顯示

2. **帳號管理頁面**
   - 訪問: http://localhost:3000/group-ai/accounts
   - **測試項目**:
     - [ ] 頁面正常加載
     - [ ] 帳號列表正常顯示
     - [ ] 創建帳號功能正常
     - [ ] 上傳Session文件功能正常
     - [ ] 啟動/停止帳號功能正常
     - [ ] 刪除帳號功能正常
     - [ ] Session文件掃描功能正常

3. **角色分配頁面**
   - 訪問: http://localhost:3000/group-ai/role-assignments
   - **測試項目**:
     - [ ] 頁面正常加載
     - [ ] 角色列表正常顯示
     - [ ] 提取角色功能正常
     - [ ] 分配角色功能正常

4. **劇本管理頁面**
   - 訪問: http://localhost:3000/group-ai/scripts
   - **測試項目**:
     - [ ] 頁面正常加載
     - [ ] 劇本列表正常顯示
     - [ ] 上傳劇本功能正常
     - [ ] 編輯劇本功能正常

---

### 3. 工作節點服務 (worker-01)

**程序名稱**: `group-ai-worker`  
**服務器地址**: 165.154.254.99  
**服務端口**: 8000  
**Systemd服務**: `group-ai-worker`

#### 部署狀態檢查

1. **SSH連接測試**
   ```bash
   ssh root@165.154.254.99 "echo '連接成功'"
   ```
   **預期結果**: 顯示"連接成功"

2. **部署目錄檢查**
   ```bash
   ssh root@165.154.254.99 "ls -la /opt/group-ai"
   ```
   **預期結果**: 顯示目錄內容

3. **Python環境檢查**
   ```bash
   ssh root@165.154.254.99 "/opt/group-ai/venv/bin/python --version"
   ```
   **預期結果**: Python 3.11.x

4. **配置文件檢查**
   ```bash
   ssh root@165.154.254.99 "test -f /opt/group-ai/.env && echo '配置文件存在'"
   ```
   **預期結果**: "配置文件存在"

5. **Systemd服務檢查**
   ```bash
   ssh root@165.154.254.99 "systemctl status group-ai-worker"
   ```
   **預期結果**: 服務狀態為active

#### 測試內容

1. **服務健康檢查**
   ```bash
   curl http://165.154.254.99:8000/health
   ```
   **預期結果**: `{"status":"ok"}`

2. **API接口測試**
   ```bash
   curl http://165.154.254.99:8000/api/v1/group-ai/accounts
   ```
   **預期結果**: 返回帳號列表

3. **日誌檢查**
   ```bash
   ssh root@165.154.254.99 "tail -n 50 /opt/group-ai/logs/worker.log"
   ```
   **預期結果**: 顯示最近的日誌，無錯誤

4. **端口監聽檢查**
   ```bash
   ssh root@165.154.254.99 "netstat -tlnp | grep 8000"
   ```
   **預期結果**: 端口8000正在監聽

---

## 完整測試流程

### 階段1: 本地服務測試

1. **啟動後端服務**
   ```bash
   cd admin-backend
   python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```

2. **啟動前端服務**
   ```bash
   cd saas-demo
   npm run dev
   ```

3. **測試後端API**
   - 訪問 http://localhost:8000/docs
   - 測試所有API端點

4. **測試前端頁面**
   - 訪問 http://localhost:3000
   - 測試所有功能頁面

### 階段2: 遠程服務器測試

1. **檢查部署狀態**
   ```bash
   python scripts/deployment/check_and_start.py
   ```

2. **啟動遠程服務**
   ```bash
   python scripts/deployment/start_all_servers.py
   ```

3. **測試遠程API**
   - 訪問 http://165.154.254.99:8000/health
   - 測試所有API端點

4. **監控日誌**
   ```bash
   python scripts/deployment/monitor_logs.py --duration 600
   ```

### 階段3: 集成測試

1. **通過前端管理遠程服務器**
   - 訪問 http://localhost:3000/group-ai/servers
   - 測試啟動/停止/重啟功能
   - 測試日誌查看功能

2. **帳號管理測試**
   - 上傳Session文件
   - 創建帳號
   - 啟動帳號
   - 檢查帳號狀態

3. **功能聯動測試**
   - 創建帳號 → 分配角色 → 啟動帳號
   - 上傳劇本 → 分配給帳號 → 測試運行

---

## 常見問題排查

### 問題1: SSH連接失敗

**症狀**: `Authentication failed`  
**解決方案**:
1. 檢查密碼是否正確
2. 檢查服務器是否運行
3. 檢查防火牆設置

### 問題2: 服務無法啟動

**症狀**: systemd服務狀態為failed  
**解決方案**:
1. 查看服務日誌: `journalctl -u group-ai-worker -n 50`
2. 檢查配置文件: `cat /opt/group-ai/.env`
3. 檢查Python環境: `/opt/group-ai/venv/bin/python --version`

### 問題3: 端口無法訪問

**症狀**: curl連接超時  
**解決方案**:
1. 檢查防火牆: `ufw status`
2. 檢查服務是否運行: `systemctl status group-ai-worker`
3. 檢查端口監聽: `netstat -tlnp | grep 8000`

### 問題4: 前端無法連接後端

**症狀**: API請求失敗  
**解決方案**:
1. 檢查後端服務是否運行
2. 檢查CORS設置
3. 檢查API_BASE_URL配置

---

## 測試檢查表

### 後端服務
- [ ] 健康檢查通過
- [ ] API文檔可訪問
- [ ] 服務器列表API正常
- [ ] 帳號列表API正常
- [ ] 所有API端點響應正常

### 前端服務
- [ ] 主頁正常加載
- [ ] 服務器管理頁面正常
- [ ] 帳號管理頁面正常
- [ ] 所有功能按鈕可用
- [ ] 自動刷新功能正常

### 遠程服務器
- [ ] SSH連接正常
- [ ] 部署目錄存在
- [ ] Python環境正常
- [ ] 配置文件存在
- [ ] Systemd服務正常
- [ ] 服務健康檢查通過
- [ ] API接口正常
- [ ] 日誌正常記錄

### 集成功能
- [ ] 前端可以查看遠程服務器狀態
- [ ] 前端可以操作遠程服務器
- [ ] 前端可以查看遠程服務器日誌
- [ ] 帳號創建和分配正常
- [ ] Session文件上傳正常

---

## 測試腳本

### 快速測試腳本

```bash
#!/bin/bash
# 快速測試所有服務

echo "測試後端服務..."
curl -s http://localhost:8000/health || echo "後端服務未運行"

echo "測試前端服務..."
curl -s http://localhost:3000 | head -n 1 || echo "前端服務未運行"

echo "測試遠程服務器..."
curl -s http://165.154.254.99:8000/health || echo "遠程服務器未運行"

echo "測試完成"
```

### 自動化測試

```bash
# 運行完整測試
python scripts/deployment/check_and_start.py

# 監控日誌
python scripts/deployment/monitor_logs.py --duration 600
```

---

## 測試報告模板

### 測試日期: __________

#### 後端服務測試
- 健康檢查: [ ] 通過 [ ] 失敗
- API文檔: [ ] 正常 [ ] 異常
- 服務器API: [ ] 正常 [ ] 異常
- 帳號API: [ ] 正常 [ ] 異常

#### 前端服務測試
- 服務器管理頁面: [ ] 正常 [ ] 異常
- 帳號管理頁面: [ ] 正常 [ ] 異常
- 功能按鈕: [ ] 正常 [ ] 異常

#### 遠程服務器測試
- SSH連接: [ ] 正常 [ ] 異常
- 服務狀態: [ ] 正常 [ ] 異常
- API接口: [ ] 正常 [ ] 異常
- 日誌記錄: [ ] 正常 [ ] 異常

#### 發現的問題
1. ________________________________
2. ________________________________
3. ________________________________

#### 備註
________________________________
________________________________

