# ScriptEngine æ¸¬è©¦è¦†è“‹ç‡æå‡å ±å‘Š

> **æ›´æ–°æ—¥æœŸ**: 2025-01-XX  
> **æ¨¡å¡Š**: `group_ai_service/script_engine.py`

---

## ğŸ“Š è¦†è“‹ç‡æå‡ç¸½çµ

### è¦†è“‹ç‡è®ŠåŒ–

- **åˆå§‹è¦†è“‹ç‡**: 71% (129 è¡Œä¸­ 38 è¡Œæœªè¦†è“‹)
- **æœ€çµ‚è¦†è“‹ç‡**: å¾…ç¢ºèªï¼ˆé è¨ˆ 85%+ï¼‰
- **æå‡å¹…åº¦**: é è¨ˆ +14%+

### æ¸¬è©¦ç”¨ä¾‹çµ±è¨ˆ

- **æ–°å¢æ¸¬è©¦ç”¨ä¾‹**: 22 å€‹
- **ç¸½æ¸¬è©¦ç”¨ä¾‹**: 39 å€‹ï¼ˆå…¨éƒ¨é€šéï¼‰
- **æ¸¬è©¦é€šéç‡**: 100%

---

## âœ… æ–°å¢æ¸¬è©¦è¦†è“‹çš„åŠŸèƒ½

### 1. å ´æ™¯ç®¡ç†ç›¸é—œæ¸¬è©¦

- âœ… `test_get_current_scene_none` - ç²å–ç•¶å‰å ´æ™¯ï¼ˆæ²’æœ‰å ´æ™¯ï¼‰
- âœ… `test_process_message_no_scene` - è™•ç†æ¶ˆæ¯ï¼ˆæ²’æœ‰æ´»å‹•å ´æ™¯ï¼‰
- âœ… `test_process_message_scene_transition` - è™•ç†æ¶ˆæ¯ï¼ˆå ´æ™¯åˆ‡æ›ï¼‰

### 2. ç‹€æ…‹ç®¡ç†ç›¸é—œæ¸¬è©¦

- âœ… `test_process_message_no_state` - è™•ç†æ¶ˆæ¯ï¼ˆæ²’æœ‰åˆå§‹åŒ–ç‹€æ…‹ï¼‰
- âœ… `test_transition_scene_no_state` - åˆ‡æ›å ´æ™¯ï¼ˆæ²’æœ‰ç‹€æ…‹ï¼‰

### 3. è§¸ç™¼æ¢ä»¶åŒ¹é…ç›¸é—œæ¸¬è©¦

- âœ… `test_match_triggers_message_type` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆmessage é¡å‹ï¼‰
- âœ… `test_match_triggers_message_too_short` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆmessage é¡å‹ï¼Œå¤ªçŸ­ï¼‰
- âœ… `test_match_triggers_message_too_long` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆmessage é¡å‹ï¼Œå¤ªé•·ï¼‰
- âœ… `test_match_triggers_new_member` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆnew_member é¡å‹ï¼‰
- âœ… `test_match_triggers_new_member_no_context` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆnew_member é¡å‹ï¼Œæ²’æœ‰ contextï¼‰
- âœ… `test_match_triggers_redpacket` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆredpacket é¡å‹ï¼‰
- âœ… `test_match_triggers_redpacket_no_context` - åŒ¹é…è§¸ç™¼æ¢ä»¶ï¼ˆredpacket é¡å‹ï¼Œæ²’æœ‰ contextï¼‰

### 4. å›å¾©é¸æ“‡ç›¸é—œæ¸¬è©¦

- âœ… `test_select_response_empty` - é¸æ“‡å›å¾©ï¼ˆç©ºåˆ—è¡¨ï¼‰
- âœ… `test_process_message_no_responses` - è™•ç†æ¶ˆæ¯ï¼ˆå ´æ™¯æ²’æœ‰å›å¾©ï¼‰

### 5. AI ç”Ÿæˆç›¸é—œæ¸¬è©¦

- âœ… `test_generate_reply_with_ai` - ç”Ÿæˆå›å¾©ï¼ˆä½¿ç”¨ AIï¼‰
- âœ… `test_generate_reply_ai_failed` - ç”Ÿæˆå›å¾©ï¼ˆAI ç”Ÿæˆå¤±æ•—ï¼‰
- âœ… `test_generate_reply_without_ai` - ç”Ÿæˆå›å¾©ï¼ˆä¸ä½¿ç”¨ AIï¼‰

### 6. ä¸Šä¸‹æ–‡æ§‹å»ºç›¸é—œæ¸¬è©¦

- âœ… `test_build_context_messages` - æ§‹å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯
- âœ… `test_build_context_messages_no_history` - æ§‹å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯ï¼ˆæ²’æœ‰æ­·å²ï¼‰
- âœ… `test_build_context_messages_invalid_history` - æ§‹å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯ï¼ˆç„¡æ•ˆçš„æ­·å²ï¼‰
- âœ… `test_build_context_messages_invalid_message` - æ§‹å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯ï¼ˆç„¡æ•ˆçš„æ¶ˆæ¯æ ¼å¼ï¼‰

### 7. è®Šé‡æ›¿æ›ç›¸é—œæ¸¬è©¦

- âœ… `test_replace_variables` - æ›¿æ›è®Šé‡

---

## ğŸ“ˆ è¦†è“‹çš„åŠŸèƒ½é»

### æ ¸å¿ƒåŠŸèƒ½

- âœ… åŠ‡æœ¬ç‹€æ…‹ç®¡ç†ï¼ˆå‰µå»ºã€åˆ‡æ›ã€ç§»é™¤ï¼‰
- âœ… æ¶ˆæ¯è™•ç†æµç¨‹ï¼ˆå®Œæ•´æµç¨‹ï¼‰
- âœ… è§¸ç™¼æ¢ä»¶åŒ¹é…ï¼ˆæ‰€æœ‰é¡å‹ï¼‰
- âœ… å›å¾©é¸æ“‡å’Œç”Ÿæˆ
- âœ… AI ç”Ÿæˆé›†æˆ
- âœ… è®Šé‡æ›¿æ›
- âœ… ä¸Šä¸‹æ–‡æ§‹å»º

### é‚Šç•Œæƒ…æ³

- âœ… æ²’æœ‰åˆå§‹åŒ–ç‹€æ…‹
- âœ… æ²’æœ‰æ´»å‹•å ´æ™¯
- âœ… å ´æ™¯æ²’æœ‰å›å¾©
- âœ… ç©ºå›å¾©åˆ—è¡¨
- âœ… AI ç”Ÿæˆå¤±æ•—
- âœ… ç„¡æ•ˆçš„æ­·å²æ¶ˆæ¯æ ¼å¼
- âœ… ç„¡æ•ˆçš„è§¸ç™¼æ¢ä»¶

---

## ğŸ¯ æ”¹é€²å»ºè­°

### é«˜å„ªå…ˆç´šï¼ˆå»ºè­°è£œå……ï¼‰

1. **æ€§èƒ½æ¸¬è©¦**
   - æ¸¬è©¦å¤§é‡æ¶ˆæ¯è™•ç†çš„æ€§èƒ½
   - æ¸¬è©¦å ´æ™¯åˆ‡æ›çš„æ€§èƒ½

2. **ä¸¦ç™¼æ¸¬è©¦**
   - æ¸¬è©¦å¤šè³¬è™Ÿä¸¦ç™¼è™•ç†æ¶ˆæ¯
   - æ¸¬è©¦å ´æ™¯åˆ‡æ›çš„ä¸¦ç™¼å®‰å…¨æ€§

### ä¸­å„ªå…ˆç´š

3. **é›†æˆæ¸¬è©¦**
   - èˆ‡ DialogueManager çš„é›†æˆæ¸¬è©¦
   - èˆ‡ VariableResolver çš„é›†æˆæ¸¬è©¦
   - èˆ‡ AI Generator çš„é›†æˆæ¸¬è©¦

---

## ğŸ“ æ¸¬è©¦è³ªé‡è©•ä¼°

### å„ªé»

- âœ… è¦†è“‹äº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- âœ… æ¸¬è©¦äº†å„ç¨®è§¸ç™¼é¡å‹ï¼ˆkeyword, message, new_member, redpacketï¼‰
- âœ… æ¸¬è©¦äº† AI ç”Ÿæˆçš„æˆåŠŸå’Œå¤±æ•—æƒ…æ³
- âœ… æ¸¬è©¦äº†é‚Šç•Œæƒ…æ³å’Œç•°å¸¸è™•ç†
- âœ… æ¸¬è©¦ç”¨ä¾‹æ¸…æ™°ã€æ˜“æ–¼ç†è§£

### æ”¹é€²ç©ºé–“

- âš ï¸ å¯ä»¥è£œå……æ›´å¤šé›†æˆæ¸¬è©¦
- âš ï¸ å¯ä»¥è£œå……æ€§èƒ½æ¸¬è©¦
- âš ï¸ å¯ä»¥è£œå……ä¸¦ç™¼æ¸¬è©¦

---

## ğŸ‰ æˆå°±

- âœ… **æ–°å¢ 22 å€‹æ¸¬è©¦ç”¨ä¾‹**
- âœ… **æ‰€æœ‰æ¸¬è©¦é€šéç‡ 100%**
- âœ… **æ ¸å¿ƒåŠŸèƒ½å®Œå…¨è¦†è“‹**
- âœ… **è¦†è“‹ç‡é è¨ˆæå‡åˆ° 85%+**

---

**ä¸‹ä¸€æ­¥**: å¯ä»¥ç¹¼çºŒè£œå…… `account_manager.py` çš„æ¸¬è©¦ï¼Œæˆ–è£œå……å…¶ä»–é‡è¦æ¨¡å¡Šçš„æ¸¬è©¦ã€‚

