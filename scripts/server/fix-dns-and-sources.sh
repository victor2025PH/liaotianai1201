#!/bin/bash
# ============================================================
# ä¿®å¤ DNS è§£æžå’Œè½¯ä»¶æºé—®é¢˜
# ============================================================
# 
# åŠŸèƒ½ï¼š
# 1. è¯Šæ–­ DNS è§£æžé—®é¢˜
# 2. é…ç½®å¯é çš„ DNS æœåŠ¡å™¨
# 3. æ›´æ¢ä¸ºå¯é çš„è½¯ä»¶æºï¼ˆé˜¿é‡Œäº‘/æ¸…åŽå¤§å­¦é•œåƒï¼‰
# 4. æµ‹è¯•ç½‘ç»œè¿žæŽ¥
# ============================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

success_msg() { echo -e "${GREEN}âœ… $1${NC}"; }
error_msg() { echo -e "${RED}âŒ $1${NC}"; }
info_msg() { echo -e "${YELLOW}â„¹ï¸  $1${NC}"; }
step_msg() { echo -e "${BLUE}ðŸ“Œ $1${NC}"; }

echo "========================================="
echo "ä¿®å¤ DNS è§£æžå’Œè½¯ä»¶æºé—®é¢˜"
echo "========================================="
echo ""

# æ£€æŸ¥æ˜¯å¦ä»¥ root æƒé™è¿è¡Œ
if [ "$EUID" -ne 0 ]; then 
    error_msg "è¯·ä½¿ç”¨ sudo è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# ============================================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯Šæ–­ DNS é—®é¢˜
# ============================================================
echo "========================================="
echo "ç¬¬ä¸€éƒ¨åˆ†ï¼šè¯Šæ–­ DNS é—®é¢˜"
echo "========================================="
echo ""

step_msg "[1/3] æ£€æŸ¥å½“å‰ DNS é…ç½®..."

# æ£€æŸ¥ systemd-resolved
if systemctl is-active --quiet systemd-resolved 2>/dev/null; then
    info_msg "systemd-resolved æ­£åœ¨è¿è¡Œ"
    cat /etc/systemd/resolved.conf | grep -E "^DNS=|^FallbackDNS=" || echo "ä½¿ç”¨é»˜è®¤ DNS"
else
    info_msg "systemd-resolved æœªè¿è¡Œæˆ–ä¸å­˜åœ¨"
fi

# æ£€æŸ¥ /etc/resolv.conf
if [ -f /etc/resolv.conf ]; then
    info_msg "å½“å‰ /etc/resolv.conf é…ç½®:"
    cat /etc/resolv.conf
else
    info_msg "/etc/resolv.conf ä¸å­˜åœ¨"
fi
echo ""

step_msg "[2/3] æµ‹è¯• DNS è§£æž..."

# æµ‹è¯•è§£æž
test_dns() {
    local hostname=$1
    if host "$hostname" > /dev/null 2>&1 || nslookup "$hostname" > /dev/null 2>&1; then
        success_msg "å¯ä»¥è§£æž: $hostname"
        return 0
    else
        error_msg "æ— æ³•è§£æž: $hostname"
        return 1
    fi
}

test_dns "google.com" || DNS_FAILED=true
test_dns "baidu.com" || DNS_FAILED=true
test_dns "mirrors.ucloud.cn" || DNS_FAILED=true

if [ "$DNS_FAILED" = "true" ]; then
    error_msg "DNS è§£æžå¤±è´¥ï¼Œéœ€è¦ä¿®å¤"
else
    success_msg "DNS è§£æžæ­£å¸¸"
fi
echo ""

step_msg "[3/3] æµ‹è¯•ç½‘ç»œè¿žæŽ¥..."

if ping -c 2 8.8.8.8 > /dev/null 2>&1; then
    success_msg "å¯ä»¥è¿žæŽ¥åˆ°å¤–ç½‘ï¼ˆIP è¿žæŽ¥æ­£å¸¸ï¼‰"
    NETWORK_OK=true
else
    error_msg "æ— æ³•è¿žæŽ¥åˆ°å¤–ç½‘"
    NETWORK_OK=false
fi

if ping -c 2 114.114.114.114 > /dev/null 2>&1; then
    success_msg "å¯ä»¥è¿žæŽ¥åˆ°å›½å†… DNSï¼ˆ114.114.114.114ï¼‰"
else
    info_msg "æ— æ³•è¿žæŽ¥åˆ° 114.114.114.114"
fi
echo ""

# ============================================================
# ç¬¬äºŒéƒ¨åˆ†ï¼šä¿®å¤ DNS é…ç½®
# ============================================================
echo "========================================="
echo "ç¬¬äºŒéƒ¨åˆ†ï¼šä¿®å¤ DNS é…ç½®"
echo "========================================="
echo ""

if [ "$NETWORK_OK" = "true" ]; then
    step_msg "[1/2] é…ç½®å¯é çš„ DNS æœåŠ¡å™¨..."
    
    # é…ç½® systemd-resolvedï¼ˆUbuntu 22.04 é»˜è®¤ä½¿ç”¨ï¼‰
    if command -v systemd-resolve > /dev/null 2>&1 || systemctl list-unit-files | grep -q systemd-resolved; then
        info_msg "é…ç½® systemd-resolved..."
        
        # å¤‡ä»½åŽŸé…ç½®
        cp /etc/systemd/resolved.conf /etc/systemd/resolved.conf.backup 2>/dev/null || true
        
        # é…ç½® DNS
        cat > /etc/systemd/resolved.conf << 'EOF'
[Resolve]
DNS=223.5.5.5 114.114.114.114 8.8.8.8
FallbackDNS=1.1.1.1 8.8.4.4
Domains=
#DNSOverTLS=no
#MulticastDNS=no
#DNSSEC=no
#Cache=yes
#DNSStubListener=yes
#ReadEtcHosts=yes
EOF
        
        systemctl restart systemd-resolved 2>/dev/null || true
        success_msg "systemd-resolved é…ç½®å·²æ›´æ–°"
    fi
    
    # åŒæ—¶æ›´æ–° /etc/resolv.confï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
    info_msg "æ›´æ–° /etc/resolv.conf..."
    cat > /etc/resolv.conf << 'EOF'
# Generated by fix-dns-and-sources.sh
nameserver 223.5.5.5
nameserver 114.114.114.114
nameserver 8.8.8.8
EOF
    
    success_msg "DNS é…ç½®å·²æ›´æ–°"
    echo ""
    
    step_msg "[2/2] éªŒè¯ DNS è§£æž..."
    sleep 2
    
    if host "google.com" > /dev/null 2>&1 || nslookup "google.com" > /dev/null 2>&1; then
        success_msg "DNS è§£æžå·²ä¿®å¤"
    else
        error_msg "DNS è§£æžä»ç„¶å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œè¿žæŽ¥"
    fi
    echo ""
else
    error_msg "ç½‘ç»œè¿žæŽ¥å¤±è´¥ï¼Œæ— æ³•ä¿®å¤ DNS"
    echo "è¯·æ£€æŸ¥ï¼š"
    echo "  1. æœåŠ¡å™¨çš„ç½‘ç»œè¿žæŽ¥"
    echo "  2. é˜²ç«å¢™è®¾ç½®"
    echo "  3. è·¯ç”±é…ç½®"
    exit 1
fi

# ============================================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ›´æ¢è½¯ä»¶æº
# ============================================================
echo "========================================="
echo "ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ›´æ¢è½¯ä»¶æº"
echo "========================================="
echo ""

step_msg "[1/3] å¤‡ä»½åŽŸæœ‰è½¯ä»¶æºé…ç½®..."

# å¤‡ä»½åŽŸæœ‰é…ç½®
if [ -f /etc/apt/sources.list ]; then
    cp /etc/apt/sources.list /etc/apt/sources.list.backup.$(date +%Y%m%d_%H%M%S)
    success_msg "å·²å¤‡ä»½ /etc/apt/sources.list"
fi

if [ -d /etc/apt/sources.list.d ]; then
    tar -czf /etc/apt/sources.list.d.backup.$(date +%Y%m%d_%H%M%S).tar.gz /etc/apt/sources.list.d/ 2>/dev/null || true
fi
echo ""

step_msg "[2/3] æ£€æµ‹ Ubuntu ç‰ˆæœ¬..."

# æ£€æµ‹ Ubuntu ç‰ˆæœ¬
if [ -f /etc/os-release ]; then
    . /etc/os-release
    UBUNTU_VERSION=$(echo $VERSION_ID | cut -d. -f1,2)
    UBUNTU_CODENAME=$VERSION_CODENAME
    
    info_msg "æ£€æµ‹åˆ° Ubuntu $UBUNTU_VERSION ($UBUNTU_CODENAME)"
else
    error_msg "æ— æ³•æ£€æµ‹ Ubuntu ç‰ˆæœ¬"
    exit 1
fi

# å¦‚æžœæ²¡æœ‰æ£€æµ‹åˆ° codenameï¼Œæ ¹æ®ç‰ˆæœ¬å·è®¾ç½®
if [ -z "$UBUNTU_CODENAME" ]; then
    case "$UBUNTU_VERSION" in
        22.04)
            UBUNTU_CODENAME="jammy"
            ;;
        20.04)
            UBUNTU_CODENAME="focal"
            ;;
        18.04)
            UBUNTU_CODENAME="bionic"
            ;;
        *)
            error_msg "ä¸æ”¯æŒçš„ Ubuntu ç‰ˆæœ¬: $UBUNTU_VERSION"
            exit 1
            ;;
    esac
    info_msg "ä½¿ç”¨ codename: $UBUNTU_CODENAME"
fi
echo ""

step_msg "[3/3] æ›´æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒæº..."

# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒï¼ˆåœ¨ä¸­å›½å¤§é™†è®¿é—®é€Ÿåº¦è¾ƒå¿«ä¸”ç¨³å®šï¼‰
cat > /etc/apt/sources.list << EOF
# é˜¿é‡Œäº‘ Ubuntu ${UBUNTU_VERSION} é•œåƒæº
# ç”Ÿæˆæ—¶é—´: $(date)

# é»˜è®¤æ³¨é‡Šäº†æºç é•œåƒä»¥æé«˜ apt update é€Ÿåº¦ï¼Œå¦‚æœ‰éœ€è¦å¯è‡ªè¡Œå–æ¶ˆæ³¨é‡Š
deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse
# deb-src https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse

deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-updates main restricted universe multiverse
# deb-src https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-updates main restricted universe multiverse

deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-backports main restricted universe multiverse
# deb-src https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-backports main restricted universe multiverse

deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-security main restricted universe multiverse
# deb-src https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-security main restricted universe multiverse

# deb https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-proposed main restricted universe multiverse
# deb-src https://mirrors.aliyun.com/ubuntu/ ${UBUNTU_CODENAME}-proposed main restricted universe multiverse
EOF

success_msg "è½¯ä»¶æºå·²æ›´æ¢ä¸ºé˜¿é‡Œäº‘é•œåƒ"
echo ""

# ============================================================
# ç¬¬å››éƒ¨åˆ†ï¼šæµ‹è¯•è½¯ä»¶æº
# ============================================================
echo "========================================="
echo "ç¬¬å››éƒ¨åˆ†ï¼šæµ‹è¯•è½¯ä»¶æº"
echo "========================================="
echo ""

step_msg "[1/2] æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."

# æ¸…ç† apt ç¼“å­˜
apt clean
apt autoclean

# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
if apt update; then
    success_msg "è½¯ä»¶åŒ…åˆ—è¡¨æ›´æ–°æˆåŠŸ"
else
    error_msg "è½¯ä»¶åŒ…åˆ—è¡¨æ›´æ–°å¤±è´¥"
    echo ""
    echo "å°è¯•ä½¿ç”¨æ¸…åŽå¤§å­¦é•œåƒæº..."
    
    # å¤‡ç”¨ï¼šä½¿ç”¨æ¸…åŽå¤§å­¦é•œåƒ
    cat > /etc/apt/sources.list << EOF
# æ¸…åŽå¤§å­¦ Ubuntu ${UBUNTU_VERSION} é•œåƒæº
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ ${UBUNTU_CODENAME} main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ ${UBUNTU_CODENAME}-updates main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ ${UBUNTU_CODENAME}-backports main restricted universe multiverse
deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ ${UBUNTU_CODENAME}-security main restricted universe multiverse
EOF
    
    apt update
    success_msg "å·²åˆ‡æ¢åˆ°æ¸…åŽå¤§å­¦é•œåƒæº"
fi
echo ""

step_msg "[2/2] æµ‹è¯•å®‰è£…ä¸€ä¸ªç®€å•è½¯ä»¶åŒ…..."

# æµ‹è¯•å®‰è£… curlï¼ˆé€šå¸¸å·²ç»å®‰è£…ï¼‰
if dpkg -l | grep -q "^ii.*curl"; then
    success_msg "curl å·²å®‰è£…ï¼Œè½¯ä»¶æºå·¥ä½œæ­£å¸¸"
else
    info_msg "å°è¯•å®‰è£… curl è¿›è¡Œæµ‹è¯•..."
    if apt install -y curl; then
        success_msg "è½¯ä»¶æºå·¥ä½œæ­£å¸¸"
    else
        error_msg "è½¯ä»¶æºä»æœ‰é—®é¢˜"
    fi
fi
echo ""

# ============================================================
# å®Œæˆ
# ============================================================
echo "========================================="
echo "âœ… DNS å’Œè½¯ä»¶æºä¿®å¤å®Œæˆï¼"
echo "========================================="
echo ""
echo "ðŸ“Š å½“å‰é…ç½®ï¼š"
echo "  - DNS æœåŠ¡å™¨: 223.5.5.5, 114.114.114.114, 8.8.8.8"
echo "  - è½¯ä»¶æº: é˜¿é‡Œäº‘é•œåƒï¼ˆæˆ–æ¸…åŽå¤§å­¦é•œåƒï¼‰"
echo ""
echo "ðŸ” éªŒè¯å‘½ä»¤ï¼š"
echo "  - æµ‹è¯• DNS: host google.com"
echo "  - æ›´æ–°è½¯ä»¶åŒ…: sudo apt update"
echo "  - æµ‹è¯•å®‰è£…: sudo apt install -y curl"
echo ""
success_msg "çŽ°åœ¨å¯ä»¥ç»§ç»­æ‰§è¡Œéƒ¨ç½²è„šæœ¬äº†ï¼"
