# 分配剧本问题 - 完整修复和测试指南

## 问题总结

用户在分配剧本时遇到 "账号不存在" 错误（404），虽然账号在节点管理和账号管理页面都可见。

## 完整修复方案

### ✅ 1. 后端修复

#### 1.1 添加 session_file 字段支持
- 文件：`admin-backend/app/api/group_ai/accounts.py`
- 在 `AccountUpdateRequest` 中添加 `session_file` 字段

#### 1.2 增强 update_account 函数
- 支持从远程服务器扫描并创建账号记录
- 详细的调试日志
- 权限检查日志

#### 1.3 添加 HTTP 中间件
- 文件：`admin-backend/app/main.py`
- 记录所有 PUT 请求到 `/accounts/`
- 记录请求体和响应状态

### ✅ 2. 前端修复

#### 2.1 增强 server_id 传递逻辑
- 文件：`saas-demo/src/app/group-ai/accounts/page.tsx`
- 优先使用 `server_id`，如果没有则使用 `node_id`
- 添加调试日志

#### 2.2 修复 API 类型定义
- 文件：`saas-demo/src/lib/api/group-ai.ts`
- 添加 `session_file` 字段

## 测试步骤

### 1. 刷新浏览器

清除缓存并刷新页面：
- 打开：http://aikz.usdt2026.cc/group-ai/accounts
- 按 `Ctrl+Shift+R` 强制刷新

### 2. 分配剧本

1. 选择一个 Worker 节点账号（如 Eve, 639277358115）
2. 点击"分配剧本"按钮
3. 选择剧本（如"红包游戏陪玩剧本"）
4. 选择角色（如"小柒"）
5. 点击"分配剧本"按钮

### 3. 查看日志

#### 3.1 浏览器控制台

应该看到调试日志：
```
[分配剧本] 账号: 639277358115, server_id: computer_001, node_id: computer_001, 最终serverId: computer_001
```

#### 3.2 后端日志

查看中间件日志：
```bash
tail -f /tmp/backend_final.log | grep -E "MIDDLEWARE|UPDATE_ACCOUNT"
```

应该看到：
- `[MIDDLEWARE] PUT 请求到达`
- `[MIDDLEWARE] 请求体`（包含 server_id）
- `[UPDATE_ACCOUNT] 收到更新賬號請求`
- `[UPDATE_ACCOUNT] server_id=computer_001`
- 服务器扫描结果
- 账号创建结果

## 日志文件位置

- **后端详细日志**：`/tmp/backend_final.log`
- **标准日志**：`logs/backend.log`
- **浏览器控制台**：F12 → Console

## 问题排查

### 如果仍然出现 404 错误

#### 步骤1：检查中间件日志

```bash
tail -100 /tmp/backend_final.log | grep MIDDLEWARE
```

**如果没有日志**：
- 请求没有到达后端
- 可能是 Nginx 配置问题
- 检查 Nginx 错误日志：`sudo tail -50 /var/log/nginx/error.log`

**如果有日志但显示 404**：
- 继续查看 `UPDATE_ACCOUNT` 日志
- 查看具体的错误信息

#### 步骤2：检查 update_account 日志

```bash
tail -100 /tmp/backend_final.log | grep UPDATE_ACCOUNT
```

**如果没有日志**：
- 请求可能没有到达函数
- 可能是路由或认证问题

**如果有日志但显示错误**：
- 查看具体的错误信息
- 检查 `server_id` 是否正确传递
- 检查服务器列表

#### 步骤3：检查服务器配置

```bash
cd ~/liaotian/admin-backend
python3 -c "from app.api.group_ai.session_uploader import SessionUploader; uploader = SessionUploader(); print('服务器列表:', list(uploader.servers.keys()))"
```

确认 `computer_001` 是否在列表中。

## 预期结果

成功的情况下，日志应该显示：

1. **中间件日志**：
   ```
   [MIDDLEWARE] PUT 请求到达: /api/v1/group-ai/accounts/639277358115
   [MIDDLEWARE] 请求体: {"script_id": "...", "server_id": "computer_001", ...}
   ```

2. **函数日志**：
   ```
   [UPDATE_ACCOUNT] 收到更新賬號請求: account_id=639277358115
   [UPDATE_ACCOUNT] server_id=computer_001
   賬號 639277358115 不在數據庫中，嘗試從遠程服務器 computer_001 掃描並創建記錄
   SessionUploader 中的服務器列表: ['computer_001', 'computer_002']
   在服務器 computer_001 上找到賬號 639277358115，創建數據庫記錄
   已創建賬號 639277358115 的數據庫記錄
   ```

3. **响应状态**：
   ```
   [MIDDLEWARE] PUT 响应状态: 200
   ```

4. **浏览器显示**：成功消息，不再显示错误

## 如果仍然失败

请提供以下信息：

1. **浏览器控制台的完整输出**
2. **后端日志的最后 100 行**：`tail -100 /tmp/backend_final.log`
3. **Network 标签中的请求详情**：
   - Request URL
   - Request Method
   - Request Headers
   - Request Payload
   - Response Status
   - Response Body

## 状态

✅ 所有修复已完成  
✅ 中间件日志已添加  
✅ 详细调试日志已添加  
✅ 服务已重启  
⏳ 等待用户测试

---

**所有修复已完成，请测试并查看日志！**
